(()=>{"use strict";var e={2003:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AgentConfig=void 0;t.AgentConfig=class{constructor(e,t,o=0,n=50){this.provider=e,this.model=t,this.temperature=o,this.recursionLimit=n}}},1412:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AgentRequest=void 0;const n=o(2003);class r{constructor(e,t,o,n,s){this.sender=e,this.content=t,this.sessionId=o,this.config=n,this.workspaceName=s,this.sessionId=o||r.generateRandomSessionId()}static fromJSON(e){const{sender:t,content:o,sessionId:s,config:i,workspaceName:a}=e;if(!o)throw new Error("Missing required field 'content'");const c=i?Object.assign(new n.AgentConfig,i):new n.AgentConfig,l=s||r.generateRandomSessionId();return new r(t,o,l,c,a)}static generateRandomSessionId(){const e="abcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let o=0;o<10;o++)t+=e.charAt(Math.floor(36*Math.random()));return t}static getContentAsString(e){return"string"==typeof e?e:JSON.stringify(e)}}t.AgentRequest=r},7249:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StandardAgentStateManager=void 0;const n=o(9314),r=o(8804);t.StandardAgentStateManager=class{static createGraphState(){return{messages:{reducer:(e,t)=>e.concat(t)}}}static shouldContinue(e){const t=e.messages,o=t[t.length-1];return o.tool_calls?.length?"tools":"__end__"}static createWorkflow(e,t){const o=this.createGraphState(),s=new r.ToolNode(t);return new n.StateGraph({channels:o}).addNode("agent",(async t=>await e(t))).addNode("tools",s).addEdge("__start__","agent").addConditionalEdges("agent",this.shouldContinue).addEdge("tools","agent")}}},1350:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DevOpsAgentController=void 0;const i=o(3563),a=o(7559),c=o(1412),l=o(9055);let u=class{constructor(e){this.devOpsAgentService=e}async processRequest(e,t){t.setHeader("Content-Type","text/plain");for await(const o of this.devOpsAgentService.processRequestStream(e)){const e=JSON.stringify(o);t.write(e+"\n")}l.default.debug("Finished writing all chunks to client"),t.end()}};t.DevOpsAgentController=u,n([(0,i.Post)(),(0,i.HttpCode)(200),s(0,(0,i.Body)()),s(1,(0,i.Res)()),r("design:type",Function),r("design:paramtypes",[c.AgentRequest,Object]),r("design:returntype",Promise)],u.prototype,"processRequest",null),t.DevOpsAgentController=u=n([(0,i.Controller)("agents/devops-agent"),r("design:paramtypes",[a.DevOpsAgentService])],u)},6730:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DevOpsAgentModule=void 0;const r=o(3563),s=o(1350),i=o(7559);let a=class{};t.DevOpsAgentModule=a,t.DevOpsAgentModule=a=n([(0,r.Module)({controllers:[s.DevOpsAgentController],providers:[i.DevOpsAgentService]})],a)},7559:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DevOpsAgentService=void 0;const s=o(3563),i=o(1544),a=o(7249),c=o(7027),l=o(1486),u=o(9314),d=o(9055),p=o(6254);let f=class{constructor(){this.tools=[c.DevOpsTool]}async*processRequestStream(e){d.default.info("Received agent request",{agentRequest:JSON.stringify(e)});const t=i.ChatModelManager.getChatModel(e.config).bindTools(this.tools);const o=a.StandardAgentStateManager.createWorkflow((async function(e){const o=e.messages;d.default.info("Calling model with messages",{messages:JSON.stringify(o)});const n=await t.invoke(o);return d.default.info("Received model response",{response:JSON.stringify(n)}),{messages:[n]}}),this.tools),n=new u.MemorySaver,r=o.compile({checkpointer:n}),s={messages:[new l.SystemMessage({content:"You are a helpful AI assistant capable of executing DevOps tasks using shell commands. \n          Before executing any command, carefully analyze it to ensure it's not destructive or harmful to the system. \n          Reject any requests that seem potentially dangerous or are likely to cause unintended system changes. \n          Installing new tools or updating existing is totally acceptable.\n          Feel free to run commands in the shell to find out more about the current system.\n          "}),new l.HumanMessage("string"==typeof e.content?e.content:JSON.stringify(e.content))]};d.default.debug("Initial state",{initialState:JSON.stringify(s)});const c=await r.stream(s,{configurable:{thread_id:e.sessionId||"default"}});for await(const e of c){const t=p.MessageUtils.processOutputEvent(e);yield{type:t.label,content:t.content}}d.default.info("Streaming completed")}};t.DevOpsAgentService=f,t.DevOpsAgentService=f=n([(0,s.Injectable)(),r("design:paramtypes",[])],f)},2914:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ExampleAgentController=void 0;const i=o(3563),a=o(6603),c=o(1412);let l=class{constructor(e){this.exampleAgentService=e}async processRequest(e){return this.exampleAgentService.processRequest(e)}};t.ExampleAgentController=l,n([(0,i.Post)(),s(0,(0,i.Body)()),r("design:type",Function),r("design:paramtypes",[c.AgentRequest]),r("design:returntype",Promise)],l.prototype,"processRequest",null),t.ExampleAgentController=l=n([(0,i.Controller)("agents/example-agent"),r("design:paramtypes",[a.ExampleAgentService])],l)},414:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ExampleAgentModule=void 0;const r=o(3563),s=o(2914),i=o(6603);let a=class{};t.ExampleAgentModule=a,t.ExampleAgentModule=a=n([(0,r.Module)({controllers:[s.ExampleAgentController],providers:[i.ExampleAgentService]})],a)},6603:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ExampleAgentService=void 0;const r=o(3563),s=o(1544),i=o(7249),a=o(4548),c=o(1486),l=o(9314);let u=class{constructor(){this.tools=[a.ExampleWeatherTool]}async processRequest(e){console.log("agentRequest: "+JSON.stringify(e));const t=s.ChatModelManager.getChatModel(e.config).bindTools(this.tools);const o=i.StandardAgentStateManager.createWorkflow((async function(e){const o=e.messages;return{messages:[await t.invoke(o)]}}),this.tools),n=new l.MemorySaver,r=o.compile({checkpointer:n}),a={messages:[new c.SystemMessage({content:"You are a helpful AI assistant capable of analyzing text and using tools when necessary."}),new c.HumanMessage("string"==typeof e.content?e.content:JSON.stringify(e.content))]},u=await r.invoke(a,{configurable:{thread_id:e.sessionId||"default"}}),d=u.messages[u.messages.length-1];return console.log("Response received:",d),d.content}};t.ExampleAgentService=u,t.ExampleAgentService=u=n([(0,r.Injectable)()],u)},9852:function(e,t,o){var n,r=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SEAgentController=void 0;const a=o(3563),c=o(5017),l=o(1412);let u=n=class{constructor(e){this.seAgentService=e,this.logger=new a.Logger(n.name)}async processRequest(e,t){try{t.setHeader("Content-Type","text/event-stream"),t.setHeader("Cache-Control","no-cache"),t.setHeader("Connection","keep-alive"),t.setHeader("Location",`/sessions/${e.sessionId}/stream`);for await(const o of this.seAgentService.processRequestStream(e))t.write(`data: ${JSON.stringify(o)}\n\n`);t.end()}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),t.setHeader("Content-Type","application/json"),t.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}};t.SEAgentController=u,r([(0,a.Post)(),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Body)()),i(1,(0,a.Res)()),s("design:type",Function),s("design:paramtypes",[l.AgentRequest,Object]),s("design:returntype",Promise)],u.prototype,"processRequest",null),t.SEAgentController=u=n=r([(0,a.Controller)("agents/se-agent"),s("design:paramtypes",[c.SEAgentService])],u)},3764:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SEAgentModule=void 0;const r=o(3563),s=o(9852),i=o(5017),a=o(5873),c=o(3880),l=o(9449),u=o(3177);let d=class{};t.SEAgentModule=d,t.SEAgentModule=d=n([(0,r.Module)({imports:[a.WorkspaceModule,c.SessionModule,l.LangchainModule,u.MutationsModule],controllers:[s.SEAgentController],providers:[i.SEAgentService]})],d)},5017:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SEAgentService=void 0;const s=o(3563),i=o(8474),a=o(7373),c=o(1412),l=o(2003),u=o(1544),d=o(7249),p=o(1486),f=o(9055),h=o(6254),g=o(5515),y=o(4970),m=o(3923),S=o(7465),v=o(3765),b=o(9896),R=o(6928),w=o(9626),O=o(1e3),_=o(7602),E=o(9100);let P=class{constructor(e,t,o,n){this.workspaceService=e,this.sessionService=t,this.checkpointerService=o,this.mutationsService=n,this.chatModelManager=u.ChatModelManager.getInstance()}async*processRequestStream(e){if(!e.workspaceName)throw new Error("Workspace name is required");const t=(0,E.ulid)();let o=e.config;o||(o=new l.AgentConfig);const n=await this.workspaceService.findOne(e.workspaceName);if(!n)throw new Error(`Workspace ${e.workspaceName} not found`);const r=n.buildOrTestCommand&&""!==n.buildOrTestCommand.trim()?n.buildOrTestCommand:void 0;e.sessionId||(e.sessionId=this.generateSessionId());const s=c.AgentRequest.getContentAsString(e.content),i=await this.sessionService.ensureSession(e.workspaceName,e.sessionId,s);await this.sessionService.updateSessionStatus(i.sessionId,"active"),f.default.info("Received SE agent request",{agentRequest:JSON.stringify(e),requestId:t});const a=this.chatModelManager.getProvider(e.config.provider),u=a.getModel(e.config),O=[new y.ReadFile(n.repoBaseDir),new m.UpdateFile(n.repoBaseDir,this.mutationsService,e.sessionId),new S.DeleteFile(n.repoBaseDir),new v.CommandLine(n.repoBaseDir)],_=u.bindTools(O),P=g.ReadWorkspaceTree.generateWorkspaceTree(n.repoBaseDir),M=R.join(n.repoBaseDir,"hints.md");let C="";b.existsSync(M)&&(C=b.readFileSync(M,"utf-8"));const A=(0,w.createSystemPrompt)(P,C,r);const j=d.StandardAgentStateManager.createWorkflow((async function(e){const t=e.messages;f.default.debug("Calling model with messages: %s",JSON.stringify(t));const o=await _.invoke(t);return f.default.debug("Received model response: %s",JSON.stringify(o)),{messages:[o]}}),O),T=this.checkpointerService.getCheckpointer(),I=j.compile({checkpointer:T});this.storeRequestContent(n.repoBaseDir,t,s),await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:"Human",content:s,createdAt:new Date});let k=o.recursionLimit?o.recursionLimit:50;const D={configurable:{thread_id:e.sessionId},recursionLimit:k};f.default.debug("Checkpoint config",D);const F=await T.get(D),x=new p.HumanMessage(s);let N={messages:[]};N.messages=F?[x]:[new p.SystemMessage({content:A}),x],f.default.debug("Initial state",N);const $=await I.stream(N,D);let q=0,W=0,L=0,H="";const U=new Date;try{for await(const t of $){f.default.debug("Output Event was: %s",JSON.stringify(t));const o=h.MessageUtils.processOutputEvent(t);f.default.debug("Processed message: %s",o);const n=a.calculateCost(o.usageMetadata?.inputTokens||0,o.usageMetadata?.outputTokens||0),r={itemId:this.generateItemId(),sessionId:e.sessionId,label:o.label,content:o.content,createdAt:new Date,inputTokens:o.usageMetadata?.inputTokens,outputTokens:o.usageMetadata?.outputTokens,totalTokens:o.usageMetadata?.totalTokens,cost:n},s=await this.sessionService.addItem(r);q+=o.usageMetadata?.inputTokens||0,W+=o.usageMetadata?.outputTokens||0,L+=o.usageMetadata?.totalTokens||0,H=o.content;const i=await this.sessionService.getSession(e.sessionId);if(i&&"aborted"===i.status){const t={label:"Error",content:"Session was aborted by the user."},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:t.label,content:t.content,createdAt:new Date});yield o;break}yield s}}catch(t){f.default.error("Error in SE Agent:",t);const o={label:"Error",content:`An error occurred: ${t.message}`},n=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:o.label,content:o.content,createdAt:new Date});yield n}finally{await this.sessionService.updateSessionStatus(e.sessionId,"inactive");const t=a.calculateCost(q,W),o=new Date,n=o.getTime()-U.getTime();await this.sessionService.addRequest({requestId:(0,E.ulid)(),sessionId:e.sessionId,requestContent:s,responseContent:H,startedAt:U,endedAt:o,tookMillis:n,inputTokens:q,outputTokens:W,totalTokens:L,cost:t}),f.default.info("SE Agent processing completed in %s seconds - Input tokens: %s, Output tokens: %s, Total tokens: %s, Total cost: £%s",n/1e3,q,W,L,t.toFixed(6))}}generateSessionId(){return(0,E.ulid)()}generateItemId(){return(0,E.ulid)()}storeRequestContent(e,t,o){if("false"===process.env.STORE_SPECS_IN_WORKSPACE||o.length<=100)return;const n=new Date,r=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`,s=R.join(e,".hldk","specs",r);b.mkdirSync(s,{recursive:!0});const i=R.join(s,`${t}.txt`);b.writeFileSync(i,o),f.default.debug(`Stored request content in file: ${i}`)}};t.SEAgentService=P,t.SEAgentService=P=n([(0,s.Injectable)(),r("design:paramtypes",[i.WorkspaceService,a.SessionService,O.CheckpointerService,_.MutationsService])],P)},9626:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createSystemPrompt=function(e,t,o){let n="As an AI assistant, you are tasked analysing the software system and answering questions about it and/or making improvements to it.\nFollow these guidelines:\n1. Review the file structure tree below and the read_file tool to answer questions about the system and suggest improvements where appropriate. Provide a concise summary of your findings.\n2. When making changes to the system:\n   a. First, fetch all the files you think you might need using the read_file tool.\n   b. Make a clear plan with multiple steps.\n   c. Iterate through the plan, one step at a time.\n   d. Think step-by-step and explain the needed changes in a few short sentences.\n   e. Each change MUST be done by invoking the update_file tool to replace a part of the file with a new bit.\n3. Use the read_file tool to retrieve the contents of specific files when needed rather than guessing at what they contain.\n   When making edits to previously referenced files, always keep the name/path the same.\n4. When choosing a file path for generated artifacts, consider the structure and choose a logical location.\n5. When a specific file name is mentioned, look for it in the structure below and use the read_file tool to get the content of that file.\n6. Consider the following when suggesting improvements:\n   a. Code organization and structure\n   b. Adherence to best practices and design patterns\n   c. Performance optimizations\n   d. Security considerations\n   e. Scalability and maintainability\n   f. Documentation and comments\n7. Provide clear explanations for your suggestions and recommendations.\n8. If you need to create new files or modify existing ones, clearly indicate the file path and content.\n9. When generating new code or modifying existing code, always look at similar or nearby files in the source tree for guidance on:\n   a. Code style and formatting\n   b. Logging practices\n   c. Error handling\n   d. Import statements and module organization\n   e. Commenting style and docstring format\n   f. Naming conventions for variables, functions, and classes\n   g. Tools, libraries, and frameworks being used\n   h. Your ending summary should be a concise summary of a) which files were updated and b) what changes were made to them.\n10. To find similar files:\n    a. Examine the file structure provided below.\n    b. Identify files in the same directory or nearby directories with similar purposes or file extensions.\n    c. Use the read_file tool to retrieve the contents of these similar files for reference.\n11. Ensure that new code generation and modifications align with the existing codebase's style and best practices.\n12. Do not make assumptions about tools, libraries, or frameworks being used:\n    a. Always fetch and examine similar existing files before creating new ones.\n    b. When adding a new entity or data class, fetch an existing one first and use the same tooling and styles.\n    c. For data migrations, look at an existing migration file to understand the tooling and practices used in the repository.\n    d. Consistently use the same tools and approaches found in the existing codebase.\n13. When making changes to the system use the update_file tool as follows:\n    a. Always provide the path to the file you want to change (or create) as the first argument.\n    b. The second argument is the SEARCH block - the bit of the existing code you want to replace. For new files this should be an empty string.\n    c. The third argument is the REPLACE block - the bit of the new code you want to replace it with. DO NOT FORGET TO INCLUDE THIS!!\n    d. Always try to minimise the size of the SEARCH block so you are only updating the specific parts of the file that need updating.\n    e. If you need to make edits to multiple parts of a single file, make a plan and do so in a series of update_file calls.\n    f. If you get an error back from the tool saying the search block was not found then you can try again with a larger search block or the entire contents of the file as the search block.\n14. To delete a file, use the delete_file tool:\n    a. Provide the relative path of the file to delete as the argument.\n    b. Always confirm the file deletion with the user before proceeding.\n15. When refactoring or renaming files:\n    a. Use the update_file tool to create the new file with the desired content.\n    b. Use the delete_file tool to remove the old file.\n    c. Update any references to the old file in other parts of the codebase using the update_file tool.\n16. After making changes to the system, always commit the changes to git using the following steps:\n    a. Use the command_line tool with command 'git add -A && git commit -m \"<suitable commit message>\"'\n    b. Replace \"<suitable commit message>\" with a brief, descriptive message of the changes you've made.\n    c. Do not try to git add individual files, always use 'git add -A' as above.\n17. If the user asks you to undo or /undo or undo the last changes, use the command_line tool with the command \"git reset --hard HEAD~1\"\n18. You can use the command_line tool to execute commands in the workspace directory, not just git commands. This includes system commands, package managers, build tools, etc. But remember the following:\n    a. Do not traverse up above the workspace directory though and only do things that are safe and can definitely be undone.\n    b. Only use package manager/build commands if you are sure of the correct one. Look in the readme or the build files to find out for sure and if not sure then do not use them. Just say what you might do to complete the task.";o&&(n+=`\n19. After making changes to the system, but before committing them to git, consider the following:\n    a. If you have updated any code files (not just scripts, documentation, or other non-code files), you should run the following command to test if the changes haven't broken anything:\n       Use the command_line tool to execute this command: ${o}\n    b. If you run the test and any errors occur, try to fix them if it seems feasible.\n    c. If the errors cannot be fixed easily, stop processing and report the error to the user without committing the changes to git.\n    d. If you don't run the test or if the build or test is successful, proceed with committing the changes to git.\n    e. Remember, you only need to run this test command if you've made changes to actual code files, not for changes to scripts, documentation, or other non-code files.`);return n+=`\n\nHere is the file tree of the system:\n${e}\n\n${t?`Additional hints:\n${t}`:""}\n\n${o?`Build or Test Command: ${o}`:""}\n\nIMPORTANT: Keep your final summary concise and to the point. If you have made changes to multiple files, only list the files that have been changed and a short description of the changes for each file.\nIMPORTANT: When using the update_file tool you MUST provide all 3 arguments: filePath, search & REPLACE. DO NOT FORGET TO INCLUDE THE REPLACE BLOCK!!\nIMPORTANT: ALWAYS GO LOOKING IN THE CODEBASE AND FETCH ANY FILES YOU THINK YOU NEED TO LEARN FROM BEFORE MAKING CHANGES. DO NOT MAKE ASSUMPTIONS ABOUT WHAT IS IN A FILE - JUST FETCH IT!\nIMPARTANT: You must NEVER try to stop processes or kill running processes. You must only use the command_line tool to execute commands.\n\n${o?"IMPORTANT: REMEMBER TO RUN THE BUILD OR TEST COMMAND IF YOU HAVE MADE CHANGES TO THE CODE FILES BEFORE THEN COMMITTING YOUR CHANGES TO GIT!":"IMPORTANT: ALWAYS COMMIT YOUR CHANGES TO GIT AFTER MAKING THEM!"}\n`,n}},715:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AppModule=void 0;const r=o(3563),s=o(2810),i=o(6928),a=o(6808),c=o(414),l=o(6730),u=o(3764),d=o(5873),p=o(3880),f=o(7535),h=o(9449),g=o(3177),y=o(3049),m=o(376),S=o(7967),v=o(1901);let b=class{};t.AppModule=b,t.AppModule=b=n([(0,r.Module)({imports:[s.ServeStaticModule.forRoot({rootPath:(0,i.join)(__dirname,"..","..","vitify-webui","dist"),exclude:["/api*"]}),m.DataSourceModule,a.HelloWorldModule,d.WorkspaceModule,p.SessionModule,c.ExampleAgentModule,l.DevOpsAgentModule,u.SEAgentModule,f.AgentsModule,h.LangchainModule,g.MutationsModule,y.AudioTranscriptionModule,S.ConfigModule,v.GitModule]})],b)},2776:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.initializeDataSource=t.getDataSource=t.AppDataSource=void 0;const n=o(6689),r=o(857),s=o(6928),i=o(9896),a=o(9055),c=o(5095);const l=s.join(r.homedir(),".hldk","db","hldk.sqlite");class u{constructor(e=l){this.dbPath=e,this.updateDbPath(process.env.HLDK_DB_PATH||this.dbPath)}updateDbPath(e){this.dbPath=e,a.default.info(`Connecting to the database at ${this.dbPath}`),i.existsSync(this.dbPath)||(a.default.info(`Database path ${this.dbPath} does not exist, creating it`),i.mkdirSync(s.dirname(this.dbPath),{recursive:!0})),this.db&&this.db.close((e=>{e&&a.default.error(`Error closing database: ${e.message}`)})),this.db=new n.Database(this.dbPath,(e=>{if(e)throw a.default.error(`Error opening database: ${e.message}`),e;a.default.info(`Connected to the database at ${this.dbPath}`)}))}async initialize(){await this.runMigrations()}async runMigrations(){let e=process.env.MIGRATIONS_PATH;if(!e&&(e=function(e){let t=e,o=0;for(;t!==s.parse(t).root;){o++;const e=s.join(t,"migrations");if(a.default.info(`Searching for migrations in: ${e}`),i.existsSync(e)){const t=i.readdirSync(e).filter((e=>e.endsWith(".sql")));if(t.length>0)return a.default.info(`Found ${t.length} SQL files in ${e}`),e}t=s.dirname(t)}return a.default.info(`Searched ${o} directories, but no valid migrations directory found.`),null}(__dirname),!e)){const e="Unable to find migrations directory";throw a.default.error(e),new Error(e)}a.default.info(`Using migrations directory: ${e}`);if(0===i.readdirSync(e).filter((e=>e.endsWith(".sql"))).length){const t=`No .sql files found in migrations directory: ${e}`;throw a.default.error(t),new Error(t)}const t=new c.Flyway({url:`jdbc:sqlite:${this.dbPath}`,user:"",password:"",migrationLocations:[`filesystem:${e}`]});try{const e=await t.migrate();if(!e.success)throw a.default.error("Migration failed: %s",JSON.stringify(e)),new Error(`Migration failed: ${e.error.message}`);a.default.info("Database migration completed successfully")}catch(e){throw console.log(e),a.default.error("Error running database migrations",e),e}}async query(e,t=[]){return new Promise(((o,n)=>{this.db.all(e,t,((e,t)=>{e?n(e):o(t)}))}))}async run(e,t=[]){return new Promise(((o,n)=>{this.db.run(e,t,(e=>{e?n(e):o()}))}))}async close(){return new Promise(((e,t)=>{this.db.close((o=>{o?t(o):e()}))}))}buildPaginationQuery(e,t){const o=(t.page-1)*t.limit;return`${e} LIMIT ${t.limit} OFFSET ${o}`}buildSortQuery(e,t){return`${e} ORDER BY ${t.field} ${t.order}`}}t.AppDataSource=u;let d=null;t.getDataSource=async()=>(d||(d=new u,await d.initialize()),d);t.initializeDataSource=async()=>{await(0,t.getDataSource)()}},376:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DataSourceModule=void 0;const r=o(3563),s=o(2776);let i=class{};t.DataSourceModule=i,t.DataSourceModule=i=n([(0,r.Module)({providers:[{provide:"DATA_SOURCE",useFactory:async()=>(await(0,s.initializeDataSource)(),(0,s.getDataSource)())}],exports:["DATA_SOURCE"]})],i)},1544:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ChatModelManager=void 0;const n=o(4264),r=o(1986),s=o(2003),i=o(8884),a=o(9055);class c{constructor(){this.providers=[new n.OpenAIProvider,new r.AnthropicProvider]}static getInstance(){return c.instance||(c.instance=new c),c.instance}static getChatModel(e){return c.getInstance().getChatModel(e)}getProvider(e){const t=e||(0,i.getEnv)("LLM_PROVIDER","anthropic");if(!t)throw new Error("No LLM provider specified");return a.default.info(`Using provider: ${t}`),this.providers.find((e=>e.getName()===t))}getChatModel(e){return this.getProvider(e.provider).getModel(e||new s.AgentConfig)}calculateCost(e,t,o){const n=this.providers.find((t=>t.getName()===e));if(!n)throw new Error(`Unsupported LLM provider: ${e}`);return n.calculateCost(t,o)}}t.ChatModelManager=c},1e3:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointerService=void 0;const s=o(3563),i=o(9314);let a=class{constructor(){this.checkpointer=new i.MemorySaver}getCheckpointer(){return this.checkpointer}};t.CheckpointerService=a,t.CheckpointerService=a=n([(0,s.Injectable)(),r("design:paramtypes",[])],a)},9449:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.LangchainModule=void 0;const r=o(3563),s=o(1e3);let i=class{};t.LangchainModule=i,t.LangchainModule=i=n([(0,r.Module)({providers:[s.CheckpointerService],exports:[s.CheckpointerService]})],i)},6254:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageUtils=void 0;const n=o(1486),r=o(9055);class s{static processOutputEvent(e){let t,o=e.messages,i="AI",a="No content found";if(!o&&e.agent&&e.agent.messages?o=e.agent.messages:!o&&e.tools&&e.tools.messages&&(o=e.tools.messages,i="Tool"),o&&o.length>0){const c=o[o.length-1];if(c instanceof n.ToolMessage||"tool"===c.type){return{label:"Tool",content:`Calling ${c.name||"Unknown Tool"}\nOutput was:\n${s.processContent(c.content)}`}}if(c instanceof n.AIMessage)return a=s.processContent(c.content),t=this.extractUsageMetadata(c),a.trim().length<1?(r.default.warn("AI message has empty content %s",{lastMessage:JSON.stringify(c)}),{label:"AI",content:JSON.stringify(c),usageMetadata:t}):{label:"AI",content:a,usageMetadata:t};if(c instanceof n.HumanMessage)return a=s.processContent(c.content),{label:"Human",content:a};if(c instanceof n.BaseMessage)return a=s.processContent(c.content),{label:i,content:a};r.default.warn("Processing unknown output using strings",{output:JSON.stringify(e)});const l=JSON.stringify(c),u=JSON.parse(l);if("kwargs"in u&&u.kwargs&&u.kwargs.content)return a=u.kwargs.content,t=this.extractUsageMetadata(u),{label:i,content:a,usageMetadata:t}}return r.default.warn("Processing unknown output: %s",{output:JSON.stringify(e)}),{label:"Unknown",content:JSON.stringify(e)}}static processContent(e){return Array.isArray(e)?e.filter((e=>"text"===e.type)).map((e=>e.text)).join("\n"):String(e)}static extractUsageMetadata(e){if(e.usage_metadata)return{inputTokens:e.usage_metadata.input_tokens,outputTokens:e.usage_metadata.output_tokens,totalTokens:e.usage_metadata.total_tokens}}}t.MessageUtils=s},1986:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AnthropicProvider=void 0;const n=o(646),r=o(8483),s=o(8884);class i extends r.BaseProvider{getName(){return"anthropic"}getModel(e){return new n.ChatAnthropic({modelName:this.getModelName(e,"claude-3-5-sonnet-20240620"),temperature:e.temperature,anthropicApiKey:(0,s.getEnv)("ANTHROPIC_API_KEY"),maxTokens:8192})}getCostPerInputToken(){return 225e-8}getCostPerOutputToken(){return 1125e-8}}t.AnthropicProvider=i},8483:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BaseProvider=void 0;const n=o(8884);t.BaseProvider=class{calculateCost(e,t){return e*this.getCostPerInputToken()+t*this.getCostPerOutputToken()}getModelName(e,t){if(e?.model)return e.model;const o=`${this.getName().toUpperCase()}_MODEL`,r=(0,n.getEnv)(o);return r||t}}},4264:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OpenAIProvider=void 0;const n=o(6228),r=o(8483),s=o(8884);class i extends r.BaseProvider{getName(){return"openai"}getModel(e){return new n.ChatOpenAI({modelName:this.getModelName(e,"gpt-4o"),temperature:e.temperature,openAIApiKey:(0,s.getEnv)("OPENAI_API_KEY")})}getCostPerInputToken(){return 6e-6}getCostPerOutputToken(){return 12e-6}}t.OpenAIProvider=i},2231:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentsController=void 0;const s=o(3563),i=o(7504);let a=class{constructor(e){this.agentsService=e}getAgents(){return this.agentsService.getAgents()}};t.AgentsController=a,n([(0,s.Get)(),r("design:type",Function),r("design:paramtypes",[]),r("design:returntype",void 0)],a.prototype,"getAgents",null),t.AgentsController=a=n([(0,s.Controller)("agents"),r("design:paramtypes",[i.AgentsService])],a)},7535:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentsModule=void 0;const r=o(3563),s=o(2231),i=o(7504);let a=class{};t.AgentsModule=a,t.AgentsModule=a=n([(0,r.Module)({controllers:[s.AgentsController],providers:[i.AgentsService]})],a)},7504:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentsService=void 0;const r=o(3563);let s=class{getAgents(){return[{name:"DevOps Agent",url:"/agents/devops-agent"},{name:"SE Agent",url:"/se-agent"}]}};t.AgentsService=s,t.AgentsService=s=n([(0,r.Injectable)()],s)},885:function(e,t,o){var n,r=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionController=void 0;const a=o(3563),c=o(9556),l=o(4562),u=o(8461);let d=class{constructor(e){this.audioTranscriptionService=e}async transcribeAudio(e){try{return{transcription:await this.audioTranscriptionService.transcribe(e.buffer.toString("base64"))}}catch(e){throw console.error("Transcription error:",e),new Error("An error occurred during transcription")}}};t.AudioTranscriptionController=d,r([(0,a.Post)(),(0,a.UseInterceptors)((0,c.FileInterceptor)("audio")),i(0,(0,a.UploadedFile)()),s("design:type",Function),s("design:paramtypes",["function"==typeof(n=void 0!==u.Multer&&u.Multer.File)?n:Object]),s("design:returntype",Promise)],d.prototype,"transcribeAudio",null),t.AudioTranscriptionController=d=r([(0,a.Controller)("audio-transcription"),s("design:paramtypes",[l.AudioTranscriptionService])],d)},3049:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionModule=void 0;const r=o(3563),s=o(885),i=o(4562);let a=class{};t.AudioTranscriptionModule=a,t.AudioTranscriptionModule=a=n([(0,r.Module)({controllers:[s.AudioTranscriptionController],providers:[i.AudioTranscriptionService,s.AudioTranscriptionController]})],a)},4562:function(e,t,o){var n,r=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionService=void 0;const s=o(3563),i=o(5317),a=o(9896),c=o(857),l=o(6928);let u=n=class{constructor(){this.logger=new s.Logger(n.name)}async transcribe(e){this.logger.debug("Starting audio transcription");const t=Buffer.from(e,"base64"),o=l.join(c.tmpdir(),`audio-${Date.now()}.wav`);await a.promises.writeFile(o,t),this.logger.debug(`Temporary file created: ${o}`);try{const e=await this.runFasterWhisperCLI(o);return this.logger.debug("Transcription completed successfully"),e}finally{await a.promises.unlink(o),this.logger.debug(`Temporary file deleted: ${o}`)}}runFasterWhisperCLI(e){return new Promise(((t,o)=>{const n=l.join(c.tmpdir(),`audio-${Date.now()}.srt`);this.logger.debug(`Running Faster Whisper CLI on file: ${e}`);const r=process.env.TRANSCRIPTION_LANGUAGE||"en",s=process.env.TRANSCRIPTION_COMPUTE_TYPE||"float32",u=[e,"-o",n,"--task","transcribe","--without_timestamps","True","--language",r,"--compute_type",s],d=`faster-whisper ${u.join(" ")}`;this.logger.log(`Executing command: ${d}`);const p=(0,i.spawn)("faster-whisper",u);p.stdout.on("data",(e=>{this.logger.debug(`Faster Whisper stdout: ${e}`)})),p.stderr.on("data",(e=>{this.logger.warn(`Faster Whisper stderr: ${e}`)})),p.on("error",(e=>{this.logger.error(`Error in Faster Whisper process: ${e}`),o(new Error("Error in Faster Whisper process - make sure you have run the ./scripts/install-faster-whisper.sh script"))})),p.on("close",(async e=>{if(0===e)try{const e=await a.promises.readFile(n,"utf-8");this.logger.debug(`SRT content: ${e}`);const o=this.parseSrtContent(e);this.logger.debug("Faster Whisper process completed successfully"),t(o)}catch(e){this.logger.error(`Error reading SRT file: ${e}`),o(new Error(`Error reading SRT file: ${e.message}`))}finally{await a.promises.unlink(n),this.logger.debug(`Temporary SRT file deleted: ${n}`)}else this.logger.error(`Faster Whisper process exited with code ${e}`),o(new Error(`Faster Whisper process exited with code ${e}`))}))}))}parseSrtContent(e){const t=e.split("\n");let o="";for(let e=0;e<t.length;e++)/^\d+$/.test(t[e])||/.*-->.*$/.test(t[e])||(o+=t[e].trim()+" ");return o.trim()}};t.AudioTranscriptionService=u,t.AudioTranscriptionService=u=n=r([(0,s.Injectable)()],u)},5015:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigController=void 0;const i=o(3563),a=o(2368);let c=class{constructor(e){this.configService=e}getConfig(){return this.configService.getConfig()}async getAllProperties(){return this.configService.getAllProperties()}async getProperty(e){return this.configService.getProperty(e)}async setProperty(e,t){return await this.configService.setProperty(e,t),{message:"Property set successfully"}}async unsetProperty(e){return await this.configService.unsetProperty(e),{message:"Property unset successfully"}}};t.ConfigController=c,n([(0,i.Get)(),r("design:type",Function),r("design:paramtypes",[]),r("design:returntype",void 0)],c.prototype,"getConfig",null),n([(0,i.Get)("properties"),r("design:type",Function),r("design:paramtypes",[]),r("design:returntype",Promise)],c.prototype,"getAllProperties",null),n([(0,i.Get)("property/:name"),s(0,(0,i.Param)("name")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],c.prototype,"getProperty",null),n([(0,i.Put)("property/:name"),s(0,(0,i.Param)("name")),s(1,(0,i.Body)("value")),r("design:type",Function),r("design:paramtypes",[String,String]),r("design:returntype",Promise)],c.prototype,"setProperty",null),n([(0,i.Delete)("property/:name"),s(0,(0,i.Param)("name")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],c.prototype,"unsetProperty",null),t.ConfigController=c=n([(0,i.Controller)("config"),r("design:paramtypes",[a.ConfigService])],c)},1080:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigProperty=void 0;t.ConfigProperty=class{constructor(e,t){this.name=e,this.value=t}}},7967:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigModule=void 0;const r=o(3563),s=o(5015),i=o(2368),a=o(5699),c=o(2776);let l=class{};t.ConfigModule=l,t.ConfigModule=l=n([(0,r.Module)({controllers:[s.ConfigController],providers:[i.ConfigService,a.ConfigPropertyRepository,{provide:"DATA_SOURCE",useFactory:()=>c.AppDataSource}],exports:[i.ConfigService,a.ConfigPropertyRepository]})],l)},5699:function(e,t,o){var n,r=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigPropertyRepository=void 0;const a=o(3563),c=o(2776),l=o(1080);let u=n=class{constructor(e){this.dataSource=e,this.logger=new a.Logger(n.name)}async getProperty(e){try{const t=await this.dataSource.query("SELECT value FROM config_properties WHERE name = ?",[e]);return t[0]?.value||null}catch(t){return this.logger.error(`Error getting property ${e}`,t),null}}async setProperty(e,t){try{null===t?await this.dataSource.run("DELETE FROM config_properties WHERE name = ?",[e]):await this.dataSource.run("INSERT OR REPLACE INTO config_properties (name, value) VALUES (?, ?)",[e,t])}catch(t){this.logger.error(`Error setting property ${e}`,t)}}async getAllProperties(){try{if("function"!=typeof this.dataSource.query)return this.logger.warn("DataSource query method not available, returning empty array"),[];return(await this.dataSource.query("SELECT * FROM config_properties")).map((e=>new l.ConfigProperty(e.name,e.value)))}catch(e){return this.logger.error("Error getting all properties",e),[]}}async deleteProperty(e){try{await this.dataSource.run("DELETE FROM config_properties WHERE name = ?",[e])}catch(t){this.logger.error(`Error deleting property ${e}`,t)}}};t.ConfigPropertyRepository=u,t.ConfigPropertyRepository=u=n=r([(0,a.Injectable)(),i(0,(0,a.Inject)("DATA_SOURCE")),s("design:paramtypes",[c.AppDataSource])],u)},2368:function(e,t,o){var n,r=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigService=void 0;const i=o(3563),a=o(5699);let c=n=class{constructor(e){this.configPropertyRepository=e,this.configCache=new Map,this.logger=new i.Logger(n.name)}async onModuleInit(){try{await this.loadConfigToCache()}catch(e){this.logger.error("Failed to load config properties to cache",e)}}async loadConfigToCache(){try{const e=await this.configPropertyRepository.getAllProperties();this.configCache.clear();for(const t of e)this.configCache.set(t.name,t.value);this.logger.log("Config properties loaded to cache successfully")}catch(e){throw this.logger.error("Error loading config properties to cache",e),e}}getConfig(){return{version:"0.4.2",maskedAnthropicApiKey:this.maskApiKey(process.env.ANTHROPIC_API_KEY)}}getProperty(e,t){const o=process.env[e];if(void 0!==o)return o;const n=this.configCache.get(e);return void 0!==n?n:t||null}async setProperty(e,t){try{await this.configPropertyRepository.setProperty(e,t),this.configCache.set(e,t)}catch(t){throw this.logger.error(`Error setting property ${e}`,t),t}}async unsetProperty(e){try{await this.configPropertyRepository.deleteProperty(e),this.configCache.delete(e)}catch(t){throw this.logger.error(`Error unsetting property ${e}`,t),t}}async getAllProperties(){return Array.from(this.configCache.entries()).map((([e,t])=>({name:e,value:t})))}maskApiKey(e){if(!e)return"not set";if(e.length<=12)return e;const t=e.length-8-4;return e.slice(0,8)+"*".repeat(t)+e.slice(-4)}};t.ConfigService=c,t.ConfigService=c=n=r([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigPropertyRepository])],c)},5754:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GitLogEntry=void 0;t.GitLogEntry=class{constructor(e,t,o,n){this.hash=e,this.message=t,this.timestamp=o,this.author=n}}},7265:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.GitController=void 0;const i=o(3563),a=o(5190);let c=class{constructor(e){this.gitService=e}async getGitLog(e){return this.gitService.getGitLog(e)}async getGitDiff(e,t){return this.gitService.getGitDiff(e,t)}async undoLastCommit(e){await this.gitService.undoLastCommit(e)}};t.GitController=c,n([(0,i.Get)(":workspaceName/log"),s(0,(0,i.Param)("workspaceName")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],c.prototype,"getGitLog",null),n([(0,i.Get)(":workspaceName/diff/:hash"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("hash")),r("design:type",Function),r("design:paramtypes",[String,String]),r("design:returntype",Promise)],c.prototype,"getGitDiff",null),n([(0,i.Post)(":workspaceName/undo-last-commit"),s(0,(0,i.Param)("workspaceName")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],c.prototype,"undoLastCommit",null),t.GitController=c=n([(0,i.Controller)("git"),r("design:paramtypes",[a.GitService])],c)},1901:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.GitModule=void 0;const r=o(3563),s=o(7265),i=o(5190),a=o(5873);let c=class{};t.GitModule=c,t.GitModule=c=n([(0,r.Module)({imports:[a.WorkspaceModule],controllers:[s.GitController],providers:[i.GitService]})],c)},5190:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.GitService=void 0;const s=o(3563),i=o(8474),a=o(5317),c=o(9023),l=o(5754),u=(0,c.promisify)(a.exec);let d=class{constructor(e){this.workspaceService=e}async undoLastCommit(e){const t=await this.workspaceService.findOne(e);if(!t)throw new Error(`Workspace ${e} not found`);const o=`git -C ${t.repoBaseDir} reset --hard HEAD~1`;try{await u(o)}catch(e){throw new Error(`Failed to undo last commit: ${e.message}`)}}async getGitLog(e){const t=await this.workspaceService.findOne(e);if(!t)throw new Error(`Workspace ${e} not found`);const o=`git -C ${t.repoBaseDir} log -n 10 --pretty=format:'{"hash":"%h","message":"%s","timestamp":"%aI","author":"%an"}'`;try{const{stdout:e}=await u(o);return e.split("\n").map((e=>{const{hash:t,message:o,timestamp:n,author:r}=JSON.parse(e);return new l.GitLogEntry(t,o,n,r)}))}catch(e){throw new Error(`Failed to get git log: ${e.message}`)}}async getGitDiff(e,t){const o=await this.workspaceService.findOne(e);if(!o)throw new Error(`Workspace ${e} not found`);const n=`git -C ${o.repoBaseDir} show --unified ${t}`;try{const{stdout:e}=await u(n);return e}catch(e){throw new Error(`Failed to get git diff: ${e.message}`)}}};t.GitService=d,t.GitService=d=n([(0,s.Injectable)(),r("design:paramtypes",[i.WorkspaceService])],d)},5096:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldController=void 0;const s=o(3563),i=o(5533);let a=class{constructor(e){this.helloWorldService=e}getHello(){return this.helloWorldService.getHello()}};t.HelloWorldController=a,n([(0,s.Get)(),r("design:type",Function),r("design:paramtypes",[]),r("design:returntype",String)],a.prototype,"getHello",null),t.HelloWorldController=a=n([(0,s.Controller)("hello-world"),r("design:paramtypes",[i.HelloWorldService])],a)},6808:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldModule=void 0;const r=o(3563),s=o(5096),i=o(5533);let a=class{};t.HelloWorldModule=a,t.HelloWorldModule=a=n([(0,r.Module)({controllers:[s.HelloWorldController],providers:[i.HelloWorldService]})],a)},5533:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldService=void 0;const r=o(3563);let s=class{getHello(){return"Hello World!"}};t.HelloWorldService=s,t.HelloWorldService=s=n([(0,r.Injectable)()],s)},2303:(e,t)=>{var o;Object.defineProperty(t,"__esModule",{value:!0}),t.Mutation=t.MutationType=void 0,function(e){e.CREATE="create",e.UPDATE="update",e.DELETE="delete"}(o||(t.MutationType=o={}));t.Mutation=class{constructor(e,t,o,n,r,s,i,a,c){this.id=e,this.type=t,this.filePath=o,this.description=n,this.fileContentsBefore=r,this.fileContentsAfter=s,this.updatedAt=i,this.sessionId=a,this.linesChanged=c}}},672:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationRepository=void 0;const i=o(3563),a=o(2776),c=o(3903);let l=class{constructor(e){this.dataSource=e}async findAll(e,t){let o="SELECT * FROM mutations";return t&&(o=this.dataSource.buildSortQuery(o,t)),e&&(o=this.dataSource.buildPaginationQuery(o,e)),this.dataSource.query(o)}async findById(e){return(await this.dataSource.query("SELECT * FROM mutations WHERE id = ?",[e]))[0]||null}async findBySessionId(e,t,o){let n="SELECT * FROM mutations WHERE sessionId = ?";return o&&(n=this.dataSource.buildSortQuery(n,o)),t&&(n=this.dataSource.buildPaginationQuery(n,t)),this.dataSource.query(n,[e])}async findBySessionIds(e){const t=`SELECT * FROM mutations WHERE sessionId IN (${e.map((()=>"?")).join(",")})`;return this.dataSource.query(t,e)}async create(e){const t=(0,c.v4)(),o=(new Date).toISOString();return await this.dataSource.run("INSERT INTO mutations (id, type, filePath, description, fileContentsBefore, fileContentsAfter, sessionId, updatedAt, linesChanged) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",[t,e.type,e.filePath,e.description,e.fileContentsBefore,e.fileContentsAfter,e.sessionId,o,e.linesChanged]),t}async update(e,t){const o=Object.keys(t).map((e=>`${e} = ?`)).join(", "),n=Object.values(t);await this.dataSource.run(`UPDATE mutations SET ${o} WHERE id = ?`,[...n,e])}async delete(e){await this.dataSource.run("DELETE FROM mutations WHERE id = ?",[e])}};t.MutationRepository=l,t.MutationRepository=l=n([(0,i.Injectable)(),s(0,(0,i.Inject)("DATA_SOURCE")),r("design:paramtypes",[a.AppDataSource])],l)},9989:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsController=void 0;const i=o(3563),a=o(7602);let c=class{constructor(e){this.mutationsService=e}async getMutationsForSession(e){return this.mutationsService.getMutationsForSession(e)}async getMutation(e){return this.mutationsService.getMutation(e)}};t.MutationsController=c,n([(0,i.Get)("session/:sessionId"),s(0,(0,i.Param)("sessionId")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],c.prototype,"getMutationsForSession",null),n([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],c.prototype,"getMutation",null),t.MutationsController=c=n([(0,i.Controller)("mutations"),r("design:paramtypes",[a.MutationsService])],c)},3177:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsModule=void 0;const r=o(3563),s=o(376),i=o(9989),a=o(7602),c=o(672);let l=class{};t.MutationsModule=l,t.MutationsModule=l=n([(0,r.Module)({imports:[s.DataSourceModule],controllers:[i.MutationsController],providers:[a.MutationsService,c.MutationRepository],exports:[a.MutationsService]})],l)},7602:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsService=void 0;const s=o(3563),i=o(672);let a=class{constructor(e){this.mutationRepository=e}async getMutationsForSession(e){return(await this.mutationRepository.findBySessionId(e,void 0,{field:"updatedAt",order:"DESC"})).map((e=>({id:e.id,type:e.type,filePath:e.filePath,updatedAt:e.updatedAt,description:e.description,fileContentsBefore:e.fileContentsBefore,fileContentsAfter:e.fileContentsAfter,linesChanged:e.linesChanged})))}async getMutation(e){return this.mutationRepository.findById(e)}async createMutation(e){if(!e.sessionId)throw new Error("sessionId is required to create a mutation");const t=this.calculateLinesChanged(e.description);return await this.mutationRepository.create({...e,updatedAt:e.updatedAt||new Date,linesChanged:t})}async getLinesChangedForSession(e){return(await this.mutationRepository.findBySessionId(e)).reduce(((e,t)=>e+(t.linesChanged||0)),0)}async getLinesChangedBySessionIds(e){const t=await this.mutationRepository.findBySessionIds(e),o={};return t.forEach((e=>{o[e.sessionId]||(o[e.sessionId]=0),o[e.sessionId]+=e.linesChanged||0})),o}calculateLinesChanged(e){if(!e)return 0;const t=e.match(/<<<<<<< SEARCH\n([\s\S]*?)=======\n/),o=e.match(/=======\n([\s\S]*?)>>>>>>> REPLACE/);if(!t||!o)return 0;const n=t[1].split("\n"),r=o[1].split("\n");return this.levenshteinDistance(n,r)}levenshteinDistance(e,t){const o=[];for(let t=0;t<=e.length;t++)o[t]=[t];for(let e=0;e<=t.length;e++)o[0][e]=e;for(let n=1;n<=e.length;n++)for(let r=1;r<=t.length;r++)e[n-1]===t[r-1]?o[n][r]=o[n-1][r-1]:o[n][r]=Math.min(o[n-1][r]+1,o[n][r-1]+1,o[n-1][r-1]+1);return o[e.length][t.length]}};t.MutationsService=a,t.MutationsService=a=n([(0,s.Injectable)(),r("design:paramtypes",[i.MutationRepository])],a)},9095:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ItemRepository=void 0;const i=o(3563),a=o(2776);let c=class{constructor(e){this.dataSource=e}async findAll(e,t){let o="SELECT * FROM items";return t&&(o=this.dataSource.buildSortQuery(o,t)),e&&(o=this.dataSource.buildPaginationQuery(o,e)),this.dataSource.query(o)}async findById(e){return(await this.dataSource.query("SELECT * FROM items WHERE itemId = ?",[e]))[0]||null}async findBySessionId(e,t,o){let n="SELECT * FROM items WHERE sessionId = ?";return o&&(n=this.dataSource.buildSortQuery(n,o)),t&&(n=this.dataSource.buildPaginationQuery(n,t)),this.dataSource.query(n,[e])}async create(e){await this.dataSource.run("INSERT INTO items (itemId, sessionId, label, content, createdAt, input_tokens, output_tokens, total_tokens, cost) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",[e.itemId,e.sessionId,e.label,e.content,e.createdAt,e.inputTokens,e.outputTokens,e.totalTokens,e.cost])}async update(e,t){const o=Object.keys(t).map((e=>`${e} = ?`)).join(", "),n=Object.values(t);await this.dataSource.run(`UPDATE items SET ${o} WHERE itemId = ?`,[...n,e])}async delete(e){await this.dataSource.run("DELETE FROM items WHERE itemId = ?",[e])}async countBySessionId(e){return(await this.dataSource.query("SELECT COUNT(*) as count FROM items WHERE sessionId = ?",[e]))[0].count}async getSessionStats(e){const t=`\n      SELECT \n        sessionId,\n        SUM(COALESCE(input_tokens, 0)) as inputTokens,\n        SUM(COALESCE(output_tokens, 0)) as outputTokens,\n        SUM(COALESCE(total_tokens, 0)) as totalTokens,\n        SUM(COALESCE(cost, 0)) as cost\n      FROM items\n      WHERE sessionId IN (${e.map((()=>"?")).join(",")})\n      GROUP BY sessionId\n    `,o=await this.dataSource.query(t,e),n={};return o.forEach((e=>{n[e.sessionId]={inputTokens:e.inputTokens,outputTokens:e.outputTokens,totalTokens:e.totalTokens,cost:e.cost,linesChanged:0}})),n}};t.ItemRepository=c,t.ItemRepository=c=n([(0,i.Injectable)(),s(0,(0,i.Inject)("DATA_SOURCE")),r("design:paramtypes",[a.AppDataSource])],c)},811:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.RequestRepository=void 0;const i=o(3563),a=o(2776);let c=class{constructor(e){this.dataSource=e}async findAll(e,t){let o="SELECT * FROM requests";return t&&(o=this.dataSource.buildSortQuery(o,t)),e&&(o=this.dataSource.buildPaginationQuery(o,e)),this.dataSource.query(o)}async findById(e){return(await this.dataSource.query("SELECT * FROM requests WHERE requestId = ?",[e]))[0]||null}async findBySessionId(e,t,o){let n="SELECT * FROM requests WHERE sessionId = ?";return o&&(n=this.dataSource.buildSortQuery(n,o)),t&&(n=this.dataSource.buildPaginationQuery(n,t)),this.dataSource.query(n,[e])}async create(e){await this.dataSource.run("INSERT INTO requests (requestId, sessionId, requestContent, responseContent, startedAt, endedAt, tookMillis, inputTokens, outputTokens, totalTokens, cost) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[e.requestId,e.sessionId,e.requestContent,e.responseContent,e.startedAt,e.endedAt,e.tookMillis,e.inputTokens,e.outputTokens,e.totalTokens,e.cost])}async update(e,t){const o=Object.keys(t).map((e=>`${e} = ?`)).join(", "),n=Object.values(t);await this.dataSource.run(`UPDATE requests SET ${o} WHERE requestId = ?`,[...n,e])}async delete(e){await this.dataSource.run("DELETE FROM requests WHERE requestId = ?",[e])}async countBySessionId(e){return(await this.dataSource.query("SELECT COUNT(*) as count FROM requests WHERE sessionId = ?",[e]))[0].count}};t.RequestRepository=c,t.RequestRepository=c=n([(0,i.Injectable)(),s(0,(0,i.Inject)("DATA_SOURCE")),r("design:paramtypes",[a.AppDataSource])],c)},5480:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionController=void 0;const i=o(3563),a=o(7373),c=o(573);let l=class{constructor(e){this.sessionService=e}async createSession(e,t,o=""){return this.sessionService.ensureSession(e,t,o)}async getSessions(e=1,t=10,o="createdAt",n="DESC"){return this.sessionService.getSessions(e,t,o,n)}async getSession(e){return this.sessionService.getSession(e)}async deleteSession(e){return this.sessionService.deleteSession(e)}async getItemsForSession(e,t=1,o=100,n="ASC"){const[r,s]=await this.sessionService.getItemsForSession(e,t,o,n);return{items:r,total:s}}streamSessionItems(e){return this.sessionService.streamSessionItems(e)}async abortSession(e){return this.sessionService.abortSession(e)}};t.SessionController=l,n([(0,i.Post)(),s(0,(0,i.Body)("workspaceName")),s(1,(0,i.Body)("sessionId")),s(2,(0,i.Body)("requestContent")),r("design:type",Function),r("design:paramtypes",[String,String,String]),r("design:returntype",Promise)],l.prototype,"createSession",null),n([(0,i.Get)(),s(0,(0,i.Query)("page")),s(1,(0,i.Query)("limit")),s(2,(0,i.Query)("sortBy")),s(3,(0,i.Query)("sortOrder")),r("design:type",Function),r("design:paramtypes",[Number,Number,String,String]),r("design:returntype",Promise)],l.prototype,"getSessions",null),n([(0,i.Get)(":sessionId"),s(0,(0,i.Param)("sessionId")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],l.prototype,"getSession",null),n([(0,i.Delete)(":sessionId"),s(0,(0,i.Param)("sessionId")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],l.prototype,"deleteSession",null),n([(0,i.Get)(":sessionId/items"),s(0,(0,i.Param)("sessionId")),s(1,(0,i.Query)("page")),s(2,(0,i.Query)("limit")),s(3,(0,i.Query)("sortOrder")),r("design:type",Function),r("design:paramtypes",[String,Number,Number,String]),r("design:returntype",Promise)],l.prototype,"getItemsForSession",null),n([(0,i.Sse)(":sessionId/stream"),s(0,(0,i.Param)("sessionId")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",c.Observable)],l.prototype,"streamSessionItems",null),n([(0,i.Post)(":sessionId/abort"),s(0,(0,i.Param)("sessionId")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],l.prototype,"abortSession",null),t.SessionController=l=n([(0,i.Controller)("sessions"),r("design:paramtypes",[a.SessionService])],l)},3880:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionModule=void 0;const r=o(3563),s=o(376),i=o(5480),a=o(7373),c=o(3936),l=o(9095),u=o(811),d=o(3177);let p=class{};t.SessionModule=p,t.SessionModule=p=n([(0,r.Module)({imports:[s.DataSourceModule,d.MutationsModule],controllers:[i.SessionController],providers:[a.SessionService,c.SessionRepository,l.ItemRepository,u.RequestRepository],exports:[a.SessionService]})],p)},3936:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionRepository=void 0;const i=o(3563),a=o(2776);let c=class{constructor(e){this.dataSource=e}async findAll(e,t,o){let n="SELECT * FROM sessions",r="SELECT COUNT(*) as count FROM sessions";const s=[],i=[];if(o&&Object.entries(o).forEach((([e,t])=>{s.push(`${e} = ?`),i.push(t)})),s.length>0){const e=` WHERE ${s.join(" AND ")}`;n+=e,r+=e}t&&(n=this.dataSource.buildSortQuery(n,t));const a=(await this.dataSource.query(r,i))[0].count;if(e){const t=(e.page-1)*e.limit;n+=` LIMIT ${e.limit} OFFSET ${t}`}return{sessions:await this.dataSource.query(n,i),total:a}}async findById(e){return(await this.dataSource.query("SELECT * FROM sessions WHERE sessionId = ?",[e]))[0]||null}async create(e){await this.dataSource.run("INSERT INTO sessions (sessionId, workspaceName, status, createdAt, requestSnippet) VALUES (?, ?, ?, ?, ?)",[e.sessionId,e.workspaceName,e.status,e.createdAt,e.requestSnippet])}async update(e,t){const o=Object.keys(t).map((e=>`${e} = ?`)).join(", "),n=Object.values(t);await this.dataSource.run(`UPDATE sessions SET ${o} WHERE sessionId = ?`,[...n,e])}async delete(e){await this.dataSource.run("DELETE FROM sessions WHERE sessionId = ?",[e])}async count(e){let t="SELECT COUNT(*) as count FROM sessions";const o=[];if(e){t+=` WHERE ${Object.entries(e).map((([e,t])=>(o.push(t),`${e} = ?`))).join(" AND ")}`}return(await this.dataSource.query(t,o))[0].count}async createItem(e){await this.dataSource.run("INSERT INTO item (itemId, sessionId, label, content, createdAt, input_tokens, output_tokens, total_tokens) VALUES (?, ?, ?, ?, ?, ?, ?, ?)",[e.itemId,e.sessionId,e.label,e.content,e.createdAt,e.inputTokens,e.outputTokens,e.totalTokens])}async findItemsBySessionId(e){return this.dataSource.query("SELECT * FROM item WHERE sessionId = ? ORDER BY createdAt ASC",[e])}async updateItem(e,t){const o=Object.keys(t).map((e=>`${e} = ?`)).join(", "),n=Object.values(t);await this.dataSource.run(`UPDATE item SET ${o} WHERE itemId = ?`,[...n,e])}};t.SessionRepository=c,t.SessionRepository=c=n([(0,i.Injectable)(),s(0,(0,i.Inject)("DATA_SOURCE")),r("design:paramtypes",[a.AppDataSource])],c)},7373:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionService=void 0;const s=o(3563),i=o(573),a=o(4434),c=o(3936),l=o(9095),u=o(811),d=o(7602),p=o(9055);let f=class{constructor(e,t,o,n){this.sessionRepository=e,this.itemRepository=t,this.requestRepository=o,this.mutationsService=n,this.eventEmitter=new a.EventEmitter}async getSessions(e=1,t=10,o="createdAt",n="DESC"){const{sessions:r,total:s}=await this.sessionRepository.findAll({page:e,limit:t},{field:o,order:n}),i=r.map((e=>e.sessionId)),a=await this.itemRepository.getSessionStats(i),c=await this.mutationsService.getLinesChangedBySessionIds(i);return{sessions:r.map((e=>({...e,stats:{inputTokens:0,outputTokens:0,totalTokens:0,cost:0,...a[e.sessionId]||{},linesChanged:c[e.sessionId]||0}}))),total:s}}async getSessionStats(e){const t=await this.itemRepository.getSessionStats([e]),o=await this.mutationsService.getLinesChangedForSession(e);return{...t[e]||{inputTokens:0,outputTokens:0,totalTokens:0,cost:0},linesChanged:o}}async ensureSession(e,t,o){const n=await this.sessionRepository.findById(t);if(n){if(n.workspaceName!==e)throw new Error(`Session ${t} exists but belongs to a different workspace`);if("active"===n.status)throw new Error(`Session ${t} is currently active`);return n.requestSnippet||(n.requestSnippet=o.slice(0,250),await this.sessionRepository.update(t,{requestSnippet:n.requestSnippet})),n}const r={sessionId:t,workspaceName:e,status:"inactive",createdAt:new Date,requestSnippet:o.slice(0,250)};return await this.sessionRepository.create(r),r}async getSession(e){return this.sessionRepository.findById(e)}async deleteSession(e){await this.sessionRepository.delete(e)}async deleteSessionForWorkspace(e,t){await this.sessionRepository.delete(t)}async addItem(e){return"AI"===e.label||"Human"===e.label?p.default.info("Adding item to session: %s with label: %s, content: %s",e.sessionId,e.label,e.content):p.default.debug("Adding item to session %s with label %s, content: %s",e.sessionId,e.label,e.content),await this.itemRepository.create(e),this.eventEmitter.emit("newItem",e),e}async getItemsForSession(e,t=1,o=100,n="ASC"){return[await this.itemRepository.findBySessionId(e,{page:t,limit:o},{field:"createdAt",order:n}),await this.itemRepository.countBySessionId(e)]}streamSessionItems(e){return new i.Observable((t=>{this.getItemsForSession(e).then((([e])=>{e.forEach((e=>{t.next({data:e})}))}));const o=o=>{o.sessionId===e&&t.next({data:o})};return this.eventEmitter.on("newItem",o),()=>{this.eventEmitter.removeListener("newItem",o)}}))}async updateSessionStatus(e,t){await this.sessionRepository.update(e,{status:t})}async abortSession(e){if(!await this.sessionRepository.findById(e))throw new s.NotFoundException(`Session with id ${e} not found`);return await this.updateSessionStatus(e,"aborted"),this.sessionRepository.findById(e)}generateSessionId(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let o=0;o<10;o++)t+=e.charAt(Math.floor(62*Math.random()));return t}generateItemId(){return"item_"+Math.random().toString(36).substr(2,9)}async addRequest(e){return p.default.info("Adding request to session: %s, requestContent: %s, cost: £%s",e.sessionId,e.requestContent,e.cost?e.cost.toFixed(6):"N/A"),await this.requestRepository.create(e),e}};t.SessionService=f,t.SessionService=f=n([(0,s.Injectable)(),r("design:paramtypes",[c.SessionRepository,l.ItemRepository,u.RequestRepository,d.MutationsService])],f)},2397:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceController=void 0;const i=o(3563),a=o(8474);let c=class{constructor(e){this.workspaceService=e}async findAll(){return this.workspaceService.findAll()}async findOne(e){return this.workspaceService.findOne(e)}async create(e){return this.workspaceService.createWorkspace(e.repoBaseDir,e.name)}async update(e,t){return this.workspaceService.updateWorkspace(e,t.buildOrTestCommand)}async remove(e){return this.workspaceService.removeWorkspace(e)}};t.WorkspaceController=c,n([(0,i.Get)(),r("design:type",Function),r("design:paramtypes",[]),r("design:returntype",Promise)],c.prototype,"findAll",null),n([(0,i.Get)(":name"),s(0,(0,i.Param)("name")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],c.prototype,"findOne",null),n([(0,i.Post)(),s(0,(0,i.Body)()),r("design:type",Function),r("design:paramtypes",[Object]),r("design:returntype",Promise)],c.prototype,"create",null),n([(0,i.Patch)(":name"),s(0,(0,i.Param)("name")),s(1,(0,i.Body)()),r("design:type",Function),r("design:paramtypes",[String,Object]),r("design:returntype",Promise)],c.prototype,"update",null),n([(0,i.Delete)(":name"),s(0,(0,i.Param)("name")),r("design:type",Function),r("design:paramtypes",[String]),r("design:returntype",Promise)],c.prototype,"remove",null),t.WorkspaceController=c=n([(0,i.Controller)("workspace"),r("design:paramtypes",[a.WorkspaceService])],c)},5873:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceModule=void 0;const r=o(3563),s=o(2397),i=o(8474),a=o(4717),c=o(376);let l=class{};t.WorkspaceModule=l,t.WorkspaceModule=l=n([(0,r.Module)({imports:[c.DataSourceModule],controllers:[s.WorkspaceController],providers:[i.WorkspaceService,a.WorkspaceRepository],exports:[i.WorkspaceService]})],l)},4717:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceRepository=void 0;const i=o(3563),a=o(2776);let c=class{constructor(e){this.dataSource=e}async findAll(e,t){let o="SELECT * FROM workspaces";return t&&(o=this.dataSource.buildSortQuery(o,t)),e&&(o=this.dataSource.buildPaginationQuery(o,e)),this.dataSource.query(o)}async findByName(e){return(await this.dataSource.query("SELECT * FROM workspaces WHERE name = ?",[e]))[0]||null}async create(e){await this.dataSource.run("INSERT INTO workspaces (name, repoBaseDir, remoteRepoUrl, status, buildOrTestCommand) VALUES (?, ?, ?, ?, ?)",[e.name,e.repoBaseDir,e.remoteRepoUrl,e.status,e.buildOrTestCommand])}async update(e,t){const o=Object.keys(t).map((e=>`${e} = ?`)).join(", "),n=Object.values(t);await this.dataSource.run(`UPDATE workspaces SET ${o} WHERE name = ?`,[...n,e])}async delete(e){await this.dataSource.run("DELETE FROM workspaces WHERE name = ?",[e])}};t.WorkspaceRepository=c,t.WorkspaceRepository=c=n([(0,i.Injectable)(),s(0,(0,i.Inject)("DATA_SOURCE")),r("design:paramtypes",[a.AppDataSource])],c)},8474:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(s<3?r(i):s>3?r(t,o,i):r(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceService=void 0;const s=o(3563),i=o(4717),a=o(6928),c=o(5317),l=o(9023),u=o(9896),d=o(9055),p=(0,l.promisify)(c.exec);let f=class{constructor(e){this.workspaceRepository=e}async updateWorkspace(e,t){const o=await this.workspaceRepository.findByName(e);if(!o)throw new s.NotFoundException(`Workspace with name ${e} not found`);return o.buildOrTestCommand=t,await this.workspaceRepository.update(e,{buildOrTestCommand:t}),d.default.info(`Workspace updated successfully: ${JSON.stringify(o)}`),o}async createWorkspace(e,t){const o=t||a.basename(e);if(await this.workspaceRepository.findByName(o))throw new s.BadRequestException("A workspace with the same name already exists");if(!u.existsSync(e)||!u.statSync(e).isDirectory())throw new s.BadRequestException("The specified repository directory does not exist or is not a directory");try{await this.isValidGitRepo(e)}catch(e){throw new s.BadRequestException("The specified directory is not a valid git repository")}const n={name:o,repoBaseDir:e,status:"Created",remoteRepoUrl:"",buildOrTestCommand:null};try{n.remoteRepoUrl=await this.getRemoteRepoUrl(e),await this.getCurrentBranch(e)}catch(e){console.error("Error getting Git information:",e),n.status="Error: Unable to get Git information"}return await this.workspaceRepository.create(n),d.default.info(`Workspace created successfully: ${JSON.stringify(n)}`),n}async findAll(){return this.workspaceRepository.findAll()}async findOne(e){return this.workspaceRepository.findByName(e)}async removeWorkspace(e){if(!await this.workspaceRepository.findByName(e))throw new s.NotFoundException(`Workspace with name ${e} not found`);await this.workspaceRepository.delete(e),d.default.info(`Workspace removed successfully: ${e}`)}async getRemoteRepoUrl(e){const{stdout:t}=await p("git config --get remote.origin.url",{cwd:e});return t.trim()}async getCurrentBranch(e){const{stdout:t}=await p("git rev-parse --abbrev-ref HEAD",{cwd:e});return t.trim()}async isValidGitRepo(e){try{return await p("git rev-parse --is-inside-work-tree",{cwd:e}),!0}catch(e){return!1}}};t.WorkspaceService=f,t.WorkspaceService=f=n([(0,s.Injectable)(),r("design:paramtypes",[i.WorkspaceRepository])],f)},3765:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CommandLine=void 0;const n=o(3153),r=o(1569),s=o(5317),i=(0,o(9023).promisify)(s.exec);class a extends n.Tool{constructor(e){super(),this.name="command_line",this.description="Execute a command line instruction in the workspace directory",this.schema=r.z.object({command:r.z.string().describe("The command to execute")}),this.workspaceRootDir=e,this.maxOutputChars=parseInt(process.env.MAX_TOOL_OUTPUT_CHARS||"2000",10)}clipOutput(e){return e.length>this.maxOutputChars?`Large output detected so clipped to last ${this.maxOutputChars} chars...\n${e.slice(-this.maxOutputChars)}`:e}async _call({command:e}){try{const{stdout:t,stderr:o}=await i(e,{cwd:this.workspaceRootDir}),n=this.clipOutput(t);return`Executed Command:\n${e}\nOutput:\n${n}${this.clipOutput(o)}`}catch(t){const o=t.stdout||"",n=t.stderr||"";return`Executed Command:\n${e}\nOutput:\n${this.clipOutput(o)}${this.clipOutput(n)}\nError:\n${this.clipOutput(t.message)}`}}}t.CommandLine=a},7465:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteFile=void 0;const n=o(3153),r=o(1569),s=o(9896),i=o(6928);class a extends n.Tool{constructor(e){super(),this.name="delete_file",this.description="Delete a file from the workspace",this.schema=r.z.object({filePath:r.z.string().describe("The relative path of the file to delete")}),this.workspaceRootDir=e}async _call(e){return this.deleteFile(e.filePath)}deleteFile(e){const t=i.join(this.workspaceRootDir,e);try{return s.existsSync(t)?(s.unlinkSync(t),`Successfully deleted file: ${e}`):`Error: File not found - ${e}`}catch(e){return`Error deleting file: ${e.message}`}}}t.DeleteFile=a},7027:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DevOpsTool=void 0;const n=o(3153),r=o(1569),s=o(5317),i=(0,o(9023).promisify)(s.exec);t.DevOpsTool=(0,n.tool)((async({command:e})=>{try{const{stdout:t,stderr:o}=await i(e);return o?`Command executed with errors: ${o}`:t}catch(e){return`Error executing command: ${e.message}`}}),{name:"devops",description:"Execute a shell command and return the output.",schema:r.z.object({command:r.z.string().describe("The shell command to execute.")})})},4548:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ExampleWeatherTool=void 0;const n=o(3153),r=o(1569);t.ExampleWeatherTool=(0,n.tool)((async({query:e})=>e.toLowerCase().includes("sf")||e.toLowerCase().includes("san francisco")?"It's 60 degrees and foggy in San Francisco.":"I'm sorry, I don't have weather information for that location."),{name:"weather",description:"Get the current weather for a location.",schema:r.z.object({query:r.z.string().describe("The location to get weather information for.")})})},4970:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ReadFile=void 0;const n=o(3153),r=o(1569),s=o(9896),i=o(6928),a=o(9055);class c extends n.Tool{constructor(e){super(),this.name="read_file",this.description="Read the content of a file in the workspace",this.schema=r.z.object({filePath:r.z.string().describe("The relative path of the file to read")}),this.workspaceRootDir=e}async _call(e){return this.readFile(e.filePath)}readFile(e){a.default.debug("ReadFile.readFile called with:",{filePath:e});const t=i.join(this.workspaceRootDir,e);try{return s.readFileSync(t,"utf-8")}catch(t){return"ENOENT"===t.code?`Error: File not found - ${e}`:`Error reading file: ${t.message}`}}}t.ReadFile=c},5515:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ReadWorkspaceTree=void 0;const n=o(3153),r=o(1569),s=o(9896),i=o(6928),a=o(526);class c extends n.Tool{constructor(e){super(),this.name="read_workspace_tree",this.description="Read the workspace file tree, respecting .gitignore and .aiderignore files",this.schema=r.z.object({}),this.workspaceRootDir=e}async _call(){return c.generateWorkspaceTree(this.workspaceRootDir)}static generateWorkspaceTree(e){if(!s.existsSync(e)||!s.statSync(e).isDirectory())return`Error: ${e} is not a valid directory.`;const t=c.parseIgnoreFiles(e);return`File tree for ${e}:\n.\n${c.generateTree(e,t,e)}`}static parseIgnoreFiles(e){const t=(0,a.default)();t.add([".git"]);return[".gitignore",".aiderignore",".hldkignore"].forEach((o=>{const n=i.join(e,o);if(s.existsSync(n)){const e=s.readFileSync(n,"utf-8");t.add(e)}})),t}static generateTree(e,t,o,n=""){let r=[];const a=s.readdirSync(e).sort();return a.forEach(((l,u)=>{const d=i.join(e,l),p=i.relative(o,d);if(t.ignores(p))return;const f=u===a.length-1;r.push(`${n}${f?"└── ":"├── "}${l}`),s.statSync(d).isDirectory()&&r.push(c.generateTree(d,t,o,n+(f?"    ":"│   ")))})),r.join("\n")}}t.ReadWorkspaceTree=c},3923:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFile=void 0;const n=o(3153),r=o(1569),s=o(9896),i=o(6928),a=o(9055),c=o(2303);class l extends n.Tool{constructor(e,t,o){super(),this.name="update_file",this.description="Update the content of a file in the workspace by providing the path of the file to update, the text block to search for in the file content, and the text block to replace the search block with. All 3 arguments are required filePath, search & replace.",this.schema=r.z.object({filePath:r.z.string().describe("The relative path of the file to update"),search:r.z.string().describe("The text block to search for in the file content"),replace:r.z.string().describe("The text block to replace the search block with - DO NOT FORGET TO INCLUDE THIS!!!")}),this.workspaceRootDir=e,this.mutationsService=t,this.sessionId=o}async _call(e){return this.updateFile(e.filePath,e.search,e.replace)}async updateFile(e,t,o){a.default.debug("UpdateFile.updateFile called with:",{filePath:e,search:t,replace:o});const n=i.join(this.workspaceRootDir,e);try{let r,a,l=!1;if(s.existsSync(n)||null!==t&&""!==t){r=s.readFileSync(n,"utf-8");const e=r.indexOf(t);if(-1===e)return"Error: failed to find search block in file content.";a=r.slice(0,e)+o+r.slice(e+t.length),s.writeFileSync(n,a,"utf-8")}else{const e=i.dirname(n);s.mkdirSync(e,{recursive:!0}),s.writeFileSync(n,o,"utf-8"),r="",a=o,l=!0}const u=l?`Successfully created new file: ${e}\n<<<<<<< CONTENT\n${o}\n>>>>>>>>`:`Successfully updated file: ${e}\n<<<<<<< SEARCH\n${t}\n=======\n${o}\n>>>>>>>> REPLACE\n`;return await this.mutationsService.createMutation({type:l?c.MutationType.CREATE:c.MutationType.UPDATE,filePath:e,description:u,fileContentsBefore:r,fileContentsAfter:a,updatedAt:new Date,sessionId:this.sessionId}),u}catch(t){return"ENOENT"===t.code?`Error: File not found - ${e}`:`Error updating file: ${t.message}`}}}t.UpdateFile=l},8884:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getEnv=function(e,t){let o;"undefined"!=typeof process&&process.env?o=process.env[e]:"undefined"!=typeof globalThis&&"Deno"in globalThis?o=globalThis.Deno.env.get(e):console.warn(`Unable to access environment variables. Key: ${e}`);return void 0!==o?o:t}},9055:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=o(5124),r=o(9896),s=o(6928),i=o(8884),a=o(9233),c=s.join(process.cwd(),"logs");r.existsSync(c)||r.mkdirSync(c,{recursive:!0});const l=s.join(c,"hldk-server-%DATE%.log"),u=(0,i.getEnv)("LOG_FILE_PATH",l);console.log(`Log file pattern: ${u}`);const d=new a({filename:u,datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"20m",maxFiles:"14d",level:"debug"}),p=n.format.printf((({level:e,message:t,timestamp:o})=>{const n=new Date(o);return`${`${(n.getMonth()+1).toString().padStart(2,"0")}/${n.getDate().toString().padStart(2,"0")}/${n.getFullYear()}, ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}:${n.getSeconds().toString().padStart(2,"0")} ${n.getHours()>=12?"PM":"AM"}`} - ${e.toUpperCase()}: ${t}`})),f=n.createLogger({level:"debug",format:n.format.combine(n.format.splat(),n.format.timestamp(),p),transports:[new n.transports.Console({level:"info"}),d]});t.default=f},646:e=>{e.exports=require("@langchain/anthropic")},1486:e=>{e.exports=require("@langchain/core/messages")},3153:e=>{e.exports=require("@langchain/core/tools")},9314:e=>{e.exports=require("@langchain/langgraph")},8804:e=>{e.exports=require("@langchain/langgraph/prebuilt")},6228:e=>{e.exports=require("@langchain/openai")},3563:e=>{e.exports=require("@nestjs/common")},8781:e=>{e.exports=require("@nestjs/core")},9556:e=>{e.exports=require("@nestjs/platform-express")},2810:e=>{e.exports=require("@nestjs/serve-static")},818:e=>{e.exports=require("dotenv")},7252:e=>{e.exports=require("express")},526:e=>{e.exports=require("ignore")},8461:e=>{e.exports=require("multer")},5095:e=>{e.exports=require("node-flyway")},1321:e=>{e.exports=require("reflect-metadata")},573:e=>{e.exports=require("rxjs")},6689:e=>{e.exports=require("sqlite3")},9100:e=>{e.exports=require("ulid")},3903:e=>{e.exports=require("uuid")},5124:e=>{e.exports=require("winston")},9233:e=>{e.exports=require("winston-daily-rotate-file")},1569:e=>{e.exports=require("zod")},5317:e=>{e.exports=require("child_process")},4434:e=>{e.exports=require("events")},9896:e=>{e.exports=require("fs")},857:e=>{e.exports=require("os")},6928:e=>{e.exports=require("path")},9023:e=>{e.exports=require("util")}},t={};function o(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,o),s.exports}(()=>{o(1321);const e=o(818),t=o(6928),n=o(8781),r=o(715),s=o(7252),i=o(6928),a=o(2776),c=o(9055);(0,e.config)({path:(0,t.resolve)(__dirname,"../.env")}),async function(){try{await(0,a.initializeDataSource)(),c.default.info("Database initialization and migration completed successfully")}catch(e){c.default.error("Error initializing database and running migrations:",e),process.exit(1)}const e=await n.NestFactory.create(r.AppModule);e.setGlobalPrefix("api"),e.enableCors({origin:["http://localhost:3011","http://localhost:3012","http://localhost:3013","http://localhost:3014"],methods:["GET","POST","PUT","PATCH","DELETE","OPTIONS"],allowedHeaders:"*",exposedHeaders:["Location"]}),e.use(s.static((0,i.join)(__dirname,"webui"))),e.use("*",((e,t,o)=>{e.originalUrl.startsWith("/api")?o():t.sendFile((0,i.join)(__dirname,"webui","index.html"))}));const t=process.env.PORT||3010;await e.listen(t);const o=`http://localhost:${t}`;console.log(`\nhldk-server is now available at: ${o}`)}()})()})();