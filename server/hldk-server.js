(()=>{var e={2003:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AgentConfig=void 0;t.AgentConfig=class{constructor(e,t=0,r=50,o=!0){this.model=e,this.temperature=t,this.recursionLimit=r,this.cachePrompt=o}}},1412:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AgentRequest=void 0;const o=r(2003),s=r(9100);class n{constructor(e,t,r,s=new o.AgentConfig,i){this.sender=e,this.content=t,this.sessionId=r,this.config=s,this.workspaceName=i,this.sessionId=r||n.generateRandomSessionId()}static fromJSON(e){const{sender:t,content:r,sessionId:s,config:i,workspaceName:a,agent:c}=e;if(!r)throw new Error("Missing required field 'content'");const l=i?Object.assign(new o.AgentConfig,i):new o.AgentConfig,u=s||n.generateRandomSessionId();return new n(t,r,u,l,a)}static generateRandomSessionId(){return(0,s.ulid)()}static getContentAsString(e){return"string"==typeof e?e:JSON.stringify(e)}}t.AgentRequest=n},7249:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StandardAgentStateManager=void 0;const o=r(9314),s=r(8804);t.StandardAgentStateManager=class{static createGraphState(){return{messages:{reducer:(e,t)=>e.concat(t)}}}static shouldContinue(e){const t=e.messages,r=t[t.length-1];return r.tool_calls?.length?"tools":"__end__"}static createWorkflow(e,t){const r=this.createGraphState(),n=new s.ToolNode(t);return new o.StateGraph({channels:r}).addNode("agent",(async t=>await e(t))).addNode("tools",n).addEdge("__start__","agent").addConditionalEdges("agent",this.shouldContinue).addEdge("tools","agent")}}},3520:function(e,t,r){"use strict";var o,s=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentController=void 0;const a=r(3563),c=r(1412);let l=o=class{constructor(e){this.agentServices=e,this.logger=new a.Logger(o.name)}getAgentService(e){const t=this.agentServices.get(e);if(!t)throw new Error(`Unknown agent: ${e}`);return t}async processRequestWithStream(e,t,r){try{const o=c.AgentRequest.fromJSON(t);r.setHeader("Content-Type","text/event-stream"),r.setHeader("Cache-Control","no-cache"),r.setHeader("Connection","keep-alive"),r.setHeader("Location",`/sessions/${o.sessionId}/stream`);for await(const t of this.getAgentService(e).processRequestStream(o))r.write(`data: ${JSON.stringify(t)}\n\n`);r.end()}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),r.setHeader("Content-Type","application/json"),r.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}async processRequestNoStream(e,t,r){try{const o=c.AgentRequest.fromJSON(t),s=await this.getAgentService(e).processRequest(o);r.setHeader("Content-Type","application/json"),r.json(s)}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),r.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}};t.AgentController=l,s([(0,a.Post)(":name/stream"),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),i(2,(0,a.Res)()),n("design:type",Function),n("design:paramtypes",[String,String,Object]),n("design:returntype",Promise)],l.prototype,"processRequestWithStream",null),s([(0,a.Post)(":name"),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),i(2,(0,a.Res)()),n("design:type",Function),n("design:paramtypes",[String,String,Object]),n("design:returntype",Promise)],l.prototype,"processRequestNoStream",null),t.AgentController=l=o=s([(0,a.Controller)("agents"),i(0,(0,a.Inject)("AGENT_SERVICES")),n("design:paramtypes",[Map])],l)},2177:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentsModule=void 0;const s=r(3563),n=r(3520),i=r(5017),a=r(3887),c=r(9354),l=r(361),u=r(1817),d={provide:"AGENT_SERVICES",useFactory:async(e,t,r)=>{const o=new Map;o.set("se-agent",e),o.set("ops-agent",t);return(await r.loadPlugins()).forEach((e=>{o.set(e.getName(),e)})),o},inject:[i.SEAgentService,a.OpsAgentService,u.PluginLoaderService]};let p=class{};t.AgentsModule=p,t.AgentsModule=p=o([(0,s.Module)({imports:[c.BaseAgentModule,l.ToolsModule],controllers:[n.AgentController],providers:[i.SEAgentService,a.OpsAgentService,u.PluginLoaderService,d],exports:[d]})],p)},2483:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestContext=void 0;const o=r(6426),s=r(9896),n=r(6928);t.RequestContext=class{constructor(e,t,r){this.workspace=e,this.requestId=t,this.sessionId=r}repositoryTree(){return(0,o.generateTree)(this.workspace.repoBaseDir)}repositoryHints(){const e=n.join(this.workspace.repoBaseDir,"hints.md");if(s.existsSync(e))return s.readFileSync(e,"utf-8")}}},4838:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentCollaborator=void 0;const n=r(3563),i=r(7373),a=r(1e3),c=r(1412),l=r(1544),u=r(7249),d=r(1486),p=r(9055),f=r(6254),h=r(9100),g=r(2483),y=r(8474),m=r(6910),w=r(2368),v=r(538);let S=class{constructor(e,t,r,o){this.workspaceService=e,this.sessionService=t,this.checkpointerService=r,this.homeService=o,this.chatModelManager=l.ChatModelManager.getInstance()}async processRequest(e,t){const r=this.processRequestStream(e,t);let o=null;for await(const e of r)o=e;if(!o)throw new Error("No items were yielded from the generator");const s=await this.sessionService.getRequest(o?.requestId);if(!s)throw new Error("Failed to retrieve persisted request");return s}async*processRequestStream(e,t){const r=(0,h.ulid)();if(!await this.homeService.isAccessOkay()){const e={label:"Error",content:"Access is not valid. Please check your HLDK API key and try again."},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId||this.generateSessionId(),label:e.label,content:e.content,createdAt:new Date,requestId:r});return void(yield o)}if(t.sessionId||(t.sessionId=this.generateSessionId()),!t.workspaceName)throw new Error("Workspace name is required in the agent request");const o=await this.workspaceService.findOne(t.workspaceName),s=new g.RequestContext(o,r,t.sessionId);await e.verifyRequest(t,s);const n=c.AgentRequest.getContentAsString(t.content),i=await this.sessionService.ensureSession(t.workspaceName,t.sessionId,n,e.getName());await this.sessionService.updateSessionStatus(i.sessionId,"active"),p.default.info("%s received request: %s - %s",e.getName(),r,JSON.stringify(t));const a=await this.chatModelManager.getModel(t.config,e.getModelCategory());p.default.info("Using model: %s",a.modelDescriptor.getFullName());const l=await e.getTools(s),y=a.baseChatModel.bindTools(l);var v=await e.getSystemPrompt(s);a.extraSystemMessageKwargs&&(v=[{type:"text",text:v,...a.extraSystemMessageKwargs}],p.default.debug("Using extra system message kwargs",a.extraSystemMessageKwargs));const S=u.StandardAgentStateManager.createWorkflow((async function(e){const t=e.messages;p.default.debug("Calling model with messages: %s",JSON.stringify(t));const r=await y.invoke(t);return p.default.debug("Received model response: %s",JSON.stringify(r)),{messages:[r]}}),l),b=this.checkpointerService.getCheckpointer(),R=S.compile({checkpointer:b});await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:"Human",content:n,createdAt:new Date,requestId:r});const _=new Date;await this.sessionService.addRequest({requestId:r,sessionId:t.sessionId,workspaceName:t.workspaceName,requestContent:n,startedAt:_});const k=t.config.recursionLimit||w.ConfigService.getNumericProperty(m.ConfigPropNames.AGENT_RECURSION_LIMIT)||50,C=a.extraHeaders?{configurable:{thread_id:t.sessionId},recursionLimit:k,headers:a.extraHeaders}:{configurable:{thread_id:t.sessionId},recursionLimit:k};p.default.debug("Call options: %s",JSON.stringify(C));const P=await b.get(C),O=new d.HumanMessage(n);let M={messages:[]};P?M.messages=[O]:a.extraSystemMessageKwargs?(p.default.debug("Using extra system message kwargs: %s",JSON.stringify(a.extraSystemMessageKwargs)),M.messages=[new d.SystemMessage({content:v,additional_kwargs:a.extraSystemMessageKwargs}),O]):M.messages=[new d.SystemMessage({content:v}),O],p.default.debug("Initial state",M);const I=await R.stream(M,C);let A=0,j=0,T=0,E=0,D=0,x="";try{for await(const e of I){p.default.debug("Output Event was: %s",JSON.stringify(e));const o=f.MessageUtils.processOutputEvent(e);p.default.debug("Processed message: %s",o);const s=o.usageMetadata,n=a.calculateCost(s?.inputTokens||0,s?.cacheWriteTokens||0,s?.cacheReadTokens||0,s?.outputTokens||0),i={itemId:this.generateItemId(),sessionId:t.sessionId,label:o.label,content:o.content,createdAt:new Date,inputTokens:o.usageMetadata?.inputTokens,cacheWriteTokens:s?.cacheWriteTokens,cacheReadTokens:s?.cacheReadTokens,outputTokens:s?.outputTokens,totalTokens:s?.totalTokens,cost:n,requestId:r},c=await this.sessionService.addItem(i);A+=s?.inputTokens||0,j+=s?.cacheWriteTokens||0,T+=s?.cacheReadTokens||0,E+=s?.outputTokens||0,D+=s?.inputTokens||0+s?.cacheReadTokens||0+s?.outputTokens||0,p.default.info("Running total - totalInputTokens: %s, totalCacheWriteTokens: %s, totalCacheReadTokens: %s, totalOutputTokens: %s, totalTokens: %s",A,j,T,E,D),x=o.content;const l=await this.sessionService.getSession(t.sessionId);if(l&&"aborted"===l.status){const e={label:"Error",content:"Session was aborted by the user."},r=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:e.label,content:e.content,createdAt:new Date});yield r;break}yield c}}catch(e){p.default.error("Error in Agent:",e);const r={label:"Error",content:`An error occurred: ${e.message}`},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:r.label,content:r.content,createdAt:new Date});yield o}finally{await this.sessionService.updateSessionStatus(t.sessionId,"inactive");const e=a.calculateCost(A,j,T,E),o=new Date,s=o.getTime()-_.getTime(),n=await this.sessionService.updateRequest(r,{responseContent:x,endedAt:o,tookMillis:s,inputTokens:A,cacheWriteTokens:j,cacheReadTokens:T,outputTokens:E,totalTokens:D,cost:e});await this.homeService.logRequest(n),p.default.info("Agent processing completed in %s seconds - Input tokens: %s, Cache Write tokens: %s, Cache Read tokens: %s, Output tokens: %s, Total tokens: %s, Total cost: £%s",s/1e3,A,j,T,E,D,e.toFixed(6))}}generateSessionId(){return(0,h.ulid)()}generateItemId(){return(0,h.ulid)()}};t.AgentCollaborator=S,t.AgentCollaborator=S=o([(0,n.Injectable)(),s("design:paramtypes",[y.WorkspaceService,i.SessionService,a.CheckpointerService,v.HomeService])],S)},9354:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseAgentModule=void 0;const s=r(3563),n=r(4838),i=r(5873),a=r(3880),c=r(9449),l=r(3177),u=r(4193);let d=class{};t.BaseAgentModule=d,t.BaseAgentModule=d=o([(0,s.Module)({imports:[i.WorkspaceModule,a.SessionModule,c.LangchainModule,l.MutationsModule,u.HomeModule],providers:[n.AgentCollaborator],exports:[n.AgentCollaborator]})],d)},9335:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseAgentService=void 0;const i=r(3563),a=r(4838),c=r(1412),l=r(6158),u=r(1162);let d=class{constructor(e,t){this.agentCollaborator=e,this.toolFactoryService=t}async getTools(e){return[]}async getSystemPrompt(e){throw new Error("Not implemented")}getName(){throw new Error("Not implemented")}getModelCategory(){return u.ModelCategory.CODING}async verifyRequest(e,t){}async*processRequestStream(e){if(!e.workspaceName)throw new Error("Workspace name is required in the agent request");yield*this.agentCollaborator.processRequestStream(this,e)}async processRequest(e){return this.agentCollaborator.processRequest(this,e)}async simpleRequest(e,t,r=null){const o=new c.AgentRequest(null,e,r,null,t);return(await this.processRequest(o)).responseContent}};t.BaseAgentService=d,t.BaseAgentService=d=o([(0,i.Injectable)(),n(0,(0,i.Inject)((0,i.forwardRef)((()=>a.AgentCollaborator)))),s("design:paramtypes",[a.AgentCollaborator,l.ToolFactoryService])],d)},3887:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.OpsAgentService=void 0;const i=r(3563),a=r(9896),c=r(6928),l=r(9335),u=r(6158),d=r(4838);let p=class extends l.BaseAgentService{constructor(e,t){super(e,t),this.agentCollaborator=e,this.toolFactoryService=t}getName(){return"ops-agent"}async getTools(e){return this.toolFactoryService.createTools(["read_file","update_file","delete_file","command_line","add_workspace","fetch_web_page","git_init"],e)}async getSystemPrompt(e){let t="";const r=c.join(e.workspace.repoBaseDir,"ops-hints.md");a.existsSync(r)&&(t=a.readFileSync(r,"utf-8"));const o=process.platform,s="win32"===o?"Windows":"darwin"===o?"macOS":"Linux";return`\n    \n    You are a helpful DevOps agent. Your task is to assist with various DevOps-related tasks and solve problems using the tools provided. \n    Always avoid doing anything destructive that cannot be undone. Do not kill processes unless specifically instructed to do so. \n    If multiple attempts to solve a problem fail, stop processing and report that the approach doesn't seem to be working.\n\n    Current working directory: ${e.workspace.repoBaseDir}\n    Current operating system: ${s}\n\n    Use the following tools to accomplish tasks:\n    1. Read File: Use this to read the contents of a file.\n    2. Update File: Use this to modify the contents of a file.\n    3. Delete File: Use this to remove a file (be cautious with this operation).\n    4. Command Line: Use this to execute shell commands. You can pass in a subdirectory to run the command in that subdirectory.\n    5. Add Workspace: Use this if asked to add a new workspace - you need to pass the base directory of target project NOT this workspace's root directory.\n    6. Git Init: Use this to initialize a new Git repository in the current workspace.\n    7. Fetch Web Page: Use this to fetch the HTML content of a web page. Only use when explicitly requested by the user to fetch a specific URL.\n\n    Additional hints for this workspace:\n    ${t}\n\n    IMPORTANT: It is okay to look in files under the repo and even create directories and add new files under the workspace root directory. \n    IMPORTANT: You should never recurse up out of the current working directory (repo root) and should never read or alter any files outside the workspace folder unless specifically instructed to do so.\n    IMPORTANT: Remember to always use the tools provided to solve problems according to the user's request. If you're unsure about a task or if it seems risky, ask for clarification before proceeding.\n    IMPORTANT: When adding things to git, always use 'git add -A' rather than adding individual files.\n    IMPORTANT: Only use the Fetch Web Page tool when explicitly requested by the user to fetch a specific URL.`}};t.OpsAgentService=p,t.OpsAgentService=p=o([(0,i.Injectable)(),n(0,(0,i.Inject)((0,i.forwardRef)((()=>d.AgentCollaborator)))),s("design:paramtypes",[d.AgentCollaborator,u.ToolFactoryService])],p)},5017:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SEAgentService=void 0;const i=r(3563),a=r(6158),c=r(9055),l=r(4838),u=r(9335);let d=class extends u.BaseAgentService{constructor(e,t){super(e,t),this.agentCollaborator=e,this.toolFactoryService=t}getName(){return"se-agent"}async getTools(e){return this.toolFactoryService.createTools(["read_file","update_file","delete_file","command_line","fetch_web_page","read_dependency_source_tree","read_dependency_source_file","git_commit"],e)}async getSystemPrompt(e){let t=`As an AI assistant, you are tasked with analysing the software system and answering questions about it and/or making improvements to it.\n  Follow these guidelines:\n  1. Review the file structure tree below and use the read_file tool to answer questions about the system and suggest improvements where appropriate. Provide a concise summary of your findings.\n  2. When making changes to the system:\n     a. First, fetch all the files you think you might need using the read_file tool. For gradle/maven projects you can also use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for dependencies and inspect them to learn how to interact with them.\n     b. Make a clear plan with multiple steps.\n     c. Iterate through the plan, one step at a time.\n     d. Think step-by-step and explain the needed changes in a few short sentences.\n     e. Each change MUST be done by invoking the update_file tool to replace a part of the file with a new bit.\n  3. Use the read_file tool to retrieve the contents of specific files when needed rather than guessing at what they contain.\n     When making edits to previously referenced files, always keep the name/path the same.\n  4. When choosing a file path for generated artifacts, consider the structure and choose a logical location.\n  5. When a specific file name is mentioned, look for it in the structure below and use the read_file tool to get the content of that file.\n  6. Consider the following when suggesting improvements:\n     a. Code organization and structure\n     b. Adherence to best practices and design patterns\n     c. Performance optimizations\n     d. Security considerations\n     e. Scalability and maintainability\n     f. Documentation and comments\n  7. Provide clear explanations for your suggestions and recommendations.\n  8. If you need to create new files or modify existing ones, clearly indicate the file path and content.\n  9. When generating new code or modifying existing code, always look at similar or nearby files in the source tree for guidance on:\n     a. Code style and formatting\n     b. Logging practices\n     c. Error handling\n     d. Import statements and module organization\n     e. Commenting style and docstring format\n     f. Naming conventions for variables, functions, and classes\n     g. Tools, libraries, and frameworks being used\n     h. Your ending summary should be a concise summary of a) which files were updated and b) what changes were made to them.\n  10. To find similar files:\n      a. Examine the file structure provided below.\n      b. Identify files in the same directory or nearby directories with similar purposes or file extensions.\n      c. Use the read_file tool to retrieve the contents of these similar files for reference.\n  11. Ensure that new code generation and modifications align with the existing codebase's style and best practices.\n  12. Do not make assumptions about tools, libraries, or frameworks being used:\n      a. Always fetch and examine similar existing files before creating new ones.\n      b. When adding a new entity or data class, fetch an existing one first and use the same tooling and styles.\n      c. For data migrations, look at an existing migration file to understand the tooling and practices used in the repository.\n      d. Consistently use the same tools and approaches found in the existing codebase.\n  13. When making changes to the system use the update_file tool as follows:\n      a. Always provide the path to the file you want to change (or create) as the first argument.\n      b. The second argument is the SEARCH block - the bit of the existing code you want to replace. For new files this should be an empty string.\n      c. The third argument is the REPLACE block - the bit of the new code you want to replace it with. DO NOT FORGET TO INCLUDE THIS!!\n      d. Always try to minimise the size of the SEARCH block so you are only updating the specific parts of the file that need updating.\n      e. If you need to make edits to multiple parts of a single file, make a plan and do so in a series of update_file calls.\n      f. If you get an error back from the tool saying the search block was not found then you can try again with a larger search block or the entire contents of the file as the search block.\n  14. To delete a file, use the delete_file tool:\n      a. Provide the relative path of the file to delete as the argument.\n      b. Always confirm the file deletion with the user before proceeding.\n  15. When refactoring or renaming files:\n      a. Use the update_file tool to create the new file with the desired content.\n      b. Use the delete_file tool to remove the old file.\n      c. Update any references to the old file in other parts of the codebase using the update_file tool.\n  16. ${e.workspace.isGitRepo?"After making changes to the system, always commit the changes to git using the git_commit tool:\n      a. Use the git_commit tool with a brief, descriptive commit message of the changes you've made.\n      b. The git_commit tool will automatically stage and commit all changes, so you don't need to worry about git add commands.\n  17. If the user asks you to undo or /undo or undo the last changes, inform them that you cannot directly undo git commits, but they can use git reset --hard HEAD~1 in their local environment if needed.":"This workspace is not a git repository. You cannot commit changes or use git commands. Instead, focus on analyzing the code and suggesting improvements without version control operations."}\n  18. You can use the command_line tool to execute commands in the workspace directory${e.workspace.isGitRepo?", but not for git operations":""}. This includes system commands, package managers, build tools, etc. But remember the following:\n      a. Do not traverse up above the workspace directory though and only do things that are safe and can definitely be undone.\n      b. Only use package manager/build commands if you are sure of the correct one. Look in the readme or the build files to find out for sure and if not sure then do not use them. Just say what you might do to complete the task.\n  19. You can use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for dependencies and inspect them to learn how to interact with them. Look in the build file (e.g. pom.xml or build.gradle) or package metadata (e.g. package.json) and then use that to build the correct scheme and locator.\n  20. Always use the git_commit tool for git operations instead of the command_line tool. The git_commit tool is specifically designed for safe and efficient git operations in this environment.\n      `;return e.workspace.buildOrTestCommand&&(t+=`\n  21. After making changes to the system, but before committing them to git, consider the following:\n      a. If you have updated any code files (not just scripts, documentation, or other non-code files), you should run the following command to test if the changes haven't broken anything:\n         Use the command_line tool to execute this command: ${e.workspace.buildOrTestCommand}\n      b. If you run the test and any errors occur, try to fix them if it seems feasible.\n      c. If the errors cannot be fixed easily, stop processing and report the error to the user without committing the changes to git.\n      d. If you don't run the test or if the build or test is successful, proceed with committing the changes to git.\n      e. Remember, you only need to run this test command if you've made changes to actual code files, not for changes to scripts, documentation, or other non-code files.`),t+=`\n  \n  Here is the file tree of the system:\n  ${e.repositoryTree()}\n  \n  ${e.repositoryHints()?`Additional hints:\n${e.repositoryHints()}`:""}\n  \n  ${e.workspace.buildOrTestCommand?`Build or Test Command: ${e.workspace.buildOrTestCommand}`:""}\n  \n  IMPORTANT: Keep your final summary concise and to the point. If you have made changes to multiple files, only list the files that have been changed and a short description of the changes for each file.\n  IMPORTANT: When using the update_file tool you MUST provide all 3 arguments: filePath, search & REPLACE. DO NOT FORGET TO INCLUDE THE REPLACE BLOCK!!\n  IMPORTANT: ALWAYS GO LOOKING IN THE CODEBASE AND FETCH ANY FILES YOU THINK YOU NEED TO LEARN FROM BEFORE MAKING CHANGES. DO NOT MAKE ASSUMPTIONS ABOUT WHAT IS IN A FILE - JUST FETCH IT!\n  IMPARTANT: You must NEVER try to stop processes or kill running processes. You must only use the command_line tool to execute commands.\n  IMPORTANT: Always use the update_file tool to make changes to the codebase. Never use the command_line tool to make changes to update source code.\n  IMPORTANT: If asked by the user, you can use the fetch_web_page tool to read the content of a web page. Only use this tool when explicitly requested by the user to fetch a specific URL.\n  \n  ${e.workspace.buildOrTestCommand?`\n    IMPORTANT: Run: ${e.workspace.buildOrTestCommand} to build and test the project after making changes to the code.\n    IMPORTANT: If you get an error then fix it and run the test again until you get it right.\n    IMPORTANT: If the build error relates to a maven/gradle dependency then you should use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for the dependency and inspect it to see if you can fix the problem.\n    `:""}\n  IMPORTANT: IF YOU MADE CODE CHANGES THEN YOU MUST REMEMBER TO COMMIT YOUR CHANGES TO GIT! DO NOT FORGET THIS!\n  `,c.default.debug(`SE Agent system prompt for workspace '${e.workspace.name}' (length: ${t.length} chars): ${t}`),t}};t.SEAgentService=d,t.SEAgentService=d=o([(0,i.Injectable)(),n(0,(0,i.Inject)((0,i.forwardRef)((()=>l.AgentCollaborator)))),s("design:paramtypes",[l.AgentCollaborator,a.ToolFactoryService])],d)},715:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AppModule=void 0;const n=r(3563),i=r(2810),a=r(6928),c=r(6808),l=r(5873),u=r(3880),d=r(2177),p=r(9449),f=r(3177),h=r(3049),g=r(376),y=r(7967),m=r(1901),w=r(361),v=r(8221),S=r(7852),b=r(9161),R=r(4193),_=r(350),k=r(2776),C=r(9055);let P=class{constructor(e){this.appDataSource=e}async onModuleDestroy(){C.default.info("AppModule onModuleDestroy called.."),await this.appDataSource.close()}};t.AppModule=P,t.AppModule=P=o([(0,n.Module)({imports:[i.ServeStaticModule.forRoot({rootPath:(0,a.join)(__dirname,"..","..","vitify-webui","dist"),exclude:["/api*"]}),g.DataSourceModule,c.HelloWorldModule,l.WorkspaceModule,u.SessionModule,d.AgentsModule,p.LangchainModule,f.MutationsModule,h.AudioTranscriptionModule,y.ConfigModule,m.GitModule,w.ToolsModule,v.ReportingModule,S.SourceArtefactModule,b.ChatCompletionModule,R.HomeModule,_.PluginModule],providers:[{provide:k.AppDataSource,useFactory:k.getAppDataSource}]}),s("design:paramtypes",[k.AppDataSource])],P)},2776:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAppDataSource=t.AppDataSource=void 0;const o=r(9055),s=r(1832),n=r(9187),i=r(8627);class a{constructor(e){this.dbChoice=e}async initKnexOnly(){const e=this.dbChoice?(0,n.default)(this.dbChoice):(0,n.getDefaultKnexConfig)();this.knex=(0,s.default)(e),await this.verifyDbConnection(this.knex)}async verifyDbConnection(e){try{o.default.info("Verifying database connection..."),await e.raw("SELECT 1"),o.default.info("Database connection successful")}catch(e){throw o.default.error("Database connection failed",e),e}}async initialize(){await this.initKnexOnly(),this.migrationManager=new i.KnexMigrationManager(this.knex),await this.runMigrations()}async runMigrations(){try{const e=await this.migrationManager.runMigrations();o.default.info(`Ran ${e.length} migrations`)}catch(e){throw o.default.error("Error running database migrations",e),e}}async close(){o.default.info("Closing data source..."),this.knex&&await this.knex.destroy(),o.default.info("Data source closed")}buildPaginationQuery(e,t){const r=(t.page-1)*t.limit;return`${e} LIMIT ${t.limit} OFFSET ${r}`}buildSortQuery(e,t){return`${e} ORDER BY ${t.field} ${t.order}`}}t.AppDataSource=a;let c=null;t.getAppDataSource=async()=>(null===c?(o.default.info("Creating new AppDataSource instance..."),c=new a,await c.initialize()):o.default.info("Returning existing AppDataSource instance..."),c)},376:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DataSourceModule=void 0;const s=r(3563),n=r(2776);let i=class{};t.DataSourceModule=i,t.DataSourceModule=i=o([(0,s.Module)({providers:[{provide:n.AppDataSource,useFactory:n.getAppDataSource},{provide:"KNEX",useFactory:e=>e.knex,inject:[n.AppDataSource]}],exports:[n.AppDataSource,"KNEX"]})],i)},9187:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultKnexConfig=function(){p||(p=d());return p};const o=r(9896),s=r(6928),n=r(857),i=r(9055),a=s.join(n.homedir(),".hldk","db","hldk.sqlite");function c(){let e=__dirname,t=s.join(e,"migrations");for(i.default.info(`Looking for migrations in: ${t} - will recurse up looking for migrations`);!l(t);)e=s.dirname(e),t=s.join(e,"migrations");if(u(t)||(t=s.join(process.cwd(),"migrations")),u(t)||(t=s.join(process.cwd(),"server","migrations")),!u(t))throw new Error("No migrations directory found in any of the usual locations");return t}function l(e){return o.existsSync(e)&&u(e)}function u(e){return o.readdirSync(e).some((e=>e.endsWith(".js")))}function d(e){let t;void 0===e&&(e=process.env.DB_CHOICE||"local"),i.default.info(`Using database configuration: ${e}`);try{t=function(e=process.env.DB_CHOICE||"local"){let t,r=process.env.DB_CONFIG_PATH||"db-config.json";try{t=o.readFileSync(r,"utf8")}catch(e){r=s.join(process.cwd(),"config","db-config.json");try{t=o.readFileSync(r,"utf8")}catch(e){throw new Error("Unable to find db-config.json")}}i.default.info(`Using db config at: ${r}`);const a=JSON.parse(t);if(!a[e])throw i.default.error(`Invalid DB_CHOICE: ${e} - not found in db-config.json - ${JSON.stringify(a)}`),new Error(`Invalid DB_CHOICE: ${e} - not found in db-config.json`);const c=a[e],l=c.connection;if("object"==typeof l&&"filename"in l&&(l.filename=l.filename.replace("~",n.homedir()),!o.existsSync(l.filename))){const e=s.dirname(r),t=s.resolve(e,l.filename);if(i.default.info(`Resolved filename: ${t} from config file directory: ${e} using relative path: ${l.filename}`),!o.existsSync(t))throw i.default.error(`File does not exist: ${t}`),new Error(`File does not exist: ${t}`);l.filename=t}const d=c.migrations;if(d&&"string"==typeof d.directory){const e=s.resolve(s.dirname(r),d.directory);u(e)&&(c.migrations.directory=e)}return c.useNullAsDefault=!0,c}(e)}catch(r){if("local"!==e)throw i.default.error("error",r),i.default.error(`Invalid DB_CHOICE: ${e} - no db-config.json found`),new Error(`Invalid DB_CHOICE: ${e} - no db-config.json found`);i.default.info("Did not find db-config.json, using default SQLite configuration"),t={client:"sqlite3",connection:{filename:a},useNullAsDefault:!0}}if(i.default.info(`Using db config (after making paths absolute): ${JSON.stringify(t)}`),t.migrations||(i.default.warn("No migrations directory found in db-config.json, using default"),t.migrations={directory:c()}),t.migrations.extension="js",t.connection&&"object"==typeof t.connection&&"filename"in t.connection){const e=t.connection.filename,r=s.dirname(e);o.existsSync(r)||(i.default.info(`Creating Database directory: ${r}`),o.mkdirSync(r,{recursive:!0}))}return i.default.info(`Using knex config: ${JSON.stringify(t)}`),t}var p=void 0;t.default=d},8627:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KnexMigrationManager=void 0;const o=r(9055);t.KnexMigrationManager=class{constructor(e){this.knexInstance=e}async runMigrations(){try{const e=await this.knexInstance.migrate.latest();return o.default.info(`Ran ${e[1].length} migrations`),e[1]}catch(e){throw o.default.error("Failed to run Knex migrations",e),e}}async getMigrationStatus(){try{const e=await this.knexInstance.migrate.list();return{completed:e[0],newMigrations:e[1]}}catch(e){throw o.default.error("Failed to get Knex migration status",e),e}}}},1544:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatModelManager=void 0;const o=r(4264),s=r(1986),n=r(4659),i=r(8312),a=r(2088),c=r(2003),l=r(9055),u=r(1162),d=r(2368);class p{constructor(){this.providers=[new s.AnthropicProvider,new o.OpenAIProvider,new n.GroqProvider,new i.OllamaProvider]}static getInstance(){return p.instance||(p.instance=new p),p.instance}static async getModel(e,t=u.ModelCategory.CODING){return p.getInstance().getModel(e,t)}async getModel(e,t=u.ModelCategory.CODING){let r=e?.model;r||(r=d.ConfigService.getInstance().getProperty(`DEFAULT_${t}_MODEL`));const o=await this.getProvider(r),s=await o.getModelDescriptor(r),n=o.getBaseChatModel(r,e||new c.AgentConfig),i=o.getExtraHeaders(r,e),l=o.getExtraSystemMessageKwargs(r,e);return new a.ChatModel(s,n,i,l)}async getValidModelDescriptors(){return(await Promise.all(this.providers.filter((e=>e.isValid())).map((e=>e.getModelDescriptors())))).flat()}async getValidModelNames(){return(await this.getValidModelDescriptors()).map((e=>e.name))}async getValidModelFullNames(){return(await this.getValidModelDescriptors()).map((e=>e.getFullName()))}async getProvider(e){if(e){const[t]=e.split("/"),r=this.providers.find((e=>e.getName()===t&&e.isValid()));if(r)return r;l.default.warn(`Provider not found or not valid for model ${e}. Searching for first valid provider.`)}const t=this.providers.find((e=>e.isValid()));if(t)return t;throw new Error("No valid provider found. Please check your API keys.")}}t.ChatModelManager=p},1e3:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointerService=void 0;const n=r(3563),i=r(9314);let a=class{constructor(){this.checkpointer=new i.MemorySaver}getCheckpointer(){return this.checkpointer}};t.CheckpointerService=a,t.CheckpointerService=a=o([(0,n.Injectable)(),s("design:paramtypes",[])],a)},9449:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.LangchainModule=void 0;const s=r(3563),n=r(1e3);let i=class{};t.LangchainModule=i,t.LangchainModule=i=o([(0,s.Module)({providers:[n.CheckpointerService],exports:[n.CheckpointerService]})],i)},6254:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageUtils=void 0;const o=r(1486),s=r(9055);class n{static processOutputEvent(e){let t,r=e.messages,i="AI",a="No content found";if(!r&&e.agent&&e.agent.messages?r=e.agent.messages:!r&&e.tools&&e.tools.messages&&(r=e.tools.messages,i="Tool"),r&&r.length>0){const c=r[r.length-1];if(c instanceof o.ToolMessage||"tool"===c.type){return{label:"Tool",content:`Calling ${c.name||"Unknown Tool"}\nOutput was:\n${n.processContent(c.content)}`}}if(c instanceof o.AIMessage)return a=n.processContent(c.content),t=this.extractUsageMetadata(c),a.trim().length<1?(s.default.warn("AI message has empty content %s",{lastMessage:JSON.stringify(c)}),{label:"AI",content:JSON.stringify(c),usageMetadata:t}):{label:"AI",content:a,usageMetadata:t};if(c instanceof o.HumanMessage)return a=n.processContent(c.content),{label:"Human",content:a};if(c instanceof o.BaseMessage)return a=n.processContent(c.content),{label:i,content:a};s.default.warn("Processing unknown output using strings",{output:JSON.stringify(e)});const l=JSON.stringify(c),u=JSON.parse(l);if("kwargs"in u&&u.kwargs&&u.kwargs.content)return a=u.kwargs.content,t=this.extractUsageMetadata(u),{label:i,content:a,usageMetadata:t}}return s.default.warn("Processing unknown output: %s",{output:JSON.stringify(e)}),{label:"Unknown",content:JSON.stringify(e)}}static processContent(e){return Array.isArray(e)?e.filter((e=>"text"===e.type)).map((e=>e.text)).join("\n"):String(e)}static extractUsageMetadata(e){var t=e.response_metadata?.usage||e.usage_metadata;if(t){const e={inputTokens:t.input_tokens,cacheWriteTokens:t.cache_creation_input_tokens||0,cacheReadTokens:t.cache_read_input_tokens||0,outputTokens:t.output_tokens,totalTokens:t.total_tokens};return s.default.info("extractUsageMetadata - usageMetadata: %s",{usageMetadata:JSON.stringify(e)}),e}}}t.MessageUtils=n},1986:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnthropicProvider=void 0;const o=r(646),s=r(8483),n=r(8959),i=r(2368);class a extends s.BaseProvider{getName(){return"anthropic"}getBaseChatModel(e,t){return new o.ChatAnthropic({modelName:this.shortModelName(e),temperature:t.temperature,anthropicApiKey:i.ConfigService.getInstance().getProperty("ANTHROPIC_API_KEY"),maxTokens:8192,clientOptions:{defaultHeaders:{"anthropic-beta":"prompt-caching-2024-07-31"}}})}async getModelDescriptors(){return[new n.ModelDescriptor("anthropic","claude-3-5-sonnet-20240620",225e-8,28125e-10,225e-9,1125e-8),new n.ModelDescriptor("anthropic","claude-3-opus-20240229",1125e-8,140625e-10,1125e-9,5625e-8),new n.ModelDescriptor("anthropic","claude-3-haiku-20240307",1.875e-7,225e-9,2.25e-8,9.375e-7)]}isValid(){return!!i.ConfigService.getInstance().getProperty("ANTHROPIC_API_KEY")}getExtraHeaders(e,t){return this.isPromptCachingEnabled(t)?{"anthropic-beta":"prompt-caching-2024-07-31"}:null}getExtraSystemMessageKwargs(e,t){return this.isPromptCachingEnabled(t)?{cache_control:{type:"ephemeral"}}:null}}t.AnthropicProvider=a},8483:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseProvider=void 0;const o=r(9055);t.BaseProvider=class{async getModelDescriptor(e){const t=await this.getModelDescriptors();if(!e)return t[0];const[r,o]=e.split("/"),s=o||e,n=t.find((e=>e.name===s));if(!n)throw new Error(`Model ${s} not found for provider ${this.getName()}`);return n}shortModelName(e){const[t,r]=e.split("/");return r||e}getExtraHeaders(e,t){return null}getExtraSystemMessageKwargs(e,t){return null}isPromptCachingEnabled(e){const t=!0===e?.cachePrompt;return o.default.info("isPromptCachingEnabled - cachePrompt: %s, result: %s",e?.cachePrompt,t),t}}},2088:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatModel=void 0;t.ChatModel=class{constructor(e,t,r=null,o=null){this.modelDescriptor=e,this.baseChatModel=t,this.extraHeaders=r,this.extraSystemMessageKwargs=o}calculateCost(e,t,r,o){const s=this.modelDescriptor;return e*s.costPerInputToken+t*s.costPerCacheWriteToken+r*s.costPerCacheReadToken+o*s.costPerOutputToken}}},4659:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GroqProvider=void 0;const o=r(1463),s=r(8483),n=r(8959),i=r(2368),a=r(8938);class c extends s.BaseProvider{getName(){return"groq"}getBaseChatModel(e,t){return new o.ChatGroq({modelName:this.shortModelName(e),temperature:t.temperature,apiKey:i.ConfigService.getInstance().getProperty("GROQ_API_KEY")})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>new n.ModelDescriptor("groq",e,0,0,0,0)))}isValid(){return!!i.ConfigService.getInstance().getProperty("GROQ_API_KEY")}async fetchModels(){const e=i.ConfigService.getInstance().getProperty("GROQ_API_KEY");if(!e)return console.log("Groq API key not found"),[];try{const t=await a.default.get("https://api.groq.com/openai/v1/models",{headers:{Authorization:`Bearer ${e}`}});if(200===t.status){return(t.data.data||[]).map((e=>e.id))}return console.log(`Failed to fetch Groq models. Status code: ${t.status}`),[]}catch(e){return console.error(`Error fetching Groq models: ${e}`),[]}}}t.GroqProvider=c},1162:(e,t)=>{"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.ModelCategory=void 0,function(e){e.CODING="CODING",e.REASONING="REASONING",e.SUMMARISATION="SUMMARISATION"}(r||(t.ModelCategory=r={}))},8959:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDescriptor=void 0;t.ModelDescriptor=class{constructor(e,t,r,o,s,n){this.provider=e,this.name=t,this.costPerInputToken=r,this.costPerCacheWriteToken=o,this.costPerCacheReadToken=s,this.costPerOutputToken=n}getFullName(){return`${this.provider}/${this.name}`}}},8312:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OllamaProvider=void 0;const o=r(3548),s=r(8483),n=r(8959),i=r(2368);class a extends s.BaseProvider{getName(){return"ollama"}getBaseChatModel(e,t){return new o.ChatOllama({baseUrl:this.getBaseUrl(),model:this.shortModelName(e),temperature:t.temperature})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>new n.ModelDescriptor("ollama",e,0,0,0,0)))}isValid(){return!!this.getBaseUrl()}getBaseUrl(){return i.ConfigService.getInstance().getProperty("OLLAMA_BASE_URL")||"http://localhost:11434"}async fetchModels(){const e=this.getBaseUrl();try{const t=await fetch(`${e}/api/tags`);if(t.ok){const e=await t.json();return(e.models||[]).map((e=>e.name))}return console.log(`Failed to fetch Ollama models. Status code: ${t.status}`),[]}catch(e){return console.error(`Error fetching Ollama models: ${e}`),[]}}}t.OllamaProvider=a},4264:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenAIProvider=void 0;const o=r(6228),s=r(8483),n=r(8959),i=r(2368);class a extends s.BaseProvider{getName(){return"openai"}getBaseChatModel(e,t){return new o.ChatOpenAI({modelName:this.shortModelName(e),temperature:t.temperature,openAIApiKey:i.ConfigService.getInstance().getProperty("OPENAI_API_KEY")})}async getModelDescriptors(){return[new n.ModelDescriptor("openai","gpt-4o",3e-5,0,0,6e-5)]}isValid(){return!!i.ConfigService.getInstance().getProperty("OPENAI_API_KEY")}}t.OpenAIProvider=a},885:function(e,t,r){"use strict";var o,s=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionController=void 0;const a=r(3563),c=r(9556),l=r(4562),u=r(8461);let d=class{constructor(e){this.audioTranscriptionService=e}async transcribeAudio(e){try{return{transcription:await this.audioTranscriptionService.transcribe(e.buffer.toString("base64"))}}catch(e){throw console.error("Transcription error:",e),new Error("An error occurred during transcription")}}};t.AudioTranscriptionController=d,s([(0,a.Post)(),(0,a.UseInterceptors)((0,c.FileInterceptor)("audio")),i(0,(0,a.UploadedFile)()),n("design:type",Function),n("design:paramtypes",["function"==typeof(o=void 0!==u.Multer&&u.Multer.File)?o:Object]),n("design:returntype",Promise)],d.prototype,"transcribeAudio",null),t.AudioTranscriptionController=d=s([(0,a.Controller)("audio-transcription"),n("design:paramtypes",[l.AudioTranscriptionService])],d)},3049:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionModule=void 0;const s=r(3563),n=r(885),i=r(4562);let a=class{};t.AudioTranscriptionModule=a,t.AudioTranscriptionModule=a=o([(0,s.Module)({controllers:[n.AudioTranscriptionController],providers:[i.AudioTranscriptionService,n.AudioTranscriptionController]})],a)},4562:function(e,t,r){"use strict";var o,s=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionService=void 0;const n=r(3563),i=r(5317),a=r(9896),c=r(857),l=r(6928);let u=o=class{constructor(){this.logger=new n.Logger(o.name)}async transcribe(e){this.logger.debug("Starting audio transcription");const t=Buffer.from(e,"base64"),r=l.join(c.tmpdir(),`audio-${Date.now()}.wav`);await a.promises.writeFile(r,t),this.logger.debug(`Temporary file created: ${r}`);try{const e=await this.runFasterWhisperCLI(r);return this.logger.debug("Transcription completed successfully"),e}finally{await a.promises.unlink(r),this.logger.debug(`Temporary file deleted: ${r}`)}}runFasterWhisperCLI(e){return new Promise(((t,r)=>{const o=l.join(c.tmpdir(),`audio-${Date.now()}.srt`);this.logger.debug(`Running Faster Whisper CLI on file: ${e}`);const s=process.env.TRANSCRIPTION_LANGUAGE||"en",n=process.env.TRANSCRIPTION_COMPUTE_TYPE||"float32",u=[e,"-o",o,"--task","transcribe","--without_timestamps","True","--language",s,"--compute_type",n],d=`faster-whisper ${u.join(" ")}`;this.logger.log(`Executing command: ${d}`);const p=(0,i.spawn)("faster-whisper",u);p.stdout.on("data",(e=>{this.logger.debug(`Faster Whisper stdout: ${e}`)})),p.stderr.on("data",(e=>{this.logger.warn(`Faster Whisper stderr: ${e}`)})),p.on("error",(e=>{this.logger.error(`Error in Faster Whisper process: ${e}`),r(new Error("Error in Faster Whisper process - make sure you have run the ./scripts/install-faster-whisper.sh script"))})),p.on("close",(async e=>{if(0===e)try{const e=await a.promises.readFile(o,"utf-8");this.logger.debug(`SRT content: ${e}`);const r=this.parseSrtContent(e);this.logger.debug("Faster Whisper process completed successfully"),t(r)}catch(e){this.logger.error(`Error reading SRT file: ${e}`),r(new Error(`Error reading SRT file: ${e.message}`))}finally{await a.promises.unlink(o),this.logger.debug(`Temporary SRT file deleted: ${o}`)}else this.logger.error(`Faster Whisper process exited with code ${e}`),r(new Error(`Faster Whisper process exited with code ${e}`))}))}))}parseSrtContent(e){const t=e.split("\n");let r="";for(let e=0;e<t.length;e++)/^\d+$/.test(t[e])||/.*-->.*$/.test(t[e])||(r+=t[e].trim()+" ");return r.trim()}};t.AudioTranscriptionService=u,t.AudioTranscriptionService=u=o=s([(0,n.Injectable)()],u)},9161:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ChatCompletionModule=void 0;const s=r(3563),n=r(3239);let i=class{};t.ChatCompletionModule=i,t.ChatCompletionModule=i=o([(0,s.Module)({providers:[n.SummaryCompletion],exports:[n.SummaryCompletion]})],i)},3239:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryCompletion=void 0;const n=r(3563),i=r(1162),a=r(1544),c=r(1486),l=r(724),u=r(9055);let d=class{constructor(){this.systemPrompt="\n    You are a helpful assistant that summarises text. Your job is present the minumum useful information in the shortest way possible.\n    Summarise the following text pulling out just the interesting things. For example:\n    \n    a) If it looks like test output:\n       - If all tests passed, just say that and mention how many tests passed if possible.\n       - If there were some failures, include each of them with the first part of the stack trace if possible.\n    \n    b) If it's something else, then just pull out the most important information.\n    \n    Always keep your summary concise and focused on the most important information.",this.chatModelManager=a.ChatModelManager.getInstance()}async getSummary(e){const t=await this.chatModelManager.getModel(null,i.ModelCategory.SUMMARISATION),r=[new c.SystemMessage(this.systemPrompt),new c.HumanMessage(e)],o=new l.StringOutputParser,s=Date.now(),n=await t.baseChatModel.invoke(r),a=await o.invoke(n),d=Date.now()-s;return u.default.info("Summary produced by %s in %sms: %s",t.modelDescriptor.getFullName(),d,a),a}};t.SummaryCompletion=d,t.SummaryCompletion=d=o([(0,n.Injectable)(),s("design:paramtypes",[])],d)},6910:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigPropNames=void 0;class r{}t.ConfigPropNames=r,r.HLDK_API_KEY="HLDK_API_KEY",r.DEFAULT_CODING_MODEL="DEFAULT_CODING_MODEL",r.DEFAULT_REASONING_MODEL="DEFAULT_REASONING_MODEL",r.DEFAULT_SUMMARISATION_MODEL="DEFAULT_SUMMARISATION_MODEL",r.AGENT_RECURSION_LIMIT="AGENT_RECURSION_LIMIT",r.OLLAMA_BASE_URL="OLLAMA_BASE_URL",r.VALUE_PER_LINE="VALUE_PER_LINE",r.ANTHROPIC_API_KEY="ANTHROPIC_API_KEY",r.OPENAI_API_KEY="OPENAI_API_KEY",r.GROQ_API_KEY="GROQ_API_KEY"},5015:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigController=void 0;const i=r(3563),a=r(2368);let c=class{constructor(e){this.configService=e}getConfig(){return this.configService.getConfig()}async getAllProperties(){return this.configService.getAllProperties()}async getProperty(e){return this.configService.getProperty(e)}async setProperty(e,t){return await this.configService.setProperty(e,t),{message:"Property set successfully"}}async unsetProperty(e){return await this.configService.unsetProperty(e),{message:"Property unset successfully"}}async updateMultipleProperties(e){for(const[t,r]of Object.entries(e))await this.configService.setProperty(t,r);return{message:"Properties updated successfully"}}};t.ConfigController=c,o([(0,i.Get)(),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",void 0)],c.prototype,"getConfig",null),o([(0,i.Get)("properties"),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",Promise)],c.prototype,"getAllProperties",null),o([(0,i.Get)("property/:name"),n(0,(0,i.Param)("name")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],c.prototype,"getProperty",null),o([(0,i.Put)("property/:name"),n(0,(0,i.Param)("name")),n(1,(0,i.Body)("value")),s("design:type",Function),s("design:paramtypes",[String,String]),s("design:returntype",Promise)],c.prototype,"setProperty",null),o([(0,i.Delete)("property/:name"),n(0,(0,i.Param)("name")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],c.prototype,"unsetProperty",null),o([(0,i.Post)("properties"),n(0,(0,i.Body)()),s("design:type",Function),s("design:paramtypes",[Object]),s("design:returntype",Promise)],c.prototype,"updateMultipleProperties",null),t.ConfigController=c=o([(0,i.Controller)("config"),s("design:paramtypes",[a.ConfigService])],c)},3713:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigDescriptors=t.ConfigSection=t.ConfigPropertyDescriptor=void 0;const o=r(6910),s=r(1544);class n{constructor(e,t,r,o,s,n,i){this.label=e,this.name=t,this.type=r,this.description=o,this.sensitive=s,this.defaultValue=n,this.possibleValues=i}}t.ConfigPropertyDescriptor=n;class i{constructor(e,t){this.title=e,this.properties=t}}t.ConfigSection=i;class a{constructor(e){this.sections=e}static getDefaultDescriptors(){const e=async()=>s.ChatModelManager.getInstance().getValidModelFullNames();return new a([new i("API Keys",[new n("HLDK API Key",o.ConfigPropNames.HLDK_API_KEY,"string","HLDK API Key",!0),new n("Anthropic API Key",o.ConfigPropNames.ANTHROPIC_API_KEY,"string","Anthropic API Key",!0),new n("OpenAI API Key",o.ConfigPropNames.OPENAI_API_KEY,"string","OpenAI API Key",!0),new n("Groq API Key",o.ConfigPropNames.GROQ_API_KEY,"string","Groq API Key",!0)]),new i("Models",[new n("Coding Model",o.ConfigPropNames.DEFAULT_CODING_MODEL,"enum","Coding Model",!1,"anthropic/claude-3-5-sonnet-20240620",e),new n("Reasoning Model",o.ConfigPropNames.DEFAULT_REASONING_MODEL,"enum","Reasoning Model",!1,"anthropic/claude-3-5-sonnet-20240620",e),new n("Summarisation Model",o.ConfigPropNames.DEFAULT_SUMMARISATION_MODEL,"enum","Summarisation Model",!1,"anthropic/claude-3-haiku-20240307",e)]),new i("Ollama",[new n("Ollama Base URL",o.ConfigPropNames.OLLAMA_BASE_URL,"string","Ollama Base URL",!1,"http://localhost:11434")]),new i("Misc",[new n("Agent Recursion Limit",o.ConfigPropNames.AGENT_RECURSION_LIMIT,"number","How many times an agent can call itself recursively before halting",!1,50),new n("Dashboard £ per LOC",o.ConfigPropNames.VALUE_PER_LINE,"number","Approximate value created per line of code generated in £",!1,2.4)])])}}t.ConfigDescriptors=a},1080:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigProperty=void 0;t.ConfigProperty=class{constructor(e,t){this.name=e,this.value=t}}},7967:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigModule=void 0;const s=r(3563),n=r(5015),i=r(2368),a=r(5699),c=r(3713),l=r(376);let u=class{};t.ConfigModule=u,t.ConfigModule=u=o([(0,s.Module)({imports:[l.DataSourceModule],controllers:[n.ConfigController],providers:[i.ConfigService,a.ConfigPropertyRepository,c.ConfigPropertyDescriptor,c.ConfigSection,c.ConfigDescriptors],exports:[i.ConfigService,a.ConfigPropertyRepository,c.ConfigPropertyDescriptor,c.ConfigSection,c.ConfigDescriptors]})],u)},5699:function(e,t,r){"use strict";var o,s=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigPropertyRepository=void 0;const a=r(3563),c=(r(1832),r(1080));let l=o=class{constructor(e){this.knex=e,this.logger=new a.Logger(o.name)}async getProperty(e){try{const t=await this.knex("config_properties").select("value").where("name",e).first();return t?.value||null}catch(t){return this.logger.error(`Error getting property ${e}`,t),null}}async setProperty(e,t){try{null===t?await this.knex("config_properties").where("name",e).delete():await this.knex("config_properties").insert({name:e,value:t}).onConflict("name").merge()}catch(t){throw this.logger.error(`Error setting property ${e}`,t),t}}async getAllProperties(){try{return(await this.knex("config_properties").select("*")).map((e=>new c.ConfigProperty(e.name,e.value)))}catch(e){return this.logger.error("Error getting all properties",e),[]}}async deleteProperty(e){try{await this.knex("config_properties").where("name",e).delete()}catch(t){throw this.logger.error(`Error deleting property ${e}`,t),t}}};t.ConfigPropertyRepository=l,t.ConfigPropertyRepository=l=o=s([(0,a.Injectable)(),i(0,(0,a.Inject)("KNEX")),n("design:paramtypes",[Function])],l)},2368:function(e,t,r){"use strict";var o,s=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigService=void 0;const i=r(3563),a=r(5699),c=r(3713),l=r(6910);let u=o=class{constructor(e){this.configPropertyRepository=e,this.configCache=new Map,this.logger=new i.Logger(o.name),o.instance=this,this.cachedDescriptors=c.ConfigDescriptors.getDefaultDescriptors()}static getInstance(){if(!o.instance)throw new Error("ConfigService has not been initialized");return o.instance}static getProperty(e,t){return o.getInstance().getProperty(e,t)}static getNumericProperty(e,t){return o.getInstance().getNumericProperty(e,t)}static getBooleanProperty(e,t){return o.getInstance().getBooleanProperty(e,t)}async onModuleInit(){try{await this.loadConfigToCache()}catch(e){this.logger.error("Failed to load config properties to cache",e)}}async loadConfigToCache(){try{const e=await this.configPropertyRepository.getAllProperties();this.configCache.clear();for(const t of e)this.configCache.set(t.name,t.value);this.logger.log("Config properties loaded to cache successfully")}catch(e){throw this.logger.error("Error loading config properties to cache",e),e}}async getConfig(){const e=new Map,t=[],r=c.ConfigDescriptors.getDefaultDescriptors();for(const t of r.sections)for(const r of t.properties){const t=this.getProperty(r.name);if(null!==t&&e.set(r.name,r.sensitive?this.maskValue(t):t),"function"==typeof r.possibleValues){const e=await r.possibleValues();r.possibleValues=e}}return null===this.getProperty(l.ConfigPropNames.HLDK_API_KEY)&&t.push("You need to set the HLDK API Key which you can get from higherlevel.dev/app"),null===this.getProperty(l.ConfigPropNames.ANTHROPIC_API_KEY)&&t.push("You need to set the Anthropic API Key which you can get from console.anthropic.com"),{version:"0.9.4",descriptors:r,currentValues:Object.fromEntries(e),requiredActions:t.length>0?t:void 0}}getProperty(e,t){const r=process.env[e];if(void 0!==r)return r;const o=this.configCache.get(e);if(void 0!==o)return o;const s=this.findDescriptor(e);return s?s?.defaultValue?.toString()||t||null:(this.logger.warn("Unknown property: %s",e),null)}getNumericProperty(e,t){const r=this.getProperty(e);return null!==r?parseFloat(r):t||null}getBooleanProperty(e,t){const r=this.getProperty(e);return null!==r?"true"===r.toLowerCase():t||null}findDescriptor(e){for(const t of this.cachedDescriptors.sections){const r=t.properties.find((t=>t.name===e));if(r)return r}}async setProperty(e,t){try{t?(await this.configPropertyRepository.setProperty(e,t),this.configCache.set(e,t)):await this.unsetProperty(e)}catch(t){throw this.logger.error(`Error setting property ${e}`,t),t}}async unsetProperty(e){try{await this.configPropertyRepository.deleteProperty(e),this.configCache.delete(e)}catch(t){throw this.logger.error(`Error unsetting property ${e}`,t),t}}async getAllProperties(){return Array.from(this.configCache.entries()).map((([e,t])=>({name:e,value:t})))}maskValue(e){if(!e)return"not set";if(e.length<20)return"*".repeat(e.length);const t=e.length-8-4;return e.slice(0,8)+"*".repeat(t)+e.slice(-4)}};t.ConfigService=u,t.ConfigService=u=o=s([(0,i.Injectable)(),n("design:paramtypes",[a.ConfigPropertyRepository])],u)},5754:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitLogEntry=void 0;t.GitLogEntry=class{constructor(e,t,r,o){this.hash=e,this.message=t,this.timestamp=r,this.author=o}}},7265:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.GitController=void 0;const i=r(3563),a=r(5190);let c=class{constructor(e){this.gitService=e}async getGitLog(e){try{return await this.gitService.getGitLog(e)}catch(e){if(e.message.includes("not a git repository"))throw new i.HttpException("Workspace is not a git repository",i.HttpStatus.BAD_REQUEST);throw new i.HttpException(`Failed to get git log: ${e.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}async getGitDiff(e,t){try{return await this.gitService.getGitDiff(e,t)}catch(e){throw new i.HttpException(`Failed to get git diff: ${e.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}async undoLastCommit(e){try{await this.gitService.undoLastCommit(e)}catch(e){throw new i.HttpException(`Failed to undo last commit: ${e.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}};t.GitController=c,o([(0,i.Get)(":workspaceName/log"),n(0,(0,i.Param)("workspaceName")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],c.prototype,"getGitLog",null),o([(0,i.Get)(":workspaceName/diff/:hash"),n(0,(0,i.Param)("workspaceName")),n(1,(0,i.Param)("hash")),s("design:type",Function),s("design:paramtypes",[String,String]),s("design:returntype",Promise)],c.prototype,"getGitDiff",null),o([(0,i.Post)(":workspaceName/undo-last-commit"),n(0,(0,i.Param)("workspaceName")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],c.prototype,"undoLastCommit",null),t.GitController=c=o([(0,i.Controller)("git"),s("design:paramtypes",[a.GitService])],c)},1901:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.GitModule=void 0;const s=r(3563),n=r(7265),i=r(5190),a=r(5873);let c=class{};t.GitModule=c,t.GitModule=c=o([(0,s.Module)({imports:[a.WorkspaceModule],controllers:[n.GitController],providers:[i.GitService]})],c)},5190:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.GitService=void 0;const n=r(3563),i=r(8474),a=r(5317),c=r(9023),l=r(5754),u=r(9055),d=(0,c.promisify)(a.exec);let p=class{constructor(e){this.workspaceService=e}async undoLastCommit(e){const t=await this.workspaceService.findOne(e);if(!t)throw new Error(`Workspace ${e} not found`);const r=t.repoBaseDir;try{await d("git reset --hard HEAD~1",{cwd:r})}catch(e){throw new Error(`Failed to undo last commit: ${e.message}`)}}async getGitLog(e){const t=await this.workspaceService.findOne(e);if(!t)throw new Error(`Workspace ${e} not found`);const r=t.repoBaseDir,{stdout:o}=await d("git log -n 10 --pretty=format:%x7b%x22hash%x22:%x22%h%x22,%x22message%x22:%x22%s%x22,%x22timestamp%x22:%x22%aI%x22,%x22author%x22:%x22%an%x22%x7d",{cwd:r});return o.split(/\r?\n/).filter((e=>e.trim().startsWith("{"))).map((e=>{try{const{hash:t,message:r,timestamp:o,author:s}=JSON.parse(e);return new l.GitLogEntry(t,r,o,s)}catch(t){return u.default.debug(`Failed to parse git log entry: ${e}`),null}})).filter((e=>null!==e))}async getGitDiff(e,t){const r=await this.workspaceService.findOne(e);if(!r)throw new Error(`Workspace ${e} not found`);const o=r.repoBaseDir,s=`git show --unified ${t}`;try{const{stdout:e}=await d(s,{cwd:o});return e}catch(e){throw new Error(`Failed to get git diff: ${e.message}`)}}};t.GitService=p,t.GitService=p=o([(0,n.Injectable)(),s("design:paramtypes",[i.WorkspaceService])],p)},5096:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldController=void 0;const n=r(3563),i=r(5533);let a=class{constructor(e){this.helloWorldService=e}getHello(){return this.helloWorldService.getHello()}};t.HelloWorldController=a,o([(0,n.Get)(),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",String)],a.prototype,"getHello",null),t.HelloWorldController=a=o([(0,n.Controller)("hello-world"),s("design:paramtypes",[i.HelloWorldService])],a)},6808:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldModule=void 0;const s=r(3563),n=r(5096),i=r(5533);let a=class{};t.HelloWorldModule=a,t.HelloWorldModule=a=o([(0,s.Module)({controllers:[n.HelloWorldController],providers:[i.HelloWorldService]})],a)},5533:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldService=void 0;const s=r(3563);let n=class{getHello(){return"Hello World!"}};t.HelloWorldService=n,t.HelloWorldService=n=o([(0,s.Injectable)()],n)},4193:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HomeModule=void 0;const s=r(3563),n=r(538),i=r(7967);let a=class{};t.HomeModule=a,t.HomeModule=a=o([(0,s.Module)({imports:[i.ConfigModule],providers:[n.HomeService],exports:[n.HomeService]})],a)},538:function(e,t,r){"use strict";var o,s=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.HomeService=void 0;const i=r(3563),a=r(2368),c=r(8938),l=r(857);class u{constructor(e){const{requestContent:t,responseContent:r,startedAt:o,endedAt:s,...n}=e;this.requestData=n}toJSON(){return this.requestData}}let d=o=class{constructor(e){this.configService=e,this.logger=new i.Logger(o.name),this.accessCheck={lastResultCode:null,timeOfLastCheck:null,failedToConnect:!1},this.workerQueue=[],this.workerInterval=null,this.isShuttingDown=!1}onModuleInit(){this.startWorkerThread()}async onApplicationShutdown(e){this.logger.log("Application shutdown initiated"+(e?` (signal: ${e})`:"")),this.isShuttingDown=!0,this.workerInterval&&clearInterval(this.workerInterval),this.workerQueue.length>0&&(this.logger.log(`Processing ${this.workerQueue.length} remaining requests before shutdown`),await this.processRemainingRequests()),this.logger.log("Shutdown process completed")}isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async checkAccess(){const e=this.configService.getProperty("HLDK_API_KEY");if(!e)throw new Error("API Key is not configured");if(!this.isValidUUID(e))throw new Error("Invalid API Key");const t=l.hostname();try{const r=await c.default.post("https://otiiwxlfsrejhbrxdras.supabase.co/functions/v1/log-access",{hostname:t},{headers:{Authorization:`Bearer ${e}`},timeout:3e3});this.accessCheck={lastResultCode:r.status,timeOfLastCheck:new Date,failedToConnect:!1}}catch(e){if(c.default.isAxiosError(e)){const t=e;t.response?this.accessCheck={lastResultCode:t.response.status,timeOfLastCheck:new Date,failedToConnect:!1}:(t.request,this.accessCheck={lastResultCode:null,timeOfLastCheck:new Date,failedToConnect:!0})}else this.accessCheck={lastResultCode:null,timeOfLastCheck:new Date,failedToConnect:!0};this.logger.error("Failed to check access",e)}return this.accessCheck}async isAccessOkay(){const e=new Date(Date.now()-864e5);return(!this.accessCheck.timeOfLastCheck||this.accessCheck.timeOfLastCheck<e||403===this.accessCheck.lastResultCode)&&await this.checkAccess(),200===this.accessCheck.lastResultCode||this.accessCheck.failedToConnect}async logRequest(e){await this.isAccessOkay()&&!this.accessCheck.failedToConnect&&this.workerQueue.push(new u(e))}startWorkerThread(){this.workerInterval=setInterval((async()=>{if(this.workerQueue.length>0&&!this.isShuttingDown){const e=[...this.workerQueue];this.workerQueue=[],await this.sendRequestsToHomeServer(e)}}),1e4)}async processRemainingRequests(){if(this.workerQueue.length>0){const e=[...this.workerQueue];this.workerQueue=[],await this.sendRequestsToHomeServer(e)}}async sendRequestsToHomeServer(e){const t=this.configService.getProperty("HLDK_API_KEY");if(!t)return void this.logger.log("API Key is not configured");const r=e.map((e=>c.default.post("https://otiiwxlfsrejhbrxdras.supabase.co/functions/v1/log-request",e,{headers:{Authorization:`Bearer ${t}`},timeout:5e3})));(await Promise.allSettled(r)).forEach(((e,t)=>{"rejected"===e.status&&this.logger.log(`Failed to log request at index ${t}`,e.reason)}))}};t.HomeService=d,t.HomeService=d=o=s([(0,i.Injectable)(),n("design:paramtypes",[a.ConfigService])],d)},672:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationRepository=void 0;const i=r(3563),a=(r(1832),r(3903));let c=class{constructor(e){this.knex=e}async findAll(e,t){let r=this.knex("mutations").select("*");if(t&&(r=r.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:o}=e,s=(t-1)*o;r=r.offset(s).limit(o)}return r}async findById(e){return this.knex("mutations").where("id",e).first()}async findBySessionId(e,t,r){let o=this.knex("mutations").where("sessionId",e);if(r&&(o=o.orderBy(r.field,r.order.toLowerCase())),t){const{page:e,limit:r}=t,s=(e-1)*r;o=o.offset(s).limit(r)}return o}async findBySessionIds(e){return this.knex("mutations").whereIn("sessionId",e)}async findByRequestId(e){return this.knex("mutations").where("requestId",e)}async create(e){const t=(0,a.v4)(),r=(new Date).toISOString();return await this.knex("mutations").insert({id:t,...e,updatedAt:r}),t}async update(e,t){await this.knex("mutations").where("id",e).update(t)}async delete(e){await this.knex("mutations").where("id",e).delete()}};t.MutationRepository=c,t.MutationRepository=c=o([(0,i.Injectable)(),n(0,(0,i.Inject)("KNEX")),s("design:paramtypes",[Function])],c)},9989:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsController=void 0;const i=r(3563),a=r(7602);let c=class{constructor(e){this.mutationsService=e}async getMutationsForSession(e){return this.mutationsService.getMutationsForSession(e)}async getMutation(e){return this.mutationsService.getMutation(e)}};t.MutationsController=c,o([(0,i.Get)("session/:sessionId"),n(0,(0,i.Param)("sessionId")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],c.prototype,"getMutationsForSession",null),o([(0,i.Get)(":id"),n(0,(0,i.Param)("id")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],c.prototype,"getMutation",null),t.MutationsController=c=o([(0,i.Controller)("mutations"),s("design:paramtypes",[a.MutationsService])],c)},3177:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsModule=void 0;const s=r(3563),n=r(376),i=r(9989),a=r(7602),c=r(672);let l=class{};t.MutationsModule=l,t.MutationsModule=l=o([(0,s.Module)({imports:[n.DataSourceModule],controllers:[i.MutationsController],providers:[a.MutationsService,c.MutationRepository],exports:[a.MutationsService]})],l)},7602:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsService=void 0;const n=r(3563),i=r(672);let a=class{constructor(e){this.mutationRepository=e}async getMutationsForSession(e){return(await this.mutationRepository.findBySessionId(e,void 0,{field:"updatedAt",order:"DESC"})).map((e=>({id:e.id,type:e.type,filePath:e.filePath,updatedAt:e.updatedAt,description:e.description,fileContentsBefore:e.fileContentsBefore,fileContentsAfter:e.fileContentsAfter,requestId:e.requestId})))}async getMutation(e){return this.mutationRepository.findById(e)}async getMutationsForRequest(e){return(await this.mutationRepository.findByRequestId(e)).map((e=>({id:e.id,type:e.type,filePath:e.filePath,updatedAt:e.updatedAt,description:e.description,fileContentsBefore:e.fileContentsBefore,fileContentsAfter:e.fileContentsAfter,requestId:e.requestId})))}async createMutation(e){if(!e.sessionId)throw new Error("sessionId is required to create a mutation");if(!e.requestId)throw new Error("requestId is required to create a mutation");return await this.mutationRepository.create({...e,updatedAt:e.updatedAt||new Date})}};t.MutationsService=a,t.MutationsService=a=o([(0,n.Injectable)(),s("design:paramtypes",[i.MutationRepository])],a)},353:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingController=void 0;const i=r(3563),a=r(7510);let c=class{constructor(e){this.reportingService=e}async getReport(e,t,r,o){return this.reportingService.generateReport(e,t,r,o)}};t.ReportingController=c,o([(0,i.Get)("report"),n(0,(0,i.Query)("from")),n(1,(0,i.Query)("to")),n(2,(0,i.Query)("period")),n(3,(0,i.Query)("workspaceName")),s("design:type",Function),s("design:paramtypes",[String,String,String,String]),s("design:returntype",Promise)],c.prototype,"getReport",null),t.ReportingController=c=o([(0,i.Controller)("reporting"),s("design:paramtypes",[a.ReportingService])],c)},8221:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingModule=void 0;const s=r(3563),n=r(353),i=r(7510),a=r(376),c=r(7967);let l=class{};t.ReportingModule=l,t.ReportingModule=l=o([(0,s.Module)({imports:[a.DataSourceModule,c.ConfigModule],controllers:[n.ReportingController],providers:[i.ReportingService]})],l)},7510:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingService=void 0;const i=r(3563),a=(r(1832),r(9055)),c=r(2368),l=r(6910);let u=class{constructor(e,t){this.knex=e,this.configService=t}async generateReport(e,t,r,o){try{const{startDate:s,endDate:n}=this.resolveDateRange(e,t,r),i=await this.getRequestTotalsData(s,n,o);return{requestTotals:i,dailyMetrics:await this.getHistoricStats(s,n,o),dateRange:{startDate:s,endDate:n}}}catch(e){throw a.default.error(`Error generating report: ${e.message}`,e.stack),e}}resolveDateRange(e,t,r){const o=new Date;let s,n;try{if(e&&t)s=new Date(e),n=new Date(t),n.setHours(23,59,59,999);else if(r)switch(n=new Date(o),n.setHours(23,59,59,999),r){case"today":s=new Date(o),s.setHours(0,0,0,0);break;case"this-week":s=new Date(o),s.setDate(s.getDate()-7),s.setHours(0,0,0,0);break;case"this-month":s=new Date(o),s.setDate(s.getDate()-30),s.setHours(0,0,0,0);break;case"all-time":s=new Date(o),s.setDate(s.getDate()-90),s.setHours(0,0,0,0);break;default:throw new Error("Invalid period specified")}else s=new Date(o),s.setDate(s.getDate()-90),s.setHours(0,0,0,0),n=new Date(o),n.setHours(23,59,59,999);return{startDate:s,endDate:n}}catch(e){throw a.default.error(`Error resolving date range: ${e.message}`,e.stack),e}}async getRequestTotalsData(e,t,r){try{let o=this.knex("requests").select(this.knex.raw("COUNT(*) as totalRequests"),this.knex.raw("COALESCE(SUM(tookMillis), 0) as totalProcessingMillis"),this.knex.raw("COALESCE(AVG(tookMillis), 0) as avgProcessingMillis"),this.knex.raw("COALESCE(SUM(inputTokens), 0) as totalInputTokens"),this.knex.raw("COALESCE(SUM(outputTokens), 0) as totalOutputTokens"),this.knex.raw("COALESCE(SUM(totalTokens), 0) as totalTokens"),this.knex.raw("COALESCE(SUM(cost), 0) as totalCost"),this.knex.raw("COALESCE(AVG(cost), 0) as avgCostPerRequest"),this.knex.raw("COALESCE(SUM(linesChanged), 0) as totalLinesChanged"),this.knex.raw("COALESCE(AVG(linesChanged), 0) as avgLinesChangedPerRequest"),this.knex.raw("COALESCE(SUM(filesChanged), 0) as totalFilesChanged"),this.knex.raw("COALESCE(SUM(insertions), 0) as totalInsertions"),this.knex.raw("COALESCE(SUM(deletions), 0) as totalDeletions"),this.knex.raw("COALESCE(SUM(testLinesChanged), 0) as totalTestLinesChanged"),this.knex.raw("COALESCE(SUM(testFilesChanged), 0) as totalTestFilesChanged"),this.knex.raw("COALESCE(SUM(testInsertions), 0) as totalTestInsertions"),this.knex.raw("COALESCE(SUM(testDeletions), 0) as totalTestDeletions"),this.knex.raw("COALESCE(SUM(cacheReadTokens), 0) as totalCacheReadTokens"),this.knex.raw("COALESCE(SUM(cacheWriteTokens), 0) as totalCacheWriteTokens")).whereBetween("startedAt",[e,t]);r&&""!==r.trim()&&(o=o.where("workspaceName",r));const s=await o.first(),n=s.totalLinesChanged-s.totalTestLinesChanged,i=s.totalFilesChanged-s.totalTestFilesChanged,a=s.totalLinesChanged>0?s.totalCost/s.totalLinesChanged:0,c=this.configService.getNumericProperty(l.ConfigPropNames.VALUE_PER_LINE)||2.4,u=s.totalLinesChanged*c,d=s.totalRequests>0?u/s.totalRequests:0,p=s.totalInputTokens+s.totalCacheReadTokens>0?100*s.totalCacheReadTokens/(s.totalInputTokens+s.totalCacheReadTokens):0;return{totalRequests:s.totalRequests,totalProcessingMillis:s.totalProcessingMillis,avgProcessingMillis:s.avgProcessingMillis,totalInputTokens:s.totalInputTokens,totalOutputTokens:s.totalOutputTokens,totalTokens:s.totalTokens,totalCost:s.totalCost,avgCostPerRequest:s.avgCostPerRequest,avgCostPerLine:a,totalLinesChanged:s.totalLinesChanged,totalFilesChanged:s.totalFilesChanged,totalInsertions:s.totalInsertions,totalDeletions:s.totalDeletions,totalTestLinesChanged:s.totalTestLinesChanged,totalTestFilesChanged:s.totalTestFilesChanged,totalTestInsertions:s.totalTestInsertions,totalTestDeletions:s.totalTestDeletions,totalProductionLinesChanged:n,totalProductionFilesChanged:i,totalValueCreated:u,avgValueCreatedPerRequest:d,avgLinesChangedPerRequest:s.avgLinesChangedPerRequest,totalCacheReadTokens:s.totalCacheReadTokens,totalCacheWriteTokens:s.totalCacheWriteTokens,inputCacheHitPercentage:p}}catch(e){throw a.default.error(`Error getting request totals data: ${e.message}`,e.stack),e}}async getHistoricStats(e,t,r){try{let o=this.knex("requests").select(this.knex.raw("strftime('%Y-%m-%d', datetime(startedAt/1000, 'unixepoch')) as label"),this.knex.raw("COALESCE(SUM(linesChanged), 0) as linesChanged"),this.knex.raw("COALESCE(SUM(cost), 0) as cost"),this.knex.raw("COUNT(*) as requests"),this.knex.raw("COALESCE(SUM(tookMillis), 0) as processingTime")).whereBetween("startedAt",[e,t]);r&&""!==r.trim()&&(o=o.where("workspaceName",r)),o=o.groupBy("label").orderBy("label","asc"),a.default.debug(`Query: ${o.toString()}`);const s=await o,n=this.configService.getNumericProperty(l.ConfigPropNames.VALUE_PER_LINE)||2.4;return s.map((e=>({label:e.label,linesChanged:e.linesChanged,cost:e.cost,valueCreated:e.linesChanged*n,requests:e.requests,processingTime:e.processingTime})))}catch(e){throw a.default.error(`Error getting historic stats: ${e.message}`,e.stack),e}}};t.ReportingService=u,t.ReportingService=u=o([(0,i.Injectable)(),n(0,(0,i.Inject)("KNEX")),s("design:paramtypes",[Function,c.ConfigService])],u)},9095:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ItemRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t){let r=this.knex("items").select("*");if(t&&(r=r.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:o}=e,s=(t-1)*o;r=r.offset(s).limit(o)}return r}async findById(e){return this.knex("items").where("itemId",e).first()}async findBySessionId(e,t,r){let o=this.knex("items").where("sessionId",e);if(r&&(o=o.orderBy(r.field,r.order.toLowerCase())),t){const{page:e,limit:r}=t,s=(e-1)*r;o=o.offset(s).limit(r)}return o}async create(e){await this.knex("items").insert(e)}async update(e,t){await this.knex("items").where("itemId",e).update(t)}async delete(e){await this.knex("items").where("itemId",e).delete()}async countBySessionId(e){const t=await this.knex("items").where("sessionId",e).count("* as count").first();return t?.count}async getSessionStats(e){const t=await this.knex("items").select("sessionId").sum("inputTokens as inputTokens").sum("cacheWriteTokens as cacheWriteTokens").sum("cacheReadTokens as cacheReadTokens").sum("outputTokens as outputTokens").sum("totalTokens as totalTokens").sum("cost as cost").whereIn("sessionId",e).groupBy("sessionId"),r={};return t.forEach((e=>{r[e.sessionId]={inputTokens:e.inputTokens,cacheWriteTokens:e.cacheWriteTokens,cacheReadTokens:e.cacheReadTokens,outputTokens:e.outputTokens,totalTokens:e.totalTokens,cost:e.cost}})),r}async getRequestStats(e){const t=await this.knex("items").select("requestId").sum("inputTokens as inputTokens").sum("cacheWriteTokens as cacheWriteTokens").sum("cacheReadTokens as cacheReadTokens").sum("outputTokens as outputTokens").sum("totalTokens as totalTokens").sum("cost as cost").whereIn("requestId",e).groupBy("requestId"),r={};return t.forEach((e=>{r[e.requestId]={inputTokens:e.inputTokens,cacheWriteTokens:e.cacheWriteTokens,cacheReadTokens:e.cacheReadTokens,outputTokens:e.outputTokens,totalTokens:e.totalTokens,cost:e.cost}})),r}};t.ItemRepository=a,t.ItemRepository=a=o([(0,i.Injectable)(),n(0,(0,i.Inject)("KNEX")),s("design:paramtypes",[Function])],a)},5312:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Request=void 0;t.Request=class{constructor(e,t,r,o,s={}){this.responseContent="",this.startedAt=new Date,this.endedAt=new Date,this.tookMillis=0,this.inputTokens=0,this.cacheWriteTokens=0,this.cacheReadTokens=0,this.outputTokens=0,this.totalTokens=0,this.cost=0,this.filesChanged=0,this.insertions=0,this.deletions=0,this.testFilesChanged=0,this.testInsertions=0,this.testDeletions=0,this.linesChanged=0,this.testLinesChanged=0,this.requestId=e,this.sessionId=t,this.workspaceName=r,this.requestContent=o,Object.assign(this,s)}}},811:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.RequestRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t){let r=this.knex("requests").select("*");if(t&&(r=r.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:o}=e,s=(t-1)*o;r=r.offset(s).limit(o)}return r}async findById(e){return this.knex("requests").where("requestId",e).first()}async findBySessionId(e,t,r){let o=this.knex("requests").where("sessionId",e);if(r&&(o=o.orderBy(r.field,r.order.toLowerCase())),t){const{page:e,limit:r}=t,s=(e-1)*r;o=o.offset(s).limit(r)}return o}async create(e){await this.knex("requests").insert(e)}async update(e,t){await this.knex("requests").where("requestId",e).update(t)}async delete(e){await this.knex("requests").where("requestId",e).delete()}async countBySessionId(e){const t=await this.knex("requests").where("sessionId",e).count("* as count").first();return t?.count}async updateRequest(e,t){await this.knex("requests").where("requestId",e).update(t)}async updateGitStats(e,t){await this.knex("requests").where("requestId",e).update(t)}async getSessionGitStats(e){return(await this.knex("requests").select("sessionId").sum("filesChanged as filesChanged").sum("insertions as insertions").sum("deletions as deletions").sum("testFilesChanged as testFilesChanged").sum("testInsertions as testInsertions").sum("testDeletions as testDeletions").sum("linesChanged as linesChanged").sum("testLinesChanged as testLinesChanged").whereIn("sessionId",e).groupBy("sessionId")).reduce(((e,t)=>(e[t.sessionId]={filesChanged:t.filesChanged,insertions:t.insertions,deletions:t.deletions,testFilesChanged:t.testFilesChanged,testInsertions:t.testInsertions,testDeletions:t.testDeletions,linesChanged:t.linesChanged,testLinesChanged:t.testLinesChanged},e)),{})}};t.RequestRepository=a,t.RequestRepository=a=o([(0,i.Injectable)(),n(0,(0,i.Inject)("KNEX")),s("design:paramtypes",[Function])],a)},5480:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionController=void 0;const i=r(3563),a=r(7373),c=r(573);let l=class{constructor(e){this.sessionService=e}async createSession(e,t,r="",o="se-agent"){return this.sessionService.ensureSession(e,t,r,o)}async getSessions(e=1,t=10,r="createdAt",o="DESC"){return this.sessionService.getSessions(e,t,r,o)}async getSession(e){return this.sessionService.getSession(e)}async deleteSession(e){return this.sessionService.deleteSession(e)}async getItemsForSession(e,t=1,r=100,o="ASC"){const[s,n]=await this.sessionService.getItemsForSession(e,t,r,o);return{items:s,total:n}}streamSessionItems(e){return this.sessionService.streamSessionItems(e)}async abortSession(e){return this.sessionService.abortSession(e)}};t.SessionController=l,o([(0,i.Post)(),n(0,(0,i.Body)("workspaceName")),n(1,(0,i.Body)("sessionId")),n(2,(0,i.Body)("requestContent")),n(3,(0,i.Body)("agent")),s("design:type",Function),s("design:paramtypes",[String,String,String,String]),s("design:returntype",Promise)],l.prototype,"createSession",null),o([(0,i.Get)(),n(0,(0,i.Query)("page")),n(1,(0,i.Query)("limit")),n(2,(0,i.Query)("sortBy")),n(3,(0,i.Query)("sortOrder")),s("design:type",Function),s("design:paramtypes",[Number,Number,String,String]),s("design:returntype",Promise)],l.prototype,"getSessions",null),o([(0,i.Get)(":sessionId"),n(0,(0,i.Param)("sessionId")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],l.prototype,"getSession",null),o([(0,i.Delete)(":sessionId"),n(0,(0,i.Param)("sessionId")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],l.prototype,"deleteSession",null),o([(0,i.Get)(":sessionId/items"),n(0,(0,i.Param)("sessionId")),n(1,(0,i.Query)("page")),n(2,(0,i.Query)("limit")),n(3,(0,i.Query)("sortOrder")),s("design:type",Function),s("design:paramtypes",[String,Number,Number,String]),s("design:returntype",Promise)],l.prototype,"getItemsForSession",null),o([(0,i.Sse)(":sessionId/stream"),n(0,(0,i.Param)("sessionId")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",c.Observable)],l.prototype,"streamSessionItems",null),o([(0,i.Post)(":sessionId/abort"),n(0,(0,i.Param)("sessionId")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],l.prototype,"abortSession",null),t.SessionController=l=o([(0,i.Controller)("sessions"),s("design:paramtypes",[a.SessionService])],l)},3880:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionModule=void 0;const s=r(3563),n=r(376),i=r(5480),a=r(7373),c=r(3936),l=r(9095),u=r(811),d=r(3177);let p=class{};t.SessionModule=p,t.SessionModule=p=o([(0,s.Module)({imports:[n.DataSourceModule,d.MutationsModule],controllers:[i.SessionController],providers:[a.SessionService,c.SessionRepository,l.ItemRepository,u.RequestRepository],exports:[a.SessionService]})],p)},3936:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t,r){let o=this.knex("sessions").select("*"),s=this.knex("sessions").count("* as count");r&&(o=o.where(r),s=s.where(r)),t&&(o=o.orderBy(t.field,t.order.toLowerCase()));const n=await s.first(),i=n?.count;if(e){const{page:t,limit:r}=e,s=(t-1)*r;o=o.offset(s).limit(r)}return{sessions:await o,total:i}}async findById(e){return this.knex("sessions").where("sessionId",e).first()}async create(e){await this.knex("sessions").insert(e)}async update(e,t){await this.knex("sessions").where("sessionId",e).update(t)}async delete(e){await this.knex("sessions").where("sessionId",e).delete()}async count(e){const t=this.knex("sessions").count("* as count");e&&t.where(e);const r=await t.first();return r?.count}async createItem(e){await this.knex("item").insert(e)}async findItemsBySessionId(e){return this.knex("item").where("sessionId",e).orderBy("createdAt","asc")}async updateItem(e,t){await this.knex("item").where("itemId",e).update(t)}};t.SessionRepository=a,t.SessionRepository=a=o([(0,i.Injectable)(),n(0,(0,i.Inject)("KNEX")),s("design:paramtypes",[Function])],a)},7373:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionService=void 0;const n=r(3563),i=r(5312),a=r(573),c=r(4434),l=r(3936),u=r(9095),d=r(811),p=r(9055),f=r(9100);let h=class{constructor(e,t,r){this.sessionRepository=e,this.itemRepository=t,this.requestRepository=r,this.eventEmitter=new c.EventEmitter}async getSessions(e=1,t=10,r="createdAt",o="DESC"){const{sessions:s,total:n}=await this.sessionRepository.findAll({page:e,limit:t},{field:r,order:o}),i=s.map((e=>e.sessionId)),a=await this.itemRepository.getSessionStats(i),c=await this.requestRepository.getSessionGitStats(i);return{sessions:s.map((e=>({...e,stats:{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0,...a[e.sessionId]||{}},gitStats:{filesChanged:0,insertions:0,deletions:0,testFilesChanged:0,testInsertions:0,testDeletions:0,...c[e.sessionId]||{}}}))),total:n}}async getSessionStats(e){return{...(await this.itemRepository.getSessionStats([e]))[e]||{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0}}}async getRequestStats(e){return{...(await this.itemRepository.getRequestStats([e]))[e]||{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0}}}async ensureSession(e,t,r,o){const s=await this.sessionRepository.findById(t);if(s){if(s.workspaceName!==e)throw new Error(`Session ${t} exists but belongs to a different workspace`);if("active"===s.status)throw new Error(`Session ${t} is currently active`);return s.requestSnippet||(s.requestSnippet=r.slice(0,250),await this.sessionRepository.update(t,{requestSnippet:s.requestSnippet})),s}const n={sessionId:t,workspaceName:e,status:"inactive",createdAt:new Date,requestSnippet:r.slice(0,250),agent:o};return await this.sessionRepository.create(n),n}async getSession(e){return this.sessionRepository.findById(e)}async deleteSession(e){await this.sessionRepository.delete(e)}async deleteSessionForWorkspace(e,t){await this.sessionRepository.delete(t)}async addItem(e){return"AI"===e.label||"Human"===e.label?p.default.info("Adding item to session: %s with label: %s, content: %s",e.sessionId,e.label,e.content):p.default.debug("Adding item to session %s with label %s, content: %s",e.sessionId,e.label,e.content),await this.itemRepository.create(e),this.eventEmitter.emit("newItem",e),e}async getItemsForSession(e,t=1,r=100,o="ASC"){return[await this.itemRepository.findBySessionId(e,{page:t,limit:r},{field:"createdAt",order:o}),await this.itemRepository.countBySessionId(e)]}streamSessionItems(e){return new a.Observable((t=>{this.getItemsForSession(e).then((([e])=>{e.forEach((e=>{t.next({data:e})}))}));const r=r=>{r.sessionId===e&&t.next({data:r})};return this.eventEmitter.on("newItem",r),()=>{this.eventEmitter.removeListener("newItem",r)}}))}async updateSessionStatus(e,t){await this.sessionRepository.update(e,{status:t})}async abortSession(e){if(!await this.sessionRepository.findById(e))throw new n.NotFoundException(`Session with id ${e} not found`);return await this.updateSessionStatus(e,"aborted"),this.sessionRepository.findById(e)}generateSessionId(){return(0,f.ulid)()}generateItemId(){return(0,f.ulid)()}async addRequest(e){p.default.info("Adding request to session: %s, workspaceName: %s, requestContent: %s",e.sessionId,e.workspaceName,e.requestContent);const t=new i.Request(e.requestId||this.generateRequestId(),e.sessionId,e.workspaceName,e.requestContent,e);return await this.requestRepository.create(t),t}async updateRequest(e,t){return p.default.info("Updating request: %s, updateData: %s",e,JSON.stringify(t)),await this.requestRepository.updateRequest(e,t),this.requestRepository.findById(e)}generateRequestId(){return(0,f.ulid)()}async getRequest(e){return this.requestRepository.findById(e)}async updateGitStats(e,t){p.default.info("Updating git stats for request: %s, gitStats: %s",e,JSON.stringify(t)),await this.requestRepository.updateGitStats(e,t)}};t.SessionService=h,t.SessionService=h=o([(0,n.Injectable)(),s("design:paramtypes",[l.SessionRepository,u.ItemRepository,d.RequestRepository])],h)},4912:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.MavenSourceArtefactScheme=void 0;const s=r(3563),n=r(8547),i=r(8938),a=r(1943),c=r(6928),l=r(857),u=r(4650),d=r(9055);let p=class{getName(){return"maven"}async downloadAndStoreSources(e,t,r){if(d.default.info(`Downloading and storing sources for Maven artifact: ${e}`),!this.isValidGAV(e))throw d.default.warn(`Invalid Maven GAV coordinates: ${e}`),new s.BadRequestException("Invalid Maven GAV coordinates");const o=this.getRepoUrls(r);d.default.info(`Using repository URLs: ${o.join(", ")}`);const i=await this.findSourcesJarUrl(o,e);if(!i)throw d.default.warn(`Sources jar not found for ${e} in any of the provided repositories`),new s.BadRequestException("Sources jar not found in any of the provided repositories");d.default.info(`Found sources jar at: ${i}`);const u=await a.mkdtemp(c.join(l.tmpdir(),"maven-sources-")),p=c.join(u,"sources.jar");try{await this.downloadFile(i,p),d.default.info(`Downloaded sources jar to: ${p}`);const r=e.replace(/:/g,"/"),o=c.join(t,"maven",r);await a.mkdir(o,{recursive:!0}),d.default.info(`Created cache directory: ${o}`),await this.unzipJar(p,o),d.default.info(`Unzipped sources jar to: ${o}`);const s=new n.SourceArtefact({scheme:this.getName(),locator:e,valid:!0,error:null,repo:new URL(i).origin,cacheSrcBaseDir:o});return d.default.info(`Successfully created SourceArtefact for ${e}`),s}finally{await a.rm(u,{recursive:!0,force:!0}),d.default.info(`Cleaned up temporary directory: ${u}`)}}async needsImport(e){if(!e.cacheSrcBaseDir)return!0;try{return 0===(await a.readdir(e.cacheSrcBaseDir)).length}catch(e){return!0}}async readArtefactSourceTree(e){if(!e.cacheSrcBaseDir)throw new Error("Invalid source artefact: missing cache directory");const{generateTree:t}=await Promise.resolve().then((()=>r(6426)));return t(e.cacheSrcBaseDir)}async readArtefactSourceFile(e,t){if(!e.cacheSrcBaseDir)throw new Error("Invalid source artefact: missing cache directory");const r=c.join(e.cacheSrcBaseDir,t);try{return await a.readFile(r,"utf-8")}catch(e){throw new Error(`Failed to read file: ${t}`)}}isValidGAV(e){return/^[^:]+:[^:]+:[^:]+$/.test(e)}getRepoUrls(e){if(e&&e.length>0)return e;const t=process.env.MAVEN_REPO_URLS;return t?t.split(",").map((e=>e.trim())):["https://repo.maven.apache.org/maven2"]}async findSourcesJarUrl(e,t){const[r,o,s]=t.split(":"),n=`${r.replace(/\./g,"/")}/${o}/${s}/${o}-${s}-sources.jar`;for(var a of e){a.endsWith("/")||(a+="/");const e=new URL(n,a).toString();d.default.info(`Checking URL: ${e}`);try{return await i.default.head(e),e}catch(t){d.default.info(`Error checking maven url ${e}: ${t}`)}}return null}async downloadFile(e,t){const r=await i.default.get(e,{responseType:"arraybuffer"});await a.writeFile(t,r.data)}async unzipJar(e,t){new u(e).extractAllTo(t,!0)}};t.MavenSourceArtefactScheme=p,t.MavenSourceArtefactScheme=p=o([(0,s.Injectable)()],p)},4358:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SchemePackageManager=void 0;const n=r(3563),i=r(6928),a=r(857),c=r(1943),l=r(8547);let u=class{constructor(e){this.schemes=new Map(e.map((e=>[e.getName(),e])))}getScheme(e){const t=this.schemes.get(e);if(!t)throw new Error(`Unknown scheme: ${e}`);return t}async downloadAndStoreSources(e,t,r){const o=this.schemes.get(e);if(!o)return new l.SourceArtefact({scheme:e,locator:t,valid:!1,error:`Unknown scheme: ${e}`,repo:"",cacheSrcBaseDir:""});const s=i.join(a.homedir(),".hldk","cached-sources");try{return await o.downloadAndStoreSources(t,s,r)}catch(r){return new l.SourceArtefact({scheme:e,locator:t,valid:!1,error:r instanceof Error?r.message:"Unknown error occurred",repo:"",cacheSrcBaseDir:""})}}async deleteSourceCache(e){if(e)try{await c.rm(e,{recursive:!0,force:!0})}catch(e){console.error(`Error deleting source cache directory: ${e}`)}}async needsImport(e){const t=this.schemes.get(e.scheme);return!t||await t.needsImport(e)}};t.SchemePackageManager=u,t.SchemePackageManager=u=o([(0,n.Injectable)(),s("design:paramtypes",[Array])],u)},308:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactController=void 0;const i=r(3563),a=r(3153);let c=class{constructor(e){this.sourceArtefactService=e}async importSourceArtefact(e){return this.sourceArtefactService.importSourceArtefact(e.scheme,e.locator,e.repoUrls)}async findById(e){return this.sourceArtefactService.findById(e)}async delete(e){return this.sourceArtefactService.delete(e)}async findBySchemeAndLocator(e,t){return this.sourceArtefactService.findBySchemeAndLocator(e,t)}async query(e,t,r=1,o=10,s="locator",n="ASC"){return this.sourceArtefactService.query(e,t,r,o,s,n)}};t.SourceArtefactController=c,o([(0,i.Post)("import"),n(0,(0,i.Body)()),s("design:type",Function),s("design:paramtypes",[Object]),s("design:returntype",Promise)],c.prototype,"importSourceArtefact",null),o([(0,i.Get)(":id"),n(0,(0,i.Param)("id")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],c.prototype,"findById",null),o([(0,i.Delete)(":id"),n(0,(0,i.Param)("id")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],c.prototype,"delete",null),o([(0,i.Get)("find"),n(0,(0,i.Query)("scheme")),n(1,(0,i.Query)("locator")),s("design:type",Function),s("design:paramtypes",[String,String]),s("design:returntype",Promise)],c.prototype,"findBySchemeAndLocator",null),o([(0,i.Get)(),n(0,(0,i.Query)("scheme")),n(1,(0,i.Query)("partialLocator")),n(2,(0,i.Query)("page")),n(3,(0,i.Query)("pageSize")),n(4,(0,i.Query)("sortBy")),n(5,(0,i.Query)("sortOrder")),s("design:type",Function),s("design:paramtypes",[String,String,Number,Number,String,String]),s("design:returntype",Promise)],c.prototype,"query",null),t.SourceArtefactController=c=o([(0,i.Controller)("source-artefacts"),s("design:paramtypes",[a.SourceArtefactService])],c)},8547:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefact=void 0;t.SourceArtefact=class{constructor(e){Object.assign(this,e)}}},7852:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactModule=void 0;const s=r(3563),n=r(308),i=r(3153),a=r(5908),c=r(376),l=r(4358),u=r(4912);let d=class{};t.SourceArtefactModule=d,t.SourceArtefactModule=d=o([(0,s.Module)({imports:[c.DataSourceModule],controllers:[n.SourceArtefactController],providers:[i.SourceArtefactService,a.SourceArtefactRepository,u.MavenSourceArtefactScheme,{provide:l.SchemePackageManager,useFactory:e=>new l.SchemePackageManager([e]),inject:[u.MavenSourceArtefactScheme]}],exports:[i.SourceArtefactService]})],d)},5908:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactRepository=void 0;const i=r(3563),a=(r(1832),r(8547)),c=r(3563),l=r(9100);let u=class{constructor(e){this.knex=e}async create(e){const t=(0,l.ulid)(),r=e.createdAt?e.createdAt:new Date;return await this.knex("source_artefacts").insert({id:t,...e,createdAt:r}),{id:t,...e}}async findById(e){const t=await this.knex("source_artefacts").where("id",e).first();return t?new a.SourceArtefact(t):null}async update(e,t){return await this.knex("source_artefacts").where("id",e).update(t),this.findById(e)}async delete(e){await this.knex("source_artefacts").where("id",e).delete()}async findBySchemeAndLocator(e,t){const r=await this.knex("source_artefacts").where({scheme:e,locator:t}).first();return r?new a.SourceArtefact(r):null}async query(e,t,r=1,o=10,s="locator",n="ASC"){const i=(r-1)*o;let c=this.knex("source_artefacts");e&&(c=c.where("scheme",e)),t&&(c=c.where("locator","like",`%${t}%`));const[l,u]=await Promise.all([c.clone().orderBy(s,n).limit(o).offset(i),c.clone().count("* as count").first()]);return{items:l.map((e=>new a.SourceArtefact(e))),total:u?.count}}};t.SourceArtefactRepository=u,t.SourceArtefactRepository=u=o([(0,i.Injectable)(),n(0,(0,c.Inject)("KNEX")),s("design:paramtypes",[Function])],u)},3153:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactService=void 0;const n=r(3563),i=r(5908),a=r(8547),c=r(4358);let l=class{constructor(e,t){this.sourceArtefactRepository=e,this.schemePackageManager=t}async importSourceArtefact(e,t,r){if(await this.findBySchemeAndLocator(e,t))throw new n.BadRequestException(`Source artefact with scheme '${e}' and locator '${t}' already exists.`);try{const o=await this.schemePackageManager.downloadAndStoreSources(e,t,r);return this.sourceArtefactRepository.create(o)}catch(r){const o=r instanceof Error?r.message:"Unknown error occurred";return this.sourceArtefactRepository.create(new a.SourceArtefact({scheme:e,locator:t,valid:!1,error:o,repo:"",cacheSrcBaseDir:""}))}}async findById(e){return this.sourceArtefactRepository.findById(e)}async delete(e){const t=await this.sourceArtefactRepository.findById(e);return t&&await this.schemePackageManager.deleteSourceCache(t.cacheSrcBaseDir),this.sourceArtefactRepository.delete(e)}async findBySchemeAndLocator(e,t){return this.sourceArtefactRepository.findBySchemeAndLocator(e,t)}async query(e,t,r=1,o=10,s="locator",n="ASC"){return this.sourceArtefactRepository.query(e,t,r,o,s,n)}async readArtefactSourceTree(e,t,r){const o=await this.ensureSourceArtefact(e,t,r);return this.schemePackageManager.getScheme(e).readArtefactSourceTree(o)}async readArtefactSourceFile(e,t,r,o){const s=await this.ensureSourceArtefact(e,t,o);return this.schemePackageManager.getScheme(e).readArtefactSourceFile(s,r)}async ensureSourceArtefact(e,t,r){let o=await this.findBySchemeAndLocator(e,t);const s=this.schemePackageManager.getScheme(e);return o&&!await s.needsImport(o)||(o=await this.importSourceArtefact(e,t,r)),o}};t.SourceArtefactService=l,t.SourceArtefactService=l=o([(0,n.Injectable)(),s("design:paramtypes",[i.SourceArtefactRepository,c.SchemePackageManager])],l)},6158:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ToolFactoryService=void 0;const n=r(3563),i=r(7602),a=r(8474),c=r(3153),l=r(7373),u=r(3923),d=r(4970),p=r(7465),f=r(3765),h=r(5515),g=r(5996),y=r(1781),m=r(7600),w=r(2626),v=r(4911),S=r(3716),b=r(3239);let R=class{constructor(e,t,r,o,s){this.mutationsService=e,this.workspaceService=t,this.sourceArtefactService=r,this.sessionService=o,this.summaryCompletion=s,this.toolMap={update_file:e=>new u.UpdateFile(e.workspace.repoBaseDir,this.mutationsService,e.sessionId,e.requestId),read_file:e=>new d.ReadFile(e.workspace.repoBaseDir),delete_file:e=>new p.DeleteFile(e.workspace.repoBaseDir),command_line:e=>new f.CommandLine(e.workspace.repoBaseDir,this.summaryCompletion),read_workspace_tree:e=>new h.ReadWorkspaceTree(e.workspace.repoBaseDir),add_workspace:e=>new g.AddWorkspace(this.workspaceService,e.workspace.repoBaseDir),fetch_web_page:()=>new y.FetchWebPage(this.summaryCompletion),read_dependency_source_tree:()=>new m.ReadDependencySourceTree(this.sourceArtefactService),read_dependency_source_file:()=>new w.ReadDependencySourceFile(this.sourceArtefactService),git_commit:e=>new v.GitCommit(e.workspace.repoBaseDir,e.requestId,this.sessionService),git_init:e=>new S.GitInit(e.workspace.repoBaseDir)}}createTools(e,t){return e.map((e=>{const r=this.toolMap[e];if(!r)throw new Error(`Unknown tool: ${e}`);return r(t)}))}allTools(e){return Object.values(this.toolMap).map((t=>t(e)))}};t.ToolFactoryService=R,t.ToolFactoryService=R=o([(0,n.Injectable)(),s("design:paramtypes",[i.MutationsService,a.WorkspaceService,c.SourceArtefactService,l.SessionService,b.SummaryCompletion])],R)},361:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ToolsModule=void 0;const s=r(3563),n=r(6158),i=r(3177),a=r(5873),c=r(3880),l=r(7852),u=r(9161);let d=class{};t.ToolsModule=d,t.ToolsModule=d=o([(0,s.Module)({imports:[i.MutationsModule,a.WorkspaceModule,c.SessionModule,l.SourceArtefactModule,u.ChatCompletionModule],providers:[n.ToolFactoryService],exports:[n.ToolFactoryService]})],d)},2397:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceController=void 0;const i=r(3563),a=r(8474),c=r(6928);let l=class{constructor(e){this.workspaceService=e}async findAll(){return this.workspaceService.findAll()}async findOne(e){return this.workspaceService.findOne(e)}async create(e){return this.workspaceService.createWorkspace({name:e.name||c.basename(e.repoBaseDir),repoBaseDir:e.repoBaseDir})}async update(e,t){return this.workspaceService.updateWorkspace(e,t.buildOrTestCommand)}async remove(e){return this.workspaceService.removeWorkspace(e)}};t.WorkspaceController=l,o([(0,i.Get)(),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",Promise)],l.prototype,"findAll",null),o([(0,i.Get)(":name"),n(0,(0,i.Param)("name")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],l.prototype,"findOne",null),o([(0,i.Post)(),n(0,(0,i.Body)()),s("design:type",Function),s("design:paramtypes",[Object]),s("design:returntype",Promise)],l.prototype,"create",null),o([(0,i.Patch)(":name"),n(0,(0,i.Param)("name")),n(1,(0,i.Body)()),s("design:type",Function),s("design:paramtypes",[String,Object]),s("design:returntype",Promise)],l.prototype,"update",null),o([(0,i.Delete)(":name"),n(0,(0,i.Param)("name")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],l.prototype,"remove",null),t.WorkspaceController=l=o([(0,i.Controller)("workspace"),s("design:paramtypes",[a.WorkspaceService])],l)},5873:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceModule=void 0;const s=r(3563),n=r(2397),i=r(8474),a=r(4717),c=r(376);let l=class{};t.WorkspaceModule=l,t.WorkspaceModule=l=o([(0,s.Module)({imports:[c.DataSourceModule],controllers:[n.WorkspaceController],providers:[i.WorkspaceService,a.WorkspaceRepository],exports:[i.WorkspaceService]})],l)},4717:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t){let r=this.knex("workspaces").select("*");if(t&&(r=r.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:o}=e,s=(t-1)*o;r=r.offset(s).limit(o)}return r}async findByName(e){return this.knex("workspaces").where("name",e).first()}async create(e){await this.knex("workspaces").insert(e)}async update(e,t){await this.knex("workspaces").where("name",e).update(t)}async delete(e){await this.knex("workspaces").where("name",e).delete()}};t.WorkspaceRepository=a,t.WorkspaceRepository=a=o([(0,i.Injectable)(),n(0,(0,i.Inject)("KNEX")),s("design:paramtypes",[Function])],a)},8474:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceService=void 0;const n=r(3563),i=r(4717),a=r(5317),c=r(9023),l=r(9896),u=r(9055),d=(0,c.promisify)(a.exec);let p=class{constructor(e){this.workspaceRepository=e}async updateWorkspace(e,t){const r=await this.workspaceRepository.findByName(e);if(!r)throw new n.NotFoundException(`Workspace with name ${e} not found`);return r.buildOrTestCommand=t,await this.workspaceRepository.update(e,{buildOrTestCommand:t}),u.default.info(`Workspace updated successfully: ${JSON.stringify(r)}`),r}async createWorkspace(e){const{name:t,repoBaseDir:r,isGitRepo:o}=e;if(await this.workspaceRepository.findByName(t))throw new n.BadRequestException("A workspace with the same name already exists");if(!l.existsSync(r)||!l.statSync(r).isDirectory())throw new n.BadRequestException("The specified repository directory does not exist or is not a directory");let s=o??!1;if(!o)try{s=await this.isValidGitRepo(r)}catch(e){u.default.warn(`The specified directory is not a valid git repository: ${e}`)}const i={name:t,repoBaseDir:r,status:"Created",remoteRepoUrl:"",buildOrTestCommand:null,isGitRepo:s};if(s)try{i.remoteRepoUrl=await this.getRemoteRepoUrl(r),await this.getCurrentBranch(r)}catch(e){console.error("Error getting Git information:",e),i.status="Error: Unable to get Git information"}return await this.workspaceRepository.create(i),u.default.info(`Workspace created successfully: ${JSON.stringify(i)}`),i}async findAll(){return this.workspaceRepository.findAll()}async findOne(e){return this.workspaceRepository.findByName(e)}async removeWorkspace(e){if(!await this.workspaceRepository.findByName(e))throw new n.NotFoundException(`Workspace with name ${e} not found`);await this.workspaceRepository.delete(e),u.default.info(`Workspace removed successfully: ${e}`)}async getRemoteRepoUrl(e){const{stdout:t}=await d("git config --get remote.origin.url",{cwd:e});return t.trim()}async getCurrentBranch(e){const{stdout:t}=await d("git rev-parse --abbrev-ref HEAD",{cwd:e});return t.trim()}async isValidGitRepo(e){try{return await d("git rev-parse --is-inside-work-tree",{cwd:e}),!0}catch(e){return!1}}};t.WorkspaceService=p,t.WorkspaceService=p=o([(0,n.Injectable)(),s("design:paramtypes",[i.WorkspaceRepository])],p)},1817:function(e,t,r){"use strict";var o,s=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.PluginLoaderService=void 0;const i=r(3563),a=r(6928),c=r(4652),l=r(9335),u=r(4838),d=r(6158);let p=o=class{constructor(e,t){this.agentCollaborator=e,this.toolFactoryService=t,this.logger=new i.Logger(o.name)}async loadPlugins(){try{const e=process.env.PLUGIN_DIR;if(!e)return this.logger.log("PLUGIN_DIR not set, skipping plugin loading"),[];if(!await c.pathExists(e))return this.logger.warn(`Plugin directory not found: ${e}`),[];const t=await c.readdir(e),o=[];for(const s of t){const t=a.join(e,s,"agent.js");if(await c.pathExists(t))try{const e=r(7216)(t);if(e.prototype instanceof l.BaseAgentService){const t=new e(this.agentCollaborator,this.toolFactoryService);o.push(t),this.logger.log(`Loaded plugin agent: ${s}`)}else this.logger.warn(`Invalid agent in plugin: ${s}`)}catch(e){this.logger.error(`Error loading plugin: ${s}`,e.stack)}}return o}catch(e){return this.logger.error("Error loading plugins: %s",e.message,e.stack),[]}}};t.PluginLoaderService=p,t.PluginLoaderService=p=o=s([(0,i.Injectable)(),n("design:paramtypes",[u.AgentCollaborator,d.ToolFactoryService])],p)},350:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.PluginModule=void 0;const s=r(3563),n=r(1817),i=r(2177),a=r(361),c=r(9354);let l=class{};t.PluginModule=l,t.PluginModule=l=o([(0,s.Module)({imports:[i.AgentsModule,a.ToolsModule,c.BaseAgentModule],providers:[n.PluginLoaderService],exports:[n.PluginLoaderService]})],l)},7216:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=7216,e.exports=t},5996:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddWorkspace=void 0;const o=r(5534),s=r(1569),n=r(9896),i=r(6928),a=r(5317),c=r(9023),l=r(9055),u=(0,c.promisify)(a.exec);class d extends o.Tool{constructor(e,t){super(),this.name="AddWorkspace",this.description="Add a new workspace to the system",this.schema=s.z.object({baseDir:s.z.string().describe("The absolute path to the directory of the workspace (can be a git repo or not)"),name:s.z.string().optional().describe("Optional name of the workspace (no spaces)")}),this.workspaceService=e,this.baseDir=t}async _call({baseDir:e,name:t}){try{if(l.default.info(`Adding workspace with baseDir: ${e}`),!i.isAbsolute(e))throw new Error(`Base directory must be an absolute path: ${e}`);const r=e;if(!n.existsSync(r))throw new Error(`Base directory does not exist: ${r}`);let o=!1;try{await u("git rev-parse --is-inside-work-tree",{cwd:r}),o=!0}catch(e){await u("git init",{cwd:r}),o=!0}const s=t||i.basename(r);return await this.workspaceService.createWorkspace({name:s,repoBaseDir:r,isGitRepo:o}),`Workspace '${s}' ${o?"added":"created and added"} successfully at ${r}`}catch(e){return l.default.error(`Error adding workspace: ${e.message}`,e),`Error adding workspace: ${e.message}`}}}t.AddWorkspace=d},3765:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommandLine=void 0;const o=r(5534),s=r(1569),n=r(5317),i=r(9023),a=r(9055),c=r(6928),l=(0,i.promisify)(n.exec);class u extends o.Tool{constructor(e,t){super(),this.name="command_line",this.description="Execute a command line instruction in the workspace directory or a subdirectory",this.schema=s.z.object({command:s.z.string().describe("The command to execute"),subDir:s.z.string().optional().describe("Optional subdirectory relative to the workspace root to execute the command in")}),this.workspaceRootDir=e,this.maxOutputChars=parseInt(process.env.MAX_TOOL_OUTPUT_CHARS||"2000",10),this.summaryCompletion=t}async summariseOutput(e,t){const r="Stdout:\n"+e+"\nStderr:\n"+t;if(r.length>this.maxOutputChars){if(this.summaryCompletion){const e=await this.summaryCompletion.getSummary(r);return a.default.info(`Summarised large command output - reduced ${r.length} chars to ${e.length}`),e}{const o=this.clipString(e),s=this.clipString(t);return`Summarised large command output - reduced ${r.length} chars to ${o.length+s.length}:\n${o}\n${s}`}}return r}clipString(e){return e.length>this.maxOutputChars?e.slice(-this.maxOutputChars):e}async _call({command:e,subDir:t}){try{const r=t?c.default.join(this.workspaceRootDir,t):this.workspaceRootDir;a.default.info(`Executing command: ${e} in directory: ${r}`);const{stdout:o,stderr:s}=await l(e,{cwd:r});return`Executed Command:\n${e}\nWorking Directory: ${r}\nOutput:\n${await this.summariseOutput(o,s)}`}catch(t){a.default.warn(`Error executing command: ${e}`,t),a.default.warn(`Error stdout: ${t.stdout}`),a.default.warn(`Error stderr: ${t.stderr}`);const r=t.stdout||"",o=t.stderr||"";return`Executed Command:\n${e}\nOutput:\n${await this.summariseOutput(r,o)}\nError:\n${this.clipString(t.message)}`}}}t.CommandLine=u},7465:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteFile=void 0;const o=r(5534),s=r(1569),n=r(9896),i=r(6928),a=r(9055);class c extends o.Tool{constructor(e){super(),this.name="delete_file",this.description="Delete a file from the workspace",this.schema=s.z.object({filePath:s.z.string().describe("The relative path of the file to delete")}),this.workspaceRootDir=e}async _call(e){return this.deleteFile(e.filePath)}deleteFile(e){const t=i.join(this.workspaceRootDir,e);try{return n.existsSync(t)?(a.default.info(`Deleting file: ${e}`),n.unlinkSync(t),`Successfully deleted file: ${e}`):`Error: File not found - ${e}`}catch(e){return`Error deleting file: ${e.message}`}}}t.DeleteFile=c},1781:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var s,n=arguments.length,i=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(n<3?s(i):n>3?s(t,r,i):s(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FetchWebPage=void 0;const i=r(5534),a=r(1569),c=r(8938),l=r(9055),u=r(3563),d=r(3239);let p=class extends i.Tool{constructor(e){super(),this.summaryCompletion=e,this.name="fetch_web_page",this.description="Fetch the HTML source of a web page. This tool should only be used if the user has specifically asked for a web page by URL.",this.schema=a.z.object({url:a.z.string().url().describe("The URL of the web page to fetch")}),this.warningThreshold=2e3}async _call({url:e}){try{l.default.info(`Fetching web page: ${e}`);const t=(await c.default.get(e)).data;if(t.length>this.warningThreshold){l.default.warn(`Large HTML content detected (${t.length} characters) for URL: ${e}`);const r=`Please summarise the contents of the web url: ${e} so that we get all the useful information from the page: ${t}`;return`Fetched and summarized HTML from URL: ${e}\nSummary:\n${await this.summaryCompletion.getSummary(r)}`}return`Fetched HTML from URL: ${e}\nHTML Content:\n${t}`}catch(t){l.default.error(`Error fetching web page: ${e}`,t);return`Error fetching web page: ${e}\nError:\n${t.message||"Unknown error occurred"}`}}};t.FetchWebPage=p,t.FetchWebPage=p=o([n(0,(0,u.Inject)(d.SummaryCompletion)),s("design:paramtypes",[d.SummaryCompletion])],p)},4911:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitCommit=void 0;const o=r(7773),s=r(9896),n=r(6928),i=r(9055),a=r(5317),c=r(9023),l=r(857),u=(0,c.promisify)(a.exec);class d extends o.Tool{constructor(e,t,r){super(),this.repoBaseDir=e,this.requestId=t,this.sessionService=r,this.name="git_commit",this.description="Commits changes to the git repository"}async parseGitDiffOutput(e){const t=e.match(/(\d+) files? changed(?:, (\d+) insertions?\(\+\))?(?:, (\d+) deletions?\(-\))?/),r=t&&t[2]?parseInt(t[2]):0,o=t&&t[3]?parseInt(t[3]):0;return{filesChanged:t?parseInt(t[1]):0,insertions:r,deletions:o,linesChanged:Math.max(r,o)}}async getGitStats(){await u("git add -A",{cwd:this.repoBaseDir});const{stdout:e}=await u("git diff --cached --shortstat",{cwd:this.repoBaseDir});let t="";if("win32"===l.platform()){const{stdout:e}=await u("git diff --cached --name-only",{cwd:this.repoBaseDir}),r=e.split("\n").filter((e=>e.includes("test")));if(r.length>0){const e=r.join(" "),{stdout:o}=await u(`git diff --cached --shortstat ${e}`,{cwd:this.repoBaseDir});t=o}}else{const{stdout:e}=await u('git diff --cached --name-only | grep "test" | xargs git diff --cached --shortstat',{cwd:this.repoBaseDir});t=e}return{allFiles:await this.parseGitDiffOutput(e),testFiles:await this.parseGitDiffOutput(t)}}async storeRequestSpecJsonFile(e){const t=await this.sessionService.getRequest(this.requestId);if(!t||!t.requestContent)return void i.default.warn(`Unable to store request content for requestId: ${this.requestId}`);if(!await this.sessionService.getSession(t.sessionId))return void i.default.warn(`Session not found for requestId: ${this.requestId}`);if("false"===process.env.STORE_SPECS_IN_WORKSPACE)return;const r=new Date,o=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}`,a=n.join(this.repoBaseDir,".hldk","specs",o);s.mkdirSync(a,{recursive:!0});const c=await this.sessionService.getRequestStats(this.requestId),l=c.cost,u=await this.getGitStats(),d=Date.now()-new Date(t.startedAt).getTime(),p={spec:t.requestContent,commitMessage:e,stats:{...c,cost:l,currency:"gbp",processingMillis:d,git:{...u.allFiles,testFilesChanged:u.testFiles.filesChanged,testInsertions:u.testFiles.insertions,testDeletions:u.testFiles.deletions,linesChanged:u.allFiles.linesChanged,testLinesChanged:u.testFiles.linesChanged}}},f=n.join(a,`${this.requestId}.json`);s.writeFileSync(f,JSON.stringify(p,null,2)),await this.sessionService.updateGitStats(this.requestId,{...u.allFiles,testFilesChanged:u.testFiles.filesChanged,testInsertions:u.testFiles.insertions,testDeletions:u.testFiles.deletions,linesChanged:u.allFiles.linesChanged,testLinesChanged:u.testFiles.linesChanged})}async _call(e){try{return await this.storeRequestSpecJsonFile(e),i.default.info(`Committing changes to git with message: ${e}`),await u(`git add -A && git commit -am "${e}"`,{cwd:this.repoBaseDir}),`Successfully committed changes with message: ${e}`}catch(e){return i.default.error("Error in GitCommit tool:",e),`Failed to commit changes: ${e.message}`}}}t.GitCommit=d},3716:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitInit=void 0;const o=r(5534),s=r(1569),n=r(5317),i=r(9023),a=r(9055),c=r(6928),l=r(9896),u=(0,i.promisify)(n.exec);class d extends o.Tool{constructor(e){super(),this.name="git_init",this.description="Initialize a git repository in the specified directory if it's not already a git repository",this.schema=s.z.object({folder:s.z.string().describe("The folder relative to the workspace root to initialize as a git repository")}),this.workspaceRootDir=e,this.maxOutputChars=parseInt(process.env.MAX_TOOL_OUTPUT_CHARS||"2000",10)}clipOutput(e){return e.length>this.maxOutputChars?`Large output detected so clipped to last ${this.maxOutputChars} chars...\n${e.slice(-this.maxOutputChars)}`:e}async _call({folder:e}){try{a.default.info(`Initializing git repository in ${e} under workspace ${this.workspaceRootDir}`);const t=c.join(this.workspaceRootDir,e);if(!l.existsSync(t))return`Error: The directory ${t} does not exist.`;const r=c.join(t,".git");if(l.existsSync(r))return`The directory ${t} is already a git repository.`;const{stdout:o,stderr:s}=await u("git init",{cwd:t}),n=this.clipOutput(o);return`Executed Command: git init\nWorking Directory: ${t}\nOutput:\n${n}${this.clipOutput(s)}`}catch(e){a.default.warn(`Error initializing git repository: ${e.message}`,e),a.default.warn(`Error stdout: ${e.stdout}`),a.default.warn(`Error stderr: ${e.stderr}`);const t=e.stdout||"",r=e.stderr||"";return`Error initializing git repository:\nOutput:\n${this.clipOutput(t)}${this.clipOutput(r)}\nError:\n${this.clipOutput(e.message)}`}}}t.GitInit=d},2626:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadDependencySourceFile=void 0;const o=r(5534),s=r(1569);class n extends o.Tool{constructor(e){super(),this.name="read_dependency_source_file",this.description='Read the content of a specific source file from a dependency, using the package manager scheme (e.g. "maven"), locator (e.g. "com.example:example:1.0.0"), and file path.\n  Currently only maven is supported so the scheme is always "maven" and the locator is always a Maven GAV tuple (group:artifact:version).\n  If no repository URLs are provided then the default Maven central repository will be used.\n  The file path should be relative to the root of the source directory, e.g., "com/foo/Bar.java".\n  If the file is not found, it will check for alternative extensions (e.g., .kt for Kotlin).\n  ',this.schema=s.z.object({input:s.z.string().describe("A JSON string containing packageManagerScheme, locator, filePath, and optional repositoryUrls")}),this.sourceArtefactService=e}async _call(e){const{packageManagerScheme:t,locator:r,filePath:o,repositoryUrls:s}=JSON.parse(e.input);if(!t||!r||!o)return"Error: Missing required parameters. Please provide packageManagerScheme, locator, and filePath.";try{return await this.sourceArtefactService.readArtefactSourceFile(t,r,o,s)}catch(e){return`Error: Unable to read dependency source file. ${e instanceof Error?e.message:"Unknown error occurred"}`}}}t.ReadDependencySourceFile=n},7600:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadDependencySourceTree=void 0;const o=r(5534),s=r(1569);class n extends o.Tool{constructor(e){super(),this.name="read_dependency_source_tree",this.description='Read the source tree hierarchy (directories and file names only) of a dependency, using the package manager scheme (e.g. "maven") and locator (e.g. "com.example:example:1.0.0"). \n  Use this tool if you need to know more about how to use a specific dependency.\n  Look in the build file (e.g. pom.xml or build.gradle) or package metadata (e.g. package.json) and then use that to build the correct scheme and locator.\n  Currently only maven is supported so the scheme is always "maven" and the locator is always a Maven GAV tuple (group:artifact:version).\n  If no repository URLs are provided then the default Maven central repository will be used.\n  ',this.schema=s.z.object({input:s.z.string().describe("A JSON string containing packageManagerScheme, locator, and optional repositoryUrls")}),this.sourceArtefactService=e}async _call(e){const{packageManagerScheme:t,locator:r,repositoryUrls:o}=JSON.parse(e.input);try{return await this.sourceArtefactService.readArtefactSourceTree(t,r,o)}catch(e){return`Error: Unable to read dependency source tree. ${e instanceof Error?e.message:"Unknown error occurred"}`}}}t.ReadDependencySourceTree=n},4970:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadFile=void 0;const o=r(5534),s=r(1569),n=r(9896),i=r(6928),a=r(9055);class c extends o.Tool{constructor(e){super(),this.name="read_file",this.description="Read the content of a file in the workspace",this.schema=s.z.object({filePath:s.z.string().describe("The relative path of the file to read")}),this.workspaceRootDir=e}async _call(e){return this.readFile(e.filePath)}readFile(e){a.default.info(`ReadFile.readFile called with: ${e}`);const t=i.join(this.workspaceRootDir,e);try{return n.readFileSync(t,"utf-8")}catch(t){return"ENOENT"===t.code?`Error: File not found - ${e}`:`Error reading file: ${t.message}`}}}t.ReadFile=c},5515:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadWorkspaceTree=void 0;const o=r(5534),s=r(1569),n=r(6426);class i extends o.Tool{constructor(e){super(),this.name="read_workspace_tree",this.description="Read the workspace file tree, respecting .gitignore and .aiderignore files",this.schema=s.z.object({}),this.workspaceRootDir=e}async _call(){return(0,n.generateTree)(this.workspaceRootDir)}}t.ReadWorkspaceTree=i},3923:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFile=void 0;const o=r(5534),s=r(1569),n=r(9896),i=r(6928),a=r(9055);class c extends o.Tool{constructor(e,t,r,o){super(),this.name="update_file",this.description="Update the content of a file in the workspace by providing the path of the file to update, the text block to search for in the file content, and the text block to replace the search block with. All 3 arguments are required: filePath, search, and replace.",this.schema=s.z.object({filePath:s.z.string().describe("The relative path of the file to update"),search:s.z.string().describe("The text block to search for in the file content"),replace:s.z.string().describe("The text block to replace the search block with - DO NOT FORGET TO INCLUDE THIS!!!")}),this.workspaceRootDir=e,this.mutationsService=t,this.sessionId=r,this.requestId=o}async _call(e){return this.updateFile(e.filePath,e.search,e.replace)}async updateFile(e,t,r){a.default.debug("UpdateFile.updateFile called with: %s\n>>>>> SEARCH\n%s\n-------\n%s<<<<< REPLACE\n",e,t,r);const o=i.join(this.workspaceRootDir,e);try{let s,c,l=!1;if(n.existsSync(o)||t&&""!==t){s=n.readFileSync(o,"utf-8");const i=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&").replace(/\r\n|\n/g,"(?:\\r\\n|\\n)"),l=new RegExp(i,"g").exec(s);if(!l)return a.default.warn("UpdateFile.updateFile failed to find the search block in the file content."),a.default.warn("Search block was:\n%s",t),a.default.warn("Full file content was:\n%s",s),"Error: failed to find search block in file content.";const u=l.index,d=l[0].length;c=s.slice(0,u)+r+s.slice(u+d),a.default.info(`Updating file: ${e}`),n.writeFileSync(o,c,"utf-8")}else{const e=i.dirname(o);n.mkdirSync(e,{recursive:!0}),n.writeFileSync(o,r,"utf-8"),s="",c=r,l=!0}return"Success"}catch(e){return a.default.error("UpdateFile.updateFile encountered an error:",e),`Error: ${e.message}`}}}t.UpdateFile=c},8884:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEnv=function(e,t){let r;"undefined"!=typeof process&&process.env?r=process.env[e]:"undefined"!=typeof globalThis&&"Deno"in globalThis?r=globalThis.Deno.env.get(e):console.warn(`Unable to access environment variables. Key: ${e}`);return void 0!==r?r:t}},9055:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(5124),s=r(9896),n=r(6928),i=r(8884),a=r(9233),c=n.join(process.cwd(),"logs");s.existsSync(c)||s.mkdirSync(c,{recursive:!0});const l=n.join(c,"hldk-server-%DATE%.log"),u=(0,i.getEnv)("LOG_FILE_PATH",l);console.log(`Log file pattern: ${u}`);const d=new a({filename:u,datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"20m",maxFiles:"14d",level:"debug"}),p=o.format.printf((({level:e,message:t,timestamp:r})=>{const o=new Date(r);return`${`${(o.getMonth()+1).toString().padStart(2,"0")}/${o.getDate().toString().padStart(2,"0")}/${o.getFullYear()}, ${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}:${o.getSeconds().toString().padStart(2,"0")} ${o.getHours()>=12?"PM":"AM"}`} - ${e.toUpperCase()}: ${t}`})),f=o.createLogger({level:"debug",format:o.format.combine(o.format.splat(),o.format.timestamp(),p),transports:[new o.transports.Console({level:"info"}),d]});t.default=f},6426:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateTree=function(e,t=[]){if(!o.existsSync(e)||!o.statSync(e).isDirectory())return`Error: ${e} is not a valid directory.`;const r=function(e,t){const r=(0,n.default)();r.add([".git",".hldk",...t]);return[".gitignore",".aiderignore",".hldkignore"].forEach((t=>{const n=s.join(e,t);if(o.existsSync(n)){const e=o.readFileSync(n,"utf-8");r.add(e)}})),r}(e,t),a=i(e,r,e);return`File tree for ${e}:\n.\n${a}`};const o=r(9896),s=r(6928),n=r(526);function i(e,t,r,n=""){let a=[];const c=o.readdirSync(e).sort();return c.forEach(((l,u)=>{const d=s.join(e,l),p=s.relative(r,d);if(t.ignores(p))return;const f=u===c.length-1;a.push(`${n}${f?"└── ":"├── "}${l}`),o.statSync(d).isDirectory()&&a.push(i(d,t,r,n+(f?"    ":"│   ")))})),a.join("\n")}},646:e=>{"use strict";e.exports=require("@langchain/anthropic")},1486:e=>{"use strict";e.exports=require("@langchain/core/messages")},724:e=>{"use strict";e.exports=require("@langchain/core/output_parsers")},5534:e=>{"use strict";e.exports=require("@langchain/core/tools")},1463:e=>{"use strict";e.exports=require("@langchain/groq")},9314:e=>{"use strict";e.exports=require("@langchain/langgraph")},8804:e=>{"use strict";e.exports=require("@langchain/langgraph/prebuilt")},3548:e=>{"use strict";e.exports=require("@langchain/ollama")},6228:e=>{"use strict";e.exports=require("@langchain/openai")},3563:e=>{"use strict";e.exports=require("@nestjs/common")},8781:e=>{"use strict";e.exports=require("@nestjs/core")},9556:e=>{"use strict";e.exports=require("@nestjs/platform-express")},2810:e=>{"use strict";e.exports=require("@nestjs/serve-static")},4650:e=>{"use strict";e.exports=require("adm-zip")},8938:e=>{"use strict";e.exports=require("axios")},818:e=>{"use strict";e.exports=require("dotenv")},7252:e=>{"use strict";e.exports=require("express")},4652:e=>{"use strict";e.exports=require("fs-extra")},526:e=>{"use strict";e.exports=require("ignore")},1832:e=>{"use strict";e.exports=require("knex")},7773:e=>{"use strict";e.exports=require("langchain/tools")},8461:e=>{"use strict";e.exports=require("multer")},1321:e=>{"use strict";e.exports=require("reflect-metadata")},573:e=>{"use strict";e.exports=require("rxjs")},9100:e=>{"use strict";e.exports=require("ulid")},3903:e=>{"use strict";e.exports=require("uuid")},5124:e=>{"use strict";e.exports=require("winston")},9233:e=>{"use strict";e.exports=require("winston-daily-rotate-file")},1569:e=>{"use strict";e.exports=require("zod")},5317:e=>{"use strict";e.exports=require("child_process")},4434:e=>{"use strict";e.exports=require("events")},9896:e=>{"use strict";e.exports=require("fs")},1943:e=>{"use strict";e.exports=require("fs/promises")},857:e=>{"use strict";e.exports=require("os")},6928:e=>{"use strict";e.exports=require("path")},9023:e=>{"use strict";e.exports=require("util")}},t={};function r(o){var s=t[o];if(void 0!==s)return s.exports;var n=t[o]={exports:{}};return e[o].call(n.exports,n,n.exports,r),n.exports}r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);(()=>{"use strict";r(1321);const e=r(818),t=r(6928),o=r(8781),s=r(715),n=r(7252),i=r(6928),a=r(9055),c=r(9187);(0,e.config)({path:(0,t.resolve)(__dirname,"../.env")}),async function(){(0,c.getDefaultKnexConfig)();const e=await o.NestFactory.create(s.AppModule);e.setGlobalPrefix("api"),e.enableCors({origin:["http://localhost:3011","http://localhost:3012","http://localhost:3013","http://localhost:3014"],methods:["GET","POST","PUT","PATCH","DELETE","OPTIONS"],allowedHeaders:"*",exposedHeaders:["Location"]}),e.use(n.static((0,i.join)(__dirname,"webui"))),e.use("*",((e,t,r)=>{e.originalUrl.startsWith("/api")?r():t.sendFile((0,i.join)(__dirname,"webui","index.html"))}));const t=process.env.PORT||3010;await e.listen(t);const r=`http://localhost:${t}`;console.log(`\nhldk-server is now available at: ${r}`);const l=["SIGTERM","SIGINT"];for(const t of l)process.on(t,(async()=>{a.default.info(`Received ${t}. Starting graceful shutdown...`),await e.close(),a.default.info("Application shut down gracefully"),process.exit(0)}))}().catch((e=>{a.default.error("Error during application bootstrap:",e),process.exit(1)}))})()})();