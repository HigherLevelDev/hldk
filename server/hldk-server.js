(()=>{var __webpack_modules__={2003:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AgentConfig=void 0;t.AgentConfig=class{constructor(e,t=0,r,o=!0,n){this.model=e,this.temperature=t,this.recursionLimit=r,this.cachePrompt=o,this.privateModelsRequired=n}}},1412:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AgentRequest=void 0;const o=r(2003),n=r(9100);class s{constructor(e,t,r,n=new o.AgentConfig,i){this.sender=e,this.content=t,this.sessionId=r,this.config=n,this.workspaceName=i,this.sessionId=r||s.generateRandomSessionId()}static fromJSON(e){const{sender:t,content:r,sessionId:n,config:i,workspaceName:a,agent:c}=e;if(!r)throw new Error("Missing required field 'content'");const l=i?Object.assign(new o.AgentConfig,i):new o.AgentConfig,d=n||s.generateRandomSessionId();return new s(t,r,d,l,a)}static generateRandomSessionId(){return(0,n.ulid)()}static getFirstTextContent(e){if("string"==typeof e)return e;if(!Array.isArray(e))throw new Error("Invalid content type");{const t=e[0];if("text"===t.type)return t.text||""}}}t.AgentRequest=s},9234:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestContext=void 0;const o=r(6426),n=r(9896),s=r(6928);class i{constructor(e,t,r){this.workspace=e,this.requestId=t,this.sessionId=r}portFromSourceTree(){if(this.workspace.portFromBaseDir)return(0,o.generateAdaptiveTree)(this.workspace.portFromBaseDir)}repositoryTree(){return(0,o.generateAdaptiveTree)(this.workspace.repoBaseDir)}repositoryHints(){const e=s.join(this.workspace.repoBaseDir,"hints.md");if(n.existsSync(e))return n.readFileSync(e,"utf-8")}productHints(){const e=s.join(this.workspace.repoBaseDir,"product-hints.md");if(n.existsSync(e))return n.readFileSync(e,"utf-8")}}t.RequestContext=i,i.TREE_SIZE_WARNING_THRESHOLD=1e5},7249:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StandardAgentStateManager=void 0;const o=r(9314),n=r(8804);t.StandardAgentStateManager=class{static createGraphState(){return{messages:{reducer:(e,t)=>e.concat(t)}}}static shouldContinue(e){const t=e.messages,r=t[t.length-1];return r.tool_calls?.length?"tools":"__end__"}static createWorkflow(e,t){const r=this.createGraphState(),s=new n.ToolNode(t);return new o.StateGraph({channels:r}).addNode("agent",(async t=>await e(t))).addNode("tools",s).addEdge("__start__","agent").addConditionalEdges("agent",this.shouldContinue).addEdge("tools","agent")}}},5862:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AgentRule=void 0;t.AgentRule=class{constructor(e,t,r,o){this.agentName=e,this.content=t,this.createdAt=r,this.updatedAt=o}}},5025:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentRuleRepository=void 0;const i=r(3563),a=(r(1832),r(9055));let c=class{constructor(e){this.knex=e}async findByAgentName(e){return this.knex("rules").where("agentName",e).first()}async upsert(e){const t=(new Date).toISOString();try{await this.knex("rules").insert({agentName:e.agentName,content:e.content,createdAt:t,updatedAt:t}).onConflict("agentName").merge({content:e.content,updatedAt:t})}catch(t){throw a.default.error("Failed to upsert rule:",{error:t.message,stack:t.stack,rule:e}),t}}};t.AgentRuleRepository=c,t.AgentRuleRepository=c=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],c)},3470:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentRuleService=void 0;const s=r(3563),i=r(5025),a=r(5862);let c=class{constructor(e){this.ruleRepository=e}async getRulesByAgentName(e){const t=await this.ruleRepository.findByAgentName(e);return t||new a.AgentRule(e,"",new Date,new Date)}async upsertRule(e,t){const r=new a.AgentRule(e,t,new Date,new Date);await this.ruleRepository.upsert(r)}};t.AgentRuleService=c,t.AgentRuleService=c=o([(0,s.Injectable)(),n("design:paramtypes",[i.AgentRuleRepository])],c)},3520:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentController=void 0;const a=r(3563),c=r(1412),l=r(3470),d=r(9055);let u=o=class{constructor(e,t){this.agentServices=e,this.agentRuleService=t,this.logger=new a.Logger(o.name)}getAgentService(e){const t=this.agentServices.get(e);if(!t)throw new Error(`Unknown agent: ${e}`);return t}async processRequestWithStream(e,t,r){try{const o=c.AgentRequest.fromJSON(t);r.setHeader("Content-Type","text/event-stream"),r.setHeader("Cache-Control","no-cache"),r.setHeader("Connection","keep-alive"),r.setHeader("Location",`/sessions/${o.sessionId}/stream`);for await(const t of this.getAgentService(e).processRequestStream(o))r.write(`data: ${JSON.stringify(t)}\n\n`);r.end()}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),r.setHeader("Content-Type","application/json"),r.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}async processRequestNoStream(e,t,r){try{const o=c.AgentRequest.fromJSON(t),n=await this.getAgentService(e).processRequest(o);d.default.info("Returning result: %s",JSON.stringify(n)),r.setHeader("Content-Type","application/json"),r.json(n)}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),r.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}async processRequestAndGetContent(e,t,r){try{const o=c.AgentRequest.fromJSON(t);let n=(await this.getAgentService(e).processRequest(o)).responseContent.trim();d.default.info("Raw result: %s",n);const s=r.req.headers.accept;if(s&&s.includes("application/json"))try{const e=n.match(/\{[\s\S]*\}/);if(e){const t=JSON.parse(e[0]);return n=t,d.default.info("Extracted JSON content: %s",JSON.stringify(t)),r.setHeader("Content-Type","application/json"),void r.json(t)}}catch(e){d.default.warn("Failed to extract JSON from response content: %s",e.message)}r.setHeader("Content-Type","text/plain"),r.send(n)}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),r.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}async getRules(e){return this.agentRuleService.getRulesByAgentName(e)}async updateRules(e,t){return await this.agentRuleService.upsertRule(e,t.content),{success:!0}}};t.AgentController=u,n([(0,a.Post)(":name/stream"),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),i(2,(0,a.Res)()),s("design:type",Function),s("design:paramtypes",[String,String,Object]),s("design:returntype",Promise)],u.prototype,"processRequestWithStream",null),n([(0,a.Post)(":name"),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),i(2,(0,a.Res)()),s("design:type",Function),s("design:paramtypes",[String,String,Object]),s("design:returntype",Promise)],u.prototype,"processRequestNoStream",null),n([(0,a.Post)(":name/responseContent"),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),i(2,(0,a.Res)()),s("design:type",Function),s("design:paramtypes",[String,String,Object]),s("design:returntype",Promise)],u.prototype,"processRequestAndGetContent",null),n([(0,a.Get)(":name/rules"),i(0,(0,a.Param)("name")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],u.prototype,"getRules",null),n([(0,a.Put)(":name/rules"),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),s("design:type",Function),s("design:paramtypes",[String,Object]),s("design:returntype",Promise)],u.prototype,"updateRules",null),t.AgentController=u=o=n([(0,a.Controller)("agents"),i(0,(0,a.Inject)("AGENT_SERVICES")),s("design:paramtypes",[Map,l.AgentRuleService])],u)},2177:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentsModule=void 0;const n=r(3563),s=r(3520),i=r(9449),a=r(5017),c=r(3887),l=r(5610),d=r(6695),u=r(2424),p=r(361),f=r(7307),h=r(3690),m=r(8471),g=r(3470),y=r(5025),w=r(7223),S=r(1263),v=r(5873),_=r(3880),R=r(4193),b=r(9161),A=r(376),E={provide:"AGENT_SERVICES",useFactory:async(e,t,r,o,n,s,i,a)=>{const c=new Map;c.set("se-agent",e),c.set("ops-agent",t),c.set("review-agent",r),c.set("computer-use-agent",o),c.set("private-coder-agent",n),c.set("architect-agent",s),c.set("product-agent",i);return(await a.loadPlugins()).forEach((e=>{e&&e.getName&&c.set(e.getName(),e)})),c},inject:[a.SEAgentService,c.OpsAgentService,l.ReviewAgentService,d.ComputerUseAgentService,m.PrivateCoderAgentService,w.ArchitectAgentService,S.ProductAgentService,f.PluginLoaderService]};let T=class{};t.AgentsModule=T,t.AgentsModule=T=o([(0,n.Module)({imports:[u.GraphAgentModule,p.ToolsModule,h.SimpleAgentModule,v.WorkspaceModule,_.SessionModule,R.HomeModule,b.ChatCompletionModule,i.LangchainModule,A.DataSourceModule],controllers:[s.AgentController],providers:[a.SEAgentService,c.OpsAgentService,l.ReviewAgentService,d.ComputerUseAgentService,m.PrivateCoderAgentService,w.ArchitectAgentService,S.ProductAgentService,f.PluginLoaderService,g.AgentRuleService,y.AgentRuleRepository,E],exports:[E,g.AgentRuleService]})],T)},7223:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ArchitectAgentService=void 0;const i=r(3563),a=r(3470),c=r(6158),l=r(9055),d=r(2300),u=r(5277),p=r(8921);let f=class extends u.GraphAgentService{constructor(e,t,r){super(e,t,r),this.agentCollaborator=e,this.toolFactoryService=t,this.ruleService=r}getName(){return"architect-agent"}async getTools(e){const t=["read_file","update_file","delete_file","fetch_web_page","current_timestamp","grep","find_files"];return e.workspace.portFromBaseDir&&t.push("read_port_from_file"),this.toolFactoryService.createTools(t,e)}async getSystemPrompt(e){let t=`As an expert AI Software Architect, your primary role is to analyze requirements and break them down into well-defined, implementable tasks. Your main responsibilities vary based on the type of request:\n\n1. STORY TASK BREAKDOWN (Primary Role):\n   When breaking down an existing story into tasks:\n   \n   a) First analyze the context:\n      - Read the epic's requirements.md for high-level context\n      - Study the story.json to understand specific acceptance criteria\n      - Research the existing codebase using the repository file tree defined below and the read_file to understand current implementation\n      - Read the hints.md and README.md files to understand the tech stack and any other relevant information\n      - Read any other files that seem at all relevant to the task or to see examples of how things are done\n      - Use the read_file tool to read examples of existing code that might be relevant to the task\n      - Do not make assumptions about the codebase, always use the read_file tool to understand the existing code before designing new code\n   \n   b) Create tasks that:\n      - Fulfill all acceptance criteria\n      - Include basic happy path end-to-end tests\n      - Are sized for one atomic commit (3-4 files max)\n      - Are ordered logically for implementation\n      - If possible, include both the backend and frontend code changes in the same task so they can immediately be tested together\n      - Prefer lots of small tasks over fewer larger tasks\n   \n   c) For each task provide:\n      - Clear, descriptive title\n      - List of files to be created and the files to be modified\n      - For each file, describe the changes needed with pseudo code or code snippets if applicable\n      - Define entity/dto properties if applicable\n      - Show the code for DB table creation/updates if applicable\n      - Dependencies on other tasks\n      - Basic testing requirements which should include a happy path end to end test (no mocking/fixtures)\n      - List which acceptance criteria the task fulfills\n      - Status "backlog"\n      - Assignee "se-agent"\n\n2. EPIC/STORY PLANNING:\n   When asked to create a plan for something (and no specific EPIC is mentioned):\n   \n   a) Create a new epic with:\n      - Clear requirements.md file (this can be technical in nature rather than business requirements)\n      - 1-2 initial stories\n   \n   b) STOP and present the plan to user and wait for approval before breaking down the first story\n   \n   c) Only proceed with task breakdown after user approval\n\n3. FIRST EPIC SETUP:\n   When breaking down the first epic/stories in a project (e.g. EPIC-01):\n   \n   a) First task should be either:\n      - Scaffolding: Ask user for tech stack or propose a tech stack and ask user to confirm\n      OR\n      - Rebranding: If template exists:\n        * Update all wording/readmes\n        * Disable/hide template features if needed\n        * Include startup instructions for SE agent to show user\n   \n   b) Second task should implement first actual requirement\n   \n   c) Ensure proper tech stack is defined:\n      - Check hints.md and codebase for existing choices\n      - If none found, propose stack to user and wait for confirmation\n      - Update hints.md with confirmed stack\n\n4. REFACTORING PLANS:\n   When asked to create a refactoring plan:\n   \n   a) Test Coverage:\n      - Assess existing test coverage and add and missing happy path tests for important behaviors\n      - Create test story first if needed to add tests\n      - Plan for test updates/temporary disabling tests if needed\n   \n   b) Analysis & Principles:\n      - Identify complexity, duplication, coupling, large files, etc.\n      - Follow SOLID principles\n      - Keep changes independently deployable\n      - Maintain backward compatibility during the refactoring\n   \n   c) Task Structure:\n      1. Setup (tests, infrastructure)\n      2. Extraction (new files, minimal changes, bit by bit etc)\n      3. Updates (client code, dependencies)\n      4. Cleanup (remove old code, re-enable tests)\n\n${await p.EpicsPrompts.allEpicInstructions(e)}\n\nHere is the file tree of the system:\n${e.repositoryTree()}\n\n${e.repositoryHints()?`Additional hints:\n${e.repositoryHints()}`:""}\n\nIMPORTANT GUIDELINES:\n- If there is no tech stack defined yet in the repository, then propose a tech stack and STOP AND ASK USER TO CONFIRM if that technology stack is okay\n- Always use read_file to examine code before referencing it\n- Tasks should be small (single commit) but complete (testable)\n- Every acceptance criterion must have a task\n- Use current_timestamp for timestamps\n- Order tasks logically\n- You create tasks/stories only - no direct code edits unless specifically asked to do so\n- When creating first epic, focus on proper setup/scaffolding\n- Always stop and present plan to user before detailed breakdown\n\nWhat follows may be more specific instructions which should be followed in preference to the general instructions above...\n`;return l.default.debug(`Architect Agent system prompt for workspace '${e.workspace.name}' (length: ${t.length} chars): ${t}`),t}};t.ArchitectAgentService=f,t.ArchitectAgentService=f=o([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>d.GraphAgentCollaborator)))),n("design:paramtypes",[d.GraphAgentCollaborator,c.ToolFactoryService,a.AgentRuleService])],f)},2300:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.GraphAgentCollaborator=void 0;const s=r(3563),i=r(7373),a=r(1e3),c=r(1412),l=r(1544),d=r(1486),u=r(9055),p=r(6254),f=r(9100),h=r(9234),m=r(8474),g=r(6910),y=r(2368),w=r(538),S=r(3239),v=r(4911);let _=class{constructor(e,t,r,o,n){this.workspaceService=e,this.sessionService=t,this.checkpointerService=r,this.homeService=o,this.summaryCompletion=n,this.chatModelManager=l.ChatModelManager.getInstance()}async processRequest(e,t){u.default.info("Processing request: %s",JSON.stringify(t));const r=this.processRequestStream(e,t);let o=null;for await(const e of r)o=e,u.default.info("Yielded item: %s",JSON.stringify(e));if(!o)throw new Error("No items were yielded from the generator");const n=await this.sessionService.getRequest(o?.requestId);if(!n)throw new Error("Failed to retrieve persisted request");return u.default.info("Returning request: %s",JSON.stringify(n)),n}async*processRequestStream(e,t){const r=(0,f.ulid)();if(!await this.homeService.isAccessOkay()){const e={label:"Error",content:"Access is not valid. Please check your HLDK API key and try again."},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId||this.generateSessionId(),label:e.label,content:e.content,createdAt:new Date,requestId:r});return void(yield o)}const o=new Date;t.sessionId||(t.sessionId=this.generateSessionId());const n=await this.chatModelManager.getModel(t.config,e.getModelCategory(),e.isPrivateModelsOnly());let s;t.workspaceName?s=await this.workspaceService.lockByName(t.workspaceName):(s=await this.workspaceService.lockSessionWorkspace(t.sessionId),t.workspaceName=s.name);const i=s.name,a=new h.RequestContext(s,r,t.sessionId);await e.verifyRequest(t,a);let l=!1,m=0,w=0,S=0,_=0,R="";try{const s=c.AgentRequest.getFirstTextContent(t.content),i=await this.sessionService.ensureSession(t.workspaceName,t.sessionId,s,e.getName());await this.sessionService.updateSessionStatus(i.sessionId,"active"),u.default.info("%s received request: %s - %s",e.getName(),r,JSON.stringify(t)),u.default.info("Using model: %s",n.modelDescriptor.getFullName());const f=await e.getTools(a),h=n.baseChatModel.bindTools(f);let v=await e.getSystemPrompt(a);const A=await e.getAgentRules();A&&(v=v+"\n\nAdditional system rules:\n"+A),u.default.info("System prompt length: %s",v.length);const E=y.ConfigService.getNumericProperty(g.ConfigPropNames.AGENT_SYSTEM_PROMPT)||5e4;if(v.length>E)throw u.default.error("System prompt is longer than the maximum allowed length of %s characters - check the system prompt for %s",E,e.getName()),u.default.error("System prompt: %s",v),u.default.error("Consider adding a .hldkignore file or updating your .gitignore file to ignore some of the files in the workspace"),new Error(`System prompt is longer than the maximum allowed length of ${E} characters - check logs for more details - you can increase the limit by setting ${g.ConfigPropNames.AGENT_SYSTEM_PROMPT} on the home page`);var b=v;n.options.extraSystemMessageKwargs&&(b=[{type:"text",text:b,...n.options.extraSystemMessageKwargs}],u.default.debug("Using extra system message kwargs",n.options.extraSystemMessageKwargs));const T=this.checkpointerService.getCheckpointer(),k=e.createGraph(h,f,T);await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:"Human",content:s,createdAt:new Date,requestId:r}),await this.sessionService.addRequest({requestId:r,sessionId:t.sessionId,workspaceName:t.workspaceName,requestContent:s,startedAt:o});const O=t.config.recursionLimit||y.ConfigService.getNumericProperty(g.ConfigPropNames.AGENT_RECURSION_LIMIT)||50,I=n.options.extraHeaders?{configurable:{thread_id:t.sessionId},recursionLimit:O,headers:n.options.extraHeaders}:{configurable:{thread_id:t.sessionId},recursionLimit:O};u.default.debug("Call options: %s",JSON.stringify(I));const P=await T.get(I),C=p.MessageUtils.buildHumanMessage(t.content);let x=e.createInitialState();P?x.messages=[C]:n.options.extraSystemMessageKwargs?(u.default.debug("Using extra system message kwargs",n.options.extraSystemMessageKwargs),x.messages=[new d.SystemMessage({content:b,additional_kwargs:n.options.extraSystemMessageKwargs}),C]):n.options.systemPromptSupported?x.messages=[new d.SystemMessage({content:b}),C]:x.messages=[new d.HumanMessage({content:b}),C];const D=await k.stream(x,I);for await(const e of D){u.default.debug("Output Event was: %s",JSON.stringify(e));const o=p.MessageUtils.processOutputEvent(e);u.default.debug("Processed message: %s",o);const s=o.usageMetadata,i=n.calculateCost(s?.inputTokens||0,s?.cacheWriteTokens||0,s?.cacheReadTokens||0,s?.outputTokens||0),a={itemId:this.generateItemId(),sessionId:t.sessionId,label:o.label,content:o.content,createdAt:new Date,inputTokens:o.usageMetadata?.inputTokens,cacheWriteTokens:s?.cacheWriteTokens,cacheReadTokens:s?.cacheReadTokens,outputTokens:s?.outputTokens,totalTokens:s?.totalTokens,cost:i,requestId:r},c=await this.sessionService.addItem(a);m+=s?.inputTokens||0,w+=s?.cacheWriteTokens||0,S+=s?.cacheReadTokens||0,_+=s?.outputTokens||0,R=o.content;const d=await this.sessionService.getSession(t.sessionId);if(l=d&&"aborted"===d.status,l){const e={label:"Error",content:"Session was aborted by the user."},r=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:e.label,content:e.content,createdAt:new Date});yield r;break}yield c}}catch(e){u.default.error("Error in Agent:",e);const r={label:"Error",content:`An error occurred: ${e.message}`},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:r.label,content:r.content,createdAt:new Date});yield o}finally{try{if(!l&&s.isGitRepo){const e=new v.GitCommit(s.repoBaseDir,r,this.sessionService);if(await e.hasUncommittedUpdates()){const t=await e.getUncommittedChanges(),r="Give me a good commit message for the following diff contents - just return the message without quotes",o=await this.summaryCompletion.getSummary(r,t);u.default.info("Detected uncommitted git updates - committing changes with message: "+o),await e._call(o)}}await this.sessionService.updateSessionStatus(t.sessionId,"inactive");const e=n.calculateCost(m,w,S,_),i=new Date,a=i.getTime()-o.getTime(),c=m+w+S+_,d=await this.sessionService.updateRequest(r,{responseContent:R,endedAt:i,tookMillis:a,inputTokens:m,cacheWriteTokens:w,cacheReadTokens:S,outputTokens:_,totalTokens:c,cost:e});await this.homeService.logRequest(d),u.default.info("Agent processing completed in %s seconds - Input tokens: %s, Cache Write tokens: %s, Cache Read tokens: %s, Output tokens: %s, Total tokens: %s, Total cost: £%s",a/1e3,m,w,S,_,c,e.toFixed(6))}finally{i&&await this.workspaceService.unlockByName(i)}}}generateSessionId(){return(0,f.ulid)()}generateItemId(){return(0,f.ulid)()}};t.GraphAgentCollaborator=_,t.GraphAgentCollaborator=_=o([(0,s.Injectable)(),n("design:paramtypes",[m.WorkspaceService,i.SessionService,a.CheckpointerService,w.HomeService,S.SummaryCompletion])],_)},2424:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.GraphAgentModule=void 0;const n=r(3563),s=r(2300),i=r(5873),a=r(3880),c=r(9449),l=r(3177),d=r(4193),u=r(9161);let p=class{};t.GraphAgentModule=p,t.GraphAgentModule=p=o([(0,n.Module)({imports:[i.WorkspaceModule,a.SessionModule,c.LangchainModule,l.MutationsModule,d.HomeModule,u.ChatCompletionModule],providers:[s.GraphAgentCollaborator],exports:[s.GraphAgentCollaborator]})],p)},5277:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.GraphAgentService=void 0;const i=r(3563),a=r(3470),c=r(1412),l=r(7249),d=r(1162),u=r(6158),p=r(9055),f=r(2300);let h=class{constructor(e,t,r){this.agentCollaborator=e,this.toolFactoryService=t,this.ruleService=r}async getTools(e){return await this.toolFactoryService.createTools(await this.getToolNames(e),e)}async getToolNames(e){return[]}async getAgentRules(){const e=await this.ruleService.getRulesByAgentName(this.getName());return e?.content||null}async getSystemPrompt(e){const t=await this.getAgentRules(),r="Not implemented";return t?`${r}\n\nRules:\n${t}`:r}getName(){return"graph-agent"}getModelCategory(){return d.ModelCategory.CODING}isPrivateModelsOnly(){return!1}async verifyRequest(e,t){}async*processRequestStream(e){if(!e.workspaceName)throw new Error("Workspace name is required in the agent request");yield*this.agentCollaborator.processRequestStream(this,e)}async processRequest(e){return this.agentCollaborator.processRequest(this,e)}async simpleRequest(e,t,r=null){const o=new c.AgentRequest(null,e,r,null,t);return(await this.processRequest(o)).responseContent}createGraph(e,t,r){return l.StandardAgentStateManager.createWorkflow((async function(t){const r=t.messages;p.default.debug("Calling model with messages: %s",JSON.stringify(r));const o=await e.invoke(r);return p.default.debug("Received model response: %s",JSON.stringify(o)),{messages:[o]}}),t).compile({checkpointer:r})}createInitialState(){return{messages:[]}}};t.GraphAgentService=h,t.GraphAgentService=h=o([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>f.GraphAgentCollaborator)))),n("design:paramtypes",[f.GraphAgentCollaborator,u.ToolFactoryService,a.AgentRuleService])],h)},3690:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleAgentModule=void 0;const n=r(3563),s=r(5873),i=r(3880),a=r(4193),c=r(9161);let l=class{};t.SimpleAgentModule=l,t.SimpleAgentModule=l=o([(0,n.Module)({imports:[s.WorkspaceModule,i.SessionModule,a.HomeModule,c.ChatCompletionModule],exports:[]})],l)},6295:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleAgentService=void 0;const s=r(3563),i=r(1412),a=r(8474),c=r(7373),l=r(538),d=r(3239),u=r(9234),p=r(9100),f=r(9055),h=r(4911),m=r(1544),g=r(6254),y=r(6158),w=r(3470);let S=class{constructor(e,t,r,o,n,s){this.workspaceService=e,this.sessionService=t,this.homeService=r,this.summaryCompletion=o,this.toolFactory=n,this.ruleService=s,this.chatModelManager=m.ChatModelManager.getInstance()}async getAgentRules(){const e=await this.ruleService.getRulesByAgentName(this.getName());return e?.content||null}createInitialState(){return{messages:[]}}async*processRequestStream(e){const t=(0,p.ulid)();if(!await this.homeService.isAccessOkay()){const r={label:"Error",content:"Access is not valid. Please check your HLDK API key and try again."},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId||this.generateSessionId(),label:r.label,content:r.content,createdAt:new Date,requestId:t});return void(yield o)}const r=new Date;e.sessionId||(e.sessionId=this.generateSessionId());const o=await this.chatModelManager.getModel(e.config,this.getModelCategory(),this.isPrivateModelsOnly());let n;e.workspaceName?n=await this.workspaceService.lockByName(e.workspaceName):(n=await this.workspaceService.lockSessionWorkspace(e.sessionId),e.workspaceName=n.name);const s=n.name,a=new u.RequestContext(n,t,e.sessionId);let c=!1,l=0,d=0,m=0,y=0,w="";try{const n=i.AgentRequest.getFirstTextContent(e.content),s=await this.sessionService.ensureSession(e.workspaceName,e.sessionId,n,this.getName());await this.sessionService.updateSessionStatus(s.sessionId,"active"),f.default.info("%s received request: %s - %s",this.getName(),t,JSON.stringify(e)),f.default.info("Using primary model: %s",o.modelDescriptor.getFullName()),await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:"Human",content:n,createdAt:new Date,requestId:t}),await this.sessionService.addRequest({requestId:t,sessionId:e.sessionId,workspaceName:e.workspaceName,requestContent:n,startedAt:r});const u=await this.handleAppStream(e,a,o);for await(const r of u){f.default.debug("Output Event was: %s",JSON.stringify(r));const n=g.MessageUtils.processOutputEvent(r);f.default.debug("Processed message: %s",n);const s=n.usageMetadata,i=o.calculateCost(s?.inputTokens||0,s?.cacheWriteTokens||0,s?.cacheReadTokens||0,s?.outputTokens||0),a={itemId:this.generateItemId(),sessionId:e.sessionId,label:n.label,content:n.content,createdAt:new Date,inputTokens:s?.inputTokens,cacheWriteTokens:s?.cacheWriteTokens,cacheReadTokens:s?.cacheReadTokens,outputTokens:s?.outputTokens,totalTokens:s?.totalTokens,cost:i,requestId:t},u=await this.sessionService.addItem(a);l+=s?.inputTokens||0,d+=s?.cacheWriteTokens||0,m+=s?.cacheReadTokens||0,y+=s?.outputTokens||0,w=n.content;const p=await this.sessionService.getSession(e.sessionId);if(c=p&&"aborted"===p.status,c){const t={label:"Error",content:"Session was aborted by the user."},r=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:t.label,content:t.content,createdAt:new Date});yield r;break}yield u}}catch(t){f.default.error("Error in Agent:",t);const r={label:"Error",content:`An error occurred: ${t.message}`},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:r.label,content:r.content,createdAt:new Date});yield o}finally{try{if(!c&&n.isGitRepo){const e=new h.GitCommit(n.repoBaseDir,t,this.sessionService);if(await e.hasUncommittedUpdates()){const t=await e.getUncommittedChanges(),r="Give me a good commit message for the following diff contents - just return the message without quotes",o=await this.summaryCompletion.getSummary(r,t);f.default.info("Detected uncommitted git updates - committing changes with message: "+o),await e._call(o)}}await this.sessionService.updateSessionStatus(e.sessionId,"inactive");const s=o.calculateCost(l,d,m,y),i=new Date,a=i.getTime()-r.getTime(),u=l+d+m+y,p=await this.sessionService.updateRequest(t,{responseContent:w,endedAt:i,tookMillis:a,inputTokens:l,cacheWriteTokens:d,cacheReadTokens:m,outputTokens:y,totalTokens:u,cost:s});await this.homeService.logRequest(p),f.default.info("Agent processing completed in %s seconds - Input tokens: %s, Cache Write tokens: %s, Cache Read tokens: %s, Output tokens: %s, Total tokens: %s, Total cost: £%s",a/1e3,l,d,m,y,u,s.toFixed(6))}finally{s&&await this.workspaceService.unlockByName(s)}}}async processRequest(e){f.default.info("Processing request: %s",JSON.stringify(e));const t=this.processRequestStream(e);let r=null;for await(const e of t)r=e,f.default.info("Yielded item: %s",JSON.stringify(e));if(!r)throw new Error("No items were yielded from the generator");const o=await this.sessionService.getRequest(r?.requestId);if(!o)throw new Error("Failed to retrieve persisted request");return f.default.info("Returning request: %s",JSON.stringify(o)),o}async simpleRequest(e,t,r=null){const o=new i.AgentRequest(null,e,r,null,t);return(await this.processRequest(o)).responseContent}generateSessionId(){return(0,p.ulid)()}generateItemId(){return(0,p.ulid)()}};t.SimpleAgentService=S,t.SimpleAgentService=S=o([(0,s.Injectable)(),n("design:paramtypes",[a.WorkspaceService,c.SessionService,l.HomeService,d.SummaryCompletion,y.ToolFactoryService,w.AgentRuleService])],S)},989:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseToolCallingAgent=void 0;const s=r(1486),i=r(3563),a=r(1412),c=r(1e3),l=r(3239),d=r(2368),u=r(6910),p=r(538),f=r(7373),h=r(6158),m=r(8474),g=r(9055),y=r(6295),w=r(2873),S=r(3470);let v=class extends y.SimpleAgentService{constructor(e,t,r,o,n,s,i){super(e,t,r,o,n,i),this.workspaceService=e,this.sessionService=t,this.homeService=r,this.summaryCompletion=o,this.toolFactory=n,this.checkpointerService=s,this.ruleService=i}getToolCallingScheme(){return new w.MultilineToolCallingScheme}async*handleAppStream(e,t,r){let o;if(this.checkpointerService&&e.sessionId)try{const t=await this.checkpointerService.loadState(e.sessionId);t&&(o=t,g.default.debug("Loaded existing conversation state for session: %s",e.sessionId))}catch(e){g.default.warn("Failed to load conversation state:",e)}const n=await this.chatModelManager.getModel(e.config,this.getModelCategory(),this.isPrivateModelsOnly()),i=this.getTools(t);o||(o=this.createInitialState());const c=a.AgentRequest.getFirstTextContent(e.content),l=d.ConfigService.getInstance().getNumericProperty(u.ConfigPropNames.AGENT_ITERATION_LIMIT,20);let p=0,f=!1;const h=this.getToolCallingScheme();let m=await this.getSpecificSystemPrompt(t)+h.getSystemPrompt(t,i);const y=await this.getAgentRules();for(y&&(m=m+"\n\nAdditional system rules:\n"+y),g.default.debug("System prompt was:\n%s",m),o.messages.push(new s.SystemMessage({content:m})),o.messages.push(new s.HumanMessage({content:c}));p<l&&!f;){p++,g.default.info(`Iteration ${p}: Asking model for response...`);const t=await n.baseChatModel.invoke(o.messages);o.messages.push(t),this.checkpointerService&&e.sessionId&&await this.checkpointerService.saveState(e.sessionId,o),yield o;const r=t.content.toString();let a;g.default.info(`Iteration ${p}: Agent response:\n${r}`);try{a=h.parseLLMResponse(r)}catch(e){o.messages.push(new s.HumanMessage({content:"Error: Your response could not be parsed as valid. Please ensure you follow the correct format."}));continue}const{response:c,tool_calls:l,next:d}=a;if("finish"!==d)if("call_tools"===d&&Array.isArray(l))for(const e of l){const{tool_name:t,args:r}=e,n=i.find((e=>e.name===t));if(n)try{const e=await n.call(r);o.messages.push(new s.HumanMessage({content:`Tool: '${t}' output:\n${e}`}))}catch(e){g.default.error(`Error executing tool '${t}':`,e),o.messages.push(new s.HumanMessage({content:`Tool: Error executing '${t}': ${e.message}`})),yield o}else o.messages.push(new s.HumanMessage({content:`Tool: Unknown tool '${t}'.`})),yield o}else"continue"!==d&&(o.messages.push(new s.HumanMessage({content:`Tool: Unrecognized 'next' value '${d}'. Please use 'call_tools', 'continue', or 'finish'.`})),yield o);else f=!0}f||(o.messages.push(new s.SystemMessage({content:`Maximum iterations (${l}) reached without completion.`})),yield o)}};t.BaseToolCallingAgent=v,t.BaseToolCallingAgent=v=o([(0,i.Injectable)(),n("design:paramtypes",[m.WorkspaceService,f.SessionService,p.HomeService,l.SummaryCompletion,h.ToolFactoryService,c.CheckpointerService,S.AgentRuleService])],v)},2873:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MultilineToolCallingScheme=void 0;const o=r(6511);class n extends o.ToolCallingScheme{getSystemPrompt(e,t){return`\n\nYou are an AI being used as part of an agent to help implement the user's request.\nYou are one part of a multi-step process and you are operating in a loop.\nEach response should be targeted to provide some feedback to the user about what is happening now, but mostly it needs to instruct the agent on what to do next.\n\nThe general format for your responses is:\n\n<free text describing what our plan is>\n\n<<<<< NEXT_ACTION next_action >>>>> (where next_action is one of: call_tools, continue, finish)\n\nWhen you need to use a tool, use the following format embedded in your response:\n\n<<<<< NEXT_ACTION next_action >>>>>\n\n<<<<< TOOL CALL tool_name\n<<<<< arg_name_1\n(argument value 1)\n<<<<< arg_name_2\n(argument value 2)\n...\n>>>>> TOOL CALL END\n\n- **next_action** can be one of: \`call_tools\`, \`continue\`, or \`finish\`.\n  - Use \`call_tools\` if you expect the agent to execute the tools you've specified.\n  - Use \`continue\` if you want to proceed without tool execution and control will return to you.\n  - Use \`finish\` when you have completed all tasks or if you need more information from the user and you want to return control to them.\n- Start the next action line with \`<<<<< NEXT_ACTION next_action >>>>>\`.\n- If you are calling tools, include the tool calls as specified.\n- IMPORTANT: Just do one step at a time, ask for a tool call and wait for the response before asking for another tool call (or continuing/finishing).\n\nAvailable Tools:\n\n${this.getToolInstructions(t)}\n\nRemember:\n\n- **Use the exact argument names as specified for each tool.**\n- **Do not include any JSON or markdown formatting in your response.**\n- **Provide code snippets or text exactly as needed, without worrying about escaping.**\n- **Only use tools when necessary.**\n\n---\n\nExamples:\n\n1a. **Using \`update_file\` to update an existing file and specifying \`call_tools\`:**\n\nI need to update the file to replace certain code.\n\n<<<<< NEXT_ACTION call_tools >>>>>\n\n<<<<< TOOL CALL update_file\n<<<<< filePath\n/src/utils/math.js\n<<<<< search\nfunction add(a, b) {\n  return a + b;\n}\n<<<<< replace\nfunction add(a, b) {\n  return a - b;\n}\n>>>>> TOOL CALL END\n\n1b. **Using \`update_file\` to create a new file and specifying \`call_tools\`:**\n\nOr another example when we are creating a new file:\n\n<<<<< NEXT_ACTION call_tools >>>>>\n\n<<<<< TOOL CALL update_file\n<<<<< filePath\n/src/utils/math.js\n<<<<< search\n<<<<< replace\nfunction add(a, b) {\n  return a - b;\n}\n>>>>> TOOL CALL END\n\n2. **Continuing without tool execution (\`continue\`):**\n\nI will now proceed to document the changes made.\n\n<<<<< NEXT_ACTION continue >>>>>\n\n3. **Finishing the task (\`finish\`):**\n\nAll tasks are completed. Here's a summary of the changes made.\n\n<<<<< NEXT_ACTION finish >>>>>\n\n---\n\nNow, please proceed to assist the user with their request.\n`}parseLLMResponse(e){const t=this.extractNextAction(e),r=this.extractToolCalls(e);return{response:e.replace(/<<<<< NEXT_ACTION.*?>>>>>>/gs,"").replace(/<<<<< TOOL CALL.*?>>>>> TOOL CALL END/gs,"").trim(),tool_calls:r,next:t}}getToolInstructions(e){return e.map((e=>`Tool Name: ${e.name}\nDescription: ${e.description}\nUsage:\n<<<<< TOOL CALL ${e.name}\n${this.getToolArgumentsUsage(e)}\n>>>>> TOOL CALL END`)).join("\n\n")}getToolArgumentsUsage(e){const t=e.schema;if(!t||!t._def||"function"!=typeof t._def.shape)return"(No parameters required)";try{const e=t._def.shape();return e&&"object"==typeof e?Object.keys(e).map((e=>`<<<<< ${e}\n(value for ${e})`)).join("\n"):"(No parameters required)"}catch(e){return"(Error reading tool parameters)"}}extractNextAction(e){const t=e.match(/<<<<< NEXT_ACTION (\w+) >>>>>/);if(t){const e=t[1];if(["call_tools","continue","finish"].includes(e))return e}return"continue"}extractToolCalls(e){const t=[],r=/<<<<< TOOL CALL (\w+)[\s\S]*?>>>>> TOOL CALL END/g;let o;for(;null!==(o=r.exec(e));){const e=o[1],r=o[0],n=this.extractArgs(r);t.push({tool_name:e,args:n})}return t}extractArgs(e){const t={},r=/<<<<< (\w+)\n([\s\S]*?)(?=(<<<<< \w+|>>>>> TOOL CALL END))/g;let o;for(;null!==(o=r.exec(e));){const e=o[1],r=o[2].trim();t[e]=r}return t}}t.MultilineToolCallingScheme=n},6511:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToolCallingScheme=void 0;t.ToolCallingScheme=class{}},6695:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ComputerUseAgentService=void 0;const i=r(3563),a=r(3470),c=r(5277),l=r(6158),d=r(2300),u=r(8884);let p=class extends c.GraphAgentService{constructor(e,t,r){super(e,t,r),this.agentCollaborator=e,this.toolFactoryService=t,this.ruleService=r}getName(){return"computer-use-agent"}async getTools(e){return this.toolFactoryService.createTools(["computer"],e)}async getSystemPrompt(e){const t=process.platform,r="win32"===t?"Windows":"darwin"===t?"macOS":"Linux",o=(0,u.getEnv)("WIDTH"),n=(0,u.getEnv)("HEIGHT");if(!o||!n)throw new Error("Screen resolution environment variables WIDTH and HEIGHT must be set");return`\n    You are a Computer Use Agent specializing in controlling the computer through keyboard and mouse automation. Your task is to help users achieve their goals by controlling the computer interface using the computer tool.\n\n    WORKSPACE INFORMATION:\n    Current operating system: ${r}\n    Screen resolution: ${o}x${n} pixels\n\n    AVAILABLE COMPUTER TOOL FUNCTIONS:\n\n    1. Keyboard Control:\n       - key: Send keyboard key events\n         * Use for special keys and key combinations\n         * Examples: "enter", "tab", "ctrl+c", "shift+a"\n       - type: Type text directly\n         * Use for entering regular text\n         * More reliable than individual key presses for text input\n         * Example: {"action": "type", "text": "Hello World"}\n\n    2. Mouse Control:\n       - mouse_move: Move mouse cursor to specific coordinates\n         * Requires x,y coordinates within screen bounds\n         * Example: {"action": "mouse_move", "coordinate": [100, 200]}\n       - left_click: Click the left mouse button\n         * Use after positioning the cursor\n         * For basic selection and activation\n       - right_click: Click the right mouse button\n         * Use for context menus\n         * Position cursor first\n       - middle_click: Click the middle mouse button\n         * Special functions in some applications\n       - double_click: Double click at current position\n         * Use for opening files/folders\n         * More reliable than two separate clicks\n       - left_click_drag: Click and drag operation\n         * For selections and drag-drop\n         * Requires target coordinates\n         * Example: {"action": "left_click_drag", "coordinate": [300, 400]}\n\n    3. Screen Information:\n       - screenshot: Capture the current screen\n         * Use to verify current state\n         * Helps in debugging automation\n       - cursor_position: Get current mouse coordinates\n         * Use to verify cursor location\n         * Helpful for planning movements\n\n    OPERATIONAL GUIDELINES:\n\n    1. Coordinate System:\n       - Screen coordinates start at (0,0) in top-left corner\n       - X increases right (0 to ${o}), Y increases down (0 to ${n})\n       - All coordinates must stay within screen bounds (0 ≤ x ≤ ${o}, 0 ≤ y ≤ ${n})\n\n    2. Best Practices:\n       - Always verify cursor position before clicking\n       - Use type action for text input when possible\n       - Add small delays between actions if needed\n       - Break complex operations into simple steps\n       - Verify results with screenshots when needed\n\n    3. Safety Considerations:\n       - Avoid rapid mouse movements\n       - Verify coordinates before drag operations\n       - Be cautious with double-clicks\n       - Allow time for system response\n\n    IMPORTANT REMINDERS:\n    1. NEVER guess about what is on the screen - always take a screenshot first to examine the current state\n    2. Take screenshots after performing actions to verify they had the intended effect\n    3. All coordinates must be within screen bounds\n    4. Always verify current state before critical actions\n    5. Use the most appropriate function for each task\n    6. Break complex tasks into simple, verifiable steps\n    7. Consider user confirmation for critical operations\n    8. Remember that screen layout may vary by system\n    9. Be prepared to handle unexpected states\n    10. NEVER assume we need to wait for an operation to complete - if the expected result is not visible in the screenshot, assume the operation did not work\n    \n    WORKFLOW REQUIREMENTS:\n    1. Before making any plan:\n       - Take a screenshot to understand the current state\n       - Analyze the screenshot to identify UI elements and their locations\n       - Only proceed once you have clear visual confirmation of the interface\n    \n    2. After performing actions:\n       - Take another screenshot to verify the results\n       - Compare with expected outcome\n       - If results don't match expectations, adjust your approach\n       \n    3. For complex operations:\n       - Break down into smaller steps\n       - Verify each step with a screenshot before proceeding\n       - Document any unexpected behavior or states`}};t.ComputerUseAgentService=p,t.ComputerUseAgentService=p=o([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>d.GraphAgentCollaborator)))),n("design:paramtypes",[d.GraphAgentCollaborator,l.ToolFactoryService,a.AgentRuleService])],p)},3887:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.OpsAgentService=void 0;const i=r(3563),a=r(9896),c=r(3470),l=r(6928),d=r(5277),u=r(6158),p=r(2300);let f=class extends d.GraphAgentService{constructor(e,t,r){super(e,t,r),this.agentCollaborator=e,this.toolFactoryService=t,this.ruleService=r}getName(){return"ops-agent"}async getTools(e){return this.toolFactoryService.createTools(["read_file","update_file","delete_file","command_line","add_workspace","fetch_web_page","git_init"],e)}async getSystemPrompt(e){let t="";const r=l.join(e.workspace.repoBaseDir,"ops-hints.md");a.existsSync(r)&&(t=a.readFileSync(r,"utf-8"));const o=process.platform,n="win32"===o?"Windows":"darwin"===o?"macOS":"Linux";return`\n    You are a helpful DevOps agent specializing in system operations, automation, and infrastructure management. Your task is to assist with various DevOps-related tasks and solve problems using the tools provided.\n\n    WORKSPACE INFORMATION:\n    Current working directory: ${e.workspace.repoBaseDir}\n    Current operating system: ${n}\n\n    AVAILABLE TOOLS AND THEIR USAGE:\n\n    1. File Operations:\n       - read_file: Read the contents of any file in the workspace\n       - update_file: Modify file contents (requires filePath, search text, and replacement text)\n       - delete_file: Remove a file (use with caution, confirm before deleting important files)\n\n    2. System Operations:\n       - command_line: Execute shell commands\n         * Can specify a subdirectory to run commands in\n         * Use for package management, build tools, and system commands\n         * ALWAYS include automatic confirmation flags to prevent hanging:\n           - Use --yes or -y for apt, apt-get\n           - Use -y for yum\n           - Use --no-input for pip\n           - Use -f or --force for npm/pnpm\n           - Use --defaults for yeoman\n           - Use --non-interactive for composer\n           - Use --assume-yes for other tools\n           - Add appropriate silent/quiet flags when available\n         * DO NOT use for process termination or destructive operations\n       \n    3. Git and Repository Management:\n       - git_init: Initialize a new Git repository\n       - Always use 'git add -A' for staging changes\n\n    5. Additional Tools:\n       - add_workspace: Add a new workspace (specify target project's base directory)\n       - fetch_web_page: Fetch web page content (only when explicitly requested)\n\n    OPERATIONAL GUIDELINES:\n\n    1. Safety and Security:\n       - Never perform destructive operations that cannot be undone\n       - Do not terminate processes unless explicitly instructed\n       - Stop and report if multiple solution attempts fail\n       - Never access or modify files outside the workspace directory\n\n    2. Workspace Management:\n       - You can create directories and files within the workspace\n       - You can read and modify any files under the repo root\n       - Never traverse up beyond the workspace root directory\n\n    3. Best Practices:\n       - Always verify file existence before operations\n       - Use appropriate error handling\n       - Document significant changes\n       - Ask for clarification when instructions are unclear or risky\n\n    4. New Project Creation:\n       - When asked to create a new project with specific technologies:\n         * First, search for suitable template projects:\n           - Use fetch_web_page with GitHub search URL in format:\n             https://github.com/search?q=tech1%20tech2%20app%20starter&type=repositories\n             (replacing tech1, tech2, etc. with the requested technologies)\n           - Analyze results and identify best candidates based on:\n             * Star count (higher is better)\n             * Last update date (2020 or newer preferred)\n             * Match to requested tech stack\n           - Present top candidates to user and ask if they want to use one as template\n           - If user selects a template, use add_workspace tool with the chosen repo URL\n         \n         * If no good templates found or user prefers fresh setup:\n           - Offer to bootstrap project using official tooling\n           - Create appropriate subdirectory in workspace\n           - Use command_line tool with proper package manager/CLI tools\n           - Use sensible defaults where possible\n           - Ask user for input only when necessary for key decisions\n           - After setup complete:\n             * Add a README.md file to the new project directory with instructions for the user\n             * Use the add_workspace tool with full path to the new project directory\n             * Read and relay setup/startup instructions\n             * Suggest next steps for development\n\n       - When asked to create a new project without specific tech stack:\n         * Use the add_workspace tool with gitRepoUrl: https://github.com/HigherLevelDev/fullstack-starter\n         * Create the new workspace as a subfolder of the current workspace unless an absolute path is specified\n         * Follow any specific requirements provided by the user\n         * After creating the workspace:\n           - Read and relay the README.md file contents to provide setup/startup instructions\n           - Suggest using the architect-agent or se-agent to implement requested features in the new workspace\n           - Provide clear next steps for the user to get started with their project\n\n    Additional Workspace-Specific Hints:\n    ${e.repositoryHints()?`${e.repositoryHints()}`:""}\n\n    IMPORTANT REMINDERS:\n    1. After creating a new project, add a README.md and call the add_workspace tool with the full path to add and let the user know it should appear in the list of workspaces\n    2. Always use 'git add -A' rather than adding individual files\n    3. Confirm destructive operations with the user before proceeding\n    4. Stay within the workspace boundaries\n    5. Use tools according to their documented purposes and limitations\n    6. ALWAYS include automatic confirmation flags (--yes, -y, --force, etc.) when running interactive commands\n    7. Add appropriate silent/quiet flags to prevent unnecessary output when available`}};t.OpsAgentService=f,t.OpsAgentService=f=o([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>p.GraphAgentCollaborator)))),n("design:paramtypes",[p.GraphAgentCollaborator,u.ToolFactoryService,c.AgentRuleService])],f)},8471:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.PrivateCoderAgentService=void 0;const s=r(3563),i=r(989),a=r(1e3),c=r(8474),l=r(7373),d=r(538),u=r(3239),p=r(6158),f=r(1162),h=r(8921),m=r(3470);let g=class extends i.BaseToolCallingAgent{constructor(e,t,r,o,n,s,i){super(e,t,r,o,n,s,i)}getName(){return"private-coder-agent"}getModelCategory(){return f.ModelCategory.CODING}isPrivateModelsOnly(){return!0}getTools(e){const t=this.toolFactory.createTool("read_file",e),r=this.toolFactory.createTool("update_file",e),o=this.toolFactory.createTool("command_line",e),n=this.toolFactory.createTool("current_timestamp",e);return o.setPrivateRequired(!0),[t,r,o,n]}async getSpecificSystemPrompt(e){const t=await h.EpicsPrompts.updateStoryTasks(e);return`\nYou are an AI coding assistant focused on making high-quality code changes. Your task is to help implement the user's request by following this multi-step process:\n\n1. Initial Research (ALWAYS DO THIS FIRST):\n   a. Use the read_file tool to examine any relevant files before planning any changes.\n   b. Look at similar files in the codebase to understand:\n      - Code style and formatting conventions\n      - Use of DTOs vs use of domain entities etc\n      - Error handling patterns\n      - Logging practices\n      - Import organization\n      - Naming conventions\n      - Documentation style\n      - Tools and patterns being used\n   c. Never make assumptions about file contents - always verify with read_file\n   d. Study the existing patterns thoroughly before proceeding to planning.\n\n2. Planning (ONLY AFTER RESEARCH IS COMPLETE):\n   a. Based on the research, make a clear plan with multiple steps.\n   b. Break down complex changes into smaller, manageable steps.\n   c. Think through potential impacts on other parts of the codebase.\n   d. Consider how to maintain consistency with existing patterns.\n\n3. Implementation (FOLLOW PLAN STEP BY STEP):\n   a. Execute each step in the plan sequentially, explaining each change.\n   b. Make changes using the update_file tool, always providing all three arguments:\n      - filePath: The path to the file to modify\n      - search: The specific code block to replace\n      - replace: The new code block (never forget this!)\n   c. Keep changes focused and minimal - update only what's necessary.\n   d. Ensure code changes follow these principles:\n      - Clean, maintainable code structure\n      - Performance optimization\n      - Security best practices\n      - Scalability considerations\n      - Proper error handling\n      - Clear documentation\n      - Consistent with existing patterns (e.g. code style, formatting, naming conventions, dto's, repository patterns, etc)\n\n4. Testing:\n   a. After code changes, use the command_line tool to run: ${e.workspace.buildOrTestCommand}\n   b. If errors occur, analyze and fix them before proceeding.\n   c. Ensure all changes are properly tested.\n\n5. Summary:\n   Provide a concise final summary listing:\n   a. Files that were modified\n   b. Brief description of changes made to each file\n\nThe repository file structure is:\n${e.repositoryTree()}\n\n${e.repositoryHints()?`Additional hints provided by the user that must be adhered to:\n${e.repositoryHints()}`:""}\n\nIMPORTANT REMINDERS:\n- ALWAYS do thorough research first (use the read_file tool) and return that as a response\n- Keep reading more files if needed until you have a thorough understanding of the codebase\n- Then make a clear plan based on research findings and return that as a response (continue)\n- Then iterate through the plan step by step, using the update_file tool to make changes to the code\n- Keep changes minimal and focused (use the update_file tool)\n- Build/Test after making changes (use the command_line tool)\n- Provide clear, concise summaries\n\n# Task Management Instructions\n${t}\n\nIMPORTANT: When implementing tasks:\n1. Always check the task status in the task JSON file before starting work\n2. Update the task status to "inprogress" when you start working on it\n3. Update the task status to "done" when you complete it\n4. Always use current_timestamp to update the updatedAt field when changing task status\n5. Remember that task status changes may require updating the parent story status\n\n- COMMAND LINE TOOL RESTRICTIONS:\n  * Only use the command_line tool for:\n    1. Running the build/test command (${e.workspace.buildOrTestCommand})\n    2. Installing new local packages for the project\n  * Never use it for any other system changes\n  * Never traverse up above the workspace directory\n  * Always include automatic confirmation flags (--yes, -y, --force, etc.) for package installations\n`}};t.PrivateCoderAgentService=g,t.PrivateCoderAgentService=g=o([(0,s.Injectable)(),n("design:paramtypes",[c.WorkspaceService,l.SessionService,d.HomeService,u.SummaryCompletion,p.ToolFactoryService,a.CheckpointerService,m.AgentRuleService])],g)},1263:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ProductAgentService=void 0;const i=r(3563),a=r(6158),c=r(3470),l=r(9055),d=r(2300),u=r(5277),p=r(8921);let f=class extends u.GraphAgentService{constructor(e,t,r){super(e,t,r),this.agentCollaborator=e,this.toolFactoryService=t,this.ruleService=r}getName(){return"product-agent"}async getTools(e){return this.toolFactoryService.createTools(["read_file","update_file","delete_file","fetch_web_page","current_timestamp"],e)}async getSystemPrompt(e){let t=`As an AI Product Manager, your role is to define, refine, and manage product requirements through epics and stories. You excel at:\n\n1. Creating and Refining Requirements:\n   - Developing clear, comprehensive epic requirements\n   - Breaking down epics into well-defined stories\n   - Writing detailed, testable acceptance criteria\n   - Ensuring requirements are SMART (Specific, Measurable, Achievable, Relevant, Time-bound)\n\n2. Stakeholder Perspective Analysis:\n   - Product Value: Ensuring features deliver clear business value\n   - User Experience: Considering the end-user journey and usability\n   - Quality Assurance: Including testability and edge cases\n   - Operations: Considering scalability, monitoring, and maintenance\n   - Engineering: Evaluating technical feasibility and complexity\n   - Security: Identifying potential security implications\n   - Compliance: Ensuring regulatory and policy compliance\n\n3. Story Creation Best Practices:\n   - Write user-centric stories following the format:\n     "A a [user type], I want [goal] so that [benefit]"\n   - Create comprehensive acceptance criteria that:\n     * Are each formatted as "ACxx: Given a [user type], when [action], then [outcome]"\n     * Are specific and testable\n     * Cover happy path and edge cases\n     * Include performance requirements\n     * Specify error handling\n     * Define security requirements\n     * Include monitoring/observability requirements\n\n4. Requirements Quality Standards:\n   - Clarity: Unambiguous and easily understood\n   - Completeness: Covers all aspects of the feature\n   - Consistency: Aligns with existing features and patterns\n   - Testability: Can be verified through testing\n   - Feasibility: Technically achievable within constraints\n   - Traceability: Links to business goals and metrics\n\n${await p.EpicsPrompts.updateEpicInstructions(e)}\n\n${await p.EpicsPrompts.updateEpicStories(e)}\n\n${await p.EpicsPrompts.existingEpicsAndStories(e)}\n\n${e.productHints()?`Product Guidelines:\n${e.productHints()}`:""}\n\nIMPORTANT: Always write requirements from the user's perspective\nIMPORTANT: Every story must have clear, testable acceptance criteria\nIMPORTANT: Consider all stakeholder perspectives when defining requirements\nIMPORTANT: Ensure requirements are complete, clear, and unambiguous\nIMPORTANT: Include non-functional requirements (performance, security, etc.)\nIMPORTANT: Use the current_timestamp tool for timestamps\nIMPORTANT: Stories should be independent and deliverable\nIMPORTANT: DO NOT CREATE ANY STORIES UNLESS YOU ARE ASKED TO DO SO EXPLICITLY\n`;return l.default.debug(`Product Agent system prompt for workspace '${e.workspace.name}' (length: ${t.length} chars): ${t}`),t}};t.ProductAgentService=f,t.ProductAgentService=f=o([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>d.GraphAgentCollaborator)))),n("design:paramtypes",[d.GraphAgentCollaborator,a.ToolFactoryService,c.AgentRuleService])],f)},8921:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EpicsPrompts=void 0;const o=r(6426),n=r(6928),s=r(9896),i=r(526);t.EpicsPrompts=class{static async getEpicsTree(e){const t=n.join(e.workspace.repoBaseDir,"epics"),r=(0,i.default)();return s.existsSync(t)?(0,o.generateTreeRecursive)(t,r,t):(s.mkdirSync(t,{recursive:!0}),"└── (empty epics directory)")}static async existingEpicsAndStories(e){return`To work with epics in this workspace, you need to understand the file structure:\n\n${await this.getEpicsTree(e)}\n\nEach epic follows this structure:\nEPIC-XX_Name/\n  ├── requirements.md (contains epic title and description)\n  └── stories/\n      └── STORY-XX_Name/\n          ├── story.json (contains story details)\n          └── tasks/\n              └── TASK-XX_Name.json (individual task details)\n\nUse the read_file tool (e.g. path: ./epics/EPIC-XX_Name/requirements.md) to inspect these files and understand the current state of epics.`}static async updateEpicInstructions(e){return"To create or update an epic:\n\n1. For a new epic:\n   - Create a directory named EPIC-XX_Name (where XX is a sequential number and Name is a short title)\n   - Use update_file to create requirements.md in the epic directory with this structure:\n     # XX_Name\n     \n     ## Description\n     Epic description goes here\n     \n     ## Goals\n     - Add specific, measurable goals here\n     \n     ## Success Criteria\n     - List the criteria that define when this epic is complete\n\n2. For updating an existing epic:\n   - Use read_file to get the current requirements.md content\n   - Use update_file to update the requirements.md with the new content (path: ./epics/EPIC-XX_Name/requirements.md)\n   - Maintain the same format with title, description, goals, and success criteria sections\n\nThe epic directory should be under the workspace at: ./epics/EPIC-XX_Name/"}static async updateEpicStories(e){return'To create or update stories in an epic:\n\n1. For a new story:\n   - Create a directory named STORY-XX_Name under the epic\'s stories directory\n   - Use update_file to create story.json with this structure:\n     {\n       "id": "STORY-XX_Name",\n       "title": "Story Title",\n       "description": "Detailed story description",\n       "status": "backlog",\n       "createdAt": "<use current_timestamp>",\n       "updatedAt": "<use current_timestamp>",\n       "acceptanceCriteria": [\n         "AC01: Given a normal user, when they log in, then they should see a welcome message",\n         "AC02: Given an admin user, when they log in, then they should be taken to the admin dashboard"\n       ]\n     }\n\n2. For updating an existing story:\n   - Use read_file to get the current story.json content\n   - Use update_file to update the story.json with the new content\n   - Maintain all existing fields and update only what\'s changed\n   - Update the updatedAt timestamp using current_timestamp\n\nThe story file should be under the stories directory of the epic which is under the workspace at: ./epics/EPIC-XX_Name/stories/STORY-XX_Name/story.json\n\nValid status values are: "backlog", "inprogress", "done" (all lowercase)'}static async updateStoryTasks(e){return`To create or update tasks in a story:\n\n1. For a new task:\n   - Create a new file named TASK-XX_Name.json in the story's tasks directory\n   - Use update_file to create the task with this structure:\n     {\n       "id": "TASK-XX_Name",\n       "title": "Task Title",\n       "description": "Detailed task description",\n       "assignee": "Agent-X",\n       "status": "backlog",\n       "createdAt": "<use current_timestamp>",\n       "updatedAt": "<use current_timestamp>"\n     }\n\n2. For updating an existing task:\n   - Use read_file to get the current task JSON file\n   - Update the necessary fields\n   - Update the updatedAt timestamp using current_timestamp\n   - Use update_file to save the modified task\n\nThe task files should be at: ${e.workspace.repoBaseDir}/epics/EPIC-XX_Name/stories/STORY-XX_Name/tasks/TASK-XX_Name.json\n\nValid task status values are: "backlog", "inprogress", "done" (all lowercase)\n\nRemember to update the story's status based on its tasks:\n- If all tasks are done -> story is done\n- If any task is inprogress -> story is inprogress\n- If all tasks are backlog or no tasks -> story is backlog\n\nAlso update the story.json file to reflect the current task status.`}static async allEpicInstructions(e){return`# Complete Epic Management Instructions\n\n${await this.existingEpicsAndStories(e)}\n\n${await this.updateEpicInstructions(e)}\n\n${await this.updateEpicStories(e)}\n\n${await this.updateStoryTasks(e)}\n\nRemember:\n1. Always use ULIDs for new IDs (epic, story, task)\n2. Keep timestamps updated using current_timestamp\n3. Maintain proper status transitions\n4. Preserve existing data when updating\n5. Follow the exact file structure and formats`}}},5610:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReviewAgentService=void 0;const i=r(3563),a=r(6158),c=r(3470),l=r(9055),d=r(2300),u=r(5277);let p=class extends u.GraphAgentService{constructor(e,t,r){super(e,t,r),this.agentCollaborator=e,this.toolFactoryService=t,this.ruleService=r}getName(){return"review-agent"}async getTools(e){return this.toolFactoryService.createTools(["read_file","update_file","delete_file","command_line","fetch_web_page","read_dependency_source_tree","read_dependency_source_file","git_commit","remote_git"],e)}async getSystemPrompt(e){let t=`As an AI code review assistant, you are tasked with analyzing and reviewing code changes in a pull request or specific commit.\n  Follow these guidelines:\n  1. The user input will be a URL to a pull request or a specific commit hash.\n  2. Use the "remote-git" toolkit (not implemented yet) to:\n     a. Sync the workspace to match the state of the commit/pull request.\n     b. Fetch the contents of the commit or the pull request (including comments).\n  3. Perform a thorough evaluation of the changes being made, considering:\n     a. Code quality and readability\n     b. Adherence to best practices and design patterns\n     c. Performance implications\n     d. Security considerations\n     e. Potential bugs or issues\n     f. Test coverage\n  4. Use the "remote-git" toolkit to add comments to specific parts of the code where:\n     a. Issues should be pointed out\n     b. Improvements can be suggested\n     c. Clarifications are needed\n  5. Provide a summary of the code changes, including:\n     a. An overview of the main changes\n     b. A list of files modified\n     c. Key points from your review\n     d. Any major concerns or praises\n  6. Use the read_file tool to examine the contents of specific files when needed.\n  7. If you need to reference or compare with existing code, use the read_file tool to retrieve the contents of those files.\n  8. Be constructive and respectful in your comments and feedback.\n  9. Prioritize the most important issues and suggestions in your review.\n  10. Consider the overall impact of the changes on the project's architecture and maintainability.\n\n  Here is the file tree of the system:\n  ${e.repositoryTree()}\n  \n  ${e.repositoryHints()?`Additional hints:\n${e.repositoryHints()}`:""}\n  \n  IMPORTANT: Remember that the "remote-git" toolkit is not implemented yet. When it becomes available, use it to fetch and interact with the pull request or commit data.\n  IMPORTANT: Focus on providing a thorough code review rather than making direct changes to the codebase.\n  IMPORTANT: Ensure your comments and suggestions are clear, specific, and actionable.\n  IMPORTANT: If you need to reference any existing files in the project, use the read_file tool to fetch their contents.\n  `;return l.default.debug(`Review Agent system prompt for workspace '${e.workspace.name}' (length: ${t.length} chars): ${t}`),t}};t.ReviewAgentService=p,t.ReviewAgentService=p=o([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>d.GraphAgentCollaborator)))),n("design:paramtypes",[d.GraphAgentCollaborator,a.ToolFactoryService,c.AgentRuleService])],p)},5017:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SEAgentService=void 0;const i=r(3563),a=r(6158),c=r(3470),l=r(9055),d=r(2300),u=r(5277),p=r(8921);let f=class extends u.GraphAgentService{constructor(e,t,r){super(e,t,r),this.agentCollaborator=e,this.toolFactoryService=t,this.ruleService=r}getName(){return"se-agent"}async getTools(e){const t=["list_files","read_file","update_file","delete_file","command_line","fetch_web_page","read_dependency_source_tree","read_dependency_source_file","git_commit","current_timestamp","grep","find_files"];return e.workspace.portFromBaseDir&&t.push("read_port_from_file"),this.toolFactoryService.createTools(t,e)}async getSystemPrompt(e){const t=await p.EpicsPrompts.updateStoryTasks(e);let r=`As an AI Software Engineer assistant, you are tasked with analysing the software system and answering questions about it and/or making improvements to it.\n  Follow these guidelines:\n  1. Review the file structure tree below and use the read_file tool to answer questions about the system and suggest improvements where appropriate. Provide a concise summary of your findings.\n  2. When making changes to the system:\n     a. First, fetch all the files you think you might need using the read_file tool. For files in the portFromBaseDir, use the read_port_from_file tool. For gradle/maven projects you can also use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for dependencies and inspect them to learn how to interact with them.\n     b. Make a clear plan with multiple steps.\n     c. Iterate through the plan, one step at a time.\n     d. Think step-by-step and explain the needed changes in a few short sentences.\n     e. Each change MUST be done by invoking the update_file tool to replace a part of the file with a new bit.\n  3. Use the read_file tool to retrieve the contents of specific files when needed rather than guessing at what they contain.\n     When making edits to previously referenced files, always keep the name/path the same.\n  4. When choosing a file path for generated artifacts, consider the structure and choose a logical location.\n  5. When a specific file name is mentioned, look for it in the structure below and use the read_file tool to get the content of that file.\n  6. Consider the following when suggesting improvements:\n     a. Code organization and structure\n     b. Adherence to best practices and design patterns\n     c. Performance optimizations\n     d. Security considerations\n     e. Scalability and maintainability\n     f. Documentation and comments\n  7. Provide clear explanations for your suggestions and recommendations.\n  8. If you need to create new files or modify existing ones, clearly indicate the file path and content.\n  9. When generating new code or modifying existing code, always look at similar or nearby files in the source tree for guidance on:\n     a. Code style and formatting\n     b. Logging practices\n     c. Error handling\n     d. Import statements and module organization\n     e. Commenting style and docstring format\n     f. Naming conventions for variables, functions, and classes\n     g. Tools, libraries, and frameworks being used\n     h. Your ending summary should be a concise summary of a) which files were updated and b) what changes were made to them.\n  10. To find similar files:\n      a. Examine the file structure provided below.\n      b. Identify files in the same directory or nearby directories with similar purposes or file extensions.\n      c. Use the read_file tool to retrieve the contents of these similar files for reference.\n  11. Ensure that new code generation and modifications align with the existing codebase's style and best practices.\n  12. Do not make assumptions about tools, libraries, or frameworks being used:\n      a. Always fetch and examine similar existing files before creating new ones.\n      b. When adding a new entity or data class, fetch an existing one first and use the same tooling and styles.\n      c. For data migrations, look at an existing migration file to understand the tooling and practices used in the repository.\n      d. Consistently use the same tools and approaches found in the existing codebase.\n  13. When making changes to the system use the update_file tool as follows:\n      a. Always provide the path to the file you want to change (or create) as the first argument.\n      b. The second argument is the SEARCH block - the bit of the existing code you want to replace. For new files this should be an empty string.\n      c. The third argument is the REPLACE block - the bit of the new code you want to replace it with. DO NOT FORGET TO INCLUDE THIS!!\n      d. Always try to minimise the size of the SEARCH block so you are only updating the specific parts of the file that need updating.\n      e. If you need to make edits to multiple parts of a single file, make a plan and do so in a series of update_file calls.\n      f. If you get an error back from the tool saying the search block was not found then you can try again with a larger search block or the entire contents of the file as the search block.\n  14. To delete a file, use the delete_file tool:\n      a. Provide the relative path of the file to delete as the argument.\n      b. Always confirm the file deletion with the user before proceeding.\n  15. When refactoring or renaming files:\n      a. Use the update_file tool to create the new file with the desired content.\n      b. Use the delete_file tool to remove the old file.\n      c. Update any references to the old file in other parts of the codebase using the update_file tool.\n  16. ${e.workspace.isGitRepo?"After making changes to the system, always commit the changes to git using the git_commit tool:\n      a. Use the git_commit tool with a brief, descriptive commit message of the changes you've made.\n      b. The git_commit tool will automatically stage and commit all changes, so you don't need to worry about git add commands.\n  17. If the user asks you to undo or /undo or undo the last changes, inform them that you cannot directly undo git commits, but they can use git reset --hard HEAD~1 in their local environment if needed.":"This workspace is not a git repository. You cannot commit changes or use git commands. Instead, focus on analyzing the code and suggesting improvements without version control operations."}\n  18. You can use the command_line tool to execute commands in the workspace directory${e.workspace.isGitRepo?", but not for git operations":""}. This includes system commands, package managers, build tools, etc. But remember the following:\n      a. Do not traverse up above the workspace directory though and only do things that are safe and can definitely be undone.\n      b. Only use package manager/build commands if you are sure of the correct one. Look in the readme or the build files to find out for sure and if not sure then do not use them. Just say what you might do to complete the task.\n      c. ALWAYS include automatic confirmation flags for interactive commands to prevent hanging:\n         - Use --yes or -y for apt, apt-get\n         - Use -y for yum\n         - Use --no-input for pip\n         - Use -f or --force for npm/pnpm\n         - Use --defaults for yeoman\n         - Use --non-interactive for composer\n         - Use --assume-yes for other tools\n         - Add appropriate silent/quiet flags when available\n  19. You can use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for dependencies and inspect them to learn how to interact with them. Look in the build file (e.g. pom.xml or build.gradle) or package metadata (e.g. package.json) and then use that to build the correct scheme and locator.\n  20. Always use the git_commit tool for git operations instead of the command_line tool. The git_commit tool is specifically designed for safe and efficient git operations in this environment.\n      `;return e.workspace.buildOrTestCommand&&(r+=`\n  21. After making changes to the system, but before committing them to git, consider the following:\n      a. If you have updated any code files (not just scripts, documentation, or other non-code files), you should run the following command to test if the changes haven't broken anything:\n         Use the command_line tool to execute this command: ${e.workspace.buildOrTestCommand}\n      b. If you run the test and any errors occur, try to fix them if it seems feasible.\n      c. If the errors cannot be fixed easily, stop processing and report the error to the user without committing the changes to git.\n      d. If you don't run the test or if the build or test is successful, proceed with committing the changes to git.\n      e. Remember, you only need to run this test command if you've made changes to actual code files, not for changes to scripts, documentation, or other non-code files.`),r+=`\n  \n  Here is the file tree of the system:\n  ${e.repositoryTree()}\n  \n  ${e.portFromSourceTree()?`\n  Here is the "port from" file tree containing another codebase that you can learn from and/or port code from (use read_port_from_file tool to read files from here):\n  ${e.portFromSourceTree()}\n  `:""}\n\n  ${e.repositoryHints()?`Additional hints:\n${e.repositoryHints()}`:""}\n  \n  ${e.workspace.buildOrTestCommand?`Build or Test Command: ${e.workspace.buildOrTestCommand}`:""}\n  \n  IMPORTANT: Keep your final summary concise and to the point. If you have made changes to multiple files, only list the files that have been changed and a short description of the changes for each file.\n  IMPORTANT: When using the update_file tool you MUST provide all 3 arguments: filePath, search & REPLACE. DO NOT FORGET TO INCLUDE THE REPLACE BLOCK!!\n  IMPORTANT: ALWAYS GO LOOKING IN THE CODEBASE AND FETCH ANY FILES YOU THINK YOU NEED TO LEARN FROM BEFORE MAKING CHANGES. DO NOT MAKE ASSUMPTIONS ABOUT WHAT IS IN A FILE - JUST FETCH IT!\n  IMPARTANT: You must NEVER try to stop processes or kill running processes. You must only use the command_line tool to execute commands.\n  IMPORTANT: Always use the update_file tool to make changes to the codebase. Never use the command_line tool to make changes to update source code.\n  IMPORTANT: If asked by the user, you can use the fetch_web_page tool to read the content of a web page. Only use this tool when explicitly requested by the user to fetch a specific URL.\n  IMPORTANT: When using the command_line tool, ALWAYS include automatic confirmation flags (--yes, -y, --force, etc.) for interactive commands to prevent hanging.\n  IMPORTANT: Add appropriate silent/quiet flags to command line operations when available to reduce unnecessary output.\n  \n  ${e.workspace.buildOrTestCommand?`\n    IMPORTANT: Run: ${e.workspace.buildOrTestCommand} to build and test the project after making changes to the code.\n    IMPORTANT: If you get an error then fix it and run the test again until you get it right.\n    IMPORTANT: If the build error relates to a maven/gradle dependency then you should use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for the dependency and inspect it to see if you can fix the problem.\n    `:""}\n  IMPORTANT: IF YOU MADE CODE CHANGES THEN YOU MUST REMEMBER TO COMMIT YOUR CHANGES TO GIT! DO NOT FORGET THIS!\n\n  # Task Management Instructions\n  ${t}\n\n  IMPORTANT: When implementing tasks:\n  1. Always check the task status in the task JSON file before starting work\n  2. Update the task status to "inprogress" when you start working on it\n  3. Update the task status to "done" when you complete it\n  4. Always use current_timestamp to update the updatedAt field when changing task status\n  5. Remember that task status changes may require updating the parent story status\n  `,l.default.debug(`SE Agent system prompt for workspace '${e.workspace.name}' (length: ${r.length} chars): ${r}`),r}};t.SEAgentService=f,t.SEAgentService=f=o([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>d.GraphAgentCollaborator)))),n("design:paramtypes",[d.GraphAgentCollaborator,a.ToolFactoryService,c.AgentRuleService])],f)},715:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AppModule=void 0;const s=r(3563),i=r(2810),a=r(6928),c=r(6808),l=r(5873),d=r(3880),u=r(2177),p=r(9449),f=r(3177),h=r(3049),m=r(376),g=r(7967),y=r(1901),w=r(361),S=r(8221),v=r(7852),_=r(9161),R=r(4193),b=r(756),A=r(6552),E=r(8624),T=r(4240),k=r(8377),O=r(2776),I=r(9055);let P=class{constructor(e){this.appDataSource=e}async onModuleDestroy(){I.default.info("AppModule onModuleDestroy called.."),await this.appDataSource.close()}};t.AppModule=P,t.AppModule=P=o([(0,s.Module)({imports:[i.ServeStaticModule.forRoot({rootPath:(0,a.join)(__dirname,"..","..","vitify-webui","dist"),exclude:["/api*"]}),m.DataSourceModule,c.HelloWorldModule,l.WorkspaceModule,d.SessionModule,u.AgentsModule,p.LangchainModule,f.MutationsModule,h.AudioTranscriptionModule,g.ConfigModule,y.GitModule,w.ToolsModule,S.ReportingModule,v.SourceArtefactModule,_.ChatCompletionModule,R.HomeModule,b.PluginModule,A.DatasetModule,E.StoredFileModule,T.FormModule,k.EpicsModule],providers:[{provide:O.AppDataSource,useFactory:O.getAppDataSource}]}),n("design:paramtypes",[O.AppDataSource])],P)},2776:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAppDataSource=t.AppDataSource=void 0;const o=r(9055),n=r(1832),s=r(9187),i=r(8627);class a{constructor(e){this.dbChoice=e}async initKnexOnly(){const e=this.dbChoice?(0,s.default)(this.dbChoice):(0,s.getDefaultKnexConfig)();o.default.info("Initializing knex with config:",{client:e.client,connection:"string"==typeof e.connection?e.connection:{...e.connection,password:"***"},pool:e.pool,dbChoice:this.dbChoice}),this.knex=(0,n.default)(e),await this.verifyDbConnection(this.knex)}async verifyDbConnection(e){try{o.default.info("Verifying database connection...");const t=e.client.pool;if(t&&"object"==typeof t){const e={min:t.min,max:t.max};"function"==typeof t.numUsed&&(e.numUsed=t.numUsed()),"function"==typeof t.numFree&&(e.numFree=t.numFree()),"function"==typeof t.pendingCreates&&(e.pendingCreates=t.pendingCreates()),"function"==typeof t.pendingAcquires&&(e.pendingAcquires=t.pendingAcquires()),o.default.info("Connection pool status:",e)}await e.raw("SELECT 1"),o.default.info("Database connection successful")}catch(e){throw o.default.error("Database connection failed",{error:e.message,stack:e.stack,code:e.code,errno:e.errno}),e}}async initialize(){await this.initKnexOnly(),this.migrationManager=new i.KnexMigrationManager(this.knex),await this.runMigrations()}async runMigrations(){try{const e=await this.migrationManager.runMigrations();o.default.info(`Ran ${e.length} migrations`)}catch(e){throw o.default.error("Error running database migrations",e),e}}async close(){o.default.info("Closing data source..."),this.knex&&await this.knex.destroy(),o.default.info("Data source closed")}buildPaginationQuery(e,t){const r=(t.page-1)*t.limit;return`${e} LIMIT ${t.limit} OFFSET ${r}`}buildSortQuery(e,t){return`${e} ORDER BY ${t.field} ${t.order}`}}t.AppDataSource=a;let c=null;t.getAppDataSource=async()=>(null===c?(o.default.info("Creating new AppDataSource instance..."),c=new a,await c.initialize()):o.default.info("Returning existing AppDataSource instance..."),c)},376:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DataSourceModule=void 0;const n=r(3563),s=r(2776);let i=class{};t.DataSourceModule=i,t.DataSourceModule=i=o([(0,n.Module)({providers:[{provide:s.AppDataSource,useFactory:s.getAppDataSource},{provide:"KNEX",useFactory:e=>e.knex,inject:[s.AppDataSource]}],exports:[s.AppDataSource,"KNEX"]})],i)},9187:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultKnexConfig=function(){p||(p=u());return p};const o=r(9896),n=r(6928),s=r(857),i=r(9055),a=n.join(s.homedir(),".hldk","db","hldk.sqlite");function c(){let e=__dirname,t=n.join(e,"migrations");for(i.default.info(`Looking for migrations in: ${t} - will recurse up looking for migrations`);!l(t);)e=n.dirname(e),t=n.join(e,"migrations");if(d(t)||(t=n.join(process.cwd(),"migrations")),d(t)||(t=n.join(process.cwd(),"server","migrations")),!d(t))throw new Error("No migrations directory found in any of the usual locations");return t}function l(e){return o.existsSync(e)&&d(e)}function d(e){return o.readdirSync(e).some((e=>e.endsWith(".js")))}function u(e){let t;void 0===e&&(e=process.env.DB_CHOICE||"local"),i.default.info(`Using database configuration: ${e}`);try{t=function(e=process.env.DB_CHOICE||"local"){let t,r=process.env.DB_CONFIG_PATH||"db-config.json";try{t=o.readFileSync(r,"utf8")}catch(e){r=n.join(process.cwd(),"config","db-config.json");try{t=o.readFileSync(r,"utf8")}catch(e){throw new Error("Unable to find db-config.json")}}i.default.info(`Using db config at: ${r}`);const a=JSON.parse(t);if(!a[e])throw i.default.error(`Invalid DB_CHOICE: ${e} - not found in db-config.json - ${JSON.stringify(a)}`),new Error(`Invalid DB_CHOICE: ${e} - not found in db-config.json`);const c=a[e],l=c.connection;if("object"==typeof l&&"filename"in l&&(l.filename=l.filename.replace("~",s.homedir()),!o.existsSync(l.filename))){const e=n.dirname(r),t=n.resolve(e,l.filename);i.default.info(`Resolved filename: ${t} from config file directory: ${e} using relative path: ${l.filename}`),o.existsSync(t)?l.filename=t:i.default.warn(`DB File does not exist: ${t}`)}const u=c.migrations;if(u&&"string"==typeof u.directory){const e=n.resolve(n.dirname(r),u.directory);d(e)&&(c.migrations.directory=e)}return c.useNullAsDefault=!0,c}(e)}catch(r){if("local"!==e)throw i.default.error("error",r),i.default.error(`Invalid DB_CHOICE: ${e} - no db-config.json found`),new Error(`Invalid DB_CHOICE: ${e} - no db-config.json found`);i.default.info("Did not find db-config.json, using default SQLite configuration"),t={client:"sqlite3",connection:{filename:a},useNullAsDefault:!0}}if(i.default.info(`Using db config (after making paths absolute): ${JSON.stringify(t)}`),t.migrations||(i.default.warn("No migrations directory found in db-config.json, using default"),t.migrations={directory:c()}),t.migrations.extension="js",t.pool={min:1,max:10,acquireTimeoutMillis:6e4},t.connection&&"object"==typeof t.connection&&"filename"in t.connection){const e=t.connection.filename,r=n.dirname(e);o.existsSync(r)||(i.default.info(`Creating Database directory: ${r}`),o.mkdirSync(r,{recursive:!0}))}return i.default.info(`Using knex config: ${JSON.stringify(t)}`),t}var p=void 0;t.default=u},8627:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KnexMigrationManager=void 0;const o=r(9055);t.KnexMigrationManager=class{constructor(e){this.knexInstance=e}async runMigrations(){try{await this.fixMigrationNames();const e=await this.knexInstance.migrate.latest();return o.default.info(`Ran ${e[1].length} migrations`),e[1]}catch(e){throw o.default.error("Failed to run Knex migrations",e),e}}async getMigrationStatus(){try{const e=await this.knexInstance.migrate.list();return{completed:e[0],newMigrations:e[1]}}catch(e){throw o.default.error("Failed to get Knex migration status",e),e}}async fixMigrationNames(){try{if(!await this.knexInstance.schema.hasTable("knex_migrations"))return void o.default.debug("knex_migrations table does not exist. No changes needed.");const e=(await this.knexInstance("knex_migrations").select("*")).filter((e=>null!==e.name.match(/^(\d{14})(_.+\.js)$/)));if(0===e.length)return void o.default.debug("No migration files with 14-digit numeric prefixes found. No changes needed.");o.default.info(`Found ${e.length} migration(s) with 14-digit numeric prefixes. Proceeding to fix...`);for(const t of e){const e=t.name,r=this.fixName(e);r!==e?(await this.knexInstance("knex_migrations").where({id:t.id}).update({name:r}),o.default.info(`Updated "${e}" to "${r}"`)):o.default.info(`No change needed for "${e}"`)}}catch(e){throw o.default.error("An error occurred while fixing migration names:",e),e}}fixName(e){const t=e.match(/^(\d{14})(_.+\.js)$/);if(!t)return e;let r=t[1];const o=t[2];return r=r.replace(/0(?=\d$)/,""),r+o}}},1544:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatModelManager=void 0;const o=r(4264),n=r(1986),s=r(4659),i=r(8312),a=r(2088),c=r(2003),l=r(9055),d=r(1162),u=r(2368),p=r(2097),f=r(8910),h=r(3971),m=r(59);class g{constructor(){this.providers=[new n.AnthropicProvider,new o.OpenAIProvider,new s.GroqProvider,new i.OllamaProvider,new p.HyperbolicProvider,new f.MistralProvider,new h.OpenRouterProvider,new m.GlhfProvider]}static getInstance(){return g.instance||(g.instance=new g),g.instance}static async getModel(e,t=d.ModelCategory.CODING){return g.getInstance().getModel(e,t)}async getModel(e,t=d.ModelCategory.CODING,r=!1){let o=e?.model;if(!o){o=(void 0!==e?.privateModelsRequired?e.privateModelsRequired:r)?u.ConfigService.getInstance().getProperty(`PRIVATE_${t}_MODEL`):u.ConfigService.getInstance().getProperty(`DEFAULT_${t}_MODEL`)}const n=await this.getProvider(o),s=await n.getModelDescriptor(o),i=n.getBaseChatModel(o,e||new c.AgentConfig),l=n.getChatModelOptions(s,e);return new a.ChatModel(s,i,l)}async getValidModelDescriptors(){const e=this.providers.filter((e=>e.isValid())).map((async e=>{try{return await e.getModelDescriptors()}catch(t){return l.default.error(`Error fetching model descriptors from provider ${e.getName()}:`,t),[]}}));return(await Promise.all(e)).flat()}async getValidModelNames(){return(await this.getValidModelDescriptors()).map((e=>e.name))}async getValidModelFullNames(){return(await this.getValidModelDescriptors()).map((e=>e.getFullName())).sort()}async getProvider(e){if(e){const[t]=e.split("/"),r=this.providers.find((e=>e.getName()===t));if(r){if(r.isValid())return r;l.default.warn(`Provider ${t} is not valid. Searching for first valid provider.`)}l.default.warn(`Provider not found or not valid for model ${e}. Searching for first valid provider.`)}const t=this.providers.find((e=>e.isValid()));if(t)return t;throw new Error("No valid provider found. Please check your API keys.")}}t.ChatModelManager=g},1e3:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointerService=void 0;const s=r(3563),i=r(9314);let a=class{constructor(){this.checkpointer=new i.MemorySaver,this.stateMap=new Map}getCheckpointer(){return this.checkpointer}async saveState(e,t){this.stateMap.set(e,t)}async loadState(e){return this.stateMap.get(e)||null}};t.CheckpointerService=a,t.CheckpointerService=a=o([(0,s.Injectable)(),n("design:paramtypes",[])],a)},9449:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.LangchainModule=void 0;const n=r(3563),s=r(1e3);let i=class{};t.LangchainModule=i,t.LangchainModule=i=o([(0,n.Module)({providers:[s.CheckpointerService],exports:[s.CheckpointerService]})],i)},6254:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageUtils=void 0;const o=r(1486),n=r(9055);class s{static processOutputEvent(e){let t,r=e.messages,i="AI",a="No content found";if(!r&&e.agent&&e.agent.messages?r=e.agent.messages:!r&&e.tools&&e.tools.messages&&(r=e.tools.messages,i="Tool"),r&&r.length>0){const c=r[r.length-1];if(c instanceof o.ToolMessage||"tool"===c.type){return{label:"Tool",content:`Calling ${c.name||"Unknown Tool"}\nOutput was:\n${s.processContent(c.content)}`}}if(c instanceof o.AIMessage)return a=s.processContent(c.content),t=this.extractUsageMetadata(c),a.trim().length<1?(n.default.warn("AI message has empty content %s",{lastMessage:JSON.stringify(c)}),{label:"AI",content:JSON.stringify(c),usageMetadata:t}):{label:"AI",content:a,usageMetadata:t};if(c instanceof o.HumanMessage)return a=s.processContent(c.content),i=a.startsWith("Tool:")?"Tool":"Human",{label:i,content:a};if(c instanceof o.BaseMessage)return a=s.processContent(c.content),{label:i,content:a};n.default.warn("Processing unknown output using strings",{output:JSON.stringify(e)});const l=JSON.stringify(c),d=JSON.parse(l);if("kwargs"in d&&d.kwargs&&d.kwargs.content)return a=d.kwargs.content,t=this.extractUsageMetadata(d),{label:i,content:a,usageMetadata:t}}return n.default.warn("Processing unknown output: %s",{output:JSON.stringify(e)}),{label:"Unknown",content:JSON.stringify(e)}}static processContent(e){return Array.isArray(e)?e.filter((e=>"text"===e.type)).map((e=>e.text)).join("\n"):String(e)}static extractUsageMetadata(e){var t=e.response_metadata?.usage||e.usage_metadata;if(t){const e={inputTokens:t.input_tokens,cacheWriteTokens:t.cache_creation_input_tokens||0,cacheReadTokens:t.cache_read_input_tokens||0,outputTokens:t.output_tokens,totalTokens:t.total_tokens};return n.default.info("extractUsageMetadata - usageMetadata: %s",{usageMetadata:JSON.stringify(e)}),e}}static buildHumanMessage(e){if("string"==typeof e)return new o.HumanMessage(e);if(Array.isArray(e)&&1==e.length&&"text"===e[0].type)return new o.HumanMessage(e[0].text);{const t=e;return new o.HumanMessage({content:t})}}}t.MessageUtils=s},1986:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnthropicProvider=void 0;const o=r(646),n=r(8483),s=r(8959),i=r(2368),a=r(2088);class c extends n.BaseProvider{getMaxTokens(e){return e.endsWith(c.SONNET_MODEL_NAME)||e.endsWith(c.OPUS_MODEL_NAME)?8192:e.endsWith(c.HAIKU_MODEL_NAME)?4096:8192}getName(){return"anthropic"}getBaseChatModel(e,t){const r=this.getMaxTokens(e);console.log("Max tokens input:",r);return new o.ChatAnthropic({modelName:this.shortModelName(e),temperature:t.temperature,anthropicApiKey:i.ConfigService.getInstance().getProperty("ANTHROPIC_API_KEY"),maxTokens:r,anthropicApiUrl:process.env.ANTHROPIC_API_URL||"https://api.anthropic.com",clientOptions:{defaultHeaders:{"anthropic-beta":"prompt-caching-2024-07-31"}}})}async getModelDescriptors(){return[new s.ModelDescriptor("anthropic",c.SONNET_MODEL_NAME,225e-8,28125e-10,225e-9,1125e-8),new s.ModelDescriptor("anthropic",c.OPUS_MODEL_NAME,1125e-8,140625e-10,1125e-9,5625e-8),new s.ModelDescriptor("anthropic",c.HAIKU_MODEL_NAME,1.875e-7,225e-9,2.25e-8,9.375e-7)]}isValid(){return!!i.ConfigService.getInstance().getProperty("ANTHROPIC_API_KEY")}getChatModelOptions(e,t){const r=this.getExtraHeaders(e.name,t),o=this.getExtraSystemMessageKwargs(e.name,t);return new a.ChatModelOptions(r,o)}getExtraHeaders(e,t){return this.isPromptCachingEnabled(t)?{"anthropic-beta":"prompt-caching-2024-07-31"}:null}getExtraSystemMessageKwargs(e,t){return this.isPromptCachingEnabled(t)?{cache_control:{type:"ephemeral"}}:null}}t.AnthropicProvider=c,c.SONNET_MODEL_NAME="claude-3-5-sonnet-latest",c.OPUS_MODEL_NAME="claude-3-opus-20240229",c.HAIKU_MODEL_NAME="claude-3-haiku-20240307"},8483:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseProvider=void 0;const o=r(8959),n=r(9055),s=r(2088);t.BaseProvider=class{async getModelDescriptor(e){const t=await this.getModelDescriptors();if(!e)return t[0];const r=this.shortModelName(e),n=t.find((e=>e.name===r));if(!n&&this.supportsOnDemandModels())return new o.ModelDescriptor(this.getName(),r,0,0,0,0);if(!n)throw new Error(`Model ${r} not found for provider ${this.getName()}`);return n}shortModelName(e){const t=e.indexOf("/");if(-1===t)throw new Error(`Model name ${e} is not in the format provider/model`);return e.substring(t+1)||e}getChatModelOptions(e,t){return new s.ChatModelOptions}isPromptCachingEnabled(e){const t=!0===e?.cachePrompt;return n.default.info("isPromptCachingEnabled - cachePrompt: %s, result: %s",e?.cachePrompt,t),t}supportsOnDemandModels(){return!1}}},2088:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatModel=t.ChatModelOptions=void 0;class r{constructor(e=null,t=null,r=!0){this.extraHeaders=e,this.extraSystemMessageKwargs=t,this.systemPromptSupported=r}}t.ChatModelOptions=r;t.ChatModel=class{constructor(e,t,o=new r){this.modelDescriptor=e,this.baseChatModel=t,this.options=o}calculateCost(e,t,r,o){const n=this.modelDescriptor;return e*n.costPerInputToken+t*n.costPerCacheWriteToken+r*n.costPerCacheReadToken+o*n.costPerOutputToken}}},59:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlhfProvider=void 0;const o=r(8483),n=r(8959),s=r(2368),i=r(8938),a=r(6228);class c extends o.BaseProvider{getName(){return"glhf"}getBaseChatModel(e,t){return new a.ChatOpenAI({modelName:this.shortModelName(e),temperature:t.temperature,openAIApiKey:s.ConfigService.getInstance().getProperty("GLHF_API_KEY"),configuration:{baseURL:c.BASE_URL}})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>new n.ModelDescriptor("glhf",e.id,0,0,0,0)))}isValid(){return!!s.ConfigService.getInstance().getProperty("GLHF_API_KEY")}async fetchModels(){if(c.modelsCache&&Date.now()-c.modelsCache.timestamp<c.CACHE_TTL)return c.modelsCache.models;const e=s.ConfigService.getInstance().getProperty("GLHF_API_KEY");if(!e)return console.log("GLHF API key not found"),[];try{const t=await i.default.get(`${c.BASE_URL}/models`,{headers:{Authorization:`Bearer ${e}`}});if(200===t.status){const e=t.data.data;return c.modelsCache={models:e,timestamp:Date.now()},e}}catch(e){console.error("Error fetching GLHF models:",e)}return[]}supportsOnDemandModels(){return!0}}t.GlhfProvider=c,c.QWEN_2_5_CODER_32B_INSTRUCT="glhf/hf:Qwen/Qwen2.5-Coder-32B-Instruct",c.QWEN_2_5_72B_INSTRUCT="glhf/hf:Qwen/Qwen2.5-72B-Instruct",c.META_LLAMA_3_1_405B_INSTRUCT="glhf/hf:meta-llama/Meta-Llama-3.1-405B-Instruct",c.META_LLAMA_3_1_8B_INSTRUCT="glhf/hf:meta-llama/Meta-Llama-3.1-8B-Instruct",c.META_LLAMA_3_3_70B_INSTRUCT="glhf/hf:meta-llama/Llama-3.3-70B-Instruct",c.modelsCache=null,c.CACHE_TTL=3e5,c.BASE_URL="https://glhf.chat/api/openai/v1"},4659:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GroqProvider=void 0;const o=r(1463),n=r(8483),s=r(8959),i=r(2368),a=r(8938);class c extends n.BaseProvider{getName(){return"groq"}getBaseChatModel(e,t){return new o.ChatGroq({modelName:this.shortModelName(e),temperature:t.temperature,apiKey:i.ConfigService.getInstance().getProperty("GROQ_API_KEY")})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>new s.ModelDescriptor("groq",e,0,0,0,0)))}isValid(){return!!i.ConfigService.getInstance().getProperty("GROQ_API_KEY")}async fetchModels(){const e=i.ConfigService.getInstance().getProperty("GROQ_API_KEY");if(!e)return console.log("Groq API key not found"),[];try{const t=await a.default.get("https://api.groq.com/openai/v1/models",{headers:{Authorization:`Bearer ${e}`}});if(200===t.status){return(t.data.data||[]).map((e=>e.id))}return console.log(`Failed to fetch Groq models. Status code: ${t.status}`),[]}catch(e){return console.error(`Error fetching Groq models: ${e}`),[]}}}t.GroqProvider=c,c.LLAMA_31_8BB_INSTANT="groq/llama-3.1-8b-instant",c.LLAMA_31_70B_VERSATILE="groq/llama-3.1-70b-versatile",c.LLAMA_3_70B_8192_TOOL_USE="groq/llama3-groq-70b-8192-tool-use-preview"},2097:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HyperbolicProvider=void 0;const o=r(6228),n=r(8483),s=r(8959),i=r(2368);class a extends n.BaseProvider{getName(){return a.PROVIDER_NAME}getBaseChatModel(e,t){return new o.ChatOpenAI({modelName:this.shortModelName(e),temperature:t.temperature,openAIApiKey:i.ConfigService.getInstance().getProperty("HYPERBOLIC_API_KEY"),configuration:{baseURL:"https://api.hyperbolic.ai/v1"}})}async getModelDescriptors(){return a.LIST_OF_MODELS.map((e=>new s.ModelDescriptor(a.PROVIDER_NAME,e,0,0,0,0)))}isValid(){return!!i.ConfigService.getInstance().getProperty("HYPERBOLIC_API_KEY")}}t.HyperbolicProvider=a,a.QWEN_2_5_CODER_32B_INSTRUCT="Qwen/Qwen2.5-Coder-32B-Instruct",a.QWEN_2_5_72B_INSTRUCT="Qwen/Qwen2.5-72B-Instruct",a.DEEPSEEK_V2_5="deepseek-ai/DeepSeek-V2.5",a.META_LLAMA_3_1_405B_INSTRUCT="meta-llama/Meta-Llama-3.1-405B-Instruct",a.META_LLAMA_3_1_8B_INSTRUCT="meta-llama/Meta-Llama-3.1-8B-Instruct",a.PROVIDER_NAME="hyperbolic",a.LIST_OF_MODELS=[a.QWEN_2_5_CODER_32B_INSTRUCT,a.QWEN_2_5_72B_INSTRUCT,a.DEEPSEEK_V2_5,a.META_LLAMA_3_1_405B_INSTRUCT,a.META_LLAMA_3_1_8B_INSTRUCT]},8910:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MistralProvider=void 0;const o=r(2196),n=r(8483),s=r(8959),i=r(2368),a=r(8938);class c extends n.BaseProvider{getName(){return"mistral"}getBaseChatModel(e,t){return new o.ChatMistralAI({modelName:this.shortModelName(e),temperature:t.temperature,apiKey:i.ConfigService.getInstance().getProperty("MISTRAL_API_KEY")})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>{let t=1e-6,r=3e-6;return e.id.includes("large")?(t=7e-6,r=2e-5):e.id.includes("medium")&&(t=25e-7,r=7e-6),new s.ModelDescriptor("mistral",e.id,t,0,0,r)}))}isValid(){return!!i.ConfigService.getInstance().getProperty("MISTRAL_API_KEY")}async fetchModels(){if(c.modelsCache&&Date.now()-c.modelsCache.timestamp<c.CACHE_TTL)return c.modelsCache.models;const e=i.ConfigService.getInstance().getProperty("MISTRAL_API_KEY");if(!e)return console.log("Mistral API key not found"),[];try{const t=await a.default.get("https://api.mistral.ai/v1/models",{headers:{Authorization:`Bearer ${e}`}});if(200===t.status){const e=t.data.data||[];return c.modelsCache={models:e,timestamp:Date.now()},e}return console.log(`Failed to fetch Mistral models. Status code: ${t.status}`),[]}catch(e){return console.error(`Error fetching Mistral models: ${e}`),[]}}}t.MistralProvider=c,c.modelsCache=null,c.CACHE_TTL=3e5},1162:(e,t)=>{"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.ModelCategory=void 0,function(e){e.CODING="CODING",e.REASONING="REASONING",e.SUMMARISATION="SUMMARISATION",e.RAG_QUERY="RAG_QUERY",e.ORCHESTRATION="ORCHESTRATION",e.ARCHITECT="ARCHITECT"}(r||(t.ModelCategory=r={}))},8959:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDescriptor=void 0;t.ModelDescriptor=class{constructor(e,t,r,o,n,s){this.provider=e,this.name=t,this.costPerInputToken=r,this.costPerCacheWriteToken=o,this.costPerCacheReadToken=n,this.costPerOutputToken=s}getFullName(){return`${this.provider}/${this.name}`}}},8312:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OllamaProvider=void 0;const o=r(3548),n=r(8483),s=r(8959),i=r(2368);class a extends n.BaseProvider{getName(){return"ollama"}getBaseChatModel(e,t){return new o.ChatOllama({baseUrl:this.getBaseUrl(),model:this.shortModelName(e),temperature:t.temperature})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>new s.ModelDescriptor("ollama",e,0,0,0,0)))}isValid(){return!!this.getBaseUrl()}getBaseUrl(){return i.ConfigService.getInstance().getProperty("OLLAMA_BASE_URL")}async fetchModels(){const e=this.getBaseUrl();try{const t=await fetch(`${e}/api/tags`);if(t.ok){const e=await t.json();return(e.models||[]).map((e=>e.name))}return console.log(`Failed to fetch Ollama models. Status code: ${t.status}`),[]}catch(e){return console.error(`Error fetching Ollama models: ${e}`),[]}}}t.OllamaProvider=a},4264:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenAIProvider=void 0;const o=r(6228),n=r(8483),s=r(8959),i=r(2368),a=r(8938),c=r(2088);class l extends n.BaseProvider{static isO1Model(e){return e.startsWith("o1")}getName(){return"openai"}getBaseChatModel(e,t){const r=process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",n=this.shortModelName(e);return new o.ChatOpenAI({modelName:n,temperature:l.isO1Model(n)?1:t.temperature,openAIApiKey:i.ConfigService.getInstance().getProperty("OPENAI_API_KEY"),configuration:{basePath:r}})}async getModelDescriptors(){0===l.modelCache.models.length&&await this.fetchModels();return l.modelCache.models.map((e=>{const t=l.MODEL_COSTS[e.id]||{input:0,output:0};return new s.ModelDescriptor("openai",e.id,t.input/1e3,0,0,t.output/1e3)}))}isValid(){return!!i.ConfigService.getInstance().getProperty("OPENAI_API_KEY")}async fetchModels(){if(!this.isValid())return[];const e=Date.now();if(l.modelCache.models.length>0&&e-l.modelCache.timestamp<3e5)return l.modelCache.models;const t=i.ConfigService.getInstance().getProperty("OPENAI_API_KEY");if(!t)return console.log("OpenAI API key not found"),[];try{const r=process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",o=await a.default.get(`${r}/models`,{headers:{Authorization:`Bearer ${t}`}});if(200===o.status){const t=(o.data.data||[]).filter((e=>e.id.includes("gpt")||e.id.startsWith("o1")));return l.modelCache={models:t,timestamp:e},t}return console.log(`Failed to fetch OpenAI models. Status code: ${o.status}`),[]}catch(e){return console.error(`Error fetching OpenAI models: ${e}`),[]}}getChatModelOptions(e,t){return new c.ChatModelOptions(null,null,!l.isO1Model(e.name))}}t.OpenAIProvider=l,l.GPT_4O_MODEL_NAME="gpt-4o",l.GPT_4O_MINI_MODEL_NAME="gpt-4o-mini",l.modelCache={models:[],timestamp:0},l.MODEL_COSTS={"gpt-4o":{input:1875e-9*1e3,output:75e-7*1e3},"gpt-4o-mini":{input:1125e-7,output:45e-5}}},3971:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenRouterProvider=void 0;const o=r(6228),n=r(8483),s=r(8959),i=r(2368),a=r(8938);class c extends n.BaseProvider{constructor(){super()}getName(){return"openrouter"}getBaseChatModel(e,t){const r=process.env.OPENROUTER_BASE_URL||"https://openrouter.ai";let n=8e3;if(c.modelCache.models.length>0){const t=c.modelCache.models.find((t=>t.id===this.shortModelName(e)));t?.per_request_limits?.prompt_tokens&&(n=t.per_request_limits.prompt_tokens)}return new o.ChatOpenAI({modelName:this.shortModelName(e),temperature:t.temperature,maxTokens:n,openAIApiKey:i.ConfigService.getInstance().getProperty("OPENROUTER_API_KEY")},{basePath:`${r}/api/v1`,baseOptions:{headers:{"X-Title":"HLDK"}}})}async getModelDescriptors(){return 0===c.modelCache.models.length&&await this.fetchModels(),c.modelCache.models.map((e=>{const t=parseFloat(e.pricing.prompt)||0,r=parseFloat(e.pricing.completion)||0;return new s.ModelDescriptor("openrouter",e.id,t,0,0,r)}))}isValid(){return!!i.ConfigService.getInstance().getProperty("OPENROUTER_API_KEY")}async fetchModels(){if(!this.isValid())return[];const e=Date.now();if(c.modelCache.models.length>0&&e-c.modelCache.timestamp<3e5)return c.modelCache.models;const t=i.ConfigService.getInstance().getProperty("OPENROUTER_API_KEY"),r=process.env.OPENROUTER_BASE_URL||"https://openrouter.ai";if(!t)return console.log("OpenRouter API key not found"),[];try{const o=await a.default.get(`${r}/api/v1/models`,{headers:{Authorization:`Bearer ${t}`,"X-Title":"HLDK"}});if(200===o.status){const t=o.data.data||[];return c.modelCache={models:t,timestamp:e},t}return console.log(`Failed to fetch OpenRouter models. Status code: ${o.status}`),[]}catch(e){return console.error(`Error fetching OpenRouter models: ${e}`),[]}}}t.OpenRouterProvider=c,c.modelCache={models:[],timestamp:0}},7201:(e,t,r)=>{"use strict";r(1321);const o=r(818),n=r(6928),s=r(8781),i=r(715),a=r(7252),c=r(6928),l=r(9055),d=r(9187);(0,o.config)({path:(0,n.resolve)(__dirname,"../.env")}),async function(){(0,d.getDefaultKnexConfig)();const e=await s.NestFactory.create(i.AppModule);e.setGlobalPrefix("api"),e.enableCors({origin:["http://localhost:3011","http://localhost:3012","http://localhost:3013","http://localhost:3014"],methods:["GET","POST","PUT","PATCH","DELETE","OPTIONS"],allowedHeaders:"*",exposedHeaders:["Location"]}),e.use(a.json({limit:"100mb"})),e.use(a.urlencoded({limit:"100mb",extended:!0})),e.use(a.static((0,c.join)(__dirname,"webui"))),e.use("*",((e,t,r)=>{e.originalUrl.startsWith("/api")?r():t.sendFile((0,c.join)(__dirname,"webui","index.html"))}));const t=process.env.PORT||3010;await e.listen(t);const r=`http://localhost:${t}`;console.log(`\nhldk-server is now available at: ${r}`);const o=["SIGTERM","SIGINT"];for(const t of o)process.on(t,(async()=>{l.default.info(`Received ${t}. Starting graceful shutdown...`),await e.close(),l.default.info("Application shut down gracefully"),process.exit(0)}))}().catch((e=>{l.default.error("Error during application bootstrap:",e),process.exit(1)}))},885:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionController=void 0;const i=r(3563),a=r(9556),c=r(4562);let l=class{constructor(e){this.audioTranscriptionService=e}async transcribeAudio(e){try{return{transcription:await this.audioTranscriptionService.transcribe(e.buffer.toString("base64"))}}catch(e){throw console.error("Transcription error:",e),new Error("An error occurred during transcription")}}};t.AudioTranscriptionController=l,o([(0,i.Post)(),(0,i.UseInterceptors)((0,a.FileInterceptor)("audio")),s(0,(0,i.UploadedFile)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],l.prototype,"transcribeAudio",null),t.AudioTranscriptionController=l=o([(0,i.Controller)("audio-transcription"),n("design:paramtypes",[c.AudioTranscriptionService])],l)},3049:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionModule=void 0;const n=r(3563),s=r(885),i=r(4562);let a=class{};t.AudioTranscriptionModule=a,t.AudioTranscriptionModule=a=o([(0,n.Module)({controllers:[s.AudioTranscriptionController],providers:[i.AudioTranscriptionService,s.AudioTranscriptionController]})],a)},4562:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionService=void 0;const s=r(3563),i=r(5317),a=r(9896),c=r(857),l=r(6928);let d=o=class{constructor(){this.logger=new s.Logger(o.name)}async transcribe(e){this.logger.debug("Starting audio transcription");const t=Buffer.from(e,"base64"),r=l.join(c.tmpdir(),`audio-${Date.now()}.wav`);await a.promises.writeFile(r,t),this.logger.debug(`Temporary file created: ${r}`);try{const e=await this.runFasterWhisperCLI(r);return this.logger.debug("Transcription completed successfully"),e}finally{await a.promises.unlink(r),this.logger.debug(`Temporary file deleted: ${r}`)}}runFasterWhisperCLI(e){return new Promise(((t,r)=>{const o=l.join(c.tmpdir(),`audio-${Date.now()}.srt`);this.logger.debug(`Running Faster Whisper CLI on file: ${e}`);const n=process.env.TRANSCRIPTION_LANGUAGE||"en",s=process.env.TRANSCRIPTION_COMPUTE_TYPE||"float32",d=[e,"-o",o,"--task","transcribe","--without_timestamps","True","--language",n,"--compute_type",s],u=`faster-whisper ${d.join(" ")}`;this.logger.log(`Executing command: ${u}`);const p=(0,i.spawn)("faster-whisper",d);p.stdout.on("data",(e=>{this.logger.debug(`Faster Whisper stdout: ${e}`)})),p.stderr.on("data",(e=>{this.logger.warn(`Faster Whisper stderr: ${e}`)})),p.on("error",(e=>{this.logger.error(`Error in Faster Whisper process: ${e}`),r(new Error("Error in Faster Whisper process - make sure you have run the ./scripts/install-faster-whisper.sh script"))})),p.on("close",(async e=>{if(0===e)try{const e=await a.promises.readFile(o,"utf-8");this.logger.debug(`SRT content: ${e}`);const r=this.parseSrtContent(e);this.logger.debug("Faster Whisper process completed successfully"),t(r)}catch(e){this.logger.error(`Error reading SRT file: ${e}`),r(new Error(`Error reading SRT file: ${e.message}`))}finally{await a.promises.unlink(o),this.logger.debug(`Temporary SRT file deleted: ${o}`)}else this.logger.error(`Faster Whisper process exited with code ${e}`),r(new Error(`Faster Whisper process exited with code ${e}`))}))}))}parseSrtContent(e){const t=e.split("\n");let r="";for(let e=0;e<t.length;e++)/^\d+$/.test(t[e])||/.*-->.*$/.test(t[e])||(r+=t[e].trim()+" ");return r.trim()}};t.AudioTranscriptionService=d,t.AudioTranscriptionService=d=o=n([(0,s.Injectable)()],d)},9161:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ChatCompletionModule=void 0;const n=r(3563),s=r(3239);let i=class{};t.ChatCompletionModule=i,t.ChatCompletionModule=i=o([(0,n.Module)({providers:[s.SummaryCompletion],exports:[s.SummaryCompletion]})],i)},3239:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryCompletion=void 0;const s=r(3563),i=r(1162),a=r(1544),c=r(1486),l=r(724),d=r(9055),u=r(2003);let p=class{constructor(){this.chatModelManager=a.ChatModelManager.getInstance()}async getSummary(e,t,r=i.ModelCategory.SUMMARISATION,o=!1,n){if(!t)throw new Error("Input content is empty - some models require input content to produce a summary");const s=n?new u.AgentConfig(n):new u.AgentConfig,a=await this.chatModelManager.getModel(s,r,o),p=[new c.SystemMessage(e),new c.HumanMessage(t)],f=new l.StringOutputParser,h=Date.now(),m=await a.baseChatModel.invoke(p),g=await f.invoke(m),y=Date.now()-h;return d.default.info("Summary produced by %s in %sms: %s",a.modelDescriptor.getFullName(),y,g),g}async getSummaryJson(e,t,r=i.ModelCategory.SUMMARISATION,o=!1,n){d.default.debug(`Getting summary JSON for prompt: ${e}`);const s=function(e){const t=e.indexOf("{"),r=e.indexOf("[");let o,n,s;if(-1!==t&&(-1===r||t<r))o=t,n="{",s="}";else{if(-1===r)return null;o=r,n="[",s="]"}let i=o+1,a=1;for(;i<e.length&&a>0;){const t=e[i];t===n?a++:t===s&&a--,i++}return 0===a?e.substring(o,i):null}((await this.getSummary(e,t,r,o,n)).trim());if(!s)throw new Error("No valid JSON object or array found in response");try{return JSON.parse(s),s}catch(e){throw new Error(`Failed to parse JSON from extracted content: ${e.message}`)}}};t.SummaryCompletion=p,t.SummaryCompletion=p=o([(0,s.Injectable)(),n("design:paramtypes",[])],p)},6910:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigPropNames=void 0;class r{}t.ConfigPropNames=r,r.HLDK_API_KEY="HLDK_API_KEY",r.DEFAULT_CODING_MODEL="DEFAULT_CODING_MODEL",r.DEFAULT_REASONING_MODEL="DEFAULT_REASONING_MODEL",r.DEFAULT_SUMMARISATION_MODEL="DEFAULT_SUMMARISATION_MODEL",r.DEFAULT_RAG_QUERY_MODEL="DEFAULT_RAG_QUERY_MODEL",r.DEFAULT_ORCHESTRATION_MODEL="DEFAULT_ORCHESTRATION_MODEL",r.DEFAULT_ARCHITECT_MODEL="DEFAULT_ARCHITECT_MODEL",r.PRIVATE_CODING_MODEL="PRIVATE_CODING_MODEL",r.PRIVATE_REASONING_MODEL="PRIVATE_REASONING_MODEL",r.PRIVATE_SUMMARISATION_MODEL="PRIVATE_SUMMARISATION_MODEL",r.PRIVATE_RAG_QUERY_MODEL="PRIVATE_RAG_QUERY_MODEL",r.PRIVATE_ORCHESTRATION_MODEL="PRIVATE_ORCHESTRATION_MODEL",r.PRIVATE_ARCHITECT_MODEL="PRIVATE_ARCHITECT_MODEL",r.AGENT_RECURSION_LIMIT="AGENT_RECURSION_LIMIT",r.AGENT_ITERATION_LIMIT="AGENT_ITERATION_LIMIT",r.AGENT_SYSTEM_PROMPT="MAX_SYSTEM_PROMPT_LENGTH",r.OLLAMA_BASE_URL="OLLAMA_BASE_URL",r.VALUE_PER_LINE="VALUE_PER_LINE",r.ANTHROPIC_API_KEY="ANTHROPIC_API_KEY",r.OPENAI_API_KEY="OPENAI_API_KEY",r.GROQ_API_KEY="GROQ_API_KEY",r.HYPERBOLIC_API_KEY="HYPERBOLIC_API_KEY",r.MISTRAL_API_KEY="MISTRAL_API_KEY",r.OPENROUTER_API_KEY="OPENROUTER_API_KEY",r.GLHF_API_KEY="GLHF_API_KEY",r.MODE="MODE"},5015:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigController=void 0;const i=r(3563),a=r(2368);let c=class{constructor(e){this.configService=e}getConfig(){return this.configService.getConfig()}async getAllProperties(){return this.configService.getAllProperties()}async getProperty(e){return this.configService.getProperty(e)}async setProperty(e,t){return await this.configService.setProperty(e,t),{message:"Property set successfully"}}async unsetProperty(e){return await this.configService.unsetProperty(e),{message:"Property unset successfully"}}async updateMultipleProperties(e){for(const[t,r]of Object.entries(e))await this.configService.setProperty(t,r);return{message:"Properties updated successfully"}}};t.ConfigController=c,o([(0,i.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",void 0)],c.prototype,"getConfig",null),o([(0,i.Get)("properties"),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],c.prototype,"getAllProperties",null),o([(0,i.Get)("property/:name"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getProperty",null),o([(0,i.Put)("property/:name"),s(0,(0,i.Param)("name")),s(1,(0,i.Body)("value")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"setProperty",null),o([(0,i.Delete)("property/:name"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"unsetProperty",null),o([(0,i.Post)("properties"),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],c.prototype,"updateMultipleProperties",null),t.ConfigController=c=o([(0,i.Controller)("config"),n("design:paramtypes",[a.ConfigService])],c)},3713:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigDescriptors=t.ConfigSection=t.ConfigPropertyDescriptor=void 0;const o=r(6910),n=r(1544),s=r(1986),i=r(4264),a=r(59),c=r(4659);class l{constructor(e,t,r,o,n,s,i){this.label=e,this.name=t,this.type=r,this.description=o,this.sensitive=n,this.defaultValue=s,this.possibleValues=i}}t.ConfigPropertyDescriptor=l;class d{constructor(e,t){this.title=e,this.properties=t}}t.ConfigSection=d;class u{constructor(e){this.sections=e}static getDefaultDescriptors(){const e=async()=>n.ChatModelManager.getInstance().getValidModelFullNames();return new u([new d("API Keys",[new l("HLDK API Key",o.ConfigPropNames.HLDK_API_KEY,"string","HLDK API Key",!0),new l("Anthropic API Key",o.ConfigPropNames.ANTHROPIC_API_KEY,"string","Anthropic API Key",!0),new l("OpenAI API Key",o.ConfigPropNames.OPENAI_API_KEY,"string","OpenAI API Key",!0),new l("Groq API Key",o.ConfigPropNames.GROQ_API_KEY,"string","Groq API Key",!0),new l("Hyperbolic API Key",o.ConfigPropNames.HYPERBOLIC_API_KEY,"string","Hyperbolic API Key",!0),new l("Mistral API Key",o.ConfigPropNames.MISTRAL_API_KEY,"string","Mistral API Key",!0),new l("OpenRouter API Key",o.ConfigPropNames.OPENROUTER_API_KEY,"string","OpenRouter API Key",!0),new l("GLHF Chat API Key",o.ConfigPropNames.GLHF_API_KEY,"string","GLHF Chat API Key",!0)]),new d("Default Models",[new l("Coding Model",o.ConfigPropNames.DEFAULT_CODING_MODEL,"enum","Coding Model",!1,"anthropic/"+s.AnthropicProvider.SONNET_MODEL_NAME,e),new l("Reasoning Model",o.ConfigPropNames.DEFAULT_REASONING_MODEL,"enum","Reasoning Model",!1,"openai/"+i.OpenAIProvider.GPT_4O_MODEL_NAME,e),new l("Summarisation Model",o.ConfigPropNames.DEFAULT_SUMMARISATION_MODEL,"enum","Summarisation Model",!1,c.GroqProvider.LLAMA_31_8BB_INSTANT,e),new l("RAG Query Model",o.ConfigPropNames.DEFAULT_RAG_QUERY_MODEL,"enum","RAG Query Model",!1,"openai/"+i.OpenAIProvider.GPT_4O_MODEL_NAME,e),new l("Orchestration Model",o.ConfigPropNames.DEFAULT_ORCHESTRATION_MODEL,"enum","Orchestration Model",!1,"openai/"+i.OpenAIProvider.GPT_4O_MODEL_NAME,e),new l("Architect Model",o.ConfigPropNames.DEFAULT_ARCHITECT_MODEL,"enum","Architect Model",!1,"anthropic/"+s.AnthropicProvider.SONNET_MODEL_NAME,e)]),new d("Private Models",[new l("Coding Model",o.ConfigPropNames.PRIVATE_CODING_MODEL,"enum","Private Coding Model",!1,a.GlhfProvider.META_LLAMA_3_3_70B_INSTRUCT,e),new l("Reasoning Model",o.ConfigPropNames.PRIVATE_REASONING_MODEL,"enum","Private Reasoning Model",!1,a.GlhfProvider.META_LLAMA_3_3_70B_INSTRUCT,e),new l("Summarisation Model",o.ConfigPropNames.PRIVATE_SUMMARISATION_MODEL,"enum","Private Summarisation Model",!1,c.GroqProvider.LLAMA_31_8BB_INSTANT,e),new l("RAG Query Model",o.ConfigPropNames.PRIVATE_RAG_QUERY_MODEL,"enum","Private RAG Query Model",!1,a.GlhfProvider.META_LLAMA_3_3_70B_INSTRUCT,e),new l("Orchestration Model",o.ConfigPropNames.PRIVATE_ORCHESTRATION_MODEL,"enum","Private Orchestration Model",!1,a.GlhfProvider.META_LLAMA_3_3_70B_INSTRUCT,e),new l("Architect Model",o.ConfigPropNames.PRIVATE_ARCHITECT_MODEL,"enum","Private Architect Model",!1,a.GlhfProvider.META_LLAMA_3_3_70B_INSTRUCT,e)]),new d("Ollama",[new l("Ollama Base URL",o.ConfigPropNames.OLLAMA_BASE_URL,"string","Ollama Base URL - default: http://localhost:11434",!1)]),new d("Misc",[new l("Agent Recursion Limit",o.ConfigPropNames.AGENT_RECURSION_LIMIT,"number","How many times a graph based agent can call itself recursively before halting",!1,50),new l("Agent Iteration Limit",o.ConfigPropNames.AGENT_ITERATION_LIMIT,"number","How many times a simple agent can iterate before halting",!1,50),new l("Agent System Prompt",o.ConfigPropNames.AGENT_SYSTEM_PROMPT,"number","Maximum length of the system prompt for agents",!1,5e4),new l("Dashboard £ per LOC",o.ConfigPropNames.VALUE_PER_LINE,"number","Approximate value created per line of code generated in £",!1,2.4)])])}}t.ConfigDescriptors=u},1080:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigProperty=void 0;t.ConfigProperty=class{constructor(e,t){this.name=e,this.value=t}}},7967:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigModule=void 0;const n=r(3563),s=r(5015),i=r(2368),a=r(5699),c=r(3713),l=r(376);let d=class{};t.ConfigModule=d,t.ConfigModule=d=o([(0,n.Module)({imports:[l.DataSourceModule],controllers:[s.ConfigController],providers:[i.ConfigService,a.ConfigPropertyRepository,c.ConfigPropertyDescriptor,c.ConfigSection,c.ConfigDescriptors],exports:[i.ConfigService,a.ConfigPropertyRepository,c.ConfigPropertyDescriptor,c.ConfigSection,c.ConfigDescriptors]})],d)},5699:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigPropertyRepository=void 0;const a=r(3563),c=(r(1832),r(1080));let l=o=class{constructor(e){this.knex=e,this.logger=new a.Logger(o.name)}async getProperty(e){try{const t=await this.knex("config_properties").select("value").where("name",e).first();return t?.value||null}catch(t){return this.logger.error(`Error getting property ${e}`,t),null}}async setProperty(e,t){try{null===t?await this.knex("config_properties").where("name",e).delete():await this.knex("config_properties").insert({name:e,value:t}).onConflict("name").merge()}catch(t){throw this.logger.error(`Error setting property ${e}`,t),t}}async getAllProperties(){try{return(await this.knex("config_properties").select("*")).map((e=>new c.ConfigProperty(e.name,e.value)))}catch(e){return this.logger.error("Error getting all properties",e),[]}}async deleteProperty(e){try{await this.knex("config_properties").where("name",e).delete()}catch(t){throw this.logger.error(`Error deleting property ${e}`,t),t}}};t.ConfigPropertyRepository=l,t.ConfigPropertyRepository=l=o=n([(0,a.Injectable)(),i(0,(0,a.Inject)("KNEX")),s("design:paramtypes",[Function])],l)},2368:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigService=void 0;const i=r(3563),a=r(5699),c=r(3713),l=r(6910);let d=o=class{constructor(e){this.configPropertyRepository=e,this.configCache=new Map,this.possibleValuesCache=new Map,this.logger=new i.Logger(o.name),o.instance=this,this.cachedDescriptors=c.ConfigDescriptors.getDefaultDescriptors()}static getInstance(){if(!o.instance)throw new Error("ConfigService has not been initialized");return o.instance}static getProperty(e,t){return o.getInstance().getProperty(e,t)}static getNumericProperty(e,t){return o.getInstance().getNumericProperty(e,t)}static getBooleanProperty(e,t){return o.getInstance().getBooleanProperty(e,t)}async onModuleInit(){try{await this.loadConfigToCache()}catch(e){this.logger.error("Failed to load config properties to cache",e)}}async loadConfigToCache(){try{const e=await this.configPropertyRepository.getAllProperties();this.configCache.clear();for(const t of e)this.configCache.set(t.name,t.value);this.logger.log("Config properties loaded to cache successfully")}catch(e){throw this.logger.error("Error loading config properties to cache",e),e}}async getConfig(){const e=new Map,t=[],r=c.ConfigDescriptors.getDefaultDescriptors();for(const t of r.sections)for(const r of t.properties){const t=this.getProperty(r.name);if(null!==t&&e.set(r.name,r.sensitive?this.maskValue(t):t),"function"==typeof r.possibleValues){const e=this.possibleValuesCache.get(r.possibleValues);if(e)r.possibleValues=e;else{const e=await r.possibleValues();this.possibleValuesCache.set(r.possibleValues,e),r.possibleValues=e}}}return null===this.getProperty(l.ConfigPropNames.HLDK_API_KEY)&&t.push("You need to set the HLDK API Key which you can get from higherlevel.dev/app"),null===this.getProperty(l.ConfigPropNames.ANTHROPIC_API_KEY)&&t.push("You need to set the Anthropic API Key which you can get from console.anthropic.com"),{version:"0.21.0",mode:process.env.MODE||"normal",descriptors:r,currentValues:Object.fromEntries(e),requiredActions:t.length>0?t:void 0}}getProperty(e,t){const r=process.env[e];if(void 0!==r)return r;const o=this.configCache.get(e);if(void 0!==o)return o;const n=this.findDescriptor(e);return n?n?.defaultValue?.toString()||t||null:(this.logger.warn(`Unknown property: ${e}`),null)}getNumericProperty(e,t){const r=this.getProperty(e);return null!==r?parseFloat(r):t||null}getBooleanProperty(e,t){const r=this.getProperty(e);return null!==r?"true"===r.toLowerCase():t||null}findDescriptor(e){for(const t of this.cachedDescriptors.sections){const r=t.properties.find((t=>t.name===e));if(r)return r}}async setProperty(e,t){try{t?(await this.configPropertyRepository.setProperty(e,t),this.configCache.set(e,t)):await this.unsetProperty(e)}catch(t){throw this.logger.error(`Error setting property ${e}`,t),t}}async unsetProperty(e){try{await this.configPropertyRepository.deleteProperty(e),this.configCache.delete(e)}catch(t){throw this.logger.error(`Error unsetting property ${e}`,t),t}}async getAllProperties(){return Array.from(this.configCache.entries()).map((([e,t])=>({name:e,value:t})))}maskValue(e){if(!e)return"not set";if(e.length<20)return"*".repeat(e.length);const t=e.length-8-4;return e.slice(0,8)+"*".repeat(t)+e.slice(-4)}};t.ConfigService=d,t.ConfigService=d=o=n([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigPropertyRepository])],d)},1747:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetDocument=void 0;const o=r(9100);t.DatasetDocument=class{constructor(e,t,r,n="new",s=(0,o.ulid)(),i=new Date,a=new Date){this.id=s,this.datasetId=e,this.filename=t,this.contentHash=r,this.status=n,this.createdAt=i,this.updatedAt=a}}},6932:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetDocumentRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e){return this.knex("datasetDocuments").where("datasetId",e).select("*")}async findById(e){return this.knex("datasetDocuments").where("id",e).first()}async create(e){await this.knex("datasetDocuments").insert(e)}async update(e,t){const r={...t,updatedAt:new Date};await this.knex("datasetDocuments").where("id",e).update(r)}async delete(e){await this.knex("datasetDocuments").where("id",e).delete()}async updateStatus(e,t){await this.knex("datasetDocuments").where("id",e).update({status:t,updatedAt:new Date})}};t.DatasetDocumentRepository=a,t.DatasetDocumentRepository=a=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},8460:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetIndexingService=void 0;const i=r(3563),a=r(2368),c=r(6932),l=r(7184),d=r(7093),u=r(5796),p=r(7310),f=r(8565),h=r(9179),m=r(7915),g=r(4897),y=r(779),w=r(6928),S=r(9100);let v=o=class{constructor(e,t,r){this.configService=e,this.datasetRepository=t,this.documentRepository=r,this.logger=new i.Logger(o.name),this.embeddingsModel=process.env.EMBEDDINGS_MODEL||"Xenova/all-mpnet-base-v2",this.chunkSize=parseInt(process.env.CHUNK_SIZE||"1000",10),this.chunkOverlap=parseInt(process.env.CHUNK_OVERLAP||"200",10),this.chromaUrl=process.env.CHROMA_URL||"http://localhost:8000"}getLoader(e){const t=w.extname(e).toLowerCase();let r;switch(this.logger.log(`Selecting loader for file extension: ${t}`),t){case".pdf":this.logger.log("Using PDFLoader"),r=new f.PDFLoader(e);break;case".docx":this.logger.log("Using DocxLoader"),r=new h.DocxLoader(e);break;case".pptx":this.logger.log("Using PPTXLoader"),r=new g.PPTXLoader(e);break;case".csv":this.logger.log("Using CSVLoader"),r=new y.CSVLoader(e);break;default:this.logger.log("Using UnstructuredLoader for unknown file type"),r=new m.UnstructuredLoader(e)}return r}async indexDocument(e,t,r){try{this.logger.log(`Starting indexing process for document ${e} in dataset ${t}`),await this.documentRepository.updateStatus(e,"indexing"),this.logger.log("Updated document status to 'indexing'"),this.logger.log(`Loading document from path: ${r}`);const o=this.getLoader(r),n=await o.load();this.logger.log(`Successfully loaded document with ${n.length} pages/sections`),this.logger.log(`Splitting text with chunk size ${this.chunkSize} and overlap ${this.chunkOverlap}`);const s=new d.RecursiveCharacterTextSplitter({chunkSize:this.chunkSize,chunkOverlap:this.chunkOverlap}),i=await s.splitDocuments(n);this.logger.log(`Text split into ${i.length} chunks`),i.forEach((t=>{const r=(0,S.ulid)();t.id=r,t.metadata.original_document_id=e,t.metadata.id=r})),this.logger.log(`Initializing embeddings model: ${this.embeddingsModel}`);const a=new p.HuggingFaceTransformersEmbeddings({modelName:this.embeddingsModel}),c=await this.datasetRepository.findById(t);if(!c)throw new Error("Dataset not found");this.logger.log(`Using dataset collection name: ${c.name}`),this.logger.log(`Storing vectors in Chroma at ${this.chromaUrl}`);await u.Chroma.fromDocuments(i,a,{collectionName:c.name,url:this.chromaUrl});this.logger.log("Successfully stored vectors in Chroma"),await this.documentRepository.updateStatus(e,"indexed"),this.logger.log(`Successfully completed indexing of document ${e} in dataset ${t}`)}catch(r){throw this.logger.error(`Failed to index document ${e} in dataset ${t}`),this.logger.error(`Error details: ${r.message}`),r.stack&&this.logger.error(`Stack trace: ${r.stack}`),await this.documentRepository.updateStatus(e,"error"),r}}async removeDocumentFromIndex(e,t){try{this.logger.log(`Removing document ${e} from index collection ${t}`);const r=new p.HuggingFaceTransformersEmbeddings({modelName:this.embeddingsModel}),o=new u.Chroma(r,{collectionName:t,url:this.chromaUrl});await o.delete({filter:{original_document_id:e}}),this.logger.log(`Successfully removed document ${e} from index`)}catch(t){throw this.logger.error(`Failed to remove document ${e} from index: ${t.message}`),t}}};t.DatasetIndexingService=v,t.DatasetIndexingService=v=o=n([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigService,l.DatasetRepository,c.DatasetDocumentRepository])],v)},6696:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetRetrievalService=void 0;const i=r(3563),a=r(2368),c=r(8077),l=r(7310),d=r(5796);let u=o=class{constructor(e,t){this.configService=e,this.datasetService=t,this.logger=new i.Logger(o.name),this.embeddingsModel=process.env.EMBEDDINGS_MODEL||"Xenova/all-mpnet-base-v2",this.chromaUrl=process.env.CHROMA_URL||"http://localhost:8000"}async searchDataset(e,t,r=20,o=void 0){try{this.logger.log(`Searching dataset ${e} for: ${t}`),this.logger.log(`Initializing embeddings model: ${this.embeddingsModel}`);const n=new l.HuggingFaceTransformersEmbeddings({modelName:this.embeddingsModel}),s=new d.Chroma(n,{collectionName:e,url:this.chromaUrl});if(!o){const o=await s.similaritySearch(t,r);return this.logger.log(`Found ${o.length} matches in dataset ${e}`),o}const i=await this.datasetService.getAllDatasets().then((t=>t.find((t=>t.name===e))));if(!i)throw new Error(`Dataset ${e} not found`);const a=await this.datasetService.getDocuments(i.id),c=a.map((e=>(this.logger.log(`Searching for ${t} in document ${e.id}`),s.similaritySearch(t,o,{original_document_id:{$eq:e.id}})))),u=(await Promise.all(c)).flat();this.logger.log(`Found ${u.length} matches in dataset ${e} - before deduplication`),this.logger.log(`Combined results: ${JSON.stringify(u)}`);const p=u.filter(((e,t,r)=>r.findIndex((t=>t.metadata.id===e.metadata.id))===t));return this.logger.log(`Found ${p.length} total matches across ${a.length} documents in dataset ${e}`),u}catch(t){throw this.logger.error(`Failed to search dataset ${e}`),this.logger.error(`Error details: ${t.message}`),t.stack&&this.logger.error(`Stack trace: ${t.stack}`),t}}};t.DatasetRetrievalService=u,t.DatasetRetrievalService=u=o=n([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigService,c.DatasetService])],u)},2251:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetController=void 0;const i=r(3563),a=r(9556),c=r(6982),l=r(8077),d=r(6696);let u=class{constructor(e,t){this.datasetService=e,this.datasetRetrievalService=t}async getAllDatasets(){return this.datasetService.getAllDatasets()}async getDataset(e){return this.datasetService.getDatasetById(e)}async createDataset(e){if(!e.name.match(/^[a-zA-Z0-9]{3,30}$/))throw new Error("Dataset name must be 3-30 alphanumeric characters with no spaces");return this.datasetService.createDataset(e.name,e.baseDir)}async updateDataset(e,t){await this.datasetService.updateDataset(e,t)}async deleteDataset(e){await this.datasetService.deleteDataset(e)}async getDocuments(e){return this.datasetService.getDocuments(e)}async getDocument(e){return this.datasetService.getDocumentById(e)}async createDocument(e,t){const r=(0,c.createHash)("md5").update(t.buffer).digest("hex");return this.datasetService.createDocument(e,t.originalname,r,t.buffer)}async updateDocumentStatus(e,t){await this.datasetService.updateDocumentStatus(e,t.status)}async deleteDocument(e){await this.datasetService.deleteDocument(e)}async queryDataset(e,t,r){const o=await this.datasetService.getDatasetById(e);return this.datasetRetrievalService.searchDataset(o.name,t,r?parseInt(r,10):void 0)}};t.DatasetController=u,o([(0,i.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],u.prototype,"getAllDatasets",null),o([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"getDataset",null),o([(0,i.Post)(),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],u.prototype,"createDataset",null),o([(0,i.Put)(":id"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],u.prototype,"updateDataset",null),o([(0,i.Delete)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"deleteDataset",null),o([(0,i.Get)(":datasetId/documents"),s(0,(0,i.Param)("datasetId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"getDocuments",null),o([(0,i.Get)(":datasetId/documents/:id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"getDocument",null),o([(0,i.Post)(":datasetId/documents"),(0,i.UseInterceptors)((0,a.FileInterceptor)("file")),s(0,(0,i.Param)("datasetId")),s(1,(0,i.UploadedFile)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],u.prototype,"createDocument",null),o([(0,i.Put)(":datasetId/documents/:id/status"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],u.prototype,"updateDocumentStatus",null),o([(0,i.Delete)(":datasetId/documents/:id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"deleteDocument",null),o([(0,i.Get)(":id/query"),s(0,(0,i.Param)("id")),s(1,(0,i.Query)("q")),s(2,(0,i.Query)("numResults")),n("design:type",Function),n("design:paramtypes",[String,String,String]),n("design:returntype",Promise)],u.prototype,"queryDataset",null),t.DatasetController=u=o([(0,i.Controller)("datasets"),n("design:paramtypes",[l.DatasetService,d.DatasetRetrievalService])],u)},4623:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Dataset=void 0;const o=r(9100);t.Dataset=class{constructor(e,t,r=(0,o.ulid)(),n=new Date){this.id=r,this.name=e,this.baseDir=t,this.createdAt=n}}},6552:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetModule=void 0;const n=r(3563),s=r(376),i=r(2251),a=r(8077),c=r(7184),l=r(6932),d=r(8460),u=r(6696),p=r(7967);let f=class{};t.DatasetModule=f,t.DatasetModule=f=o([(0,n.Module)({imports:[s.DataSourceModule,p.ConfigModule],controllers:[i.DatasetController],providers:[a.DatasetService,c.DatasetRepository,l.DatasetDocumentRepository,d.DatasetIndexingService,u.DatasetRetrievalService],exports:[a.DatasetService,u.DatasetRetrievalService]})],f)},7184:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(){return this.knex("datasets").select("*")}async findById(e){return this.knex("datasets").where("id",e).first()}async create(e){await this.knex("datasets").insert(e)}async update(e,t){await this.knex("datasets").where("id",e).update(t)}async delete(e){await this.knex("datasets").where("id",e).delete()}};t.DatasetRepository=a,t.DatasetRepository=a=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},8077:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetService=void 0;const i=r(3563),a=r(9896),c=r(6928),l=r(4623),d=r(1747),u=r(7184),p=r(6932),f=r(8460),h=r(8884),m=r(857);let g=o=class{constructor(e,t,r){this.datasetRepository=e,this.documentRepository=t,this.indexingService=r,this.logger=new i.Logger(o.name)}async getAllDatasets(){return this.datasetRepository.findAll()}async getDatasetById(e){return this.datasetRepository.findById(e)}async createDataset(e,t){const r=(0,h.getEnv)("DATASETS_BASE_DIR",c.join(m.homedir(),".hldk","datasets")),o=t||c.join(r,e);await a.promises.mkdir(o,{recursive:!0});const n=new l.Dataset(e,o);return await this.datasetRepository.create(n),n}async updateDataset(e,t){await this.datasetRepository.update(e,t)}async deleteDataset(e){const t=await this.documentRepository.findAll(e);for(const e of t)await this.deleteDocument(e.id);await this.datasetRepository.delete(e)}async getDocuments(e){return this.documentRepository.findAll(e)}async getDocumentById(e){return this.documentRepository.findById(e)}async createDocument(e,t,r,o){const n=await this.getDatasetById(e);if(!n)throw new Error("Dataset not found");const s=new d.DatasetDocument(e,t,r);await this.documentRepository.create(s);const i=c.join(n.baseDir,t);return await a.promises.mkdir(c.dirname(i),{recursive:!0}),await a.promises.writeFile(i,o),this.indexingService.indexDocument(s.id,e,i).catch((e=>{this.logger.error(`Failed to index document ${s.id}: ${e.message}`,e.stack)})),s}async updateDocumentStatus(e,t){await this.documentRepository.updateStatus(e,t)}async deleteDocument(e){const t=await this.documentRepository.findById(e);if(!t)throw new Error("Document not found");const r=await this.getDatasetById(t.datasetId);if(!r)throw new Error("Dataset not found");try{await this.indexingService.removeDocumentFromIndex(e,r.name)}catch(t){this.logger.error(`Error removing document ${e} from index:`,t)}const o=c.join(r.baseDir,t.filename);try{await a.promises.unlink(o)}catch(e){this.logger.error(`Error deleting file ${o}:`,e)}await this.documentRepository.delete(e)}};t.DatasetService=g,t.DatasetService=g=o=n([(0,i.Injectable)(),s("design:paramtypes",[u.DatasetRepository,p.DatasetDocumentRepository,f.DatasetIndexingService])],g)},8144:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDocController=void 0;const i=r(3563),a=r(3381),c=r(7823);let l=class{constructor(e){this.storedDocService=e}async storeDoc(e,t,r){const o=await this.storedDocService.storeDoc(e,t,r);return c.StoredDocDTO.fromStoredDoc(o)}async getDoc(e){return this.storedDocService.getDoc(e)}async getDocContent(e,t){const r=await this.storedDocService.getDoc(e);if(!r)throw new Error(`Document not found with id: ${e}`);t.setHeader("Content-Type",r.mimeType),t.send(r.contents)}async getDocsBySession(e){return(await this.storedDocService.getDocsBySession(e)).map((e=>c.StoredDocDTO.fromStoredDoc(e)))}async getDocsByWorkspace(e){return(await this.storedDocService.getDocsByWorkspace(e)).map((e=>c.StoredDocDTO.fromStoredDoc(e)))}};t.StoredDocController=l,o([(0,i.Post)(),s(0,(0,i.Body)("contents")),s(1,(0,i.Query)("sessionId")),s(2,(0,i.Query)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String,String,String]),n("design:returntype",Promise)],l.prototype,"storeDoc",null),o([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getDoc",null),o([(0,i.Get)(":id/contents"),s(0,(0,i.Param)("id")),s(1,(0,i.Res)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],l.prototype,"getDocContent",null),o([(0,i.Get)("session/:sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getDocsBySession",null),o([(0,i.Get)("workspace/:workspaceName"),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getDocsByWorkspace",null),t.StoredDocController=l=o([(0,i.Controller)("stored-docs"),n("design:paramtypes",[a.StoredDocService])],l)},7823:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDocDTO=void 0;class r{constructor(e,t,r,o,n){this.id=e,this.mimeType=t,this.createdAt=r,this.sessionId=o,this.workspaceName=n}static fromStoredDoc(e){return new r(e.id,e.mimeType,e.createdAt,e.sessionId,e.workspaceName)}}t.StoredDocDTO=r},3543:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDoc=void 0;const o=r(9100);t.StoredDoc=class{constructor(e,t,r,n,s=(0,o.ulid)(),i=new Date){if(this.id=s,this.contents=e,this.sessionId=r,this.workspaceName=n,this.createdAt=i,t)this.mimeType=t;else try{JSON.parse(e),this.mimeType="application/json"}catch{e.trim().startsWith("<")&&e.trim().endsWith(">")?this.mimeType="text/html":this.mimeType="text/plain"}}}},1680:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DocstoreModule=void 0;const n=r(3563),s=r(8144),i=r(3381),a=r(8648),c=r(376);let l=class{};t.DocstoreModule=l,t.DocstoreModule=l=o([(0,n.Module)({imports:[c.DataSourceModule],controllers:[s.StoredDocController],providers:[i.StoredDocService,a.StoredDocRepository],exports:[i.StoredDocService]})],l)},8648:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDocRepository=void 0;const i=r(3563),a=(r(1832),r(3543)),c=r(7823);let l=class{constructor(e){this.knex=e,this.columns={all:["id","contents","mimeType","createdAt","sessionId","workspaceName"],withoutContents:["id","mimeType","createdAt","sessionId","workspaceName"]}}async save(e){await this.knex("stored_docs").insert({id:e.id,contents:e.contents,mimeType:e.mimeType,createdAt:e.createdAt,sessionId:e.sessionId,workspaceName:e.workspaceName})}async findById(e){const t=await this.knex("stored_docs").select(this.columns.all).where("id",e).first();return t?new a.StoredDoc(t.contents,t.mimeType,t.sessionId,t.workspaceName,t.id,t.createdAt):null}async findByIdWithoutContents(e){const t=await this.knex("stored_docs").select(this.columns.withoutContents).where("id",e).first();return t?c.StoredDocDTO.fromStoredDoc(t):null}async findBySessionId(e){return(await this.knex("stored_docs").select(this.columns.withoutContents).where("sessionId",e)).map((e=>c.StoredDocDTO.fromStoredDoc(e)))}async findByWorkspaceName(e){return(await this.knex("stored_docs").select(this.columns.withoutContents).where("workspaceName",e)).map((e=>c.StoredDocDTO.fromStoredDoc(e)))}};t.StoredDocRepository=l,t.StoredDocRepository=l=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],l)},3381:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDocService=void 0;const s=r(3563),i=r(3543),a=r(8648),c=r(1943),l=r(857),d=r(6928),u=r(3903),p=r(9055);let f=class{constructor(e){this.storedDocRepository=e}async storeDoc(e,t,r,o){const n=new i.StoredDoc(e,t,r,o);return await this.storedDocRepository.save(n),p.default.info(`Stored new document with ID: ${n.id}, sessionId: ${r||"none"}, workspaceName: ${o||"none"}`),n}async getDoc(e){const t=await this.storedDocRepository.findById(e);return t?p.default.info(`Retrieved document with ID: ${e}`):p.default.info(`Document not found with ID: ${e}`),t}async getDocMetadata(e){return this.storedDocRepository.findByIdWithoutContents(e)}async getDocsBySession(e){const t=await this.storedDocRepository.findBySessionId(e);return p.default.info(`Retrieved ${t.length} documents for session: ${e}`),t}async getDocsByWorkspace(e){const t=await this.storedDocRepository.findByWorkspaceName(e);return p.default.info(`Retrieved ${t.length} documents for workspace: ${e}`),t}async withFile(e,t){const r=await this.getDoc(e);if(!r)throw new Error(`Document not found with id: ${e}`);const o=await c.mkdtemp(d.join(l.tmpdir(),"hldk-")),n=d.join(o,`${(0,u.v4)()}`);p.default.info(`Created temporary file for document ${e}: ${n}`);try{await c.writeFile(n,r.contents);return await t(n)}finally{try{await c.unlink(n),await c.rmdir(o)}catch(e){p.default.error("Error cleaning up temporary file:",e)}}}};t.StoredDocService=f,t.StoredDocService=f=o([(0,s.Injectable)(),n("design:paramtypes",[a.StoredDocRepository])],f)},251:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Epic=void 0;const o=r(9100),n=r(7655);t.Epic=class{constructor(e,t,r,n=[],s=(0,o.ulid)(),i=new Date,a=new Date){this.id=s,this.title=e,this.description=t,this.workspaceName=r,this.stories=n,this.createdAt=i,this.updatedAt=a}addStory(e){this.stories.push(e),this.updatedAt=new Date}removeStory(e){this.stories=this.stories.filter((t=>t.id!==e)),this.updatedAt=new Date}getStatus(){return 0===this.stories.length?n.StoryStatus.BACKLOG:this.stories.every((e=>e.status===n.StoryStatus.DONE))?n.StoryStatus.DONE:this.stories.some((e=>e.status===n.StoryStatus.IN_PROGRESS))?n.StoryStatus.IN_PROGRESS:n.StoryStatus.BACKLOG}}},7655:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Story=t.StoryStatus=void 0;const o=r(9100);var n;!function(e){e.BACKLOG="backlog",e.IN_PROGRESS="in_progress",e.DONE="done"}(n||(t.StoryStatus=n={}));t.Story=class{constructor(e,t,r=[],s=n.BACKLOG,i=(0,o.ulid)(),a=new Date,c=new Date){this.id=i,this.title=e,this.description=t,this.status=s,this.acceptanceCriteria=r,this.createdAt=a,this.updatedAt=c}}},9615:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Task=t.TaskStatus=void 0;const o=r(9100);var n;!function(e){e.BACKLOG="backlog",e.IN_PROGRESS="in_progress",e.DONE="done"}(n||(t.TaskStatus=n={}));t.Task=class{constructor(e,t,r=n.BACKLOG,s=(0,o.ulid)(),i=new Date,a=new Date){this.id=s,this.title=e,this.description=t,this.status=r,this.createdAt=i,this.updatedAt=a}}},7781:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.EpicsController=void 0;const i=r(3563),a=r(8610);let c=class{constructor(e){this.epicsService=e}async getRequirements(e,t){return{content:await this.epicsService.getRequirements(e,t)}}async updateRequirements(e,t,r){return{content:await this.epicsService.updateRequirements(e,t,r.content)}}async findAll(e){return this.epicsService.findAllEpics(e)}async findOne(e,t){return this.epicsService.findEpicById(e,t)}async create(e,t){return this.epicsService.createEpic(e,t.title,t.description)}async update(e,t,r){return this.epicsService.updateEpic(e,t,r.title,r.description)}async remove(e,t){return this.epicsService.deleteEpic(e,t)}async addStory(e,t,r){return this.epicsService.addStory(e,t,r.title,r.description,r.acceptanceCriteria)}async updateStory(e,t,r,o){return this.epicsService.updateStory(e,t,r,o.title,o.description,o.acceptanceCriteria)}async getStory(e,t,r){return this.epicsService.getStory(e,t,r)}async removeStory(e,t,r){return this.epicsService.deleteStory(e,t,r)}async addTask(e,t,r,o){return this.epicsService.addTask(e,t,r,o.title,o.description)}async updateTask(e,t,r,o,n){return this.epicsService.updateTask(e,t,r,o,n.title,n.description,n.status)}async removeTask(e,t,r,o){return this.epicsService.deleteTask(e,t,r,o)}async getTasks(e,t,r){return this.epicsService.getTasks(e,t,r)}async getTask(e,t,r,o){return this.epicsService.getTask(e,t,r,o)}};t.EpicsController=c,o([(0,i.Get)(":epicId/requirements"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"getRequirements",null),o([(0,i.Put)(":epicId/requirements"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,String,Object]),n("design:returntype",Promise)],c.prototype,"updateRequirements",null),o([(0,i.Get)(),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"findAll",null),o([(0,i.Get)(":epicId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"findOne",null),o([(0,i.Post)(),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],c.prototype,"create",null),o([(0,i.Put)(":epicId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,String,Object]),n("design:returntype",Promise)],c.prototype,"update",null),o([(0,i.Delete)(":epicId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"remove",null),o([(0,i.Post)(":epicId/stories"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,String,Object]),n("design:returntype",Promise)],c.prototype,"addStory",null),o([(0,i.Put)(":epicId/stories/:storyId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Param)("storyId")),s(3,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,String,String,Object]),n("design:returntype",Promise)],c.prototype,"updateStory",null),o([(0,i.Get)(":epicId/stories/:storyId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Param)("storyId")),n("design:type",Function),n("design:paramtypes",[String,String,String]),n("design:returntype",Promise)],c.prototype,"getStory",null),o([(0,i.Delete)(":epicId/stories/:storyId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Param)("storyId")),n("design:type",Function),n("design:paramtypes",[String,String,String]),n("design:returntype",Promise)],c.prototype,"removeStory",null),o([(0,i.Post)(":epicId/stories/:storyId/tasks"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Param)("storyId")),s(3,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,String,String,Object]),n("design:returntype",Promise)],c.prototype,"addTask",null),o([(0,i.Put)(":epicId/stories/:storyId/tasks/:taskId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Param)("storyId")),s(3,(0,i.Param)("taskId")),s(4,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,String,String,String,Object]),n("design:returntype",Promise)],c.prototype,"updateTask",null),o([(0,i.Delete)(":epicId/stories/:storyId/tasks/:taskId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Param)("storyId")),s(3,(0,i.Param)("taskId")),n("design:type",Function),n("design:paramtypes",[String,String,String,String]),n("design:returntype",Promise)],c.prototype,"removeTask",null),o([(0,i.Get)(":epicId/stories/:storyId/tasks"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Param)("storyId")),n("design:type",Function),n("design:paramtypes",[String,String,String]),n("design:returntype",Promise)],c.prototype,"getTasks",null),o([(0,i.Get)(":epicId/stories/:storyId/tasks/:taskId"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("epicId")),s(2,(0,i.Param)("storyId")),s(3,(0,i.Param)("taskId")),n("design:type",Function),n("design:paramtypes",[String,String,String,String]),n("design:returntype",Promise)],c.prototype,"getTask",null),t.EpicsController=c=o([(0,i.Controller)("workspaces/:workspaceName/epics"),n("design:paramtypes",[a.EpicsService])],c)},8377:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.EpicsModule=void 0;const n=r(3563),s=r(7781),i=r(8610),a=r(5762),c=r(5873);let l=class{};t.EpicsModule=l,t.EpicsModule=l=o([(0,n.Module)({imports:[c.WorkspaceModule],controllers:[s.EpicsController],providers:[i.EpicsService,a.FileSystemEpicRepository],exports:[i.EpicsService]})],l)},8610:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.EpicsService=void 0;const s=r(3563),i=r(5762),a=r(251),c=r(7655),l=r(9615);let d=class{constructor(e){this.epicRepository=e}async getRequirements(e,t){return this.epicRepository.getRequirements(e,t)}async updateRequirements(e,t,r){return this.epicRepository.updateRequirements(e,t,r)}async findAllEpics(e){return this.epicRepository.findAllByWorkspace(e)}async findEpicById(e,t){const r=await this.epicRepository.findById(e,t);if(!r)throw new Error(`Epic with id ${t} not found`);return r}async createEpic(e,t,r){const o=new a.Epic(t,r,e);return this.epicRepository.create(o)}async updateEpic(e,t,r,o){const n=await this.findEpicById(e,t);return n.title=r,n.description=o,n.updatedAt=new Date,this.epicRepository.update(n)}async deleteEpic(e,t){await this.epicRepository.delete(e,t)}async addStory(e,t,r,o,n){const s=new c.Story(r,o,n);return this.epicRepository.addStory(e,t,s)}async updateStory(e,t,r,o,n,s){const i=(await this.findEpicById(e,t)).stories.find((e=>e.id===r));if(!i)throw new Error(`Story with id ${r} not found`);return i.title=o,i.description=n,i.acceptanceCriteria=s,i.updatedAt=new Date,this.epicRepository.updateStory(e,t,i)}async deleteStory(e,t,r){await this.epicRepository.deleteStory(e,t,r)}async getStory(e,t,r){return this.epicRepository.getStory(e,t,r)}async addTask(e,t,r,o,n){const s=new l.Task(o,n);return this.epicRepository.addTask(e,t,r,s)}async updateTask(e,t,r,o,n,s,i){const a=new l.Task(n,s,i,o);return a.updatedAt=new Date,this.epicRepository.updateTask(e,t,r,a)}async deleteTask(e,t,r,o){await this.epicRepository.deleteTask(e,t,r,o)}async getTasks(e,t,r){if(!(await this.findEpicById(e,t)).stories.find((e=>e.id===r)))throw new Error(`Story with id ${r} not found`);return this.epicRepository.getTasks(e,t,r)}async getTask(e,t,r,o){if(!(await this.findEpicById(e,t)).stories.find((e=>e.id===r)))throw new Error(`Story with id ${r} not found`);return this.epicRepository.getTask(e,t,r,o)}};t.EpicsService=d,t.EpicsService=d=o([(0,s.Injectable)(),n("design:paramtypes",[i.FileSystemEpicRepository])],d)},5762:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.FileSystemEpicRepository=void 0;const s=r(3563),i=r(1943),a=r(6928),c=r(251),l=r(7655),d=r(9615),u=r(4717);let p=class{constructor(e){this.workspaceRepository=e}async getRequirements(e,t){const r=await this.getEpicPath(e,t),o=a.join(r,"requirements.md");try{return await i.readFile(o,"utf-8")}catch(e){throw new Error(`Requirements not found for epic ${t}`)}}async updateRequirements(e,t,r){const o=await this.getEpicPath(e,t),n=a.join(o,"requirements.md");try{return await i.writeFile(n,r),r}catch(e){throw new Error(`Failed to update requirements for epic ${t}`)}}async getEpicsBasePath(e){const t=await this.workspaceRepository.findByName(e);if(!t)throw new s.NotFoundException(`Workspace not found: ${e}`);return a.join(t.repoBaseDir,"epics")}async getEpicPath(e,t){const r=await this.getEpicsBasePath(e);return a.join(r,t)}async getStoryPath(e,t,r){const o=await this.getEpicPath(e,t);return a.join(o,"stories",r,"story.json")}async getTaskPath(e,t,r,o){const n=await this.getEpicPath(e,t);return a.join(n,"stories",r,"tasks",`${o}.json`)}async ensureDirectoryExists(e){try{await i.mkdir(e,{recursive:!0})}catch(e){if("EEXIST"!==e.code)throw e}}async readTask(e,t,r,o){const n=await this.getTaskPath(e,t,r,o);try{const e=JSON.parse(await i.readFile(n,"utf-8")),t=new d.Task(e.title,e.description,e.status);return t.id=e.id,t.createdAt=new Date(e.createdAt),t.updatedAt=new Date(e.updatedAt),t}catch(e){throw new s.NotFoundException(`Task with id ${o} not found`)}}async writeTask(e,t,r,o){const n=await this.getTaskPath(e,t,r,o.id);await this.ensureDirectoryExists(a.dirname(n)),await i.writeFile(n,JSON.stringify(o,null,2))}async findAllByWorkspace(e){const t=await this.getEpicsBasePath(e);try{await i.access(t)}catch(e){return[]}let r;try{r=await i.readdir(t)}catch(e){return console.error("Error reading epics directory:",e),[]}const o=[];for(const n of r){const r=a.join(t,n),s=a.join(r,"requirements.md");try{const t=await i.readFile(s,"utf-8"),d=t.match(/# (.+?):/),u=t.match(/## Description\s+(.*?)(?=##|$)/s),p=d?d[1].trim():n,f=u?u[1].trim():"",h=a.join(r,"stories"),m=[];try{const e=await i.readdir(h);for(const t of e){const e=a.join(h,t,"story.json"),r=JSON.parse(await i.readFile(e,"utf-8")),o=new l.Story(r.title,r.description,r.acceptanceCriteria,r.status);o.id=r.id,o.createdAt=new Date(r.createdAt),o.updatedAt=new Date(r.updatedAt),m.push(o)}}catch(e){console.log(`No stories directory found for epic ${n}, continuing with empty stories array`)}o.push(new c.Epic(p,f,e,m,n))}catch(e){console.error(`Error reading epic ${n}:`,e)}}return o}async findById(e,t){const r=await this.getEpicPath(e,t);try{await i.access(r)}catch(e){return null}try{const o=a.join(r,"requirements.md"),n=await i.readFile(o,"utf-8"),s=n.match(/# (.+?):/),d=n.match(/## Description\s+(.*?)(?=##|$)/s),u=s?s[1].trim():t,p=d?d[1].trim():"",f=a.join(r,"stories");let h=[];try{const e=await i.readdir(f);for(const t of e)try{const e=a.join(f,t,"story.json"),r=JSON.parse(await i.readFile(e,"utf-8")),o=new l.Story(r.title,r.description,r.acceptanceCriteria,r.status,r.taskIds||[]);o.id=r.id,o.createdAt=new Date(r.createdAt),o.updatedAt=new Date(r.updatedAt),h.push(o)}catch(e){console.error(`Error reading story ${t}:`,e)}}catch(e){console.error("Error reading stories directory:",e)}return new c.Epic(u,p,e,h,t)}catch(e){return console.error(`Error reading epic ${t}:`,e),null}}async create(e){const t=await this.getEpicPath(e.workspaceName,e.id);await this.ensureDirectoryExists(t),await this.ensureDirectoryExists(a.join(t,"stories"));const r=`# ${e.title}:\n\n## Description\n${e.description}\n\n## Goals\n- Add goals here\n`;return await i.writeFile(a.join(t,"requirements.md"),r),e}async update(e){const t=await this.getEpicPath(e.workspaceName,e.id),r=a.join(t,"requirements.md"),o=`# ${e.title}:\n\n## Description\n${e.description}\n\n## Goals\n- Add goals here\n`;return await i.writeFile(r,o),e}async delete(e,t){const r=await this.getEpicPath(e,t);await i.rm(r,{recursive:!0,force:!0})}async addStory(e,t,r){const o=await this.getEpicPath(e,t),n=a.join(o,"stories");await this.ensureDirectoryExists(n);const s=await this.getStoryPath(e,t,r.id);return await this.ensureDirectoryExists(a.dirname(s)),await i.writeFile(s,JSON.stringify(r,null,2)),r}async updateStory(e,t,r){const o=await this.getStoryPath(e,t,r.id);return await i.writeFile(o,JSON.stringify(r,null,2)),r}async deleteStory(e,t,r){const o=await this.getStoryPath(e,t,r),n=a.dirname(o);await i.rm(n,{recursive:!0,force:!0})}async getStory(e,t,r){const o=await this.getStoryPath(e,t,r);try{const e=JSON.parse(await i.readFile(o,"utf-8")),t=new l.Story(e.title,e.description,e.acceptanceCriteria,e.status,e.taskIds||[]);return t.id=e.id,t.createdAt=new Date(e.createdAt),t.updatedAt=new Date(e.updatedAt),t}catch(e){throw new s.NotFoundException(`Story with id ${r} not found`)}}async addTask(e,t,r,o){const n=await this.findById(e,t);if(!n)throw new Error("Epic not found");if(!n.stories.find((e=>e.id===r)))throw new Error("Story not found");return await this.writeTask(e,t,r,o),o}async updateTask(e,t,r,o){const n=await this.findById(e,t);if(!n)throw new Error("Epic not found");if(!n.stories.find((e=>e.id===r)))throw new Error("Story not found");try{await this.readTask(e,t,r,o.id)}catch(e){throw new Error("Task not found")}return await this.writeTask(e,t,r,o),o}async deleteTask(e,t,r,o){const n=await this.findById(e,t);if(!n)throw new Error("Epic not found");if(!n.stories.find((e=>e.id===r)))throw new Error("Story not found");const s=await this.getTaskPath(e,t,r,o);await i.rm(s,{force:!0})}async getTasks(e,t,r){const o=await this.findById(e,t);if(!o)throw new Error("Epic not found");if(!o.stories.find((e=>e.id===r)))throw new Error("Story not found");const n=a.join(await this.getEpicPath(e,t),"stories",r,"tasks");try{const o=await i.readdir(n),s=[];for(const n of o){if(!n.endsWith(".json"))continue;const o=n.replace(".json","");try{const n=await this.readTask(e,t,r,o);s.push(n)}catch(e){console.error(`Error reading task ${o}:`,e)}}return s}catch(e){if("ENOENT"===e.code)return[];throw e}}async getTask(e,t,r,o){return this.readTask(e,t,r,o)}};t.FileSystemEpicRepository=p,t.FileSystemEpicRepository=p=o([(0,s.Injectable)(),n("design:paramtypes",[u.WorkspaceRepository])],p)},5056:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileController=void 0;const i=r(3563),a=r(9556),c=r(7205);let l=class{constructor(e){this.storedFileService=e}async uploadFile(e,t,r){return this.storedFileService.uploadFile(e,t,r)}async getFileContent(e,t){const r=await this.storedFileService.getFile(e);r?(t.setHeader("Content-Type",r.mimeType),t.setHeader("Content-Disposition",`attachment; filename="${r.originalFilename}"`),t.send(r.fileContents)):t.status(404).send("File not found")}async getFile(e){return this.storedFileService.getFileMetadata(e)}async getAllFiles(){return this.storedFileService.getAllFiles()}async deleteFile(e){await this.storedFileService.deleteFile(e)}async getFilesBySessionId(e){return this.storedFileService.getFilesBySessionId(e)}async getFilesByWorkspaceName(e){return this.storedFileService.getFilesByWorkspaceName(e)}};t.StoredFileController=l,o([(0,i.Post)("upload"),(0,i.UseInterceptors)((0,a.FileInterceptor)("file")),s(0,(0,i.UploadedFile)()),s(1,(0,i.Query)("sessionId")),s(2,(0,i.Query)("workspaceName")),n("design:type",Function),n("design:paramtypes",[Object,String,String]),n("design:returntype",Promise)],l.prototype,"uploadFile",null),o([(0,i.Get)(":id/content"),s(0,(0,i.Param)("id")),s(1,(0,i.Res)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],l.prototype,"getFileContent",null),o([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getFile",null),o([(0,i.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],l.prototype,"getAllFiles",null),o([(0,i.Delete)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"deleteFile",null),o([(0,i.Get)("session/:sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getFilesBySessionId",null),o([(0,i.Get)("workspace/:workspaceName"),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getFilesByWorkspaceName",null),t.StoredFileController=l=o([(0,i.Controller)("stored-files"),n("design:paramtypes",[c.StoredFileService])],l)},5775:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileDto=void 0;class r{constructor(e){this.id=e.id,this.originalFilename=e.originalFilename,this.mimeType=e.mimeType,this.createdAt=e.createdAt,this.sessionId=e.sessionId,this.workspaceName=e.workspaceName}static fromStoredFile(e){return new r({id:e.id,originalFilename:e.originalFilename,mimeType:e.mimeType,createdAt:e.createdAt,sessionId:e.sessionId,workspaceName:e.workspaceName})}}t.StoredFileDto=r},7607:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFile=void 0;const o=r(9100);t.StoredFile=class{constructor(e,t,r,n,s,i=(0,o.ulid)(),a=new Date){this.id=i,this.originalFilename=e,this.fileContents=t,this.mimeType=r,this.sessionId=n,this.workspaceName=s,this.createdAt=a}}},8624:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileModule=void 0;const n=r(3563),s=r(5056),i=r(7205),a=r(4632),c=r(376);let l=class{};t.StoredFileModule=l,t.StoredFileModule=l=o([(0,n.Module)({imports:[c.DataSourceModule],controllers:[s.StoredFileController],providers:[i.StoredFileService,a.StoredFileRepository],exports:[i.StoredFileService]})],l)},4632:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileRepository=void 0;const i=r(3563),a=(r(1832),r(5775));let c=class{constructor(e){this.knex=e,this.columns={all:["id","fileContents","originalFilename","mimeType","createdAt","sessionId","workspaceName"],withoutContent:["id","originalFilename","mimeType","createdAt","sessionId","workspaceName"]}}async findAll(){return(await this.knex("stored_files").select(this.columns.withoutContent)).map((e=>a.StoredFileDto.fromStoredFile(e)))}async findById(e){const t=await this.knex("stored_files").select(this.columns.all).where("id",e).first();return t||null}async findByIdWithoutContent(e){const t=await this.knex("stored_files").select(this.columns.withoutContent).where("id",e).first();return t?a.StoredFileDto.fromStoredFile(t):null}async create(e){await this.knex("stored_files").insert(e)}async delete(e){await this.knex("stored_files").where("id",e).delete()}async findBySessionId(e){return(await this.knex("stored_files").select(this.columns.withoutContent).where("sessionId",e)).map((e=>a.StoredFileDto.fromStoredFile(e)))}async findByWorkspaceName(e){return(await this.knex("stored_files").select(this.columns.withoutContent).where("workspaceName",e)).map((e=>a.StoredFileDto.fromStoredFile(e)))}};t.StoredFileRepository=c,t.StoredFileRepository=c=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],c)},7205:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileService=void 0;const s=r(3563),i=r(7607),a=r(5775),c=r(4632),l=r(904),d=r(8817),u=r(9055);let p=class{constructor(e){this.storedFileRepository=e}async uploadFile(e,t,r){let o=l.lookup(e.originalname);if(!o){const t=await d.default.fromBuffer(e.buffer);o=t?t.mime:"application/octet-stream"}const n=new i.StoredFile(e.originalname,e.buffer,o,t,r);return await this.storedFileRepository.create(n),u.default.info(`File uploaded: ${e.originalname} (${o}) for session: ${t||"none"}, workspace: ${r||"none"}`),a.StoredFileDto.fromStoredFile(n)}async getFile(e){const t=await this.storedFileRepository.findById(e);return t?u.default.info(`File retrieved: ${t.originalFilename} (${e})`):u.default.info(`File not found: ${e}`),t}async getFileMetadata(e){const t=await this.storedFileRepository.findByIdWithoutContent(e);return t?u.default.info(`File metadata retrieved: ${t.originalFilename} (${e})`):u.default.info(`File not found: ${e}`),t}async getAllFiles(){return this.storedFileRepository.findAll()}async deleteFile(e){const t=await this.storedFileRepository.findByIdWithoutContent(e);await this.storedFileRepository.delete(e),u.default.info(`File deleted: ${t?t.originalFilename:"unknown"} (${e})`)}async getFilesBySessionId(e){const t=await this.storedFileRepository.findBySessionId(e);return u.default.info(`Retrieved ${t.length} files for session: ${e}`),t}async getFilesByWorkspaceName(e){const t=await this.storedFileRepository.findByWorkspaceName(e);return u.default.info(`Retrieved ${t.length} files for workspace: ${e}`),t}};t.StoredFileService=p,t.StoredFileService=p=o([(0,s.Injectable)(),n("design:paramtypes",[c.StoredFileRepository])],p)},7701:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DocxFormBuilder=void 0;const s=r(3563),i=r(9100),a=r(1162),c=r(3239),l=r(3229),d=r(9055),u=r(7687);let p=class{constructor(e){this.summaryCompletion=e}canHandle(e){return"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===e.mimeType}async extractTitle(e){const t=(await(0,l.extractRawText)(e.fileContents)).substring(0,1e4);return await this.summaryCompletion.getSummary("Return a suitable Title for the following document. Just return the Title on its own with no other info:",t,a.ModelCategory.SUMMARISATION)}removeQuestionsWithAnswerInTheFormAsText(e){return e.filter((e=>e.answerInTheFormAsText?(d.default.info("Removing question with answer already in form text: %s - Answer: %s",e.text||e.shortDescription,e.answerInTheFormAsText),!1):!(e.subQuestions&&e.subQuestions.length>0&&(e.subQuestions=this.removeQuestionsWithAnswerInTheFormAsText(e.subQuestions),"composite"===e.type&&0===e.subQuestions.length))||(d.default.info("Removing composite question with no remaining subquestions: %s",e.shortDescription),!1)))}async*generateSections(e,t){const r=await(0,l.extractSectionsFromDocxBuffer)(e.fileContents,!1);d.default.info("Found %d sections in the DOCX document",r.sections.length);for(const e of r.sections){if(0===e.potentialInputs.length){d.default.info("No inputs found in section, skipping...");continue}d.default.info("Processing section with %d inputs: %s",e.potentialInputs.length,e.xpath);const r=(0,i.ulid)(),o=`\n      You are an expert form builder. The original form was a Word document in .docx format. You are being given a section of content from the form after it has been converted to HTML along with a list of potentual input fields found in that section.\n      Your job is to analyze the HTML content and potential input fields to identify and structure the questions in the form.\n\n      The potential input fields have the following properties:\n      - xpath: The XML path to the input field in the original DOCX document\n      - type: The type of input (text, textarea, checkbox) - DO NOT ASSUME THIS IS THE ACTUAL TYPE OF THE INPUT FIELD. For example some "text" inputs are actually text-areas - use your judgement based on the context of the input, where it appears and how much space is available in the input field to answer the question as well as the actual question text.\n      - id: Optional identifier\n      - label: Optional label text found near the input\n      - originalValue: Optional existing value in the input which might contain the question text also\n\n      For each potential input field, you need to:\n      1. Identify if it's a question or not (if not then you don't need to include this bit in the JSON output)\n      2. If it is a question, identify the actual question being asked\n      3. Determine if it's part of a larger composite question\n      4. Create appropriate question structures that include the input's xpath as originalInputXpath\n\n      The section id for this section is: ${r}\n\n      Return a JSON object in this format:\n{\n  "id": "${r}",\n  "title": "A descriptive title for this section",\n  "path": "${r}",\n  "questions": [\n    {\n      "path": "unique identifier for this question: ${r}/short-unique-identifier (for sub questions append short-unique-identifier to the parent path)",\n      "type": "text|text-area|number|boolean|multipleChoice|composite",\n      "number": "Optional: Populate with any numbering associated with this question (e.g. 1.2 or 4a etc). Only populate for non-composite questions",\n      "shortDescription": "Optional: Only for composite questions or questions with long text: 1 to 4 word short description for the question (e.g. 'Contact Details')",\n      "text": "The actual question text (IMPORTANT: DO NOT POPULATE FOR COMPOSITE QUESTIONS - ALSO REMEMBER TO ESCAPE SPECIAL CHARACTERS LIKE QUOTES USING THE BACKSLASH (")",\n      "options": ["option1", "option2"] (only for multipleChoice type),\n      "multipleSelection": true|false (only for multipleChoice type),\n      "subQuestions": [] (only for composite type, contains nested questions in same format and appends to the parent path),\n      "normalizedQuestionText": "A longer, self-contained version of the question that makes sense on its own without hierarchical context",\n      "additionalInfo": "Optional: Any helpful context or instructions for answering the question that appears in the form. Do not make up instructions that are not present in the form.",\n      "originalInputXpath": "The xpath of the input field this question corresponds to",\n      "answerInTheFormAsText": "Optional: If the answer is already provided in the form then populate this with the answer",\n      "appendOrReplace": "Optional: Instructions on how to update the input field with the answer (e.g. 'append' or 'replace Answer here') if the input field already contains content\n    }\n  ]\n}\n\nImportant Guidelines:\n1. The section title should be descriptive and reflect the theme of all questions in this block\n2. Each question's path should start with the section path (which is a ulid). For sub questions append the short-unique-identifier to the parent path.\n3. For composite questions (like address forms or tables), use the composite type and subQuestions\n4. If you see a boolean or text question with nested questions, use the composite type and add in the parent question as a subQuestion along with the nested questions.\n5. The number property should be populated with any numbering associated with this question (e.g. 1.2 or 4a etc). Only use numbers from the actual form.\n6. The shortDescription property is required for composite questions but should also be populated for questions with long text.\n7. The normalizedQuestionText should be self-contained and clear even without context. DO NOT POPULATE FOR COMPOSITE QUESTIONS. \n8. Include any helpful instructions or context that appears in the form in additionalInfo\n9. Don't miss any questions - capture everything that looks like it needs an answer\n10. Choose appropriate types based on the expected answer format\n11. For tables or lists that contain multiple related questions, use composite type with subQuestions. Some tables will use columns to partition questions. Sometimes the questions in the LHS of the table will have a different row structure to the questions on the RHS of the table.\n12. The number property should ONLY be populated if there is actual numbering in the form content\n13. For table layout questions make sure to construct a suitable hierarchy of questions to efficiently cover ALL of the questions without missing any\n14. IMPORTANT: DO NOT INCLUDE BLANK OR EMPTY ATTRIBUTES IN THE JSON OUTPUT - JUST LEAVE THEM OUT ENTIRELY\n15. IMPORTANT: EXAMINE THE HTML STRUCTURE LOOKING FOR NESTED STRUCTURE AND USE COMPOSITE TYPE FOR THESE QUESTIONS\n16. IMPORTANT: DO NOT MISS ANY FOLLOW ON QUESTIONS THAT RELATE TO A BOOLEAN YES/NO QUESTION (MAKE THE BOOLEAN QUESTION A SUBQUESTION AND ADD THE FOLLOW ON QUESTIONS)\n17. IMPORTANT: EVERY QUESTION MUST HAVE AN originalInputXpath THAT MATCHES ONE OF THE PROVIDED INPUT XPATHS\n18. IMPORTANT: WHEN FINISHED, GO BACK AND CHECK THAT YOU HAVE NOT MISSED ANY QUESTIONS. MAKE SURE TO CHECK ALL ROWS AND COLUMNS OF TABLES.\n19. IMPORTANT: REMEMBER TO ESCAPE SPECIAL CHARACTERS IN THE JSON LIKE QUOTES USING THE BACKSLASH (")\n\nHere are the potentialinputs found in this section:\n${JSON.stringify(e.potentialInputs,null,2)}\n\nThe HTML content of the section that needs to be analyzed follows this message.\n`;d.default.info("Analyzing section for questions with %d inputs",e.potentialInputs.length),d.default.info("HTML content of section: %s",e.convertedHtml);try{const r=await this.summaryCompletion.getSummaryJson(o,e.convertedHtml,a.ModelCategory.REASONING,!1,t),n=JSON.parse(r),s=(0,u.countNestedQuestions)(n.questions);if(d.default.info("Found %d questions in this section",s),0===s){d.default.warn("No questions found in this section, skipping...");continue}d.default.info("Question structure result: %s",JSON.stringify(n));try{const e=n.questions,t={id:n.id,title:n.title,path:n.path,questions:e};yield t}catch(e){d.default.error("Failed to process questions:",e);continue}}catch(e){d.default.error("Failed to process section:",e);continue}}}};t.DocxFormBuilder=p,t.DocxFormBuilder=p=o([(0,s.Injectable)(),n("design:paramtypes",[c.SummaryCompletion])],p)},7628:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnswerQueryRequest=void 0;t.AnswerQueryRequest=class{}},9543:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CopyFormRequest=void 0;t.CopyFormRequest=class{constructor(){this.copyAnswers=!0}}},412:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CreateFormRequest=void 0;t.CreateFormRequest=class{}},3896:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFormAnswerDto=void 0;t.UpdateFormAnswerDto=class{}},6815:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFormRequest=void 0;t.UpdateFormRequest=class{}},6941:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DocxFormExporter=void 0;const s=r(3563),i=r(9896),a=r(857),c=r(6928),l=r(1879),d=r(9863),u=r(1115),p=r(7020),f=r(9055),h=r(9496);let m=class{constructor(e,t){this.formAnswerRepository=e,this.formSectionRepository=t}canHandle(e,t){return"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===t.mimeType}getDefaultFileName(e,t){const r=(new Date).toISOString().replace(/[-:T]/g,"").substring(0,12),o=t.originalFilename.split(".").pop(),n=`${t.originalFilename.replace(/\.[^.]+$/,"")}-exported-${r}.${o}`;return f.default.info(`Default file name for form ${e.id} is ${n}`),n}getContentType(e){return e.mimeType}async extractDocxToTemp(e,t){return new Promise(((r,o)=>{u.fromBuffer(e,{lazyEntries:!0},((e,n)=>{e?o(new Error(`Failed to open DOCX buffer: ${e.message}`)):(n.on("entry",(e=>{const r=c.join(t,e.fileName);i.mkdirSync(c.dirname(r),{recursive:!0}),n.openReadStream(e,((t,s)=>{if(t)return void o(new Error(`Failed to read entry ${e.fileName}: ${t.message}`));const a=i.createWriteStream(r);s.pipe(a),a.on("finish",(()=>n.readEntry()))}))})),n.on("end",r),n.on("error",o),n.readEntry())}))}))}buildQuestionMap(e){const t=new Map,r=e=>{t.set(e.path,e),e.subQuestions&&e.subQuestions.forEach((e=>r(e)))};return e.forEach(r),f.default.info(`Built question map with ${t.size} questions`),t}async updateDocumentXml(e,t,r){f.default.info("Updating document.xml with answers");const o=await i.promises.readFile(e,"utf8");f.default.debug(`XML content: ${o}`);const n=(new l.DOMParser).parseFromString(o,"application/xml"),s={w:"http://schemas.openxmlformats.org/wordprocessingml/2006/main",w14:"http://schemas.microsoft.com/office/word/2010/wordml"},a={lookupNamespaceURI:e=>s[e]||null},c=(e,t)=>(f.default.info(`Selecting nodes with expression: ${e} and context node: ${t.nodeName}`),d.selectWithResolver(e,t,a)),u=e=>{f.default.info(`Node: ${e.nodeName} - ${e.textContent}`)};for(const[e,o]of t.entries())try{const t=r.get(e);if(!t){f.default.warn(`No question found for question path: ${e} - for answer: ${JSON.stringify(o)}`);continue}const s=t.originalInputXpath;f.default.info(`Processing answer for xpath: ${s} - value: ${o.value} - for question: ${t.normalizedQuestionText}`);const i=c(s,n);if(i.length>1&&f.default.warn(`Found ${i.length} nodes for xpath: ${s} - for question: ${t.normalizedQuestionText}`),i.length>0){const e=i[0];switch(u(e),e.nodeName){case"w:r":this.handleRunNode(e,t,o,n,c);break;case"w:p":this.handleParagraphNode(e,t,o,n,c);break;case"w:t":this.handleTextNode(e,t,o,n,c);break;case"w:tc":this.handleTableCellNode(e,t,o,n,c);break;default:f.default.warn(`Unsupported node type: ${e.nodeName} for xpath: ${s}`)}}else f.default.warn(`No nodes found for xpath: ${s}`)}catch(t){f.default.error(`Error processing question path ${e}: ${t.message}`)}const p=(new l.XMLSerializer).serializeToString(n);await i.promises.writeFile(e,p)}async createNewDocx(e){return new Promise(((t,r)=>{const o=new p.ZipFile,n=async(e,t="")=>{const r=await i.promises.readdir(e,{withFileTypes:!0});for(const s of r){const r=c.join(e,s.name),i=c.join(t,s.name);s.isDirectory()?await n(r,i):o.addFile(r,i)}};n(e).then((()=>{const e=[];o.outputStream.on("data",(t=>e.push(t))),o.outputStream.on("end",(()=>t(Buffer.concat(e)))),o.outputStream.on("error",r),o.end()})).catch(r)}))}transformAnswerValue(e,t){return"boolean"===e.type&&"1"===t.value?"Yes":"boolean"===e.type&&"0"===t.value?"No":t.value}handleRunNode(e,t,r,o,n){const s=n(".//w:t",e);let i=null;for(const e of s){if(""!==(e.textContent||"").trim()){i=null;break}i=e}if(i)i.textContent=(i.textContent||"")+r.value,f.default.info(`Appended answer into existing empty text node: "${r.value}"`);else{const t=o.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main","w:t");t.textContent=r.value,e.appendChild(t),f.default.info(`Inserted new <w:t> element with value "${r.value}"`)}}handleParagraphNode(e,t,r,o,n){const s="http://schemas.openxmlformats.org/wordprocessingml/2006/main",i=n(".//w:t",e);let a=null;for(const e of i){if(""!==(e.textContent||"").trim()){a=null;break}a=e}if(a){const e=this.transformAnswerValue(t,r);a.textContent=(a.textContent||"")+e,f.default.info(`Appended answer into existing empty text node in paragraph: "${e}"`)}else{const n=o.createElementNS(s,"w:t"),i=this.transformAnswerValue(t,r);n.textContent=i;const a=o.createElementNS(s,"w:r");a.appendChild(n),e.appendChild(a),f.default.info(`Inserted new run with text "${r.value}"`)}}handleTextNode(e,t,r,o,n){const s=e.textContent||"";if(""===s.trim()){const o=this.transformAnswerValue(t,r);e.textContent=s+o,f.default.info(`Appended answer into existing empty text node: "${o}"`)}else{const n=e.parentNode;if(n){const e="http://schemas.openxmlformats.org/wordprocessingml/2006/main",s=o.createElementNS(e,"w:t"),i=this.transformAnswerValue(t,r);s.textContent=i,n.appendChild(s),f.default.info(`Inserted new <w:t> element with value "${r.value}"`)}else f.default.warn("Cannot append new text node as parent node is null")}}handleTableCellNode(e,t,r,o,n){const s="http://schemas.openxmlformats.org/wordprocessingml/2006/main",i=n(".//w:t",e);let a=null;for(const e of i){if(""!==(e.textContent||"").trim()){a=null;break}a=e}if(a){const e=this.transformAnswerValue(t,r);a.textContent=(a.textContent||"")+e,f.default.info(`Appended answer into existing empty text node in table cell: "${e}"`)}else{const n=o.createElementNS(s,"w:p"),i=o.createElementNS(s,"w:r"),a=o.createElementNS(s,"w:t"),c=this.transformAnswerValue(t,r);a.textContent=c,i.appendChild(a),n.appendChild(i),e.appendChild(n),f.default.info(`Appended new paragraph with text "${r.value}" to table cell`)}}async export(e,t){f.default.info(`Exporting form ${e.id} to DOCX`);const r=await this.formSectionRepository.findByFormId(e.id);f.default.info(`Found ${r.length} sections for form ${e.id}`);const o=new Map;for(const e of r){const t=e.getQuestions(),r=this.buildQuestionMap(t);for(const[e,t]of r.entries())o.set(e,t)}f.default.info(`Built question map with ${o.size} questions`);const n=await this.formAnswerRepository.findByFormId(e.id);f.default.info(`Found ${n.length} answers for form ${e.id}`);const s=new Map;for(const e of n)s.set(e.questionPath,e);f.default.info(`Found ${s.size} answers for form ${e.id}`);const l=await i.promises.mkdtemp(c.join(a.tmpdir(),"docx-export-"));try{const e=t.fileContents;f.default.info("Extracting DOCX to temp directory"),await this.extractDocxToTemp(e,l);const r=c.join(l,"word/document.xml");await this.updateDocumentXml(r,s,o),f.default.info("Creating new DOCX file");const n=await this.createNewDocx(l);return f.default.info("New DOCX file created"),n}finally{await i.promises.rm(l,{recursive:!0,force:!0})}}};t.DocxFormExporter=m,t.DocxFormExporter=m=o([(0,s.Injectable)(),n("design:paramtypes",[h.FormAnswerRepository,h.FormSectionRepository])],m)},4391:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.FormAnswersService=void 0;const i=r(3563),a=r(6696),c=r(3239),l=r(1162),d=r(9496),u=r(2368),p=r(6910);let f=o=class{generateRagQueryPrompt(e){const t=e.partialAnswer&&e.partialAnswer.trim().length>2,r=e.relatedAnswers.some((e=>e.answerInTheFormAsText));let o="";if(t||r){if(t&&!r)o=`Example response for a question about "${e.targetQuestion.normalizedQuestionText}" with partial answer "${e.partialAnswer}":\n[\n  {"query": "detailed information about ${e.targetQuestion.normalizedQuestionText}"},\n  {"query": "specific details supporting ${e.partialAnswer}"}\n]`;else if(t&&r){const t=e.relatedAnswers[0].answerInTheFormAsText;o=`Example response for a question about "${e.targetQuestion.normalizedQuestionText}" with partial answer "${e.partialAnswer}" and related answer "${t}":\n[\n  {"query": "detailed information about ${e.targetQuestion.normalizedQuestionText}"},\n  {"query": "specific details supporting ${e.partialAnswer}"},\n  {"query": "information connecting ${e.partialAnswer} with the related answers in the context"}\n]`}}else o=`Example response for a question about "${e.targetQuestion.normalizedQuestionText}":\n[\n  {"query": "detailed information about ${e.targetQuestion.normalizedQuestionText}"}\n]`;return`You are an AI assistant helping to generate RAG (Retrieval Augmented Generation) queries for answering form questions.\n\nGiven the context about a form question, generate search queries that will help find the most relevant information to answer the question.\n\nThe context object contains:\n- sectionTitle: The title of the form section containing the question\n- targetQuestion: The details of the question that needs to be answered\n${t?"- partialAnswer: The user's partial answer that needs to be expanded\n":""}${r?"- relatedAnswers: Other answers in the form that are related to this question\n":""}\n\nYou should generate queries based on the following rules:\n1. ALWAYS generate a main query focused on the normalized question text\n${t?"2. Generate a second query to find supporting or related information for the partial answer\n":""}${r?`${t?"3":"2"}. Generate a ${t?"third":"second"} query to find information that connects or relates to the existing answers\n`:""}\n\nKeep all queries concise and focused on retrieving relevant information.\n\nResponse format: Return a JSON array of query objects, each with just a "query" string.\n\n${o}\n`}constructor(e,t,r,n,s){this.datasetRetrievalService=e,this.summaryCompletion=t,this.formSectionRepository=r,this.formAnswerRepository=n,this.configService=s,this.logger=new i.Logger(o.name)}flattenQuestions(e,t=[]){for(const r of e)t.push(r),r.subQuestions&&r.subQuestions.length>0&&this.flattenQuestions(r.subQuestions,t);return t}findRelatedAnswers(e,t){const r=t.path.split("/").slice(0,-1).join("/");return e.filter((e=>e.questionPath.startsWith(r)&&e.answerInTheFormAsText))}async fetchAnswersFromDB(e,t,r){const o=await this.formAnswerRepository.findByFormId(e,t);return this.logger.log(`Found ${o.length} answers for section ${t}`),r.map((e=>({questionPath:e.path,normalizedQuestionText:e.normalizedQuestionText,answerInTheFormAsText:o.find((t=>t.questionPath===e.path))?.value})))}async executeRagQueries(e,t){const r=[],n=t.map((async({query:t})=>{const n=await this.datasetRetrievalService.searchDataset(e,t,o.RESULTS_PER_QUERY,o.RESULTS_PER_QUERY);r.push(...n)}));await Promise.all(n);return r.filter(((e,t,r)=>r.findIndex((t=>t.metadata.id===e.metadata.id))===t))}async queryAnswer(e){this.logger.log(`Querying answer for form ${e.formId}, question ${e.questionPath}, specific model ${e.modelName}`);const t=e.questionPath.split("/")[0],r=await this.formSectionRepository.findById(t);if(!r)throw new Error(`Section not found with id ${t}`);const n=e.partialAnswerText&&e.partialAnswerText.trim().length>2,s=(n?o.PARTIAL_ANSWER_PROMPT:o.BASE_PROMPT,JSON.parse(r.json));this.logger.log(`Found ${s.length} questions in section ${t}`),this.logger.log(`Questions: ${JSON.stringify(s)}`);const i=this.flattenQuestions(s),a=i.find((t=>t.path===e.questionPath));if(!a)throw new Error(`Question not found with path ${e.questionPath}`);this.logger.log(`Partial answer provided: ${e.partialAnswerText}`),await this.formAnswerRepository.upsertAnswer(e.formId,{questionPath:e.questionPath,normalizedQuestionText:a.normalizedQuestionText,value:e.partialAnswerText||""});const c=await this.fetchAnswersFromDB(e.formId,t,i),d=this.findRelatedAnswers(c,a);this.logger.log(`Related answers: ${JSON.stringify(d)}`);const u=e.modelName||this.configService.getProperty(p.ConfigPropNames.DEFAULT_RAG_QUERY_MODEL);this.logger.log(`Using RAG query model: ${u}`);const f={sectionTitle:r.title,targetQuestion:a,partialAnswer:e.partialAnswerText,relatedAnswers:d.filter((e=>e.answerInTheFormAsText))},h=JSON.stringify(f);this.logger.log(`RAG query context: ${h}`);const m=this.generateRagQueryPrompt(f),g=await this.summaryCompletion.getSummaryJson(m,h,l.ModelCategory.RAG_QUERY,!1,e.modelName);let y=JSON.parse(g);if(!Array.isArray(y)){const e=Object.values(y).find(Array.isArray);e?y=e:(this.logger.warn("LLM response was not an array and no array property found in object"),y=[])}const w=y;this.logger.log(`Generated RAG queries: ${JSON.stringify(w)}`);const S=await this.executeRagQueries(e.datasetName,w);this.logger.log(`RAG query results: ${JSON.stringify(S)}`);const v=d.length>0?`YOUR ANSWER MUST BE CONSISTENT WITH THE FOLLOWING ANSWERS THAT HAVE ALREADY BEEN PROVIDED BY THE USER:\n${d.filter((e=>e.answerInTheFormAsText)).map((e=>`${e.normalizedQuestionText} --\x3e ${e.answerInTheFormAsText}`)).join("\n")}`:"",_=i.filter((e=>e.path!==a.path)).map((e=>e.path)).join("\n"),R=(n?o.PARTIAL_ANSWER_PROMPT:o.BASE_PROMPT).replace("{RELATED_ANSWERS}",v).replace("{OTHER_QUESTION_PATHS_IN_THIS_SECTION}",_),b={sectionTitle:r.title,targetQuestion:a,partialAnswer:e.partialAnswerText,ragQueries:w,ragQueryResults:S},A=JSON.stringify(b),E=await this.summaryCompletion.getSummaryJson(R,A,l.ModelCategory.RAG_QUERY,!1,e.modelName),T=JSON.parse(E);return{formId:e.formId,normalizedQuestionText:a.normalizedQuestionText,questionPath:e.questionPath,answerText:T.answerText,confidence:T.confidence,references:T.references,ragQueries:w,ragQueryResults:S,modelUsed:u}}};t.FormAnswersService=f,f.RESULTS_PER_QUERY=2,f.RAG_QUERY_PROMPT_LEGACY="You are an AI assistant helping to generate RAG (Retrieval Augmented Generation) queries for answering form questions.",f.BASE_PROMPT='You are an AI assistant helping to answer form questions based on provided context.\n\nThe context object contains:\n- sectionTitle: The title of the form section containing the question\n- targetQuestion: The details of the question that needs to be answered - includes the question path, normalized question text and any additional info as well as type info: text, text-area, number, boolean, multipleChoice\n- ragQueries: The RAG queries that were used to retrieve the context\n- ragQueryResults: Relevant context retrieved for the question\n\n{RELATED_ANSWERS}\n\nHere are the list of other question paths in this section - these will all get answered in a different query - so your answer should not overlap with these:\n{OTHER_QUESTION_PATHS_IN_THIS_SECTION}\n\nPlease provide a focused answer that:\n1. Uses the provided context effectively, prioritizing the most relevant information from the RAG results\n2. Doesn\'t overlap with other questions in the section as they will be answered in a different query\n3. Is the minimum amount of text needed to answer the question as it will be directly entered into the form\n\nQuestion type:\n- If the type is text then a short precise answer is best\n- If the type is text-area then a longer answer is appropriate\n- If the type is number then the answer should be a number\n- If the type is boolean then the answer should be a boolean\n- If the type is multipleChoice then the answer should be one of the provided choices\n\nResponse format: {"answerText": "your answer", "confidence": 0.X, "references": [{ "type": "rag", "text": "reference text", "source": "where the reference text came from" }, { "type": "form", "text": "reference text", "source": "question path" }]}\n\nFor the source field use the metadata/source field from the RAG query results or the question path for form answers\n\nDO NOT REPEAT THE QUESTION OR CONTEXT IN YOUR ANSWER TEXT.\nIMPORTANT: if there are related answers provided then your answer MUST BE CONSISTENT WITH THEM!!\n',f.PARTIAL_ANSWER_PROMPT='You are an AI assistant helping to complete a partially answered form question based on provided context.\n\nThe context object contains:\n- sectionTitle: The title of the form section containing the question\n- targetQuestion: The details of the question that needs to be answered - includes the question path, normalized question text and any additional info as well as type info: text, text-area, number, boolean, multipleChoice\n- partialAnswer: The user\'s partial answer that needs to be built upon\n- ragQueries: The RAG queries that were used to retrieve the context\n- ragQueryResults: Relevant context retrieved for the question\n\n{RELATED_ANSWERS}\n\nHere are the list of other question paths in this section - these will all get answered in a different query - so your answer should not overlap with these:\n{OTHER_QUESTION_PATHS_IN_THIS_SECTION}\n\nPlease provide a complete answer that:\n1. Builds upon and incorporates the user\'s partial answer\n2. Maintains the user\'s original intent and perspective\n3. Uses the provided context effectively, with special emphasis on the partial answer RAG results\n4. Adds any missing important information to make the answer complete\n5. Doesn\'t overlap with other questions in the section\n6. Is the minimum amount of text needed while ensuring completeness\n\nQuestion type:\n- If the type is text then a short precise answer is best\n- If the type is text-area then a longer answer is appropriate\n- If the type is number then the answer should be a number\n- If the type is boolean then the answer should be a boolean\n- If the type is multipleChoice then the answer should be one of the provided choices\n\nResponse format: {"answerText": "your answer", "confidence": 0.X, "references": [{ "type": "rag", "text": "reference text", "source": "where the reference text came from" }, { "type": "form", "text": "reference text", "source": "question path" }]}\n\nFor the source field use the metadata/source field from the RAG query results or the question path for form answers\n\nDO NOT REPEAT THE QUESTION OR CONTEXT IN YOUR ANSWER TEXT.\nIMPORTANT: if there are related answers provided then your answer MUST BE CONSISTENT WITH THEM!!\n',t.FormAnswersService=f=o=n([(0,i.Injectable)(),s("design:paramtypes",[a.DatasetRetrievalService,c.SummaryCompletion,d.FormSectionRepository,d.FormAnswerRepository,u.ConfigService])],f)},1472:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormController=void 0;const i=r(3563),a=r(1909),c=r(412),l=r(9543),d=r(6815),u=r(3896),p=r(7628),f=r(4391),h=r(9055);let m=class{constructor(e,t){this.formService=e,this.formAnswersService=t}async buildForm(e){try{return await this.formService.buildNewForm(e.fileId,e.sessionId,e.model)}catch(e){throw h.default.error(`Error building form: ${e.message}\n${e.stack}`),new i.InternalServerErrorException("Failed to build form")}}async getForms(){try{return await this.formService.getFormList()}catch(e){throw h.default.error(`Error getting forms list: ${e.message}\n${e.stack}`),new i.InternalServerErrorException("Failed to retrieve forms list")}}async getForm(e){try{const t=await this.formService.getFormWithSections(e);if(!t)throw new i.NotFoundException(`Form with ID ${e} not found`);return t}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error getting form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to retrieve form")}}async getFormSection(e,t){try{const r=await this.formService.getFormSection(e,t);if(!r)throw new i.NotFoundException(`Section with ID ${t} not found in form ${e}`);return r}catch(r){if(r instanceof i.NotFoundException)throw r;throw h.default.error(`Error getting form section ${t} for form ${e}: ${r.message}\n${r.stack}`),new i.InternalServerErrorException("Failed to retrieve form section")}}async updateForm(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.updateFormTitle(e,t.title),{message:"Form updated successfully"}}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error updating form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to update form")}}async deleteForm(e){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.deleteForm(e),{message:"Form deleted successfully"}}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error deleting form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to delete form")}}async updateFormAnswer(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.updateAnswer(e,t),{message:"Answer updated successfully"}}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error updating form answer for form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to update form answer")}}async getFormAnswers(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.getAnswers(e,t)}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error getting form answers for form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to retrieve form answers")}}async deleteFormAnswers(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.deleteAnswers(e,t),{message:"Answers deleted successfully"}}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error deleting form answers for form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to delete form answers")}}async queryAnswer(e){try{return await this.formAnswersService.queryAnswer(e)}catch(e){throw h.default.error(`Error querying answer: ${e.message}\n${e.stack}`),new i.InternalServerErrorException("Failed to query answer")}}async exportForm(e,t){try{h.default.info(`Exporting form ${e}`);const r=await this.formService.getForm(e);if(!r)return void t.status(404).json({statusCode:404,message:`Form with ID ${e} not found`,error:"Not Found"});if(!await this.formService.getSourceFile(r.sourceFileId))return void t.status(404).json({statusCode:404,message:`Source file not found for form ${e}`,error:"Not Found"});const{buffer:o,fileName:n,contentType:s}=await this.formService.exportForm(e);if(!o||0===o.length)return void t.status(500).json({statusCode:500,message:"Failed to generate export file",error:"Internal Server Error"});t.setHeader("Content-Type",s),t.setHeader("Content-Disposition",`attachment; filename="${n}"`),t.setHeader("Content-Length",o.length),t.status(200),t.end(o)}catch(r){h.default.error(`Error exporting form ${e}: ${r.message}\n${r.stack}`);const o=r instanceof i.NotFoundException?404:500,n=r.message||"Failed to export form",s=r instanceof i.NotFoundException?"Not Found":"Internal Server Error";t.setHeader("Content-Type","application/json"),t.status(o).json({statusCode:o,message:n,error:s})}}async copyForm(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);const r=await this.formService.copyForm(e,t.title,t.copyAnswers,t.sessionId);if(!r)throw new i.NotFoundException(`Failed to copy form with ID ${e}`);return r}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error copying form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to copy form")}}};t.FormController=m,o([(0,i.Post)("build"),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[c.CreateFormRequest]),n("design:returntype",Promise)],m.prototype,"buildForm",null),o([(0,i.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],m.prototype,"getForms",null),o([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],m.prototype,"getForm",null),o([(0,i.Get)(":id/sections/:sectionId"),s(0,(0,i.Param)("id")),s(1,(0,i.Param)("sectionId")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],m.prototype,"getFormSection",null),o([(0,i.Put)(":id"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,d.UpdateFormRequest]),n("design:returntype",Promise)],m.prototype,"updateForm",null),o([(0,i.Delete)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],m.prototype,"deleteForm",null),o([(0,i.Post)(":id/answers"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,u.UpdateFormAnswerDto]),n("design:returntype",Promise)],m.prototype,"updateFormAnswer",null),o([(0,i.Get)(":id/answers"),s(0,(0,i.Param)("id")),s(1,(0,i.Query)("questionPathPrefix")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],m.prototype,"getFormAnswers",null),o([(0,i.Delete)(":id/answers"),s(0,(0,i.Param)("id")),s(1,(0,i.Query)("questionPathPrefix")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],m.prototype,"deleteFormAnswers",null),o([(0,i.Post)("query-answer"),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[p.AnswerQueryRequest]),n("design:returntype",Promise)],m.prototype,"queryAnswer",null),o([(0,i.Post)(":id/export"),s(0,(0,i.Param)("id")),s(1,(0,i.Res)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],m.prototype,"exportForm",null),o([(0,i.Post)(":id/copy"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,l.CopyFormRequest]),n("design:returntype",Promise)],m.prototype,"copyForm",null),t.FormController=m=o([(0,i.Controller)("forms"),n("design:paramtypes",[a.FormService,f.FormAnswersService])],m)},7687:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FormAnswer=t.FormAnswerOption=t.FormSection=t.Form=void 0,t.countNestedQuestions=r;t.Form=class{constructor(e,t,r,o,n){this.id=e,this.sourceFileId=t,this.title=r,this.createdAt=o,this.sessionId=n}};t.FormSection=class{constructor(e,t,o,n,s,i){this.id=e,this.formId=t,this.path=o,this.title=n,this.json=s,this.createdAt=i,this.questionCount=r(this.getQuestions())}getQuestions(){return JSON.parse(this.json)}};t.FormAnswerOption=class{constructor(e,t,r,o){this.id=e,this.questionPath=t,this.value=r,this.confidence=o}};function r(e){let t=0;for(const o of e)o.subQuestions&&o.subQuestions.length>0?t+=r(o.subQuestions):t++;return t}t.FormAnswer=class{constructor(e,t,r,o,n,s,i,a){this.id=e,this.formId=t,this.questionPath=r,this.normalizedQuestionText=o,this.value=n,this.formAnswerOptionId=s,this.confidence=i,this.originalInputXpath=a}}},4240:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.FormModule=void 0;const n=r(3563),s=r(1472),i=r(1909),a=r(9496),c=r(376),l=r(6552),d=r(7967),u=r(7184),p=r(8624),f=r(7701),h=r(6941),m=r(3239),g=r(4391),y=r(6696);let w=class{};t.FormModule=w,t.FormModule=w=o([(0,n.Module)({imports:[c.DataSourceModule,p.StoredFileModule,l.DatasetModule,d.ConfigModule],controllers:[s.FormController],providers:[i.FormService,g.FormAnswersService,y.DatasetRetrievalService,a.FormRepository,a.FormSectionRepository,a.FormAnswerOptionRepository,a.FormAnswerRepository,u.DatasetRepository,f.DocxFormBuilder,m.SummaryCompletion,{provide:"FORM_BUILDERS",useFactory:e=>[e],inject:[f.DocxFormBuilder]},h.DocxFormExporter,{provide:"FORM_EXPORTERS",useFactory:e=>[e],inject:[h.DocxFormExporter]}],exports:[i.FormService]})],w)},9496:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormAnswerRepository=t.FormAnswerOptionRepository=t.FormSectionRepository=t.FormRepository=void 0;const i=r(3563),a=(r(1832),r(7687)),c=r(9100);let l=class{constructor(e){this.knex=e}async findById(e){return this.knex("forms").where("id",e).first()}async findAll(e=20){return this.knex("forms").orderBy("createdAt","desc").limit(e)}async findBySessionId(e){return this.knex("forms").where("sessionId",e)}async create(e,t,r){const o=(0,c.ulid)(),n=(new Date).toISOString();return await this.knex("forms").insert({id:o,sourceFileId:e,title:t,createdAt:n,sessionId:r,status:"processing",questionCount:0}),o}async updateSectionAndQuestionCount(e,t,r){await this.knex("forms").where("id",e).update({numberOfSections:t,questionCount:r})}async updateStatus(e,t){await this.knex("forms").where("id",e).update({status:t})}async delete(e){await this.knex("forms").where("id",e).delete()}async updateTitle(e,t){await this.knex("forms").where("id",e).update({title:t})}};t.FormRepository=l,t.FormRepository=l=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],l);let d=class{constructor(e){this.knex=e}async findByFormId(e){return(await this.knex("form_sections").where("formId",e).orderBy("id")).map((e=>new a.FormSection(e.id,e.formId,e.path,e.title,e.json,new Date(e.createdAt))))}async findById(e){const t=await this.knex("form_sections").where("id",e).first();return t?new a.FormSection(t.id,t.formId,t.path,t.title,t.json,new Date(t.createdAt)):null}ensureUlids(e,t=!1){e.forEach((e=>{e.id&&!t||(e.id=(0,c.ulid)()),e.subQuestions&&this.ensureUlids(e.subQuestions,t)}))}async create(e,t,r,o,n,s=!1){const i=(new Date).toISOString();this.ensureUlids(n,s);const c=JSON.stringify(n),l=(0,a.countNestedQuestions)(n);return await this.knex("form_sections").insert({id:t,formId:e,path:r,title:o,json:c,createdAt:i,status:"ready",questionCount:l}),t}async updateStatus(e,t){await this.knex("form_sections").where("id",e).update({status:t})}async deleteByFormId(e){await this.knex("form_sections").where("formId",e).delete()}};t.FormSectionRepository=d,t.FormSectionRepository=d=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],d);let u=class{constructor(e){this.knex=e}async findByQuestionPath(e){return this.knex("form_answer_options").where("questionPath",e).orderBy("confidence","desc")}async create(e,t,r,o){const n=(0,c.ulid)();return await this.knex("form_answer_options").insert({id:n,formId:e,questionPath:t,value:r,confidence:o}),n}async deleteByFormId(e){await this.knex("form_answer_options").where("formId",e).delete()}};t.FormAnswerOptionRepository=u,t.FormAnswerOptionRepository=u=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],u);let p=class{constructor(e){this.knex=e}async getAnswersCount(e){const t=await this.knex("form_answers").where("formId",e).count("id as count").first();return t?.count||0}async findByQuestionPathPrefix(e){let t=this.knex("form_answers");return t=t.where("questionPath","like",`${e}%`),t.orderBy("questionPath")}async findByUniqueQuestionPath(e){return this.knex("form_answers").where("questionPath",e).first()}async findByFormId(e,t){let r=this.knex("form_answers").where("formId",e);return t&&(r=r.where("questionPath","like",`${t}%`)),r.orderBy("questionPath")}async upsertAnswer(e,t){await this.knex("form_answers").where({formId:e,questionPath:t.questionPath}).first()?t.value&&""===t.value.trim()?await this.knex("form_answers").where({formId:e,questionPath:t.questionPath}).delete():await this.knex("form_answers").where({formId:e,questionPath:t.questionPath}).update({normalizedQuestionText:t.normalizedQuestionText,value:t.value,formAnswerOptionId:t.formAnswerOptionId,confidence:t.confidence,originalInputXpath:t.originalInputXpath}):await this.knex("form_answers").insert({id:(0,c.ulid)(),formId:e,...t})}async create(e,t,r,o,n,s){const i=(0,c.ulid)();return await this.knex("form_answers").insert({id:i,formId:e,questionPath:t,normalizedQuestionText:r,value:o,formAnswerOptionId:n,confidence:s}),i}async deleteByFormId(e){await this.knex("form_answers").where("formId",e).delete()}async deleteByQuestionPathPrefix(e,t){await this.knex("form_answers").where("formId",e).where("questionPath","like",`${t}%`).delete()}};t.FormAnswerRepository=p,t.FormAnswerRepository=p=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],p)},1909:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormService=void 0;const i=r(3563),a=r(7205),c=r(9496),l=r(7687),d=r(9055),u=r(9100);let p=class{constructor(e,t,r,o,n,s,i){this.formRepository=e,this.formSectionRepository=t,this.formAnswerOptionRepository=r,this.formAnswerRepository=o,this.storedFileService=n,this.formBuilders=s,this.formExporters=i}async getSourceFile(e){try{return await this.storedFileService.getFile(e)}catch(t){return d.default.error(`Error getting source file ${e}:`,t),null}}async createForm(e,t,r){try{const o=await this.formRepository.create(e,t,r);return d.default.info(`Created form with id ${o}`),o}catch(e){throw d.default.error("Error creating form:",e),e}}async addSection(e,t,r,o,n){try{if(!await this.formRepository.findById(e))throw new Error(`Form not found with id ${e}`);const s=await this.formSectionRepository.create(e,t,r,o,n);return d.default.info(`Added section ${s} to form ${e}`),s}catch(e){throw d.default.error("Error adding section:",e),e}}async addAnswerOption(e,t,r,o){try{const n=await this.formAnswerOptionRepository.create(e,t,r,o);return d.default.info(`Added answer option ${n} for question ${t}`),n}catch(e){throw d.default.error("Error adding answer option:",e),e}}async addAnswer(e,t,r,o,n,s){try{const i=await this.formAnswerRepository.create(e,t,r,o,n,s);return d.default.info(`Added answer ${i} for question ${t}`),i}catch(e){throw d.default.error("Error adding answer:",e),e}}async getForm(e){try{const t=await this.formRepository.findById(e);return t||null}catch(e){throw d.default.error("Error getting form:",e),e}}async getFormWithSections(e){try{const t=await this.formRepository.findById(e);if(!t)return null;const r=await this.formSectionRepository.findByFormId(e);return{...t,sections:r.map((e=>({id:e.id,path:e.path,title:e.title,status:e.status,createdAt:e.createdAt,questionCount:e.questionCount})))}}catch(e){throw d.default.error("Error getting form with sections:",e),e}}async getFormSection(e,t){try{const r=await this.formSectionRepository.findById(t);return r&&r.formId===e?{id:r.id,formId:r.formId,path:r.path,title:r.title,questions:JSON.parse(r.json),createdAt:r.createdAt,status:r.status}:null}catch(e){throw d.default.error("Error getting form section:",e),e}}async getFormList(e=20){try{const t=await this.formRepository.findAll(e);return await Promise.all(t.map((async e=>{const t=await this.formAnswerRepository.getAnswersCount(e.id);return{id:e.id,title:e.title,createdAt:e.createdAt,status:e.status,questionCount:e.questionCount,answersCount:t}})))}catch(e){throw d.default.error("Error getting form list:",e),e}}async getFormSections(e){try{return await this.formSectionRepository.findByFormId(e)}catch(e){throw d.default.error("Error getting form sections:",e),e}}async getAnswerOptions(e){try{return await this.formAnswerOptionRepository.findByQuestionPath(e)}catch(e){throw d.default.error("Error getting answer options:",e),e}}async getAnswers(e,t){try{return await this.formAnswerRepository.findByFormId(e,t)}catch(e){throw d.default.error("Error getting answers:",e),e}}async updateAnswer(e,t){try{await this.formAnswerRepository.upsertAnswer(e,t),d.default.info(`Updated/created answer for form ${e}, question ${t.questionPath}`)}catch(e){throw d.default.error("Error updating answer:",e),e}}async buildNewForm(e,t,r){try{const o=await this.storedFileService.getFile(e);if(!o)throw new Error(`File not found with id ${e}`);const n=this.formBuilders.find((e=>e.canHandle(o)));if(!n)throw new Error(`No form builder found for file type ${o.mimeType} with filename ${o.originalFilename}`);const s=await n.extractTitle(o),i=await this.createForm(e,s,t);this.processSectionsInBackground(i,o,n,r);const a=await this.getFormWithSections(i);if(!a)throw new Error(`Failed to retrieve created form with id ${i}`);return a}catch(e){throw d.default.error("Error building new form:",e),e}}async deleteAnswers(e,t){try{t?(await this.formAnswerRepository.deleteByQuestionPathPrefix(e,t),d.default.info(`Deleted answers for form ${e} with prefix ${t}`)):(await this.formAnswerRepository.deleteByFormId(e),d.default.info(`Deleted all answers for form ${e}`))}catch(e){throw d.default.error("Error deleting answers:",e),e}}async updateFormTitle(e,t){try{if(!await this.formRepository.findById(e))throw new Error(`Form not found with id ${e}`);await this.formRepository.updateTitle(e,t),d.default.info(`Updated title for form ${e}`)}catch(e){throw d.default.error("Error updating form title:",e),e}}async deleteForm(e){try{await this.formAnswerRepository.deleteByFormId(e),await this.formAnswerOptionRepository.deleteByFormId(e),await this.formSectionRepository.deleteByFormId(e),await this.formRepository.delete(e),d.default.info(`Successfully deleted form ${e} and all related data`)}catch(t){throw d.default.error(`Error deleting form ${e}:`,t),t}}async exportForm(e){try{const t=await this.getForm(e);if(!t)throw new Error(`Form not found with id ${e}`);const r=await this.storedFileService.getFile(t.sourceFileId);if(!r)throw new Error(`Source file not found with id ${t.sourceFileId}`);const o=this.formExporters.find((e=>e.canHandle(t,r)));if(!o)throw new Error(`No form exporter found that can handle form ${e}`);const n=await o.export(t,r),s=o.getDefaultFileName(t,r);return{buffer:n,fileName:s,contentType:o.getContentType(r)}}catch(e){throw d.default.error("Error exporting form:",e),e}}async copyForm(e,t,r=!0,o){try{const n=await this.formRepository.findById(e);if(!n)return d.default.error(`Form not found with id ${e}`),null;d.default.info(`Copying form ${e} with title ${t} and copyAnswers ${r}`);const s=await this.formRepository.create(n.sourceFileId,t,o||(0,u.ulid)());d.default.info(`Created new form ${s}`);const i=new Map,a=await this.formSectionRepository.findByFormId(e);for(const e of a){const t=(0,u.ulid)();i.set(e.id,t);const r=JSON.parse(e.json.replace(new RegExp(e.id,"g"),t));await this.formSectionRepository.create(s,t,t,e.title,r,!0)}if(d.default.info(`Copied ${a.length} sections to form ${s}`),r){const t=await this.formAnswerRepository.findByFormId(e);d.default.info(`Copying ${t.length} answers to form ${s}`);for(const e of t)if(e.value&&""!==e.value.trim()){const t=e.questionPath.split("/")[0],r=i.get(t),o=e.questionPath.replace(new RegExp(t,"g"),r);d.default.info(`Copying answer ${e.id} in section ${r} for question ${e.questionPath} to ${o}`),await this.formAnswerRepository.create(s,o,e.normalizedQuestionText,e.value,e.formAnswerOptionId,e.confidence)}}return await this.formRepository.updateStatus(s,"ready"),this.getFormWithSections(s)}catch(e){throw d.default.error("Error copying form:",e),e}}async processSectionsInBackground(e,t,r,o){try{let n=0,s=0;for await(const i of r.generateSections(t,o)){await this.addSection(e,i.id,i.path,i.title,i.questions);s+=(0,l.countNestedQuestions)(i.questions),n++}await this.formRepository.updateSectionAndQuestionCount(e,n,s),await this.formRepository.updateStatus(e,"ready"),d.default.info(`Completed processing form ${e} with ${n} sections and ${s} questions`)}catch(t){d.default.error(`Error processing sections for form ${e}:`,t),await this.formRepository.updateStatus(e,"error")}}};t.FormService=p,t.FormService=p=o([(0,i.Injectable)(),s(5,(0,i.Inject)("FORM_BUILDERS")),s(6,(0,i.Inject)("FORM_EXPORTERS")),n("design:paramtypes",[c.FormRepository,c.FormSectionRepository,c.FormAnswerOptionRepository,c.FormAnswerRepository,a.StoredFileService,Array,Array])],p)},5754:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitLogEntry=void 0;t.GitLogEntry=class{constructor(e,t,r,o,n){this.hash=e,this.message=r,this.date=t,this.author_name=o,this.author_email=n}}},7265:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.GitController=void 0;const i=r(3563),a=r(5190);let c=class{constructor(e){this.gitService=e}async getGitLog(e){try{return await this.gitService.getGitLog(e)}catch(t){if(t.message.includes("not found"))throw new i.HttpException(`Workspace ${e} not found`,i.HttpStatus.NOT_FOUND);if(t.message.includes("not a git repository"))throw new i.HttpException("Workspace is not a git repository",i.HttpStatus.BAD_REQUEST);throw new i.HttpException(`Failed to get git log: ${t.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}async getGitDiff(e,t){try{return await this.gitService.getGitDiff(e,t)}catch(t){if(t.message.includes("not found"))throw new i.HttpException(`Workspace ${e} not found`,i.HttpStatus.NOT_FOUND);throw new i.HttpException(`Failed to get git diff: ${t.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}async undoLastCommit(e){try{await this.gitService.undoLastCommit(e)}catch(t){if(t.message.includes("not found"))throw new i.HttpException(`Workspace ${e} not found`,i.HttpStatus.NOT_FOUND);throw new i.HttpException(`Failed to undo last commit: ${t.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}};t.GitController=c,o([(0,i.Get)(":workspaceName/log"),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getGitLog",null),o([(0,i.Get)(":workspaceName/diff/:hash"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("hash")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"getGitDiff",null),o([(0,i.Post)(":workspaceName/undo-last-commit"),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"undoLastCommit",null),t.GitController=c=o([(0,i.Controller)("git"),n("design:paramtypes",[a.GitService])],c)},1901:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.GitModule=void 0;const n=r(3563),s=r(7265),i=r(5190),a=r(5873);let c=class{};t.GitModule=c,t.GitModule=c=o([(0,n.Module)({imports:[a.WorkspaceModule],controllers:[s.GitController],providers:[i.GitService]})],c)},5190:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.GitService=void 0;const s=r(3563),i=r(8474),a=r(5754),c=r(9055),l=r(3807);let d=class{constructor(e){this.workspaceService=e}async getGit(e){const t=await this.workspaceService.findOne(e);if(!t)throw new Error(`Workspace ${e} not found`);return(0,l.default)(t.repoBaseDir)}async undoLastCommit(e){const t=await this.getGit(e);try{await t.reset(["--hard","HEAD~1"])}catch(e){throw new Error(`Failed to undo last commit: ${e.message}`)}}async getGitLog(e){const t=await this.getGit(e);try{return(await t.log(["-n","15"])).all.map((e=>new a.GitLogEntry(e.hash,e.date,e.message,e.author_name,e.author_email)))}catch(e){return e instanceof Error&&e.message.includes("not a git repository")||c.default.warn(`Failed to fetch git log: ${e.message}`),[]}}async getGitDiff(e,t){const r=await this.getGit(e);try{return await r.show(["--unified",t])}catch(e){throw new Error(`Failed to get git diff: ${e.message}`)}}};t.GitService=d,t.GitService=d=o([(0,s.Injectable)(),n("design:paramtypes",[i.WorkspaceService])],d)},5096:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldController=void 0;const s=r(3563),i=r(5533);let a=class{constructor(e){this.helloWorldService=e}getHello(){return this.helloWorldService.getHello()}};t.HelloWorldController=a,o([(0,s.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",String)],a.prototype,"getHello",null),t.HelloWorldController=a=o([(0,s.Controller)("hello-world"),n("design:paramtypes",[i.HelloWorldService])],a)},6808:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldModule=void 0;const n=r(3563),s=r(5096),i=r(5533);let a=class{};t.HelloWorldModule=a,t.HelloWorldModule=a=o([(0,n.Module)({controllers:[s.HelloWorldController],providers:[i.HelloWorldService]})],a)},5533:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldService=void 0;const n=r(3563);let s=class{getHello(){return"Hello World!"}};t.HelloWorldService=s,t.HelloWorldService=s=o([(0,n.Injectable)()],s)},4193:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HomeModule=void 0;const n=r(3563),s=r(538),i=r(7967);let a=class{};t.HomeModule=a,t.HomeModule=a=o([(0,n.Module)({imports:[i.ConfigModule],providers:[s.HomeService],exports:[s.HomeService]})],a)},538:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.HomeService=void 0;const i=r(3563),a=r(2368),c=r(8938),l=r(857);class d{constructor(e){const{requestContent:t,responseContent:r,startedAt:o,endedAt:n,...s}=e;this.requestData=s}toJSON(){return this.requestData}}let u=o=class{constructor(e){this.configService=e,this.logger=new i.Logger(o.name),this.accessCheck={lastResultCode:null,timeOfLastCheck:null,failedToConnect:!1},this.workerQueue=[],this.workerInterval=null,this.isShuttingDown=!1}onModuleInit(){this.startWorkerThread()}async onApplicationShutdown(e){this.logger.log("Application shutdown initiated"+(e?` (signal: ${e})`:"")),this.isShuttingDown=!0,this.workerInterval&&clearInterval(this.workerInterval),this.workerQueue.length>0&&(this.logger.log(`Processing ${this.workerQueue.length} remaining requests before shutdown`),await this.processRemainingRequests()),this.logger.log("Shutdown process completed")}isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async checkAccess(){const e=this.configService.getProperty("HLDK_API_KEY");if(!e)throw new Error("API Key is not configured");if(!this.isValidUUID(e))throw new Error("Invalid API Key");const t=l.hostname();try{const r=await c.default.post("https://otiiwxlfsrejhbrxdras.supabase.co/functions/v1/log-access",{hostname:t},{headers:{Authorization:`Bearer ${e}`},timeout:3e3});this.accessCheck={lastResultCode:r.status,timeOfLastCheck:new Date,failedToConnect:!1}}catch(e){if(c.default.isAxiosError(e)){const t=e;t.response?this.accessCheck={lastResultCode:t.response.status,timeOfLastCheck:new Date,failedToConnect:!1}:(t.request,this.accessCheck={lastResultCode:null,timeOfLastCheck:new Date,failedToConnect:!0})}else this.accessCheck={lastResultCode:null,timeOfLastCheck:new Date,failedToConnect:!0};this.logger.error("Failed to check access",e)}return this.accessCheck}async isAccessOkay(){const e=new Date(Date.now()-864e5);return(!this.accessCheck.timeOfLastCheck||this.accessCheck.timeOfLastCheck<e||403===this.accessCheck.lastResultCode)&&await this.checkAccess(),200===this.accessCheck.lastResultCode||this.accessCheck.failedToConnect}async logRequest(e){await this.isAccessOkay()&&!this.accessCheck.failedToConnect&&this.workerQueue.push(new d(e))}startWorkerThread(){this.workerInterval=setInterval((async()=>{if(this.workerQueue.length>0&&!this.isShuttingDown){const e=[...this.workerQueue];this.workerQueue=[],await this.sendRequestsToHomeServer(e)}}),1e4)}async processRemainingRequests(){if(this.workerQueue.length>0){const e=[...this.workerQueue];this.workerQueue=[],await this.sendRequestsToHomeServer(e)}}async sendRequestsToHomeServer(e){const t=this.configService.getProperty("HLDK_API_KEY");if(!t)return void this.logger.log("API Key is not configured");const r=e.map((e=>c.default.post("https://otiiwxlfsrejhbrxdras.supabase.co/functions/v1/log-request",e,{headers:{Authorization:`Bearer ${t}`},timeout:5e3})));(await Promise.allSettled(r)).forEach(((e,t)=>{"rejected"===e.status&&this.logger.log(`Failed to log request at index ${t}`,e.reason)}))}};t.HomeService=u,t.HomeService=u=o=n([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigService])],u)},2303:(e,t)=>{"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.Mutation=t.MutationType=void 0,function(e){e.CREATE="create",e.UPDATE="update",e.DELETE="delete"}(r||(t.MutationType=r={}));t.Mutation=class{constructor(e,t,r,o,n,s,i,a,c){this.id=e,this.type=t,this.filePath=r,this.description=o,this.fileContentsBefore=n,this.fileContentsAfter=s,this.updatedAt=i,this.sessionId=a,this.requestId=c}}},672:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationRepository=void 0;const i=r(3563),a=(r(1832),r(3903)),c=r(9055);let l=class{constructor(e){this.knex=e}async findAll(e,t){let r=this.knex("mutations").select("*");if(t&&(r=r.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:o}=e,n=(t-1)*o;r=r.offset(n).limit(o)}return r}async findById(e){return this.knex("mutations").where("id",e).first()}async findBySessionId(e,t,r){let o=this.knex("mutations").where("sessionId",e);if(r&&(o=o.orderBy(r.field,r.order.toLowerCase())),t){const{page:e,limit:r}=t,n=(e-1)*r;o=o.offset(n).limit(r)}return o}async findBySessionIds(e){return this.knex("mutations").whereIn("sessionId",e)}async findByRequestId(e){return this.knex("mutations").where("requestId",e)}async create(e){const t=(0,a.v4)(),r=(new Date).toISOString();try{return await this.knex("mutations").insert({id:t,...e,updatedAt:r}),t}catch(o){throw c.default.error("Failed to create mutation:",{error:o.message,stack:o.stack,mutation:{id:t,...e,updatedAt:r}}),o}}async update(e,t){await this.knex("mutations").where("id",e).update(t)}async delete(e){await this.knex("mutations").where("id",e).delete()}};t.MutationRepository=l,t.MutationRepository=l=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],l)},9989:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsController=void 0;const i=r(3563),a=r(7602);let c=class{constructor(e){this.mutationsService=e}async getMutationsForSession(e){return this.mutationsService.getMutationsForSession(e)}async getMutation(e){return this.mutationsService.getMutation(e)}};t.MutationsController=c,o([(0,i.Get)("session/:sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getMutationsForSession",null),o([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getMutation",null),t.MutationsController=c=o([(0,i.Controller)("mutations"),n("design:paramtypes",[a.MutationsService])],c)},3177:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsModule=void 0;const n=r(3563),s=r(376),i=r(9989),a=r(7602),c=r(672);let l=class{};t.MutationsModule=l,t.MutationsModule=l=o([(0,n.Module)({imports:[s.DataSourceModule],controllers:[i.MutationsController],providers:[a.MutationsService,c.MutationRepository],exports:[a.MutationsService]})],l)},7602:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsService=void 0;const s=r(3563),i=r(672);let a=class{constructor(e){this.mutationRepository=e}async getMutationsForSession(e){return(await this.mutationRepository.findBySessionId(e,void 0,{field:"updatedAt",order:"DESC"})).map((e=>({id:e.id,type:e.type,filePath:e.filePath,updatedAt:e.updatedAt,description:e.description,fileContentsBefore:e.fileContentsBefore,fileContentsAfter:e.fileContentsAfter,requestId:e.requestId})))}async getMutation(e){return this.mutationRepository.findById(e)}async getMutationsForRequest(e){return(await this.mutationRepository.findByRequestId(e)).map((e=>({id:e.id,type:e.type,filePath:e.filePath,updatedAt:e.updatedAt,description:e.description,fileContentsBefore:e.fileContentsBefore,fileContentsAfter:e.fileContentsAfter,requestId:e.requestId})))}async createMutation(e){if(!e.sessionId)throw new Error("sessionId is required to create a mutation");if(!e.requestId)throw new Error("requestId is required to create a mutation");return await this.mutationRepository.create({...e,updatedAt:e.updatedAt||new Date})}};t.MutationsService=a,t.MutationsService=a=o([(0,s.Injectable)(),n("design:paramtypes",[i.MutationRepository])],a)},7307:function(__unused_webpack_module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},PluginLoaderService_1;Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginLoaderService=void 0;const common_1=__webpack_require__(3563),fs=__webpack_require__(4652),path=__webpack_require__(6928),graph_agent_collaborator_service_1=__webpack_require__(2300),graph_agent_service_1=__webpack_require__(5277),logger_1=__webpack_require__(9055),tool_factory_service_1=__webpack_require__(6158),agent_rule_service_1=__webpack_require__(3470);let PluginLoaderService=PluginLoaderService_1=class PluginLoaderService{constructor(e,t,r){this.agentCollaborator=e,this.toolFactoryService=t,this.ruleService=r,this.logger=new common_1.Logger(PluginLoaderService_1.name)}async loadPlugins(){const e=[];try{const t=process.env.PLUGIN_DIR||path.join(__dirname,"..","..","plugins");if(logger_1.default.info(`Loading plugins from: ${t}`),!t)return logger_1.default.info("PLUGIN_DIR not set, skipping plugin loading"),e;if(!await fs.pathExists(t))return logger_1.default.warn(`Plugin directory not found: ${t}`),e;const r=await fs.readdir(t);for(const o of r){const r=path.join(t,o,"plugin-config.json");if(await fs.pathExists(r)){const n=await fs.readJson(r),s=await this.loadPlugin(t,o,n);e.push(...s)}else logger_1.default.warn(`No plugin-config.json found for plugin: ${o}. Skipping.`)}}catch(e){logger_1.default.error("Error loading plugins: %s",e.message,e.stack)}return e}async loadPlugin(e,t,r){logger_1.default.info(`Loading plugin: ${t}`);const o=[];if(r.agents)for(const[n,s]of Object.entries(r.agents)){const r=await this.loadAgent(e,t,n,s);r&&o.push(r)}if(r.tools)for(const[o,n]of Object.entries(r.tools))await this.loadTool(e,t,o,n);return r.tests&&await this.runTests(e,t,r.tests),o}async loadAgent(pluginDir,pluginName,agentName,agentFile){const agentPath=path.join(pluginDir,pluginName,agentFile);if(await fs.pathExists(agentPath))try{const AgentModule=eval("require")(agentPath),agentImplementation=AgentModule.default||AgentModule,agent=new graph_agent_service_1.GraphAgentService(this.agentCollaborator,this.toolFactoryService,this.ruleService);for(const e of Object.getOwnPropertyNames(agentImplementation))"function"==typeof agentImplementation[e]&&"constructor"!==e&&(logger_1.default.info("Delegating method: %s to plugin: %s/%s",e,pluginName,agentName),agent[e]=async(...t)=>await agentImplementation[e](...t));return agent.getName=()=>agentName,logger_1.default.info(`Loaded agent: ${agentFile} from plugin: ${pluginName} with name: ${agent.getName()}`),agent}catch(e){logger_1.default.error(`Error loading agent: ${agentFile} from plugin: ${pluginName}`,e.stack)}else logger_1.default.warn(`Agent file not found: ${agentPath}`);return null}async loadTool(pluginDir,pluginName,toolName,toolFile){logger_1.default.info(`Loading tool: ${toolName} (${toolFile}) from plugin: ${pluginName}`);const toolPath=path.join(pluginDir,pluginName,toolFile);if(await fs.pathExists(toolPath))try{const ToolModule=eval("require")(toolPath);"function"==typeof ToolModule.createTool?(this.toolFactoryService.registerTool(toolName,ToolModule.createTool),logger_1.default.info(`Loaded tool: ${toolName} (${toolFile}) from plugin: ${pluginName}`)):logger_1.default.warn(`Tool ${toolName} (${toolFile}) from plugin: ${pluginName} does not export a 'createTool' function`)}catch(e){logger_1.default.error(`Error loading tool: ${toolName} (${toolFile}) from plugin: ${pluginName}`,e.stack)}}async runTests(e,t,r){for(const o of r){const r=path.join(e,t,o);if(await fs.pathExists(r))try{const e=await Promise.resolve(`${r}`).then((e=>__webpack_require__(6002)(e)));"function"==typeof e.default&&await e.default(),logger_1.default.info(`Ran test: ${o} for plugin: ${t}`)}catch(e){logger_1.default.error(`Error running test: ${o} for plugin: ${t}`,e.stack)}}}};exports.PluginLoaderService=PluginLoaderService,exports.PluginLoaderService=PluginLoaderService=PluginLoaderService_1=__decorate([(0,common_1.Injectable)(),__metadata("design:paramtypes",[graph_agent_collaborator_service_1.GraphAgentCollaborator,tool_factory_service_1.ToolFactoryService,agent_rule_service_1.AgentRuleService])],PluginLoaderService)},756:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.PluginModule=void 0;const n=r(3563),s=r(7307),i=r(2177),a=r(361),c=r(2424);let l=class{};t.PluginModule=l,t.PluginModule=l=o([(0,n.Module)({imports:[i.AgentsModule,a.ToolsModule,c.GraphAgentModule],providers:[s.PluginLoaderService],exports:[s.PluginLoaderService]})],l)},6002:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=6002,e.exports=t},353:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingController=void 0;const i=r(3563),a=r(7510);let c=class{constructor(e){this.reportingService=e}async getReport(e,t,r,o){return this.reportingService.generateReport(e,t,r,o)}};t.ReportingController=c,o([(0,i.Get)("report"),s(0,(0,i.Query)("from")),s(1,(0,i.Query)("to")),s(2,(0,i.Query)("period")),s(3,(0,i.Query)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String,String,String,String]),n("design:returntype",Promise)],c.prototype,"getReport",null),t.ReportingController=c=o([(0,i.Controller)("reporting"),n("design:paramtypes",[a.ReportingService])],c)},8221:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingModule=void 0;const n=r(3563),s=r(353),i=r(7510),a=r(376),c=r(7967);let l=class{};t.ReportingModule=l,t.ReportingModule=l=o([(0,n.Module)({imports:[a.DataSourceModule,c.ConfigModule],controllers:[s.ReportingController],providers:[i.ReportingService]})],l)},7510:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingService=void 0;const i=r(3563),a=(r(1832),r(9055)),c=r(2368),l=r(6910);let d=class{constructor(e,t){this.knex=e,this.configService=t}async generateReport(e,t,r,o){try{const{startDate:n,endDate:s}=this.resolveDateRange(e,t,r),i=await this.getRequestTotalsData(n,s,o);return{requestTotals:i,dailyMetrics:await this.getHistoricStats(n,s,o),dateRange:{startDate:n,endDate:s}}}catch(e){throw a.default.error(`Error generating report: ${e.message}`,e.stack),e}}resolveDateRange(e,t,r){const o=new Date;let n,s;try{if(e&&t)n=new Date(e),s=new Date(t),s.setHours(23,59,59,999);else if(r)switch(s=new Date(o),s.setHours(23,59,59,999),r){case"today":n=new Date(o),n.setHours(0,0,0,0);break;case"this-week":n=new Date(o),n.setDate(n.getDate()-7),n.setHours(0,0,0,0);break;case"this-month":n=new Date(o),n.setDate(n.getDate()-30),n.setHours(0,0,0,0);break;case"all-time":n=new Date(o),n.setDate(n.getDate()-90),n.setHours(0,0,0,0);break;default:throw new Error("Invalid period specified")}else n=new Date(o),n.setDate(n.getDate()-90),n.setHours(0,0,0,0),s=new Date(o),s.setHours(23,59,59,999);return{startDate:n,endDate:s}}catch(e){throw a.default.error(`Error resolving date range: ${e.message}`,e.stack),e}}async getRequestTotalsData(e,t,r){try{let o=this.knex("requests").select(this.knex.raw("COUNT(*) as totalRequests"),this.knex.raw("COALESCE(SUM(tookMillis), 0) as totalProcessingMillis"),this.knex.raw("COALESCE(AVG(tookMillis), 0) as avgProcessingMillis"),this.knex.raw("COALESCE(SUM(inputTokens), 0) as totalInputTokens"),this.knex.raw("COALESCE(SUM(outputTokens), 0) as totalOutputTokens"),this.knex.raw("COALESCE(SUM(totalTokens), 0) as totalTokens"),this.knex.raw("COALESCE(SUM(cost), 0) as totalCost"),this.knex.raw("COALESCE(AVG(cost), 0) as avgCostPerRequest"),this.knex.raw("COALESCE(SUM(CASE WHEN linesChanged <= 500 THEN linesChanged ELSE 0 END), 0) as totalLinesChanged"),this.knex.raw("COALESCE(AVG(CASE WHEN linesChanged <= 500 THEN linesChanged ELSE NULL END), 0) as avgLinesChangedPerRequest"),this.knex.raw("COALESCE(SUM(filesChanged), 0) as totalFilesChanged"),this.knex.raw("COALESCE(SUM(insertions), 0) as totalInsertions"),this.knex.raw("COALESCE(SUM(deletions), 0) as totalDeletions"),this.knex.raw("COALESCE(SUM(CASE WHEN linesChanged <= 500 THEN testLinesChanged ELSE 0 END), 0) as totalTestLinesChanged"),this.knex.raw("COALESCE(SUM(testFilesChanged), 0) as totalTestFilesChanged"),this.knex.raw("COALESCE(SUM(testInsertions), 0) as totalTestInsertions"),this.knex.raw("COALESCE(SUM(testDeletions), 0) as totalTestDeletions"),this.knex.raw("COALESCE(SUM(cacheReadTokens), 0) as totalCacheReadTokens"),this.knex.raw("COALESCE(SUM(cacheWriteTokens), 0) as totalCacheWriteTokens")).whereBetween("startedAt",[e,t]);r&&""!==r.trim()&&(o=o.where("workspaceName",r));const n=await o.first(),s=n.totalLinesChanged-n.totalTestLinesChanged,i=n.totalFilesChanged-n.totalTestFilesChanged,a=n.totalLinesChanged>0?n.totalCost/n.totalLinesChanged:0,c=this.configService.getNumericProperty(l.ConfigPropNames.VALUE_PER_LINE)||2.4,d=n.totalLinesChanged*c,u=n.totalRequests>0?d/n.totalRequests:0,p=n.totalInputTokens+n.totalCacheReadTokens>0?100*n.totalCacheReadTokens/(n.totalInputTokens+n.totalCacheReadTokens):0;return{totalRequests:n.totalRequests,totalProcessingMillis:n.totalProcessingMillis,avgProcessingMillis:n.avgProcessingMillis,totalInputTokens:n.totalInputTokens,totalOutputTokens:n.totalOutputTokens,totalTokens:n.totalTokens,totalCost:n.totalCost,avgCostPerRequest:n.avgCostPerRequest,avgCostPerLine:a,totalLinesChanged:n.totalLinesChanged,totalFilesChanged:n.totalFilesChanged,totalInsertions:n.totalInsertions,totalDeletions:n.totalDeletions,totalTestLinesChanged:n.totalTestLinesChanged,totalTestFilesChanged:n.totalTestFilesChanged,totalTestInsertions:n.totalTestInsertions,totalTestDeletions:n.totalTestDeletions,totalProductionLinesChanged:s,totalProductionFilesChanged:i,totalValueCreated:d,avgValueCreatedPerRequest:u,avgLinesChangedPerRequest:n.avgLinesChangedPerRequest,totalCacheReadTokens:n.totalCacheReadTokens,totalCacheWriteTokens:n.totalCacheWriteTokens,inputCacheHitPercentage:p}}catch(e){throw a.default.error(`Error getting request totals data: ${e.message}`,e.stack),e}}async getHistoricStats(e,t,r){try{let o=this.knex("requests").select(this.knex.raw("strftime('%Y-%m-%d', datetime(startedAt/1000, 'unixepoch')) as label"),this.knex.raw("COALESCE(SUM(CASE WHEN linesChanged <= 500 THEN linesChanged ELSE 0 END), 0) as linesChanged"),this.knex.raw("COALESCE(SUM(cost), 0) as cost"),this.knex.raw("COUNT(*) as requests"),this.knex.raw("COALESCE(SUM(tookMillis), 0) as processingTime")).whereBetween("startedAt",[e,t]);r&&""!==r.trim()&&(o=o.where("workspaceName",r)),o=o.groupBy("label").orderBy("label","asc"),a.default.debug(`Query: ${o.toString()}`);const n=await o,s=this.configService.getNumericProperty(l.ConfigPropNames.VALUE_PER_LINE)||2.4;return n.map((e=>({label:e.label,linesChanged:e.linesChanged,cost:e.cost,valueCreated:e.linesChanged*s,requests:e.requests,processingTime:e.processingTime})))}catch(e){throw a.default.error(`Error getting historic stats: ${e.message}`,e.stack),e}}};t.ReportingService=d,t.ReportingService=d=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function,c.ConfigService])],d)},9095:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ItemRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t){let r=this.knex("items").select("*");if(t&&(r=r.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:o}=e,n=(t-1)*o;r=r.offset(n).limit(o)}return r}async findById(e){return this.knex("items").where("itemId",e).first()}async findBySessionId(e,t,r){let o=this.knex("items").where("sessionId",e);if(r&&(o=o.orderBy(r.field,r.order.toLowerCase())),t){const{page:e,limit:r}=t,n=(e-1)*r;o=o.offset(n).limit(r)}return o}async create(e){await this.knex("items").insert(e)}async update(e,t){await this.knex("items").where("itemId",e).update(t)}async delete(e){await this.knex("items").where("itemId",e).delete()}async countBySessionId(e){const t=await this.knex("items").where("sessionId",e).count("* as count").first();return t?.count}async getSessionStats(e){const t=await this.knex("items").select("sessionId").sum("inputTokens as inputTokens").sum("cacheWriteTokens as cacheWriteTokens").sum("cacheReadTokens as cacheReadTokens").sum("outputTokens as outputTokens").sum("totalTokens as totalTokens").sum("cost as cost").whereIn("sessionId",e).groupBy("sessionId"),r={};return t.forEach((e=>{r[e.sessionId]={inputTokens:e.inputTokens,cacheWriteTokens:e.cacheWriteTokens,cacheReadTokens:e.cacheReadTokens,outputTokens:e.outputTokens,totalTokens:e.totalTokens,cost:e.cost}})),r}async getRequestStats(e){const t=await this.knex("items").select("requestId").sum("inputTokens as inputTokens").sum("cacheWriteTokens as cacheWriteTokens").sum("cacheReadTokens as cacheReadTokens").sum("outputTokens as outputTokens").sum("totalTokens as totalTokens").sum("cost as cost").whereIn("requestId",e).groupBy("requestId"),r={};return t.forEach((e=>{r[e.requestId]={inputTokens:e.inputTokens,cacheWriteTokens:e.cacheWriteTokens,cacheReadTokens:e.cacheReadTokens,outputTokens:e.outputTokens,totalTokens:e.totalTokens,cost:e.cost}})),r}};t.ItemRepository=a,t.ItemRepository=a=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},4143:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.RequestController=void 0;const i=r(3563),a=r(7373);let c=class{constructor(e){this.sessionService=e}async getRequest(e){return this.sessionService.getRequest(e)}};t.RequestController=c,o([(0,i.Get)(":requestId"),s(0,(0,i.Param)("requestId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getRequest",null),t.RequestController=c=o([(0,i.Controller)("requests"),n("design:paramtypes",[a.SessionService])],c)},5312:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Request=void 0;t.Request=class{constructor(e,t,r,o,n={}){this.responseContent="",this.startedAt=new Date,this.endedAt=new Date,this.tookMillis=0,this.inputTokens=0,this.cacheWriteTokens=0,this.cacheReadTokens=0,this.outputTokens=0,this.totalTokens=0,this.cost=0,this.filesChanged=0,this.insertions=0,this.deletions=0,this.testFilesChanged=0,this.testInsertions=0,this.testDeletions=0,this.linesChanged=0,this.testLinesChanged=0,this.requestId=e,this.sessionId=t,this.workspaceName=r,this.requestContent=o,Object.assign(this,n)}}},811:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.RequestRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t){let r=this.knex("requests").select("*");if(t&&(r=r.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:o}=e,n=(t-1)*o;r=r.offset(n).limit(o)}return r}async findById(e){return this.knex("requests").where("requestId",e).first()}async findBySessionId(e,t,r){let o=this.knex("requests").where("sessionId",e);if(r&&(o=o.orderBy(r.field,r.order.toLowerCase())),t){const{page:e,limit:r}=t,n=(e-1)*r;o=o.offset(n).limit(r)}return o}async create(e){await this.knex("requests").insert(e)}async update(e,t){await this.knex("requests").where("requestId",e).update(t)}async delete(e){await this.knex("requests").where("requestId",e).delete()}async countBySessionId(e){const t=await this.knex("requests").where("sessionId",e).count("* as count").first();return t?.count}async updateRequest(e,t){await this.knex("requests").where("requestId",e).update(t)}async updateGitStats(e,t){await this.knex("requests").where("requestId",e).update(t)}async getSessionGitStats(e){return(await this.knex("requests").select("sessionId").sum("filesChanged as filesChanged").sum("insertions as insertions").sum("deletions as deletions").sum("testFilesChanged as testFilesChanged").sum("testInsertions as testInsertions").sum("testDeletions as testDeletions").sum("linesChanged as linesChanged").sum("testLinesChanged as testLinesChanged").whereIn("sessionId",e).groupBy("sessionId")).reduce(((e,t)=>(e[t.sessionId]={filesChanged:t.filesChanged,insertions:t.insertions,deletions:t.deletions,testFilesChanged:t.testFilesChanged,testInsertions:t.testInsertions,testDeletions:t.testDeletions,linesChanged:t.linesChanged,testLinesChanged:t.testLinesChanged},e)),{})}};t.RequestRepository=a,t.RequestRepository=a=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},5480:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionController=void 0;const i=r(3563),a=r(7373),c=r(573);let l=class{constructor(e){this.sessionService=e}async createSession(e,t,r="",o="se-agent"){return this.sessionService.ensureSession(e,t,r,o)}async getSessions(e=1,t=10,r="createdAt",o="DESC"){return this.sessionService.getSessions(e,t,r,o)}async getSession(e){return this.sessionService.getSession(e)}async deleteSession(e){return this.sessionService.deleteSession(e)}async getItemsForSession(e,t=1,r=100,o="ASC"){const[n,s]=await this.sessionService.getItemsForSession(e,t,r,o);return{items:n,total:s}}streamSessionItems(e){return this.sessionService.streamSessionItems(e)}async abortSession(e){return this.sessionService.abortSession(e)}};t.SessionController=l,o([(0,i.Post)(),s(0,(0,i.Body)("workspaceName")),s(1,(0,i.Body)("sessionId")),s(2,(0,i.Body)("requestContent")),s(3,(0,i.Body)("agent")),n("design:type",Function),n("design:paramtypes",[String,String,String,String]),n("design:returntype",Promise)],l.prototype,"createSession",null),o([(0,i.Get)(),s(0,(0,i.Query)("page")),s(1,(0,i.Query)("limit")),s(2,(0,i.Query)("sortBy")),s(3,(0,i.Query)("sortOrder")),n("design:type",Function),n("design:paramtypes",[Number,Number,String,String]),n("design:returntype",Promise)],l.prototype,"getSessions",null),o([(0,i.Get)(":sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getSession",null),o([(0,i.Delete)(":sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"deleteSession",null),o([(0,i.Get)(":sessionId/items"),s(0,(0,i.Param)("sessionId")),s(1,(0,i.Query)("page")),s(2,(0,i.Query)("limit")),s(3,(0,i.Query)("sortOrder")),n("design:type",Function),n("design:paramtypes",[String,Number,Number,String]),n("design:returntype",Promise)],l.prototype,"getItemsForSession",null),o([(0,i.Sse)(":sessionId/stream"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",c.Observable)],l.prototype,"streamSessionItems",null),o([(0,i.Post)(":sessionId/abort"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"abortSession",null),t.SessionController=l=o([(0,i.Controller)("sessions"),n("design:paramtypes",[a.SessionService])],l)},3880:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionModule=void 0;const n=r(3563),s=r(376),i=r(5480),a=r(4143),c=r(7373),l=r(3936),d=r(9095),u=r(811),p=r(3177);let f=class{};t.SessionModule=f,t.SessionModule=f=o([(0,n.Module)({imports:[s.DataSourceModule,p.MutationsModule],controllers:[i.SessionController,a.RequestController],providers:[c.SessionService,l.SessionRepository,d.ItemRepository,u.RequestRepository],exports:[c.SessionService]})],f)},3936:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t,r){let o=this.knex("sessions").select("*"),n=this.knex("sessions").count("* as count");r&&(o=o.where(r),n=n.where(r)),t&&(o=o.orderBy(t.field,t.order.toLowerCase()));const s=await n.first(),i=s?.count;if(e){const{page:t,limit:r}=e,n=(t-1)*r;o=o.offset(n).limit(r)}return{sessions:await o,total:i}}async findById(e){return this.knex("sessions").where("sessionId",e).first()}async create(e){await this.knex("sessions").insert(e)}async update(e,t){await this.knex("sessions").where("sessionId",e).update(t)}async delete(e){await this.knex("sessions").where("sessionId",e).delete()}async count(e){const t=this.knex("sessions").count("* as count");e&&t.where(e);const r=await t.first();return r?.count}async createItem(e){await this.knex("item").insert(e)}async findItemsBySessionId(e){return this.knex("item").where("sessionId",e).orderBy("createdAt","asc")}async updateItem(e,t){await this.knex("item").where("itemId",e).update(t)}};t.SessionRepository=a,t.SessionRepository=a=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},7373:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionService=void 0;const s=r(3563),i=r(5312),a=r(573),c=r(4434),l=r(3936),d=r(9095),u=r(811),p=r(9055),f=r(9100);let h=class{constructor(e,t,r){this.sessionRepository=e,this.itemRepository=t,this.requestRepository=r,this.eventEmitter=new c.EventEmitter}async getSessions(e=1,t=10,r="createdAt",o="DESC"){const{sessions:n,total:s}=await this.sessionRepository.findAll({page:e,limit:t},{field:r,order:o}),i=n.map((e=>e.sessionId)),a=await this.itemRepository.getSessionStats(i),c=await this.requestRepository.getSessionGitStats(i);return{sessions:n.map((e=>({...e,stats:{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0,...a[e.sessionId]||{}},gitStats:{filesChanged:0,insertions:0,deletions:0,testFilesChanged:0,testInsertions:0,testDeletions:0,...c[e.sessionId]||{}}}))),total:s}}async getSessionStats(e){return{...(await this.itemRepository.getSessionStats([e]))[e]||{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0}}}async getRequestStats(e){return{...(await this.itemRepository.getRequestStats([e]))[e]||{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0}}}async ensureSession(e,t,r,o){const n=await this.sessionRepository.findById(t);if(n){if(n.workspaceName!==e)throw new Error(`Session ${t} exists but belongs to a different workspace`);if("active"===n.status)throw new Error(`Session ${t} is currently active`);return n.requestSnippet||(n.requestSnippet=r.slice(0,250),await this.sessionRepository.update(t,{requestSnippet:n.requestSnippet})),n}const s={sessionId:t,workspaceName:e,status:"inactive",createdAt:new Date,requestSnippet:r.slice(0,250),agent:o};return await this.sessionRepository.create(s),s}async getSession(e){return this.sessionRepository.findById(e)}async deleteSession(e){await this.sessionRepository.delete(e)}async deleteSessionForWorkspace(e,t){await this.sessionRepository.delete(t)}async addItem(e){return"AI"===e.label||"Human"===e.label?p.default.info("Adding item to session: %s with label: %s, content: %s",e.sessionId,e.label,e.content):p.default.debug("Adding item to session %s with label %s, content: %s",e.sessionId,e.label,e.content),await this.itemRepository.create(e),this.eventEmitter.emit("newItem",e),e}async getItemsForSession(e,t=1,r=100,o="ASC"){return[await this.itemRepository.findBySessionId(e,{page:t,limit:r},{field:"createdAt",order:o}),await this.itemRepository.countBySessionId(e)]}streamSessionItems(e){return new a.Observable((t=>{this.getItemsForSession(e).then((([e])=>{e.forEach((e=>{t.next({data:e})}))}));const r=r=>{r.sessionId===e&&t.next({data:r})};return this.eventEmitter.on("newItem",r),()=>{this.eventEmitter.removeListener("newItem",r)}}))}async updateSessionStatus(e,t){await this.sessionRepository.update(e,{status:t})}async abortSession(e){if(!await this.sessionRepository.findById(e))throw new s.NotFoundException(`Session with id ${e} not found`);return await this.updateSessionStatus(e,"aborted"),this.sessionRepository.findById(e)}generateSessionId(){return(0,f.ulid)()}generateItemId(){return(0,f.ulid)()}async addRequest(e){p.default.info("Adding request to session: %s, workspaceName: %s, requestContent: %s",e.sessionId,e.workspaceName,e.requestContent);const t=new i.Request(e.requestId||this.generateRequestId(),e.sessionId,e.workspaceName,e.requestContent,e);return await this.requestRepository.create(t),t}async updateRequest(e,t){return p.default.info("Updating request: %s, updateData: %s",e,JSON.stringify(t)),await this.requestRepository.updateRequest(e,t),this.requestRepository.findById(e)}generateRequestId(){return(0,f.ulid)()}async getRequest(e){return this.requestRepository.findById(e)}async updateGitStats(e,t){p.default.info("Updating git stats for request: %s, gitStats: %s",e,JSON.stringify(t)),await this.requestRepository.updateGitStats(e,t)}};t.SessionService=h,t.SessionService=h=o([(0,s.Injectable)(),n("design:paramtypes",[l.SessionRepository,d.ItemRepository,u.RequestRepository])],h)},4912:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.MavenSourceArtefactScheme=void 0;const n=r(3563),s=r(8547),i=r(8938),a=r(1943),c=r(6928),l=r(857),d=r(4650),u=r(9055);let p=class{getName(){return"maven"}async downloadAndStoreSources(e,t,r){if(u.default.info(`Downloading and storing sources for Maven artifact: ${e}`),!this.isValidGAV(e))throw u.default.warn(`Invalid Maven GAV coordinates: ${e}`),new n.BadRequestException("Invalid Maven GAV coordinates");const o=this.getRepoUrls(r);u.default.info(`Using repository URLs: ${o.join(", ")}`);const i=await this.findSourcesJarUrl(o,e);if(!i)throw u.default.warn(`Sources jar not found for ${e} in any of the provided repositories`),new n.BadRequestException("Sources jar not found in any of the provided repositories");u.default.info(`Found sources jar at: ${i}`);const d=await a.mkdtemp(c.join(l.tmpdir(),"maven-sources-")),p=c.join(d,"sources.jar");try{await this.downloadFile(i,p),u.default.info(`Downloaded sources jar to: ${p}`);const r=e.replace(/:/g,"/"),o=c.join(t,"maven",r);await a.mkdir(o,{recursive:!0}),u.default.info(`Created cache directory: ${o}`),await this.unzipJar(p,o),u.default.info(`Unzipped sources jar to: ${o}`);const n=new s.SourceArtefact({scheme:this.getName(),locator:e,valid:!0,error:null,repo:new URL(i).origin,cacheSrcBaseDir:o});return u.default.info(`Successfully created SourceArtefact for ${e}`),n}finally{await a.rm(d,{recursive:!0,force:!0}),u.default.info(`Cleaned up temporary directory: ${d}`)}}async needsImport(e){if(!e.cacheSrcBaseDir)return!0;try{return 0===(await a.readdir(e.cacheSrcBaseDir)).length}catch(e){return!0}}async readArtefactSourceTree(e){if(!e.cacheSrcBaseDir)throw new Error("Invalid source artefact: missing cache directory");const{generateTree:t}=await Promise.resolve().then((()=>r(6426)));return t(e.cacheSrcBaseDir)}async readArtefactSourceFile(e,t){if(!e.cacheSrcBaseDir)throw new Error("Invalid source artefact: missing cache directory");const r=c.join(e.cacheSrcBaseDir,t);try{return await a.readFile(r,"utf-8")}catch(e){throw new Error(`Failed to read file: ${t}`)}}isValidGAV(e){return/^[^:]+:[^:]+:[^:]+$/.test(e)}getRepoUrls(e){if(e&&e.length>0)return e;const t=process.env.MAVEN_REPO_URLS;return t?t.split(",").map((e=>e.trim())):["https://repo.maven.apache.org/maven2"]}async findSourcesJarUrl(e,t){const[r,o,n]=t.split(":"),s=`${r.replace(/\./g,"/")}/${o}/${n}/${o}-${n}-sources.jar`;for(var a of e){a.endsWith("/")||(a+="/");const e=new URL(s,a).toString();u.default.info(`Checking URL: ${e}`);try{return await i.default.head(e),e}catch(t){u.default.info(`Error checking maven url ${e}: ${t}`)}}return null}async downloadFile(e,t){const r=await i.default.get(e,{responseType:"arraybuffer"});await a.writeFile(t,r.data)}async unzipJar(e,t){new d(e).extractAllTo(t,!0)}};t.MavenSourceArtefactScheme=p,t.MavenSourceArtefactScheme=p=o([(0,n.Injectable)()],p)},4358:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SchemePackageManager=void 0;const s=r(3563),i=r(6928),a=r(857),c=r(1943),l=r(8547);let d=class{constructor(e){this.schemes=new Map(e.map((e=>[e.getName(),e])))}getScheme(e){const t=this.schemes.get(e);if(!t)throw new Error(`Unknown scheme: ${e}`);return t}async downloadAndStoreSources(e,t,r){const o=this.schemes.get(e);if(!o)return new l.SourceArtefact({scheme:e,locator:t,valid:!1,error:`Unknown scheme: ${e}`,repo:"",cacheSrcBaseDir:""});const n=i.join(a.homedir(),".hldk","cached-sources");try{return await o.downloadAndStoreSources(t,n,r)}catch(r){return new l.SourceArtefact({scheme:e,locator:t,valid:!1,error:r instanceof Error?r.message:"Unknown error occurred",repo:"",cacheSrcBaseDir:""})}}async deleteSourceCache(e){if(e)try{await c.rm(e,{recursive:!0,force:!0})}catch(e){console.error(`Error deleting source cache directory: ${e}`)}}async needsImport(e){const t=this.schemes.get(e.scheme);return!t||await t.needsImport(e)}};t.SchemePackageManager=d,t.SchemePackageManager=d=o([(0,s.Injectable)(),n("design:paramtypes",[Array])],d)},4279:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactController=void 0;const i=r(3563),a=r(3153);let c=class{constructor(e){this.sourceArtefactService=e}async importSourceArtefact(e){return this.sourceArtefactService.importSourceArtefact(e.scheme,e.locator,e.repoUrls)}async findById(e){return this.sourceArtefactService.findById(e)}async delete(e){return this.sourceArtefactService.delete(e)}async findBySchemeAndLocator(e,t){return this.sourceArtefactService.findBySchemeAndLocator(e,t)}async query(e,t,r=1,o=10,n="locator",s="ASC"){return this.sourceArtefactService.query(e,t,r,o,n,s)}};t.SourceArtefactController=c,o([(0,i.Post)("import"),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],c.prototype,"importSourceArtefact",null),o([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"findById",null),o([(0,i.Delete)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"delete",null),o([(0,i.Get)("find"),s(0,(0,i.Query)("scheme")),s(1,(0,i.Query)("locator")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"findBySchemeAndLocator",null),o([(0,i.Get)(),s(0,(0,i.Query)("scheme")),s(1,(0,i.Query)("partialLocator")),s(2,(0,i.Query)("page")),s(3,(0,i.Query)("pageSize")),s(4,(0,i.Query)("sortBy")),s(5,(0,i.Query)("sortOrder")),n("design:type",Function),n("design:paramtypes",[String,String,Number,Number,String,String]),n("design:returntype",Promise)],c.prototype,"query",null),t.SourceArtefactController=c=o([(0,i.Controller)("source-artefacts"),n("design:paramtypes",[a.SourceArtefactService])],c)},8547:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefact=void 0;t.SourceArtefact=class{constructor(e){Object.assign(this,e)}}},7852:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactModule=void 0;const n=r(3563),s=r(4279),i=r(3153),a=r(5908),c=r(376),l=r(4358),d=r(4912);let u=class{};t.SourceArtefactModule=u,t.SourceArtefactModule=u=o([(0,n.Module)({imports:[c.DataSourceModule],controllers:[s.SourceArtefactController],providers:[i.SourceArtefactService,a.SourceArtefactRepository,d.MavenSourceArtefactScheme,{provide:l.SchemePackageManager,useFactory:e=>new l.SchemePackageManager([e]),inject:[d.MavenSourceArtefactScheme]}],exports:[i.SourceArtefactService]})],u)},5908:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactRepository=void 0;const i=r(3563),a=(r(1832),r(8547)),c=r(3563),l=r(9100);let d=class{constructor(e){this.knex=e}async create(e){const t=(0,l.ulid)(),r=e.createdAt?e.createdAt:new Date;return await this.knex("source_artefacts").insert({id:t,...e,createdAt:r}),{id:t,...e}}async findById(e){const t=await this.knex("source_artefacts").where("id",e).first();return t?new a.SourceArtefact(t):null}async update(e,t){return await this.knex("source_artefacts").where("id",e).update(t),this.findById(e)}async delete(e){await this.knex("source_artefacts").where("id",e).delete()}async findBySchemeAndLocator(e,t){const r=await this.knex("source_artefacts").where({scheme:e,locator:t}).first();return r?new a.SourceArtefact(r):null}async query(e,t,r=1,o=10,n="locator",s="ASC"){const i=(r-1)*o;let c=this.knex("source_artefacts");e&&(c=c.where("scheme",e)),t&&(c=c.where("locator","like",`%${t}%`));const[l,d]=await Promise.all([c.clone().orderBy(n,s).limit(o).offset(i),c.clone().count("* as count").first()]);return{items:l.map((e=>new a.SourceArtefact(e))),total:d?.count}}};t.SourceArtefactRepository=d,t.SourceArtefactRepository=d=o([(0,i.Injectable)(),s(0,(0,c.Inject)("KNEX")),n("design:paramtypes",[Function])],d)},3153:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactService=void 0;const s=r(3563),i=r(5908),a=r(8547),c=r(4358);let l=class{constructor(e,t){this.sourceArtefactRepository=e,this.schemePackageManager=t}async importSourceArtefact(e,t,r){if(await this.findBySchemeAndLocator(e,t))throw new s.BadRequestException(`Source artefact with scheme '${e}' and locator '${t}' already exists.`);try{const o=await this.schemePackageManager.downloadAndStoreSources(e,t,r);return this.sourceArtefactRepository.create(o)}catch(r){const o=r instanceof Error?r.message:"Unknown error occurred";return this.sourceArtefactRepository.create(new a.SourceArtefact({scheme:e,locator:t,valid:!1,error:o,repo:"",cacheSrcBaseDir:""}))}}async findById(e){return this.sourceArtefactRepository.findById(e)}async delete(e){const t=await this.sourceArtefactRepository.findById(e);return t&&await this.schemePackageManager.deleteSourceCache(t.cacheSrcBaseDir),this.sourceArtefactRepository.delete(e)}async findBySchemeAndLocator(e,t){return this.sourceArtefactRepository.findBySchemeAndLocator(e,t)}async query(e,t,r=1,o=10,n="locator",s="ASC"){return this.sourceArtefactRepository.query(e,t,r,o,n,s)}async readArtefactSourceTree(e,t,r){const o=await this.ensureSourceArtefact(e,t,r);return this.schemePackageManager.getScheme(e).readArtefactSourceTree(o)}async readArtefactSourceFile(e,t,r,o){const n=await this.ensureSourceArtefact(e,t,o);return this.schemePackageManager.getScheme(e).readArtefactSourceFile(n,r)}async ensureSourceArtefact(e,t,r){let o=await this.findBySchemeAndLocator(e,t);const n=this.schemePackageManager.getScheme(e);return o&&!await n.needsImport(o)||(o=await this.importSourceArtefact(e,t,r)),o}};t.SourceArtefactService=l,t.SourceArtefactService=l=o([(0,s.Injectable)(),n("design:paramtypes",[i.SourceArtefactRepository,c.SchemePackageManager])],l)},6158:function(e,t,r){"use strict";var o,n=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ToolFactoryService=void 0;const i=r(3563),a=r(7602),c=r(8474),l=r(3153),d=r(7373),u=r(3923),p=r(4970),f=r(7465),h=r(7793),m=r(3765),g=r(5515),y=r(5996),w=r(1781),S=r(7600),v=r(2626),_=r(4911),R=r(3716),b=r(2923),A=r(4500),E=r(42),T=r(1514),k=r(9461),O=r(5188),I=r(308),P=r(3239),C=r(6696),x=r(7205),D=r(1909),M=r(4934),N=r(1983);let F=o=class{constructor(e,t,r,n,s,a,c,l){this.mutationsService=e,this.workspaceService=t,this.sourceArtefactService=r,this.sessionService=n,this.summaryCompletion=s,this.datasetRetrievalService=a,this.storedFileService=c,this.formService=l,this.logger=new i.Logger(o.name),this.toolMap={update_file:e=>new u.UpdateFile(e.workspace.repoBaseDir,this.mutationsService,e.sessionId,e.requestId),read_file:e=>new p.ReadFile(e.workspace.repoBaseDir),read_port_from_file:e=>new h.ReadPortFromFile(e.workspace.portFromBaseDir),delete_file:e=>new f.DeleteFile(e.workspace.repoBaseDir),command_line:e=>new m.CommandLine(e.workspace.repoBaseDir,this.summaryCompletion),read_workspace_tree:e=>new g.ReadWorkspaceTree(e.workspace.repoBaseDir),add_workspace:e=>new y.AddWorkspace(this.workspaceService,e.workspace.repoBaseDir),fetch_web_page:()=>new w.FetchWebPage(this.summaryCompletion),read_dependency_source_tree:()=>new S.ReadDependencySourceTree(this.sourceArtefactService),read_dependency_source_file:()=>new v.ReadDependencySourceFile(this.sourceArtefactService),git_commit:e=>new _.GitCommit(e.workspace.repoBaseDir,e.requestId,this.sessionService),git_init:e=>new R.GitInit(e.workspace.repoBaseDir),current_timestamp:()=>new b.CurrentTimestamp,dataset_retrieval:()=>new A.DatasetRetrieval(this.datasetRetrievalService),docx_to_html:()=>new E.DocxToHtml(this.storedFileService),create_form:e=>new T.CreateForm(this.formService,e.sessionId),list_files:e=>new k.ListFiles(e.workspace.repoBaseDir),grep:e=>new O.Grep(e.workspace.repoBaseDir),find_files:e=>new I.FindFiles(e.workspace.repoBaseDir),computer:()=>{switch(process.platform){case"linux":return new M.ComputerToolLinux;case"darwin":return new N.ComputerToolMac;case"win32":throw new Error("ComputerTool is not supported on Windows yet.");default:throw new Error(`Unsupported platform: ${process.platform}`)}}}}toSnakeCase(e){return e.split(/(?=[A-Z])/).join("_").toLowerCase()}toCamelCase(e){return e.replace(/_([a-z])/g,(e=>e[1].toUpperCase()))}registerTool(e,t){const r=this.toSnakeCase(e);this.toolMap[r]=t,this.logger.log(`Registered new tool: ${r}`)}createTools(e,t){return e.map((e=>{const r=this.toSnakeCase(e),o=this.toolMap[r];if(!o)throw new Error(`Unknown tool: ${e}`);return o(t)}))}createTool(e,t){const r=this.toSnakeCase(e),o=this.toolMap[r];if(!o)throw new Error(`Unknown tool: ${e}`);return o(t)}allTools(e){return Object.values(this.toolMap).map((t=>t(e)))}};t.ToolFactoryService=F,t.ToolFactoryService=F=o=n([(0,i.Injectable)(),s("design:paramtypes",[a.MutationsService,c.WorkspaceService,l.SourceArtefactService,d.SessionService,P.SummaryCompletion,C.DatasetRetrievalService,x.StoredFileService,D.FormService])],F)},361:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ToolsModule=void 0;const n=r(3563),s=r(6158),i=r(3177),a=r(5873),c=r(3880),l=r(7852),d=r(9161),u=r(6552),p=r(8624),f=r(1680),h=r(4240);let m=class{};t.ToolsModule=m,t.ToolsModule=m=o([(0,n.Module)({imports:[i.MutationsModule,a.WorkspaceModule,c.SessionModule,l.SourceArtefactModule,d.ChatCompletionModule,u.DatasetModule,p.StoredFileModule,f.DocstoreModule,h.FormModule],providers:[s.ToolFactoryService],exports:[s.ToolFactoryService]})],m)},2397:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceController=void 0;const i=r(3563),a=r(8474);let c=class{constructor(e){this.workspaceService=e}async unlock(e){return this.workspaceService.unlockByName(e)}async findAll(e){const t="true"===e;return this.workspaceService.findAll(t)}async findOne(e){return this.workspaceService.findOne(e)}async create(e){return this.workspaceService.createWorkspace(e)}async update(e,t){return this.workspaceService.updateWorkspace(e,t)}async remove(e){return this.workspaceService.removeWorkspace(e)}};t.WorkspaceController=c,o([(0,i.Post)(":name/unlock"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"unlock",null),o([(0,i.Get)(),s(0,(0,i.Query)("isTemp")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"findAll",null),o([(0,i.Get)(":name"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"findOne",null),o([(0,i.Post)(),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],c.prototype,"create",null),o([(0,i.Patch)(":name"),s(0,(0,i.Param)("name")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],c.prototype,"update",null),o([(0,i.Delete)(":name"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"remove",null),t.WorkspaceController=c=o([(0,i.Controller)("workspace"),n("design:paramtypes",[a.WorkspaceService])],c)},5873:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceModule=void 0;const n=r(3563),s=r(2397),i=r(8474),a=r(4717),c=r(376);let l=class{};t.WorkspaceModule=l,t.WorkspaceModule=l=o([(0,n.Module)({imports:[c.DataSourceModule],controllers:[s.WorkspaceController],providers:[i.WorkspaceService,a.WorkspaceRepository],exports:[i.WorkspaceService,a.WorkspaceRepository]})],l)},4717:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceRepository=void 0;const i=r(3563);r(1832);let a=class{constructor(e){this.knex=e}async findAll(e){let t=this.knex("workspaces").select("*");return void 0!==e&&(t=t.where("isTemp",e)),t}async findByName(e){return this.knex("workspaces").where("name",e).first()}async create(e){const t={...e};e.portFromBaseDir||delete t.portFromBaseDir,await this.knex("workspaces").insert(e)}async update(e,t){await this.knex("workspaces").where("name",e).update(t)}async delete(e){await this.knex("workspaces").where("name",e).delete()}async updateLastAccessedAt(e){await this.knex("workspaces").where("name",e).update("lastAccessedAt",this.knex.fn.now())}async findUnlockedTempWorkspaceByRemoteUrl(e){return this.knex("workspaces").where({remoteRepoUrl:e,isTemp:!0,isLocked:!1}).orderBy("lastAccessedAt","desc").first()}};t.WorkspaceRepository=a,t.WorkspaceRepository=a=o([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},8474:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceService=void 0;const s=r(3563),i=r(4717),a=r(9896),c=r(6928),l=r(9055),d=r(3807),u=r(2434);let p=class{constructor(e){this.workspaceRepository=e}async lockSessionWorkspace(e){const t=`session/${e}`;if(await this.workspaceRepository.findByName(t))return this.lockByName(t);const r=process.env.TEMP_WORKSPACE_ROOT_DIR||"~/.hldk/temp-workspaces/",o=c.join(r,"session",e);a.mkdirSync(o,{recursive:!0});const n=await this.createWorkspace({name:t,repoBaseDir:o,isTemp:!0});return this.lockByName(n.name)}async lockTempWorkspace(e){const t=await this.workspaceRepository.findUnlockedTempWorkspaceByRemoteUrl(e);if(t)return this.lockByName(t.name);const r=this.generateWorkspaceName(e),o=this.createWorkspaceDirectory(r);await this.cloneRepository(e,o);const n=await this.createWorkspace({name:r,repoBaseDir:o,isTemp:!0});return this.lockByName(n.name)}generateWorkspaceName(e){return`${c.basename(e,".git")}-${Math.random().toString(36).substring(2,7)}`}createWorkspaceDirectory(e){const t=process.env.TEMP_WORKSPACE_ROOT_DIR||c.join(process.env.HOME||"","/.hldk/temp-workspaces/"),r=c.join(t,e);return a.mkdirSync(r,{recursive:!0}),r}async cloneRepository(e,t){const r=(0,d.default)();await r.clone(e,t)}async updateWorkspace(e,t){const r=await this.workspaceRepository.findByName(e);if(!r)throw new s.NotFoundException(`Workspace with name ${e} not found`);return r.buildOrTestCommand=t.buildOrTestCommand,r.portFromBaseDir=t.portFromBaseDir,await this.workspaceRepository.update(e,{buildOrTestCommand:t.buildOrTestCommand,portFromBaseDir:t.portFromBaseDir}),l.default.info(`Workspace updated successfully: ${JSON.stringify(r)}`),r}async lockByName(e){const t=await this.workspaceRepository.findByName(e);if(!t)throw new s.NotFoundException(`Workspace with name ${e} not found`);if(t.isLocked)throw new s.BadRequestException(`Workspace with name ${e} is already locked`);return t.isLocked=!0,t.lastAccessedAt=new Date,await this.workspaceRepository.update(e,{isLocked:!0,lastAccessedAt:t.lastAccessedAt}),l.default.info(`Workspace locked successfully: ${JSON.stringify(t)}`),t}async unlockByName(e){const t=await this.workspaceRepository.findByName(e);if(!t)throw new s.NotFoundException(`Workspace with name ${e} not found`);return t.isLocked=!1,await this.workspaceRepository.update(e,{isLocked:!1}),l.default.info(`Workspace unlocked successfully: ${JSON.stringify(t)}`),t}async createWorkspace(e){l.default.info(`Importing workspace with request: ${JSON.stringify(e)}`);let t=e.name;t||(t=c.basename(e.repoBaseDir));if(await this.workspaceRepository.findByName(t))throw new s.BadRequestException("A workspace with the same name already exists");if(!a.existsSync(e.repoBaseDir)||!a.statSync(e.repoBaseDir).isDirectory())throw new s.BadRequestException("The specified repository directory does not exist or is not a directory");let r=await this.isValidGitRepo(e.repoBaseDir);if(l.default.info(`isGitRepo: ${r}`),!r&&e.ensureGitRepo){const t=(0,d.default)(e.repoBaseDir);await t.init(),r=!0,l.default.info(`Initialized new Git repository in ${e.repoBaseDir}`)}if(r){if(u.GitUtils.ensureGitignoreExists(e.repoBaseDir)){const t=(0,d.default)(e.repoBaseDir);await t.add(".gitignore"),await t.commit("Added default .gitignore file"),l.default.info("Added default .gitignore file")}}const o={name:t,repoBaseDir:e.repoBaseDir,status:"Created",remoteRepoUrl:"",buildOrTestCommand:null,isGitRepo:r,isLocked:!1,isTemp:e.isTemp??!1,lastAccessedAt:new Date,portFromBaseDir:e.portFromBaseDir};if(r)try{o.remoteRepoUrl=await this.getRemoteRepoUrl(e.repoBaseDir);(0,d.default)(e.repoBaseDir);await this.hasCommits(e.repoBaseDir)&&await this.getCurrentBranch(e.repoBaseDir)}catch(e){console.error("Error getting Git information:",e),o.status="Error: Unable to get Git information"}return await this.workspaceRepository.create(o),l.default.info(`Workspace created successfully: ${JSON.stringify(o)}`),o}async findAll(e){return this.workspaceRepository.findAll(e)}async findOne(e){return this.workspaceRepository.findByName(e)}async updateLastAccessedAt(e){await this.workspaceRepository.updateLastAccessedAt(e)}async removeWorkspace(e){if(!await this.workspaceRepository.findByName(e))throw new s.NotFoundException(`Workspace with name ${e} not found`);await this.workspaceRepository.delete(e),l.default.info(`Workspace removed successfully: ${e}`)}async getRemoteRepoUrl(e){const t=(0,d.default)(e),r=(await t.getRemotes(!0)).find((e=>"origin"===e.name));return r?r.refs.fetch:""}async getCurrentBranch(e){return(0,d.default)(e).revparse(["--abbrev-ref","HEAD"])}async isValidGitRepo(e){try{const t=(0,d.default)(e);return await t.revparse(["--is-inside-work-tree"]),!0}catch(e){return!1}}async hasCommits(e){try{const t=(0,d.default)(e);return(await t.log(["--oneline","-1"])).total>0}catch(e){return!1}}};t.WorkspaceService=p,t.WorkspaceService=p=o([(0,s.Injectable)(),n("design:paramtypes",[i.WorkspaceRepository])],p)},5996:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddWorkspace=void 0;const o=r(5534),n=r(1569),s=r(9896),i=r(6928),a=r(5317),c=r(9023),l=r(9055),d=r(1943),u=r(3807),p=(0,c.promisify)(a.exec);class f extends o.Tool{constructor(e,t){super(),this.name="AddWorkspace",this.description="Add a new workspace to the system",this.schema=n.z.object({baseDir:n.z.string().describe("The absolute path to the directory of the workspace (can be a git repo or not)"),name:n.z.string().optional().describe("Optional name of the workspace (no spaces)"),gitRepoUrl:n.z.string().optional().describe("Optional git repository URL to clone into the workspace")}),this.workspaceService=e,this.baseDir=t}async cloneAndCleanGitRepo(e,t){try{l.default.info(`Cloning repository from ${t} to ${e}`),await p(`git clone ${t} ${e} --quiet`),l.default.debug("Repository cloned successfully");const r=i.join(e,".git");s.existsSync(r)&&(l.default.debug(`Removing existing .git directory at ${r}`),await(0,d.rm)(r,{recursive:!0,force:!0}),l.default.debug(".git directory removed successfully")),l.default.info("Initializing new git repository");const o=(0,u.default)(e);await o.init(),l.default.debug("Git repository initialized"),await o.add("."),l.default.debug("Added all files to git"),await o.commit(`initial commit after copying from ${t}`),l.default.info("Created initial commit in new repository")}catch(e){throw l.default.error(`Failed to clone repository: ${e.message}`,e),new Error(`Failed to clone repository: ${e.message}`)}}async _call({baseDir:e,name:t,gitRepoUrl:r}){try{if(l.default.info(`Adding workspace with baseDir: ${e}, name: ${t||"not provided"}, gitRepoUrl: ${r||"not provided"}`),!i.isAbsolute(e))throw l.default.warn(`Base directory is not absolute: ${e}`),new Error(`Base directory must be an absolute path: ${e}`);const o=e;if(l.default.debug(`Full path resolved to: ${o}`),r){l.default.info(`Git repository URL provided, preparing to clone from: ${r}`);const e=i.dirname(o);if(l.default.debug(`Checking parent directory: ${e}`),!s.existsSync(e))throw l.default.error(`Parent directory does not exist: ${e}`),new Error(`Parent directory does not exist: ${e}`);l.default.debug("Parent directory exists, proceeding with clone"),await this.cloneAndCleanGitRepo(o,r)}else{if(l.default.info("No git repository URL provided, checking if directory exists"),!s.existsSync(o))throw l.default.error(`Base directory does not exist: ${o}`),new Error(`Base directory does not exist: ${o}`);l.default.debug("Directory exists, proceeding with workspace creation")}const n=t||i.basename(o);l.default.info(`Creating workspace in database with name: ${n}`),await this.workspaceService.createWorkspace({name:n,repoBaseDir:o,ensureGitRepo:!0}),l.default.debug("Workspace created in database successfully");const a=`Workspace '${n}' added successfully at ${o}${r?" (cloned from git)":""}`;return l.default.info(a),a}catch(e){return l.default.error(`Error adding workspace: ${e.message}`,e),`Error adding workspace: ${e.message}`}}}t.AddWorkspace=f},3765:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommandLine=void 0;const o=r(5534),n=r(1569),s=r(5317),i=r(9023),a=r(9055),c=r(6928),l=r(1162),d=(0,i.promisify)(s.exec);class u extends o.Tool{constructor(e,t){super(),this.name="command_line",this.description="Execute a command line instruction in the workspace directory or a subdirectory",this.schema=n.z.object({command:n.z.string().describe("The command to execute"),subDir:n.z.string().optional().describe("Optional subdirectory relative to the workspace root to execute the command in")}),this.privateRequired=!1,this.summaryPrompt="\n  You are a helpful assistant that summarises text. Your job is present the minumum useful information in the shortest way possible.\n  Summarise the following text pulling out just the interesting things. For example:\n  \n  a) If it looks like test output:\n     - If all tests passed, just say that and mention how many tests passed if possible.\n     - IF THERE ARE ANY FAILURES THEN YOU MUST ALL INFORMATION ABOUT ALL OF THE ERRORS INCLUDING ALL OF THE STACK TRACES OR ERROR INFORMATION AND INCLUDE ALL FILES/LINE NUMBERS ETC.\n     - ALSO INCLUDE ALL THE DEBUG/CONSOLE OUTPUT THAT IS RELATED TO THE TESTS THAT FAILED. IT IS BETTER TO INCLUDE TOO MUCH INFORMATION THAN TOO LITTLE.\n\n  b) If it's something else, then just pull out the most important information.",this.workspaceRootDir=e,this.maxOutputChars=parseInt(process.env.MAX_TOOL_OUTPUT_CHARS||"5000",10),this.summaryCompletion=t}setPrivateRequired(e){this.privateRequired=e}async summariseOutput(e,t){const r="Stdout:\n"+e+"\nStderr:\n"+t;if(r.length>this.maxOutputChars){if(this.summaryCompletion){a.default.debug(`Summarising large command output - ${r.length} chars - content:\n ${r}`);const e=await this.summaryCompletion.getSummary(this.summaryPrompt,r,l.ModelCategory.SUMMARISATION,this.privateRequired);return a.default.info(`Summarised large command output - reduced ${r.length} chars to ${e.length}`),e}{const o=this.clipString(e),n=this.clipString(t);return`Summarised large command output - reduced ${r.length} chars to ${o.length+n.length}:\n${o}\n${n}`}}return r}clipString(e){return e.length>this.maxOutputChars?e.slice(-this.maxOutputChars):e}async _call({command:e,subDir:t}){try{const r=t&&"."!==t?c.default.join(this.workspaceRootDir,t):this.workspaceRootDir;a.default.info(`Executing command: ${e} in directory: ${r}`);const{stdout:o,stderr:n}=await d(e,{cwd:r});return`Successfully executed command:\n${e}\nWorking Directory: ${r}\nOutput was:\n${await this.summariseOutput(o,n)}`}catch(t){a.default.warn(`Error executing command: ${e}`,t),a.default.warn(`Error stdout: ${t.stdout}`),a.default.warn(`Error stderr: ${t.stderr}`);const r=t.stdout||"",o=t.stderr||"";return`Error encountered when executing command:\n${e}\nOutput was:\n${await this.summariseOutput(r,o)}\nError was:\n${this.clipString(t.message)}`}}}t.CommandLine=u},1514:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CreateForm=void 0;const o=r(7773);class n extends o.Tool{constructor(e,t){super(),this.formService=e,this.sessionId=t,this.name="create_form",this.description="Creates a new form using the provided JSON data"}async _call(e){try{JSON.parse(e);return"ERROR: Not implemented"}catch(e){throw new Error(`Failed to create form: ${e.message}`)}}}t.CreateForm=n},2923:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentTimestamp=void 0;const o=r(7773);class n extends o.Tool{constructor(){super(...arguments),this.name="current_timestamp",this.description="Returns the current timestamp in epoch milliseconds and ISO format"}async _call(){const e=new Date,t=e.getTime(),r=e.toISOString();return JSON.stringify({epochMillis:t,isoFormat:r})}}t.CurrentTimestamp=n},4500:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetRetrieval=void 0;const o=r(7773),n=r(3563);class s extends o.Tool{constructor(e){super(),this.datasetRetrievalService=e,this.name="dataset_retrieval",this.description="Search a dataset for similar content using vector similarity. Input should be a JSON string with datasetName, searchText, and optional numResults (defaults to 5).",this.logger=new n.Logger(s.name)}async _call(e){try{const t=JSON.parse(e);if(!t.datasetName||!t.searchText)throw new Error("Both datasetName and searchText are required");const r=await this.datasetRetrievalService.searchDataset(t.datasetName,t.searchText,t.numResults);return JSON.stringify(r,null,2)}catch(e){throw this.logger.error(`Error in dataset retrieval tool: ${e.message}`),e}}}t.DatasetRetrieval=s},7465:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteFile=void 0;const o=r(5534),n=r(1569),s=r(9896),i=r(6928),a=r(9055);class c extends o.Tool{constructor(e){super(),this.name="delete_file",this.description="Delete a file from the workspace",this.schema=n.z.object({filePath:n.z.string().describe("The relative path of the file to delete")}),this.workspaceRootDir=e}async _call(e){return this.deleteFile(e.filePath)}deleteFile(e){const t=i.join(this.workspaceRootDir,e);try{return s.existsSync(t)?(a.default.info(`Deleting file: ${e}`),s.unlinkSync(t),`Successfully deleted file: ${e}`):`Error: File not found - ${e}`}catch(e){return`Error deleting file: ${e.message}`}}}t.DeleteFile=c},42:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DocxToHtml=void 0;const i=r(5534),a=r(3563),c=r(7205),l=r(9896),d=r(6928),u=r(857),p=r(9055),f=r(3229);let h=class extends i.Tool{constructor(e){super(),this.storedFileService=e,this.name="docx_to_html",this.description="Converts a DOCX file to HTML. Takes a stored file ID as input and returns the generated HTML content directly."}async _call(e){try{const t=await this.storedFileService.getFile(e);if(!t)throw new Error(`File with ID ${e} not found`);p.default.info("Converting DOCX to HTML");const r=await(0,f.convertDocxToHtml)(t.fileContents,{wrapperElement:"html",removeImages:!0}),o=u.tmpdir(),n=d.join(o,`docx-${Date.now()}.html`);return l.writeFileSync(n,r,"utf8"),p.default.info(`HTML content written to temp file: ${n}`),r}catch(e){throw new Error(`Failed to convert DOCX to HTML: ${e.message}`)}}};t.DocxToHtml=h,t.DocxToHtml=h=o([(0,a.Injectable)(),s(0,(0,a.Inject)(c.StoredFileService)),n("design:paramtypes",[c.StoredFileService])],h)},1781:function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,s=arguments.length,i=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,r,i):n(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FetchWebPage=void 0;const i=r(5534),a=r(1569),c=r(758),l=r(9055),d=r(3563),u=r(3239);let p=class extends i.Tool{constructor(e){super(),this.summaryCompletion=e,this.name="fetch_web_page",this.description="Fetch the body text of a web page using a headless browser. This tool should only be used if the user has specifically asked for a web page by URL.",this.schema=a.z.object({url:a.z.string().url().describe("The URL of the web page to fetch")}),this.warningThreshold=4e3}async _call({url:e}){try{l.default.info(`Fetching web page: ${e}`);const t=await c.default.launch({headless:!0}),r=await t.newPage();await r.goto(e,{waitUntil:"networkidle0"});const o=await r.evaluate((()=>document.body.innerText));if(await t.close(),o.length>this.warningThreshold){l.default.warn(`Large text content detected (${o.length} characters) for URL: ${e}`);const t=`Please summarise the contents of the web url: ${e} so that we get all the useful information from the page`;return`Fetched and summarized text from URL: ${e}\nSummary:\n${await this.summaryCompletion.getSummary(t,o)}`}return`Fetched text from URL: ${e}\nContent:\n${o}`}catch(t){l.default.error(`Error fetching web page: ${e}`,t);return`Error fetching web page: ${e}\nError:\n${t.message||"Unknown error occurred"}`}}};t.FetchWebPage=p,t.FetchWebPage=p=o([s(0,(0,d.Inject)(u.SummaryCompletion)),n("design:paramtypes",[u.SummaryCompletion])],p)},308:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FindFiles=void 0;const o=r(5534),n=r(1569),s=r(6928),i=r(9896),a=r(9055);class c extends o.Tool{static async main(e,t,r,o,n){a.default.info(`Starting find files search in workspace: ${e}`),a.default.info(`Parameters - startPath: ${t}, searchTerm: ${r}, fileExtensions: ${o}, max: ${n}`);const s=new c(e),i=await s._call({startPath:t,searchTerm:r,fileExtensions:o,max:n});return a.default.info("Find files search completed"),i}constructor(e){super(),this.name="find_files",this.description="Find all file paths in the repository that contain a given search term (case insensitive) in their names",this.schema=n.z.object({startPath:n.z.string().describe("The relative path under repo root to start search from (use '.' for entire repo)"),searchTerm:n.z.string().describe("Search term (case insensitive) or regex to match in the file names"),fileExtensions:n.z.string().optional().describe("Optional regex for file extensions to limit search to (e.g. '\\.(ts|js|java)$')"),max:n.z.number().optional().describe("Maximum number of files to return (optional, defaults to 50)")}),this.MAX_RESULTS=50,this.workspaceRootDir=e}async _call(e){try{const{startPath:t,searchTerm:r,fileExtensions:o,max:n}=e,c=s.resolve(this.workspaceRootDir,t),l=n||this.MAX_RESULTS,d=new RegExp(r,"i"),u=o?new RegExp(o):null,p=[];let f=!1;const h=e=>{if(p.length>=l)return void(f=!0);const t=i.readdirSync(e,{withFileTypes:!0});for(const r of t){if(p.length>=l){f=!0;break}const t=s.join(e,r.name);r.isDirectory()?h(t):r.isFile()&&d.test(r.name)&&(u&&!u.test(r.name)||p.push(s.relative(this.workspaceRootDir,t)))}};h(c);const m={matchingFiles:p};if(f){const e=`Stopped searching after finding ${l} files. There may be more matching files.`;a.default.info(e),m.warning=e}return a.default.info(`Found ${p.length} matching files`),JSON.stringify(m,null,2)}catch(e){throw a.default.error(`Error in find files search: ${e.message}`),new Error(`Error performing find files search: ${e.message}`)}}}t.FindFiles=c},4911:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitCommit=void 0;const o=r(7773),n=r(9896),s=r(6928),i=r(9055),a=r(3807),c=r(2434);class l extends o.Tool{async ensureGitignoreExists(){return c.GitUtils.ensureGitignoreExists(this.repoBaseDir)}constructor(e,t,r){super(),this.repoBaseDir=e,this.requestId=t,this.sessionService=r,this.name="git_commit",this.description="Commits changes to the git repository",this.MAX_DIFF_SIZE=5e4,this.git=(0,a.default)(this.repoBaseDir)}async parseGitDiffOutput(e){const t=e.match(/(\d+) files? changed(?:, (\d+) insertions?\(\+\))?(?:, (\d+) deletions?\(-\))?/),r=t&&t[2]?parseInt(t[2]):0,o=t&&t[3]?parseInt(t[3]):0;return{filesChanged:t?parseInt(t[1]):0,insertions:r,deletions:o,linesChanged:Math.max(r,o)}}async getGitStats(){await this.git.add("-A");const e=await this.git.diff(["--cached","--shortstat"]),t=(await this.git.diff(["--cached","--name-only"])).split("\n").filter((e=>e.includes("test")));let r="";return t.length>0&&(r=await this.git.diff(["--cached","--shortstat",...t])),{allFiles:await this.parseGitDiffOutput(e),testFiles:await this.parseGitDiffOutput(r)}}async storeRequestSpecJsonFile(e){const t=await this.sessionService.getRequest(this.requestId);if(!t||!t.requestContent)return void i.default.warn(`Unable to store request content for requestId: ${this.requestId}`);if(!await this.sessionService.getSession(t.sessionId))return void i.default.warn(`Session not found for requestId: ${this.requestId}`);if("false"===process.env.STORE_SPECS_IN_WORKSPACE)return;const r=new Date,o=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}`,a=s.join(this.repoBaseDir,".hldk","specs",o);n.mkdirSync(a,{recursive:!0});const c=await this.sessionService.getRequestStats(this.requestId),l=c.cost,d=await this.getGitStats(),u=Date.now()-new Date(t.startedAt).getTime(),p={spec:t.requestContent,commitMessage:e,stats:{...c,cost:l,currency:"gbp",processingMillis:u,git:{...d.allFiles,testFilesChanged:d.testFiles.filesChanged,testInsertions:d.testFiles.insertions,testDeletions:d.testFiles.deletions,linesChanged:d.allFiles.linesChanged,testLinesChanged:d.testFiles.linesChanged}}},f=s.join(a,`${this.requestId}.json`);n.writeFileSync(f,JSON.stringify(p,null,2)),await this.sessionService.updateGitStats(this.requestId,{...d.allFiles,testFilesChanged:d.testFiles.filesChanged,testInsertions:d.testFiles.insertions,testDeletions:d.testFiles.deletions,linesChanged:d.allFiles.linesChanged,testLinesChanged:d.testFiles.linesChanged})}async _call(e){try{const t=await this.ensureGitignoreExists();await this.storeRequestSpecJsonFile(e),i.default.info(`Committing changes to git with message: ${e}`),await this.git.add("-A"),t&&(await this.git.add(".gitignore"),e=`${e}\n\nAutomatically added .gitignore file with default patterns`),await this.git.commit(e);const r=`Successfully committed changes with message: ${e}`;return t?`${r}\nNote: Created a new .gitignore file with default patterns`:r}catch(e){return i.default.error("Error in GitCommit tool:",e),`Failed to commit changes: ${e.message}`}}async hasUncommittedUpdates(){try{await this.ensureGitignoreExists();const e=await this.git.status();return i.default.info("Git status: %s",JSON.stringify(e)),e.files.length>0}catch(e){throw i.default.error("Error checking for uncommitted updates:",e),new Error(`Failed to check for uncommitted updates: ${e.message}`)}}async getUncommittedChanges(){try{await this.ensureGitignoreExists();const e=await this.git.status();let t="";const r=await this.git.raw(["rev-parse","--verify","HEAD"]).catch((()=>!1));if(r){const e=await this.git.diff(["HEAD"]);e&&(t+=e)}if(e.not_added.length>0)for(const r of e.not_added)if(n.existsSync(s.join(this.repoBaseDir,r))){const e=n.readFileSync(s.join(this.repoBaseDir,r),"utf8");t+=`\n\nNew file: ${r}\n`,t+=`+++ ${r}\n`,t+=e.split("\n").map((e=>`+ ${e}`)).join("\n")}if(t.length>this.MAX_DIFF_SIZE){i.default.warn("Git diff is too large to summarise - returning just the filenames");let t="";return r&&(t=await this.git.diff(["HEAD","--name-only"])),e.not_added.length>0&&(t+=(t?"\n":"")+"Untracked files:\n"+e.not_added.join("\n")),t}return i.default.debug(`Git diff: ${t}`),t||"No changes detected"}catch(e){throw i.default.error("Error getting uncommitted changes:",e),new Error(`Failed to get uncommitted changes: ${e.message}`)}}}t.GitCommit=l},3716:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitInit=void 0;const o=r(5534),n=r(1569),s=r(9055),i=r(6928),a=r(9896),c=r(3807);class l extends o.Tool{constructor(e){super(),this.name="git_init",this.description="Initialize a git repository in the specified directory if it's not already a git repository",this.schema=n.z.object({folder:n.z.string().describe("The folder relative to the workspace root to initialize as a git repository")}),this.workspaceRootDir=e,this.maxOutputChars=parseInt(process.env.MAX_TOOL_OUTPUT_CHARS||"2000",10)}clipOutput(e){return e.length>this.maxOutputChars?`Large output detected so clipped to last ${this.maxOutputChars} chars...\n${e.slice(-this.maxOutputChars)}`:e}async _call({folder:e}){try{s.default.info(`Initializing git repository in ${e} under workspace ${this.workspaceRootDir}`);const t=i.join(this.workspaceRootDir,e);if(!a.existsSync(t))return`Error: The directory ${t} does not exist.`;const r=i.join(t,".git");if(a.existsSync(r))return`The directory ${t} is already a git repository.`;const o=(0,c.default)(t);return await o.init(),`Successfully initialized git repository in ${t}`}catch(e){s.default.warn(`Error initializing git repository: ${e.message}`,e);return`Error initializing git repository:\nError:\n${this.clipOutput(e.message)}`}}}t.GitInit=l},5188:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Grep=void 0;const o=r(5534),n=r(1569),s=r(8489),i=r(6928),a=r(9896),c=r(9055);class l extends o.Tool{static async main(e,t,r,o,n){c.default.info(`Starting grep search in workspace: ${e}`),c.default.info(`Parameters - startPath: ${t}, searchTerm: ${r}, filePattern: ${o}, max: ${n}`);const s=new l(e),i=await s._call({startPath:t,searchTerm:r,filePattern:o,max:n});return c.default.info("Grep search completed"),i}constructor(e){super(),this.name="grep",this.description="Use this grep tool to search for specific terms throughout the codebase when needed. Try to constrain the search to a specific files or a particular part of the codebase if possible.",this.schema=n.z.object({startPath:n.z.string().describe("The relative path to start the search from (use '.' for entire workspace)"),searchTerm:n.z.string().describe("The search term or regex pattern to look for"),filePattern:n.z.string().describe("Regex pattern to filter file names (required)"),max:n.z.number().optional().describe("Maximum number of files to return (optional, defaults to 20)")}),this.MAX_RESULTS=20,this.workspaceRootDir=e,s.config.silent=!0,s.config.fatal=!0}async _call(e){try{const{startPath:t,searchTerm:r,filePattern:o,max:n}=e,s=i.resolve(this.workspaceRootDir,t),l=n||this.MAX_RESULTS,d=5,u=new RegExp(o),p=this.getAllFiles(s,u),f=[];let h=!1;for(const e of p){if(f.length>=l){h=!0;break}try{const t=a.readFileSync(e,"utf-8").split("\n"),o=[];for(let e=0;e<t.length&&o.length<d;e++){const n=t[e];let s=!1;try{s=new RegExp(r).test(n)}catch(e){s=n.includes(r)}s&&o.push({lineNum:e+1,line:n.trim()})}o.length>0&&f.push({filePath:i.relative(this.workspaceRootDir,e),matches:o})}catch(t){c.default.info(`Skipping unreadable file ${e}: ${t.message}`);continue}}const m={matchingFiles:f};if(h){const e=`Stopped searching after finding matches in ${l} files. There may be more matching files.`;c.default.info(e),m.warning=e}return c.default.info(`Found matches in ${f.length} files`),JSON.stringify(m,null,2)}catch(e){throw c.default.info(`Error in grep search: ${e.message}`),new Error(`Error performing grep search: ${e.message}`)}}getAllFiles(e,t,r=[]){const o=a.readdirSync(e,{withFileTypes:!0});for(const n of o){const o=i.join(e,n.name);n.isDirectory()?this.getAllFiles(o,t,r):n.isFile()&&t.test(n.name)&&r.push(o)}return r}}t.Grep=l},9461:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ListFiles=void 0;const o=r(5534),n=r(1569),s=r(9896),i=r(6928),a=r(9055);class c extends o.Tool{constructor(e){super(),this.name="list_files",this.description="List files and directories, showing size, timestamps, and for directories also showing total size and latest update time",this.schema=n.z.object({dirPath:n.z.string().describe("The relative path of the directory to list")}),this.workspaceRootDir=e}async _call(e){const t=this.listFiles(e.dirPath);return"Directory listing for "+e.dirPath+":\n"+JSON.stringify(t,null,2)}getFilePermissions(e){const t=["---","--x","-w-","-wx","r--","r-x","rw-","rwx"];return`${t[e>>6&7]}${t[e>>3&7]}${t[7&e]}`}getDirStats(e){let t=0,r=new Date(0);try{return s.readdirSync(e).forEach((o=>{const n=i.join(e,o),a=s.statSync(n);t+=a.size,a.mtime>r&&(r=a.mtime)})),{totalSize:t,latestUpdate:r.toISOString()}}catch(e){return a.default.error(`Error getting directory stats: ${e.message}`),{totalSize:0,latestUpdate:new Date(0).toISOString()}}}listFiles(e){a.default.info(`ListFiles.listFiles called with: ${e}`);const t=i.join(this.workspaceRootDir,e);try{return s.readdirSync(t).map((e=>{const r=i.join(t,e),o=s.statSync(r),n={name:e,size:o.size,modifiedTime:o.mtime.toISOString(),isDirectory:o.isDirectory(),permissions:this.getFilePermissions(o.mode)};if(o.isDirectory()){const e=this.getDirStats(r);n.totalSize=e.totalSize,n.latestUpdate=e.latestUpdate}return n}))}catch(t){if(a.default.error(`Error listing directory: ${t.message}`),"ENOENT"===t.code)throw new Error(`Directory not found - ${e}`);throw new Error(`Error listing directory: ${t.message}`)}}}t.ListFiles=c},2626:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadDependencySourceFile=void 0;const o=r(5534),n=r(1569);class s extends o.Tool{constructor(e){super(),this.name="read_dependency_source_file",this.description='Read the content of a specific source file from a dependency, using the package manager scheme (e.g. "maven"), locator (e.g. "com.example:example:1.0.0"), and file path.\n  Currently only maven is supported so the scheme is always "maven" and the locator is always a Maven GAV tuple (group:artifact:version).\n  If no repository URLs are provided then the default Maven central repository will be used.\n  The file path should be relative to the root of the source directory, e.g., "com/foo/Bar.java".\n  If the file is not found, it will check for alternative extensions (e.g., .kt for Kotlin).\n  ',this.schema=n.z.object({input:n.z.string().describe("A JSON string containing packageManagerScheme, locator, filePath, and optional repositoryUrls")}),this.sourceArtefactService=e}async _call(e){const{packageManagerScheme:t,locator:r,filePath:o,repositoryUrls:n}=JSON.parse(e.input);if(!t||!r||!o)return"Error: Missing required parameters. Please provide packageManagerScheme, locator, and filePath.";try{return await this.sourceArtefactService.readArtefactSourceFile(t,r,o,n)}catch(e){return`Error: Unable to read dependency source file. ${e instanceof Error?e.message:"Unknown error occurred"}`}}}t.ReadDependencySourceFile=s},7600:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadDependencySourceTree=void 0;const o=r(5534),n=r(1569);class s extends o.Tool{constructor(e){super(),this.name="read_dependency_source_tree",this.description='Read the source tree hierarchy (directories and file names only) of a dependency, using the package manager scheme (e.g. "maven") and locator (e.g. "com.example:example:1.0.0"). \n  Use this tool if you need to know more about how to use a specific dependency.\n  Look in the build file (e.g. pom.xml or build.gradle) or package metadata (e.g. package.json) and then use that to build the correct scheme and locator.\n  Currently only maven is supported so the scheme is always "maven" and the locator is always a Maven GAV tuple (group:artifact:version).\n  If no repository URLs are provided then the default Maven central repository will be used.\n  ',this.schema=n.z.object({input:n.z.string().describe("A JSON string containing packageManagerScheme, locator, and optional repositoryUrls")}),this.sourceArtefactService=e}async _call(e){const{packageManagerScheme:t,locator:r,repositoryUrls:o}=JSON.parse(e.input);try{return await this.sourceArtefactService.readArtefactSourceTree(t,r,o)}catch(e){return`Error: Unable to read dependency source tree. ${e instanceof Error?e.message:"Unknown error occurred"}`}}}t.ReadDependencySourceTree=s},4970:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadFile=void 0;const o=r(5534),n=r(1569),s=r(9896),i=r(6928),a=r(9055);class c extends o.Tool{constructor(e){super(),this.name="read_file",this.description="Read the content of a file in the workspace. Should only be used for reading files that are expected to be text based. Do not use this tool for binary files.",this.schema=n.z.object({filePath:n.z.string().describe("The relative path of the file to read")}),this.workspaceRootDir=e}async _call(e){return`The content of the file at path: ${e.filePath} is as follows:\n${this.readFile(e.filePath)}`}readFile(e){a.default.info(`ReadFile.readFile called with: ${e}`);const t=i.join(this.workspaceRootDir,e);try{return s.readFileSync(t,"utf-8")}catch(t){return"ENOENT"===t.code?`Error: File not found - ${e}`:`Error reading file: ${t.message}`}}}t.ReadFile=c},7793:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadPortFromFile=void 0;const o=r(5534),n=r(1569),s=r(9896),i=r(6928),a=r(9055);class c extends o.Tool{constructor(e){super(),this.name="read_port_from_file",this.description="Read the content of a file from the portFromBaseDir in the workspace. Should only be used for reading files that are expected to be text based. Do not use this tool for binary files.",this.schema=n.z.object({filePath:n.z.string().describe("The relative path of the file to read")}),this.portFromBaseDir=e}async _call(e){return this.readFile(e.filePath)}readFile(e){a.default.info(`ReadPortFromFile.readFile called with: ${e}`);const t=i.join(this.portFromBaseDir,e);try{return s.readFileSync(t,"utf-8")}catch(t){return"ENOENT"===t.code?`Error: File not found - ${e}`:`Error reading file: ${t.message}`}}}t.ReadPortFromFile=c},5515:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadWorkspaceTree=void 0;const o=r(5534),n=r(1569),s=r(6426);class i extends o.Tool{constructor(e){super(),this.name="read_workspace_tree",this.description="Read the workspace file tree, respecting .gitignore and .aiderignore files",this.schema=n.z.object({}),this.workspaceRootDir=e}async _call(){return(0,s.generateTree)(this.workspaceRootDir)}}t.ReadWorkspaceTree=i},3923:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFile=void 0;const o=r(5534),n=r(1569),s=r(9896),i=r(6928),a=r(9055),c=r(2303);class l extends o.Tool{constructor(e,t,r,o){super(),this.name="update_file",this.description="Update the content of a file in the workspace by providing the path of the file to update, the text block to search for in the file content, and the text block to replace the search block with. All 3 arguments are required: filePath, search (use a blank/empty string when creating new files), and replace.",this.schema=n.z.object({filePath:n.z.string().describe("The relative path of the file to update"),search:n.z.string().describe("The unique text block to search for in the file content. For new files, use a blank/empty string. For existing files, make sure to include a big enough search block to ensure you're only updating the intended text."),replace:n.z.string().describe("The text block to replace the search block with - DO NOT FORGET TO INCLUDE THIS!!!")}),this.workspaceRootDir=e,this.mutationsService=t,this.sessionId=r,this.requestId=o}async _call(e){return this.updateFile(e.filePath,e.search,e.replace)}ensureDirectoryExists(e){try{return s.existsSync(e)||(a.default.info(`Creating directory: ${e}`),s.mkdirSync(e,{recursive:!0})),!0}catch(t){return a.default.error(`Failed to create directory ${e}:`,t),!1}}async updateFile(e,t,r){a.default.info("UpdateFile.updateFile called with: %s\n>>>>> SEARCH\n%s\n-------\n%s<<<<< REPLACE\n",e,t,r);const o=i.join(this.workspaceRootDir,e);try{let n,l,d=!1;if(s.existsSync(o)||t&&""!==t)if(n=s.readFileSync(o,"utf-8"),""!==n.trim()||t&&""!==t.trim()){const i=n.includes("\r\n")?"\r\n":"\n",c=t.replace(/\r\n|\n/g,i),d=r.replace(/\r\n|\n/g,i);if(n.split(c).length-1>1)return a.default.warn("Multiple exact matches found for search block: --\x3e%s<-- and file content was:\n--\x3e%s<--",t,n),`ERROR: the search block was found multiple times in the file. Please expand the search block to make it unique and construct the corresponding replace block and try again.\nFile path was: ${e}\nSearch block was:\n${t}\n`;let u=n.indexOf(c),p=c.length,f=c;if(-1===u){a.default.info("Exact match not found, attempting indentation-agnostic search.");const r=c.split(i).map((e=>e.trim())).filter((e=>e.length>0)).map((e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"))).join("\\s*"),o=new RegExp(r.replace(/\s+/g,"\\s+"),"g"),s=n.match(o);if(s&&s.length>1)return a.default.warn("Multiple indentation-agnostic matches found for search block"),a.default.warn("Search block was:\n%s",t),a.default.warn("Full file content was:\n%s",n),`ERROR: the search block was found multiple times in the file. \nPlease expand the search block to make it unique and construct the corresponding replace block and try again.\nFile path was: ${e}\nSearch block was:\n${t}\n`;o.lastIndex=0;const h=o.exec(n);if(!h)return a.default.warn("UpdateFile.updateFile failed to find the search block in the file content."),a.default.warn("Search block was:\n%s",t),a.default.warn("Full file content was:\n%s",n),`ERROR: failed to find search block in file content.\nPlease try again with a different search block.\nFile path was: ${e}\nSearch block was:\n${t}\n`;u=h.index,p=h[0].length,f=h[0];const m=f.split(i),g=m[0].match(/^\s*/)[0],y=m.filter((e=>e.trim().length>0)).map((e=>e.match(/^\s*/)[0].length-g.length)),w=d.split(i),S=w.map(((e,t)=>{if(!e.trim())return"";const r=y[Math.min(t,y.length-1)]||0;return g+" ".repeat(Math.max(0,r))+e.trim()})).join(i);l=n.slice(0,u)+S+n.slice(u+p)}else l=n.slice(0,u)+d+n.slice(u+p);a.default.info(`Updating file: ${e}`),a.default.debug("Updated file - Content after:\n%s",l),s.writeFileSync(o,l,"utf-8")}else{const e=r.replace(/\r\n/g,"\n");s.writeFileSync(o,e,"utf-8"),l=e}else{const e=i.dirname(o);if(!this.ensureDirectoryExists(e))return`ERROR: Failed to create directory: ${e}`;const t=r.replace(/\r\n/g,"\n");s.writeFileSync(o,t,"utf-8"),n="",l=t,d=!0}const u=d?`Successfully created new file: ${e}`:`Successfully updated file: ${e}`;try{await this.mutationsService.createMutation({type:d?c.MutationType.CREATE:c.MutationType.UPDATE,filePath:e,description:u,fileContentsBefore:n,fileContentsAfter:l,updatedAt:new Date,sessionId:this.sessionId,requestId:this.requestId})}catch(t){throw a.default.error("UpdateFile.updateFile encountered an error while recording the mutation:",{error:t.message,stack:t.stack,context:{filePath:e,isNewFile:d,sessionId:this.sessionId,requestId:this.requestId}}),new Error(`Failed to record file mutation: ${t.message}`)}return a.default.info("UpdateFile.updateFile completed successfully"),`Successfully updated file: ${e} with search block:\n${t}\n`}catch(e){return a.default.error("UpdateFile.updateFile encountered an error:",e),`Error: ${e.message}`}}}t.UpdateFile=l},7751:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComputerToolBase=void 0;const o=r(5534),n=r(1569);class s extends o.Tool{constructor(){super(),this.name="computer",this.description='Interact with the screen, keyboard, and mouse of the current computer. Available actions:\n    - key: Send keyboard key events (requires text parameter with key sequence)\n    - type: Type text directly (requires text parameter with content to type)\n    - mouse_move: Move mouse cursor to coordinates (requires coordinate parameter [x, y])\n    - left_click: Perform a left mouse click at current position\n    - left_click_drag: Click and drag from current position to coordinates (requires coordinate parameter [x, y])\n    - right_click: Perform a right mouse click at current position\n    - middle_click: Perform a middle mouse click at current position\n    - double_click: Perform a double click at current position\n    - screenshot: Take a screenshot of the current screen\n    - cursor_position: Get the current cursor position\n    \n    Example: {"action": "type", "text": "Hello World"} or {"action": "mouse_move", "coordinate": [100, 200]}',this.schema=n.z.object({input:n.z.string().optional()}).transform((e=>{try{return JSON.parse(e.input||"{}")}catch(e){return{}}})),this.scale=parseFloat(process.env.SCALE||"0.5"),(isNaN(this.scale)||this.scale<=0||this.scale>1)&&(console.warn(`Invalid SCALE value ${process.env.SCALE}, defaulting to 0.5`),this.scale=.5),this.width=process.env.WIDTH?parseInt(process.env.WIDTH,10):null,this.height=process.env.HEIGHT?parseInt(process.env.HEIGHT,10):null,this.maxOutputChars=2e3}clipString(e){return e.length>this.maxOutputChars?e.slice(-this.maxOutputChars):e}async _call(e){return this.execute(e)}}t.ComputerToolBase=s},4934:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComputerToolLinux=void 0;const o=r(1569),n=r(5317),s=r(9023),i=r(3903),a=r(943),c=r(3864),l=r(9896),d=r(6928),u=r(7751),p=r(7650),f=(0,s.promisify)(n.exec);class h extends u.ComputerToolBase{validateParams(e){return o.z.object({action:o.z.enum(["key","type","mouse_move","left_click","left_click_drag","right_click","middle_click","double_click","screenshot","cursor_position"]),text:o.z.string().optional(),coordinate:o.z.array(o.z.number()).length(2).optional()}).parse(e)}constructor(){if(super(),this.screenshotDelay=2,this.scalingEnabled=!0,this.outputDir="/tmp/outputs",!c.default.sync("xdotool"))throw new Error("xdotool is not installed. Please install it via your package manager.");if(!c.default.sync("gnome-screenshot")&&!c.default.sync("scrot"))throw new Error("Neither gnome-screenshot nor scrot is installed. Please install one of them.");if(!c.default.sync("convert"))throw new Error("ImageMagick is not installed. Please install it via your package manager.");const e=process.env.DISPLAY_NUM;this.displayPrefix=void 0!==e?`DISPLAY=:${e} `:"",this.xdotool=`${this.displayPrefix}xdotool`}async execute(e){const t=this.validateParams(e),{action:r,text:o,coordinate:n}=t;try{let e;switch(r){case"mouse_move":case"left_click_drag":if(!n)throw new p.ToolError(`coordinate is required for ${r}`);const[t,s]=n;e="mouse_move"===r?await this.shell(`${this.xdotool} mousemove --sync ${t} ${s}`):await this.shell(`${this.xdotool} mousedown 1 mousemove --sync ${t} ${s} mouseup 1`);break;case"key":if(!o)throw new p.ToolError(`text is required for ${r}`);e=await this.shell(`${this.xdotool} key -- ${o}`);break;case"type":if(!o)throw new p.ToolError(`text is required for ${r}`);e=await this.typeText(o);break;case"left_click":case"right_click":case"middle_click":case"double_click":e=await this.clickAction(r);break;case"screenshot":return e=await this.screenshot(),[{type:"image_url",image_url:{url:`data:image/png;base64,${e.base64_image}`}}];case"cursor_position":e=await this.getCursorPosition();break;default:throw new p.ToolError(`Invalid action: ${r}`)}return e.output}catch(e){return e instanceof p.ToolError?`Error: ${e.message}`:`Unexpected error: ${e}`}}async typeText(e){const t=this.chunkText(e,50);let r="";for(const e of t){const t=`${this.xdotool} type --delay 12 -- ${a.default.quote([e])}`;r+=(await this.shell(t,!1)).output}const o=await this.screenshot();return new p.ToolResult(r,"",o.base64_image)}async clickAction(e){const t={left_click:"1",right_click:"3",middle_click:"2",double_click:"--repeat 2 --delay 500 1"}[e];return await this.shell(`${this.xdotool} click ${t}`)}async getCursorPosition(){const e=(await this.shell(`${this.xdotool} getmouselocation --shell`,!1)).output||"",t=e.match(/X=(\d+)/),r=e.match(/Y=(\d+)/);if(!t||!r)throw new p.ToolError(`Failed to parse cursor position: ${e}`);const o=parseInt(t[1],10),n=parseInt(r[1],10);return new p.ToolResult(`X=${o},Y=${n}`,"")}async screenshot(){l.default.mkdirSync(this.outputDir,{recursive:!0});const e=d.default.join(this.outputDir,`screenshot_${(0,i.v4)().replace(/-/g,"")}.png`);let t="";if(c.default.sync("gnome-screenshot"))t=`${this.displayPrefix}gnome-screenshot -f ${e} -p`;else{if(!c.default.sync("scrot"))throw new p.ToolError("Neither gnome-screenshot nor scrot is available.");t=`${this.displayPrefix}scrot -p ${e}`}const r=await this.shell(t,!1);if(await this.shell(`convert ${e} -resize ${this.width}x${this.height}! ${e}`,!1),l.default.existsSync(e)){const t=l.default.readFileSync(e).toString("base64");return new p.ToolResult("","",t)}throw new p.ToolError(`Failed to take screenshot: ${r.error}`)}async shell(e,t=!0){const{stdout:r,stderr:o}=await f(e,{shell:"/bin/bash"});let n=null;return t&&(await new Promise((e=>setTimeout(e,1e3*this.screenshotDelay))),n=(await this.screenshot()).base64_image),new p.ToolResult(r,o,n)}chunkText(e,t){const r=[];for(let o=0;o<e.length;o+=t)r.push(e.slice(o,o+t));return r}}t.ComputerToolLinux=h},1983:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComputerToolMac=void 0;const o=r(1569),n=r(5317),s=r(9023),i=r(3903),a=r(943),c=r(3864),l=r(9896),d=r(6928),u=r(7751),p=r(7650),f=r(9055),h=(0,s.promisify)(n.exec);class m extends u.ComputerToolBase{validateParams(e){return o.z.object({action:o.z.enum(["key","type","mouse_move","left_click","left_click_drag","right_click","middle_click","double_click","screenshot","cursor_position"]),text:o.z.string().optional(),coordinate:o.z.array(o.z.number()).length(2).optional()}).parse(e)}constructor(){super(),this.screenshotDelay=2,this.scalingEnabled=!0,this.outputDir="/tmp/outputs",this.kpKeys=new Set(["arrow-down","arrow-left","arrow-right","arrow-up","brightness-down","brightness-up","delete","end","enter","esc","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","f13","f14","f15","f16","fwd-delete","home","keys-light-down","keys-light-toggle","keys-light-up","mute","num-0","num-1","num-2","num-3","num-4","num-5","num-6","num-7","num-8","num-9","num-clear","num-divide","num-enter","num-equals","num-minus","num-multiply","num-plus","page-down","page-up","play-next","play-pause","play-previous","return","space","tab","volume-down","volume-up"]),f.default.info("Initializing ComputerToolMac"),c("cliclick").then((function(e){f.default.info("cliclick command found")})).catch((function(){const e="cliclick is not installed. Please install it via Homebrew: brew install cliclick";throw f.default.error(e),new Error(e)})),c("convert").then((function(e){f.default.info("ImageMagick convert command found")})).catch((function(){const e="ImageMagick is not installed. Please install it via Homebrew: brew install imagemagick";throw f.default.error(e),new Error(e)}))}async execute(e){f.default.info(`Executing ComputerToolMac command: ${JSON.stringify(e)}`);try{const t=this.validateParams(e);f.default.info(`Parameters validated successfully: ${JSON.stringify(t)}`);const{action:r,text:o,coordinate:n}=t;let s;switch(r){case"mouse_move":case"left_click_drag":if(!n)throw new p.ToolError(`coordinate is required for ${r}`);const[e,t]=n,i=Math.round(e/this.scale),a=Math.round(t/this.scale);if(f.default.info(`Adjusted coordinates for scale factor (${this.scale}): (${i}, ${a})`),"mouse_move"===r)s=await this.executeCommands([`m:${i},${a}`]);else{const e=[`dd:${i},${a}`,`du:${i},${a}`];s=await this.executeCommands(e)}break;case"key":if(!o)throw new p.ToolError(`text is required for ${r}`);s=await this.pressKey(o);break;case"type":if(!o)throw new p.ToolError(`text is required for ${r}`);s=await this.typeText(o);break;case"left_click":case"right_click":case"middle_click":case"double_click":s=await this.clickAction(r);break;case"screenshot":return s=await this.screenshot(),[{type:"image_url",image_url:{url:`data:image/png;base64,${s.base64_image}`}}];case"cursor_position":s=await this.getCursorPosition();break;default:throw new p.ToolError(`Invalid action: ${r}`)}return s.output}catch(e){return e instanceof p.ToolError?(f.default.error("Tool error in ComputerToolMac",{error:e.message,stack:e.stack}),`Error: ${e.message}`):(f.default.error("Unexpected error in ComputerToolMac",{error:e instanceof Error?e.stack:String(e)}),`Unexpected error: ${e}`)}}async typeText(e){f.default.info(`Typing text: ${e}`);const t=["-w 200"];t.push(`t:${a.quote([e])}`),f.default.info(`Built commands for typing text: ${t.join(" ")}`);return await this.executeCommands(t)}async pressKey(e){f.default.info(`Pressing key: ${e}`);const{modifiers:t,key:r}=this.parseKeyCommand(e),o=["-w 200"];for(const e of t)f.default.info(`Key down modifier: ${e}`),o.push(`kd:${e}`);if(this.kpKeys.has(r))f.default.info(`Pressing special key with kp: ${r}`),o.push(`kp:${r}`);else{if(1!==r.length)throw new p.ToolError(`Invalid key: ${r}`);f.default.info(`Typing key with t: ${r}`),o.push(`t:${a.quote([r])}`)}for(const e of t.reverse())f.default.info(`Key up modifier: ${e}`),o.push(`ku:${e}`);f.default.info(`Built commands for key press: ${o.join(" ")}`);return await this.executeCommands(o)}async clickAction(e){const t={left_click:"c:.",right_click:"rc:.",middle_click:"mc:.",double_click:"dc:."}[e];if(!t)throw new p.ToolError(`Invalid click action: ${e}`);const r=["-w 200",t];return await this.executeCommands(r)}async getCursorPosition(){const e=await this.executeCommands(["p:."],!1),t=e.output?.trim()||"",r=t.match(/(\d+),(\d+)/);if(!r)throw new p.ToolError(`Failed to parse cursor position: ${t}`);const o=parseInt(r[1],10),n=parseInt(r[2],10);return new p.ToolResult(`X=${o},Y=${n}`,"")}async screenshot(){f.default.info("Taking screenshot"),f.default.info(`Ensuring output directory exists: ${this.outputDir}`),l.mkdirSync(this.outputDir,{recursive:!0});const e=d.join(this.outputDir,`screenshot_${(0,i.v4)().replace(/-/g,"")}.png`);f.default.info(`Screenshot will be saved to: ${e}`);const t=`screencapture -x ${e}`;f.default.info("Executing screenshot command",{cmd:t});const r=await h(t,{shell:"/bin/bash"});let o=this.width,n=this.height;if(null==o||null==n){const t=`magick identify -format "%w %h" ${e}`;f.default.info(`Executing identify command to get image dimensions: ${t}`);const r=await h(t,{shell:"/bin/bash"}),[s,i]=r.stdout.trim().split(" ");o=parseInt(s,10),n=parseInt(i,10),this.width=o,this.height=n}const s=`magick ${e} -resize ${Math.floor(o*this.scale)}x${Math.floor(n*this.scale)}! ${e}`;if(f.default.info(`Executing resize command: ${s}`),await h(s,{shell:"/bin/bash"}),l.existsSync(e)){const t=l.readFileSync(e).toString("base64");return new p.ToolResult("","",t)}throw new p.ToolError(`Failed to take screenshot: ${r.stderr}`)}async executeCommands(e,t=!0){f.default.info(`Executing commands: ${e.join(" ")}`);const r=`cliclick ${e.join(" ")}`;f.default.info(`Final cliclick command: ${r}`);try{const{stdout:e,stderr:o}=await h(r,{shell:"/bin/bash"});e&&f.default.info(`Command produced stdout output: ${e}`),o&&f.default.warn(`Command produced stderr output: ${o}`);let n=null;return t&&(f.default.info(`Waiting ${this.screenshotDelay} seconds before taking screenshot`),await new Promise((e=>setTimeout(e,1e3*this.screenshotDelay))),n=(await this.screenshot()).base64_image),f.default.info("Commands executed successfully",{hasOutput:!!e,hasScreenshot:!!n}),new p.ToolResult(e,o,n)}catch(e){throw f.default.error(`Command execution failed: ${e instanceof Error?e.stack:String(e)}`),e}}parseKeyCommand(e){const t=e.toLowerCase().split("+"),r=t.pop(),o={cmd:"cmd",command:"cmd",ctrl:"ctrl",control:"ctrl",alt:"alt",option:"alt",fn:"fn",shift:"shift"},n=t.map((e=>{const t=o[e];if(!t)throw new p.ToolError(`Invalid modifier key: ${e}`);return t}));if(this.kpKeys.has(r))return{modifiers:n,key:r};if(1===r.length&&/^[a-z0-9]$/.test(r))return{modifiers:n,key:r};throw new p.ToolError(`Invalid key: ${r}`)}}t.ComputerToolMac=m},7650:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToolResult=t.ToolError=void 0;class r extends Error{constructor(e){super(e),this.name="ToolError"}}t.ToolError=r;class o{constructor(e="",t="",r=null){this.output=e,this.error=t,this.base64_image=r}replace({output:e=null,error:t=null,base64_image:r=null}){return new o(null!==e?e:this.output,null!==t?t:this.error,null!==r?r:this.base64_image)}}t.ToolResult=o},8884:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEnv=function(e,t){let r;"undefined"!=typeof process&&process.env?r=process.env[e]:"undefined"!=typeof globalThis&&"Deno"in globalThis?r=globalThis.Deno.env.get(e):console.warn(`Unable to access environment variables. Key: ${e}`);return void 0!==r?r:t}},2434:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitUtils=void 0;const o=r(9896),n=r(6928),s=r(9055);class i{static ensureGitignoreExists(e){const t=n.join(e,".gitignore");return!o.existsSync(t)&&(s.default.info("No .gitignore file found, creating one with default patterns"),o.writeFileSync(t,this.DEFAULT_GITIGNORE),!0)}}t.GitUtils=i,i.DEFAULT_GITIGNORE="# Dependencies\nnode_modules/\n.pnpm-store/\npackage-lock.json\nyarn.lock\n\n# Build outputs\ndist/\nbuild/\ntarget/\n*.class\n*.jar\n*.war\n\n# IDEs and editors\n.idea/\n.vscode/\n*.swp\n*.swo\n.project\n.classpath\n.settings/\n\n# Logs and databases\n*.log\nlogs/\n*.sqlite\n*.db\n\n# Environment variables\n.env\n.env.*\n!.env.example\n\n# Testing\ncoverage/\n.nyc_output/\n\n# Temporary files\ntmp/\ntemp/\n.DS_Store\nThumbs.db\n\n# Compiled output\n*.pyc\n__pycache__/\n*.o\n*.so\n\n# Package files\n*.tgz\n*.zip\n*.tar.gz\n\n# Secrets\n*.pem\n*.key\n*.cert\n*.p12\n\n# Project specific\n.turbo/\n.cache/\n"},3229:(e,t,r)=>{"use strict";e=r.nmd(e),Object.defineProperty(t,"__esModule",{value:!0}),t.convertDocxToHtml=async function(e,t={}){await y(e,t);return document.documentElement.outerHTML},t.convertDocxToHtmlDom=y,t.extractRawText=async function(e){m.default.debug("Extracting raw text from DOCX buffer");try{m.default.debug("Starting mammoth raw text extraction");const t=await s.extractRawText({buffer:e});return t.messages&&t.messages.length>0&&m.default.warn("Extraction warnings:",t.messages),t.value}catch(e){throw new Error(`Failed to extract raw text from DOCX: ${e.message}`)}},t.extractDocxXmlFromBytes=async function(e){return m.default.debug("Extracting XML from DOCX buffer"),new Promise(((t,r)=>{try{m.default.debug("Opening DOCX buffer for XML extraction"),u.fromBuffer(e,{lazyEntries:!0},((e,o)=>{if(m.default.debug("DOCX buffer opened"),e)return void r(new Error(`Failed to open DOCX buffer: ${e.message}`));let n="";o.on("entry",(e=>{m.default.debug("Found entry: %s",e.fileName),"word/document.xml"===e.fileName?o.openReadStream(e,((e,o)=>{if(e)return void r(new Error(`Failed to read document.xml: ${e.message}`));const s=[];o.on("data",(e=>s.push(e))),o.on("end",(async()=>{n=Buffer.concat(s).toString("utf8");try{const e=new c.Parser,r=await e.parseStringPromise(n),o=new c.Builder({renderOpts:{pretty:!0}}).buildObject(r);t(o)}catch(e){r(new Error(`Failed to parse XML: ${e.message}`))}}))})):(m.default.debug("Skipping entry: %s",e.fileName),o.readEntry())})),o.on("end",(()=>{m.default.debug("DOCX buffer ended"),n||r(new Error("Invalid .docx file: document.xml not found"))})),m.default.debug("Reading DOCX buffer entry"),o.readEntry()}))}catch(e){r(new Error(`Error processing DOCX buffer: ${e.message}`))}}))},t.extractDocxXml=w,t.editDocxFile=async function(e,t,r,n,s){if(m.default.info("Editing DOCX file: %s",e),m.default.info("Output path: %s",n),!t)throw new Error("Search text cannot be empty");const c=s||await o.promises.mkdtemp(a.join(i.tmpdir(),"docx-edit-"));try{const s=e=>new Promise(((t,r)=>{u.open(e,{lazyEntries:!0},((e,o)=>{e?r(e):t(o)}))})),i=await s(e),l=[];let d="";await new Promise(((e,t)=>{i.on("entry",(e=>{const r=a.join(c,e.fileName);o.mkdirSync(a.dirname(r),{recursive:!0}),i.openReadStream(e,((n,s)=>{if(n)t(n);else{if("word/document.xml"===e.fileName){const e=[];s.on("data",(t=>e.push(t))),s.on("end",(()=>{d=Buffer.concat(e).toString("utf8"),o.writeFileSync(r,d)}))}else{const e=o.createWriteStream(r);s.pipe(e)}l.push(new Promise((e=>{s.on("end",e)})))}})),i.readEntry()})),i.on("end",(()=>e())),i.on("error",t),i.readEntry()})),await Promise.all(l);const f=d.indexOf(t);if(-1===f)throw new Error("Search text not found in document");const h=d.slice(0,f)+r+d.slice(f+t.length);await o.promises.writeFile(a.join(c,"word/document.xml"),h);const m=new p.ZipFile,g=async(e,t="")=>{const r=await o.promises.readdir(e,{withFileTypes:!0});for(const o of r){const r=a.join(e,o.name),n=a.join(t,o.name);o.isDirectory()?await g(r,n):m.addFile(r,n)}};await g(c);const y=o.createWriteStream(n);m.outputStream.pipe(y),await new Promise(((e,t)=>{y.on("close",e),y.on("error",t),m.end()}))}finally{s||await o.promises.rm(c,{recursive:!0,force:!0})}},t.extractSectionsFromDocxBuffer=b,t.extractDocxXmlPartsFromBytes=A,t.extractSectionsFromXmlContent=E,t.extractSections=T;const o=r(9896),n=r(2325),s=r(7393),i=r(857),a=r(6928),c=r(6566),l=r(1879),d=r(9863),u=r(1115),p=r(7020),f=r(6610),h=f.default||f,m=r(9055),g=1;async function y(e,t={}){m.default.debug("Converting DOCX to HTML with options: %j",t);try{m.default.debug("Starting mammoth conversion");const r=await s.convertToHtml({buffer:e});r.messages&&r.messages.length>0&&m.default.warn("Conversion warnings:",r.messages);let o=r.value;t.wrapperElement&&(m.default.debug("Adding wrapper element: %s",t.wrapperElement),o=`<html><head></head><body>${o}</body></html>`);let i=new n.JSDOM(o).window.document;if(t.removeImages){const e=i.getElementsByTagName("img");for(;e.length>0;)e[0].parentNode?.removeChild(e[0])}return i}catch(e){throw new Error(`Failed to convert DOCX to HTML: ${e.message}`)}}async function w(e){return m.default.info("Extracting XML from DOCX file: %s",e),new Promise(((t,r)=>{try{m.default.info("Opening DOCX file for XML extraction"),u.open(e,{lazyEntries:!0},((e,o)=>{if(e)return void r(new Error(`Failed to open DOCX file: ${e.message}`));let n="";o.on("entry",(e=>{"word/document.xml"===e.fileName?o.openReadStream(e,((e,o)=>{if(e)return void r(new Error(`Failed to read document.xml: ${e.message}`));const s=[];o.on("data",(e=>s.push(e))),o.on("end",(async()=>{n=Buffer.concat(s).toString("utf8");try{const e=new c.Parser,r=await e.parseStringPromise(n),o=new c.Builder({renderOpts:{pretty:!0}}).buildObject(r);t(o)}catch(e){r(new Error(`Failed to parse XML: ${e.message}`))}}))})):o.readEntry()})),o.on("end",(()=>{n||r(new Error("Invalid .docx file: document.xml not found"))})),o.readEntry()}))}catch(e){r(new Error(`Error processing DOCX file: ${e.message}`))}}))}function S(e){if(m.default.debug("Getting XPath for node: %s",e.nodeName),e.nodeType!==g)return m.default.debug("Node is not an element node, returning empty path"),"";let t="",r=e;const o=e.ownerDocument.documentElement,n={};for(let e=0;e<o.attributes.length;e++){const t=o.attributes[e];if(t.name.startsWith("xmlns:")){const e=t.name.split(":")[1];n[e]=t.value}else"xmlns"===t.name&&(n.default=t.value)}function s(e){if(!e)return null;for(const t in n)if(n[t]===e)return t;return null}for(;r&&r.nodeType===g&&"document"!==r.localName;){let e=1,o=r.previousSibling;for(;o;)o.nodeType===g&&o.localName===r.localName&&o.namespaceURI===r.namespaceURI&&e++,o=o.previousSibling;const n=s(r.namespaceURI);m.default.info("Node details - localName: %s, namespaceURI: %s, resolved prefix: %s",r.localName,r.namespaceURI,n);t=`/${n?`${n}:${r.localName}`:r.localName}[${e}]`+t,r=r.parentNode}if(r&&r.nodeType===g&&"document"===r.localName){const e=s(r.namespaceURI);t=`/${e?`${e}:${r.localName}`:r.localName}${t}`}return m.default.info("Completed XPath calculation for node: %s, path: %s",e.nodeName,t),t}function v(e,t){let r=t;for(;r;){if(r===e)return!0;r=r.parentNode}return!1}function _(e,t){m.default.debug("Finding label for input node: %s",e.nodeName);let r=e.parentNode;for(;r&&"w:body"!==r.nodeName;){if("w:tr"===r.nodeName){const o=Array.from(r.childNodes).filter((e=>"w:tc"===e.nodeName));m.default.debug("Found %d cells in table row",o.length);for(let n=0;n<o.length;n++){if(v(o[n],e)){m.default.debug("Input node found in cell %d, checking previous cells for label",n);for(let e=n-1;e>=0;e--){const r=t(".//w:t",o[e]).map((e=>e.textContent?.trim())).filter((e=>e)).join(" ");if(r)return m.default.debug("Found label text in same row: %s",r),r}let e=r;for(;e.previousSibling;){const r=e.previousSibling;if("w:tr"===r.nodeName){const e=Array.from(r.childNodes).filter((e=>"w:tc"===e.nodeName));for(const r of e){if(t('.//w:shd[@w:fill="E5E5E5"]',r)[0]){const e=t(".//w:t",r).map((e=>e.textContent?.trim())).filter((e=>e)).join(" ");if(e)return m.default.debug("Found label text in previous row: %s",e),e}}}e=r}}}}r=r.parentNode}return m.default.info("No label found for input node"),null}function R(e,t,r,o){function n(e){const r=t.find((t=>t.xpath===e.xpath));if(r)return r.label!==e.label&&m.default.warn("Found duplicate XPath with different labels. XPath: %s, Existing label: %s, New label: %s",e.xpath,r.label,e.label),void m.default.info("Skipping duplicate input with XPath: %s",e.xpath);t.push(e)}m.default.debug("Processing inputs in section: %s",e.nodeName);const s=r(".//w:sdt",e);m.default.debug("Found %d content controls (sdt nodes)",s.length),s.forEach((e=>{const t=r("./w:sdtPr",e)[0];if(t){let o="text",s="";m.default.debug("Determining input type for sdt node: %s",e.nodeName),m.default.debug("SDT Properties node structure: %j",t.toString());if(r(".//w14:checkbox",t)[0])m.default.debug("Found checkbox node - setting input type to checkbox"),o="checkbox";else{const e=r("./w:richText",t)[0],n=r("./w:text",t)[0];m.default.info("Checking for textarea: richTextNode=%s, textNode=%s",!!e,!!n&&!!r("./w:multiLine",n)[0]),e||n&&r("./w:multiLine",n)[0]?(m.default.debug("Found rich text or multiline text node - setting input type to textarea"),o="textarea"):m.default.debug("No special nodes found - defaulting to text input type")}const i=r("./w:sdtContent",e)[0];if(i){r(".//w:t",i).forEach((e=>{s+=e.textContent||""}))}const a=S(e),c=r("./w:id",t)[0],l=c?c.getAttribute("w:val"):null,d=_(e,r);m.default.info("Processing input node - Type: %s, XPath: %s, ID: %s, Label: %s",o,a,l,d),m.default.info("Original value from XML node: %s",s),n({xpath:a,type:o,id:l,label:d,originalValue:s||null})}}));const i=r(".//w:tc",e);m.default.info("Found %d table cells to process",i.length),i.forEach((e=>{if(r('.//w:tcBorders/w:bottom[@w:val="single"]',e)[0]){const t=r(".//w:t",e).map((e=>e.textContent||"")).join("").trim();if(!o||!t||" "===t){const o=e.parentNode;if(o&&"w:tr"===o.nodeName){const s=Array.from(o.childNodes).filter((e=>"w:tc"===e.nodeName)),i=s.findIndex((t=>t===e));if(i>0){const o=s[i-1],a=r(".//w:t",o).map((e=>e.textContent?.trim())).filter((e=>e)).join(" ");if(a){m.default.info("Found label text from left cell: %s",a);const r=e;m.default.info("Using the cell node itself as the target node");n({xpath:S(r),type:"text",id:null,label:a,originalValue:t||null})}else m.default.info("Left cell exists but has no text, skipping input")}else m.default.info("No cell to the left, skipping input")}else m.default.info("Could not find parent row for cell, skipping input")}}}));const a=r(".//w:t",e);m.default.info("Found %d text nodes to process",a.length),a.forEach((e=>{const t=e.textContent||"",s=t.replace(/[\s\u00A0]/g,"");if(!o||""===s){let o=!0,s=e.parentNode;for(;s;){if("w:tc"===s.nodeName){if(r('.//w:tcBorders/w:bottom[@w:val="single"]',s)[0])break;o=!1;break}s=s.parentNode}if(o){let o=null,s="r",i=e.parentNode;for(;i&&"w:r"!==i.nodeName;)i=i.parentNode;if(i)o=i,m.default.info("Found parent w:r node");else{let t=e.parentNode;for(;t&&"w:p"!==t.nodeName;)t=t.parentNode;t&&(o=t,s="p",m.default.info("No w:r node found, falling back to w:p node"))}if(o){const e=S(o),i=_(o,r);m.default.info("Processing text node - Node type: w:%s, XPath: %s, Label: %s",s,e,i),m.default.info("Original value from XML node: %s",t),n({xpath:e,type:"text",id:null,label:i,originalValue:t||null})}else m.default.warn("No suitable node (w:t or w:r) found for text node. Skipping this text node.")}else m.default.info("Skipping text node in table cell without bottom border")}}))}async function b(e,t=!0){m.default.info("Extracting sections from DOCX buffer");const{documentXml:r,stylesXml:o}=await A(e);return E(r,o,t)}async function A(e){if(m.default.info("Extracting XML parts from DOCX buffer"),!e||0===e.length)throw new Error("Invalid buffer: Buffer is empty");try{if(!h(e))throw new Error("Invalid buffer: Not a valid ZIP archive")}catch(e){throw m.default.error("Error validating ZIP buffer:",e),new Error("Failed to validate DOCX buffer: "+e.message)}return new Promise(((t,r)=>{try{m.default.info("Opening DOCX buffer for XML extraction");let o=setTimeout((()=>{r(new Error("Operation timed out while opening DOCX buffer"))}),5e3);u.fromBuffer(e,{lazyEntries:!0},((e,n)=>{if(clearTimeout(o),e||!n)return void r(new Error(`Failed to open DOCX buffer: ${e?.message}`));m.default.info("DOCX buffer opened successfully");let s=null,i=null;const a=new Set(["word/document.xml","word/styles.xml"]);n.on("entry",(e=>{m.default.info("Found entry: %s",e.fileName),a.has(e.fileName)?n.openReadStream(e,((o,c)=>{if(o||!c)return void r(new Error(`Failed to read ${e.fileName}: ${o?.message}`));const l=[];c.on("data",(e=>l.push(e))),c.on("end",(()=>{const r=Buffer.concat(l).toString("utf8");"word/document.xml"===e.fileName?s=r:"word/styles.xml"===e.fileName&&(i=r),a.delete(e.fileName),0===a.size?(n.close(),t({documentXml:s,stylesXml:i})):n.readEntry()})),c.on("error",(t=>{r(new Error(`Error reading ${e.fileName}: ${t.message}`))}))})):n.readEntry()})),n.on("end",(()=>{m.default.info("Finished reading DOCX entries"),a.size>0&&r(new Error("Invalid .docx file: Missing "+(a.has("word/document.xml")?"document.xml":"styles.xml")))})),n.on("error",(e=>{r(new Error(`Error processing DOCX buffer: ${e.message}`))})),m.default.info("Reading first entry in DOCX buffer"),n.readEntry()}))}catch(e){r(new Error(`Error processing DOCX buffer: ${e.message}`))}}))}async function E(e,t,r=!0){m.default.info("Parsing XML document: start of document: \n%s",e.slice(0,2e3));const o=(new l.DOMParser).parseFromString(e,"application/xml");if(!o||!o.documentElement)throw new Error("Failed to parse XML document");const n=o.documentElement,i={};for(let e=0;e<n.attributes.length;e++){const t=n.attributes[e];if(t.name.startsWith("xmlns:")){i[t.name.split(":")[1]]=t.value}else"xmlns"===t.name&&(i.default=t.value)}i.w||(i.w="http://schemas.openxmlformats.org/wordprocessingml/2006/main");const a=d.useNamespaces(i),c=[];m.default.info("Selecting document body node with namespaces: %j",i);const u=a("//w:body",o);if(!u||0===u.length)throw m.default.error("Could not find document body node. Available nodes: %s",Array.from(o.documentElement.childNodes).filter((e=>1===e.nodeType)).map((e=>e.nodeName)).join(", ")),new Error("Could not find document body node");const f=u[0];if(!f)throw new Error("Document body node is null");const h=Array.from(f.childNodes||[]);m.default.info("Found %d child nodes in document body",h.length);for(let e=0;e<h.length;e++){const o=h[e];if(1===o.nodeType)try{m.default.info("Processing section node: %s",o.nodeName);const e=S(o),i=(new l.XMLSerializer).serializeToString(o),d=[];R(o,d,a,r);const u=Array.from(n.attributes),f=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n  <w:document ${u.filter((e=>e.name.startsWith("xmlns:")||"xmlns"===e.name)).map((e=>`${e.name}="${e.value}"`)).join(" ")}>\n    <w:body>\n      ${i}\n    </w:body>\n  </w:document>`;m.default.info("Converting section to HTML: %s",e);const h=new p.ZipFile;m.default.info("Adding content types to zip");const g='<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml" ContentType="application/xml"/>\n  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>\n  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>\n</Types>';h.addBuffer(Buffer.from(g),"[Content_Types].xml"),m.default.info("Adding relationships to zip");const y='<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>\n</Relationships>';h.addBuffer(Buffer.from(y),"_rels/.rels"),m.default.info("Adding document.xml to zip"),h.addBuffer(Buffer.from(f),"word/document.xml"),m.default.info("Adding styles.xml to zip"),h.addBuffer(Buffer.from(t),"word/styles.xml"),m.default.info("Adding document.xml.rels to zip");const w='<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>\n</Relationships>';h.addBuffer(Buffer.from(w),"word/_rels/document.xml.rels"),m.default.info("Finalizing zip");const v=await new Promise(((e,t)=>{const r=[];h.outputStream.on("data",(e=>r.push(e))),h.outputStream.on("end",(()=>e(Buffer.concat(r)))),h.outputStream.on("error",t),h.end()}));m.default.info("Converting section to HTML");const _=await s.convertToHtml({buffer:v});m.default.info("Mammoth result: %s",_);const b={xpath:e,convertedHtml:_.value,potentialInputs:d};m.default.info("Unescaped RAW XML for the section: %s",i),m.default.info("Resulting section: %s",JSON.stringify(b,null,2)),c.push(b)}catch(t){m.default.error(t),m.default.error("Failed to convert XML to HTML for section with index %s: %s",e,t.message)}}return{sections:c}}async function T(e,t=!1){m.default.info("Extracting sections from DOCX file: %s",e);return b(o.readFileSync(e),t)}if(r.c[r.s]===e){const e=process.argv.slice(2);e.length<1&&(console.error("Usage: node docxExtractor.js <path-to-docx-file> [sections|xml]"),process.exit(1));const t=e[0],r=e[1]||"sections";let o=!0;switch(e.length>1&&"false"===e[1]&&(o=!1),r){case"sections":T(t,o).then((e=>{console.log(JSON.stringify(e,null,2))})).catch((e=>{console.error("Failed to extract DOCX sections:",e),process.exit(1)}));break;case"xml":w(t).then((e=>{console.log(e)})).catch((e=>{console.error("Failed to extract DOCX XML:",e),process.exit(1)}));break;default:console.error('Invalid command. Use "sections" or "xml"'),process.exit(1)}}},9055:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(5124),n=r(9896),s=r(6928),i=r(8884),a=r(9233),c=s.join(process.cwd(),"logs");n.existsSync(c)||n.mkdirSync(c,{recursive:!0});const l=s.join(c,"hldk-server-%DATE%.log"),d=(0,i.getEnv)("LOG_FILE_PATH",l);console.log(`Log file pattern: ${d}`);const u=new a({filename:d,datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"20m",maxFiles:"14d",level:"debug"}),p=o.format.printf((e=>{const{level:t,message:r,timestamp:o}=e,n=new Date(o);return`${`${(n.getMonth()+1).toString().padStart(2,"0")}/${n.getDate().toString().padStart(2,"0")}/${n.getFullYear()}, ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}:${n.getSeconds().toString().padStart(2,"0")} ${n.getHours()>=12?"PM":"AM"}`} - ${t.toUpperCase()}: ${r}`})),f=o.createLogger({level:"debug",format:o.format.combine(o.format.splat(),o.format.timestamp(),p),transports:[new o.transports.Console({level:"info"}),u]});t.default=f},6426:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateSummaryTree=u,t.generateAdaptiveTree=function(e,t=[]){if(!o.existsSync(e)||!o.statSync(e).isDirectory())return`Error: ${e} is not a valid directory.`;const r=n.join(e,".hldkignore");o.existsSync(r)||(!function(e){const t=["# Binary files","*.jpg","*.jpeg","*.png","*.gif","*.ico","*.svg","*.woff","*.woff2","*.ttf","*.eot","*.otf","*.pdf","*.zip","*.tar","*.gz","*.rar","*.7z","*.exe","*.dll","*.so","*.dylib","","# Build and dependency directories","node_modules/","dist/","build/","target/",".next/",".nuxt/",".output/","coverage/",".nyc_output/",".cache/",".parcel-cache/",".yarn/","","# IDE and editor files",".idea/",".vscode/","*.swp","*.swo","*.swn","*.bak","","# Logs and databases","*.log","*.sqlite","*.sqlite3","*.db","logs/","","# Environment and config files",".env",".env.*","!.env.example",".DS_Store","Thumbs.db"].join("\n"),r=n.join(e,".hldkignore");o.writeFileSync(r,t),i.default.info("Created default .hldkignore file with common ignore patterns")}(e),t=[]);const s=h(e,t);if(s.length<=l)return s;i.default.warn("Large file tree (%d chars) detected for workspace dir: %s",s.length,e),i.default.warn("A .hldkignore file has been created/exists in the root of the repository. You can modify it to control which files are included in the tree sent to the agent");let d,p=a;for(;p>=c;){if(d=u(e,t,p),d.length<=l)return i.default.info("Automatically limited file tree to %d items per dir resulting in a tree of %d chars",p,d.length),d;p-=10}return u(e,t,c)},t.generateTree=h,t.generateTreeRecursive=g;const o=r(9896),n=r(6928),s=r(526),i=r(9055),a=50,c=5,l=5e4,d=3;function u(e,t=[],r=c){if(!o.existsSync(e)||!o.statSync(e).isDirectory())return`Error: ${e} is not a valid directory.`;return f(e,m(e,t),e,"",0,r).trimStart()}function p(e,t,r){const s=o.readdirSync(e).sort(),i={totalFiles:0,totalFolders:0,fileTypes:{}};return s.forEach((s=>{const a=n.join(e,s),c=n.relative(r,a);if(t.ignores(c))return;if(o.statSync(a).isDirectory()){i.totalFolders++;const e=p(a,t,r);i.totalFiles+=e.totalFiles,i.totalFolders+=e.totalFolders,Object.entries(e.fileTypes).forEach((([e,t])=>{i.fileTypes[e]=(i.fileTypes[e]||0)+t}))}else{i.totalFiles++;const e=n.extname(s)||"no-extension";i.fileTypes[e]=(i.fileTypes[e]||0)+1}})),i}function f(e,t,r,s="",i=0,a=c){let l=[];const u=o.readdirSync(e).sort();let h=0,m=0;u.forEach((s=>{const i=n.join(e,s),a=n.relative(r,i);t.ignores(a)||(o.statSync(i).isDirectory()?m++:h++)}));if(i>=d&&h+m>=a){const o=p(e,t,r);l.push(`${s}├── Summary: ${o.totalFiles} files, ${o.totalFolders} folders`),Object.entries(o.fileTypes).sort().forEach((([e,t],r,o)=>{const n=r===o.length-1?"└── ":"├── ",i="no-extension"===e?"files with no extension":`${e} files`;l.push(`${s}│   ${n}${t} ${i}`)}))}else{const c={};u.forEach(((d,p)=>{const h=n.join(e,d),m=n.relative(r,h);if(t.ignores(m))return;const g=o.statSync(h),y=p===u.length-1;if(g.isDirectory())l.push(`${s}${y?"└── ":"├── "}${d}`),l.push(f(h,t,r,s+(y?"    ":"│   "),i+1,a));else{const e=n.extname(d)||"no-extension";c[e]=(c[e]||0)+1,l.push(`${s}${y?"└── ":"├── "}${d}`)}}))}return l.join("\n")}function h(e,t=[]){if(!o.existsSync(e)||!o.statSync(e).isDirectory())return`Error: ${e} is not a valid directory.`;return g(e,m(e,t),e).trimStart()}function m(e,t){const r=(0,s.default)();r.add([".git",".hldk",...t]);return[".gitignore",".aiderignore",".hldkignore"].forEach((t=>{const s=n.join(e,t);if(o.existsSync(s)){const e=o.readFileSync(s,"utf-8");r.add(e)}})),r}function g(e,t,r,s="",i=a){let c=[];const l=o.readdirSync(e).sort();if(l.length>i){const o=p(e,t,r);return c.push(`${s}Summary: ${o.totalFiles} files, ${o.totalFolders} folders`),Object.entries(o.fileTypes).sort().forEach((([e,t],r,o)=>{const n=r===o.length-1?"└── ":"├── ",i="no-extension"===e?"files with no extension":`${e} files`;c.push(`${s}${n}${t} ${i}`)})),c.join("\n")}return l.forEach(((a,d)=>{const u=n.join(e,a),p=n.relative(r,u);if(t.ignores(p))return;const f=d===l.length-1;c.push(`${s}${f?"└── ":"├── "}${a}`),o.statSync(u).isDirectory()&&c.push(g(u,t,r,s+(f?"    ":"│   "),i))})),c.join("\n")}},646:e=>{"use strict";e.exports=require("@langchain/anthropic")},779:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/csv")},9179:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/docx")},8565:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/pdf")},4897:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/pptx")},7915:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/unstructured")},7310:e=>{"use strict";e.exports=require("@langchain/community/embeddings/hf_transformers")},5796:e=>{"use strict";e.exports=require("@langchain/community/vectorstores/chroma")},1486:e=>{"use strict";e.exports=require("@langchain/core/messages")},724:e=>{"use strict";e.exports=require("@langchain/core/output_parsers")},5534:e=>{"use strict";e.exports=require("@langchain/core/tools")},1463:e=>{"use strict";e.exports=require("@langchain/groq")},9314:e=>{"use strict";e.exports=require("@langchain/langgraph")},8804:e=>{"use strict";e.exports=require("@langchain/langgraph/prebuilt")},2196:e=>{"use strict";e.exports=require("@langchain/mistralai")},3548:e=>{"use strict";e.exports=require("@langchain/ollama")},6228:e=>{"use strict";e.exports=require("@langchain/openai")},3563:e=>{"use strict";e.exports=require("@nestjs/common")},8781:e=>{"use strict";e.exports=require("@nestjs/core")},9556:e=>{"use strict";e.exports=require("@nestjs/platform-express")},2810:e=>{"use strict";e.exports=require("@nestjs/serve-static")},4650:e=>{"use strict";e.exports=require("adm-zip")},8938:e=>{"use strict";e.exports=require("axios")},3864:e=>{"use strict";e.exports=require("command-exists")},818:e=>{"use strict";e.exports=require("dotenv")},7252:e=>{"use strict";e.exports=require("express")},8817:e=>{"use strict";e.exports=require("file-type")},4652:e=>{"use strict";e.exports=require("fs-extra")},526:e=>{"use strict";e.exports=require("ignore")},6610:e=>{"use strict";e.exports=require("is-zip")},2325:e=>{"use strict";e.exports=require("jsdom")},1832:e=>{"use strict";e.exports=require("knex")},7093:e=>{"use strict";e.exports=require("langchain/text_splitter")},7773:e=>{"use strict";e.exports=require("langchain/tools")},7393:e=>{"use strict";e.exports=require("mammoth")},904:e=>{"use strict";e.exports=require("mime-types")},758:e=>{"use strict";e.exports=require("puppeteer")},1321:e=>{"use strict";e.exports=require("reflect-metadata")},573:e=>{"use strict";e.exports=require("rxjs")},943:e=>{"use strict";e.exports=require("shell-quote")},8489:e=>{"use strict";e.exports=require("shelljs")},3807:e=>{"use strict";e.exports=require("simple-git")},9100:e=>{"use strict";e.exports=require("ulid")},3903:e=>{"use strict";e.exports=require("uuid")},5124:e=>{"use strict";e.exports=require("winston")},9233:e=>{"use strict";e.exports=require("winston-daily-rotate-file")},6566:e=>{"use strict";e.exports=require("xml2js")},1879:e=>{"use strict";e.exports=require("xmldom")},9863:e=>{"use strict";e.exports=require("xpath")},1115:e=>{"use strict";e.exports=require("yauzl")},7020:e=>{"use strict";e.exports=require("yazl")},1569:e=>{"use strict";e.exports=require("zod")},5317:e=>{"use strict";e.exports=require("child_process")},6982:e=>{"use strict";e.exports=require("crypto")},4434:e=>{"use strict";e.exports=require("events")},9896:e=>{"use strict";e.exports=require("fs")},1943:e=>{"use strict";e.exports=require("fs/promises")},857:e=>{"use strict";e.exports=require("os")},6928:e=>{"use strict";e.exports=require("path")},9023:e=>{"use strict";e.exports=require("util")}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={id:e,loaded:!1,exports:{}};return __webpack_modules__[e].call(r.exports,r,r.exports,__webpack_require__),r.loaded=!0,r.exports}__webpack_require__.c=__webpack_module_cache__,__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var __webpack_exports__=__webpack_require__(__webpack_require__.s=7201)})();