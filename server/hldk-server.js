(()=>{var __webpack_modules__={2003:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AgentConfig=void 0;t.AgentConfig=class{constructor(e,t=0,o,r=!0){this.model=e,this.temperature=t,this.recursionLimit=o,this.cachePrompt=r}}},1412:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AgentRequest=void 0;const r=o(2003),n=o(9100);class s{constructor(e,t,o,n=new r.AgentConfig,i){this.sender=e,this.content=t,this.sessionId=o,this.config=n,this.workspaceName=i,this.sessionId=o||s.generateRandomSessionId()}static fromJSON(e){const{sender:t,content:o,sessionId:n,config:i,workspaceName:a,agent:c}=e;if(!o)throw new Error("Missing required field 'content'");const l=i?Object.assign(new r.AgentConfig,i):new r.AgentConfig,d=n||s.generateRandomSessionId();return new s(t,o,d,l,a)}static generateRandomSessionId(){return(0,n.ulid)()}static getFirstTextContent(e){if("string"==typeof e)return e;if(!Array.isArray(e))throw new Error("Invalid content type");{const t=e[0];if("text"===t.type)return t.text||""}}}t.AgentRequest=s},9234:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestContext=void 0;const r=o(6426),n=o(9896),s=o(6928),i=o(9055);class a{constructor(e,t,o){this.workspace=e,this.requestId=t,this.sessionId=o}portFromSourceTree(){if(!this.workspace.portFromBaseDir)return;const e=(0,r.generateTree)(this.workspace.portFromBaseDir);return e.length>a.TREE_SIZE_WARNING_THRESHOLD&&(i.default.warn("WARNING: Large file tree (%d chars) detected for portFromBaseDir: %s",e.length,this.workspace.portFromBaseDir),i.default.warn("Consider adding a .hldkignore file (to the the directory) to prevent some uninteresting files being included in the tree sent to the agent"),i.default.warn('The full file tree is logged to debug level so search for "File tree for" in the /logs/hldk-server-*.log file to see it')),e}repositoryTree(){const e=(0,r.generateTree)(this.workspace.repoBaseDir);return e.length>a.TREE_SIZE_WARNING_THRESHOLD&&(i.default.warn("WARNING: Large file tree (%d chars) detected for workspace: %s",e.length,this.workspace.name),i.default.warn("Consider adding a .hldkignore file (to the root of the repository) to prevent some uninteresting files being included in the tree sent to the agent"),i.default.warn('The full file tree is logged to debug level so search for "File tree for" in the /logs/hldk-server-*.log file to see it')),e}repositoryHints(){const e=s.join(this.workspace.repoBaseDir,"hints.md");if(n.existsSync(e))return n.readFileSync(e,"utf-8")}}t.RequestContext=a,a.TREE_SIZE_WARNING_THRESHOLD=1e5},7249:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StandardAgentStateManager=void 0;const r=o(9314),n=o(8804);t.StandardAgentStateManager=class{static createGraphState(){return{messages:{reducer:(e,t)=>e.concat(t)}}}static shouldContinue(e){const t=e.messages,o=t[t.length-1];return o.tool_calls?.length?"tools":"__end__"}static createWorkflow(e,t){const o=this.createGraphState(),s=new n.ToolNode(t);return new r.StateGraph({channels:o}).addNode("agent",(async t=>await e(t))).addNode("tools",s).addEdge("__start__","agent").addConditionalEdges("agent",this.shouldContinue).addEdge("tools","agent")}}},3520:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentController=void 0;const a=o(3563),c=o(1412),l=o(9055);let d=r=class{constructor(e){this.agentServices=e,this.logger=new a.Logger(r.name)}getAgentService(e){const t=this.agentServices.get(e);if(!t)throw new Error(`Unknown agent: ${e}`);return t}async processRequestWithStream(e,t,o){try{const r=c.AgentRequest.fromJSON(t);o.setHeader("Content-Type","text/event-stream"),o.setHeader("Cache-Control","no-cache"),o.setHeader("Connection","keep-alive"),o.setHeader("Location",`/sessions/${r.sessionId}/stream`);for await(const t of this.getAgentService(e).processRequestStream(r))o.write(`data: ${JSON.stringify(t)}\n\n`);o.end()}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),o.setHeader("Content-Type","application/json"),o.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}async processRequestNoStream(e,t,o){try{const r=c.AgentRequest.fromJSON(t),n=await this.getAgentService(e).processRequest(r);l.default.info("Returning result: %s",JSON.stringify(n)),o.setHeader("Content-Type","application/json"),o.json(n)}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),o.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}async processRequestAndGetContent(e,t,o){try{const r=c.AgentRequest.fromJSON(t);let n=(await this.getAgentService(e).processRequest(r)).responseContent.trim();l.default.info("Raw result: %s",n);const s=o.req.headers.accept;if(s&&s.includes("application/json"))try{const e=n.match(/\{[\s\S]*\}/);if(e){const t=JSON.parse(e[0]);return n=t,l.default.info("Extracted JSON content: %s",JSON.stringify(t)),o.setHeader("Content-Type","application/json"),void o.json(t)}}catch(e){l.default.warn("Failed to extract JSON from response content: %s",e.message)}o.setHeader("Content-Type","text/plain"),o.send(n)}catch(e){this.logger.error(`Error processing request: ${e.message}`,e.stack),o.status(a.HttpStatus.BAD_REQUEST).json({statusCode:a.HttpStatus.BAD_REQUEST,message:"Error processing request",error:e.message,stack:void 0})}}};t.AgentController=d,n([(0,a.Post)(":name/stream"),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),i(2,(0,a.Res)()),s("design:type",Function),s("design:paramtypes",[String,String,Object]),s("design:returntype",Promise)],d.prototype,"processRequestWithStream",null),n([(0,a.Post)(":name"),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),i(2,(0,a.Res)()),s("design:type",Function),s("design:paramtypes",[String,String,Object]),s("design:returntype",Promise)],d.prototype,"processRequestNoStream",null),n([(0,a.Post)(":name/responseContent"),(0,a.HttpCode)(a.HttpStatus.OK),i(0,(0,a.Param)("name")),i(1,(0,a.Body)()),i(2,(0,a.Res)()),s("design:type",Function),s("design:paramtypes",[String,String,Object]),s("design:returntype",Promise)],d.prototype,"processRequestAndGetContent",null),t.AgentController=d=r=n([(0,a.Controller)("agents"),i(0,(0,a.Inject)("AGENT_SERVICES")),s("design:paramtypes",[Map])],d)},2177:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AgentsModule=void 0;const n=o(3563),s=o(3520),i=o(5017),a=o(3887),c=o(5610),l=o(6695),d=o(2424),u=o(361),f=o(7307),p=o(3690),h=o(8471),m=o(4602),g=o(5873),y=o(3880),w=o(4193),S=o(9161),v={provide:"AGENT_SERVICES",useFactory:async(e,t,o,r,n,s)=>{const i=new Map;i.set("se-agent",e),i.set("ops-agent",t),i.set("review-agent",o),i.set("computer-use-agent",r),i.set("private-coder-agent",n);return(await s.loadPlugins()).forEach((e=>{e&&e.getName&&i.set(e.getName(),e)})),i},inject:[i.SEAgentService,a.OpsAgentService,c.ReviewAgentService,l.ComputerUseAgentService,h.PrivateCoderAgentService,f.PluginLoaderService]};let _=class{};t.AgentsModule=_,t.AgentsModule=_=r([(0,n.Module)({imports:[d.GraphAgentModule,u.ToolsModule,p.SimpleAgentModule,m.PrivateCoderAgentModule,g.WorkspaceModule,y.SessionModule,w.HomeModule,S.ChatCompletionModule],controllers:[s.AgentController],providers:[i.SEAgentService,a.OpsAgentService,c.ReviewAgentService,l.ComputerUseAgentService,h.PrivateCoderAgentService,f.PluginLoaderService,v],exports:[v]})],_)},2300:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.GraphAgentCollaborator=void 0;const s=o(3563),i=o(7373),a=o(1e3),c=o(1412),l=o(1544),d=o(1486),u=o(9055),f=o(6254),p=o(9100),h=o(9234),m=o(8474),g=o(6910),y=o(2368),w=o(538),S=o(3239),v=o(4911);let _=class{constructor(e,t,o,r,n){this.workspaceService=e,this.sessionService=t,this.checkpointerService=o,this.homeService=r,this.summaryCompletion=n,this.chatModelManager=l.ChatModelManager.getInstance()}async processRequest(e,t){u.default.info("Processing request: %s",JSON.stringify(t));const o=this.processRequestStream(e,t);let r=null;for await(const e of o)r=e,u.default.info("Yielded item: %s",JSON.stringify(e));if(!r)throw new Error("No items were yielded from the generator");const n=await this.sessionService.getRequest(r?.requestId);if(!n)throw new Error("Failed to retrieve persisted request");return u.default.info("Returning request: %s",JSON.stringify(n)),n}async*processRequestStream(e,t){const o=(0,p.ulid)();if(!await this.homeService.isAccessOkay()){const e={label:"Error",content:"Access is not valid. Please check your HLDK API key and try again."},r=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId||this.generateSessionId(),label:e.label,content:e.content,createdAt:new Date,requestId:o});return void(yield r)}const r=new Date;t.sessionId||(t.sessionId=this.generateSessionId());const n=await this.chatModelManager.getModel(t.config,e.getModelCategory());let s;t.workspaceName?s=await this.workspaceService.lockByName(t.workspaceName):(s=await this.workspaceService.lockSessionWorkspace(t.sessionId),t.workspaceName=s.name);const i=s.name,a=new h.RequestContext(s,o,t.sessionId);await e.verifyRequest(t,a);let l=!1,m=0,w=0,S=0,_=0,R="";try{const s=c.AgentRequest.getFirstTextContent(t.content),i=await this.sessionService.ensureSession(t.workspaceName,t.sessionId,s,e.getName());await this.sessionService.updateSessionStatus(i.sessionId,"active"),u.default.info("%s received request: %s - %s",e.getName(),o,JSON.stringify(t)),u.default.info("Using model: %s",n.modelDescriptor.getFullName());const p=await e.getTools(a),h=n.baseChatModel.bindTools(p),v=await e.getSystemPrompt(a);u.default.info("System prompt length: %s",v.length);const A=y.ConfigService.getNumericProperty(g.ConfigPropNames.AGENT_SYSTEM_PROMPT)||5e4;if(v.length>A)throw u.default.error("System prompt is longer than the maximum allowed length of %s characters - check the system prompt for %s",A,e.getName()),u.default.error("System prompt: %s",v),u.default.error("Consider adding a .hldkignore file or updating your .gitignore file to ignore some of the files in the workspace"),new Error(`System prompt is longer than the maximum allowed length of ${A} characters - check logs for more details - you can increase the limit by setting ${g.ConfigPropNames.AGENT_SYSTEM_PROMPT} on the home page`);var b=v;n.options.extraSystemMessageKwargs&&(b=[{type:"text",text:b,...n.options.extraSystemMessageKwargs}],u.default.debug("Using extra system message kwargs",n.options.extraSystemMessageKwargs));const O=this.checkpointerService.getCheckpointer(),E=e.createGraph(h,p,O);await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:"Human",content:s,createdAt:new Date,requestId:o}),await this.sessionService.addRequest({requestId:o,sessionId:t.sessionId,workspaceName:t.workspaceName,requestContent:s,startedAt:r});const I=t.config.recursionLimit||y.ConfigService.getNumericProperty(g.ConfigPropNames.AGENT_RECURSION_LIMIT)||50,P=n.options.extraHeaders?{configurable:{thread_id:t.sessionId},recursionLimit:I,headers:n.options.extraHeaders}:{configurable:{thread_id:t.sessionId},recursionLimit:I};u.default.debug("Call options: %s",JSON.stringify(P));const T=await O.get(P),C=f.MessageUtils.buildHumanMessage(t.content);let k=e.createInitialState();T?k.messages=[C]:n.options.extraSystemMessageKwargs?(u.default.debug("Using extra system message kwargs",n.options.extraSystemMessageKwargs),k.messages=[new d.SystemMessage({content:b,additional_kwargs:n.options.extraSystemMessageKwargs}),C]):n.options.systemPromptSupported?k.messages=[new d.SystemMessage({content:b}),C]:k.messages=[new d.HumanMessage({content:b}),C];const x=await E.stream(k,P);for await(const e of x){u.default.debug("Output Event was: %s",JSON.stringify(e));const r=f.MessageUtils.processOutputEvent(e);u.default.debug("Processed message: %s",r);const s=r.usageMetadata,i=n.calculateCost(s?.inputTokens||0,s?.cacheWriteTokens||0,s?.cacheReadTokens||0,s?.outputTokens||0),a={itemId:this.generateItemId(),sessionId:t.sessionId,label:r.label,content:r.content,createdAt:new Date,inputTokens:r.usageMetadata?.inputTokens,cacheWriteTokens:s?.cacheWriteTokens,cacheReadTokens:s?.cacheReadTokens,outputTokens:s?.outputTokens,totalTokens:s?.totalTokens,cost:i,requestId:o},c=await this.sessionService.addItem(a);m+=s?.inputTokens||0,w+=s?.cacheWriteTokens||0,S+=s?.cacheReadTokens||0,_+=s?.outputTokens||0,R=r.content;const d=await this.sessionService.getSession(t.sessionId);if(l=d&&"aborted"===d.status,l){const e={label:"Error",content:"Session was aborted by the user."},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:e.label,content:e.content,createdAt:new Date});yield o;break}yield c}}catch(e){u.default.error("Error in Agent:",e);const o={label:"Error",content:`An error occurred: ${e.message}`},r=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:t.sessionId,label:o.label,content:o.content,createdAt:new Date});yield r}finally{try{if(!l&&s.isGitRepo){const e=new v.GitCommit(s.repoBaseDir,o,this.sessionService);if(await e.hasUncommittedUpdates()){const t=await e.getUncommittedChanges(),o="Give me a good commit message for the following diff contents - just return the message without quotes",r=await this.summaryCompletion.getSummary(o,t);u.default.info("Detected uncommitted git updates - committing changes with message: "+r),await e._call(r)}}await this.sessionService.updateSessionStatus(t.sessionId,"inactive");const e=n.calculateCost(m,w,S,_),i=new Date,a=i.getTime()-r.getTime(),c=m+w+S+_,d=await this.sessionService.updateRequest(o,{responseContent:R,endedAt:i,tookMillis:a,inputTokens:m,cacheWriteTokens:w,cacheReadTokens:S,outputTokens:_,totalTokens:c,cost:e});await this.homeService.logRequest(d),u.default.info("Agent processing completed in %s seconds - Input tokens: %s, Cache Write tokens: %s, Cache Read tokens: %s, Output tokens: %s, Total tokens: %s, Total cost: £%s",a/1e3,m,w,S,_,c,e.toFixed(6))}finally{i&&await this.workspaceService.unlockByName(i)}}}generateSessionId(){return(0,p.ulid)()}generateItemId(){return(0,p.ulid)()}};t.GraphAgentCollaborator=_,t.GraphAgentCollaborator=_=r([(0,s.Injectable)(),n("design:paramtypes",[m.WorkspaceService,i.SessionService,a.CheckpointerService,w.HomeService,S.SummaryCompletion])],_)},2424:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.GraphAgentModule=void 0;const n=o(3563),s=o(2300),i=o(5873),a=o(3880),c=o(9449),l=o(3177),d=o(4193),u=o(9161);let f=class{};t.GraphAgentModule=f,t.GraphAgentModule=f=r([(0,n.Module)({imports:[i.WorkspaceModule,a.SessionModule,c.LangchainModule,l.MutationsModule,d.HomeModule,u.ChatCompletionModule],providers:[s.GraphAgentCollaborator],exports:[s.GraphAgentCollaborator]})],f)},5277:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.GraphAgentService=void 0;const i=o(3563),a=o(1412),c=o(7249),l=o(1162),d=o(6158),u=o(9055),f=o(2300);let p=class{constructor(e,t){this.agentCollaborator=e,this.toolFactoryService=t}async getTools(e){return await this.toolFactoryService.createTools(await this.getToolNames(e),e)}async getToolNames(e){return[]}async getSystemPrompt(e){throw new Error("Not implemented")}getName(){return"graph-agent"}getModelCategory(){return l.ModelCategory.CODING}isPrivateModelsOnly(){return!1}async verifyRequest(e,t){}async*processRequestStream(e){if(!e.workspaceName)throw new Error("Workspace name is required in the agent request");yield*this.agentCollaborator.processRequestStream(this,e)}async processRequest(e){return this.agentCollaborator.processRequest(this,e)}async simpleRequest(e,t,o=null){const r=new a.AgentRequest(null,e,o,null,t);return(await this.processRequest(r)).responseContent}createGraph(e,t,o){return c.StandardAgentStateManager.createWorkflow((async function(t){const o=t.messages;u.default.debug("Calling model with messages: %s",JSON.stringify(o));const r=await e.invoke(o);return u.default.debug("Received model response: %s",JSON.stringify(r)),{messages:[r]}}),t).compile({checkpointer:o})}createInitialState(){return{messages:[]}}};t.GraphAgentService=p,t.GraphAgentService=p=r([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>f.GraphAgentCollaborator)))),n("design:paramtypes",[f.GraphAgentCollaborator,d.ToolFactoryService])],p)},3690:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleAgentModule=void 0;const n=o(3563),s=o(5873),i=o(3880),a=o(4193),c=o(9161);let l=class{};t.SimpleAgentModule=l,t.SimpleAgentModule=l=r([(0,n.Module)({imports:[s.WorkspaceModule,i.SessionModule,a.HomeModule,c.ChatCompletionModule],exports:[]})],l)},6295:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleAgentService=void 0;const s=o(3563),i=o(1412),a=o(8474),c=o(7373),l=o(538),d=o(3239),u=o(9234),f=o(9100),p=o(9055),h=o(4911),m=o(1544),g=o(6254),y=o(6158);let w=class{constructor(e,t,o,r,n){this.workspaceService=e,this.sessionService=t,this.homeService=o,this.summaryCompletion=r,this.toolFactory=n,this.chatModelManager=m.ChatModelManager.getInstance()}createInitialState(){return{messages:[]}}async*processRequestStream(e){const t=(0,f.ulid)();if(!await this.homeService.isAccessOkay()){const o={label:"Error",content:"Access is not valid. Please check your HLDK API key and try again."},r=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId||this.generateSessionId(),label:o.label,content:o.content,createdAt:new Date,requestId:t});return void(yield r)}const o=new Date;e.sessionId||(e.sessionId=this.generateSessionId());const r=await this.chatModelManager.getModel(e.config,this.getModelCategory(),this.isPrivateModelsOnly());let n;e.workspaceName?n=await this.workspaceService.lockByName(e.workspaceName):(n=await this.workspaceService.lockSessionWorkspace(e.sessionId),e.workspaceName=n.name);const s=n.name,a=new u.RequestContext(n,t,e.sessionId);let c=!1,l=0,d=0,m=0,y=0,w="";try{const n=i.AgentRequest.getFirstTextContent(e.content),s=await this.sessionService.ensureSession(e.workspaceName,e.sessionId,n,this.getName());await this.sessionService.updateSessionStatus(s.sessionId,"active"),p.default.info("%s received request: %s - %s",this.getName(),t,JSON.stringify(e)),p.default.info("Using primary model: %s",r.modelDescriptor.getFullName()),await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:"Human",content:n,createdAt:new Date,requestId:t}),await this.sessionService.addRequest({requestId:t,sessionId:e.sessionId,workspaceName:e.workspaceName,requestContent:n,startedAt:o});const u=await this.handleAppStream(e,a,r);for await(const o of u){p.default.debug("Output Event was: %s",JSON.stringify(o));const n=g.MessageUtils.processOutputEvent(o);p.default.debug("Processed message: %s",n);const s=n.usageMetadata,i=r.calculateCost(s?.inputTokens||0,s?.cacheWriteTokens||0,s?.cacheReadTokens||0,s?.outputTokens||0),a={itemId:this.generateItemId(),sessionId:e.sessionId,label:n.label,content:n.content,createdAt:new Date,inputTokens:s?.inputTokens,cacheWriteTokens:s?.cacheWriteTokens,cacheReadTokens:s?.cacheReadTokens,outputTokens:s?.outputTokens,totalTokens:s?.totalTokens,cost:i,requestId:t},u=await this.sessionService.addItem(a);l+=s?.inputTokens||0,d+=s?.cacheWriteTokens||0,m+=s?.cacheReadTokens||0,y+=s?.outputTokens||0,w=n.content;const f=await this.sessionService.getSession(e.sessionId);if(c=f&&"aborted"===f.status,c){const t={label:"Error",content:"Session was aborted by the user."},o=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:t.label,content:t.content,createdAt:new Date});yield o;break}yield u}}catch(t){p.default.error("Error in Agent:",t);const o={label:"Error",content:`An error occurred: ${t.message}`},r=await this.sessionService.addItem({itemId:this.generateItemId(),sessionId:e.sessionId,label:o.label,content:o.content,createdAt:new Date});yield r}finally{try{if(!c&&n.isGitRepo){const e=new h.GitCommit(n.repoBaseDir,t,this.sessionService);if(await e.hasUncommittedUpdates()){const t=await e.getUncommittedChanges(),o="Give me a good commit message for the following diff contents - just return the message without quotes",r=await this.summaryCompletion.getSummary(o,t);p.default.info("Detected uncommitted git updates - committing changes with message: "+r),await e._call(r)}}await this.sessionService.updateSessionStatus(e.sessionId,"inactive");const s=r.calculateCost(l,d,m,y),i=new Date,a=i.getTime()-o.getTime(),u=l+d+m+y,f=await this.sessionService.updateRequest(t,{responseContent:w,endedAt:i,tookMillis:a,inputTokens:l,cacheWriteTokens:d,cacheReadTokens:m,outputTokens:y,totalTokens:u,cost:s});await this.homeService.logRequest(f),p.default.info("Agent processing completed in %s seconds - Input tokens: %s, Cache Write tokens: %s, Cache Read tokens: %s, Output tokens: %s, Total tokens: %s, Total cost: £%s",a/1e3,l,d,m,y,u,s.toFixed(6))}finally{s&&await this.workspaceService.unlockByName(s)}}}async processRequest(e){p.default.info("Processing request: %s",JSON.stringify(e));const t=this.processRequestStream(e);let o=null;for await(const e of t)o=e,p.default.info("Yielded item: %s",JSON.stringify(e));if(!o)throw new Error("No items were yielded from the generator");const r=await this.sessionService.getRequest(o?.requestId);if(!r)throw new Error("Failed to retrieve persisted request");return p.default.info("Returning request: %s",JSON.stringify(r)),r}async simpleRequest(e,t,o=null){const r=new i.AgentRequest(null,e,o,null,t);return(await this.processRequest(r)).responseContent}generateSessionId(){return(0,f.ulid)()}generateItemId(){return(0,f.ulid)()}};t.SimpleAgentService=w,t.SimpleAgentService=w=r([(0,s.Injectable)(),n("design:paramtypes",[a.WorkspaceService,c.SessionService,l.HomeService,d.SummaryCompletion,y.ToolFactoryService])],w)},6695:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ComputerUseAgentService=void 0;const i=o(3563),a=o(5277),c=o(6158),l=o(2300),d=o(8884);let u=class extends a.GraphAgentService{constructor(e,t){super(e,t),this.agentCollaborator=e,this.toolFactoryService=t}getName(){return"computer-use-agent"}async getTools(e){return this.toolFactoryService.createTools(["computer"],e)}async getSystemPrompt(e){const t=process.platform,o="win32"===t?"Windows":"darwin"===t?"macOS":"Linux",r=(0,d.getEnv)("WIDTH"),n=(0,d.getEnv)("HEIGHT");if(!r||!n)throw new Error("Screen resolution environment variables WIDTH and HEIGHT must be set");return`\n    You are a Computer Use Agent specializing in controlling the computer through keyboard and mouse automation. Your task is to help users achieve their goals by controlling the computer interface using the computer tool.\n\n    WORKSPACE INFORMATION:\n    Current operating system: ${o}\n    Screen resolution: ${r}x${n} pixels\n\n    AVAILABLE COMPUTER TOOL FUNCTIONS:\n\n    1. Keyboard Control:\n       - key: Send keyboard key events\n         * Use for special keys and key combinations\n         * Examples: "enter", "tab", "ctrl+c", "shift+a"\n       - type: Type text directly\n         * Use for entering regular text\n         * More reliable than individual key presses for text input\n         * Example: {"action": "type", "text": "Hello World"}\n\n    2. Mouse Control:\n       - mouse_move: Move mouse cursor to specific coordinates\n         * Requires x,y coordinates within screen bounds\n         * Example: {"action": "mouse_move", "coordinate": [100, 200]}\n       - left_click: Click the left mouse button\n         * Use after positioning the cursor\n         * For basic selection and activation\n       - right_click: Click the right mouse button\n         * Use for context menus\n         * Position cursor first\n       - middle_click: Click the middle mouse button\n         * Special functions in some applications\n       - double_click: Double click at current position\n         * Use for opening files/folders\n         * More reliable than two separate clicks\n       - left_click_drag: Click and drag operation\n         * For selections and drag-drop\n         * Requires target coordinates\n         * Example: {"action": "left_click_drag", "coordinate": [300, 400]}\n\n    3. Screen Information:\n       - screenshot: Capture the current screen\n         * Use to verify current state\n         * Helps in debugging automation\n       - cursor_position: Get current mouse coordinates\n         * Use to verify cursor location\n         * Helpful for planning movements\n\n    OPERATIONAL GUIDELINES:\n\n    1. Coordinate System:\n       - Screen coordinates start at (0,0) in top-left corner\n       - X increases right (0 to ${r}), Y increases down (0 to ${n})\n       - All coordinates must stay within screen bounds (0 ≤ x ≤ ${r}, 0 ≤ y ≤ ${n})\n\n    2. Best Practices:\n       - Always verify cursor position before clicking\n       - Use type action for text input when possible\n       - Add small delays between actions if needed\n       - Break complex operations into simple steps\n       - Verify results with screenshots when needed\n\n    3. Safety Considerations:\n       - Avoid rapid mouse movements\n       - Verify coordinates before drag operations\n       - Be cautious with double-clicks\n       - Allow time for system response\n\n    IMPORTANT REMINDERS:\n    1. NEVER guess about what is on the screen - always take a screenshot first to examine the current state\n    2. Take screenshots after performing actions to verify they had the intended effect\n    3. All coordinates must be within screen bounds\n    4. Always verify current state before critical actions\n    5. Use the most appropriate function for each task\n    6. Break complex tasks into simple, verifiable steps\n    7. Consider user confirmation for critical operations\n    8. Remember that screen layout may vary by system\n    9. Be prepared to handle unexpected states\n    10. NEVER assume we need to wait for an operation to complete - if the expected result is not visible in the screenshot, assume the operation did not work\n    \n    WORKFLOW REQUIREMENTS:\n    1. Before making any plan:\n       - Take a screenshot to understand the current state\n       - Analyze the screenshot to identify UI elements and their locations\n       - Only proceed once you have clear visual confirmation of the interface\n    \n    2. After performing actions:\n       - Take another screenshot to verify the results\n       - Compare with expected outcome\n       - If results don't match expectations, adjust your approach\n       \n    3. For complex operations:\n       - Break down into smaller steps\n       - Verify each step with a screenshot before proceeding\n       - Document any unexpected behavior or states`}};t.ComputerUseAgentService=u,t.ComputerUseAgentService=u=r([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>l.GraphAgentCollaborator)))),n("design:paramtypes",[l.GraphAgentCollaborator,c.ToolFactoryService])],u)},3887:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.OpsAgentService=void 0;const i=o(3563),a=o(9896),c=o(6928),l=o(5277),d=o(6158),u=o(2300);let f=class extends l.GraphAgentService{constructor(e,t){super(e,t),this.agentCollaborator=e,this.toolFactoryService=t}getName(){return"ops-agent"}async getTools(e){return this.toolFactoryService.createTools(["read_file","update_file","delete_file","command_line","add_workspace","fetch_web_page","git_init"],e)}async getSystemPrompt(e){let t="";const o=c.join(e.workspace.repoBaseDir,"ops-hints.md");a.existsSync(o)&&(t=a.readFileSync(o,"utf-8"));const r=process.platform,n="win32"===r?"Windows":"darwin"===r?"macOS":"Linux";return`\n    You are a helpful DevOps agent specializing in system operations, automation, and infrastructure management. Your task is to assist with various DevOps-related tasks and solve problems using the tools provided.\n\n    WORKSPACE INFORMATION:\n    Current working directory: ${e.workspace.repoBaseDir}\n    Current operating system: ${n}\n\n    AVAILABLE TOOLS AND THEIR USAGE:\n\n    1. File Operations:\n       - read_file: Read the contents of any file in the workspace\n       - update_file: Modify file contents (requires filePath, search text, and replacement text)\n       - delete_file: Remove a file (use with caution, confirm before deleting important files)\n\n    2. System Operations:\n       - command_line: Execute shell commands\n         * Can specify a subdirectory to run commands in\n         * Use for package management, build tools, and system commands\n         * ALWAYS include automatic confirmation flags to prevent hanging:\n           - Use --yes or -y for apt, apt-get\n           - Use -y for yum\n           - Use --no-input for pip\n           - Use -f or --force for npm/pnpm\n           - Use --defaults for yeoman\n           - Use --non-interactive for composer\n           - Use --assume-yes for other tools\n           - Add appropriate silent/quiet flags when available\n         * DO NOT use for process termination or destructive operations\n       \n    3. Git and Repository Management:\n       - git_init: Initialize a new Git repository\n       - Always use 'git add -A' for staging changes\n\n    5. Additional Tools:\n       - add_workspace: Add a new workspace (specify target project's base directory)\n       - fetch_web_page: Fetch web page content (only when explicitly requested)\n\n    OPERATIONAL GUIDELINES:\n\n    1. Safety and Security:\n       - Never perform destructive operations that cannot be undone\n       - Do not terminate processes unless explicitly instructed\n       - Stop and report if multiple solution attempts fail\n       - Never access or modify files outside the workspace directory\n\n    2. Workspace Management:\n       - You can create directories and files within the workspace\n       - You can read and modify any files under the repo root\n       - Never traverse up beyond the workspace root directory\n\n    3. Best Practices:\n       - Always verify file existence before operations\n       - Use appropriate error handling\n       - Document significant changes\n       - Ask for clarification when instructions are unclear or risky\n\n    Additional Workspace-Specific Hints:\n    ${e.repositoryHints()?`${e.repositoryHints()}`:""}\n\n    IMPORTANT REMINDERS:\n    1. Only use fetch_web_page when explicitly requested with a specific URL\n    2. Always use 'git add -A' rather than adding individual files\n    3. Confirm destructive operations with the user before proceeding\n    4. Stay within the workspace boundaries\n    5. Use tools according to their documented purposes and limitations\n    6. ALWAYS include automatic confirmation flags (--yes, -y, --force, etc.) when running interactive commands\n    7. Add appropriate silent/quiet flags to prevent unnecessary output when available`}};t.OpsAgentService=f,t.OpsAgentService=f=r([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>u.GraphAgentCollaborator)))),n("design:paramtypes",[u.GraphAgentCollaborator,d.ToolFactoryService])],f)},4602:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.PrivateCoderAgentModule=void 0;const n=o(3563),s=o(3690),i=o(8471),a=o(5873),c=o(3880),l=o(4193),d=o(9161),u=o(361);let f=class{};t.PrivateCoderAgentModule=f,t.PrivateCoderAgentModule=f=r([(0,n.Module)({imports:[s.SimpleAgentModule,a.WorkspaceModule,c.SessionModule,l.HomeModule,d.ChatCompletionModule,u.ToolsModule],providers:[i.PrivateCoderAgentService],exports:[i.PrivateCoderAgentService]})],f)},8471:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.PrivateCoderAgentService=void 0;const s=o(3563),i=o(6295),a=o(1162),c=o(1412),l=o(1486),d=o(8474),u=o(7373),f=o(538),p=o(3239),h=o(6158),m=o(9055);let g=class extends i.SimpleAgentService{constructor(e,t,o,r,n){super(e,t,o,r,n)}getName(){return"private-coder-agent"}getModelCategory(){return a.ModelCategory.CODING}isPrivateModelsOnly(){return!0}async*handleAppStream(e,t,o){const r=await this.chatModelManager.getModel(e.config,a.ModelCategory.CODING,this.isPrivateModelsOnly()),n=this.toolFactory.createTool("read_file",t),s=this.toolFactory.createTool("update_file",t),i=this.toolFactory.createTool("command_line",t),d=this.createInitialState(),u=c.AgentRequest.getFirstTextContent(e.content);let f=0,p=!1;const h={},g=`You are an AI coding assistant. Your task is to help implement the user's request by:\n\n1. YOU: Analyzing the repository structure and identifying relevant files by file path for the system to read.\n2. SYSTEM: The system will read the contents of the files and add them to the context.\n3. YOU: Suggest code changes using the specified search/replace format\n4. Iteratively refining the code until the build/tests pass.\n\nAt each step, you should give ONLY ONE of the following responses:\n\nA) Ask to read some (more) files (format described below)\nB) Provide code changes in the specified format (format described below)\nC) Answer the user's question or summarise the changes made\n\n\nA. Format for new files to be read and added to the context:\nread_files:\nfile_path1\nfile_path2\n*END*\n\nGuidelines for reading files:\n- Only include files that are relevant to the user's request.\n- Only include files that are in the repository.\n- If you are asked to add something new, then look for similar files/classes that already exist in the repository and that you can learn from and copy the structure and style from.\n- Once you have been given the contents of some files, you can either decide to read more files based on what you learned or you can suggest code changes for the files you have been given.\n\n\nB. Format for code changes:\n\nupdate_files:\n<filename1>\n<<<<<<< SEARCH\ncode_to_rewrite1\n=======\nnew_code1\n>>>>>>> REPLACE\n<filename1>\n<<<<<<< SEARCH\ncode_to_rewrite2\n=======\nnew_code2\n>>>>>>> REPLACE\n<filename2>\n<<<<<<< SEARCH\ncode_to_rewrite3\n=======\nnew_code3\n>>>>>>> REPLACE\n\n*END*\n\nGuidelines for code changes:\n\n- Filename must be on a line by itself before every SEARCH/REPLACE block.\n- SEARCH section must exactly match existing code, including whitespace, tabs, etc. (MAKE SURE THE INDENTING AND LINE ENDINGS MATCH THE ORIGINAL CODE EXACTLY).\n- For new files, use an empty SEARCH block.\n- Make minimal, focused changes.\n- Include necessary imports.\n- Preserve code style and formatting.\n- If you get an error trying to update a file, then try to expanding the search block out to include more of the code - the whole method perhaps etc.\n\nRepository structure:\n${t.repositoryTree()}\n`;d.messages.push(new l.SystemMessage({content:g})),d.messages.push(new l.HumanMessage({content:u}));e:for(;f<10&&!p;){f++,m.default.debug(`Iteration ${f}: State:\n${d.messages.map((e=>e.content)).join("\n")}`),m.default.info(`Iteration ${f}: Asking model for response...`);const e=await r.baseChatModel.invoke(d.messages);d.messages.push(e);const o=e.content.toString();m.default.info(`Iteration ${f}: Agent response:\n${o}`);const c=o.indexOf("read_files:"),u=o.indexOf("update_files:");if(-1!==c){const e=o.substring(c+11).split("\n").map((e=>e.trim())).filter((e=>e.length>0));for(const t of e){if(t.startsWith("*END*"))break;try{const e=await n._call({filePath:t});h[t]=e,d.messages.push(new l.HumanMessage({content:`Tool: Content of ${t}:\n${e}`})),yield d}catch(e){m.default.error(`Error reading file ${t}:`,e),d.messages.push(new l.HumanMessage({content:`Error reading ${t}: ${e.message}`})),yield d;continue e}}}else if(-1!==u){const e=o.indexOf("*END*");if(-1===e){d.messages.push(new l.HumanMessage({content:"Tool: No *END* found in update_files response"})),yield d;continue e}const r=o.substring(u+13,e).trim().split(/(?=^[^\n]+\n<{5,9} SEARCH)/m);let n="";for(const e of r){if(!e.includes("<<<<<<< SEARCH"))continue;let t=e.split("\n")[0].trim();t.length>0?n=t:0===n.length&&(t=n,m.default.warn("Empty filename found in update_files response, using last filename",{lastFilename:n}));const o=e.indexOf("<<<<<<< SEARCH\n")+15,r=e.indexOf("\n======="),i=r+9,a=e.indexOf("\n>>>>>>> REPLACE");if(-1===r||-1===a)continue;const c=e.substring(o,r).trim(),u=e.substring(i,a).trim();m.default.info(`Updating ${t} with search:\n${c}\nand replace:\n${u}`);try{const e=await s._call({filePath:t,search:c,replace:u});if(e.startsWith("Error:")){m.default.warn(`Failed to update file ${t} for search:\n${c}\nand replace:\n${u}\nThe output was:\n${e}`),d.messages.push(new l.HumanMessage({content:`Tool: Failed to update file ${t} for search:\n${c}\nand replace:\n${u}\nThe output was:\n${e}`})),yield d;continue e}d.messages.push(new l.HumanMessage({content:`Tool: Updated ${t}`}))}catch(e){m.default.warn(`Error updating file ${t}:`,e),d.messages.push(new l.HumanMessage({content:`Tool: Failed to update ${t}: ${e.message}`})),yield d;continue e}}if(t.workspace.buildOrTestCommand)try{const e=await i._call({command:t.workspace.buildOrTestCommand});m.default.info(`Build/Test Output:\n${e}`);const o='Based on the following output, did the build/tests pass? Reply just "YES" or "NO" - if the output is blank, then assume the tests passed and reply "YES"',r=await this.summaryCompletion.getSummary(o,e,a.ModelCategory.SUMMARISATION,!0);"YES"===r.trim().toUpperCase()?(p=!0,d.messages.push(new l.HumanMessage({content:"Build/tests passed successfully."}))):d.messages.push(new l.HumanMessage({content:`Tool: Build/tests failed with the following output:\n${e}\nPlease analyze the errors and suggest necessary code changes to fix the issues.`}))}catch(e){m.default.error("Error executing build/test command:",e),d.messages.push(new l.HumanMessage({content:`Tool: Failed to execute build/test command: ${e.message}`})),yield d;continue e}else p=!0,d.messages.push(new l.HumanMessage({content:"Tool: No build/test command provided. Assuming success."}))}else m.default.info(`AI answered the user's question: ${o}`),p=!0;yield d}p||(d.messages.push(new l.SystemMessage({content:"Maximum iterations reached without passing tests."})),yield d)}};t.PrivateCoderAgentService=g,t.PrivateCoderAgentService=g=r([(0,s.Injectable)(),n("design:paramtypes",[d.WorkspaceService,u.SessionService,f.HomeService,p.SummaryCompletion,h.ToolFactoryService])],g)},5610:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReviewAgentService=void 0;const i=o(3563),a=o(6158),c=o(9055),l=o(2300),d=o(5277);let u=class extends d.GraphAgentService{constructor(e,t){super(e,t),this.agentCollaborator=e,this.toolFactoryService=t}getName(){return"review-agent"}async getTools(e){return this.toolFactoryService.createTools(["read_file","update_file","delete_file","command_line","fetch_web_page","read_dependency_source_tree","read_dependency_source_file","git_commit","remote_git"],e)}async getSystemPrompt(e){let t=`As an AI code review assistant, you are tasked with analyzing and reviewing code changes in a pull request or specific commit.\n  Follow these guidelines:\n  1. The user input will be a URL to a pull request or a specific commit hash.\n  2. Use the "remote-git" toolkit (not implemented yet) to:\n     a. Sync the workspace to match the state of the commit/pull request.\n     b. Fetch the contents of the commit or the pull request (including comments).\n  3. Perform a thorough evaluation of the changes being made, considering:\n     a. Code quality and readability\n     b. Adherence to best practices and design patterns\n     c. Performance implications\n     d. Security considerations\n     e. Potential bugs or issues\n     f. Test coverage\n  4. Use the "remote-git" toolkit to add comments to specific parts of the code where:\n     a. Issues should be pointed out\n     b. Improvements can be suggested\n     c. Clarifications are needed\n  5. Provide a summary of the code changes, including:\n     a. An overview of the main changes\n     b. A list of files modified\n     c. Key points from your review\n     d. Any major concerns or praises\n  6. Use the read_file tool to examine the contents of specific files when needed.\n  7. If you need to reference or compare with existing code, use the read_file tool to retrieve the contents of those files.\n  8. Be constructive and respectful in your comments and feedback.\n  9. Prioritize the most important issues and suggestions in your review.\n  10. Consider the overall impact of the changes on the project's architecture and maintainability.\n\n  Here is the file tree of the system:\n  ${e.repositoryTree()}\n  \n  ${e.repositoryHints()?`Additional hints:\n${e.repositoryHints()}`:""}\n  \n  IMPORTANT: Remember that the "remote-git" toolkit is not implemented yet. When it becomes available, use it to fetch and interact with the pull request or commit data.\n  IMPORTANT: Focus on providing a thorough code review rather than making direct changes to the codebase.\n  IMPORTANT: Ensure your comments and suggestions are clear, specific, and actionable.\n  IMPORTANT: If you need to reference any existing files in the project, use the read_file tool to fetch their contents.\n  `;return c.default.debug(`Review Agent system prompt for workspace '${e.workspace.name}' (length: ${t.length} chars): ${t}`),t}};t.ReviewAgentService=u,t.ReviewAgentService=u=r([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>l.GraphAgentCollaborator)))),n("design:paramtypes",[l.GraphAgentCollaborator,a.ToolFactoryService])],u)},5017:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SEAgentService=void 0;const i=o(3563),a=o(6158),c=o(9055),l=o(2300),d=o(5277);let u=class extends d.GraphAgentService{constructor(e,t){super(e,t),this.agentCollaborator=e,this.toolFactoryService=t}getName(){return"se-agent"}async getTools(e){const t=["read_file","update_file","delete_file","command_line","fetch_web_page","read_dependency_source_tree","read_dependency_source_file","git_commit","current_timestamp"];return e.workspace.portFromBaseDir&&t.push("read_port_from_file"),this.toolFactoryService.createTools(t,e)}async getSystemPrompt(e){let t=`As an AI assistant, you are tasked with analysing the software system and answering questions about it and/or making improvements to it.\n  Follow these guidelines:\n  1. Review the file structure tree below and use the read_file tool to answer questions about the system and suggest improvements where appropriate. Provide a concise summary of your findings.\n  2. When making changes to the system:\n     a. First, fetch all the files you think you might need using the read_file tool. For files in the portFromBaseDir, use the read_port_from_file tool. For gradle/maven projects you can also use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for dependencies and inspect them to learn how to interact with them.\n     b. Make a clear plan with multiple steps.\n     c. Iterate through the plan, one step at a time.\n     d. Think step-by-step and explain the needed changes in a few short sentences.\n     e. Each change MUST be done by invoking the update_file tool to replace a part of the file with a new bit.\n  3. Use the read_file tool to retrieve the contents of specific files when needed rather than guessing at what they contain.\n     When making edits to previously referenced files, always keep the name/path the same.\n  4. When choosing a file path for generated artifacts, consider the structure and choose a logical location.\n  5. When a specific file name is mentioned, look for it in the structure below and use the read_file tool to get the content of that file.\n  6. Consider the following when suggesting improvements:\n     a. Code organization and structure\n     b. Adherence to best practices and design patterns\n     c. Performance optimizations\n     d. Security considerations\n     e. Scalability and maintainability\n     f. Documentation and comments\n  7. Provide clear explanations for your suggestions and recommendations.\n  8. If you need to create new files or modify existing ones, clearly indicate the file path and content.\n  9. When generating new code or modifying existing code, always look at similar or nearby files in the source tree for guidance on:\n     a. Code style and formatting\n     b. Logging practices\n     c. Error handling\n     d. Import statements and module organization\n     e. Commenting style and docstring format\n     f. Naming conventions for variables, functions, and classes\n     g. Tools, libraries, and frameworks being used\n     h. Your ending summary should be a concise summary of a) which files were updated and b) what changes were made to them.\n  10. To find similar files:\n      a. Examine the file structure provided below.\n      b. Identify files in the same directory or nearby directories with similar purposes or file extensions.\n      c. Use the read_file tool to retrieve the contents of these similar files for reference.\n  11. Ensure that new code generation and modifications align with the existing codebase's style and best practices.\n  12. Do not make assumptions about tools, libraries, or frameworks being used:\n      a. Always fetch and examine similar existing files before creating new ones.\n      b. When adding a new entity or data class, fetch an existing one first and use the same tooling and styles.\n      c. For data migrations, look at an existing migration file to understand the tooling and practices used in the repository.\n      d. Consistently use the same tools and approaches found in the existing codebase.\n  13. When making changes to the system use the update_file tool as follows:\n      a. Always provide the path to the file you want to change (or create) as the first argument.\n      b. The second argument is the SEARCH block - the bit of the existing code you want to replace. For new files this should be an empty string.\n      c. The third argument is the REPLACE block - the bit of the new code you want to replace it with. DO NOT FORGET TO INCLUDE THIS!!\n      d. Always try to minimise the size of the SEARCH block so you are only updating the specific parts of the file that need updating.\n      e. If you need to make edits to multiple parts of a single file, make a plan and do so in a series of update_file calls.\n      f. If you get an error back from the tool saying the search block was not found then you can try again with a larger search block or the entire contents of the file as the search block.\n  14. To delete a file, use the delete_file tool:\n      a. Provide the relative path of the file to delete as the argument.\n      b. Always confirm the file deletion with the user before proceeding.\n  15. When refactoring or renaming files:\n      a. Use the update_file tool to create the new file with the desired content.\n      b. Use the delete_file tool to remove the old file.\n      c. Update any references to the old file in other parts of the codebase using the update_file tool.\n  16. ${e.workspace.isGitRepo?"After making changes to the system, always commit the changes to git using the git_commit tool:\n      a. Use the git_commit tool with a brief, descriptive commit message of the changes you've made.\n      b. The git_commit tool will automatically stage and commit all changes, so you don't need to worry about git add commands.\n  17. If the user asks you to undo or /undo or undo the last changes, inform them that you cannot directly undo git commits, but they can use git reset --hard HEAD~1 in their local environment if needed.":"This workspace is not a git repository. You cannot commit changes or use git commands. Instead, focus on analyzing the code and suggesting improvements without version control operations."}\n  18. You can use the command_line tool to execute commands in the workspace directory${e.workspace.isGitRepo?", but not for git operations":""}. This includes system commands, package managers, build tools, etc. But remember the following:\n      a. Do not traverse up above the workspace directory though and only do things that are safe and can definitely be undone.\n      b. Only use package manager/build commands if you are sure of the correct one. Look in the readme or the build files to find out for sure and if not sure then do not use them. Just say what you might do to complete the task.\n      c. ALWAYS include automatic confirmation flags for interactive commands to prevent hanging:\n         - Use --yes or -y for apt, apt-get\n         - Use -y for yum\n         - Use --no-input for pip\n         - Use -f or --force for npm/pnpm\n         - Use --defaults for yeoman\n         - Use --non-interactive for composer\n         - Use --assume-yes for other tools\n         - Add appropriate silent/quiet flags when available\n  19. You can use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for dependencies and inspect them to learn how to interact with them. Look in the build file (e.g. pom.xml or build.gradle) or package metadata (e.g. package.json) and then use that to build the correct scheme and locator.\n  20. Always use the git_commit tool for git operations instead of the command_line tool. The git_commit tool is specifically designed for safe and efficient git operations in this environment.\n      `;return e.workspace.buildOrTestCommand&&(t+=`\n  21. After making changes to the system, but before committing them to git, consider the following:\n      a. If you have updated any code files (not just scripts, documentation, or other non-code files), you should run the following command to test if the changes haven't broken anything:\n         Use the command_line tool to execute this command: ${e.workspace.buildOrTestCommand}\n      b. If you run the test and any errors occur, try to fix them if it seems feasible.\n      c. If the errors cannot be fixed easily, stop processing and report the error to the user without committing the changes to git.\n      d. If you don't run the test or if the build or test is successful, proceed with committing the changes to git.\n      e. Remember, you only need to run this test command if you've made changes to actual code files, not for changes to scripts, documentation, or other non-code files.`),t+=`\n  \n  Here is the file tree of the system:\n  ${e.repositoryTree()}\n  \n  ${e.portFromSourceTree()?`\n  Here is the "port from" file tree containing another codebase that you can learn from and/or port code from (use read_port_from_file tool to read files from here):\n  ${e.portFromSourceTree()}\n  `:""}\n\n  ${e.repositoryHints()?`Additional hints:\n${e.repositoryHints()}`:""}\n  \n  ${e.workspace.buildOrTestCommand?`Build or Test Command: ${e.workspace.buildOrTestCommand}`:""}\n  \n  IMPORTANT: Keep your final summary concise and to the point. If you have made changes to multiple files, only list the files that have been changed and a short description of the changes for each file.\n  IMPORTANT: When using the update_file tool you MUST provide all 3 arguments: filePath, search & REPLACE. DO NOT FORGET TO INCLUDE THE REPLACE BLOCK!!\n  IMPORTANT: ALWAYS GO LOOKING IN THE CODEBASE AND FETCH ANY FILES YOU THINK YOU NEED TO LEARN FROM BEFORE MAKING CHANGES. DO NOT MAKE ASSUMPTIONS ABOUT WHAT IS IN A FILE - JUST FETCH IT!\n  IMPARTANT: You must NEVER try to stop processes or kill running processes. You must only use the command_line tool to execute commands.\n  IMPORTANT: Always use the update_file tool to make changes to the codebase. Never use the command_line tool to make changes to update source code.\n  IMPORTANT: If asked by the user, you can use the fetch_web_page tool to read the content of a web page. Only use this tool when explicitly requested by the user to fetch a specific URL.\n  IMPORTANT: When using the command_line tool, ALWAYS include automatic confirmation flags (--yes, -y, --force, etc.) for interactive commands to prevent hanging.\n  IMPORTANT: Add appropriate silent/quiet flags to command line operations when available to reduce unnecessary output.\n  \n  ${e.workspace.buildOrTestCommand?`\n    IMPORTANT: Run: ${e.workspace.buildOrTestCommand} to build and test the project after making changes to the code.\n    IMPORTANT: If you get an error then fix it and run the test again until you get it right.\n    IMPORTANT: If the build error relates to a maven/gradle dependency then you should use the read_dependency_source_tree and read_dependency_source_file tools to fetch the source code for the dependency and inspect it to see if you can fix the problem.\n    `:""}\n  IMPORTANT: IF YOU MADE CODE CHANGES THEN YOU MUST REMEMBER TO COMMIT YOUR CHANGES TO GIT! DO NOT FORGET THIS!\n  `,c.default.debug(`SE Agent system prompt for workspace '${e.workspace.name}' (length: ${t.length} chars): ${t}`),t}};t.SEAgentService=u,t.SEAgentService=u=r([(0,i.Injectable)(),s(0,(0,i.Inject)((0,i.forwardRef)((()=>l.GraphAgentCollaborator)))),n("design:paramtypes",[l.GraphAgentCollaborator,a.ToolFactoryService])],u)},715:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AppModule=void 0;const s=o(3563),i=o(2810),a=o(6928),c=o(6808),l=o(5873),d=o(3880),u=o(2177),f=o(9449),p=o(3177),h=o(3049),m=o(376),g=o(7967),y=o(1901),w=o(361),S=o(8221),v=o(7852),_=o(9161),R=o(4193),b=o(756),A=o(6552),O=o(8624),E=o(4240),I=o(4361),P=o(2776),T=o(9055);let C=class{constructor(e){this.appDataSource=e}async onModuleDestroy(){T.default.info("AppModule onModuleDestroy called.."),await this.appDataSource.close()}};t.AppModule=C,t.AppModule=C=r([(0,s.Module)({imports:[i.ServeStaticModule.forRoot({rootPath:(0,a.join)(__dirname,"..","..","vitify-webui","dist"),exclude:["/api*"]}),m.DataSourceModule,c.HelloWorldModule,l.WorkspaceModule,d.SessionModule,u.AgentsModule,f.LangchainModule,p.MutationsModule,h.AudioTranscriptionModule,g.ConfigModule,y.GitModule,w.ToolsModule,S.ReportingModule,v.SourceArtefactModule,_.ChatCompletionModule,R.HomeModule,b.PluginModule,A.DatasetModule,O.StoredFileModule,E.FormModule,I.DesignsModule],providers:[{provide:P.AppDataSource,useFactory:P.getAppDataSource}]}),n("design:paramtypes",[P.AppDataSource])],C)},2776:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAppDataSource=t.AppDataSource=void 0;const r=o(9055),n=o(1832),s=o(9187),i=o(8627);class a{constructor(e){this.dbChoice=e}async initKnexOnly(){const e=this.dbChoice?(0,s.default)(this.dbChoice):(0,s.getDefaultKnexConfig)();this.knex=(0,n.default)(e),await this.verifyDbConnection(this.knex)}async verifyDbConnection(e){try{r.default.info("Verifying database connection..."),await e.raw("SELECT 1"),r.default.info("Database connection successful")}catch(e){throw r.default.error("Database connection failed",e),e}}async initialize(){await this.initKnexOnly(),this.migrationManager=new i.KnexMigrationManager(this.knex),await this.runMigrations()}async runMigrations(){try{const e=await this.migrationManager.runMigrations();r.default.info(`Ran ${e.length} migrations`)}catch(e){throw r.default.error("Error running database migrations",e),e}}async close(){r.default.info("Closing data source..."),this.knex&&await this.knex.destroy(),r.default.info("Data source closed")}buildPaginationQuery(e,t){const o=(t.page-1)*t.limit;return`${e} LIMIT ${t.limit} OFFSET ${o}`}buildSortQuery(e,t){return`${e} ORDER BY ${t.field} ${t.order}`}}t.AppDataSource=a;let c=null;t.getAppDataSource=async()=>(null===c?(r.default.info("Creating new AppDataSource instance..."),c=new a,await c.initialize()):r.default.info("Returning existing AppDataSource instance..."),c)},376:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DataSourceModule=void 0;const n=o(3563),s=o(2776);let i=class{};t.DataSourceModule=i,t.DataSourceModule=i=r([(0,n.Module)({providers:[{provide:s.AppDataSource,useFactory:s.getAppDataSource},{provide:"KNEX",useFactory:e=>e.knex,inject:[s.AppDataSource]}],exports:[s.AppDataSource,"KNEX"]})],i)},9187:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultKnexConfig=function(){f||(f=u());return f};const r=o(9896),n=o(6928),s=o(857),i=o(9055),a=n.join(s.homedir(),".hldk","db","hldk.sqlite");function c(){let e=__dirname,t=n.join(e,"migrations");for(i.default.info(`Looking for migrations in: ${t} - will recurse up looking for migrations`);!l(t);)e=n.dirname(e),t=n.join(e,"migrations");if(d(t)||(t=n.join(process.cwd(),"migrations")),d(t)||(t=n.join(process.cwd(),"server","migrations")),!d(t))throw new Error("No migrations directory found in any of the usual locations");return t}function l(e){return r.existsSync(e)&&d(e)}function d(e){return r.readdirSync(e).some((e=>e.endsWith(".js")))}function u(e){let t;void 0===e&&(e=process.env.DB_CHOICE||"local"),i.default.info(`Using database configuration: ${e}`);try{t=function(e=process.env.DB_CHOICE||"local"){let t,o=process.env.DB_CONFIG_PATH||"db-config.json";try{t=r.readFileSync(o,"utf8")}catch(e){o=n.join(process.cwd(),"config","db-config.json");try{t=r.readFileSync(o,"utf8")}catch(e){throw new Error("Unable to find db-config.json")}}i.default.info(`Using db config at: ${o}`);const a=JSON.parse(t);if(!a[e])throw i.default.error(`Invalid DB_CHOICE: ${e} - not found in db-config.json - ${JSON.stringify(a)}`),new Error(`Invalid DB_CHOICE: ${e} - not found in db-config.json`);const c=a[e],l=c.connection;if("object"==typeof l&&"filename"in l&&(l.filename=l.filename.replace("~",s.homedir()),!r.existsSync(l.filename))){const e=n.dirname(o),t=n.resolve(e,l.filename);i.default.info(`Resolved filename: ${t} from config file directory: ${e} using relative path: ${l.filename}`),r.existsSync(t)?l.filename=t:i.default.warn(`DB File does not exist: ${t}`)}const u=c.migrations;if(u&&"string"==typeof u.directory){const e=n.resolve(n.dirname(o),u.directory);d(e)&&(c.migrations.directory=e)}return c.useNullAsDefault=!0,c}(e)}catch(o){if("local"!==e)throw i.default.error("error",o),i.default.error(`Invalid DB_CHOICE: ${e} - no db-config.json found`),new Error(`Invalid DB_CHOICE: ${e} - no db-config.json found`);i.default.info("Did not find db-config.json, using default SQLite configuration"),t={client:"sqlite3",connection:{filename:a},useNullAsDefault:!0}}if(i.default.info(`Using db config (after making paths absolute): ${JSON.stringify(t)}`),t.migrations||(i.default.warn("No migrations directory found in db-config.json, using default"),t.migrations={directory:c()}),t.migrations.extension="js",t.pool={min:1,max:10},t.connection&&"object"==typeof t.connection&&"filename"in t.connection){const e=t.connection.filename,o=n.dirname(e);r.existsSync(o)||(i.default.info(`Creating Database directory: ${o}`),r.mkdirSync(o,{recursive:!0}))}return i.default.info(`Using knex config: ${JSON.stringify(t)}`),t}var f=void 0;t.default=u},8627:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KnexMigrationManager=void 0;const r=o(9055);t.KnexMigrationManager=class{constructor(e){this.knexInstance=e}async runMigrations(){try{await this.fixMigrationNames();const e=await this.knexInstance.migrate.latest();return r.default.info(`Ran ${e[1].length} migrations`),e[1]}catch(e){throw r.default.error("Failed to run Knex migrations",e),e}}async getMigrationStatus(){try{const e=await this.knexInstance.migrate.list();return{completed:e[0],newMigrations:e[1]}}catch(e){throw r.default.error("Failed to get Knex migration status",e),e}}async fixMigrationNames(){try{if(!await this.knexInstance.schema.hasTable("knex_migrations"))return void r.default.debug("knex_migrations table does not exist. No changes needed.");const e=(await this.knexInstance("knex_migrations").select("*")).filter((e=>null!==e.name.match(/^(\d{14})(_.+\.js)$/)));if(0===e.length)return void r.default.debug("No migration files with 14-digit numeric prefixes found. No changes needed.");r.default.info(`Found ${e.length} migration(s) with 14-digit numeric prefixes. Proceeding to fix...`);for(const t of e){const e=t.name,o=this.fixName(e);o!==e?(await this.knexInstance("knex_migrations").where({id:t.id}).update({name:o}),r.default.info(`Updated "${e}" to "${o}"`)):r.default.info(`No change needed for "${e}"`)}}catch(e){throw r.default.error("An error occurred while fixing migration names:",e),e}}fixName(e){const t=e.match(/^(\d{14})(_.+\.js)$/);if(!t)return e;let o=t[1];const r=t[2];return o=o.replace(/0(?=\d$)/,""),o+r}}},1544:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatModelManager=void 0;const r=o(4264),n=o(1986),s=o(4659),i=o(8312),a=o(2088),c=o(2003),l=o(9055),d=o(1162),u=o(2368),f=o(2097),p=o(8910),h=o(3971),m=o(59);class g{constructor(){this.providers=[new n.AnthropicProvider,new r.OpenAIProvider,new s.GroqProvider,new i.OllamaProvider,new f.HyperbolicProvider,new p.MistralProvider,new h.OpenRouterProvider,new m.GlhfProvider]}static getInstance(){return g.instance||(g.instance=new g),g.instance}static async getModel(e,t=d.ModelCategory.CODING){return g.getInstance().getModel(e,t)}async getModel(e,t=d.ModelCategory.CODING,o=!1){let r=e?.model;r||(r=o?u.ConfigService.getInstance().getProperty(`PRIVATE_${t}_MODEL`):u.ConfigService.getInstance().getProperty(`DEFAULT_${t}_MODEL`));const n=await this.getProvider(r),s=await n.getModelDescriptor(r),i=n.getBaseChatModel(r,e||new c.AgentConfig),l=n.getChatModelOptions(s,e);return new a.ChatModel(s,i,l)}async getValidModelDescriptors(){const e=this.providers.filter((e=>e.isValid())).map((async e=>{try{return await e.getModelDescriptors()}catch(t){return l.default.error(`Error fetching model descriptors from provider ${e.getName()}:`,t),[]}}));return(await Promise.all(e)).flat()}async getValidModelNames(){return(await this.getValidModelDescriptors()).map((e=>e.name))}async getValidModelFullNames(){return(await this.getValidModelDescriptors()).map((e=>e.getFullName())).sort()}async getProvider(e){if(e){const[t]=e.split("/"),o=this.providers.find((e=>e.getName()===t));if(o){if(o.isValid())return o;l.default.warn(`Provider ${t} is not valid. Searching for first valid provider.`)}l.default.warn(`Provider not found or not valid for model ${e}. Searching for first valid provider.`)}const t=this.providers.find((e=>e.isValid()));if(t)return t;throw new Error("No valid provider found. Please check your API keys.")}}t.ChatModelManager=g},1e3:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.CheckpointerService=void 0;const s=o(3563),i=o(9314);let a=class{constructor(){this.checkpointer=new i.MemorySaver}getCheckpointer(){return this.checkpointer}};t.CheckpointerService=a,t.CheckpointerService=a=r([(0,s.Injectable)(),n("design:paramtypes",[])],a)},9449:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.LangchainModule=void 0;const n=o(3563),s=o(1e3);let i=class{};t.LangchainModule=i,t.LangchainModule=i=r([(0,n.Module)({providers:[s.CheckpointerService],exports:[s.CheckpointerService]})],i)},6254:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageUtils=void 0;const r=o(1486),n=o(9055);class s{static processOutputEvent(e){let t,o=e.messages,i="AI",a="No content found";if(!o&&e.agent&&e.agent.messages?o=e.agent.messages:!o&&e.tools&&e.tools.messages&&(o=e.tools.messages,i="Tool"),o&&o.length>0){const c=o[o.length-1];if(c instanceof r.ToolMessage||"tool"===c.type){return{label:"Tool",content:`Calling ${c.name||"Unknown Tool"}\nOutput was:\n${s.processContent(c.content)}`}}if(c instanceof r.AIMessage)return a=s.processContent(c.content),t=this.extractUsageMetadata(c),a.trim().length<1?(n.default.warn("AI message has empty content %s",{lastMessage:JSON.stringify(c)}),{label:"AI",content:JSON.stringify(c),usageMetadata:t}):{label:"AI",content:a,usageMetadata:t};if(c instanceof r.HumanMessage)return a=s.processContent(c.content),i=a.startsWith("Tool:")?"Tool":"Human",{label:i,content:a};if(c instanceof r.BaseMessage)return a=s.processContent(c.content),{label:i,content:a};n.default.warn("Processing unknown output using strings",{output:JSON.stringify(e)});const l=JSON.stringify(c),d=JSON.parse(l);if("kwargs"in d&&d.kwargs&&d.kwargs.content)return a=d.kwargs.content,t=this.extractUsageMetadata(d),{label:i,content:a,usageMetadata:t}}return n.default.warn("Processing unknown output: %s",{output:JSON.stringify(e)}),{label:"Unknown",content:JSON.stringify(e)}}static processContent(e){return Array.isArray(e)?e.filter((e=>"text"===e.type)).map((e=>e.text)).join("\n"):String(e)}static extractUsageMetadata(e){var t=e.response_metadata?.usage||e.usage_metadata;if(t){const e={inputTokens:t.input_tokens,cacheWriteTokens:t.cache_creation_input_tokens||0,cacheReadTokens:t.cache_read_input_tokens||0,outputTokens:t.output_tokens,totalTokens:t.total_tokens};return n.default.info("extractUsageMetadata - usageMetadata: %s",{usageMetadata:JSON.stringify(e)}),e}}static buildHumanMessage(e){if("string"==typeof e)return new r.HumanMessage(e);if(Array.isArray(e)&&1==e.length&&"text"===e[0].type)return new r.HumanMessage(e[0].text);{const t=e;return new r.HumanMessage({content:t})}}}t.MessageUtils=s},1986:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnthropicProvider=void 0;const r=o(646),n=o(8483),s=o(8959),i=o(2368),a=o(2088);class c extends n.BaseProvider{getMaxTokens(e){return e.endsWith(c.SONNET_MODEL_NAME)||e.endsWith(c.OPUS_MODEL_NAME)?8192:e.endsWith(c.HAIKU_MODEL_NAME)?4096:8192}getName(){return"anthropic"}getBaseChatModel(e,t){const o=this.getMaxTokens(e);console.log("Max tokens input:",o);return new r.ChatAnthropic({modelName:this.shortModelName(e),temperature:t.temperature,anthropicApiKey:i.ConfigService.getInstance().getProperty("ANTHROPIC_API_KEY"),maxTokens:o,anthropicApiUrl:process.env.ANTHROPIC_API_URL||"https://api.anthropic.com",clientOptions:{defaultHeaders:{"anthropic-beta":"prompt-caching-2024-07-31"}}})}async getModelDescriptors(){return[new s.ModelDescriptor("anthropic",c.SONNET_MODEL_NAME,225e-8,28125e-10,225e-9,1125e-8),new s.ModelDescriptor("anthropic",c.OPUS_MODEL_NAME,1125e-8,140625e-10,1125e-9,5625e-8),new s.ModelDescriptor("anthropic",c.HAIKU_MODEL_NAME,1.875e-7,225e-9,2.25e-8,9.375e-7)]}isValid(){return!!i.ConfigService.getInstance().getProperty("ANTHROPIC_API_KEY")}getChatModelOptions(e,t){const o=this.getExtraHeaders(e.name,t),r=this.getExtraSystemMessageKwargs(e.name,t);return new a.ChatModelOptions(o,r)}getExtraHeaders(e,t){return this.isPromptCachingEnabled(t)?{"anthropic-beta":"prompt-caching-2024-07-31"}:null}getExtraSystemMessageKwargs(e,t){return this.isPromptCachingEnabled(t)?{cache_control:{type:"ephemeral"}}:null}}t.AnthropicProvider=c,c.SONNET_MODEL_NAME="claude-3-5-sonnet-latest",c.OPUS_MODEL_NAME="claude-3-opus-20240229",c.HAIKU_MODEL_NAME="claude-3-haiku-20240307"},8483:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseProvider=void 0;const r=o(8959),n=o(9055),s=o(2088);t.BaseProvider=class{async getModelDescriptor(e){const t=await this.getModelDescriptors();if(!e)return t[0];const o=this.shortModelName(e),n=t.find((e=>e.name===o));if(!n&&this.supportsOnDemandModels())return new r.ModelDescriptor(this.getName(),o,0,0,0,0);if(!n)throw new Error(`Model ${o} not found for provider ${this.getName()}`);return n}shortModelName(e){const t=e.indexOf("/");if(-1===t)throw new Error(`Model name ${e} is not in the format provider/model`);return e.substring(t+1)||e}getChatModelOptions(e,t){return new s.ChatModelOptions}isPromptCachingEnabled(e){const t=!0===e?.cachePrompt;return n.default.info("isPromptCachingEnabled - cachePrompt: %s, result: %s",e?.cachePrompt,t),t}supportsOnDemandModels(){return!1}}},2088:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatModel=t.ChatModelOptions=void 0;class o{constructor(e=null,t=null,o=!0){this.extraHeaders=e,this.extraSystemMessageKwargs=t,this.systemPromptSupported=o}}t.ChatModelOptions=o;t.ChatModel=class{constructor(e,t,r=new o){this.modelDescriptor=e,this.baseChatModel=t,this.options=r}calculateCost(e,t,o,r){const n=this.modelDescriptor;return e*n.costPerInputToken+t*n.costPerCacheWriteToken+o*n.costPerCacheReadToken+r*n.costPerOutputToken}}},59:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlhfProvider=void 0;const r=o(8483),n=o(8959),s=o(2368),i=o(8938),a=o(6228);class c extends r.BaseProvider{getName(){return"glhf"}getBaseChatModel(e,t){return new a.ChatOpenAI({modelName:this.shortModelName(e),temperature:t.temperature,openAIApiKey:s.ConfigService.getInstance().getProperty("GLHF_API_KEY"),configuration:{baseURL:c.BASE_URL}})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>new n.ModelDescriptor("glhf",e.id,0,0,0,0)))}isValid(){return!!s.ConfigService.getInstance().getProperty("GLHF_API_KEY")}async fetchModels(){if(c.modelsCache&&Date.now()-c.modelsCache.timestamp<c.CACHE_TTL)return c.modelsCache.models;const e=s.ConfigService.getInstance().getProperty("GLHF_API_KEY");if(!e)return console.log("GLHF API key not found"),[];try{const t=await i.default.get(`${c.BASE_URL}/models`,{headers:{Authorization:`Bearer ${e}`}});if(200===t.status){const e=t.data.data;return c.modelsCache={models:e,timestamp:Date.now()},e}}catch(e){console.error("Error fetching GLHF models:",e)}return[]}supportsOnDemandModels(){return!0}}t.GlhfProvider=c,c.QWEN_2_5_CODER_32B_INSTRUCT="glhf/hf:Qwen/Qwen2.5-Coder-32B-Instruct",c.QWEN_2_5_72B_INSTRUCT="glhf/hf:Qwen/Qwen2.5-72B-Instruct",c.META_LLAMA_3_1_405B_INSTRUCT="glhf/hf:meta-llama/Meta-Llama-3.1-405B-Instruct",c.META_LLAMA_3_1_8B_INSTRUCT="glhf/hf:meta-llama/Meta-Llama-3.1-8B-Instruct",c.modelsCache=null,c.CACHE_TTL=3e5,c.BASE_URL="https://glhf.chat/api/openai/v1"},4659:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GroqProvider=void 0;const r=o(1463),n=o(8483),s=o(8959),i=o(2368),a=o(8938);class c extends n.BaseProvider{getName(){return"groq"}getBaseChatModel(e,t){return new r.ChatGroq({modelName:this.shortModelName(e),temperature:t.temperature,apiKey:i.ConfigService.getInstance().getProperty("GROQ_API_KEY")})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>new s.ModelDescriptor("groq",e,0,0,0,0)))}isValid(){return!!i.ConfigService.getInstance().getProperty("GROQ_API_KEY")}async fetchModels(){const e=i.ConfigService.getInstance().getProperty("GROQ_API_KEY");if(!e)return console.log("Groq API key not found"),[];try{const t=await a.default.get("https://api.groq.com/openai/v1/models",{headers:{Authorization:`Bearer ${e}`}});if(200===t.status){return(t.data.data||[]).map((e=>e.id))}return console.log(`Failed to fetch Groq models. Status code: ${t.status}`),[]}catch(e){return console.error(`Error fetching Groq models: ${e}`),[]}}}t.GroqProvider=c,c.LLAMA_31_8BB_INSTANT="groq/llama-3.1-8b-instant",c.LLAMA_31_70B_VERSATILE="groq/llama-3.1-70b-versatile",c.LLAMA_3_70B_8192_TOOL_USE="groq/llama3-groq-70b-8192-tool-use-preview"},2097:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HyperbolicProvider=void 0;const r=o(6228),n=o(8483),s=o(8959),i=o(2368);class a extends n.BaseProvider{getName(){return a.PROVIDER_NAME}getBaseChatModel(e,t){return new r.ChatOpenAI({modelName:this.shortModelName(e),temperature:t.temperature,openAIApiKey:i.ConfigService.getInstance().getProperty("HYPERBOLIC_API_KEY"),configuration:{baseURL:"https://api.hyperbolic.ai/v1"}})}async getModelDescriptors(){return a.LIST_OF_MODELS.map((e=>new s.ModelDescriptor(a.PROVIDER_NAME,e,0,0,0,0)))}isValid(){return!!i.ConfigService.getInstance().getProperty("HYPERBOLIC_API_KEY")}}t.HyperbolicProvider=a,a.QWEN_2_5_CODER_32B_INSTRUCT="Qwen/Qwen2.5-Coder-32B-Instruct",a.QWEN_2_5_72B_INSTRUCT="Qwen/Qwen2.5-72B-Instruct",a.DEEPSEEK_V2_5="deepseek-ai/DeepSeek-V2.5",a.META_LLAMA_3_1_405B_INSTRUCT="meta-llama/Meta-Llama-3.1-405B-Instruct",a.META_LLAMA_3_1_8B_INSTRUCT="meta-llama/Meta-Llama-3.1-8B-Instruct",a.PROVIDER_NAME="hyperbolic",a.LIST_OF_MODELS=[a.QWEN_2_5_CODER_32B_INSTRUCT,a.QWEN_2_5_72B_INSTRUCT,a.DEEPSEEK_V2_5,a.META_LLAMA_3_1_405B_INSTRUCT,a.META_LLAMA_3_1_8B_INSTRUCT]},8910:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MistralProvider=void 0;const r=o(2196),n=o(8483),s=o(8959),i=o(2368),a=o(8938);class c extends n.BaseProvider{getName(){return"mistral"}getBaseChatModel(e,t){return new r.ChatMistralAI({modelName:this.shortModelName(e),temperature:t.temperature,apiKey:i.ConfigService.getInstance().getProperty("MISTRAL_API_KEY")})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>{let t=1e-6,o=3e-6;return e.id.includes("large")?(t=7e-6,o=2e-5):e.id.includes("medium")&&(t=25e-7,o=7e-6),new s.ModelDescriptor("mistral",e.id,t,0,0,o)}))}isValid(){return!!i.ConfigService.getInstance().getProperty("MISTRAL_API_KEY")}async fetchModels(){if(c.modelsCache&&Date.now()-c.modelsCache.timestamp<c.CACHE_TTL)return c.modelsCache.models;const e=i.ConfigService.getInstance().getProperty("MISTRAL_API_KEY");if(!e)return console.log("Mistral API key not found"),[];try{const t=await a.default.get("https://api.mistral.ai/v1/models",{headers:{Authorization:`Bearer ${e}`}});if(200===t.status){const e=t.data.data||[];return c.modelsCache={models:e,timestamp:Date.now()},e}return console.log(`Failed to fetch Mistral models. Status code: ${t.status}`),[]}catch(e){return console.error(`Error fetching Mistral models: ${e}`),[]}}}t.MistralProvider=c,c.modelsCache=null,c.CACHE_TTL=3e5},1162:(e,t)=>{"use strict";var o;Object.defineProperty(t,"__esModule",{value:!0}),t.ModelCategory=void 0,function(e){e.CODING="CODING",e.REASONING="REASONING",e.SUMMARISATION="SUMMARISATION",e.RAG_QUERY="RAG_QUERY",e.ORCHESTRATION="ORCHESTRATION",e.ARCHITECT="ARCHITECT"}(o||(t.ModelCategory=o={}))},8959:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDescriptor=void 0;t.ModelDescriptor=class{constructor(e,t,o,r,n,s){this.provider=e,this.name=t,this.costPerInputToken=o,this.costPerCacheWriteToken=r,this.costPerCacheReadToken=n,this.costPerOutputToken=s}getFullName(){return`${this.provider}/${this.name}`}}},8312:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OllamaProvider=void 0;const r=o(3548),n=o(8483),s=o(8959),i=o(2368);class a extends n.BaseProvider{getName(){return"ollama"}getBaseChatModel(e,t){return new r.ChatOllama({baseUrl:this.getBaseUrl(),model:this.shortModelName(e),temperature:t.temperature})}async getModelDescriptors(){return(await this.fetchModels()).map((e=>new s.ModelDescriptor("ollama",e,0,0,0,0)))}isValid(){return!!this.getBaseUrl()}getBaseUrl(){return i.ConfigService.getInstance().getProperty("OLLAMA_BASE_URL")}async fetchModels(){const e=this.getBaseUrl();try{const t=await fetch(`${e}/api/tags`);if(t.ok){const e=await t.json();return(e.models||[]).map((e=>e.name))}return console.log(`Failed to fetch Ollama models. Status code: ${t.status}`),[]}catch(e){return console.error(`Error fetching Ollama models: ${e}`),[]}}}t.OllamaProvider=a},4264:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenAIProvider=void 0;const r=o(6228),n=o(8483),s=o(8959),i=o(2368),a=o(8938),c=o(2088);class l extends n.BaseProvider{static isO1Model(e){return e.startsWith("o1")}getName(){return"openai"}getBaseChatModel(e,t){const o=process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",n=this.shortModelName(e);return new r.ChatOpenAI({modelName:n,temperature:l.isO1Model(n)?1:t.temperature,openAIApiKey:i.ConfigService.getInstance().getProperty("OPENAI_API_KEY"),configuration:{basePath:o}})}async getModelDescriptors(){0===l.modelCache.models.length&&await this.fetchModels();return l.modelCache.models.map((e=>{const t=l.MODEL_COSTS[e.id]||{input:0,output:0};return new s.ModelDescriptor("openai",e.id,t.input/1e3,0,0,t.output/1e3)}))}isValid(){return!!i.ConfigService.getInstance().getProperty("OPENAI_API_KEY")}async fetchModels(){if(!this.isValid())return[];const e=Date.now();if(l.modelCache.models.length>0&&e-l.modelCache.timestamp<3e5)return l.modelCache.models;const t=i.ConfigService.getInstance().getProperty("OPENAI_API_KEY");if(!t)return console.log("OpenAI API key not found"),[];try{const o=process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",r=await a.default.get(`${o}/models`,{headers:{Authorization:`Bearer ${t}`}});if(200===r.status){const t=(r.data.data||[]).filter((e=>e.id.includes("gpt")||e.id.startsWith("o1")));return l.modelCache={models:t,timestamp:e},t}return console.log(`Failed to fetch OpenAI models. Status code: ${r.status}`),[]}catch(e){return console.error(`Error fetching OpenAI models: ${e}`),[]}}getChatModelOptions(e,t){return new c.ChatModelOptions(null,null,!l.isO1Model(e.name))}}t.OpenAIProvider=l,l.GPT_4O_MODEL_NAME="gpt-4o",l.GPT_4O_MINI_MODEL_NAME="gpt-4o-mini",l.modelCache={models:[],timestamp:0},l.MODEL_COSTS={"gpt-4o":{input:1875e-9*1e3,output:75e-7*1e3},"gpt-4o-mini":{input:1125e-7,output:45e-5}}},3971:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenRouterProvider=void 0;const r=o(6228),n=o(8483),s=o(8959),i=o(2368),a=o(8938);class c extends n.BaseProvider{constructor(){super()}getName(){return"openrouter"}getBaseChatModel(e,t){const o=process.env.OPENROUTER_BASE_URL||"https://openrouter.ai";let n=8e3;if(c.modelCache.models.length>0){const t=c.modelCache.models.find((t=>t.id===this.shortModelName(e)));t?.per_request_limits?.prompt_tokens&&(n=t.per_request_limits.prompt_tokens)}return new r.ChatOpenAI({modelName:this.shortModelName(e),temperature:t.temperature,maxTokens:n,openAIApiKey:i.ConfigService.getInstance().getProperty("OPENROUTER_API_KEY")},{basePath:`${o}/api/v1`,baseOptions:{headers:{"X-Title":"HLDK"}}})}async getModelDescriptors(){return 0===c.modelCache.models.length&&await this.fetchModels(),c.modelCache.models.map((e=>{const t=parseFloat(e.pricing.prompt)||0,o=parseFloat(e.pricing.completion)||0;return new s.ModelDescriptor("openrouter",e.id,t,0,0,o)}))}isValid(){return!!i.ConfigService.getInstance().getProperty("OPENROUTER_API_KEY")}async fetchModels(){if(!this.isValid())return[];const e=Date.now();if(c.modelCache.models.length>0&&e-c.modelCache.timestamp<3e5)return c.modelCache.models;const t=i.ConfigService.getInstance().getProperty("OPENROUTER_API_KEY"),o=process.env.OPENROUTER_BASE_URL||"https://openrouter.ai";if(!t)return console.log("OpenRouter API key not found"),[];try{const r=await a.default.get(`${o}/api/v1/models`,{headers:{Authorization:`Bearer ${t}`,"X-Title":"HLDK"}});if(200===r.status){const t=r.data.data||[];return c.modelCache={models:t,timestamp:e},t}return console.log(`Failed to fetch OpenRouter models. Status code: ${r.status}`),[]}catch(e){return console.error(`Error fetching OpenRouter models: ${e}`),[]}}}t.OpenRouterProvider=c,c.modelCache={models:[],timestamp:0}},7201:(e,t,o)=>{"use strict";o(1321);const r=o(818),n=o(6928),s=o(8781),i=o(715),a=o(7252),c=o(6928),l=o(9055),d=o(9187);(0,r.config)({path:(0,n.resolve)(__dirname,"../.env")}),async function(){(0,d.getDefaultKnexConfig)();const e=await s.NestFactory.create(i.AppModule);e.setGlobalPrefix("api"),e.enableCors({origin:["http://localhost:3011","http://localhost:3012","http://localhost:3013","http://localhost:3014"],methods:["GET","POST","PUT","PATCH","DELETE","OPTIONS"],allowedHeaders:"*",exposedHeaders:["Location"]}),e.use(a.json({limit:"100mb"})),e.use(a.urlencoded({limit:"100mb",extended:!0})),e.use(a.static((0,c.join)(__dirname,"webui"))),e.use("*",((e,t,o)=>{e.originalUrl.startsWith("/api")?o():t.sendFile((0,c.join)(__dirname,"webui","index.html"))}));const t=process.env.PORT||3010;await e.listen(t);const o=`http://localhost:${t}`;console.log(`\nhldk-server is now available at: ${o}`);const r=["SIGTERM","SIGINT"];for(const t of r)process.on(t,(async()=>{l.default.info(`Received ${t}. Starting graceful shutdown...`),await e.close(),l.default.info("Application shut down gracefully"),process.exit(0)}))}().catch((e=>{l.default.error("Error during application bootstrap:",e),process.exit(1)}))},885:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionController=void 0;const i=o(3563),a=o(9556),c=o(4562);let l=class{constructor(e){this.audioTranscriptionService=e}async transcribeAudio(e){try{return{transcription:await this.audioTranscriptionService.transcribe(e.buffer.toString("base64"))}}catch(e){throw console.error("Transcription error:",e),new Error("An error occurred during transcription")}}};t.AudioTranscriptionController=l,r([(0,i.Post)(),(0,i.UseInterceptors)((0,a.FileInterceptor)("audio")),s(0,(0,i.UploadedFile)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],l.prototype,"transcribeAudio",null),t.AudioTranscriptionController=l=r([(0,i.Controller)("audio-transcription"),n("design:paramtypes",[c.AudioTranscriptionService])],l)},3049:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionModule=void 0;const n=o(3563),s=o(885),i=o(4562);let a=class{};t.AudioTranscriptionModule=a,t.AudioTranscriptionModule=a=r([(0,n.Module)({controllers:[s.AudioTranscriptionController],providers:[i.AudioTranscriptionService,s.AudioTranscriptionController]})],a)},4562:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioTranscriptionService=void 0;const s=o(3563),i=o(5317),a=o(9896),c=o(857),l=o(6928);let d=r=class{constructor(){this.logger=new s.Logger(r.name)}async transcribe(e){this.logger.debug("Starting audio transcription");const t=Buffer.from(e,"base64"),o=l.join(c.tmpdir(),`audio-${Date.now()}.wav`);await a.promises.writeFile(o,t),this.logger.debug(`Temporary file created: ${o}`);try{const e=await this.runFasterWhisperCLI(o);return this.logger.debug("Transcription completed successfully"),e}finally{await a.promises.unlink(o),this.logger.debug(`Temporary file deleted: ${o}`)}}runFasterWhisperCLI(e){return new Promise(((t,o)=>{const r=l.join(c.tmpdir(),`audio-${Date.now()}.srt`);this.logger.debug(`Running Faster Whisper CLI on file: ${e}`);const n=process.env.TRANSCRIPTION_LANGUAGE||"en",s=process.env.TRANSCRIPTION_COMPUTE_TYPE||"float32",d=[e,"-o",r,"--task","transcribe","--without_timestamps","True","--language",n,"--compute_type",s],u=`faster-whisper ${d.join(" ")}`;this.logger.log(`Executing command: ${u}`);const f=(0,i.spawn)("faster-whisper",d);f.stdout.on("data",(e=>{this.logger.debug(`Faster Whisper stdout: ${e}`)})),f.stderr.on("data",(e=>{this.logger.warn(`Faster Whisper stderr: ${e}`)})),f.on("error",(e=>{this.logger.error(`Error in Faster Whisper process: ${e}`),o(new Error("Error in Faster Whisper process - make sure you have run the ./scripts/install-faster-whisper.sh script"))})),f.on("close",(async e=>{if(0===e)try{const e=await a.promises.readFile(r,"utf-8");this.logger.debug(`SRT content: ${e}`);const o=this.parseSrtContent(e);this.logger.debug("Faster Whisper process completed successfully"),t(o)}catch(e){this.logger.error(`Error reading SRT file: ${e}`),o(new Error(`Error reading SRT file: ${e.message}`))}finally{await a.promises.unlink(r),this.logger.debug(`Temporary SRT file deleted: ${r}`)}else this.logger.error(`Faster Whisper process exited with code ${e}`),o(new Error(`Faster Whisper process exited with code ${e}`))}))}))}parseSrtContent(e){const t=e.split("\n");let o="";for(let e=0;e<t.length;e++)/^\d+$/.test(t[e])||/.*-->.*$/.test(t[e])||(o+=t[e].trim()+" ");return o.trim()}};t.AudioTranscriptionService=d,t.AudioTranscriptionService=d=r=n([(0,s.Injectable)()],d)},9161:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ChatCompletionModule=void 0;const n=o(3563),s=o(3239);let i=class{};t.ChatCompletionModule=i,t.ChatCompletionModule=i=r([(0,n.Module)({providers:[s.SummaryCompletion],exports:[s.SummaryCompletion]})],i)},3239:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SummaryCompletion=void 0;const s=o(3563),i=o(1162),a=o(1544),c=o(1486),l=o(724),d=o(9055),u=o(2003);let f=class{constructor(){this.chatModelManager=a.ChatModelManager.getInstance()}async getSummary(e,t,o=i.ModelCategory.SUMMARISATION,r=!1,n){if(!t)throw new Error("Input content is empty - some models require input content to produce a summary");const s=n?new u.AgentConfig(n):new u.AgentConfig,a=await this.chatModelManager.getModel(s,o,r),f=[new c.SystemMessage(e),new c.HumanMessage(t)],p=new l.StringOutputParser,h=Date.now(),m=await a.baseChatModel.invoke(f),g=await p.invoke(m),y=Date.now()-h;return d.default.info("Summary produced by %s in %sms: %s",a.modelDescriptor.getFullName(),y,g),g}async getSummaryJson(e,t,o=i.ModelCategory.SUMMARISATION,r=!1,n){d.default.debug(`Getting summary JSON for prompt: ${e}`);const s=function(e){const t=e.indexOf("{"),o=e.indexOf("[");let r,n,s;if(-1!==t&&(-1===o||t<o))r=t,n="{",s="}";else{if(-1===o)return null;r=o,n="[",s="]"}let i=r+1,a=1;for(;i<e.length&&a>0;){const t=e[i];t===n?a++:t===s&&a--,i++}return 0===a?e.substring(r,i):null}((await this.getSummary(e,t,o,r,n)).trim());if(!s)throw new Error("No valid JSON object or array found in response");try{return JSON.parse(s),s}catch(e){throw new Error(`Failed to parse JSON from extracted content: ${e.message}`)}}};t.SummaryCompletion=f,t.SummaryCompletion=f=r([(0,s.Injectable)(),n("design:paramtypes",[])],f)},6910:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigPropNames=void 0;class o{}t.ConfigPropNames=o,o.HLDK_API_KEY="HLDK_API_KEY",o.DEFAULT_CODING_MODEL="DEFAULT_CODING_MODEL",o.DEFAULT_REASONING_MODEL="DEFAULT_REASONING_MODEL",o.DEFAULT_SUMMARISATION_MODEL="DEFAULT_SUMMARISATION_MODEL",o.DEFAULT_RAG_QUERY_MODEL="DEFAULT_RAG_QUERY_MODEL",o.DEFAULT_ORCHESTRATION_MODEL="DEFAULT_ORCHESTRATION_MODEL",o.DEFAULT_ARCHITECT_MODEL="DEFAULT_ARCHITECT_MODEL",o.PRIVATE_CODING_MODEL="PRIVATE_CODING_MODEL",o.PRIVATE_REASONING_MODEL="PRIVATE_REASONING_MODEL",o.PRIVATE_SUMMARISATION_MODEL="PRIVATE_SUMMARISATION_MODEL",o.PRIVATE_RAG_QUERY_MODEL="PRIVATE_RAG_QUERY_MODEL",o.PRIVATE_ORCHESTRATION_MODEL="PRIVATE_ORCHESTRATION_MODEL",o.PRIVATE_ARCHITECT_MODEL="PRIVATE_ARCHITECT_MODEL",o.AGENT_RECURSION_LIMIT="AGENT_RECURSION_LIMIT",o.AGENT_SYSTEM_PROMPT="MAX_SYSTEM_PROMPT_LENGTH",o.OLLAMA_BASE_URL="OLLAMA_BASE_URL",o.VALUE_PER_LINE="VALUE_PER_LINE",o.ANTHROPIC_API_KEY="ANTHROPIC_API_KEY",o.OPENAI_API_KEY="OPENAI_API_KEY",o.GROQ_API_KEY="GROQ_API_KEY",o.HYPERBOLIC_API_KEY="HYPERBOLIC_API_KEY",o.MISTRAL_API_KEY="MISTRAL_API_KEY",o.OPENROUTER_API_KEY="OPENROUTER_API_KEY",o.GLHF_API_KEY="GLHF_API_KEY",o.MODE="MODE"},5015:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigController=void 0;const i=o(3563),a=o(2368);let c=class{constructor(e){this.configService=e}getConfig(){return this.configService.getConfig()}async getAllProperties(){return this.configService.getAllProperties()}async getProperty(e){return this.configService.getProperty(e)}async setProperty(e,t){return await this.configService.setProperty(e,t),{message:"Property set successfully"}}async unsetProperty(e){return await this.configService.unsetProperty(e),{message:"Property unset successfully"}}async updateMultipleProperties(e){for(const[t,o]of Object.entries(e))await this.configService.setProperty(t,o);return{message:"Properties updated successfully"}}};t.ConfigController=c,r([(0,i.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",void 0)],c.prototype,"getConfig",null),r([(0,i.Get)("properties"),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],c.prototype,"getAllProperties",null),r([(0,i.Get)("property/:name"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getProperty",null),r([(0,i.Put)("property/:name"),s(0,(0,i.Param)("name")),s(1,(0,i.Body)("value")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"setProperty",null),r([(0,i.Delete)("property/:name"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"unsetProperty",null),r([(0,i.Post)("properties"),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],c.prototype,"updateMultipleProperties",null),t.ConfigController=c=r([(0,i.Controller)("config"),n("design:paramtypes",[a.ConfigService])],c)},3713:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigDescriptors=t.ConfigSection=t.ConfigPropertyDescriptor=void 0;const r=o(6910),n=o(1544),s=o(1986),i=o(4264),a=o(59),c=o(4659);class l{constructor(e,t,o,r,n,s,i){this.label=e,this.name=t,this.type=o,this.description=r,this.sensitive=n,this.defaultValue=s,this.possibleValues=i}}t.ConfigPropertyDescriptor=l;class d{constructor(e,t){this.title=e,this.properties=t}}t.ConfigSection=d;class u{constructor(e){this.sections=e}static getDefaultDescriptors(){const e=async()=>n.ChatModelManager.getInstance().getValidModelFullNames();return new u([new d("API Keys",[new l("HLDK API Key",r.ConfigPropNames.HLDK_API_KEY,"string","HLDK API Key",!0),new l("Anthropic API Key",r.ConfigPropNames.ANTHROPIC_API_KEY,"string","Anthropic API Key",!0),new l("OpenAI API Key",r.ConfigPropNames.OPENAI_API_KEY,"string","OpenAI API Key",!0),new l("Groq API Key",r.ConfigPropNames.GROQ_API_KEY,"string","Groq API Key",!0),new l("Hyperbolic API Key",r.ConfigPropNames.HYPERBOLIC_API_KEY,"string","Hyperbolic API Key",!0),new l("Mistral API Key",r.ConfigPropNames.MISTRAL_API_KEY,"string","Mistral API Key",!0),new l("OpenRouter API Key",r.ConfigPropNames.OPENROUTER_API_KEY,"string","OpenRouter API Key",!0),new l("GLHF Chat API Key",r.ConfigPropNames.GLHF_API_KEY,"string","GLHF Chat API Key",!0)]),new d("Default Models",[new l("Coding Model",r.ConfigPropNames.DEFAULT_CODING_MODEL,"enum","Coding Model",!1,"anthropic/"+s.AnthropicProvider.SONNET_MODEL_NAME,e),new l("Reasoning Model",r.ConfigPropNames.DEFAULT_REASONING_MODEL,"enum","Reasoning Model",!1,"openai/"+i.OpenAIProvider.GPT_4O_MODEL_NAME,e),new l("Summarisation Model",r.ConfigPropNames.DEFAULT_SUMMARISATION_MODEL,"enum","Summarisation Model",!1,c.GroqProvider.LLAMA_31_8BB_INSTANT,e),new l("RAG Query Model",r.ConfigPropNames.DEFAULT_RAG_QUERY_MODEL,"enum","RAG Query Model",!1,"openai/"+i.OpenAIProvider.GPT_4O_MODEL_NAME,e),new l("Orchestration Model",r.ConfigPropNames.DEFAULT_ORCHESTRATION_MODEL,"enum","Orchestration Model",!1,"openai/"+i.OpenAIProvider.GPT_4O_MODEL_NAME,e),new l("Architect Model",r.ConfigPropNames.DEFAULT_ARCHITECT_MODEL,"enum","Architect Model",!1,"anthropic/"+s.AnthropicProvider.SONNET_MODEL_NAME,e)]),new d("Private Models",[new l("Coding Model",r.ConfigPropNames.PRIVATE_CODING_MODEL,"enum","Private Coding Model",!0,a.GlhfProvider.QWEN_2_5_CODER_32B_INSTRUCT,e),new l("Reasoning Model",r.ConfigPropNames.PRIVATE_REASONING_MODEL,"enum","Private Reasoning Model",!0,a.GlhfProvider.META_LLAMA_3_1_405B_INSTRUCT,e),new l("Summarisation Model",r.ConfigPropNames.PRIVATE_SUMMARISATION_MODEL,"enum","Private Summarisation Model",!0,c.GroqProvider.LLAMA_31_8BB_INSTANT,e),new l("RAG Query Model",r.ConfigPropNames.PRIVATE_RAG_QUERY_MODEL,"enum","Private RAG Query Model",!0,a.GlhfProvider.QWEN_2_5_CODER_32B_INSTRUCT,e),new l("Orchestration Model",r.ConfigPropNames.PRIVATE_ORCHESTRATION_MODEL,"enum","Private Orchestration Model",!0,a.GlhfProvider.QWEN_2_5_CODER_32B_INSTRUCT,e),new l("Architect Model",r.ConfigPropNames.PRIVATE_ARCHITECT_MODEL,"enum","Private Architect Model",!0,a.GlhfProvider.QWEN_2_5_CODER_32B_INSTRUCT,e)]),new d("Ollama",[new l("Ollama Base URL",r.ConfigPropNames.OLLAMA_BASE_URL,"string","Ollama Base URL - default: http://localhost:11434",!1)]),new d("Misc",[new l("Agent Recursion Limit",r.ConfigPropNames.AGENT_RECURSION_LIMIT,"number","How many times an agent can call itself recursively before halting",!1,50),new l("Agent System Prompt",r.ConfigPropNames.AGENT_SYSTEM_PROMPT,"number","Maximum length of the system prompt for agents",!1,5e4),new l("Dashboard £ per LOC",r.ConfigPropNames.VALUE_PER_LINE,"number","Approximate value created per line of code generated in £",!1,2.4)])])}}t.ConfigDescriptors=u},1080:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigProperty=void 0;t.ConfigProperty=class{constructor(e,t){this.name=e,this.value=t}}},7967:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigModule=void 0;const n=o(3563),s=o(5015),i=o(2368),a=o(5699),c=o(3713),l=o(376);let d=class{};t.ConfigModule=d,t.ConfigModule=d=r([(0,n.Module)({imports:[l.DataSourceModule],controllers:[s.ConfigController],providers:[i.ConfigService,a.ConfigPropertyRepository,c.ConfigPropertyDescriptor,c.ConfigSection,c.ConfigDescriptors],exports:[i.ConfigService,a.ConfigPropertyRepository,c.ConfigPropertyDescriptor,c.ConfigSection,c.ConfigDescriptors]})],d)},5699:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigPropertyRepository=void 0;const a=o(3563),c=(o(1832),o(1080));let l=r=class{constructor(e){this.knex=e,this.logger=new a.Logger(r.name)}async getProperty(e){try{const t=await this.knex("config_properties").select("value").where("name",e).first();return t?.value||null}catch(t){return this.logger.error(`Error getting property ${e}`,t),null}}async setProperty(e,t){try{null===t?await this.knex("config_properties").where("name",e).delete():await this.knex("config_properties").insert({name:e,value:t}).onConflict("name").merge()}catch(t){throw this.logger.error(`Error setting property ${e}`,t),t}}async getAllProperties(){try{return(await this.knex("config_properties").select("*")).map((e=>new c.ConfigProperty(e.name,e.value)))}catch(e){return this.logger.error("Error getting all properties",e),[]}}async deleteProperty(e){try{await this.knex("config_properties").where("name",e).delete()}catch(t){throw this.logger.error(`Error deleting property ${e}`,t),t}}};t.ConfigPropertyRepository=l,t.ConfigPropertyRepository=l=r=n([(0,a.Injectable)(),i(0,(0,a.Inject)("KNEX")),s("design:paramtypes",[Function])],l)},2368:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigService=void 0;const i=o(3563),a=o(5699),c=o(3713),l=o(6910);let d=r=class{constructor(e){this.configPropertyRepository=e,this.configCache=new Map,this.logger=new i.Logger(r.name),r.instance=this,this.cachedDescriptors=c.ConfigDescriptors.getDefaultDescriptors()}static getInstance(){if(!r.instance)throw new Error("ConfigService has not been initialized");return r.instance}static getProperty(e,t){return r.getInstance().getProperty(e,t)}static getNumericProperty(e,t){return r.getInstance().getNumericProperty(e,t)}static getBooleanProperty(e,t){return r.getInstance().getBooleanProperty(e,t)}async onModuleInit(){try{await this.loadConfigToCache()}catch(e){this.logger.error("Failed to load config properties to cache",e)}}async loadConfigToCache(){try{const e=await this.configPropertyRepository.getAllProperties();this.configCache.clear();for(const t of e)this.configCache.set(t.name,t.value);this.logger.log("Config properties loaded to cache successfully")}catch(e){throw this.logger.error("Error loading config properties to cache",e),e}}async getConfig(){const e=new Map,t=[],o=c.ConfigDescriptors.getDefaultDescriptors();for(const t of o.sections)for(const o of t.properties){const t=this.getProperty(o.name);if(null!==t&&e.set(o.name,o.sensitive?this.maskValue(t):t),"function"==typeof o.possibleValues){const e=await o.possibleValues();o.possibleValues=e}}return null===this.getProperty(l.ConfigPropNames.HLDK_API_KEY)&&t.push("You need to set the HLDK API Key which you can get from higherlevel.dev/app"),null===this.getProperty(l.ConfigPropNames.ANTHROPIC_API_KEY)&&t.push("You need to set the Anthropic API Key which you can get from console.anthropic.com"),{version:"0.17.0",mode:process.env.MODE||"normal",descriptors:o,currentValues:Object.fromEntries(e),requiredActions:t.length>0?t:void 0}}getProperty(e,t){const o=process.env[e];if(void 0!==o)return o;const r=this.configCache.get(e);if(void 0!==r)return r;const n=this.findDescriptor(e);return n?n?.defaultValue?.toString()||t||null:(this.logger.warn(`Unknown property: ${e}`),null)}getNumericProperty(e,t){const o=this.getProperty(e);return null!==o?parseFloat(o):t||null}getBooleanProperty(e,t){const o=this.getProperty(e);return null!==o?"true"===o.toLowerCase():t||null}findDescriptor(e){for(const t of this.cachedDescriptors.sections){const o=t.properties.find((t=>t.name===e));if(o)return o}}async setProperty(e,t){try{t?(await this.configPropertyRepository.setProperty(e,t),this.configCache.set(e,t)):await this.unsetProperty(e)}catch(t){throw this.logger.error(`Error setting property ${e}`,t),t}}async unsetProperty(e){try{await this.configPropertyRepository.deleteProperty(e),this.configCache.delete(e)}catch(t){throw this.logger.error(`Error unsetting property ${e}`,t),t}}async getAllProperties(){return Array.from(this.configCache.entries()).map((([e,t])=>({name:e,value:t})))}maskValue(e){if(!e)return"not set";if(e.length<20)return"*".repeat(e.length);const t=e.length-8-4;return e.slice(0,8)+"*".repeat(t)+e.slice(-4)}};t.ConfigService=d,t.ConfigService=d=r=n([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigPropertyRepository])],d)},1747:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetDocument=void 0;const r=o(9100);t.DatasetDocument=class{constructor(e,t,o,n="new",s=(0,r.ulid)(),i=new Date,a=new Date){this.id=s,this.datasetId=e,this.filename=t,this.contentHash=o,this.status=n,this.createdAt=i,this.updatedAt=a}}},6932:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetDocumentRepository=void 0;const i=o(3563);o(1832);let a=class{constructor(e){this.knex=e}async findAll(e){return this.knex("datasetDocuments").where("datasetId",e).select("*")}async findById(e){return this.knex("datasetDocuments").where("id",e).first()}async create(e){await this.knex("datasetDocuments").insert(e)}async update(e,t){const o={...t,updatedAt:new Date};await this.knex("datasetDocuments").where("id",e).update(o)}async delete(e){await this.knex("datasetDocuments").where("id",e).delete()}async updateStatus(e,t){await this.knex("datasetDocuments").where("id",e).update({status:t,updatedAt:new Date})}};t.DatasetDocumentRepository=a,t.DatasetDocumentRepository=a=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},8460:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetIndexingService=void 0;const i=o(3563),a=o(2368),c=o(6932),l=o(7184),d=o(7093),u=o(5796),f=o(7310),p=o(8565),h=o(9179),m=o(7915),g=o(4897),y=o(779),w=o(6928),S=o(9100);let v=r=class{constructor(e,t,o){this.configService=e,this.datasetRepository=t,this.documentRepository=o,this.logger=new i.Logger(r.name),this.embeddingsModel=process.env.EMBEDDINGS_MODEL||"Xenova/all-mpnet-base-v2",this.chunkSize=parseInt(process.env.CHUNK_SIZE||"1000",10),this.chunkOverlap=parseInt(process.env.CHUNK_OVERLAP||"200",10),this.chromaUrl=process.env.CHROMA_URL||"http://localhost:8000"}getLoader(e){const t=w.extname(e).toLowerCase();let o;switch(this.logger.log(`Selecting loader for file extension: ${t}`),t){case".pdf":this.logger.log("Using PDFLoader"),o=new p.PDFLoader(e);break;case".docx":this.logger.log("Using DocxLoader"),o=new h.DocxLoader(e);break;case".pptx":this.logger.log("Using PPTXLoader"),o=new g.PPTXLoader(e);break;case".csv":this.logger.log("Using CSVLoader"),o=new y.CSVLoader(e);break;default:this.logger.log("Using UnstructuredLoader for unknown file type"),o=new m.UnstructuredLoader(e)}return o}async indexDocument(e,t,o){try{this.logger.log(`Starting indexing process for document ${e} in dataset ${t}`),await this.documentRepository.updateStatus(e,"indexing"),this.logger.log("Updated document status to 'indexing'"),this.logger.log(`Loading document from path: ${o}`);const r=this.getLoader(o),n=await r.load();this.logger.log(`Successfully loaded document with ${n.length} pages/sections`),this.logger.log(`Splitting text with chunk size ${this.chunkSize} and overlap ${this.chunkOverlap}`);const s=new d.RecursiveCharacterTextSplitter({chunkSize:this.chunkSize,chunkOverlap:this.chunkOverlap}),i=await s.splitDocuments(n);this.logger.log(`Text split into ${i.length} chunks`),i.forEach((t=>{const o=(0,S.ulid)();t.id=o,t.metadata.original_document_id=e,t.metadata.id=o})),this.logger.log(`Initializing embeddings model: ${this.embeddingsModel}`);const a=new f.HuggingFaceTransformersEmbeddings({modelName:this.embeddingsModel}),c=await this.datasetRepository.findById(t);if(!c)throw new Error("Dataset not found");this.logger.log(`Using dataset collection name: ${c.name}`),this.logger.log(`Storing vectors in Chroma at ${this.chromaUrl}`);await u.Chroma.fromDocuments(i,a,{collectionName:c.name,url:this.chromaUrl});this.logger.log("Successfully stored vectors in Chroma"),await this.documentRepository.updateStatus(e,"indexed"),this.logger.log(`Successfully completed indexing of document ${e} in dataset ${t}`)}catch(o){throw this.logger.error(`Failed to index document ${e} in dataset ${t}`),this.logger.error(`Error details: ${o.message}`),o.stack&&this.logger.error(`Stack trace: ${o.stack}`),await this.documentRepository.updateStatus(e,"error"),o}}async removeDocumentFromIndex(e,t){try{this.logger.log(`Removing document ${e} from index collection ${t}`);const o=new f.HuggingFaceTransformersEmbeddings({modelName:this.embeddingsModel}),r=new u.Chroma(o,{collectionName:t,url:this.chromaUrl});await r.delete({filter:{original_document_id:e}}),this.logger.log(`Successfully removed document ${e} from index`)}catch(t){throw this.logger.error(`Failed to remove document ${e} from index: ${t.message}`),t}}};t.DatasetIndexingService=v,t.DatasetIndexingService=v=r=n([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigService,l.DatasetRepository,c.DatasetDocumentRepository])],v)},6696:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetRetrievalService=void 0;const i=o(3563),a=o(2368),c=o(8077),l=o(7310),d=o(5796);let u=r=class{constructor(e,t){this.configService=e,this.datasetService=t,this.logger=new i.Logger(r.name),this.embeddingsModel=process.env.EMBEDDINGS_MODEL||"Xenova/all-mpnet-base-v2",this.chromaUrl=process.env.CHROMA_URL||"http://localhost:8000"}async searchDataset(e,t,o=20,r=void 0){try{this.logger.log(`Searching dataset ${e} for: ${t}`),this.logger.log(`Initializing embeddings model: ${this.embeddingsModel}`);const n=new l.HuggingFaceTransformersEmbeddings({modelName:this.embeddingsModel}),s=new d.Chroma(n,{collectionName:e,url:this.chromaUrl});if(!r){const r=await s.similaritySearch(t,o);return this.logger.log(`Found ${r.length} matches in dataset ${e}`),r}const i=await this.datasetService.getAllDatasets().then((t=>t.find((t=>t.name===e))));if(!i)throw new Error(`Dataset ${e} not found`);const a=await this.datasetService.getDocuments(i.id),c=a.map((e=>(this.logger.log(`Searching for ${t} in document ${e.id}`),s.similaritySearch(t,r,{original_document_id:{$eq:e.id}})))),u=(await Promise.all(c)).flat();this.logger.log(`Found ${u.length} matches in dataset ${e} - before deduplication`),this.logger.log(`Combined results: ${JSON.stringify(u)}`);const f=u.filter(((e,t,o)=>o.findIndex((t=>t.metadata.id===e.metadata.id))===t));return this.logger.log(`Found ${f.length} total matches across ${a.length} documents in dataset ${e}`),u}catch(t){throw this.logger.error(`Failed to search dataset ${e}`),this.logger.error(`Error details: ${t.message}`),t.stack&&this.logger.error(`Stack trace: ${t.stack}`),t}}};t.DatasetRetrievalService=u,t.DatasetRetrievalService=u=r=n([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigService,c.DatasetService])],u)},2251:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetController=void 0;const i=o(3563),a=o(9556),c=o(6982),l=o(8077),d=o(6696);let u=class{constructor(e,t){this.datasetService=e,this.datasetRetrievalService=t}async getAllDatasets(){return this.datasetService.getAllDatasets()}async getDataset(e){return this.datasetService.getDatasetById(e)}async createDataset(e){if(!e.name.match(/^[a-zA-Z0-9]{3,30}$/))throw new Error("Dataset name must be 3-30 alphanumeric characters with no spaces");return this.datasetService.createDataset(e.name,e.baseDir)}async updateDataset(e,t){await this.datasetService.updateDataset(e,t)}async deleteDataset(e){await this.datasetService.deleteDataset(e)}async getDocuments(e){return this.datasetService.getDocuments(e)}async getDocument(e){return this.datasetService.getDocumentById(e)}async createDocument(e,t){const o=(0,c.createHash)("md5").update(t.buffer).digest("hex");return this.datasetService.createDocument(e,t.originalname,o,t.buffer)}async updateDocumentStatus(e,t){await this.datasetService.updateDocumentStatus(e,t.status)}async deleteDocument(e){await this.datasetService.deleteDocument(e)}async queryDataset(e,t,o){const r=await this.datasetService.getDatasetById(e);return this.datasetRetrievalService.searchDataset(r.name,t,o?parseInt(o,10):void 0)}};t.DatasetController=u,r([(0,i.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],u.prototype,"getAllDatasets",null),r([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"getDataset",null),r([(0,i.Post)(),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],u.prototype,"createDataset",null),r([(0,i.Put)(":id"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],u.prototype,"updateDataset",null),r([(0,i.Delete)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"deleteDataset",null),r([(0,i.Get)(":datasetId/documents"),s(0,(0,i.Param)("datasetId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"getDocuments",null),r([(0,i.Get)(":datasetId/documents/:id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"getDocument",null),r([(0,i.Post)(":datasetId/documents"),(0,i.UseInterceptors)((0,a.FileInterceptor)("file")),s(0,(0,i.Param)("datasetId")),s(1,(0,i.UploadedFile)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],u.prototype,"createDocument",null),r([(0,i.Put)(":datasetId/documents/:id/status"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],u.prototype,"updateDocumentStatus",null),r([(0,i.Delete)(":datasetId/documents/:id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],u.prototype,"deleteDocument",null),r([(0,i.Get)(":id/query"),s(0,(0,i.Param)("id")),s(1,(0,i.Query)("q")),s(2,(0,i.Query)("numResults")),n("design:type",Function),n("design:paramtypes",[String,String,String]),n("design:returntype",Promise)],u.prototype,"queryDataset",null),t.DatasetController=u=r([(0,i.Controller)("datasets"),n("design:paramtypes",[l.DatasetService,d.DatasetRetrievalService])],u)},4623:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Dataset=void 0;const r=o(9100);t.Dataset=class{constructor(e,t,o=(0,r.ulid)(),n=new Date){this.id=o,this.name=e,this.baseDir=t,this.createdAt=n}}},6552:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetModule=void 0;const n=o(3563),s=o(376),i=o(2251),a=o(8077),c=o(7184),l=o(6932),d=o(8460),u=o(6696),f=o(7967);let p=class{};t.DatasetModule=p,t.DatasetModule=p=r([(0,n.Module)({imports:[s.DataSourceModule,f.ConfigModule],controllers:[i.DatasetController],providers:[a.DatasetService,c.DatasetRepository,l.DatasetDocumentRepository,d.DatasetIndexingService,u.DatasetRetrievalService],exports:[a.DatasetService,u.DatasetRetrievalService]})],p)},7184:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetRepository=void 0;const i=o(3563);o(1832);let a=class{constructor(e){this.knex=e}async findAll(){return this.knex("datasets").select("*")}async findById(e){return this.knex("datasets").where("id",e).first()}async create(e){await this.knex("datasets").insert(e)}async update(e,t){await this.knex("datasets").where("id",e).update(t)}async delete(e){await this.knex("datasets").where("id",e).delete()}};t.DatasetRepository=a,t.DatasetRepository=a=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},8077:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetService=void 0;const i=o(3563),a=o(9896),c=o(6928),l=o(4623),d=o(1747),u=o(7184),f=o(6932),p=o(8460),h=o(8884),m=o(857);let g=r=class{constructor(e,t,o){this.datasetRepository=e,this.documentRepository=t,this.indexingService=o,this.logger=new i.Logger(r.name)}async getAllDatasets(){return this.datasetRepository.findAll()}async getDatasetById(e){return this.datasetRepository.findById(e)}async createDataset(e,t){const o=(0,h.getEnv)("DATASETS_BASE_DIR",c.join(m.homedir(),".hldk","datasets")),r=t||c.join(o,e);await a.promises.mkdir(r,{recursive:!0});const n=new l.Dataset(e,r);return await this.datasetRepository.create(n),n}async updateDataset(e,t){await this.datasetRepository.update(e,t)}async deleteDataset(e){const t=await this.documentRepository.findAll(e);for(const e of t)await this.deleteDocument(e.id);await this.datasetRepository.delete(e)}async getDocuments(e){return this.documentRepository.findAll(e)}async getDocumentById(e){return this.documentRepository.findById(e)}async createDocument(e,t,o,r){const n=await this.getDatasetById(e);if(!n)throw new Error("Dataset not found");const s=new d.DatasetDocument(e,t,o);await this.documentRepository.create(s);const i=c.join(n.baseDir,t);return await a.promises.mkdir(c.dirname(i),{recursive:!0}),await a.promises.writeFile(i,r),this.indexingService.indexDocument(s.id,e,i).catch((e=>{this.logger.error(`Failed to index document ${s.id}: ${e.message}`,e.stack)})),s}async updateDocumentStatus(e,t){await this.documentRepository.updateStatus(e,t)}async deleteDocument(e){const t=await this.documentRepository.findById(e);if(!t)throw new Error("Document not found");const o=await this.getDatasetById(t.datasetId);if(!o)throw new Error("Dataset not found");try{await this.indexingService.removeDocumentFromIndex(e,o.name)}catch(t){this.logger.error(`Error removing document ${e} from index:`,t)}const r=c.join(o.baseDir,t.filename);try{await a.promises.unlink(r)}catch(e){this.logger.error(`Error deleting file ${r}:`,e)}await this.documentRepository.delete(e)}};t.DatasetService=g,t.DatasetService=g=r=n([(0,i.Injectable)(),s("design:paramtypes",[u.DatasetRepository,f.DatasetDocumentRepository,p.DatasetIndexingService])],g)},4361:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DesignsModule=void 0;const n=o(3563),s=o(8437),i=o(5873);let a=class{};t.DesignsModule=a,t.DesignsModule=a=r([(0,n.Module)({imports:[i.WorkspaceModule],providers:[s.DesignsService],exports:[s.DesignsService]})],a)},8437:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DesignsService=void 0;const s=o(3563),i=o(8474),a=o(9100),c=o(9896),l=o(6928);let d=class{constructor(e){this.workspaceService=e}async addNewDesign(e,t){const o=(await this.workspaceService.lockSessionWorkspace(t)).repoBaseDir,r=(0,a.ulid)(),n=l.join(o,".hldk","designs",`${r}.json`),s=l.dirname(n);c.existsSync(s)||c.mkdirSync(s,{recursive:!0}),c.writeFileSync(n,JSON.stringify(e,null,2))}};t.DesignsService=d,t.DesignsService=d=r([(0,s.Injectable)(),n("design:paramtypes",[i.WorkspaceService])],d)},8144:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDocController=void 0;const i=o(3563),a=o(3381),c=o(7823);let l=class{constructor(e){this.storedDocService=e}async storeDoc(e,t,o){const r=await this.storedDocService.storeDoc(e,t,o);return c.StoredDocDTO.fromStoredDoc(r)}async getDoc(e){return this.storedDocService.getDoc(e)}async getDocContent(e,t){const o=await this.storedDocService.getDoc(e);if(!o)throw new Error(`Document not found with id: ${e}`);t.setHeader("Content-Type",o.mimeType),t.send(o.contents)}async getDocsBySession(e){return(await this.storedDocService.getDocsBySession(e)).map((e=>c.StoredDocDTO.fromStoredDoc(e)))}async getDocsByWorkspace(e){return(await this.storedDocService.getDocsByWorkspace(e)).map((e=>c.StoredDocDTO.fromStoredDoc(e)))}};t.StoredDocController=l,r([(0,i.Post)(),s(0,(0,i.Body)("contents")),s(1,(0,i.Query)("sessionId")),s(2,(0,i.Query)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String,String,String]),n("design:returntype",Promise)],l.prototype,"storeDoc",null),r([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getDoc",null),r([(0,i.Get)(":id/contents"),s(0,(0,i.Param)("id")),s(1,(0,i.Res)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],l.prototype,"getDocContent",null),r([(0,i.Get)("session/:sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getDocsBySession",null),r([(0,i.Get)("workspace/:workspaceName"),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getDocsByWorkspace",null),t.StoredDocController=l=r([(0,i.Controller)("stored-docs"),n("design:paramtypes",[a.StoredDocService])],l)},7823:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDocDTO=void 0;class o{constructor(e,t,o,r,n){this.id=e,this.mimeType=t,this.createdAt=o,this.sessionId=r,this.workspaceName=n}static fromStoredDoc(e){return new o(e.id,e.mimeType,e.createdAt,e.sessionId,e.workspaceName)}}t.StoredDocDTO=o},3543:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDoc=void 0;const r=o(9100);t.StoredDoc=class{constructor(e,t,o,n,s=(0,r.ulid)(),i=new Date){if(this.id=s,this.contents=e,this.sessionId=o,this.workspaceName=n,this.createdAt=i,t)this.mimeType=t;else try{JSON.parse(e),this.mimeType="application/json"}catch{e.trim().startsWith("<")&&e.trim().endsWith(">")?this.mimeType="text/html":this.mimeType="text/plain"}}}},1680:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.DocstoreModule=void 0;const n=o(3563),s=o(8144),i=o(3381),a=o(8648),c=o(376);let l=class{};t.DocstoreModule=l,t.DocstoreModule=l=r([(0,n.Module)({imports:[c.DataSourceModule],controllers:[s.StoredDocController],providers:[i.StoredDocService,a.StoredDocRepository],exports:[i.StoredDocService]})],l)},8648:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDocRepository=void 0;const i=o(3563),a=(o(1832),o(3543)),c=o(7823);let l=class{constructor(e){this.knex=e,this.columns={all:["id","contents","mimeType","createdAt","sessionId","workspaceName"],withoutContents:["id","mimeType","createdAt","sessionId","workspaceName"]}}async save(e){await this.knex("stored_docs").insert({id:e.id,contents:e.contents,mimeType:e.mimeType,createdAt:e.createdAt,sessionId:e.sessionId,workspaceName:e.workspaceName})}async findById(e){const t=await this.knex("stored_docs").select(this.columns.all).where("id",e).first();return t?new a.StoredDoc(t.contents,t.mimeType,t.sessionId,t.workspaceName,t.id,t.createdAt):null}async findByIdWithoutContents(e){const t=await this.knex("stored_docs").select(this.columns.withoutContents).where("id",e).first();return t?c.StoredDocDTO.fromStoredDoc(t):null}async findBySessionId(e){return(await this.knex("stored_docs").select(this.columns.withoutContents).where("sessionId",e)).map((e=>c.StoredDocDTO.fromStoredDoc(e)))}async findByWorkspaceName(e){return(await this.knex("stored_docs").select(this.columns.withoutContents).where("workspaceName",e)).map((e=>c.StoredDocDTO.fromStoredDoc(e)))}};t.StoredDocRepository=l,t.StoredDocRepository=l=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],l)},3381:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredDocService=void 0;const s=o(3563),i=o(3543),a=o(8648),c=o(1943),l=o(857),d=o(6928),u=o(3903),f=o(9055);let p=class{constructor(e){this.storedDocRepository=e}async storeDoc(e,t,o,r){const n=new i.StoredDoc(e,t,o,r);return await this.storedDocRepository.save(n),f.default.info(`Stored new document with ID: ${n.id}, sessionId: ${o||"none"}, workspaceName: ${r||"none"}`),n}async getDoc(e){const t=await this.storedDocRepository.findById(e);return t?f.default.info(`Retrieved document with ID: ${e}`):f.default.info(`Document not found with ID: ${e}`),t}async getDocMetadata(e){return this.storedDocRepository.findByIdWithoutContents(e)}async getDocsBySession(e){const t=await this.storedDocRepository.findBySessionId(e);return f.default.info(`Retrieved ${t.length} documents for session: ${e}`),t}async getDocsByWorkspace(e){const t=await this.storedDocRepository.findByWorkspaceName(e);return f.default.info(`Retrieved ${t.length} documents for workspace: ${e}`),t}async withFile(e,t){const o=await this.getDoc(e);if(!o)throw new Error(`Document not found with id: ${e}`);const r=await c.mkdtemp(d.join(l.tmpdir(),"hldk-")),n=d.join(r,`${(0,u.v4)()}`);f.default.info(`Created temporary file for document ${e}: ${n}`);try{await c.writeFile(n,o.contents);return await t(n)}finally{try{await c.unlink(n),await c.rmdir(r)}catch(e){f.default.error("Error cleaning up temporary file:",e)}}}};t.StoredDocService=p,t.StoredDocService=p=r([(0,s.Injectable)(),n("design:paramtypes",[a.StoredDocRepository])],p)},5056:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileController=void 0;const i=o(3563),a=o(9556),c=o(7205);let l=class{constructor(e){this.storedFileService=e}async uploadFile(e,t,o){return this.storedFileService.uploadFile(e,t,o)}async getFileContent(e,t){const o=await this.storedFileService.getFile(e);o?(t.setHeader("Content-Type",o.mimeType),t.setHeader("Content-Disposition",`attachment; filename="${o.originalFilename}"`),t.send(o.fileContents)):t.status(404).send("File not found")}async getFile(e){return this.storedFileService.getFileMetadata(e)}async getAllFiles(){return this.storedFileService.getAllFiles()}async deleteFile(e){await this.storedFileService.deleteFile(e)}async getFilesBySessionId(e){return this.storedFileService.getFilesBySessionId(e)}async getFilesByWorkspaceName(e){return this.storedFileService.getFilesByWorkspaceName(e)}};t.StoredFileController=l,r([(0,i.Post)("upload"),(0,i.UseInterceptors)((0,a.FileInterceptor)("file")),s(0,(0,i.UploadedFile)()),s(1,(0,i.Query)("sessionId")),s(2,(0,i.Query)("workspaceName")),n("design:type",Function),n("design:paramtypes",[Object,String,String]),n("design:returntype",Promise)],l.prototype,"uploadFile",null),r([(0,i.Get)(":id/content"),s(0,(0,i.Param)("id")),s(1,(0,i.Res)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],l.prototype,"getFileContent",null),r([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getFile",null),r([(0,i.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],l.prototype,"getAllFiles",null),r([(0,i.Delete)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"deleteFile",null),r([(0,i.Get)("session/:sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getFilesBySessionId",null),r([(0,i.Get)("workspace/:workspaceName"),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getFilesByWorkspaceName",null),t.StoredFileController=l=r([(0,i.Controller)("stored-files"),n("design:paramtypes",[c.StoredFileService])],l)},5775:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileDto=void 0;class o{constructor(e){this.id=e.id,this.originalFilename=e.originalFilename,this.mimeType=e.mimeType,this.createdAt=e.createdAt,this.sessionId=e.sessionId,this.workspaceName=e.workspaceName}static fromStoredFile(e){return new o({id:e.id,originalFilename:e.originalFilename,mimeType:e.mimeType,createdAt:e.createdAt,sessionId:e.sessionId,workspaceName:e.workspaceName})}}t.StoredFileDto=o},7607:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFile=void 0;const r=o(9100);t.StoredFile=class{constructor(e,t,o,n,s,i=(0,r.ulid)(),a=new Date){this.id=i,this.originalFilename=e,this.fileContents=t,this.mimeType=o,this.sessionId=n,this.workspaceName=s,this.createdAt=a}}},8624:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileModule=void 0;const n=o(3563),s=o(5056),i=o(7205),a=o(4632),c=o(376);let l=class{};t.StoredFileModule=l,t.StoredFileModule=l=r([(0,n.Module)({imports:[c.DataSourceModule],controllers:[s.StoredFileController],providers:[i.StoredFileService,a.StoredFileRepository],exports:[i.StoredFileService]})],l)},4632:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileRepository=void 0;const i=o(3563),a=(o(1832),o(5775));let c=class{constructor(e){this.knex=e,this.columns={all:["id","fileContents","originalFilename","mimeType","createdAt","sessionId","workspaceName"],withoutContent:["id","originalFilename","mimeType","createdAt","sessionId","workspaceName"]}}async findAll(){return(await this.knex("stored_files").select(this.columns.withoutContent)).map((e=>a.StoredFileDto.fromStoredFile(e)))}async findById(e){const t=await this.knex("stored_files").select(this.columns.all).where("id",e).first();return t||null}async findByIdWithoutContent(e){const t=await this.knex("stored_files").select(this.columns.withoutContent).where("id",e).first();return t?a.StoredFileDto.fromStoredFile(t):null}async create(e){await this.knex("stored_files").insert(e)}async delete(e){await this.knex("stored_files").where("id",e).delete()}async findBySessionId(e){return(await this.knex("stored_files").select(this.columns.withoutContent).where("sessionId",e)).map((e=>a.StoredFileDto.fromStoredFile(e)))}async findByWorkspaceName(e){return(await this.knex("stored_files").select(this.columns.withoutContent).where("workspaceName",e)).map((e=>a.StoredFileDto.fromStoredFile(e)))}};t.StoredFileRepository=c,t.StoredFileRepository=c=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],c)},7205:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.StoredFileService=void 0;const s=o(3563),i=o(7607),a=o(5775),c=o(4632),l=o(904),d=o(8817),u=o(9055);let f=class{constructor(e){this.storedFileRepository=e}async uploadFile(e,t,o){let r=l.lookup(e.originalname);if(!r){const t=await d.default.fromBuffer(e.buffer);r=t?t.mime:"application/octet-stream"}const n=new i.StoredFile(e.originalname,e.buffer,r,t,o);return await this.storedFileRepository.create(n),u.default.info(`File uploaded: ${e.originalname} (${r}) for session: ${t||"none"}, workspace: ${o||"none"}`),a.StoredFileDto.fromStoredFile(n)}async getFile(e){const t=await this.storedFileRepository.findById(e);return t?u.default.info(`File retrieved: ${t.originalFilename} (${e})`):u.default.info(`File not found: ${e}`),t}async getFileMetadata(e){const t=await this.storedFileRepository.findByIdWithoutContent(e);return t?u.default.info(`File metadata retrieved: ${t.originalFilename} (${e})`):u.default.info(`File not found: ${e}`),t}async getAllFiles(){return this.storedFileRepository.findAll()}async deleteFile(e){const t=await this.storedFileRepository.findByIdWithoutContent(e);await this.storedFileRepository.delete(e),u.default.info(`File deleted: ${t?t.originalFilename:"unknown"} (${e})`)}async getFilesBySessionId(e){const t=await this.storedFileRepository.findBySessionId(e);return u.default.info(`Retrieved ${t.length} files for session: ${e}`),t}async getFilesByWorkspaceName(e){const t=await this.storedFileRepository.findByWorkspaceName(e);return u.default.info(`Retrieved ${t.length} files for workspace: ${e}`),t}};t.StoredFileService=f,t.StoredFileService=f=r([(0,s.Injectable)(),n("design:paramtypes",[c.StoredFileRepository])],f)},7701:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DocxFormBuilder=void 0;const s=o(3563),i=o(9100),a=o(1162),c=o(3239),l=o(3229),d=o(9055),u=o(7687);let f=class{constructor(e){this.summaryCompletion=e}canHandle(e){return"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===e.mimeType}async extractTitle(e){const t=(await(0,l.extractRawText)(e.fileContents)).substring(0,1e4);return await this.summaryCompletion.getSummary("Return a suitable Title for the following document. Just return the Title on its own with no other info:",t,a.ModelCategory.SUMMARISATION)}removeQuestionsWithAnswerInTheFormAsText(e){return e.filter((e=>e.answerInTheFormAsText?(d.default.info("Removing question with answer already in form text: %s - Answer: %s",e.text||e.shortDescription,e.answerInTheFormAsText),!1):!(e.subQuestions&&e.subQuestions.length>0&&(e.subQuestions=this.removeQuestionsWithAnswerInTheFormAsText(e.subQuestions),"composite"===e.type&&0===e.subQuestions.length))||(d.default.info("Removing composite question with no remaining subquestions: %s",e.shortDescription),!1)))}async*generateSections(e,t){const o=await(0,l.extractSectionsFromDocxBuffer)(e.fileContents,!1);d.default.info("Found %d sections in the DOCX document",o.sections.length);for(const e of o.sections){if(0===e.potentialInputs.length){d.default.info("No inputs found in section, skipping...");continue}d.default.info("Processing section with %d inputs: %s",e.potentialInputs.length,e.xpath);const o=(0,i.ulid)(),r=`\n      You are an expert form builder. The original form was a Word document in .docx format. You are being given a section of content from the form after it has been converted to HTML along with a list of potentual input fields found in that section.\n      Your job is to analyze the HTML content and potential input fields to identify and structure the questions in the form.\n\n      The potential input fields have the following properties:\n      - xpath: The XML path to the input field in the original DOCX document\n      - type: The type of input (text, textarea, checkbox) - DO NOT ASSUME THIS IS THE ACTUAL TYPE OF THE INPUT FIELD. For example some "text" inputs are actually text-areas - use your judgement based on the context of the input, where it appears and how much space is available in the input field to answer the question as well as the actual question text.\n      - id: Optional identifier\n      - label: Optional label text found near the input\n      - originalValue: Optional existing value in the input which might contain the question text also\n\n      For each potential input field, you need to:\n      1. Identify if it's a question or not (if not then you don't need to include this bit in the JSON output)\n      2. If it is a question, identify the actual question being asked\n      3. Determine if it's part of a larger composite question\n      4. Create appropriate question structures that include the input's xpath as originalInputXpath\n\n      The section id for this section is: ${o}\n\n      Return a JSON object in this format:\n{\n  "id": "${o}",\n  "title": "A descriptive title for this section",\n  "path": "${o}",\n  "questions": [\n    {\n      "path": "unique identifier for this question: ${o}/short-unique-identifier (for sub questions append short-unique-identifier to the parent path)",\n      "type": "text|text-area|number|boolean|multipleChoice|composite",\n      "number": "Optional: Populate with any numbering associated with this question (e.g. 1.2 or 4a etc). Only populate for non-composite questions",\n      "shortDescription": "Optional: Only for composite questions or questions with long text: 1 to 4 word short description for the question (e.g. 'Contact Details')",\n      "text": "The actual question text (IMPORTANT: DO NOT POPULATE FOR COMPOSITE QUESTIONS - ALSO REMEMBER TO ESCAPE SPECIAL CHARACTERS LIKE QUOTES USING THE BACKSLASH (")",\n      "options": ["option1", "option2"] (only for multipleChoice type),\n      "multipleSelection": true|false (only for multipleChoice type),\n      "subQuestions": [] (only for composite type, contains nested questions in same format and appends to the parent path),\n      "normalizedQuestionText": "A longer, self-contained version of the question that makes sense on its own without hierarchical context",\n      "additionalInfo": "Optional: Any helpful context or instructions for answering the question that appears in the form. Do not make up instructions that are not present in the form.",\n      "originalInputXpath": "The xpath of the input field this question corresponds to",\n      "answerInTheFormAsText": "Optional: If the answer is already provided in the form then populate this with the answer",\n      "appendOrReplace": "Optional: Instructions on how to update the input field with the answer (e.g. 'append' or 'replace Answer here') if the input field already contains content\n    }\n  ]\n}\n\nImportant Guidelines:\n1. The section title should be descriptive and reflect the theme of all questions in this block\n2. Each question's path should start with the section path (which is a ulid). For sub questions append the short-unique-identifier to the parent path.\n3. For composite questions (like address forms or tables), use the composite type and subQuestions\n4. If you see a boolean or text question with nested questions, use the composite type and add in the parent question as a subQuestion along with the nested questions.\n5. The number property should be populated with any numbering associated with this question (e.g. 1.2 or 4a etc). Only use numbers from the actual form.\n6. The shortDescription property is required for composite questions but should also be populated for questions with long text.\n7. The normalizedQuestionText should be self-contained and clear even without context. DO NOT POPULATE FOR COMPOSITE QUESTIONS. \n8. Include any helpful instructions or context that appears in the form in additionalInfo\n9. Don't miss any questions - capture everything that looks like it needs an answer\n10. Choose appropriate types based on the expected answer format\n11. For tables or lists that contain multiple related questions, use composite type with subQuestions. Some tables will use columns to partition questions. Sometimes the questions in the LHS of the table will have a different row structure to the questions on the RHS of the table.\n12. The number property should ONLY be populated if there is actual numbering in the form content\n13. For table layout questions make sure to construct a suitable hierarchy of questions to efficiently cover ALL of the questions without missing any\n14. IMPORTANT: DO NOT INCLUDE BLANK OR EMPTY ATTRIBUTES IN THE JSON OUTPUT - JUST LEAVE THEM OUT ENTIRELY\n15. IMPORTANT: EXAMINE THE HTML STRUCTURE LOOKING FOR NESTED STRUCTURE AND USE COMPOSITE TYPE FOR THESE QUESTIONS\n16. IMPORTANT: DO NOT MISS ANY FOLLOW ON QUESTIONS THAT RELATE TO A BOOLEAN YES/NO QUESTION (MAKE THE BOOLEAN QUESTION A SUBQUESTION AND ADD THE FOLLOW ON QUESTIONS)\n17. IMPORTANT: EVERY QUESTION MUST HAVE AN originalInputXpath THAT MATCHES ONE OF THE PROVIDED INPUT XPATHS\n18. IMPORTANT: WHEN FINISHED, GO BACK AND CHECK THAT YOU HAVE NOT MISSED ANY QUESTIONS. MAKE SURE TO CHECK ALL ROWS AND COLUMNS OF TABLES.\n19. IMPORTANT: REMEMBER TO ESCAPE SPECIAL CHARACTERS IN THE JSON LIKE QUOTES USING THE BACKSLASH (")\n\nHere are the potentialinputs found in this section:\n${JSON.stringify(e.potentialInputs,null,2)}\n\nThe HTML content of the section that needs to be analyzed follows this message.\n`;d.default.info("Analyzing section for questions with %d inputs",e.potentialInputs.length),d.default.info("HTML content of section: %s",e.convertedHtml);try{const o=await this.summaryCompletion.getSummaryJson(r,e.convertedHtml,a.ModelCategory.REASONING,!1,t),n=JSON.parse(o),s=(0,u.countNestedQuestions)(n.questions);if(d.default.info("Found %d questions in this section",s),0===s){d.default.warn("No questions found in this section, skipping...");continue}d.default.info("Question structure result: %s",JSON.stringify(n));try{const e=n.questions,t={id:n.id,title:n.title,path:n.path,questions:e};yield t}catch(e){d.default.error("Failed to process questions:",e);continue}}catch(e){d.default.error("Failed to process section:",e);continue}}}};t.DocxFormBuilder=f,t.DocxFormBuilder=f=r([(0,s.Injectable)(),n("design:paramtypes",[c.SummaryCompletion])],f)},7628:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnswerQueryRequest=void 0;t.AnswerQueryRequest=class{}},9543:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CopyFormRequest=void 0;t.CopyFormRequest=class{constructor(){this.copyAnswers=!0}}},412:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CreateFormRequest=void 0;t.CreateFormRequest=class{}},3896:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFormAnswerDto=void 0;t.UpdateFormAnswerDto=class{}},6815:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFormRequest=void 0;t.UpdateFormRequest=class{}},6941:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.DocxFormExporter=void 0;const s=o(3563),i=o(9896),a=o(857),c=o(6928),l=o(1879),d=o(9863),u=o(1115),f=o(7020),p=o(9055),h=o(9496);let m=class{constructor(e,t){this.formAnswerRepository=e,this.formSectionRepository=t}canHandle(e,t){return"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===t.mimeType}getDefaultFileName(e,t){const o=(new Date).toISOString().replace(/[-:T]/g,"").substring(0,12),r=t.originalFilename.split(".").pop(),n=`${t.originalFilename.replace(/\.[^.]+$/,"")}-exported-${o}.${r}`;return p.default.info(`Default file name for form ${e.id} is ${n}`),n}getContentType(e){return e.mimeType}async extractDocxToTemp(e,t){return new Promise(((o,r)=>{u.fromBuffer(e,{lazyEntries:!0},((e,n)=>{e?r(new Error(`Failed to open DOCX buffer: ${e.message}`)):(n.on("entry",(e=>{const o=c.join(t,e.fileName);i.mkdirSync(c.dirname(o),{recursive:!0}),n.openReadStream(e,((t,s)=>{if(t)return void r(new Error(`Failed to read entry ${e.fileName}: ${t.message}`));const a=i.createWriteStream(o);s.pipe(a),a.on("finish",(()=>n.readEntry()))}))})),n.on("end",o),n.on("error",r),n.readEntry())}))}))}buildQuestionMap(e){const t=new Map,o=e=>{t.set(e.path,e),e.subQuestions&&e.subQuestions.forEach((e=>o(e)))};return e.forEach(o),p.default.info(`Built question map with ${t.size} questions`),t}async updateDocumentXml(e,t,o){p.default.info("Updating document.xml with answers");const r=await i.promises.readFile(e,"utf8");p.default.debug(`XML content: ${r}`);const n=(new l.DOMParser).parseFromString(r,"application/xml"),s={w:"http://schemas.openxmlformats.org/wordprocessingml/2006/main",w14:"http://schemas.microsoft.com/office/word/2010/wordml"},a={lookupNamespaceURI:e=>s[e]||null},c=(e,t)=>(p.default.info(`Selecting nodes with expression: ${e} and context node: ${t.nodeName}`),d.selectWithResolver(e,t,a)),u=e=>{p.default.info(`Node: ${e.nodeName} - ${e.textContent}`)};for(const[e,r]of t.entries())try{const t=o.get(e);if(!t){p.default.warn(`No question found for question path: ${e} - for answer: ${JSON.stringify(r)}`);continue}const s=t.originalInputXpath;p.default.info(`Processing answer for xpath: ${s} - value: ${r.value} - for question: ${t.normalizedQuestionText}`);const i=c(s,n);if(i.length>1&&p.default.warn(`Found ${i.length} nodes for xpath: ${s} - for question: ${t.normalizedQuestionText}`),i.length>0){const e=i[0];switch(u(e),e.nodeName){case"w:r":this.handleRunNode(e,t,r,n,c);break;case"w:p":this.handleParagraphNode(e,t,r,n,c);break;case"w:t":this.handleTextNode(e,t,r,n,c);break;case"w:tc":this.handleTableCellNode(e,t,r,n,c);break;default:p.default.warn(`Unsupported node type: ${e.nodeName} for xpath: ${s}`)}}else p.default.warn(`No nodes found for xpath: ${s}`)}catch(t){p.default.error(`Error processing question path ${e}: ${t.message}`)}const f=(new l.XMLSerializer).serializeToString(n);await i.promises.writeFile(e,f)}async createNewDocx(e){return new Promise(((t,o)=>{const r=new f.ZipFile,n=async(e,t="")=>{const o=await i.promises.readdir(e,{withFileTypes:!0});for(const s of o){const o=c.join(e,s.name),i=c.join(t,s.name);s.isDirectory()?await n(o,i):r.addFile(o,i)}};n(e).then((()=>{const e=[];r.outputStream.on("data",(t=>e.push(t))),r.outputStream.on("end",(()=>t(Buffer.concat(e)))),r.outputStream.on("error",o),r.end()})).catch(o)}))}transformAnswerValue(e,t){return"boolean"===e.type&&"1"===t.value?"Yes":"boolean"===e.type&&"0"===t.value?"No":t.value}handleRunNode(e,t,o,r,n){const s=n(".//w:t",e);let i=null;for(const e of s){if(""!==(e.textContent||"").trim()){i=null;break}i=e}if(i)i.textContent=(i.textContent||"")+o.value,p.default.info(`Appended answer into existing empty text node: "${o.value}"`);else{const t=r.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main","w:t");t.textContent=o.value,e.appendChild(t),p.default.info(`Inserted new <w:t> element with value "${o.value}"`)}}handleParagraphNode(e,t,o,r,n){const s="http://schemas.openxmlformats.org/wordprocessingml/2006/main",i=n(".//w:t",e);let a=null;for(const e of i){if(""!==(e.textContent||"").trim()){a=null;break}a=e}if(a){const e=this.transformAnswerValue(t,o);a.textContent=(a.textContent||"")+e,p.default.info(`Appended answer into existing empty text node in paragraph: "${e}"`)}else{const n=r.createElementNS(s,"w:t"),i=this.transformAnswerValue(t,o);n.textContent=i;const a=r.createElementNS(s,"w:r");a.appendChild(n),e.appendChild(a),p.default.info(`Inserted new run with text "${o.value}"`)}}handleTextNode(e,t,o,r,n){const s=e.textContent||"";if(""===s.trim()){const r=this.transformAnswerValue(t,o);e.textContent=s+r,p.default.info(`Appended answer into existing empty text node: "${r}"`)}else{const n=e.parentNode;if(n){const e="http://schemas.openxmlformats.org/wordprocessingml/2006/main",s=r.createElementNS(e,"w:t"),i=this.transformAnswerValue(t,o);s.textContent=i,n.appendChild(s),p.default.info(`Inserted new <w:t> element with value "${o.value}"`)}else p.default.warn("Cannot append new text node as parent node is null")}}handleTableCellNode(e,t,o,r,n){const s="http://schemas.openxmlformats.org/wordprocessingml/2006/main",i=n(".//w:t",e);let a=null;for(const e of i){if(""!==(e.textContent||"").trim()){a=null;break}a=e}if(a){const e=this.transformAnswerValue(t,o);a.textContent=(a.textContent||"")+e,p.default.info(`Appended answer into existing empty text node in table cell: "${e}"`)}else{const n=r.createElementNS(s,"w:p"),i=r.createElementNS(s,"w:r"),a=r.createElementNS(s,"w:t"),c=this.transformAnswerValue(t,o);a.textContent=c,i.appendChild(a),n.appendChild(i),e.appendChild(n),p.default.info(`Appended new paragraph with text "${o.value}" to table cell`)}}async export(e,t){p.default.info(`Exporting form ${e.id} to DOCX`);const o=await this.formSectionRepository.findByFormId(e.id);p.default.info(`Found ${o.length} sections for form ${e.id}`);const r=new Map;for(const e of o){const t=e.getQuestions(),o=this.buildQuestionMap(t);for(const[e,t]of o.entries())r.set(e,t)}p.default.info(`Built question map with ${r.size} questions`);const n=await this.formAnswerRepository.findByFormId(e.id);p.default.info(`Found ${n.length} answers for form ${e.id}`);const s=new Map;for(const e of n)s.set(e.questionPath,e);p.default.info(`Found ${s.size} answers for form ${e.id}`);const l=await i.promises.mkdtemp(c.join(a.tmpdir(),"docx-export-"));try{const e=t.fileContents;p.default.info("Extracting DOCX to temp directory"),await this.extractDocxToTemp(e,l);const o=c.join(l,"word/document.xml");await this.updateDocumentXml(o,s,r),p.default.info("Creating new DOCX file");const n=await this.createNewDocx(l);return p.default.info("New DOCX file created"),n}finally{await i.promises.rm(l,{recursive:!0,force:!0})}}};t.DocxFormExporter=m,t.DocxFormExporter=m=r([(0,s.Injectable)(),n("design:paramtypes",[h.FormAnswerRepository,h.FormSectionRepository])],m)},4391:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.FormAnswersService=void 0;const i=o(3563),a=o(6696),c=o(3239),l=o(1162),d=o(9496),u=o(2368),f=o(6910);let p=r=class{generateRagQueryPrompt(e){const t=e.partialAnswer&&e.partialAnswer.trim().length>2,o=e.relatedAnswers.some((e=>e.answerInTheFormAsText));let r="";if(t||o){if(t&&!o)r=`Example response for a question about "${e.targetQuestion.normalizedQuestionText}" with partial answer "${e.partialAnswer}":\n[\n  {"query": "detailed information about ${e.targetQuestion.normalizedQuestionText}"},\n  {"query": "specific details supporting ${e.partialAnswer}"}\n]`;else if(t&&o){const t=e.relatedAnswers[0].answerInTheFormAsText;r=`Example response for a question about "${e.targetQuestion.normalizedQuestionText}" with partial answer "${e.partialAnswer}" and related answer "${t}":\n[\n  {"query": "detailed information about ${e.targetQuestion.normalizedQuestionText}"},\n  {"query": "specific details supporting ${e.partialAnswer}"},\n  {"query": "information connecting ${e.partialAnswer} with the related answers in the context"}\n]`}}else r=`Example response for a question about "${e.targetQuestion.normalizedQuestionText}":\n[\n  {"query": "detailed information about ${e.targetQuestion.normalizedQuestionText}"}\n]`;return`You are an AI assistant helping to generate RAG (Retrieval Augmented Generation) queries for answering form questions.\n\nGiven the context about a form question, generate search queries that will help find the most relevant information to answer the question.\n\nThe context object contains:\n- sectionTitle: The title of the form section containing the question\n- targetQuestion: The details of the question that needs to be answered\n${t?"- partialAnswer: The user's partial answer that needs to be expanded\n":""}${o?"- relatedAnswers: Other answers in the form that are related to this question\n":""}\n\nYou should generate queries based on the following rules:\n1. ALWAYS generate a main query focused on the normalized question text\n${t?"2. Generate a second query to find supporting or related information for the partial answer\n":""}${o?`${t?"3":"2"}. Generate a ${t?"third":"second"} query to find information that connects or relates to the existing answers\n`:""}\n\nKeep all queries concise and focused on retrieving relevant information.\n\nResponse format: Return a JSON array of query objects, each with just a "query" string.\n\n${r}\n`}constructor(e,t,o,n,s){this.datasetRetrievalService=e,this.summaryCompletion=t,this.formSectionRepository=o,this.formAnswerRepository=n,this.configService=s,this.logger=new i.Logger(r.name)}flattenQuestions(e,t=[]){for(const o of e)t.push(o),o.subQuestions&&o.subQuestions.length>0&&this.flattenQuestions(o.subQuestions,t);return t}findRelatedAnswers(e,t){const o=t.path.split("/").slice(0,-1).join("/");return e.filter((e=>e.questionPath.startsWith(o)&&e.answerInTheFormAsText))}async fetchAnswersFromDB(e,t,o){const r=await this.formAnswerRepository.findByFormId(e,t);return this.logger.log(`Found ${r.length} answers for section ${t}`),o.map((e=>({questionPath:e.path,normalizedQuestionText:e.normalizedQuestionText,answerInTheFormAsText:r.find((t=>t.questionPath===e.path))?.value})))}async executeRagQueries(e,t){const o=[],n=t.map((async({query:t})=>{const n=await this.datasetRetrievalService.searchDataset(e,t,r.RESULTS_PER_QUERY,r.RESULTS_PER_QUERY);o.push(...n)}));await Promise.all(n);return o.filter(((e,t,o)=>o.findIndex((t=>t.metadata.id===e.metadata.id))===t))}async queryAnswer(e){this.logger.log(`Querying answer for form ${e.formId}, question ${e.questionPath}, specific model ${e.modelName}`);const t=e.questionPath.split("/")[0],o=await this.formSectionRepository.findById(t);if(!o)throw new Error(`Section not found with id ${t}`);const n=e.partialAnswerText&&e.partialAnswerText.trim().length>2,s=(n?r.PARTIAL_ANSWER_PROMPT:r.BASE_PROMPT,JSON.parse(o.json));this.logger.log(`Found ${s.length} questions in section ${t}`),this.logger.log(`Questions: ${JSON.stringify(s)}`);const i=this.flattenQuestions(s),a=i.find((t=>t.path===e.questionPath));if(!a)throw new Error(`Question not found with path ${e.questionPath}`);this.logger.log(`Partial answer provided: ${e.partialAnswerText}`),await this.formAnswerRepository.upsertAnswer(e.formId,{questionPath:e.questionPath,normalizedQuestionText:a.normalizedQuestionText,value:e.partialAnswerText||""});const c=await this.fetchAnswersFromDB(e.formId,t,i),d=this.findRelatedAnswers(c,a);this.logger.log(`Related answers: ${JSON.stringify(d)}`);const u=e.modelName||this.configService.getProperty(f.ConfigPropNames.DEFAULT_RAG_QUERY_MODEL);this.logger.log(`Using RAG query model: ${u}`);const p={sectionTitle:o.title,targetQuestion:a,partialAnswer:e.partialAnswerText,relatedAnswers:d.filter((e=>e.answerInTheFormAsText))},h=JSON.stringify(p);this.logger.log(`RAG query context: ${h}`);const m=this.generateRagQueryPrompt(p),g=await this.summaryCompletion.getSummaryJson(m,h,l.ModelCategory.RAG_QUERY,!1,e.modelName);let y=JSON.parse(g);if(!Array.isArray(y)){const e=Object.values(y).find(Array.isArray);e?y=e:(this.logger.warn("LLM response was not an array and no array property found in object"),y=[])}const w=y;this.logger.log(`Generated RAG queries: ${JSON.stringify(w)}`);const S=await this.executeRagQueries(e.datasetName,w);this.logger.log(`RAG query results: ${JSON.stringify(S)}`);const v=d.length>0?`YOUR ANSWER MUST BE CONSISTENT WITH THE FOLLOWING ANSWERS THAT HAVE ALREADY BEEN PROVIDED BY THE USER:\n${d.filter((e=>e.answerInTheFormAsText)).map((e=>`${e.normalizedQuestionText} --\x3e ${e.answerInTheFormAsText}`)).join("\n")}`:"",_=i.filter((e=>e.path!==a.path)).map((e=>e.path)).join("\n"),R=(n?r.PARTIAL_ANSWER_PROMPT:r.BASE_PROMPT).replace("{RELATED_ANSWERS}",v).replace("{OTHER_QUESTION_PATHS_IN_THIS_SECTION}",_),b={sectionTitle:o.title,targetQuestion:a,partialAnswer:e.partialAnswerText,ragQueries:w,ragQueryResults:S},A=JSON.stringify(b),O=await this.summaryCompletion.getSummaryJson(R,A,l.ModelCategory.RAG_QUERY,!1,e.modelName),E=JSON.parse(O);return{formId:e.formId,normalizedQuestionText:a.normalizedQuestionText,questionPath:e.questionPath,answerText:E.answerText,confidence:E.confidence,references:E.references,ragQueries:w,ragQueryResults:S,modelUsed:u}}};t.FormAnswersService=p,p.RESULTS_PER_QUERY=2,p.RAG_QUERY_PROMPT_LEGACY="You are an AI assistant helping to generate RAG (Retrieval Augmented Generation) queries for answering form questions.",p.BASE_PROMPT='You are an AI assistant helping to answer form questions based on provided context.\n\nThe context object contains:\n- sectionTitle: The title of the form section containing the question\n- targetQuestion: The details of the question that needs to be answered - includes the question path, normalized question text and any additional info as well as type info: text, text-area, number, boolean, multipleChoice\n- ragQueries: The RAG queries that were used to retrieve the context\n- ragQueryResults: Relevant context retrieved for the question\n\n{RELATED_ANSWERS}\n\nHere are the list of other question paths in this section - these will all get answered in a different query - so your answer should not overlap with these:\n{OTHER_QUESTION_PATHS_IN_THIS_SECTION}\n\nPlease provide a focused answer that:\n1. Uses the provided context effectively, prioritizing the most relevant information from the RAG results\n2. Doesn\'t overlap with other questions in the section as they will be answered in a different query\n3. Is the minimum amount of text needed to answer the question as it will be directly entered into the form\n\nQuestion type:\n- If the type is text then a short precise answer is best\n- If the type is text-area then a longer answer is appropriate\n- If the type is number then the answer should be a number\n- If the type is boolean then the answer should be a boolean\n- If the type is multipleChoice then the answer should be one of the provided choices\n\nResponse format: {"answerText": "your answer", "confidence": 0.X, "references": [{ "type": "rag", "text": "reference text", "source": "where the reference text came from" }, { "type": "form", "text": "reference text", "source": "question path" }]}\n\nFor the source field use the metadata/source field from the RAG query results or the question path for form answers\n\nDO NOT REPEAT THE QUESTION OR CONTEXT IN YOUR ANSWER TEXT.\nIMPORTANT: if there are related answers provided then your answer MUST BE CONSISTENT WITH THEM!!\n',p.PARTIAL_ANSWER_PROMPT='You are an AI assistant helping to complete a partially answered form question based on provided context.\n\nThe context object contains:\n- sectionTitle: The title of the form section containing the question\n- targetQuestion: The details of the question that needs to be answered - includes the question path, normalized question text and any additional info as well as type info: text, text-area, number, boolean, multipleChoice\n- partialAnswer: The user\'s partial answer that needs to be built upon\n- ragQueries: The RAG queries that were used to retrieve the context\n- ragQueryResults: Relevant context retrieved for the question\n\n{RELATED_ANSWERS}\n\nHere are the list of other question paths in this section - these will all get answered in a different query - so your answer should not overlap with these:\n{OTHER_QUESTION_PATHS_IN_THIS_SECTION}\n\nPlease provide a complete answer that:\n1. Builds upon and incorporates the user\'s partial answer\n2. Maintains the user\'s original intent and perspective\n3. Uses the provided context effectively, with special emphasis on the partial answer RAG results\n4. Adds any missing important information to make the answer complete\n5. Doesn\'t overlap with other questions in the section\n6. Is the minimum amount of text needed while ensuring completeness\n\nQuestion type:\n- If the type is text then a short precise answer is best\n- If the type is text-area then a longer answer is appropriate\n- If the type is number then the answer should be a number\n- If the type is boolean then the answer should be a boolean\n- If the type is multipleChoice then the answer should be one of the provided choices\n\nResponse format: {"answerText": "your answer", "confidence": 0.X, "references": [{ "type": "rag", "text": "reference text", "source": "where the reference text came from" }, { "type": "form", "text": "reference text", "source": "question path" }]}\n\nFor the source field use the metadata/source field from the RAG query results or the question path for form answers\n\nDO NOT REPEAT THE QUESTION OR CONTEXT IN YOUR ANSWER TEXT.\nIMPORTANT: if there are related answers provided then your answer MUST BE CONSISTENT WITH THEM!!\n',t.FormAnswersService=p=r=n([(0,i.Injectable)(),s("design:paramtypes",[a.DatasetRetrievalService,c.SummaryCompletion,d.FormSectionRepository,d.FormAnswerRepository,u.ConfigService])],p)},1472:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormController=void 0;const i=o(3563),a=o(1909),c=o(412),l=o(9543),d=o(6815),u=o(3896),f=o(7628),p=o(4391),h=o(9055);let m=class{constructor(e,t){this.formService=e,this.formAnswersService=t}async buildForm(e){try{return await this.formService.buildNewForm(e.fileId,e.sessionId,e.model)}catch(e){throw h.default.error(`Error building form: ${e.message}\n${e.stack}`),new i.InternalServerErrorException("Failed to build form")}}async getForms(){try{return await this.formService.getFormList()}catch(e){throw h.default.error(`Error getting forms list: ${e.message}\n${e.stack}`),new i.InternalServerErrorException("Failed to retrieve forms list")}}async getForm(e){try{const t=await this.formService.getFormWithSections(e);if(!t)throw new i.NotFoundException(`Form with ID ${e} not found`);return t}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error getting form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to retrieve form")}}async getFormSection(e,t){try{const o=await this.formService.getFormSection(e,t);if(!o)throw new i.NotFoundException(`Section with ID ${t} not found in form ${e}`);return o}catch(o){if(o instanceof i.NotFoundException)throw o;throw h.default.error(`Error getting form section ${t} for form ${e}: ${o.message}\n${o.stack}`),new i.InternalServerErrorException("Failed to retrieve form section")}}async updateForm(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.updateFormTitle(e,t.title),{message:"Form updated successfully"}}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error updating form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to update form")}}async deleteForm(e){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.deleteForm(e),{message:"Form deleted successfully"}}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error deleting form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to delete form")}}async updateFormAnswer(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.updateAnswer(e,t),{message:"Answer updated successfully"}}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error updating form answer for form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to update form answer")}}async getFormAnswers(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.getAnswers(e,t)}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error getting form answers for form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to retrieve form answers")}}async deleteFormAnswers(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);return await this.formService.deleteAnswers(e,t),{message:"Answers deleted successfully"}}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error deleting form answers for form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to delete form answers")}}async queryAnswer(e){try{return await this.formAnswersService.queryAnswer(e)}catch(e){throw h.default.error(`Error querying answer: ${e.message}\n${e.stack}`),new i.InternalServerErrorException("Failed to query answer")}}async exportForm(e,t){try{h.default.info(`Exporting form ${e}`);const o=await this.formService.getForm(e);if(!o)return void t.status(404).json({statusCode:404,message:`Form with ID ${e} not found`,error:"Not Found"});if(!await this.formService.getSourceFile(o.sourceFileId))return void t.status(404).json({statusCode:404,message:`Source file not found for form ${e}`,error:"Not Found"});const{buffer:r,fileName:n,contentType:s}=await this.formService.exportForm(e);if(!r||0===r.length)return void t.status(500).json({statusCode:500,message:"Failed to generate export file",error:"Internal Server Error"});t.setHeader("Content-Type",s),t.setHeader("Content-Disposition",`attachment; filename="${n}"`),t.setHeader("Content-Length",r.length),t.status(200),t.end(r)}catch(o){h.default.error(`Error exporting form ${e}: ${o.message}\n${o.stack}`);const r=o instanceof i.NotFoundException?404:500,n=o.message||"Failed to export form",s=o instanceof i.NotFoundException?"Not Found":"Internal Server Error";t.setHeader("Content-Type","application/json"),t.status(r).json({statusCode:r,message:n,error:s})}}async copyForm(e,t){try{if(!await this.formService.getForm(e))throw new i.NotFoundException(`Form with ID ${e} not found`);const o=await this.formService.copyForm(e,t.title,t.copyAnswers,t.sessionId);if(!o)throw new i.NotFoundException(`Failed to copy form with ID ${e}`);return o}catch(t){if(t instanceof i.NotFoundException)throw t;throw h.default.error(`Error copying form ${e}: ${t.message}\n${t.stack}`),new i.InternalServerErrorException("Failed to copy form")}}};t.FormController=m,r([(0,i.Post)("build"),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[c.CreateFormRequest]),n("design:returntype",Promise)],m.prototype,"buildForm",null),r([(0,i.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",Promise)],m.prototype,"getForms",null),r([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],m.prototype,"getForm",null),r([(0,i.Get)(":id/sections/:sectionId"),s(0,(0,i.Param)("id")),s(1,(0,i.Param)("sectionId")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],m.prototype,"getFormSection",null),r([(0,i.Put)(":id"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,d.UpdateFormRequest]),n("design:returntype",Promise)],m.prototype,"updateForm",null),r([(0,i.Delete)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],m.prototype,"deleteForm",null),r([(0,i.Post)(":id/answers"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,u.UpdateFormAnswerDto]),n("design:returntype",Promise)],m.prototype,"updateFormAnswer",null),r([(0,i.Get)(":id/answers"),s(0,(0,i.Param)("id")),s(1,(0,i.Query)("questionPathPrefix")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],m.prototype,"getFormAnswers",null),r([(0,i.Delete)(":id/answers"),s(0,(0,i.Param)("id")),s(1,(0,i.Query)("questionPathPrefix")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],m.prototype,"deleteFormAnswers",null),r([(0,i.Post)("query-answer"),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[f.AnswerQueryRequest]),n("design:returntype",Promise)],m.prototype,"queryAnswer",null),r([(0,i.Post)(":id/export"),s(0,(0,i.Param)("id")),s(1,(0,i.Res)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],m.prototype,"exportForm",null),r([(0,i.Post)(":id/copy"),s(0,(0,i.Param)("id")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,l.CopyFormRequest]),n("design:returntype",Promise)],m.prototype,"copyForm",null),t.FormController=m=r([(0,i.Controller)("forms"),n("design:paramtypes",[a.FormService,p.FormAnswersService])],m)},7687:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FormAnswer=t.FormAnswerOption=t.FormSection=t.Form=void 0,t.countNestedQuestions=o;t.Form=class{constructor(e,t,o,r,n){this.id=e,this.sourceFileId=t,this.title=o,this.createdAt=r,this.sessionId=n}};t.FormSection=class{constructor(e,t,r,n,s,i){this.id=e,this.formId=t,this.path=r,this.title=n,this.json=s,this.createdAt=i,this.questionCount=o(this.getQuestions())}getQuestions(){return JSON.parse(this.json)}};t.FormAnswerOption=class{constructor(e,t,o,r){this.id=e,this.questionPath=t,this.value=o,this.confidence=r}};function o(e){let t=0;for(const r of e)r.subQuestions&&r.subQuestions.length>0?t+=o(r.subQuestions):t++;return t}t.FormAnswer=class{constructor(e,t,o,r,n,s,i,a){this.id=e,this.formId=t,this.questionPath=o,this.normalizedQuestionText=r,this.value=n,this.formAnswerOptionId=s,this.confidence=i,this.originalInputXpath=a}}},4240:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.FormModule=void 0;const n=o(3563),s=o(1472),i=o(1909),a=o(9496),c=o(376),l=o(6552),d=o(7967),u=o(7184),f=o(8624),p=o(7701),h=o(6941),m=o(3239),g=o(4391),y=o(6696);let w=class{};t.FormModule=w,t.FormModule=w=r([(0,n.Module)({imports:[c.DataSourceModule,f.StoredFileModule,l.DatasetModule,d.ConfigModule],controllers:[s.FormController],providers:[i.FormService,g.FormAnswersService,y.DatasetRetrievalService,a.FormRepository,a.FormSectionRepository,a.FormAnswerOptionRepository,a.FormAnswerRepository,u.DatasetRepository,p.DocxFormBuilder,m.SummaryCompletion,{provide:"FORM_BUILDERS",useFactory:e=>[e],inject:[p.DocxFormBuilder]},h.DocxFormExporter,{provide:"FORM_EXPORTERS",useFactory:e=>[e],inject:[h.DocxFormExporter]}],exports:[i.FormService]})],w)},9496:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormAnswerRepository=t.FormAnswerOptionRepository=t.FormSectionRepository=t.FormRepository=void 0;const i=o(3563),a=(o(1832),o(7687)),c=o(9100);let l=class{constructor(e){this.knex=e}async findById(e){return this.knex("forms").where("id",e).first()}async findAll(e=20){return this.knex("forms").orderBy("createdAt","desc").limit(e)}async findBySessionId(e){return this.knex("forms").where("sessionId",e)}async create(e,t,o){const r=(0,c.ulid)(),n=(new Date).toISOString();return await this.knex("forms").insert({id:r,sourceFileId:e,title:t,createdAt:n,sessionId:o,status:"processing",questionCount:0}),r}async updateSectionAndQuestionCount(e,t,o){await this.knex("forms").where("id",e).update({numberOfSections:t,questionCount:o})}async updateStatus(e,t){await this.knex("forms").where("id",e).update({status:t})}async delete(e){await this.knex("forms").where("id",e).delete()}async updateTitle(e,t){await this.knex("forms").where("id",e).update({title:t})}};t.FormRepository=l,t.FormRepository=l=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],l);let d=class{constructor(e){this.knex=e}async findByFormId(e){return(await this.knex("form_sections").where("formId",e).orderBy("id")).map((e=>new a.FormSection(e.id,e.formId,e.path,e.title,e.json,new Date(e.createdAt))))}async findById(e){const t=await this.knex("form_sections").where("id",e).first();return t?new a.FormSection(t.id,t.formId,t.path,t.title,t.json,new Date(t.createdAt)):null}ensureUlids(e,t=!1){e.forEach((e=>{e.id&&!t||(e.id=(0,c.ulid)()),e.subQuestions&&this.ensureUlids(e.subQuestions,t)}))}async create(e,t,o,r,n,s=!1){const i=(new Date).toISOString();this.ensureUlids(n,s);const c=JSON.stringify(n),l=(0,a.countNestedQuestions)(n);return await this.knex("form_sections").insert({id:t,formId:e,path:o,title:r,json:c,createdAt:i,status:"ready",questionCount:l}),t}async updateStatus(e,t){await this.knex("form_sections").where("id",e).update({status:t})}async deleteByFormId(e){await this.knex("form_sections").where("formId",e).delete()}};t.FormSectionRepository=d,t.FormSectionRepository=d=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],d);let u=class{constructor(e){this.knex=e}async findByQuestionPath(e){return this.knex("form_answer_options").where("questionPath",e).orderBy("confidence","desc")}async create(e,t,o,r){const n=(0,c.ulid)();return await this.knex("form_answer_options").insert({id:n,formId:e,questionPath:t,value:o,confidence:r}),n}async deleteByFormId(e){await this.knex("form_answer_options").where("formId",e).delete()}};t.FormAnswerOptionRepository=u,t.FormAnswerOptionRepository=u=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],u);let f=class{constructor(e){this.knex=e}async getAnswersCount(e){const t=await this.knex("form_answers").where("formId",e).count("id as count").first();return t?.count||0}async findByQuestionPathPrefix(e){let t=this.knex("form_answers");return t=t.where("questionPath","like",`${e}%`),t.orderBy("questionPath")}async findByUniqueQuestionPath(e){return this.knex("form_answers").where("questionPath",e).first()}async findByFormId(e,t){let o=this.knex("form_answers").where("formId",e);return t&&(o=o.where("questionPath","like",`${t}%`)),o.orderBy("questionPath")}async upsertAnswer(e,t){await this.knex("form_answers").where({formId:e,questionPath:t.questionPath}).first()?t.value&&""===t.value.trim()?await this.knex("form_answers").where({formId:e,questionPath:t.questionPath}).delete():await this.knex("form_answers").where({formId:e,questionPath:t.questionPath}).update({normalizedQuestionText:t.normalizedQuestionText,value:t.value,formAnswerOptionId:t.formAnswerOptionId,confidence:t.confidence,originalInputXpath:t.originalInputXpath}):await this.knex("form_answers").insert({id:(0,c.ulid)(),formId:e,...t})}async create(e,t,o,r,n,s){const i=(0,c.ulid)();return await this.knex("form_answers").insert({id:i,formId:e,questionPath:t,normalizedQuestionText:o,value:r,formAnswerOptionId:n,confidence:s}),i}async deleteByFormId(e){await this.knex("form_answers").where("formId",e).delete()}async deleteByQuestionPathPrefix(e,t){await this.knex("form_answers").where("formId",e).where("questionPath","like",`${t}%`).delete()}};t.FormAnswerRepository=f,t.FormAnswerRepository=f=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],f)},1909:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormService=void 0;const i=o(3563),a=o(7205),c=o(9496),l=o(7687),d=o(9055),u=o(9100);let f=class{constructor(e,t,o,r,n,s,i){this.formRepository=e,this.formSectionRepository=t,this.formAnswerOptionRepository=o,this.formAnswerRepository=r,this.storedFileService=n,this.formBuilders=s,this.formExporters=i}async getSourceFile(e){try{return await this.storedFileService.getFile(e)}catch(t){return d.default.error(`Error getting source file ${e}:`,t),null}}async createForm(e,t,o){try{const r=await this.formRepository.create(e,t,o);return d.default.info(`Created form with id ${r}`),r}catch(e){throw d.default.error("Error creating form:",e),e}}async addSection(e,t,o,r,n){try{if(!await this.formRepository.findById(e))throw new Error(`Form not found with id ${e}`);const s=await this.formSectionRepository.create(e,t,o,r,n);return d.default.info(`Added section ${s} to form ${e}`),s}catch(e){throw d.default.error("Error adding section:",e),e}}async addAnswerOption(e,t,o,r){try{const n=await this.formAnswerOptionRepository.create(e,t,o,r);return d.default.info(`Added answer option ${n} for question ${t}`),n}catch(e){throw d.default.error("Error adding answer option:",e),e}}async addAnswer(e,t,o,r,n,s){try{const i=await this.formAnswerRepository.create(e,t,o,r,n,s);return d.default.info(`Added answer ${i} for question ${t}`),i}catch(e){throw d.default.error("Error adding answer:",e),e}}async getForm(e){try{const t=await this.formRepository.findById(e);return t||null}catch(e){throw d.default.error("Error getting form:",e),e}}async getFormWithSections(e){try{const t=await this.formRepository.findById(e);if(!t)return null;const o=await this.formSectionRepository.findByFormId(e);return{...t,sections:o.map((e=>({id:e.id,path:e.path,title:e.title,status:e.status,createdAt:e.createdAt,questionCount:e.questionCount})))}}catch(e){throw d.default.error("Error getting form with sections:",e),e}}async getFormSection(e,t){try{const o=await this.formSectionRepository.findById(t);return o&&o.formId===e?{id:o.id,formId:o.formId,path:o.path,title:o.title,questions:JSON.parse(o.json),createdAt:o.createdAt,status:o.status}:null}catch(e){throw d.default.error("Error getting form section:",e),e}}async getFormList(e=20){try{const t=await this.formRepository.findAll(e);return await Promise.all(t.map((async e=>{const t=await this.formAnswerRepository.getAnswersCount(e.id);return{id:e.id,title:e.title,createdAt:e.createdAt,status:e.status,questionCount:e.questionCount,answersCount:t}})))}catch(e){throw d.default.error("Error getting form list:",e),e}}async getFormSections(e){try{return await this.formSectionRepository.findByFormId(e)}catch(e){throw d.default.error("Error getting form sections:",e),e}}async getAnswerOptions(e){try{return await this.formAnswerOptionRepository.findByQuestionPath(e)}catch(e){throw d.default.error("Error getting answer options:",e),e}}async getAnswers(e,t){try{return await this.formAnswerRepository.findByFormId(e,t)}catch(e){throw d.default.error("Error getting answers:",e),e}}async updateAnswer(e,t){try{await this.formAnswerRepository.upsertAnswer(e,t),d.default.info(`Updated/created answer for form ${e}, question ${t.questionPath}`)}catch(e){throw d.default.error("Error updating answer:",e),e}}async buildNewForm(e,t,o){try{const r=await this.storedFileService.getFile(e);if(!r)throw new Error(`File not found with id ${e}`);const n=this.formBuilders.find((e=>e.canHandle(r)));if(!n)throw new Error(`No form builder found for file type ${r.mimeType} with filename ${r.originalFilename}`);const s=await n.extractTitle(r),i=await this.createForm(e,s,t);this.processSectionsInBackground(i,r,n,o);const a=await this.getFormWithSections(i);if(!a)throw new Error(`Failed to retrieve created form with id ${i}`);return a}catch(e){throw d.default.error("Error building new form:",e),e}}async deleteAnswers(e,t){try{t?(await this.formAnswerRepository.deleteByQuestionPathPrefix(e,t),d.default.info(`Deleted answers for form ${e} with prefix ${t}`)):(await this.formAnswerRepository.deleteByFormId(e),d.default.info(`Deleted all answers for form ${e}`))}catch(e){throw d.default.error("Error deleting answers:",e),e}}async updateFormTitle(e,t){try{if(!await this.formRepository.findById(e))throw new Error(`Form not found with id ${e}`);await this.formRepository.updateTitle(e,t),d.default.info(`Updated title for form ${e}`)}catch(e){throw d.default.error("Error updating form title:",e),e}}async deleteForm(e){try{await this.formAnswerRepository.deleteByFormId(e),await this.formAnswerOptionRepository.deleteByFormId(e),await this.formSectionRepository.deleteByFormId(e),await this.formRepository.delete(e),d.default.info(`Successfully deleted form ${e} and all related data`)}catch(t){throw d.default.error(`Error deleting form ${e}:`,t),t}}async exportForm(e){try{const t=await this.getForm(e);if(!t)throw new Error(`Form not found with id ${e}`);const o=await this.storedFileService.getFile(t.sourceFileId);if(!o)throw new Error(`Source file not found with id ${t.sourceFileId}`);const r=this.formExporters.find((e=>e.canHandle(t,o)));if(!r)throw new Error(`No form exporter found that can handle form ${e}`);const n=await r.export(t,o),s=r.getDefaultFileName(t,o);return{buffer:n,fileName:s,contentType:r.getContentType(o)}}catch(e){throw d.default.error("Error exporting form:",e),e}}async copyForm(e,t,o=!0,r){try{const n=await this.formRepository.findById(e);if(!n)return d.default.error(`Form not found with id ${e}`),null;d.default.info(`Copying form ${e} with title ${t} and copyAnswers ${o}`);const s=await this.formRepository.create(n.sourceFileId,t,r||(0,u.ulid)());d.default.info(`Created new form ${s}`);const i=new Map,a=await this.formSectionRepository.findByFormId(e);for(const e of a){const t=(0,u.ulid)();i.set(e.id,t);const o=JSON.parse(e.json.replace(new RegExp(e.id,"g"),t));await this.formSectionRepository.create(s,t,t,e.title,o,!0)}if(d.default.info(`Copied ${a.length} sections to form ${s}`),o){const t=await this.formAnswerRepository.findByFormId(e);d.default.info(`Copying ${t.length} answers to form ${s}`);for(const e of t)if(e.value&&""!==e.value.trim()){const t=e.questionPath.split("/")[0],o=i.get(t),r=e.questionPath.replace(new RegExp(t,"g"),o);d.default.info(`Copying answer ${e.id} in section ${o} for question ${e.questionPath} to ${r}`),await this.formAnswerRepository.create(s,r,e.normalizedQuestionText,e.value,e.formAnswerOptionId,e.confidence)}}return await this.formRepository.updateStatus(s,"ready"),this.getFormWithSections(s)}catch(e){throw d.default.error("Error copying form:",e),e}}async processSectionsInBackground(e,t,o,r){try{let n=0,s=0;for await(const i of o.generateSections(t,r)){await this.addSection(e,i.id,i.path,i.title,i.questions);s+=(0,l.countNestedQuestions)(i.questions),n++}await this.formRepository.updateSectionAndQuestionCount(e,n,s),await this.formRepository.updateStatus(e,"ready"),d.default.info(`Completed processing form ${e} with ${n} sections and ${s} questions`)}catch(t){d.default.error(`Error processing sections for form ${e}:`,t),await this.formRepository.updateStatus(e,"error")}}};t.FormService=f,t.FormService=f=r([(0,i.Injectable)(),s(5,(0,i.Inject)("FORM_BUILDERS")),s(6,(0,i.Inject)("FORM_EXPORTERS")),n("design:paramtypes",[c.FormRepository,c.FormSectionRepository,c.FormAnswerOptionRepository,c.FormAnswerRepository,a.StoredFileService,Array,Array])],f)},5754:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitLogEntry=void 0;t.GitLogEntry=class{constructor(e,t,o,r,n){this.hash=e,this.message=o,this.date=t,this.author_name=r,this.author_email=n}}},7265:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.GitController=void 0;const i=o(3563),a=o(5190);let c=class{constructor(e){this.gitService=e}async getGitLog(e){try{return await this.gitService.getGitLog(e)}catch(t){if(t.message.includes("not found"))throw new i.HttpException(`Workspace ${e} not found`,i.HttpStatus.NOT_FOUND);if(t.message.includes("not a git repository"))throw new i.HttpException("Workspace is not a git repository",i.HttpStatus.BAD_REQUEST);throw new i.HttpException(`Failed to get git log: ${t.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}async getGitDiff(e,t){try{return await this.gitService.getGitDiff(e,t)}catch(t){if(t.message.includes("not found"))throw new i.HttpException(`Workspace ${e} not found`,i.HttpStatus.NOT_FOUND);throw new i.HttpException(`Failed to get git diff: ${t.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}async undoLastCommit(e){try{await this.gitService.undoLastCommit(e)}catch(t){if(t.message.includes("not found"))throw new i.HttpException(`Workspace ${e} not found`,i.HttpStatus.NOT_FOUND);throw new i.HttpException(`Failed to undo last commit: ${t.message}`,i.HttpStatus.INTERNAL_SERVER_ERROR)}}};t.GitController=c,r([(0,i.Get)(":workspaceName/log"),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getGitLog",null),r([(0,i.Get)(":workspaceName/diff/:hash"),s(0,(0,i.Param)("workspaceName")),s(1,(0,i.Param)("hash")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"getGitDiff",null),r([(0,i.Post)(":workspaceName/undo-last-commit"),s(0,(0,i.Param)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"undoLastCommit",null),t.GitController=c=r([(0,i.Controller)("git"),n("design:paramtypes",[a.GitService])],c)},1901:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.GitModule=void 0;const n=o(3563),s=o(7265),i=o(5190),a=o(5873);let c=class{};t.GitModule=c,t.GitModule=c=r([(0,n.Module)({imports:[a.WorkspaceModule],controllers:[s.GitController],providers:[i.GitService]})],c)},5190:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.GitService=void 0;const s=o(3563),i=o(8474),a=o(5754),c=o(9055),l=o(3807);let d=class{constructor(e){this.workspaceService=e}async getGit(e){const t=await this.workspaceService.findOne(e);if(!t)throw new Error(`Workspace ${e} not found`);return(0,l.default)(t.repoBaseDir)}async undoLastCommit(e){const t=await this.getGit(e);try{await t.reset(["--hard","HEAD~1"])}catch(e){throw new Error(`Failed to undo last commit: ${e.message}`)}}async getGitLog(e){const t=await this.getGit(e);try{return(await t.log(["-n","15"])).all.map((e=>new a.GitLogEntry(e.hash,e.date,e.message,e.author_name,e.author_email)))}catch(e){return e instanceof Error&&e.message.includes("not a git repository")||c.default.warn(`Failed to fetch git log: ${e.message}`),[]}}async getGitDiff(e,t){const o=await this.getGit(e);try{return await o.show(["--unified",t])}catch(e){throw new Error(`Failed to get git diff: ${e.message}`)}}};t.GitService=d,t.GitService=d=r([(0,s.Injectable)(),n("design:paramtypes",[i.WorkspaceService])],d)},5096:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldController=void 0;const s=o(3563),i=o(5533);let a=class{constructor(e){this.helloWorldService=e}getHello(){return this.helloWorldService.getHello()}};t.HelloWorldController=a,r([(0,s.Get)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",String)],a.prototype,"getHello",null),t.HelloWorldController=a=r([(0,s.Controller)("hello-world"),n("design:paramtypes",[i.HelloWorldService])],a)},6808:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldModule=void 0;const n=o(3563),s=o(5096),i=o(5533);let a=class{};t.HelloWorldModule=a,t.HelloWorldModule=a=r([(0,n.Module)({controllers:[s.HelloWorldController],providers:[i.HelloWorldService]})],a)},5533:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HelloWorldService=void 0;const n=o(3563);let s=class{getHello(){return"Hello World!"}};t.HelloWorldService=s,t.HelloWorldService=s=r([(0,n.Injectable)()],s)},4193:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.HomeModule=void 0;const n=o(3563),s=o(538),i=o(7967);let a=class{};t.HomeModule=a,t.HomeModule=a=r([(0,n.Module)({imports:[i.ConfigModule],providers:[s.HomeService],exports:[s.HomeService]})],a)},538:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.HomeService=void 0;const i=o(3563),a=o(2368),c=o(8938),l=o(857);class d{constructor(e){const{requestContent:t,responseContent:o,startedAt:r,endedAt:n,...s}=e;this.requestData=s}toJSON(){return this.requestData}}let u=r=class{constructor(e){this.configService=e,this.logger=new i.Logger(r.name),this.accessCheck={lastResultCode:null,timeOfLastCheck:null,failedToConnect:!1},this.workerQueue=[],this.workerInterval=null,this.isShuttingDown=!1}onModuleInit(){this.startWorkerThread()}async onApplicationShutdown(e){this.logger.log("Application shutdown initiated"+(e?` (signal: ${e})`:"")),this.isShuttingDown=!0,this.workerInterval&&clearInterval(this.workerInterval),this.workerQueue.length>0&&(this.logger.log(`Processing ${this.workerQueue.length} remaining requests before shutdown`),await this.processRemainingRequests()),this.logger.log("Shutdown process completed")}isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async checkAccess(){const e=this.configService.getProperty("HLDK_API_KEY");if(!e)throw new Error("API Key is not configured");if(!this.isValidUUID(e))throw new Error("Invalid API Key");const t=l.hostname();try{const o=await c.default.post("https://otiiwxlfsrejhbrxdras.supabase.co/functions/v1/log-access",{hostname:t},{headers:{Authorization:`Bearer ${e}`},timeout:3e3});this.accessCheck={lastResultCode:o.status,timeOfLastCheck:new Date,failedToConnect:!1}}catch(e){if(c.default.isAxiosError(e)){const t=e;t.response?this.accessCheck={lastResultCode:t.response.status,timeOfLastCheck:new Date,failedToConnect:!1}:(t.request,this.accessCheck={lastResultCode:null,timeOfLastCheck:new Date,failedToConnect:!0})}else this.accessCheck={lastResultCode:null,timeOfLastCheck:new Date,failedToConnect:!0};this.logger.error("Failed to check access",e)}return this.accessCheck}async isAccessOkay(){const e=new Date(Date.now()-864e5);return(!this.accessCheck.timeOfLastCheck||this.accessCheck.timeOfLastCheck<e||403===this.accessCheck.lastResultCode)&&await this.checkAccess(),200===this.accessCheck.lastResultCode||this.accessCheck.failedToConnect}async logRequest(e){await this.isAccessOkay()&&!this.accessCheck.failedToConnect&&this.workerQueue.push(new d(e))}startWorkerThread(){this.workerInterval=setInterval((async()=>{if(this.workerQueue.length>0&&!this.isShuttingDown){const e=[...this.workerQueue];this.workerQueue=[],await this.sendRequestsToHomeServer(e)}}),1e4)}async processRemainingRequests(){if(this.workerQueue.length>0){const e=[...this.workerQueue];this.workerQueue=[],await this.sendRequestsToHomeServer(e)}}async sendRequestsToHomeServer(e){const t=this.configService.getProperty("HLDK_API_KEY");if(!t)return void this.logger.log("API Key is not configured");const o=e.map((e=>c.default.post("https://otiiwxlfsrejhbrxdras.supabase.co/functions/v1/log-request",e,{headers:{Authorization:`Bearer ${t}`},timeout:5e3})));(await Promise.allSettled(o)).forEach(((e,t)=>{"rejected"===e.status&&this.logger.log(`Failed to log request at index ${t}`,e.reason)}))}};t.HomeService=u,t.HomeService=u=r=n([(0,i.Injectable)(),s("design:paramtypes",[a.ConfigService])],u)},2303:(e,t)=>{"use strict";var o;Object.defineProperty(t,"__esModule",{value:!0}),t.Mutation=t.MutationType=void 0,function(e){e.CREATE="create",e.UPDATE="update",e.DELETE="delete"}(o||(t.MutationType=o={}));t.Mutation=class{constructor(e,t,o,r,n,s,i,a,c){this.id=e,this.type=t,this.filePath=o,this.description=r,this.fileContentsBefore=n,this.fileContentsAfter=s,this.updatedAt=i,this.sessionId=a,this.requestId=c}}},672:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationRepository=void 0;const i=o(3563),a=(o(1832),o(3903));let c=class{constructor(e){this.knex=e}async findAll(e,t){let o=this.knex("mutations").select("*");if(t&&(o=o.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:r}=e,n=(t-1)*r;o=o.offset(n).limit(r)}return o}async findById(e){return this.knex("mutations").where("id",e).first()}async findBySessionId(e,t,o){let r=this.knex("mutations").where("sessionId",e);if(o&&(r=r.orderBy(o.field,o.order.toLowerCase())),t){const{page:e,limit:o}=t,n=(e-1)*o;r=r.offset(n).limit(o)}return r}async findBySessionIds(e){return this.knex("mutations").whereIn("sessionId",e)}async findByRequestId(e){return this.knex("mutations").where("requestId",e)}async create(e){const t=(0,a.v4)(),o=(new Date).toISOString();return await this.knex("mutations").insert({id:t,...e,updatedAt:o}),t}async update(e,t){await this.knex("mutations").where("id",e).update(t)}async delete(e){await this.knex("mutations").where("id",e).delete()}};t.MutationRepository=c,t.MutationRepository=c=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],c)},9989:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsController=void 0;const i=o(3563),a=o(7602);let c=class{constructor(e){this.mutationsService=e}async getMutationsForSession(e){return this.mutationsService.getMutationsForSession(e)}async getMutation(e){return this.mutationsService.getMutation(e)}};t.MutationsController=c,r([(0,i.Get)("session/:sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getMutationsForSession",null),r([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getMutation",null),t.MutationsController=c=r([(0,i.Controller)("mutations"),n("design:paramtypes",[a.MutationsService])],c)},3177:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsModule=void 0;const n=o(3563),s=o(376),i=o(9989),a=o(7602),c=o(672);let l=class{};t.MutationsModule=l,t.MutationsModule=l=r([(0,n.Module)({imports:[s.DataSourceModule],controllers:[i.MutationsController],providers:[a.MutationsService,c.MutationRepository],exports:[a.MutationsService]})],l)},7602:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.MutationsService=void 0;const s=o(3563),i=o(672);let a=class{constructor(e){this.mutationRepository=e}async getMutationsForSession(e){return(await this.mutationRepository.findBySessionId(e,void 0,{field:"updatedAt",order:"DESC"})).map((e=>({id:e.id,type:e.type,filePath:e.filePath,updatedAt:e.updatedAt,description:e.description,fileContentsBefore:e.fileContentsBefore,fileContentsAfter:e.fileContentsAfter,requestId:e.requestId})))}async getMutation(e){return this.mutationRepository.findById(e)}async getMutationsForRequest(e){return(await this.mutationRepository.findByRequestId(e)).map((e=>({id:e.id,type:e.type,filePath:e.filePath,updatedAt:e.updatedAt,description:e.description,fileContentsBefore:e.fileContentsBefore,fileContentsAfter:e.fileContentsAfter,requestId:e.requestId})))}async createMutation(e){if(!e.sessionId)throw new Error("sessionId is required to create a mutation");if(!e.requestId)throw new Error("requestId is required to create a mutation");return await this.mutationRepository.create({...e,updatedAt:e.updatedAt||new Date})}};t.MutationsService=a,t.MutationsService=a=r([(0,s.Injectable)(),n("design:paramtypes",[i.MutationRepository])],a)},7307:function(__unused_webpack_module,exports,__webpack_require__){"use strict";var __decorate=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},PluginLoaderService_1;Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginLoaderService=void 0;const common_1=__webpack_require__(3563),fs=__webpack_require__(4652),path=__webpack_require__(6928),graph_agent_collaborator_service_1=__webpack_require__(2300),graph_agent_service_1=__webpack_require__(5277),logger_1=__webpack_require__(9055),tool_factory_service_1=__webpack_require__(6158);let PluginLoaderService=PluginLoaderService_1=class PluginLoaderService{constructor(e,t){this.agentCollaborator=e,this.toolFactoryService=t,this.logger=new common_1.Logger(PluginLoaderService_1.name)}async loadPlugins(){const e=[];try{const t=process.env.PLUGIN_DIR||path.join(__dirname,"..","..","plugins");if(logger_1.default.info(`Loading plugins from: ${t}`),!t)return logger_1.default.info("PLUGIN_DIR not set, skipping plugin loading"),e;if(!await fs.pathExists(t))return logger_1.default.warn(`Plugin directory not found: ${t}`),e;const o=await fs.readdir(t);for(const r of o){const o=path.join(t,r,"plugin-config.json");if(await fs.pathExists(o)){const n=await fs.readJson(o),s=await this.loadPlugin(t,r,n);e.push(...s)}else logger_1.default.warn(`No plugin-config.json found for plugin: ${r}. Skipping.`)}}catch(e){logger_1.default.error("Error loading plugins: %s",e.message,e.stack)}return e}async loadPlugin(e,t,o){logger_1.default.info(`Loading plugin: ${t}`);const r=[];if(o.agents)for(const[n,s]of Object.entries(o.agents)){const o=await this.loadAgent(e,t,n,s);o&&r.push(o)}if(o.tools)for(const[r,n]of Object.entries(o.tools))await this.loadTool(e,t,r,n);return o.tests&&await this.runTests(e,t,o.tests),r}async loadAgent(pluginDir,pluginName,agentName,agentFile){const agentPath=path.join(pluginDir,pluginName,agentFile);if(await fs.pathExists(agentPath))try{const AgentModule=eval("require")(agentPath),agentImplementation=AgentModule.default||AgentModule,agent=new graph_agent_service_1.GraphAgentService(this.agentCollaborator,this.toolFactoryService);for(const e of Object.getOwnPropertyNames(agentImplementation))"function"==typeof agentImplementation[e]&&"constructor"!==e&&(logger_1.default.info("Delegating method: %s to plugin: %s/%s",e,pluginName,agentName),agent[e]=async(...t)=>await agentImplementation[e](...t));return agent.getName=()=>agentName,logger_1.default.info(`Loaded agent: ${agentFile} from plugin: ${pluginName} with name: ${agent.getName()}`),agent}catch(e){logger_1.default.error(`Error loading agent: ${agentFile} from plugin: ${pluginName}`,e.stack)}else logger_1.default.warn(`Agent file not found: ${agentPath}`);return null}async loadTool(pluginDir,pluginName,toolName,toolFile){logger_1.default.info(`Loading tool: ${toolName} (${toolFile}) from plugin: ${pluginName}`);const toolPath=path.join(pluginDir,pluginName,toolFile);if(await fs.pathExists(toolPath))try{const ToolModule=eval("require")(toolPath);"function"==typeof ToolModule.createTool?(this.toolFactoryService.registerTool(toolName,ToolModule.createTool),logger_1.default.info(`Loaded tool: ${toolName} (${toolFile}) from plugin: ${pluginName}`)):logger_1.default.warn(`Tool ${toolName} (${toolFile}) from plugin: ${pluginName} does not export a 'createTool' function`)}catch(e){logger_1.default.error(`Error loading tool: ${toolName} (${toolFile}) from plugin: ${pluginName}`,e.stack)}}async runTests(e,t,o){for(const r of o){const o=path.join(e,t,r);if(await fs.pathExists(o))try{const e=await Promise.resolve(`${o}`).then((e=>__webpack_require__(6002)(e)));"function"==typeof e.default&&await e.default(),logger_1.default.info(`Ran test: ${r} for plugin: ${t}`)}catch(e){logger_1.default.error(`Error running test: ${r} for plugin: ${t}`,e.stack)}}}};exports.PluginLoaderService=PluginLoaderService,exports.PluginLoaderService=PluginLoaderService=PluginLoaderService_1=__decorate([(0,common_1.Injectable)(),__metadata("design:paramtypes",[graph_agent_collaborator_service_1.GraphAgentCollaborator,tool_factory_service_1.ToolFactoryService])],PluginLoaderService)},756:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.PluginModule=void 0;const n=o(3563),s=o(7307),i=o(2177),a=o(361),c=o(2424);let l=class{};t.PluginModule=l,t.PluginModule=l=r([(0,n.Module)({imports:[i.AgentsModule,a.ToolsModule,c.GraphAgentModule],providers:[s.PluginLoaderService],exports:[s.PluginLoaderService]})],l)},6002:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=6002,e.exports=t},353:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingController=void 0;const i=o(3563),a=o(7510);let c=class{constructor(e){this.reportingService=e}async getReport(e,t,o,r){return this.reportingService.generateReport(e,t,o,r)}};t.ReportingController=c,r([(0,i.Get)("report"),s(0,(0,i.Query)("from")),s(1,(0,i.Query)("to")),s(2,(0,i.Query)("period")),s(3,(0,i.Query)("workspaceName")),n("design:type",Function),n("design:paramtypes",[String,String,String,String]),n("design:returntype",Promise)],c.prototype,"getReport",null),t.ReportingController=c=r([(0,i.Controller)("reporting"),n("design:paramtypes",[a.ReportingService])],c)},8221:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingModule=void 0;const n=o(3563),s=o(353),i=o(7510),a=o(376),c=o(7967);let l=class{};t.ReportingModule=l,t.ReportingModule=l=r([(0,n.Module)({imports:[a.DataSourceModule,c.ConfigModule],controllers:[s.ReportingController],providers:[i.ReportingService]})],l)},7510:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReportingService=void 0;const i=o(3563),a=(o(1832),o(9055)),c=o(2368),l=o(6910);let d=class{constructor(e,t){this.knex=e,this.configService=t}async generateReport(e,t,o,r){try{const{startDate:n,endDate:s}=this.resolveDateRange(e,t,o),i=await this.getRequestTotalsData(n,s,r);return{requestTotals:i,dailyMetrics:await this.getHistoricStats(n,s,r),dateRange:{startDate:n,endDate:s}}}catch(e){throw a.default.error(`Error generating report: ${e.message}`,e.stack),e}}resolveDateRange(e,t,o){const r=new Date;let n,s;try{if(e&&t)n=new Date(e),s=new Date(t),s.setHours(23,59,59,999);else if(o)switch(s=new Date(r),s.setHours(23,59,59,999),o){case"today":n=new Date(r),n.setHours(0,0,0,0);break;case"this-week":n=new Date(r),n.setDate(n.getDate()-7),n.setHours(0,0,0,0);break;case"this-month":n=new Date(r),n.setDate(n.getDate()-30),n.setHours(0,0,0,0);break;case"all-time":n=new Date(r),n.setDate(n.getDate()-90),n.setHours(0,0,0,0);break;default:throw new Error("Invalid period specified")}else n=new Date(r),n.setDate(n.getDate()-90),n.setHours(0,0,0,0),s=new Date(r),s.setHours(23,59,59,999);return{startDate:n,endDate:s}}catch(e){throw a.default.error(`Error resolving date range: ${e.message}`,e.stack),e}}async getRequestTotalsData(e,t,o){try{let r=this.knex("requests").select(this.knex.raw("COUNT(*) as totalRequests"),this.knex.raw("COALESCE(SUM(tookMillis), 0) as totalProcessingMillis"),this.knex.raw("COALESCE(AVG(tookMillis), 0) as avgProcessingMillis"),this.knex.raw("COALESCE(SUM(inputTokens), 0) as totalInputTokens"),this.knex.raw("COALESCE(SUM(outputTokens), 0) as totalOutputTokens"),this.knex.raw("COALESCE(SUM(totalTokens), 0) as totalTokens"),this.knex.raw("COALESCE(SUM(cost), 0) as totalCost"),this.knex.raw("COALESCE(AVG(cost), 0) as avgCostPerRequest"),this.knex.raw("COALESCE(SUM(CASE WHEN linesChanged <= 500 THEN linesChanged ELSE 0 END), 0) as totalLinesChanged"),this.knex.raw("COALESCE(AVG(CASE WHEN linesChanged <= 500 THEN linesChanged ELSE NULL END), 0) as avgLinesChangedPerRequest"),this.knex.raw("COALESCE(SUM(filesChanged), 0) as totalFilesChanged"),this.knex.raw("COALESCE(SUM(insertions), 0) as totalInsertions"),this.knex.raw("COALESCE(SUM(deletions), 0) as totalDeletions"),this.knex.raw("COALESCE(SUM(CASE WHEN linesChanged <= 500 THEN testLinesChanged ELSE 0 END), 0) as totalTestLinesChanged"),this.knex.raw("COALESCE(SUM(testFilesChanged), 0) as totalTestFilesChanged"),this.knex.raw("COALESCE(SUM(testInsertions), 0) as totalTestInsertions"),this.knex.raw("COALESCE(SUM(testDeletions), 0) as totalTestDeletions"),this.knex.raw("COALESCE(SUM(cacheReadTokens), 0) as totalCacheReadTokens"),this.knex.raw("COALESCE(SUM(cacheWriteTokens), 0) as totalCacheWriteTokens")).whereBetween("startedAt",[e,t]);o&&""!==o.trim()&&(r=r.where("workspaceName",o));const n=await r.first(),s=n.totalLinesChanged-n.totalTestLinesChanged,i=n.totalFilesChanged-n.totalTestFilesChanged,a=n.totalLinesChanged>0?n.totalCost/n.totalLinesChanged:0,c=this.configService.getNumericProperty(l.ConfigPropNames.VALUE_PER_LINE)||2.4,d=n.totalLinesChanged*c,u=n.totalRequests>0?d/n.totalRequests:0,f=n.totalInputTokens+n.totalCacheReadTokens>0?100*n.totalCacheReadTokens/(n.totalInputTokens+n.totalCacheReadTokens):0;return{totalRequests:n.totalRequests,totalProcessingMillis:n.totalProcessingMillis,avgProcessingMillis:n.avgProcessingMillis,totalInputTokens:n.totalInputTokens,totalOutputTokens:n.totalOutputTokens,totalTokens:n.totalTokens,totalCost:n.totalCost,avgCostPerRequest:n.avgCostPerRequest,avgCostPerLine:a,totalLinesChanged:n.totalLinesChanged,totalFilesChanged:n.totalFilesChanged,totalInsertions:n.totalInsertions,totalDeletions:n.totalDeletions,totalTestLinesChanged:n.totalTestLinesChanged,totalTestFilesChanged:n.totalTestFilesChanged,totalTestInsertions:n.totalTestInsertions,totalTestDeletions:n.totalTestDeletions,totalProductionLinesChanged:s,totalProductionFilesChanged:i,totalValueCreated:d,avgValueCreatedPerRequest:u,avgLinesChangedPerRequest:n.avgLinesChangedPerRequest,totalCacheReadTokens:n.totalCacheReadTokens,totalCacheWriteTokens:n.totalCacheWriteTokens,inputCacheHitPercentage:f}}catch(e){throw a.default.error(`Error getting request totals data: ${e.message}`,e.stack),e}}async getHistoricStats(e,t,o){try{let r=this.knex("requests").select(this.knex.raw("strftime('%Y-%m-%d', datetime(startedAt/1000, 'unixepoch')) as label"),this.knex.raw("COALESCE(SUM(CASE WHEN linesChanged <= 500 THEN linesChanged ELSE 0 END), 0) as linesChanged"),this.knex.raw("COALESCE(SUM(cost), 0) as cost"),this.knex.raw("COUNT(*) as requests"),this.knex.raw("COALESCE(SUM(tookMillis), 0) as processingTime")).whereBetween("startedAt",[e,t]);o&&""!==o.trim()&&(r=r.where("workspaceName",o)),r=r.groupBy("label").orderBy("label","asc"),a.default.debug(`Query: ${r.toString()}`);const n=await r,s=this.configService.getNumericProperty(l.ConfigPropNames.VALUE_PER_LINE)||2.4;return n.map((e=>({label:e.label,linesChanged:e.linesChanged,cost:e.cost,valueCreated:e.linesChanged*s,requests:e.requests,processingTime:e.processingTime})))}catch(e){throw a.default.error(`Error getting historic stats: ${e.message}`,e.stack),e}}};t.ReportingService=d,t.ReportingService=d=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function,c.ConfigService])],d)},9095:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.ItemRepository=void 0;const i=o(3563);o(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t){let o=this.knex("items").select("*");if(t&&(o=o.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:r}=e,n=(t-1)*r;o=o.offset(n).limit(r)}return o}async findById(e){return this.knex("items").where("itemId",e).first()}async findBySessionId(e,t,o){let r=this.knex("items").where("sessionId",e);if(o&&(r=r.orderBy(o.field,o.order.toLowerCase())),t){const{page:e,limit:o}=t,n=(e-1)*o;r=r.offset(n).limit(o)}return r}async create(e){await this.knex("items").insert(e)}async update(e,t){await this.knex("items").where("itemId",e).update(t)}async delete(e){await this.knex("items").where("itemId",e).delete()}async countBySessionId(e){const t=await this.knex("items").where("sessionId",e).count("* as count").first();return t?.count}async getSessionStats(e){const t=await this.knex("items").select("sessionId").sum("inputTokens as inputTokens").sum("cacheWriteTokens as cacheWriteTokens").sum("cacheReadTokens as cacheReadTokens").sum("outputTokens as outputTokens").sum("totalTokens as totalTokens").sum("cost as cost").whereIn("sessionId",e).groupBy("sessionId"),o={};return t.forEach((e=>{o[e.sessionId]={inputTokens:e.inputTokens,cacheWriteTokens:e.cacheWriteTokens,cacheReadTokens:e.cacheReadTokens,outputTokens:e.outputTokens,totalTokens:e.totalTokens,cost:e.cost}})),o}async getRequestStats(e){const t=await this.knex("items").select("requestId").sum("inputTokens as inputTokens").sum("cacheWriteTokens as cacheWriteTokens").sum("cacheReadTokens as cacheReadTokens").sum("outputTokens as outputTokens").sum("totalTokens as totalTokens").sum("cost as cost").whereIn("requestId",e).groupBy("requestId"),o={};return t.forEach((e=>{o[e.requestId]={inputTokens:e.inputTokens,cacheWriteTokens:e.cacheWriteTokens,cacheReadTokens:e.cacheReadTokens,outputTokens:e.outputTokens,totalTokens:e.totalTokens,cost:e.cost}})),o}};t.ItemRepository=a,t.ItemRepository=a=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},4143:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.RequestController=void 0;const i=o(3563),a=o(7373);let c=class{constructor(e){this.sessionService=e}async getRequest(e){return this.sessionService.getRequest(e)}};t.RequestController=c,r([(0,i.Get)(":requestId"),s(0,(0,i.Param)("requestId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"getRequest",null),t.RequestController=c=r([(0,i.Controller)("requests"),n("design:paramtypes",[a.SessionService])],c)},5312:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Request=void 0;t.Request=class{constructor(e,t,o,r,n={}){this.responseContent="",this.startedAt=new Date,this.endedAt=new Date,this.tookMillis=0,this.inputTokens=0,this.cacheWriteTokens=0,this.cacheReadTokens=0,this.outputTokens=0,this.totalTokens=0,this.cost=0,this.filesChanged=0,this.insertions=0,this.deletions=0,this.testFilesChanged=0,this.testInsertions=0,this.testDeletions=0,this.linesChanged=0,this.testLinesChanged=0,this.requestId=e,this.sessionId=t,this.workspaceName=o,this.requestContent=r,Object.assign(this,n)}}},811:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.RequestRepository=void 0;const i=o(3563);o(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t){let o=this.knex("requests").select("*");if(t&&(o=o.orderBy(t.field,t.order.toLowerCase())),e){const{page:t,limit:r}=e,n=(t-1)*r;o=o.offset(n).limit(r)}return o}async findById(e){return this.knex("requests").where("requestId",e).first()}async findBySessionId(e,t,o){let r=this.knex("requests").where("sessionId",e);if(o&&(r=r.orderBy(o.field,o.order.toLowerCase())),t){const{page:e,limit:o}=t,n=(e-1)*o;r=r.offset(n).limit(o)}return r}async create(e){await this.knex("requests").insert(e)}async update(e,t){await this.knex("requests").where("requestId",e).update(t)}async delete(e){await this.knex("requests").where("requestId",e).delete()}async countBySessionId(e){const t=await this.knex("requests").where("sessionId",e).count("* as count").first();return t?.count}async updateRequest(e,t){await this.knex("requests").where("requestId",e).update(t)}async updateGitStats(e,t){await this.knex("requests").where("requestId",e).update(t)}async getSessionGitStats(e){return(await this.knex("requests").select("sessionId").sum("filesChanged as filesChanged").sum("insertions as insertions").sum("deletions as deletions").sum("testFilesChanged as testFilesChanged").sum("testInsertions as testInsertions").sum("testDeletions as testDeletions").sum("linesChanged as linesChanged").sum("testLinesChanged as testLinesChanged").whereIn("sessionId",e).groupBy("sessionId")).reduce(((e,t)=>(e[t.sessionId]={filesChanged:t.filesChanged,insertions:t.insertions,deletions:t.deletions,testFilesChanged:t.testFilesChanged,testInsertions:t.testInsertions,testDeletions:t.testDeletions,linesChanged:t.linesChanged,testLinesChanged:t.testLinesChanged},e)),{})}};t.RequestRepository=a,t.RequestRepository=a=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},5480:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionController=void 0;const i=o(3563),a=o(7373),c=o(573);let l=class{constructor(e){this.sessionService=e}async createSession(e,t,o="",r="se-agent"){return this.sessionService.ensureSession(e,t,o,r)}async getSessions(e=1,t=10,o="createdAt",r="DESC"){return this.sessionService.getSessions(e,t,o,r)}async getSession(e){return this.sessionService.getSession(e)}async deleteSession(e){return this.sessionService.deleteSession(e)}async getItemsForSession(e,t=1,o=100,r="ASC"){const[n,s]=await this.sessionService.getItemsForSession(e,t,o,r);return{items:n,total:s}}streamSessionItems(e){return this.sessionService.streamSessionItems(e)}async abortSession(e){return this.sessionService.abortSession(e)}};t.SessionController=l,r([(0,i.Post)(),s(0,(0,i.Body)("workspaceName")),s(1,(0,i.Body)("sessionId")),s(2,(0,i.Body)("requestContent")),s(3,(0,i.Body)("agent")),n("design:type",Function),n("design:paramtypes",[String,String,String,String]),n("design:returntype",Promise)],l.prototype,"createSession",null),r([(0,i.Get)(),s(0,(0,i.Query)("page")),s(1,(0,i.Query)("limit")),s(2,(0,i.Query)("sortBy")),s(3,(0,i.Query)("sortOrder")),n("design:type",Function),n("design:paramtypes",[Number,Number,String,String]),n("design:returntype",Promise)],l.prototype,"getSessions",null),r([(0,i.Get)(":sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"getSession",null),r([(0,i.Delete)(":sessionId"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"deleteSession",null),r([(0,i.Get)(":sessionId/items"),s(0,(0,i.Param)("sessionId")),s(1,(0,i.Query)("page")),s(2,(0,i.Query)("limit")),s(3,(0,i.Query)("sortOrder")),n("design:type",Function),n("design:paramtypes",[String,Number,Number,String]),n("design:returntype",Promise)],l.prototype,"getItemsForSession",null),r([(0,i.Sse)(":sessionId/stream"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",c.Observable)],l.prototype,"streamSessionItems",null),r([(0,i.Post)(":sessionId/abort"),s(0,(0,i.Param)("sessionId")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"abortSession",null),t.SessionController=l=r([(0,i.Controller)("sessions"),n("design:paramtypes",[a.SessionService])],l)},3880:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionModule=void 0;const n=o(3563),s=o(376),i=o(5480),a=o(4143),c=o(7373),l=o(3936),d=o(9095),u=o(811),f=o(3177);let p=class{};t.SessionModule=p,t.SessionModule=p=r([(0,n.Module)({imports:[s.DataSourceModule,f.MutationsModule],controllers:[i.SessionController,a.RequestController],providers:[c.SessionService,l.SessionRepository,d.ItemRepository,u.RequestRepository],exports:[c.SessionService]})],p)},3936:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionRepository=void 0;const i=o(3563);o(1832);let a=class{constructor(e){this.knex=e}async findAll(e,t,o){let r=this.knex("sessions").select("*"),n=this.knex("sessions").count("* as count");o&&(r=r.where(o),n=n.where(o)),t&&(r=r.orderBy(t.field,t.order.toLowerCase()));const s=await n.first(),i=s?.count;if(e){const{page:t,limit:o}=e,n=(t-1)*o;r=r.offset(n).limit(o)}return{sessions:await r,total:i}}async findById(e){return this.knex("sessions").where("sessionId",e).first()}async create(e){await this.knex("sessions").insert(e)}async update(e,t){await this.knex("sessions").where("sessionId",e).update(t)}async delete(e){await this.knex("sessions").where("sessionId",e).delete()}async count(e){const t=this.knex("sessions").count("* as count");e&&t.where(e);const o=await t.first();return o?.count}async createItem(e){await this.knex("item").insert(e)}async findItemsBySessionId(e){return this.knex("item").where("sessionId",e).orderBy("createdAt","asc")}async updateItem(e,t){await this.knex("item").where("itemId",e).update(t)}};t.SessionRepository=a,t.SessionRepository=a=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},7373:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SessionService=void 0;const s=o(3563),i=o(5312),a=o(573),c=o(4434),l=o(3936),d=o(9095),u=o(811),f=o(9055),p=o(9100);let h=class{constructor(e,t,o){this.sessionRepository=e,this.itemRepository=t,this.requestRepository=o,this.eventEmitter=new c.EventEmitter}async getSessions(e=1,t=10,o="createdAt",r="DESC"){const{sessions:n,total:s}=await this.sessionRepository.findAll({page:e,limit:t},{field:o,order:r}),i=n.map((e=>e.sessionId)),a=await this.itemRepository.getSessionStats(i),c=await this.requestRepository.getSessionGitStats(i);return{sessions:n.map((e=>({...e,stats:{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0,...a[e.sessionId]||{}},gitStats:{filesChanged:0,insertions:0,deletions:0,testFilesChanged:0,testInsertions:0,testDeletions:0,...c[e.sessionId]||{}}}))),total:s}}async getSessionStats(e){return{...(await this.itemRepository.getSessionStats([e]))[e]||{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0}}}async getRequestStats(e){return{...(await this.itemRepository.getRequestStats([e]))[e]||{inputTokens:0,cacheWriteTokens:0,cacheReadTokens:0,outputTokens:0,totalTokens:0,cost:0}}}async ensureSession(e,t,o,r){const n=await this.sessionRepository.findById(t);if(n){if(n.workspaceName!==e)throw new Error(`Session ${t} exists but belongs to a different workspace`);if("active"===n.status)throw new Error(`Session ${t} is currently active`);return n.requestSnippet||(n.requestSnippet=o.slice(0,250),await this.sessionRepository.update(t,{requestSnippet:n.requestSnippet})),n}const s={sessionId:t,workspaceName:e,status:"inactive",createdAt:new Date,requestSnippet:o.slice(0,250),agent:r};return await this.sessionRepository.create(s),s}async getSession(e){return this.sessionRepository.findById(e)}async deleteSession(e){await this.sessionRepository.delete(e)}async deleteSessionForWorkspace(e,t){await this.sessionRepository.delete(t)}async addItem(e){return"AI"===e.label||"Human"===e.label?f.default.info("Adding item to session: %s with label: %s, content: %s",e.sessionId,e.label,e.content):f.default.debug("Adding item to session %s with label %s, content: %s",e.sessionId,e.label,e.content),await this.itemRepository.create(e),this.eventEmitter.emit("newItem",e),e}async getItemsForSession(e,t=1,o=100,r="ASC"){return[await this.itemRepository.findBySessionId(e,{page:t,limit:o},{field:"createdAt",order:r}),await this.itemRepository.countBySessionId(e)]}streamSessionItems(e){return new a.Observable((t=>{this.getItemsForSession(e).then((([e])=>{e.forEach((e=>{t.next({data:e})}))}));const o=o=>{o.sessionId===e&&t.next({data:o})};return this.eventEmitter.on("newItem",o),()=>{this.eventEmitter.removeListener("newItem",o)}}))}async updateSessionStatus(e,t){await this.sessionRepository.update(e,{status:t})}async abortSession(e){if(!await this.sessionRepository.findById(e))throw new s.NotFoundException(`Session with id ${e} not found`);return await this.updateSessionStatus(e,"aborted"),this.sessionRepository.findById(e)}generateSessionId(){return(0,p.ulid)()}generateItemId(){return(0,p.ulid)()}async addRequest(e){f.default.info("Adding request to session: %s, workspaceName: %s, requestContent: %s",e.sessionId,e.workspaceName,e.requestContent);const t=new i.Request(e.requestId||this.generateRequestId(),e.sessionId,e.workspaceName,e.requestContent,e);return await this.requestRepository.create(t),t}async updateRequest(e,t){return f.default.info("Updating request: %s, updateData: %s",e,JSON.stringify(t)),await this.requestRepository.updateRequest(e,t),this.requestRepository.findById(e)}generateRequestId(){return(0,p.ulid)()}async getRequest(e){return this.requestRepository.findById(e)}async updateGitStats(e,t){f.default.info("Updating git stats for request: %s, gitStats: %s",e,JSON.stringify(t)),await this.requestRepository.updateGitStats(e,t)}};t.SessionService=h,t.SessionService=h=r([(0,s.Injectable)(),n("design:paramtypes",[l.SessionRepository,d.ItemRepository,u.RequestRepository])],h)},4912:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.MavenSourceArtefactScheme=void 0;const n=o(3563),s=o(8547),i=o(8938),a=o(1943),c=o(6928),l=o(857),d=o(4650),u=o(9055);let f=class{getName(){return"maven"}async downloadAndStoreSources(e,t,o){if(u.default.info(`Downloading and storing sources for Maven artifact: ${e}`),!this.isValidGAV(e))throw u.default.warn(`Invalid Maven GAV coordinates: ${e}`),new n.BadRequestException("Invalid Maven GAV coordinates");const r=this.getRepoUrls(o);u.default.info(`Using repository URLs: ${r.join(", ")}`);const i=await this.findSourcesJarUrl(r,e);if(!i)throw u.default.warn(`Sources jar not found for ${e} in any of the provided repositories`),new n.BadRequestException("Sources jar not found in any of the provided repositories");u.default.info(`Found sources jar at: ${i}`);const d=await a.mkdtemp(c.join(l.tmpdir(),"maven-sources-")),f=c.join(d,"sources.jar");try{await this.downloadFile(i,f),u.default.info(`Downloaded sources jar to: ${f}`);const o=e.replace(/:/g,"/"),r=c.join(t,"maven",o);await a.mkdir(r,{recursive:!0}),u.default.info(`Created cache directory: ${r}`),await this.unzipJar(f,r),u.default.info(`Unzipped sources jar to: ${r}`);const n=new s.SourceArtefact({scheme:this.getName(),locator:e,valid:!0,error:null,repo:new URL(i).origin,cacheSrcBaseDir:r});return u.default.info(`Successfully created SourceArtefact for ${e}`),n}finally{await a.rm(d,{recursive:!0,force:!0}),u.default.info(`Cleaned up temporary directory: ${d}`)}}async needsImport(e){if(!e.cacheSrcBaseDir)return!0;try{return 0===(await a.readdir(e.cacheSrcBaseDir)).length}catch(e){return!0}}async readArtefactSourceTree(e){if(!e.cacheSrcBaseDir)throw new Error("Invalid source artefact: missing cache directory");const{generateTree:t}=await Promise.resolve().then((()=>o(6426)));return t(e.cacheSrcBaseDir)}async readArtefactSourceFile(e,t){if(!e.cacheSrcBaseDir)throw new Error("Invalid source artefact: missing cache directory");const o=c.join(e.cacheSrcBaseDir,t);try{return await a.readFile(o,"utf-8")}catch(e){throw new Error(`Failed to read file: ${t}`)}}isValidGAV(e){return/^[^:]+:[^:]+:[^:]+$/.test(e)}getRepoUrls(e){if(e&&e.length>0)return e;const t=process.env.MAVEN_REPO_URLS;return t?t.split(",").map((e=>e.trim())):["https://repo.maven.apache.org/maven2"]}async findSourcesJarUrl(e,t){const[o,r,n]=t.split(":"),s=`${o.replace(/\./g,"/")}/${r}/${n}/${r}-${n}-sources.jar`;for(var a of e){a.endsWith("/")||(a+="/");const e=new URL(s,a).toString();u.default.info(`Checking URL: ${e}`);try{return await i.default.head(e),e}catch(t){u.default.info(`Error checking maven url ${e}: ${t}`)}}return null}async downloadFile(e,t){const o=await i.default.get(e,{responseType:"arraybuffer"});await a.writeFile(t,o.data)}async unzipJar(e,t){new d(e).extractAllTo(t,!0)}};t.MavenSourceArtefactScheme=f,t.MavenSourceArtefactScheme=f=r([(0,n.Injectable)()],f)},4358:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SchemePackageManager=void 0;const s=o(3563),i=o(6928),a=o(857),c=o(1943),l=o(8547);let d=class{constructor(e){this.schemes=new Map(e.map((e=>[e.getName(),e])))}getScheme(e){const t=this.schemes.get(e);if(!t)throw new Error(`Unknown scheme: ${e}`);return t}async downloadAndStoreSources(e,t,o){const r=this.schemes.get(e);if(!r)return new l.SourceArtefact({scheme:e,locator:t,valid:!1,error:`Unknown scheme: ${e}`,repo:"",cacheSrcBaseDir:""});const n=i.join(a.homedir(),".hldk","cached-sources");try{return await r.downloadAndStoreSources(t,n,o)}catch(o){return new l.SourceArtefact({scheme:e,locator:t,valid:!1,error:o instanceof Error?o.message:"Unknown error occurred",repo:"",cacheSrcBaseDir:""})}}async deleteSourceCache(e){if(e)try{await c.rm(e,{recursive:!0,force:!0})}catch(e){console.error(`Error deleting source cache directory: ${e}`)}}async needsImport(e){const t=this.schemes.get(e.scheme);return!t||await t.needsImport(e)}};t.SchemePackageManager=d,t.SchemePackageManager=d=r([(0,s.Injectable)(),n("design:paramtypes",[Array])],d)},308:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactController=void 0;const i=o(3563),a=o(3153);let c=class{constructor(e){this.sourceArtefactService=e}async importSourceArtefact(e){return this.sourceArtefactService.importSourceArtefact(e.scheme,e.locator,e.repoUrls)}async findById(e){return this.sourceArtefactService.findById(e)}async delete(e){return this.sourceArtefactService.delete(e)}async findBySchemeAndLocator(e,t){return this.sourceArtefactService.findBySchemeAndLocator(e,t)}async query(e,t,o=1,r=10,n="locator",s="ASC"){return this.sourceArtefactService.query(e,t,o,r,n,s)}};t.SourceArtefactController=c,r([(0,i.Post)("import"),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],c.prototype,"importSourceArtefact",null),r([(0,i.Get)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"findById",null),r([(0,i.Delete)(":id"),s(0,(0,i.Param)("id")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],c.prototype,"delete",null),r([(0,i.Get)("find"),s(0,(0,i.Query)("scheme")),s(1,(0,i.Query)("locator")),n("design:type",Function),n("design:paramtypes",[String,String]),n("design:returntype",Promise)],c.prototype,"findBySchemeAndLocator",null),r([(0,i.Get)(),s(0,(0,i.Query)("scheme")),s(1,(0,i.Query)("partialLocator")),s(2,(0,i.Query)("page")),s(3,(0,i.Query)("pageSize")),s(4,(0,i.Query)("sortBy")),s(5,(0,i.Query)("sortOrder")),n("design:type",Function),n("design:paramtypes",[String,String,Number,Number,String,String]),n("design:returntype",Promise)],c.prototype,"query",null),t.SourceArtefactController=c=r([(0,i.Controller)("source-artefacts"),n("design:paramtypes",[a.SourceArtefactService])],c)},8547:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefact=void 0;t.SourceArtefact=class{constructor(e){Object.assign(this,e)}}},7852:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactModule=void 0;const n=o(3563),s=o(308),i=o(3153),a=o(5908),c=o(376),l=o(4358),d=o(4912);let u=class{};t.SourceArtefactModule=u,t.SourceArtefactModule=u=r([(0,n.Module)({imports:[c.DataSourceModule],controllers:[s.SourceArtefactController],providers:[i.SourceArtefactService,a.SourceArtefactRepository,d.MavenSourceArtefactScheme,{provide:l.SchemePackageManager,useFactory:e=>new l.SchemePackageManager([e]),inject:[d.MavenSourceArtefactScheme]}],exports:[i.SourceArtefactService]})],u)},5908:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactRepository=void 0;const i=o(3563),a=(o(1832),o(8547)),c=o(3563),l=o(9100);let d=class{constructor(e){this.knex=e}async create(e){const t=(0,l.ulid)(),o=e.createdAt?e.createdAt:new Date;return await this.knex("source_artefacts").insert({id:t,...e,createdAt:o}),{id:t,...e}}async findById(e){const t=await this.knex("source_artefacts").where("id",e).first();return t?new a.SourceArtefact(t):null}async update(e,t){return await this.knex("source_artefacts").where("id",e).update(t),this.findById(e)}async delete(e){await this.knex("source_artefacts").where("id",e).delete()}async findBySchemeAndLocator(e,t){const o=await this.knex("source_artefacts").where({scheme:e,locator:t}).first();return o?new a.SourceArtefact(o):null}async query(e,t,o=1,r=10,n="locator",s="ASC"){const i=(o-1)*r;let c=this.knex("source_artefacts");e&&(c=c.where("scheme",e)),t&&(c=c.where("locator","like",`%${t}%`));const[l,d]=await Promise.all([c.clone().orderBy(n,s).limit(r).offset(i),c.clone().count("* as count").first()]);return{items:l.map((e=>new a.SourceArtefact(e))),total:d?.count}}};t.SourceArtefactRepository=d,t.SourceArtefactRepository=d=r([(0,i.Injectable)(),s(0,(0,c.Inject)("KNEX")),n("design:paramtypes",[Function])],d)},3153:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SourceArtefactService=void 0;const s=o(3563),i=o(5908),a=o(8547),c=o(4358);let l=class{constructor(e,t){this.sourceArtefactRepository=e,this.schemePackageManager=t}async importSourceArtefact(e,t,o){if(await this.findBySchemeAndLocator(e,t))throw new s.BadRequestException(`Source artefact with scheme '${e}' and locator '${t}' already exists.`);try{const r=await this.schemePackageManager.downloadAndStoreSources(e,t,o);return this.sourceArtefactRepository.create(r)}catch(o){const r=o instanceof Error?o.message:"Unknown error occurred";return this.sourceArtefactRepository.create(new a.SourceArtefact({scheme:e,locator:t,valid:!1,error:r,repo:"",cacheSrcBaseDir:""}))}}async findById(e){return this.sourceArtefactRepository.findById(e)}async delete(e){const t=await this.sourceArtefactRepository.findById(e);return t&&await this.schemePackageManager.deleteSourceCache(t.cacheSrcBaseDir),this.sourceArtefactRepository.delete(e)}async findBySchemeAndLocator(e,t){return this.sourceArtefactRepository.findBySchemeAndLocator(e,t)}async query(e,t,o=1,r=10,n="locator",s="ASC"){return this.sourceArtefactRepository.query(e,t,o,r,n,s)}async readArtefactSourceTree(e,t,o){const r=await this.ensureSourceArtefact(e,t,o);return this.schemePackageManager.getScheme(e).readArtefactSourceTree(r)}async readArtefactSourceFile(e,t,o,r){const n=await this.ensureSourceArtefact(e,t,r);return this.schemePackageManager.getScheme(e).readArtefactSourceFile(n,o)}async ensureSourceArtefact(e,t,o){let r=await this.findBySchemeAndLocator(e,t);const n=this.schemePackageManager.getScheme(e);return r&&!await n.needsImport(r)||(r=await this.importSourceArtefact(e,t,o)),r}};t.SourceArtefactService=l,t.SourceArtefactService=l=r([(0,s.Injectable)(),n("design:paramtypes",[i.SourceArtefactRepository,c.SchemePackageManager])],l)},6158:function(e,t,o){"use strict";var r,n=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ToolFactoryService=void 0;const i=o(3563),a=o(7602),c=o(8474),l=o(3153),d=o(7373),u=o(3923),f=o(4970),p=o(7465),h=o(7793),m=o(3765),g=o(5515),y=o(5996),w=o(1781),S=o(7600),v=o(2626),_=o(4911),R=o(3716),b=o(2923),A=o(4500),O=o(42),E=o(1514),I=o(3239),P=o(6696),T=o(7205),C=o(1909),k=o(4934),x=o(1983);let M=r=class{constructor(e,t,o,n,s,a,c,l){this.mutationsService=e,this.workspaceService=t,this.sourceArtefactService=o,this.sessionService=n,this.summaryCompletion=s,this.datasetRetrievalService=a,this.storedFileService=c,this.formService=l,this.logger=new i.Logger(r.name),this.toolMap={update_file:e=>new u.UpdateFile(e.workspace.repoBaseDir,this.mutationsService,e.sessionId,e.requestId),read_file:e=>new f.ReadFile(e.workspace.repoBaseDir),read_port_from_file:e=>new h.ReadPortFromFile(e.workspace.portFromBaseDir),delete_file:e=>new p.DeleteFile(e.workspace.repoBaseDir),command_line:e=>new m.CommandLine(e.workspace.repoBaseDir,this.summaryCompletion),read_workspace_tree:e=>new g.ReadWorkspaceTree(e.workspace.repoBaseDir),add_workspace:e=>new y.AddWorkspace(this.workspaceService,e.workspace.repoBaseDir),fetch_web_page:()=>new w.FetchWebPage(this.summaryCompletion),read_dependency_source_tree:()=>new S.ReadDependencySourceTree(this.sourceArtefactService),read_dependency_source_file:()=>new v.ReadDependencySourceFile(this.sourceArtefactService),git_commit:e=>new _.GitCommit(e.workspace.repoBaseDir,e.requestId,this.sessionService),git_init:e=>new R.GitInit(e.workspace.repoBaseDir),current_timestamp:()=>new b.CurrentTimestamp,dataset_retrieval:()=>new A.DatasetRetrieval(this.datasetRetrievalService),docx_to_html:()=>new O.DocxToHtml(this.storedFileService),create_form:e=>new E.CreateForm(this.formService,e.sessionId),computer:()=>{switch(process.platform){case"linux":return new k.ComputerToolLinux;case"darwin":return new x.ComputerToolMac;case"win32":throw new Error("ComputerTool is not supported on Windows yet.");default:throw new Error(`Unsupported platform: ${process.platform}`)}}}}toSnakeCase(e){return e.split(/(?=[A-Z])/).join("_").toLowerCase()}toCamelCase(e){return e.replace(/_([a-z])/g,(e=>e[1].toUpperCase()))}registerTool(e,t){const o=this.toSnakeCase(e);this.toolMap[o]=t,this.logger.log(`Registered new tool: ${o}`)}createTools(e,t){return e.map((e=>{const o=this.toSnakeCase(e),r=this.toolMap[o];if(!r)throw new Error(`Unknown tool: ${e}`);return r(t)}))}createTool(e,t){const o=this.toSnakeCase(e),r=this.toolMap[o];if(!r)throw new Error(`Unknown tool: ${e}`);return r(t)}allTools(e){return Object.values(this.toolMap).map((t=>t(e)))}};t.ToolFactoryService=M,t.ToolFactoryService=M=r=n([(0,i.Injectable)(),s("design:paramtypes",[a.MutationsService,c.WorkspaceService,l.SourceArtefactService,d.SessionService,I.SummaryCompletion,P.DatasetRetrievalService,T.StoredFileService,C.FormService])],M)},361:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.ToolsModule=void 0;const n=o(3563),s=o(6158),i=o(3177),a=o(5873),c=o(3880),l=o(7852),d=o(9161),u=o(6552),f=o(8624),p=o(1680),h=o(4240);let m=class{};t.ToolsModule=m,t.ToolsModule=m=r([(0,n.Module)({imports:[i.MutationsModule,a.WorkspaceModule,c.SessionModule,l.SourceArtefactModule,d.ChatCompletionModule,u.DatasetModule,f.StoredFileModule,p.DocstoreModule,h.FormModule],providers:[s.ToolFactoryService],exports:[s.ToolFactoryService]})],m)},2397:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceController=void 0;const i=o(3563),a=o(8474),c=o(6928);let l=class{constructor(e){this.workspaceService=e}async unlock(e){return this.workspaceService.unlockByName(e)}async findAll(e){const t="true"===e;return this.workspaceService.findAll(t)}async findOne(e){return this.workspaceService.findOne(e)}async create(e){return this.workspaceService.createWorkspace({name:e.name||c.basename(e.repoBaseDir),repoBaseDir:e.repoBaseDir})}async update(e,t){return this.workspaceService.updateWorkspace(e,t.buildOrTestCommand,t.portFromBaseDir)}async remove(e){return this.workspaceService.removeWorkspace(e)}};t.WorkspaceController=l,r([(0,i.Post)(":name/unlock"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"unlock",null),r([(0,i.Get)(),s(0,(0,i.Query)("isTemp")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"findAll",null),r([(0,i.Get)(":name"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"findOne",null),r([(0,i.Post)(),s(0,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",Promise)],l.prototype,"create",null),r([(0,i.Patch)(":name"),s(0,(0,i.Param)("name")),s(1,(0,i.Body)()),n("design:type",Function),n("design:paramtypes",[String,Object]),n("design:returntype",Promise)],l.prototype,"update",null),r([(0,i.Delete)(":name"),s(0,(0,i.Param)("name")),n("design:type",Function),n("design:paramtypes",[String]),n("design:returntype",Promise)],l.prototype,"remove",null),t.WorkspaceController=l=r([(0,i.Controller)("workspace"),n("design:paramtypes",[a.WorkspaceService])],l)},5873:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceModule=void 0;const n=o(3563),s=o(2397),i=o(8474),a=o(4717),c=o(376);let l=class{};t.WorkspaceModule=l,t.WorkspaceModule=l=r([(0,n.Module)({imports:[c.DataSourceModule],controllers:[s.WorkspaceController],providers:[i.WorkspaceService,a.WorkspaceRepository],exports:[i.WorkspaceService]})],l)},4717:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceRepository=void 0;const i=o(3563);o(1832);let a=class{constructor(e){this.knex=e}async findAll(e){let t=this.knex("workspaces").select("*");return void 0!==e&&(t=t.where("isTemp",e)),t}async findByName(e){return this.knex("workspaces").where("name",e).first()}async create(e){const t={...e};e.portFromBaseDir||delete t.portFromBaseDir,await this.knex("workspaces").insert(e)}async update(e,t){await this.knex("workspaces").where("name",e).update(t)}async delete(e){await this.knex("workspaces").where("name",e).delete()}async updateLastAccessedAt(e){await this.knex("workspaces").where("name",e).update("lastAccessedAt",this.knex.fn.now())}async findUnlockedTempWorkspaceByRemoteUrl(e){return this.knex("workspaces").where({remoteRepoUrl:e,isTemp:!0,isLocked:!1}).orderBy("lastAccessedAt","desc").first()}};t.WorkspaceRepository=a,t.WorkspaceRepository=a=r([(0,i.Injectable)(),s(0,(0,i.Inject)("KNEX")),n("design:paramtypes",[Function])],a)},8474:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkspaceService=void 0;const s=o(3563),i=o(4717),a=o(9896),c=o(6928),l=o(9055),d=o(3807);let u=class{constructor(e){this.workspaceRepository=e}async lockSessionWorkspace(e){const t=`session/${e}`;if(await this.workspaceRepository.findByName(t))return this.lockByName(t);const o=process.env.TEMP_WORKSPACE_ROOT_DIR||"~/.hldk/temp-workspaces/",r=c.join(o,"session",e);a.mkdirSync(r,{recursive:!0});const n=await this.createWorkspace({name:t,repoBaseDir:r,isGitRepo:!1,isTemp:!0});return this.lockByName(n.name)}async lockTempWorkspace(e){const t=await this.workspaceRepository.findUnlockedTempWorkspaceByRemoteUrl(e);if(t)return this.lockByName(t.name);const o=this.generateWorkspaceName(e),r=this.createWorkspaceDirectory(o);await this.cloneRepository(e,r);const n=await this.createWorkspace({name:o,repoBaseDir:r,isGitRepo:!0,isTemp:!0});return this.lockByName(n.name)}generateWorkspaceName(e){return`${c.basename(e,".git")}-${Math.random().toString(36).substring(2,7)}`}createWorkspaceDirectory(e){const t=process.env.TEMP_WORKSPACE_ROOT_DIR||c.join(process.env.HOME||"","/.hldk/temp-workspaces/"),o=c.join(t,e);return a.mkdirSync(o,{recursive:!0}),o}async cloneRepository(e,t){const o=(0,d.default)();await o.clone(e,t)}async updateWorkspace(e,t,o,r){const n=await this.workspaceRepository.findByName(e);if(!n)throw new s.NotFoundException(`Workspace with name ${e} not found`);return n.buildOrTestCommand=t,void 0!==r&&(n.isLocked=r),await this.workspaceRepository.update(e,{buildOrTestCommand:t,portFromBaseDir:o,isLocked:r}),l.default.info(`Workspace updated successfully: ${JSON.stringify(n)}`),n}async lockByName(e){const t=await this.workspaceRepository.findByName(e);if(!t)throw new s.NotFoundException(`Workspace with name ${e} not found`);if(t.isLocked)throw new s.BadRequestException(`Workspace with name ${e} is already locked`);return t.isLocked=!0,t.lastAccessedAt=new Date,await this.workspaceRepository.update(e,{isLocked:!0,lastAccessedAt:t.lastAccessedAt}),l.default.info(`Workspace locked successfully: ${JSON.stringify(t)}`),t}async unlockByName(e){const t=await this.workspaceRepository.findByName(e);if(!t)throw new s.NotFoundException(`Workspace with name ${e} not found`);return t.isLocked=!1,await this.workspaceRepository.update(e,{isLocked:!1}),l.default.info(`Workspace unlocked successfully: ${JSON.stringify(t)}`),t}async createWorkspace(e){const{name:t,repoBaseDir:o,isGitRepo:r,isTemp:n}=e;if(await this.workspaceRepository.findByName(t))throw new s.BadRequestException("A workspace with the same name already exists");if(!a.existsSync(o)||!a.statSync(o).isDirectory())throw new s.BadRequestException("The specified repository directory does not exist or is not a directory");let i=r??!1;if(!r)try{i=await this.isValidGitRepo(o)}catch(e){l.default.warn(`The specified directory is not a valid git repository: ${e}`)}const c={name:t,repoBaseDir:o,status:"Created",remoteRepoUrl:"",buildOrTestCommand:null,isGitRepo:i,isLocked:!1,isTemp:n??!1,lastAccessedAt:new Date,portFromBaseDir:e.portFromBaseDir};if(i)try{c.remoteRepoUrl=await this.getRemoteRepoUrl(o),await this.getCurrentBranch(o)}catch(e){console.error("Error getting Git information:",e),c.status="Error: Unable to get Git information"}return await this.workspaceRepository.create(c),l.default.info(`Workspace created successfully: ${JSON.stringify(c)}`),c}async findAll(e){return this.workspaceRepository.findAll(e)}async findOne(e){return this.workspaceRepository.findByName(e)}async updateLastAccessedAt(e){await this.workspaceRepository.updateLastAccessedAt(e)}async removeWorkspace(e){if(!await this.workspaceRepository.findByName(e))throw new s.NotFoundException(`Workspace with name ${e} not found`);await this.workspaceRepository.delete(e),l.default.info(`Workspace removed successfully: ${e}`)}async getRemoteRepoUrl(e){const t=(0,d.default)(e),o=(await t.getRemotes(!0)).find((e=>"origin"===e.name));return o?o.refs.fetch:""}async getCurrentBranch(e){return(0,d.default)(e).revparse(["--abbrev-ref","HEAD"])}async isValidGitRepo(e){try{const t=(0,d.default)(e);return await t.revparse(["--is-inside-work-tree"]),!0}catch(e){return!1}}};t.WorkspaceService=u,t.WorkspaceService=u=r([(0,s.Injectable)(),n("design:paramtypes",[i.WorkspaceRepository])],u)},5996:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddWorkspace=void 0;const r=o(5534),n=o(1569),s=o(9896),i=o(6928),a=o(5317),c=o(9023),l=o(9055),d=(0,c.promisify)(a.exec);class u extends r.Tool{constructor(e,t){super(),this.name="AddWorkspace",this.description="Add a new workspace to the system",this.schema=n.z.object({baseDir:n.z.string().describe("The absolute path to the directory of the workspace (can be a git repo or not)"),name:n.z.string().optional().describe("Optional name of the workspace (no spaces)")}),this.workspaceService=e,this.baseDir=t}async _call({baseDir:e,name:t}){try{if(l.default.info(`Adding workspace with baseDir: ${e}`),!i.isAbsolute(e))throw new Error(`Base directory must be an absolute path: ${e}`);const o=e;if(!s.existsSync(o))throw new Error(`Base directory does not exist: ${o}`);let r=!1;try{await d("git rev-parse --is-inside-work-tree",{cwd:o}),r=!0}catch(e){await d("git init",{cwd:o}),r=!0}const n=t||i.basename(o);return await this.workspaceService.createWorkspace({name:n,repoBaseDir:o,isGitRepo:r}),`Workspace '${n}' ${r?"added":"created and added"} successfully at ${o}`}catch(e){return l.default.error(`Error adding workspace: ${e.message}`,e),`Error adding workspace: ${e.message}`}}}t.AddWorkspace=u},3765:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommandLine=void 0;const r=o(5534),n=o(1569),s=o(5317),i=o(9023),a=o(9055),c=o(6928),l=o(1162),d=(0,i.promisify)(s.exec);class u extends r.Tool{constructor(e,t){super(),this.name="command_line",this.description="Execute a command line instruction in the workspace directory or a subdirectory",this.schema=n.z.object({command:n.z.string().describe("The command to execute"),subDir:n.z.string().optional().describe("Optional subdirectory relative to the workspace root to execute the command in")}),this.summaryPrompt="\n  You are a helpful assistant that summarises text. Your job is present the minumum useful information in the shortest way possible.\n  Summarise the following text pulling out just the interesting things. For example:\n  \n  a) If it looks like test output:\n     - If all tests passed, just say that and mention how many tests passed if possible.\n     - IF THERE ARE ANY FAILURES THEN YOU MUST ALL INFORMATION ABOUT ALL OF THE ERRORS INCLUDING ALL OF THE STACK TRACES OR ERROR INFORMATION AND INCLUDE ALL FILES/LINE NUMBERS ETC.\n  \n  b) If it's something else, then just pull out the most important information.",this.workspaceRootDir=e,this.maxOutputChars=parseInt(process.env.MAX_TOOL_OUTPUT_CHARS||"2000",10),this.summaryCompletion=t}async summariseOutput(e,t,o){const r="Stdout:\n"+e+"\nStderr:\n"+t;if(r.length>this.maxOutputChars){if(this.summaryCompletion){const e=await this.summaryCompletion.getSummary(this.summaryPrompt,r,l.ModelCategory.SUMMARISATION,o);return a.default.info(`Summarised large command output - reduced ${r.length} chars to ${e.length}`),e}{const o=this.clipString(e),n=this.clipString(t);return`Summarised large command output - reduced ${r.length} chars to ${o.length+n.length}:\n${o}\n${n}`}}return r}clipString(e){return e.length>this.maxOutputChars?e.slice(-this.maxOutputChars):e}async _call({command:e,subDir:t,isPrivate:o}){const r=o||!1;try{const r=t?c.default.join(this.workspaceRootDir,t):this.workspaceRootDir;a.default.info(`Executing command: ${e} in directory: ${r}`);const{stdout:n,stderr:s}=await d(e,{cwd:r});return`Executed Command:\n${e}\nWorking Directory: ${r}\nOutput:\n${await this.summariseOutput(n,s,o)}`}catch(t){a.default.warn(`Error executing command: ${e}`,t),a.default.warn(`Error stdout: ${t.stdout}`),a.default.warn(`Error stderr: ${t.stderr}`);const o=t.stdout||"",n=t.stderr||"";return`Executed Command:\n${e}\nOutput:\n${await this.summariseOutput(o,n,r)}\nError:\n${this.clipString(t.message)}`}}}t.CommandLine=u},1514:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CreateForm=void 0;const r=o(7773);class n extends r.Tool{constructor(e,t){super(),this.formService=e,this.sessionId=t,this.name="create_form",this.description="Creates a new form using the provided JSON data"}async _call(e){try{JSON.parse(e);return"ERROR: Not implemented"}catch(e){throw new Error(`Failed to create form: ${e.message}`)}}}t.CreateForm=n},2923:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentTimestamp=void 0;const r=o(7773);class n extends r.Tool{constructor(){super(...arguments),this.name="current_timestamp",this.description="Returns the current timestamp in epoch milliseconds and ISO format"}async _call(){const e=new Date,t=e.getTime(),o=e.toISOString();return JSON.stringify({epochMillis:t,isoFormat:o})}}t.CurrentTimestamp=n},4500:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DatasetRetrieval=void 0;const r=o(7773),n=o(3563);class s extends r.Tool{constructor(e){super(),this.datasetRetrievalService=e,this.name="dataset_retrieval",this.description="Search a dataset for similar content using vector similarity. Input should be a JSON string with datasetName, searchText, and optional numResults (defaults to 5).",this.logger=new n.Logger(s.name)}async _call(e){try{const t=JSON.parse(e);if(!t.datasetName||!t.searchText)throw new Error("Both datasetName and searchText are required");const o=await this.datasetRetrievalService.searchDataset(t.datasetName,t.searchText,t.numResults);return JSON.stringify(o,null,2)}catch(e){throw this.logger.error(`Error in dataset retrieval tool: ${e.message}`),e}}}t.DatasetRetrieval=s},7465:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteFile=void 0;const r=o(5534),n=o(1569),s=o(9896),i=o(6928),a=o(9055);class c extends r.Tool{constructor(e){super(),this.name="delete_file",this.description="Delete a file from the workspace",this.schema=n.z.object({filePath:n.z.string().describe("The relative path of the file to delete")}),this.workspaceRootDir=e}async _call(e){return this.deleteFile(e.filePath)}deleteFile(e){const t=i.join(this.workspaceRootDir,e);try{return s.existsSync(t)?(a.default.info(`Deleting file: ${e}`),s.unlinkSync(t),`Successfully deleted file: ${e}`):`Error: File not found - ${e}`}catch(e){return`Error deleting file: ${e.message}`}}}t.DeleteFile=c},42:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DocxToHtml=void 0;const i=o(5534),a=o(3563),c=o(7205),l=o(9896),d=o(6928),u=o(857),f=o(9055),p=o(3229);let h=class extends i.Tool{constructor(e){super(),this.storedFileService=e,this.name="docx_to_html",this.description="Converts a DOCX file to HTML. Takes a stored file ID as input and returns the generated HTML content directly."}async _call(e){try{const t=await this.storedFileService.getFile(e);if(!t)throw new Error(`File with ID ${e} not found`);f.default.info("Converting DOCX to HTML");const o=await(0,p.convertDocxToHtml)(t.fileContents,{wrapperElement:"html",removeImages:!0}),r=u.tmpdir(),n=d.join(r,`docx-${Date.now()}.html`);return l.writeFileSync(n,o,"utf8"),f.default.info(`HTML content written to temp file: ${n}`),o}catch(e){throw new Error(`Failed to convert DOCX to HTML: ${e.message}`)}}};t.DocxToHtml=h,t.DocxToHtml=h=r([(0,a.Injectable)(),s(0,(0,a.Inject)(c.StoredFileService)),n("design:paramtypes",[c.StoredFileService])],h)},1781:function(e,t,o){"use strict";var r=this&&this.__decorate||function(e,t,o,r){var n,s=arguments.length,i=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(t,o,i):n(t,o))||i);return s>3&&i&&Object.defineProperty(t,o,i),i},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.FetchWebPage=void 0;const i=o(5534),a=o(1569),c=o(758),l=o(9055),d=o(3563),u=o(3239);let f=class extends i.Tool{constructor(e){super(),this.summaryCompletion=e,this.name="fetch_web_page",this.description="Fetch the body text of a web page using a headless browser. This tool should only be used if the user has specifically asked for a web page by URL.",this.schema=a.z.object({url:a.z.string().url().describe("The URL of the web page to fetch")}),this.warningThreshold=4e3}async _call({url:e}){try{l.default.info(`Fetching web page: ${e}`);const t=await c.default.launch({headless:!0}),o=await t.newPage();await o.goto(e,{waitUntil:"networkidle0"});const r=await o.evaluate((()=>document.body.innerText));if(await t.close(),r.length>this.warningThreshold){l.default.warn(`Large text content detected (${r.length} characters) for URL: ${e}`);const t=`Please summarise the contents of the web url: ${e} so that we get all the useful information from the page`;return`Fetched and summarized text from URL: ${e}\nSummary:\n${await this.summaryCompletion.getSummary(t,r)}`}return`Fetched text from URL: ${e}\nContent:\n${r}`}catch(t){l.default.error(`Error fetching web page: ${e}`,t);return`Error fetching web page: ${e}\nError:\n${t.message||"Unknown error occurred"}`}}};t.FetchWebPage=f,t.FetchWebPage=f=r([s(0,(0,d.Inject)(u.SummaryCompletion)),n("design:paramtypes",[u.SummaryCompletion])],f)},4911:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitCommit=void 0;const r=o(7773),n=o(9896),s=o(6928),i=o(9055),a=o(3807);class c extends r.Tool{constructor(e,t,o){super(),this.repoBaseDir=e,this.requestId=t,this.sessionService=o,this.name="git_commit",this.description="Commits changes to the git repository",this.MAX_DIFF_SIZE=5e4,this.git=(0,a.default)(this.repoBaseDir)}async parseGitDiffOutput(e){const t=e.match(/(\d+) files? changed(?:, (\d+) insertions?\(\+\))?(?:, (\d+) deletions?\(-\))?/),o=t&&t[2]?parseInt(t[2]):0,r=t&&t[3]?parseInt(t[3]):0;return{filesChanged:t?parseInt(t[1]):0,insertions:o,deletions:r,linesChanged:Math.max(o,r)}}async getGitStats(){await this.git.add("-A");const e=await this.git.diff(["--cached","--shortstat"]),t=(await this.git.diff(["--cached","--name-only"])).split("\n").filter((e=>e.includes("test")));let o="";return t.length>0&&(o=await this.git.diff(["--cached","--shortstat",...t])),{allFiles:await this.parseGitDiffOutput(e),testFiles:await this.parseGitDiffOutput(o)}}async storeRequestSpecJsonFile(e){const t=await this.sessionService.getRequest(this.requestId);if(!t||!t.requestContent)return void i.default.warn(`Unable to store request content for requestId: ${this.requestId}`);if(!await this.sessionService.getSession(t.sessionId))return void i.default.warn(`Session not found for requestId: ${this.requestId}`);if("false"===process.env.STORE_SPECS_IN_WORKSPACE)return;const o=new Date,r=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,a=s.join(this.repoBaseDir,".hldk","specs",r);n.mkdirSync(a,{recursive:!0});const c=await this.sessionService.getRequestStats(this.requestId),l=c.cost,d=await this.getGitStats(),u=Date.now()-new Date(t.startedAt).getTime(),f={spec:t.requestContent,commitMessage:e,stats:{...c,cost:l,currency:"gbp",processingMillis:u,git:{...d.allFiles,testFilesChanged:d.testFiles.filesChanged,testInsertions:d.testFiles.insertions,testDeletions:d.testFiles.deletions,linesChanged:d.allFiles.linesChanged,testLinesChanged:d.testFiles.linesChanged}}},p=s.join(a,`${this.requestId}.json`);n.writeFileSync(p,JSON.stringify(f,null,2)),await this.sessionService.updateGitStats(this.requestId,{...d.allFiles,testFilesChanged:d.testFiles.filesChanged,testInsertions:d.testFiles.insertions,testDeletions:d.testFiles.deletions,linesChanged:d.allFiles.linesChanged,testLinesChanged:d.testFiles.linesChanged})}async _call(e){try{return await this.storeRequestSpecJsonFile(e),i.default.info(`Committing changes to git with message: ${e}`),await this.git.add("-A"),await this.git.commit(e),`Successfully committed changes with message: ${e}`}catch(e){return i.default.error("Error in GitCommit tool:",e),`Failed to commit changes: ${e.message}`}}async hasUncommittedUpdates(){try{const e=await this.git.status();return i.default.info("Git status: %s",JSON.stringify(e)),e.files.length>0}catch(e){throw i.default.error("Error checking for uncommitted updates:",e),new Error(`Failed to check for uncommitted updates: ${e.message}`)}}async getUncommittedChanges(){try{let e=await this.git.diff(["HEAD"]);return e.length>this.MAX_DIFF_SIZE&&(i.default.warn("Git diff is too large to summarise - returning just the filenames"),e=await this.git.diff(["HEAD","--name-only"])),e}catch(e){throw i.default.error("Error getting uncommitted changes:",e),new Error(`Failed to get uncommitted changes: ${e.message}`)}}}t.GitCommit=c},3716:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GitInit=void 0;const r=o(5534),n=o(1569),s=o(9055),i=o(6928),a=o(9896),c=o(3807);class l extends r.Tool{constructor(e){super(),this.name="git_init",this.description="Initialize a git repository in the specified directory if it's not already a git repository",this.schema=n.z.object({folder:n.z.string().describe("The folder relative to the workspace root to initialize as a git repository")}),this.workspaceRootDir=e,this.maxOutputChars=parseInt(process.env.MAX_TOOL_OUTPUT_CHARS||"2000",10)}clipOutput(e){return e.length>this.maxOutputChars?`Large output detected so clipped to last ${this.maxOutputChars} chars...\n${e.slice(-this.maxOutputChars)}`:e}async _call({folder:e}){try{s.default.info(`Initializing git repository in ${e} under workspace ${this.workspaceRootDir}`);const t=i.join(this.workspaceRootDir,e);if(!a.existsSync(t))return`Error: The directory ${t} does not exist.`;const o=i.join(t,".git");if(a.existsSync(o))return`The directory ${t} is already a git repository.`;const r=(0,c.default)(t);return await r.init(),`Successfully initialized git repository in ${t}`}catch(e){s.default.warn(`Error initializing git repository: ${e.message}`,e);return`Error initializing git repository:\nError:\n${this.clipOutput(e.message)}`}}}t.GitInit=l},2626:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadDependencySourceFile=void 0;const r=o(5534),n=o(1569);class s extends r.Tool{constructor(e){super(),this.name="read_dependency_source_file",this.description='Read the content of a specific source file from a dependency, using the package manager scheme (e.g. "maven"), locator (e.g. "com.example:example:1.0.0"), and file path.\n  Currently only maven is supported so the scheme is always "maven" and the locator is always a Maven GAV tuple (group:artifact:version).\n  If no repository URLs are provided then the default Maven central repository will be used.\n  The file path should be relative to the root of the source directory, e.g., "com/foo/Bar.java".\n  If the file is not found, it will check for alternative extensions (e.g., .kt for Kotlin).\n  ',this.schema=n.z.object({input:n.z.string().describe("A JSON string containing packageManagerScheme, locator, filePath, and optional repositoryUrls")}),this.sourceArtefactService=e}async _call(e){const{packageManagerScheme:t,locator:o,filePath:r,repositoryUrls:n}=JSON.parse(e.input);if(!t||!o||!r)return"Error: Missing required parameters. Please provide packageManagerScheme, locator, and filePath.";try{return await this.sourceArtefactService.readArtefactSourceFile(t,o,r,n)}catch(e){return`Error: Unable to read dependency source file. ${e instanceof Error?e.message:"Unknown error occurred"}`}}}t.ReadDependencySourceFile=s},7600:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadDependencySourceTree=void 0;const r=o(5534),n=o(1569);class s extends r.Tool{constructor(e){super(),this.name="read_dependency_source_tree",this.description='Read the source tree hierarchy (directories and file names only) of a dependency, using the package manager scheme (e.g. "maven") and locator (e.g. "com.example:example:1.0.0"). \n  Use this tool if you need to know more about how to use a specific dependency.\n  Look in the build file (e.g. pom.xml or build.gradle) or package metadata (e.g. package.json) and then use that to build the correct scheme and locator.\n  Currently only maven is supported so the scheme is always "maven" and the locator is always a Maven GAV tuple (group:artifact:version).\n  If no repository URLs are provided then the default Maven central repository will be used.\n  ',this.schema=n.z.object({input:n.z.string().describe("A JSON string containing packageManagerScheme, locator, and optional repositoryUrls")}),this.sourceArtefactService=e}async _call(e){const{packageManagerScheme:t,locator:o,repositoryUrls:r}=JSON.parse(e.input);try{return await this.sourceArtefactService.readArtefactSourceTree(t,o,r)}catch(e){return`Error: Unable to read dependency source tree. ${e instanceof Error?e.message:"Unknown error occurred"}`}}}t.ReadDependencySourceTree=s},4970:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadFile=void 0;const r=o(5534),n=o(1569),s=o(9896),i=o(6928),a=o(9055);class c extends r.Tool{constructor(e){super(),this.name="read_file",this.description="Read the content of a file in the workspace. Should only be used for reading files that are expected to be text based. Do not use this tool for binary files.",this.schema=n.z.object({filePath:n.z.string().describe("The relative path of the file to read")}),this.workspaceRootDir=e}async _call(e){return this.readFile(e.filePath)}readFile(e){a.default.info(`ReadFile.readFile called with: ${e}`);const t=i.join(this.workspaceRootDir,e);try{return s.readFileSync(t,"utf-8")}catch(t){return"ENOENT"===t.code?`Error: File not found - ${e}`:`Error reading file: ${t.message}`}}}t.ReadFile=c},7793:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadPortFromFile=void 0;const r=o(5534),n=o(1569),s=o(9896),i=o(6928),a=o(9055);class c extends r.Tool{constructor(e){super(),this.name="read_port_from_file",this.description="Read the content of a file from the portFromBaseDir in the workspace. Should only be used for reading files that are expected to be text based. Do not use this tool for binary files.",this.schema=n.z.object({filePath:n.z.string().describe("The relative path of the file to read")}),this.portFromBaseDir=e}async _call(e){return this.readFile(e.filePath)}readFile(e){a.default.info(`ReadPortFromFile.readFile called with: ${e}`);const t=i.join(this.portFromBaseDir,e);try{return s.readFileSync(t,"utf-8")}catch(t){return"ENOENT"===t.code?`Error: File not found - ${e}`:`Error reading file: ${t.message}`}}}t.ReadPortFromFile=c},5515:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReadWorkspaceTree=void 0;const r=o(5534),n=o(1569),s=o(6426);class i extends r.Tool{constructor(e){super(),this.name="read_workspace_tree",this.description="Read the workspace file tree, respecting .gitignore and .aiderignore files",this.schema=n.z.object({}),this.workspaceRootDir=e}async _call(){return(0,s.generateTree)(this.workspaceRootDir)}}t.ReadWorkspaceTree=i},3923:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFile=void 0;const r=o(5534),n=o(1569),s=o(9896),i=o(6928),a=o(9055),c=o(2303);class l extends r.Tool{constructor(e,t,o,r){super(),this.name="update_file",this.description="Update the content of a file in the workspace by providing the path of the file to update, the text block to search for in the file content, and the text block to replace the search block with. All 3 arguments are required: filePath, search, and replace.",this.schema=n.z.object({filePath:n.z.string().describe("The relative path of the file to update"),search:n.z.string().describe("The text block to search for in the file content"),replace:n.z.string().describe("The text block to replace the search block with - DO NOT FORGET TO INCLUDE THIS!!!")}),this.workspaceRootDir=e,this.mutationsService=t,this.sessionId=o,this.requestId=r}async _call(e){return this.updateFile(e.filePath,e.search,e.replace)}async updateFile(e,t,o){a.default.debug("UpdateFile.updateFile called with: %s\n>>>>> SEARCH\n%s\n-------\n%s<<<<< REPLACE\n",e,t,o);const r=i.join(this.workspaceRootDir,e);try{let n,l,d=!1;if(s.existsSync(r)||t&&""!==t){n=s.readFileSync(r,"utf-8");const i=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&").replace(/\r\n|\n/g,"(?:\\r\\n|\\n)"),c=new RegExp(i,"g").exec(n);let d=-1,u=-1;if(c)d=c.index,u=c[0].length;else{const e=n.indexOf(t);if(-1===e)return a.default.warn("UpdateFile.updateFile failed to find the search block in the file content."),a.default.warn("Search block was:\n%s",t),a.default.warn("Full file content was:\n%s",n),"Error: failed to find search block in file content.";a.default.info("UpdateFile.updateFile simple search/replace found search block in file content at index %s",e),d=e,u=t.length}const f=n.includes("\r\n")?"\r\n":"\n",p=o.replace(/\r\n|\n/g,f);l=n.slice(0,d)+p+n.slice(d+u),a.default.info(`Updating file: ${e}`),a.default.debug("Updated file - Content after:\n%s",l),s.writeFileSync(r,l,"utf-8")}else{const e=i.dirname(r);s.mkdirSync(e,{recursive:!0});const t=o.replace(/\r\n/g,"\n");s.writeFileSync(r,t,"utf-8"),n="",l=t,d=!0}const u=d?`Successfully created new file: ${e}\n<<<<<<< CONTENT\n${o}\n>>>>>>>>`:`Successfully updated file: ${e}\n<<<<<<< SEARCH\n${t}\n=======\n${o}\n>>>>>>>> REPLACE\n`;return await this.mutationsService.createMutation({type:d?c.MutationType.CREATE:c.MutationType.UPDATE,filePath:e,description:u,fileContentsBefore:n,fileContentsAfter:l,updatedAt:new Date,sessionId:this.sessionId,requestId:this.requestId}),"Success"}catch(e){return a.default.error("UpdateFile.updateFile encountered an error:",e),`Error: ${e.message}`}}}t.UpdateFile=l},7751:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComputerToolBase=void 0;const r=o(5534),n=o(1569);class s extends r.Tool{constructor(){super(),this.name="computer",this.description='Interact with the screen, keyboard, and mouse of the current computer. Available actions:\n    - key: Send keyboard key events (requires text parameter with key sequence)\n    - type: Type text directly (requires text parameter with content to type)\n    - mouse_move: Move mouse cursor to coordinates (requires coordinate parameter [x, y])\n    - left_click: Perform a left mouse click at current position\n    - left_click_drag: Click and drag from current position to coordinates (requires coordinate parameter [x, y])\n    - right_click: Perform a right mouse click at current position\n    - middle_click: Perform a middle mouse click at current position\n    - double_click: Perform a double click at current position\n    - screenshot: Take a screenshot of the current screen\n    - cursor_position: Get the current cursor position\n    \n    Example: {"action": "type", "text": "Hello World"} or {"action": "mouse_move", "coordinate": [100, 200]}',this.schema=n.z.object({input:n.z.string().optional()}).transform((e=>{try{return JSON.parse(e.input||"{}")}catch(e){return{}}})),this.scale=parseFloat(process.env.SCALE||"0.5"),(isNaN(this.scale)||this.scale<=0||this.scale>1)&&(console.warn(`Invalid SCALE value ${process.env.SCALE}, defaulting to 0.5`),this.scale=.5),this.width=process.env.WIDTH?parseInt(process.env.WIDTH,10):null,this.height=process.env.HEIGHT?parseInt(process.env.HEIGHT,10):null,this.maxOutputChars=2e3}clipString(e){return e.length>this.maxOutputChars?e.slice(-this.maxOutputChars):e}async _call(e){return this.execute(e)}}t.ComputerToolBase=s},4934:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComputerToolLinux=void 0;const r=o(1569),n=o(5317),s=o(9023),i=o(3903),a=o(943),c=o(3864),l=o(9896),d=o(6928),u=o(7751),f=o(7650),p=(0,s.promisify)(n.exec);class h extends u.ComputerToolBase{validateParams(e){return r.z.object({action:r.z.enum(["key","type","mouse_move","left_click","left_click_drag","right_click","middle_click","double_click","screenshot","cursor_position"]),text:r.z.string().optional(),coordinate:r.z.array(r.z.number()).length(2).optional()}).parse(e)}constructor(){if(super(),this.screenshotDelay=2,this.scalingEnabled=!0,this.outputDir="/tmp/outputs",!c.default.sync("xdotool"))throw new Error("xdotool is not installed. Please install it via your package manager.");if(!c.default.sync("gnome-screenshot")&&!c.default.sync("scrot"))throw new Error("Neither gnome-screenshot nor scrot is installed. Please install one of them.");if(!c.default.sync("convert"))throw new Error("ImageMagick is not installed. Please install it via your package manager.");const e=process.env.DISPLAY_NUM;this.displayPrefix=void 0!==e?`DISPLAY=:${e} `:"",this.xdotool=`${this.displayPrefix}xdotool`}async execute(e){const t=this.validateParams(e),{action:o,text:r,coordinate:n}=t;try{let e;switch(o){case"mouse_move":case"left_click_drag":if(!n)throw new f.ToolError(`coordinate is required for ${o}`);const[t,s]=n;e="mouse_move"===o?await this.shell(`${this.xdotool} mousemove --sync ${t} ${s}`):await this.shell(`${this.xdotool} mousedown 1 mousemove --sync ${t} ${s} mouseup 1`);break;case"key":if(!r)throw new f.ToolError(`text is required for ${o}`);e=await this.shell(`${this.xdotool} key -- ${r}`);break;case"type":if(!r)throw new f.ToolError(`text is required for ${o}`);e=await this.typeText(r);break;case"left_click":case"right_click":case"middle_click":case"double_click":e=await this.clickAction(o);break;case"screenshot":return e=await this.screenshot(),[{type:"image_url",image_url:{url:`data:image/png;base64,${e.base64_image}`}}];case"cursor_position":e=await this.getCursorPosition();break;default:throw new f.ToolError(`Invalid action: ${o}`)}return e.output}catch(e){return e instanceof f.ToolError?`Error: ${e.message}`:`Unexpected error: ${e}`}}async typeText(e){const t=this.chunkText(e,50);let o="";for(const e of t){const t=`${this.xdotool} type --delay 12 -- ${a.default.quote([e])}`;o+=(await this.shell(t,!1)).output}const r=await this.screenshot();return new f.ToolResult(o,"",r.base64_image)}async clickAction(e){const t={left_click:"1",right_click:"3",middle_click:"2",double_click:"--repeat 2 --delay 500 1"}[e];return await this.shell(`${this.xdotool} click ${t}`)}async getCursorPosition(){const e=(await this.shell(`${this.xdotool} getmouselocation --shell`,!1)).output||"",t=e.match(/X=(\d+)/),o=e.match(/Y=(\d+)/);if(!t||!o)throw new f.ToolError(`Failed to parse cursor position: ${e}`);const r=parseInt(t[1],10),n=parseInt(o[1],10);return new f.ToolResult(`X=${r},Y=${n}`,"")}async screenshot(){l.default.mkdirSync(this.outputDir,{recursive:!0});const e=d.default.join(this.outputDir,`screenshot_${(0,i.v4)().replace(/-/g,"")}.png`);let t="";if(c.default.sync("gnome-screenshot"))t=`${this.displayPrefix}gnome-screenshot -f ${e} -p`;else{if(!c.default.sync("scrot"))throw new f.ToolError("Neither gnome-screenshot nor scrot is available.");t=`${this.displayPrefix}scrot -p ${e}`}const o=await this.shell(t,!1);if(await this.shell(`convert ${e} -resize ${this.width}x${this.height}! ${e}`,!1),l.default.existsSync(e)){const t=l.default.readFileSync(e).toString("base64");return new f.ToolResult("","",t)}throw new f.ToolError(`Failed to take screenshot: ${o.error}`)}async shell(e,t=!0){const{stdout:o,stderr:r}=await p(e,{shell:"/bin/bash"});let n=null;return t&&(await new Promise((e=>setTimeout(e,1e3*this.screenshotDelay))),n=(await this.screenshot()).base64_image),new f.ToolResult(o,r,n)}chunkText(e,t){const o=[];for(let r=0;r<e.length;r+=t)o.push(e.slice(r,r+t));return o}}t.ComputerToolLinux=h},1983:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComputerToolMac=void 0;const r=o(1569),n=o(5317),s=o(9023),i=o(3903),a=o(943),c=o(3864),l=o(9896),d=o(6928),u=o(7751),f=o(7650),p=o(9055),h=(0,s.promisify)(n.exec);class m extends u.ComputerToolBase{validateParams(e){return r.z.object({action:r.z.enum(["key","type","mouse_move","left_click","left_click_drag","right_click","middle_click","double_click","screenshot","cursor_position"]),text:r.z.string().optional(),coordinate:r.z.array(r.z.number()).length(2).optional()}).parse(e)}constructor(){super(),this.screenshotDelay=2,this.scalingEnabled=!0,this.outputDir="/tmp/outputs",this.kpKeys=new Set(["arrow-down","arrow-left","arrow-right","arrow-up","brightness-down","brightness-up","delete","end","enter","esc","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","f13","f14","f15","f16","fwd-delete","home","keys-light-down","keys-light-toggle","keys-light-up","mute","num-0","num-1","num-2","num-3","num-4","num-5","num-6","num-7","num-8","num-9","num-clear","num-divide","num-enter","num-equals","num-minus","num-multiply","num-plus","page-down","page-up","play-next","play-pause","play-previous","return","space","tab","volume-down","volume-up"]),p.default.info("Initializing ComputerToolMac"),c("cliclick").then((function(e){p.default.info("cliclick command found")})).catch((function(){const e="cliclick is not installed. Please install it via Homebrew: brew install cliclick";throw p.default.error(e),new Error(e)})),c("convert").then((function(e){p.default.info("ImageMagick convert command found")})).catch((function(){const e="ImageMagick is not installed. Please install it via Homebrew: brew install imagemagick";throw p.default.error(e),new Error(e)}))}async execute(e){p.default.info(`Executing ComputerToolMac command: ${JSON.stringify(e)}`);try{const t=this.validateParams(e);p.default.info(`Parameters validated successfully: ${JSON.stringify(t)}`);const{action:o,text:r,coordinate:n}=t;let s;switch(o){case"mouse_move":case"left_click_drag":if(!n)throw new f.ToolError(`coordinate is required for ${o}`);const[e,t]=n,i=Math.round(e/this.scale),a=Math.round(t/this.scale);if(p.default.info(`Adjusted coordinates for scale factor (${this.scale}): (${i}, ${a})`),"mouse_move"===o)s=await this.executeCommands([`m:${i},${a}`]);else{const e=[`dd:${i},${a}`,`du:${i},${a}`];s=await this.executeCommands(e)}break;case"key":if(!r)throw new f.ToolError(`text is required for ${o}`);s=await this.pressKey(r);break;case"type":if(!r)throw new f.ToolError(`text is required for ${o}`);s=await this.typeText(r);break;case"left_click":case"right_click":case"middle_click":case"double_click":s=await this.clickAction(o);break;case"screenshot":return s=await this.screenshot(),[{type:"image_url",image_url:{url:`data:image/png;base64,${s.base64_image}`}}];case"cursor_position":s=await this.getCursorPosition();break;default:throw new f.ToolError(`Invalid action: ${o}`)}return s.output}catch(e){return e instanceof f.ToolError?(p.default.error("Tool error in ComputerToolMac",{error:e.message,stack:e.stack}),`Error: ${e.message}`):(p.default.error("Unexpected error in ComputerToolMac",{error:e instanceof Error?e.stack:String(e)}),`Unexpected error: ${e}`)}}async typeText(e){p.default.info(`Typing text: ${e}`);const t=["-w 200"];t.push(`t:${a.quote([e])}`),p.default.info(`Built commands for typing text: ${t.join(" ")}`);return await this.executeCommands(t)}async pressKey(e){p.default.info(`Pressing key: ${e}`);const{modifiers:t,key:o}=this.parseKeyCommand(e),r=["-w 200"];for(const e of t)p.default.info(`Key down modifier: ${e}`),r.push(`kd:${e}`);if(this.kpKeys.has(o))p.default.info(`Pressing special key with kp: ${o}`),r.push(`kp:${o}`);else{if(1!==o.length)throw new f.ToolError(`Invalid key: ${o}`);p.default.info(`Typing key with t: ${o}`),r.push(`t:${a.quote([o])}`)}for(const e of t.reverse())p.default.info(`Key up modifier: ${e}`),r.push(`ku:${e}`);p.default.info(`Built commands for key press: ${r.join(" ")}`);return await this.executeCommands(r)}async clickAction(e){const t={left_click:"c:.",right_click:"rc:.",middle_click:"mc:.",double_click:"dc:."}[e];if(!t)throw new f.ToolError(`Invalid click action: ${e}`);const o=["-w 200",t];return await this.executeCommands(o)}async getCursorPosition(){const e=await this.executeCommands(["p:."],!1),t=e.output?.trim()||"",o=t.match(/(\d+),(\d+)/);if(!o)throw new f.ToolError(`Failed to parse cursor position: ${t}`);const r=parseInt(o[1],10),n=parseInt(o[2],10);return new f.ToolResult(`X=${r},Y=${n}`,"")}async screenshot(){p.default.info("Taking screenshot"),p.default.info(`Ensuring output directory exists: ${this.outputDir}`),l.mkdirSync(this.outputDir,{recursive:!0});const e=d.join(this.outputDir,`screenshot_${(0,i.v4)().replace(/-/g,"")}.png`);p.default.info(`Screenshot will be saved to: ${e}`);const t=`screencapture -x ${e}`;p.default.info("Executing screenshot command",{cmd:t});const o=await h(t,{shell:"/bin/bash"});let r=this.width,n=this.height;if(null==r||null==n){const t=`magick identify -format "%w %h" ${e}`;p.default.info(`Executing identify command to get image dimensions: ${t}`);const o=await h(t,{shell:"/bin/bash"}),[s,i]=o.stdout.trim().split(" ");r=parseInt(s,10),n=parseInt(i,10),this.width=r,this.height=n}const s=`magick ${e} -resize ${Math.floor(r*this.scale)}x${Math.floor(n*this.scale)}! ${e}`;if(p.default.info(`Executing resize command: ${s}`),await h(s,{shell:"/bin/bash"}),l.existsSync(e)){const t=l.readFileSync(e).toString("base64");return new f.ToolResult("","",t)}throw new f.ToolError(`Failed to take screenshot: ${o.stderr}`)}async executeCommands(e,t=!0){p.default.info(`Executing commands: ${e.join(" ")}`);const o=`cliclick ${e.join(" ")}`;p.default.info(`Final cliclick command: ${o}`);try{const{stdout:e,stderr:r}=await h(o,{shell:"/bin/bash"});e&&p.default.info(`Command produced stdout output: ${e}`),r&&p.default.warn(`Command produced stderr output: ${r}`);let n=null;return t&&(p.default.info(`Waiting ${this.screenshotDelay} seconds before taking screenshot`),await new Promise((e=>setTimeout(e,1e3*this.screenshotDelay))),n=(await this.screenshot()).base64_image),p.default.info("Commands executed successfully",{hasOutput:!!e,hasScreenshot:!!n}),new f.ToolResult(e,r,n)}catch(e){throw p.default.error(`Command execution failed: ${e instanceof Error?e.stack:String(e)}`),e}}parseKeyCommand(e){const t=e.toLowerCase().split("+"),o=t.pop(),r={cmd:"cmd",command:"cmd",ctrl:"ctrl",control:"ctrl",alt:"alt",option:"alt",fn:"fn",shift:"shift"},n=t.map((e=>{const t=r[e];if(!t)throw new f.ToolError(`Invalid modifier key: ${e}`);return t}));if(this.kpKeys.has(o))return{modifiers:n,key:o};if(1===o.length&&/^[a-z0-9]$/.test(o))return{modifiers:n,key:o};throw new f.ToolError(`Invalid key: ${o}`)}}t.ComputerToolMac=m},7650:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToolResult=t.ToolError=void 0;class o extends Error{constructor(e){super(e),this.name="ToolError"}}t.ToolError=o;class r{constructor(e="",t="",o=null){this.output=e,this.error=t,this.base64_image=o}replace({output:e=null,error:t=null,base64_image:o=null}){return new r(null!==e?e:this.output,null!==t?t:this.error,null!==o?o:this.base64_image)}}t.ToolResult=r},8884:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEnv=function(e,t){let o;"undefined"!=typeof process&&process.env?o=process.env[e]:"undefined"!=typeof globalThis&&"Deno"in globalThis?o=globalThis.Deno.env.get(e):console.warn(`Unable to access environment variables. Key: ${e}`);return void 0!==o?o:t}},3229:(e,t,o)=>{"use strict";e=o.nmd(e),Object.defineProperty(t,"__esModule",{value:!0}),t.convertDocxToHtml=async function(e,t={}){await y(e,t);return document.documentElement.outerHTML},t.convertDocxToHtmlDom=y,t.extractRawText=async function(e){m.default.debug("Extracting raw text from DOCX buffer");try{m.default.debug("Starting mammoth raw text extraction");const t=await s.extractRawText({buffer:e});return t.messages&&t.messages.length>0&&m.default.warn("Extraction warnings:",t.messages),t.value}catch(e){throw new Error(`Failed to extract raw text from DOCX: ${e.message}`)}},t.extractDocxXmlFromBytes=async function(e){return m.default.debug("Extracting XML from DOCX buffer"),new Promise(((t,o)=>{try{m.default.debug("Opening DOCX buffer for XML extraction"),u.fromBuffer(e,{lazyEntries:!0},((e,r)=>{if(m.default.debug("DOCX buffer opened"),e)return void o(new Error(`Failed to open DOCX buffer: ${e.message}`));let n="";r.on("entry",(e=>{m.default.debug("Found entry: %s",e.fileName),"word/document.xml"===e.fileName?r.openReadStream(e,((e,r)=>{if(e)return void o(new Error(`Failed to read document.xml: ${e.message}`));const s=[];r.on("data",(e=>s.push(e))),r.on("end",(async()=>{n=Buffer.concat(s).toString("utf8");try{const e=new c.Parser,o=await e.parseStringPromise(n),r=new c.Builder({renderOpts:{pretty:!0}}).buildObject(o);t(r)}catch(e){o(new Error(`Failed to parse XML: ${e.message}`))}}))})):(m.default.debug("Skipping entry: %s",e.fileName),r.readEntry())})),r.on("end",(()=>{m.default.debug("DOCX buffer ended"),n||o(new Error("Invalid .docx file: document.xml not found"))})),m.default.debug("Reading DOCX buffer entry"),r.readEntry()}))}catch(e){o(new Error(`Error processing DOCX buffer: ${e.message}`))}}))},t.extractDocxXml=w,t.editDocxFile=async function(e,t,o,n,s){if(m.default.info("Editing DOCX file: %s",e),m.default.info("Output path: %s",n),!t)throw new Error("Search text cannot be empty");const c=s||await r.promises.mkdtemp(a.join(i.tmpdir(),"docx-edit-"));try{const s=e=>new Promise(((t,o)=>{u.open(e,{lazyEntries:!0},((e,r)=>{e?o(e):t(r)}))})),i=await s(e),l=[];let d="";await new Promise(((e,t)=>{i.on("entry",(e=>{const o=a.join(c,e.fileName);r.mkdirSync(a.dirname(o),{recursive:!0}),i.openReadStream(e,((n,s)=>{if(n)t(n);else{if("word/document.xml"===e.fileName){const e=[];s.on("data",(t=>e.push(t))),s.on("end",(()=>{d=Buffer.concat(e).toString("utf8"),r.writeFileSync(o,d)}))}else{const e=r.createWriteStream(o);s.pipe(e)}l.push(new Promise((e=>{s.on("end",e)})))}})),i.readEntry()})),i.on("end",(()=>e())),i.on("error",t),i.readEntry()})),await Promise.all(l);const p=d.indexOf(t);if(-1===p)throw new Error("Search text not found in document");const h=d.slice(0,p)+o+d.slice(p+t.length);await r.promises.writeFile(a.join(c,"word/document.xml"),h);const m=new f.ZipFile,g=async(e,t="")=>{const o=await r.promises.readdir(e,{withFileTypes:!0});for(const r of o){const o=a.join(e,r.name),n=a.join(t,r.name);r.isDirectory()?await g(o,n):m.addFile(o,n)}};await g(c);const y=r.createWriteStream(n);m.outputStream.pipe(y),await new Promise(((e,t)=>{y.on("close",e),y.on("error",t),m.end()}))}finally{s||await r.promises.rm(c,{recursive:!0,force:!0})}},t.extractSectionsFromDocxBuffer=b,t.extractDocxXmlPartsFromBytes=A,t.extractSectionsFromXmlContent=O,t.extractSections=E;const r=o(9896),n=o(2325),s=o(7393),i=o(857),a=o(6928),c=o(6566),l=o(1879),d=o(9863),u=o(1115),f=o(7020),p=o(6610),h=p.default||p,m=o(9055),g=1;async function y(e,t={}){m.default.debug("Converting DOCX to HTML with options: %j",t);try{m.default.debug("Starting mammoth conversion");const o=await s.convertToHtml({buffer:e});o.messages&&o.messages.length>0&&m.default.warn("Conversion warnings:",o.messages);let r=o.value;t.wrapperElement&&(m.default.debug("Adding wrapper element: %s",t.wrapperElement),r=`<html><head></head><body>${r}</body></html>`);let i=new n.JSDOM(r).window.document;if(t.removeImages){const e=i.getElementsByTagName("img");for(;e.length>0;)e[0].parentNode?.removeChild(e[0])}return i}catch(e){throw new Error(`Failed to convert DOCX to HTML: ${e.message}`)}}async function w(e){return m.default.info("Extracting XML from DOCX file: %s",e),new Promise(((t,o)=>{try{m.default.info("Opening DOCX file for XML extraction"),u.open(e,{lazyEntries:!0},((e,r)=>{if(e)return void o(new Error(`Failed to open DOCX file: ${e.message}`));let n="";r.on("entry",(e=>{"word/document.xml"===e.fileName?r.openReadStream(e,((e,r)=>{if(e)return void o(new Error(`Failed to read document.xml: ${e.message}`));const s=[];r.on("data",(e=>s.push(e))),r.on("end",(async()=>{n=Buffer.concat(s).toString("utf8");try{const e=new c.Parser,o=await e.parseStringPromise(n),r=new c.Builder({renderOpts:{pretty:!0}}).buildObject(o);t(r)}catch(e){o(new Error(`Failed to parse XML: ${e.message}`))}}))})):r.readEntry()})),r.on("end",(()=>{n||o(new Error("Invalid .docx file: document.xml not found"))})),r.readEntry()}))}catch(e){o(new Error(`Error processing DOCX file: ${e.message}`))}}))}function S(e){if(m.default.debug("Getting XPath for node: %s",e.nodeName),e.nodeType!==g)return m.default.debug("Node is not an element node, returning empty path"),"";let t="",o=e;const r=e.ownerDocument.documentElement,n={};for(let e=0;e<r.attributes.length;e++){const t=r.attributes[e];if(t.name.startsWith("xmlns:")){const e=t.name.split(":")[1];n[e]=t.value}else"xmlns"===t.name&&(n.default=t.value)}function s(e){if(!e)return null;for(const t in n)if(n[t]===e)return t;return null}for(;o&&o.nodeType===g&&"document"!==o.localName;){let e=1,r=o.previousSibling;for(;r;)r.nodeType===g&&r.localName===o.localName&&r.namespaceURI===o.namespaceURI&&e++,r=r.previousSibling;const n=s(o.namespaceURI);m.default.info("Node details - localName: %s, namespaceURI: %s, resolved prefix: %s",o.localName,o.namespaceURI,n);t=`/${n?`${n}:${o.localName}`:o.localName}[${e}]`+t,o=o.parentNode}if(o&&o.nodeType===g&&"document"===o.localName){const e=s(o.namespaceURI);t=`/${e?`${e}:${o.localName}`:o.localName}${t}`}return m.default.info("Completed XPath calculation for node: %s, path: %s",e.nodeName,t),t}function v(e,t){let o=t;for(;o;){if(o===e)return!0;o=o.parentNode}return!1}function _(e,t){m.default.debug("Finding label for input node: %s",e.nodeName);let o=e.parentNode;for(;o&&"w:body"!==o.nodeName;){if("w:tr"===o.nodeName){const r=Array.from(o.childNodes).filter((e=>"w:tc"===e.nodeName));m.default.debug("Found %d cells in table row",r.length);for(let n=0;n<r.length;n++){if(v(r[n],e)){m.default.debug("Input node found in cell %d, checking previous cells for label",n);for(let e=n-1;e>=0;e--){const o=t(".//w:t",r[e]).map((e=>e.textContent?.trim())).filter((e=>e)).join(" ");if(o)return m.default.debug("Found label text in same row: %s",o),o}let e=o;for(;e.previousSibling;){const o=e.previousSibling;if("w:tr"===o.nodeName){const e=Array.from(o.childNodes).filter((e=>"w:tc"===e.nodeName));for(const o of e){if(t('.//w:shd[@w:fill="E5E5E5"]',o)[0]){const e=t(".//w:t",o).map((e=>e.textContent?.trim())).filter((e=>e)).join(" ");if(e)return m.default.debug("Found label text in previous row: %s",e),e}}}e=o}}}}o=o.parentNode}return m.default.info("No label found for input node"),null}function R(e,t,o,r){function n(e){const o=t.find((t=>t.xpath===e.xpath));if(o)return o.label!==e.label&&m.default.warn("Found duplicate XPath with different labels. XPath: %s, Existing label: %s, New label: %s",e.xpath,o.label,e.label),void m.default.info("Skipping duplicate input with XPath: %s",e.xpath);t.push(e)}m.default.debug("Processing inputs in section: %s",e.nodeName);const s=o(".//w:sdt",e);m.default.debug("Found %d content controls (sdt nodes)",s.length),s.forEach((e=>{const t=o("./w:sdtPr",e)[0];if(t){let r="text",s="";m.default.debug("Determining input type for sdt node: %s",e.nodeName),m.default.debug("SDT Properties node structure: %j",t.toString());if(o(".//w14:checkbox",t)[0])m.default.debug("Found checkbox node - setting input type to checkbox"),r="checkbox";else{const e=o("./w:richText",t)[0],n=o("./w:text",t)[0];m.default.info("Checking for textarea: richTextNode=%s, textNode=%s",!!e,!!n&&!!o("./w:multiLine",n)[0]),e||n&&o("./w:multiLine",n)[0]?(m.default.debug("Found rich text or multiline text node - setting input type to textarea"),r="textarea"):m.default.debug("No special nodes found - defaulting to text input type")}const i=o("./w:sdtContent",e)[0];if(i){o(".//w:t",i).forEach((e=>{s+=e.textContent||""}))}const a=S(e),c=o("./w:id",t)[0],l=c?c.getAttribute("w:val"):null,d=_(e,o);m.default.info("Processing input node - Type: %s, XPath: %s, ID: %s, Label: %s",r,a,l,d),m.default.info("Original value from XML node: %s",s),n({xpath:a,type:r,id:l,label:d,originalValue:s||null})}}));const i=o(".//w:tc",e);m.default.info("Found %d table cells to process",i.length),i.forEach((e=>{if(o('.//w:tcBorders/w:bottom[@w:val="single"]',e)[0]){const t=o(".//w:t",e).map((e=>e.textContent||"")).join("").trim();if(!r||!t||" "===t){const r=e.parentNode;if(r&&"w:tr"===r.nodeName){const s=Array.from(r.childNodes).filter((e=>"w:tc"===e.nodeName)),i=s.findIndex((t=>t===e));if(i>0){const r=s[i-1],a=o(".//w:t",r).map((e=>e.textContent?.trim())).filter((e=>e)).join(" ");if(a){m.default.info("Found label text from left cell: %s",a);const o=e;m.default.info("Using the cell node itself as the target node");n({xpath:S(o),type:"text",id:null,label:a,originalValue:t||null})}else m.default.info("Left cell exists but has no text, skipping input")}else m.default.info("No cell to the left, skipping input")}else m.default.info("Could not find parent row for cell, skipping input")}}}));const a=o(".//w:t",e);m.default.info("Found %d text nodes to process",a.length),a.forEach((e=>{const t=e.textContent||"",s=t.replace(/[\s\u00A0]/g,"");if(!r||""===s){let r=!0,s=e.parentNode;for(;s;){if("w:tc"===s.nodeName){if(o('.//w:tcBorders/w:bottom[@w:val="single"]',s)[0])break;r=!1;break}s=s.parentNode}if(r){let r=null,s="r",i=e.parentNode;for(;i&&"w:r"!==i.nodeName;)i=i.parentNode;if(i)r=i,m.default.info("Found parent w:r node");else{let t=e.parentNode;for(;t&&"w:p"!==t.nodeName;)t=t.parentNode;t&&(r=t,s="p",m.default.info("No w:r node found, falling back to w:p node"))}if(r){const e=S(r),i=_(r,o);m.default.info("Processing text node - Node type: w:%s, XPath: %s, Label: %s",s,e,i),m.default.info("Original value from XML node: %s",t),n({xpath:e,type:"text",id:null,label:i,originalValue:t||null})}else m.default.warn("No suitable node (w:t or w:r) found for text node. Skipping this text node.")}else m.default.info("Skipping text node in table cell without bottom border")}}))}async function b(e,t=!0){m.default.info("Extracting sections from DOCX buffer");const{documentXml:o,stylesXml:r}=await A(e);return O(o,r,t)}async function A(e){if(m.default.info("Extracting XML parts from DOCX buffer"),!e||0===e.length)throw new Error("Invalid buffer: Buffer is empty");try{if(!h(e))throw new Error("Invalid buffer: Not a valid ZIP archive")}catch(e){throw m.default.error("Error validating ZIP buffer:",e),new Error("Failed to validate DOCX buffer: "+e.message)}return new Promise(((t,o)=>{try{m.default.info("Opening DOCX buffer for XML extraction");let r=setTimeout((()=>{o(new Error("Operation timed out while opening DOCX buffer"))}),5e3);u.fromBuffer(e,{lazyEntries:!0},((e,n)=>{if(clearTimeout(r),e||!n)return void o(new Error(`Failed to open DOCX buffer: ${e?.message}`));m.default.info("DOCX buffer opened successfully");let s=null,i=null;const a=new Set(["word/document.xml","word/styles.xml"]);n.on("entry",(e=>{m.default.info("Found entry: %s",e.fileName),a.has(e.fileName)?n.openReadStream(e,((r,c)=>{if(r||!c)return void o(new Error(`Failed to read ${e.fileName}: ${r?.message}`));const l=[];c.on("data",(e=>l.push(e))),c.on("end",(()=>{const o=Buffer.concat(l).toString("utf8");"word/document.xml"===e.fileName?s=o:"word/styles.xml"===e.fileName&&(i=o),a.delete(e.fileName),0===a.size?(n.close(),t({documentXml:s,stylesXml:i})):n.readEntry()})),c.on("error",(t=>{o(new Error(`Error reading ${e.fileName}: ${t.message}`))}))})):n.readEntry()})),n.on("end",(()=>{m.default.info("Finished reading DOCX entries"),a.size>0&&o(new Error("Invalid .docx file: Missing "+(a.has("word/document.xml")?"document.xml":"styles.xml")))})),n.on("error",(e=>{o(new Error(`Error processing DOCX buffer: ${e.message}`))})),m.default.info("Reading first entry in DOCX buffer"),n.readEntry()}))}catch(e){o(new Error(`Error processing DOCX buffer: ${e.message}`))}}))}async function O(e,t,o=!0){m.default.info("Parsing XML document: start of document: \n%s",e.slice(0,2e3));const r=(new l.DOMParser).parseFromString(e,"application/xml");if(!r||!r.documentElement)throw new Error("Failed to parse XML document");const n=r.documentElement,i={};for(let e=0;e<n.attributes.length;e++){const t=n.attributes[e];if(t.name.startsWith("xmlns:")){i[t.name.split(":")[1]]=t.value}else"xmlns"===t.name&&(i.default=t.value)}i.w||(i.w="http://schemas.openxmlformats.org/wordprocessingml/2006/main");const a=d.useNamespaces(i),c=[];m.default.info("Selecting document body node with namespaces: %j",i);const u=a("//w:body",r);if(!u||0===u.length)throw m.default.error("Could not find document body node. Available nodes: %s",Array.from(r.documentElement.childNodes).filter((e=>1===e.nodeType)).map((e=>e.nodeName)).join(", ")),new Error("Could not find document body node");const p=u[0];if(!p)throw new Error("Document body node is null");const h=Array.from(p.childNodes||[]);m.default.info("Found %d child nodes in document body",h.length);for(let e=0;e<h.length;e++){const r=h[e];if(1===r.nodeType)try{m.default.info("Processing section node: %s",r.nodeName);const e=S(r),i=(new l.XMLSerializer).serializeToString(r),d=[];R(r,d,a,o);const u=Array.from(n.attributes),p=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n  <w:document ${u.filter((e=>e.name.startsWith("xmlns:")||"xmlns"===e.name)).map((e=>`${e.name}="${e.value}"`)).join(" ")}>\n    <w:body>\n      ${i}\n    </w:body>\n  </w:document>`;m.default.info("Converting section to HTML: %s",e);const h=new f.ZipFile;m.default.info("Adding content types to zip");const g='<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n  <Default Extension="xml" ContentType="application/xml"/>\n  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>\n  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>\n</Types>';h.addBuffer(Buffer.from(g),"[Content_Types].xml"),m.default.info("Adding relationships to zip");const y='<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>\n</Relationships>';h.addBuffer(Buffer.from(y),"_rels/.rels"),m.default.info("Adding document.xml to zip"),h.addBuffer(Buffer.from(p),"word/document.xml"),m.default.info("Adding styles.xml to zip"),h.addBuffer(Buffer.from(t),"word/styles.xml"),m.default.info("Adding document.xml.rels to zip");const w='<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>\n</Relationships>';h.addBuffer(Buffer.from(w),"word/_rels/document.xml.rels"),m.default.info("Finalizing zip");const v=await new Promise(((e,t)=>{const o=[];h.outputStream.on("data",(e=>o.push(e))),h.outputStream.on("end",(()=>e(Buffer.concat(o)))),h.outputStream.on("error",t),h.end()}));m.default.info("Converting section to HTML");const _=await s.convertToHtml({buffer:v});m.default.info("Mammoth result: %s",_);const b={xpath:e,convertedHtml:_.value,potentialInputs:d};m.default.info("Unescaped RAW XML for the section: %s",i),m.default.info("Resulting section: %s",JSON.stringify(b,null,2)),c.push(b)}catch(t){m.default.error(t),m.default.error("Failed to convert XML to HTML for section with index %s: %s",e,t.message)}}return{sections:c}}async function E(e,t=!1){m.default.info("Extracting sections from DOCX file: %s",e);return b(r.readFileSync(e),t)}if(o.c[o.s]===e){const e=process.argv.slice(2);e.length<1&&(console.error("Usage: node docxExtractor.js <path-to-docx-file> [sections|xml]"),process.exit(1));const t=e[0],o=e[1]||"sections";let r=!0;switch(e.length>1&&"false"===e[1]&&(r=!1),o){case"sections":E(t,r).then((e=>{console.log(JSON.stringify(e,null,2))})).catch((e=>{console.error("Failed to extract DOCX sections:",e),process.exit(1)}));break;case"xml":w(t).then((e=>{console.log(e)})).catch((e=>{console.error("Failed to extract DOCX XML:",e),process.exit(1)}));break;default:console.error('Invalid command. Use "sections" or "xml"'),process.exit(1)}}},9055:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=o(5124),n=o(9896),s=o(6928),i=o(8884),a=o(9233),c=s.join(process.cwd(),"logs");n.existsSync(c)||n.mkdirSync(c,{recursive:!0});const l=s.join(c,"hldk-server-%DATE%.log"),d=(0,i.getEnv)("LOG_FILE_PATH",l);console.log(`Log file pattern: ${d}`);const u=new a({filename:d,datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"20m",maxFiles:"14d",level:"debug"}),f=r.format.printf((e=>{const{level:t,message:o,timestamp:r}=e,n=new Date(r);return`${`${(n.getMonth()+1).toString().padStart(2,"0")}/${n.getDate().toString().padStart(2,"0")}/${n.getFullYear()}, ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}:${n.getSeconds().toString().padStart(2,"0")} ${n.getHours()>=12?"PM":"AM"}`} - ${t.toUpperCase()}: ${o}`})),p=r.createLogger({level:"debug",format:r.format.combine(r.format.splat(),r.format.timestamp(),f),transports:[new r.transports.Console({level:"info"}),u]});t.default=p},6426:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateTree=function(e,t=[]){if(!r.existsSync(e)||!r.statSync(e).isDirectory())return`Error: ${e} is not a valid directory.`;const o=function(e,t){const o=(0,s.default)();o.add([".git",".hldk",...t]);return[".gitignore",".aiderignore",".hldkignore"].forEach((t=>{const s=n.join(e,t);if(r.existsSync(s)){const e=r.readFileSync(s,"utf-8");o.add(e)}})),o}(e,t),a=i(e,o,e);return`File tree for ${e}:\n.\n${a}`};const r=o(9896),n=o(6928),s=o(526);function i(e,t,o,s=""){let a=[];const c=r.readdirSync(e).sort();return c.forEach(((l,d)=>{const u=n.join(e,l),f=n.relative(o,u);if(t.ignores(f))return;const p=d===c.length-1;a.push(`${s}${p?"└── ":"├── "}${l}`),r.statSync(u).isDirectory()&&a.push(i(u,t,o,s+(p?"    ":"│   ")))})),a.join("\n")}},646:e=>{"use strict";e.exports=require("@langchain/anthropic")},779:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/csv")},9179:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/docx")},8565:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/pdf")},4897:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/pptx")},7915:e=>{"use strict";e.exports=require("@langchain/community/document_loaders/fs/unstructured")},7310:e=>{"use strict";e.exports=require("@langchain/community/embeddings/hf_transformers")},5796:e=>{"use strict";e.exports=require("@langchain/community/vectorstores/chroma")},1486:e=>{"use strict";e.exports=require("@langchain/core/messages")},724:e=>{"use strict";e.exports=require("@langchain/core/output_parsers")},5534:e=>{"use strict";e.exports=require("@langchain/core/tools")},1463:e=>{"use strict";e.exports=require("@langchain/groq")},9314:e=>{"use strict";e.exports=require("@langchain/langgraph")},8804:e=>{"use strict";e.exports=require("@langchain/langgraph/prebuilt")},2196:e=>{"use strict";e.exports=require("@langchain/mistralai")},3548:e=>{"use strict";e.exports=require("@langchain/ollama")},6228:e=>{"use strict";e.exports=require("@langchain/openai")},3563:e=>{"use strict";e.exports=require("@nestjs/common")},8781:e=>{"use strict";e.exports=require("@nestjs/core")},9556:e=>{"use strict";e.exports=require("@nestjs/platform-express")},2810:e=>{"use strict";e.exports=require("@nestjs/serve-static")},4650:e=>{"use strict";e.exports=require("adm-zip")},8938:e=>{"use strict";e.exports=require("axios")},3864:e=>{"use strict";e.exports=require("command-exists")},818:e=>{"use strict";e.exports=require("dotenv")},7252:e=>{"use strict";e.exports=require("express")},8817:e=>{"use strict";e.exports=require("file-type")},4652:e=>{"use strict";e.exports=require("fs-extra")},526:e=>{"use strict";e.exports=require("ignore")},6610:e=>{"use strict";e.exports=require("is-zip")},2325:e=>{"use strict";e.exports=require("jsdom")},1832:e=>{"use strict";e.exports=require("knex")},7093:e=>{"use strict";e.exports=require("langchain/text_splitter")},7773:e=>{"use strict";e.exports=require("langchain/tools")},7393:e=>{"use strict";e.exports=require("mammoth")},904:e=>{"use strict";e.exports=require("mime-types")},758:e=>{"use strict";e.exports=require("puppeteer")},1321:e=>{"use strict";e.exports=require("reflect-metadata")},573:e=>{"use strict";e.exports=require("rxjs")},943:e=>{"use strict";e.exports=require("shell-quote")},3807:e=>{"use strict";e.exports=require("simple-git")},9100:e=>{"use strict";e.exports=require("ulid")},3903:e=>{"use strict";e.exports=require("uuid")},5124:e=>{"use strict";e.exports=require("winston")},9233:e=>{"use strict";e.exports=require("winston-daily-rotate-file")},6566:e=>{"use strict";e.exports=require("xml2js")},1879:e=>{"use strict";e.exports=require("xmldom")},9863:e=>{"use strict";e.exports=require("xpath")},1115:e=>{"use strict";e.exports=require("yauzl")},7020:e=>{"use strict";e.exports=require("yazl")},1569:e=>{"use strict";e.exports=require("zod")},5317:e=>{"use strict";e.exports=require("child_process")},6982:e=>{"use strict";e.exports=require("crypto")},4434:e=>{"use strict";e.exports=require("events")},9896:e=>{"use strict";e.exports=require("fs")},1943:e=>{"use strict";e.exports=require("fs/promises")},857:e=>{"use strict";e.exports=require("os")},6928:e=>{"use strict";e.exports=require("path")},9023:e=>{"use strict";e.exports=require("util")}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var o=__webpack_module_cache__[e]={id:e,loaded:!1,exports:{}};return __webpack_modules__[e].call(o.exports,o,o.exports,__webpack_require__),o.loaded=!0,o.exports}__webpack_require__.c=__webpack_module_cache__,__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var __webpack_exports__=__webpack_require__(__webpack_require__.s=7201)})();